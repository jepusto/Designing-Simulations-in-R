<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 6 Data-generating processes | Designing Monte Carlo Simulations in R</title>
  <meta name="description" content="A text on designing, implementing, and reporting on Monte Carlo simulation studies" />
  <meta name="generator" content="bookdown 0.43 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 6 Data-generating processes | Designing Monte Carlo Simulations in R" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="A text on designing, implementing, and reporting on Monte Carlo simulation studies" />
  <meta name="github-repo" content="jepusto/Designing-Simulations-in-R" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 6 Data-generating processes | Designing Monte Carlo Simulations in R" />
  
  <meta name="twitter:description" content="A text on designing, implementing, and reporting on Monte Carlo simulation studies" />
  

<meta name="author" content="Luke W. Miratrix and James E. Pustejovsky (Equal authors)" />


<meta name="date" content="2025-08-13" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="case-ANOVA.html"/>
<link rel="next" href="data-analysis-procedures.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>
<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Designing Simulations in R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#license"><i class="fa fa-check"></i>License</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#about-the-authors"><i class="fa fa-check"></i>About the authors</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#acknowledgements"><i class="fa fa-check"></i>Acknowledgements</a></li>
</ul></li>
<li class="part"><span><b>I An Introductory Look</b></span></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="introduction.html"><a href="introduction.html#some-of-simulations-many-uses"><i class="fa fa-check"></i><b>1.1</b> Some of simulation’s many uses</a>
<ul>
<li class="chapter" data-level="1.1.1" data-path="introduction.html"><a href="introduction.html#comparing-statistical-approaches"><i class="fa fa-check"></i><b>1.1.1</b> Comparing statistical approaches</a></li>
<li class="chapter" data-level="1.1.2" data-path="introduction.html"><a href="introduction.html#assessing-performance-of-complex-pipelines"><i class="fa fa-check"></i><b>1.1.2</b> Assessing performance of complex pipelines</a></li>
<li class="chapter" data-level="1.1.3" data-path="introduction.html"><a href="introduction.html#assessing-performance-under-misspecification"><i class="fa fa-check"></i><b>1.1.3</b> Assessing performance under misspecification</a></li>
<li class="chapter" data-level="1.1.4" data-path="introduction.html"><a href="introduction.html#assessing-the-finite-sample-performance-of-a-statistical-approach"><i class="fa fa-check"></i><b>1.1.4</b> Assessing the finite-sample performance of a statistical approach</a></li>
<li class="chapter" data-level="1.1.5" data-path="introduction.html"><a href="introduction.html#conducting-power-analyses"><i class="fa fa-check"></i><b>1.1.5</b> Conducting Power Analyses</a></li>
<li class="chapter" data-level="1.1.6" data-path="introduction.html"><a href="introduction.html#simulating-processess"><i class="fa fa-check"></i><b>1.1.6</b> Simulating processess</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="introduction.html"><a href="introduction.html#the-perils-of-simulation-as-evidence"><i class="fa fa-check"></i><b>1.2</b> The perils of simulation as evidence</a></li>
<li class="chapter" data-level="1.3" data-path="introduction.html"><a href="introduction.html#simulating-to-learn"><i class="fa fa-check"></i><b>1.3</b> Simulating to learn</a></li>
<li class="chapter" data-level="1.4" data-path="introduction.html"><a href="introduction.html#why-r"><i class="fa fa-check"></i><b>1.4</b> Why R?</a></li>
<li class="chapter" data-level="1.5" data-path="introduction.html"><a href="introduction.html#organization-of-the-text"><i class="fa fa-check"></i><b>1.5</b> Organization of the text</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html"><i class="fa fa-check"></i><b>2</b> Programming Preliminaries</a>
<ul>
<li class="chapter" data-level="2.1" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#welcome-to-the-tidyverse"><i class="fa fa-check"></i><b>2.1</b> Welcome to the tidyverse</a></li>
<li class="chapter" data-level="2.2" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#functions"><i class="fa fa-check"></i><b>2.2</b> Functions</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#rolling-your-own"><i class="fa fa-check"></i><b>2.2.1</b> Rolling your own</a></li>
<li class="chapter" data-level="2.2.2" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#a-dangerous-function"><i class="fa fa-check"></i><b>2.2.2</b> A dangerous function</a></li>
<li class="chapter" data-level="2.2.3" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#using-named-arguments"><i class="fa fa-check"></i><b>2.2.3</b> Using Named Arguments</a></li>
<li class="chapter" data-level="2.2.4" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#argument-defaults"><i class="fa fa-check"></i><b>2.2.4</b> Argument Defaults</a></li>
<li class="chapter" data-level="2.2.5" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#function-skeletons"><i class="fa fa-check"></i><b>2.2.5</b> Function skeletons</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#pipe-dreams"><i class="fa fa-check"></i><b>2.3</b> <code>\&gt;</code> (Pipe) dreams</a></li>
<li class="chapter" data-level="2.4" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#recipes-versus-patterns"><i class="fa fa-check"></i><b>2.4</b> Recipes versus Patterns</a></li>
<li class="chapter" data-level="2.5" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#exercises"><i class="fa fa-check"></i><b>2.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="t-test-simulation.html"><a href="t-test-simulation.html"><i class="fa fa-check"></i><b>3</b> An initial simulation</a>
<ul>
<li class="chapter" data-level="3.1" data-path="t-test-simulation.html"><a href="t-test-simulation.html#simulating-a-single-scenario"><i class="fa fa-check"></i><b>3.1</b> Simulating a single scenario</a></li>
<li class="chapter" data-level="3.2" data-path="t-test-simulation.html"><a href="t-test-simulation.html#a-non-normal-population-distribution"><i class="fa fa-check"></i><b>3.2</b> A non-normal population distribution</a></li>
<li class="chapter" data-level="3.3" data-path="t-test-simulation.html"><a href="t-test-simulation.html#simulating-across-different-scenarios"><i class="fa fa-check"></i><b>3.3</b> Simulating across different scenarios</a></li>
<li class="chapter" data-level="3.4" data-path="t-test-simulation.html"><a href="t-test-simulation.html#extending-the-simulation-design"><i class="fa fa-check"></i><b>3.4</b> Extending the simulation design</a></li>
<li class="chapter" data-level="3.5" data-path="t-test-simulation.html"><a href="t-test-simulation.html#exercises-1"><i class="fa fa-check"></i><b>3.5</b> Exercises</a></li>
</ul></li>
<li class="part"><span><b>II Structure and Mechanics of a Simulation Study</b></span></li>
<li class="chapter" data-level="4" data-path="simulation-structure.html"><a href="simulation-structure.html"><i class="fa fa-check"></i><b>4</b> Structure of a simulation study</a>
<ul>
<li class="chapter" data-level="4.1" data-path="simulation-structure.html"><a href="simulation-structure.html#general-structure-of-a-simulation"><i class="fa fa-check"></i><b>4.1</b> General structure of a simulation</a></li>
<li class="chapter" data-level="4.2" data-path="simulation-structure.html"><a href="simulation-structure.html#tidy-modular-simulations"><i class="fa fa-check"></i><b>4.2</b> Tidy, modular simulations</a></li>
<li class="chapter" data-level="4.3" data-path="simulation-structure.html"><a href="simulation-structure.html#skeleton-of-a-simulation-study"><i class="fa fa-check"></i><b>4.3</b> Skeleton of a simulation study</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="simulation-structure.html"><a href="simulation-structure.html#data-generating-process"><i class="fa fa-check"></i><b>4.3.1</b> Data-Generating Process</a></li>
<li class="chapter" data-level="4.3.2" data-path="simulation-structure.html"><a href="simulation-structure.html#data-analysis-procedure"><i class="fa fa-check"></i><b>4.3.2</b> Data Analysis Procedure</a></li>
<li class="chapter" data-level="4.3.3" data-path="simulation-structure.html"><a href="simulation-structure.html#repetition"><i class="fa fa-check"></i><b>4.3.3</b> Repetition</a></li>
<li class="chapter" data-level="4.3.4" data-path="simulation-structure.html"><a href="simulation-structure.html#performance-summaries"><i class="fa fa-check"></i><b>4.3.4</b> Performance summaries</a></li>
<li class="chapter" data-level="4.3.5" data-path="simulation-structure.html"><a href="simulation-structure.html#multifactor-simulations"><i class="fa fa-check"></i><b>4.3.5</b> Multifactor simulations</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="simulation-structure.html"><a href="simulation-structure.html#exercises-2"><i class="fa fa-check"></i><b>4.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="case-ANOVA.html"><a href="case-ANOVA.html"><i class="fa fa-check"></i><b>5</b> Case Study: Heteroskedastic ANOVA</a>
<ul>
<li class="chapter" data-level="5.1" data-path="case-ANOVA.html"><a href="case-ANOVA.html#case-anova-DGP"><i class="fa fa-check"></i><b>5.1</b> The data-generating model</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="case-ANOVA.html"><a href="case-ANOVA.html#now-make-a-function"><i class="fa fa-check"></i><b>5.1.1</b> Now make a function</a></li>
<li class="chapter" data-level="5.1.2" data-path="case-ANOVA.html"><a href="case-ANOVA.html#cautious-coding"><i class="fa fa-check"></i><b>5.1.2</b> Cautious coding</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="case-ANOVA.html"><a href="case-ANOVA.html#the-hypothesis-testing-procedures"><i class="fa fa-check"></i><b>5.2</b> The hypothesis testing procedures</a></li>
<li class="chapter" data-level="5.3" data-path="case-ANOVA.html"><a href="case-ANOVA.html#running-the-simulation"><i class="fa fa-check"></i><b>5.3</b> Running the simulation</a></li>
<li class="chapter" data-level="5.4" data-path="case-ANOVA.html"><a href="case-ANOVA.html#summarizing-test-performance"><i class="fa fa-check"></i><b>5.4</b> Summarizing test performance</a></li>
<li class="chapter" data-level="5.5" data-path="case-ANOVA.html"><a href="case-ANOVA.html#exAnovaExercises"><i class="fa fa-check"></i><b>5.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="data-generating-processes.html"><a href="data-generating-processes.html"><i class="fa fa-check"></i><b>6</b> Data-generating processes</a>
<ul>
<li class="chapter" data-level="6.1" data-path="data-generating-processes.html"><a href="data-generating-processes.html#DGP-examples"><i class="fa fa-check"></i><b>6.1</b> Examples</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="data-generating-processes.html"><a href="data-generating-processes.html#ANOVA-example"><i class="fa fa-check"></i><b>6.1.1</b> Example 1: One-way analysis of variance</a></li>
<li class="chapter" data-level="6.1.2" data-path="data-generating-processes.html"><a href="data-generating-processes.html#BVPois-example"><i class="fa fa-check"></i><b>6.1.2</b> Example 2: Bivariate Poisson model</a></li>
<li class="chapter" data-level="6.1.3" data-path="data-generating-processes.html"><a href="data-generating-processes.html#CRT-example"><i class="fa fa-check"></i><b>6.1.3</b> Example 3: Hierarchical linear model for a cluster-randomized trial</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="data-generating-processes.html"><a href="data-generating-processes.html#components-of-a-dgp"><i class="fa fa-check"></i><b>6.2</b> Components of a DGP</a></li>
<li class="chapter" data-level="6.3" data-path="data-generating-processes.html"><a href="data-generating-processes.html#DGP-functions"><i class="fa fa-check"></i><b>6.3</b> A statistical model is a recipe for data generation</a></li>
<li class="chapter" data-level="6.4" data-path="data-generating-processes.html"><a href="data-generating-processes.html#DGP-plotting"><i class="fa fa-check"></i><b>6.4</b> Plot the artificial data</a></li>
<li class="chapter" data-level="6.5" data-path="data-generating-processes.html"><a href="data-generating-processes.html#check-the-data-generating-function"><i class="fa fa-check"></i><b>6.5</b> Check the data-generating function</a></li>
<li class="chapter" data-level="6.6" data-path="data-generating-processes.html"><a href="data-generating-processes.html#case-cluster"><i class="fa fa-check"></i><b>6.6</b> Example: Simulating clustered data</a>
<ul>
<li class="chapter" data-level="6.6.1" data-path="data-generating-processes.html"><a href="data-generating-processes.html#a-design-decision-what-do-we-want-to-manipulate"><i class="fa fa-check"></i><b>6.6.1</b> A design decision: What do we want to manipulate?</a></li>
<li class="chapter" data-level="6.6.2" data-path="data-generating-processes.html"><a href="data-generating-processes.html#a-model-for-a-cluster-rct"><i class="fa fa-check"></i><b>6.6.2</b> A model for a cluster RCT</a></li>
<li class="chapter" data-level="6.6.3" data-path="data-generating-processes.html"><a href="data-generating-processes.html#from-equations-to-code"><i class="fa fa-check"></i><b>6.6.3</b> From equations to code</a></li>
<li class="chapter" data-level="6.6.4" data-path="data-generating-processes.html"><a href="data-generating-processes.html#DGP-standardization"><i class="fa fa-check"></i><b>6.6.4</b> Standardization in the DGP</a></li>
</ul></li>
<li class="chapter" data-level="6.7" data-path="data-generating-processes.html"><a href="data-generating-processes.html#three-parameter-IRT"><i class="fa fa-check"></i><b>6.7</b> Sometimes a DGP is all you need</a></li>
<li class="chapter" data-level="6.8" data-path="data-generating-processes.html"><a href="data-generating-processes.html#more-to-explore"><i class="fa fa-check"></i><b>6.8</b> More to explore</a></li>
<li class="chapter" data-level="6.9" data-path="data-generating-processes.html"><a href="data-generating-processes.html#exercises-3"><i class="fa fa-check"></i><b>6.9</b> Exercises</a>
<ul>
<li class="chapter" data-level="6.9.1" data-path="data-generating-processes.html"><a href="data-generating-processes.html#Welch-t-dgp"><i class="fa fa-check"></i><b>6.9.1</b> The Welch test on a shifted-and-scaled <span class="math inline">\(t\)</span> distribution</a></li>
<li class="chapter" data-level="6.9.2" data-path="data-generating-processes.html"><a href="data-generating-processes.html#plot-the-bivariate-poisson"><i class="fa fa-check"></i><b>6.9.2</b> Plot the bivariate Poisson</a></li>
<li class="chapter" data-level="6.9.3" data-path="data-generating-processes.html"><a href="data-generating-processes.html#BVP-check"><i class="fa fa-check"></i><b>6.9.3</b> Check the bivariate Poisson function</a></li>
<li class="chapter" data-level="6.9.4" data-path="data-generating-processes.html"><a href="data-generating-processes.html#BVP-error"><i class="fa fa-check"></i><b>6.9.4</b> Add error-catching to the bivariate Poisson function</a></li>
<li class="chapter" data-level="6.9.5" data-path="data-generating-processes.html"><a href="data-generating-processes.html#BVNB1"><i class="fa fa-check"></i><b>6.9.5</b> A bivariate negative binomial distribution</a></li>
<li class="chapter" data-level="6.9.6" data-path="data-generating-processes.html"><a href="data-generating-processes.html#BVNB2"><i class="fa fa-check"></i><b>6.9.6</b> Another bivariate negative binomial distribution</a></li>
<li class="chapter" data-level="6.9.7" data-path="data-generating-processes.html"><a href="data-generating-processes.html#cluster-RCT-plot"><i class="fa fa-check"></i><b>6.9.7</b> Plot the data from a cluster-randomized trial</a></li>
<li class="chapter" data-level="6.9.8" data-path="data-generating-processes.html"><a href="data-generating-processes.html#cluster-RCT-checks"><i class="fa fa-check"></i><b>6.9.8</b> Checking the Cluster RCT DGP</a></li>
<li class="chapter" data-level="6.9.9" data-path="data-generating-processes.html"><a href="data-generating-processes.html#cluster-RCT-heterogeneity"><i class="fa fa-check"></i><b>6.9.9</b> More school-level variation</a></li>
<li class="chapter" data-level="6.9.10" data-path="data-generating-processes.html"><a href="data-generating-processes.html#cluster-RCT-baseline"><i class="fa fa-check"></i><b>6.9.10</b> Cluster-randomized trial with baseline predictors</a></li>
<li class="chapter" data-level="6.9.11" data-path="data-generating-processes.html"><a href="data-generating-processes.html#IRT-DGP-parameters"><i class="fa fa-check"></i><b>6.9.11</b> 3-parameter IRT datasets</a></li>
<li class="chapter" data-level="6.9.12" data-path="data-generating-processes.html"><a href="data-generating-processes.html#IRT-DGP-checking"><i class="fa fa-check"></i><b>6.9.12</b> Check the 3-parameter IRT DGP</a></li>
<li class="chapter" data-level="6.9.13" data-path="data-generating-processes.html"><a href="data-generating-processes.html#IRT-DGP-breaking"><i class="fa fa-check"></i><b>6.9.13</b> Explore the 3-parameter IRT model</a></li>
<li class="chapter" data-level="6.9.14" data-path="data-generating-processes.html"><a href="data-generating-processes.html#meta-regression-DGP"><i class="fa fa-check"></i><b>6.9.14</b> Random effects meta-regression</a></li>
<li class="chapter" data-level="6.9.15" data-path="data-generating-processes.html"><a href="data-generating-processes.html#Vevea-Hedges-DGP"><i class="fa fa-check"></i><b>6.9.15</b> Meta-regression with selective reporting</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html"><i class="fa fa-check"></i><b>7</b> Data analysis procedures</a>
<ul>
<li class="chapter" data-level="7.1" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#estimation-functions"><i class="fa fa-check"></i><b>7.1</b> Writing estimation functions</a></li>
<li class="chapter" data-level="7.2" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#multiple-estimation-procedures"><i class="fa fa-check"></i><b>7.2</b> Including Multiple Data Analysis Procedures</a></li>
<li class="chapter" data-level="7.3" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#validating-an-estimation-function"><i class="fa fa-check"></i><b>7.3</b> Validating an Estimation Function</a>
<ul>
<li class="chapter" data-level="7.3.1" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#checking-against-existing-implementations"><i class="fa fa-check"></i><b>7.3.1</b> Checking against existing implementations</a></li>
<li class="chapter" data-level="7.3.2" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#checking-novel-procedures"><i class="fa fa-check"></i><b>7.3.2</b> Checking novel procedures</a></li>
<li class="chapter" data-level="7.3.3" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#checking-with-simulations"><i class="fa fa-check"></i><b>7.3.3</b> Checking with simulations</a></li>
</ul></li>
<li class="chapter" data-level="7.4" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#handling-errors-warnings-and-other-hiccups"><i class="fa fa-check"></i><b>7.4</b> Handling errors, warnings, and other hiccups</a>
<ul>
<li class="chapter" data-level="7.4.1" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#capturing-errors-and-warnings"><i class="fa fa-check"></i><b>7.4.1</b> Capturing errors and warnings</a></li>
<li class="chapter" data-level="7.4.2" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#adapting-for-errors"><i class="fa fa-check"></i><b>7.4.2</b> Adapting estimation procedures for errors and warnings</a></li>
</ul></li>
<li class="chapter" data-level="7.5" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#exercises-4"><i class="fa fa-check"></i><b>7.5</b> Exercises</a>
<ul>
<li class="chapter" data-level="7.5.1" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#BFFs-forever"><i class="fa fa-check"></i><b>7.5.1</b> More Heteroskedastic ANOVA</a></li>
<li class="chapter" data-level="7.5.2" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#contingent-testing"><i class="fa fa-check"></i><b>7.5.2</b> Contingent testing</a></li>
<li class="chapter" data-level="7.5.3" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#cross-check-CRT-estimators"><i class="fa fa-check"></i><b>7.5.3</b> Check the cluster-RCT functions</a></li>
<li class="chapter" data-level="7.5.4" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#CRT-ANCOVA-estimators"><i class="fa fa-check"></i><b>7.5.4</b> Extending the cluster-RCT functions</a></li>
<li class="chapter" data-level="7.5.5" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#contingent-estimator-processing"><i class="fa fa-check"></i><b>7.5.5</b> Contingent estimator processing</a></li>
<li class="chapter" data-level="7.5.6" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#IRT-3PL-estimation"><i class="fa fa-check"></i><b>7.5.6</b> Estimating 3-parameter item response theory models</a></li>
<li class="chapter" data-level="7.5.7" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#Vevea-Hedges-estimation"><i class="fa fa-check"></i><b>7.5.7</b> Meta-regression with selective reporting</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html"><i class="fa fa-check"></i><b>8</b> Running the Simulation Process</a>
<ul>
<li class="chapter" data-level="8.1" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#repeating-oneself"><i class="fa fa-check"></i><b>8.1</b> Repeating oneself</a></li>
<li class="chapter" data-level="8.2" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#one-run-at-a-time"><i class="fa fa-check"></i><b>8.2</b> One run at a time</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#one-run-reparameterization"><i class="fa fa-check"></i><b>8.2.1</b> Reparameterizing</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#bundle-sim-demo"><i class="fa fa-check"></i><b>8.3</b> Bundling simulations with <code>simhelpers</code></a></li>
<li class="chapter" data-level="8.4" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#seeds-and-pseudo-RNGs"><i class="fa fa-check"></i><b>8.4</b> Seeds and pseudo-random number generators</a></li>
<li class="chapter" data-level="8.5" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#exercises-5"><i class="fa fa-check"></i><b>8.5</b> Exercises</a>
<ul>
<li class="chapter" data-level="8.5.1" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#Welch-simulation"><i class="fa fa-check"></i><b>8.5.1</b> Welch simulations</a></li>
<li class="chapter" data-level="8.5.2" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#Pearson-sampling-distributions"><i class="fa fa-check"></i><b>8.5.2</b> Compare sampling distributions of Pearson’s correlation coefficients</a></li>
<li class="chapter" data-level="8.5.3" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#reparameterization-redux"><i class="fa fa-check"></i><b>8.5.3</b> Reparameterization, redux</a></li>
<li class="chapter" data-level="8.5.4" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#fancy-cluster-RCT-sims"><i class="fa fa-check"></i><b>8.5.4</b> Fancy clustered RCT simulations</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="performance-criteria.html"><a href="performance-criteria.html"><i class="fa fa-check"></i><b>9</b> Performance criteria</a>
<ul>
<li class="chapter" data-level="9.1" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-point-estimators"><i class="fa fa-check"></i><b>9.1</b> Assessing a Point Estimator</a>
<ul>
<li class="chapter" data-level="9.1.1" data-path="performance-criteria.html"><a href="performance-criteria.html#comparing-the-performances-of-the-cluster-rct-estimation-procedures"><i class="fa fa-check"></i><b>9.1.1</b> Comparing the Performances of the Cluster RCT Estimation Procedures</a></li>
<li class="chapter" data-level="9.1.2" data-path="performance-criteria.html"><a href="performance-criteria.html#estimands-not-represented-by-a-parameter"><i class="fa fa-check"></i><b>9.1.2</b> Estimands Not Represented By a Parameter</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-a-standard-error-estimator"><i class="fa fa-check"></i><b>9.2</b> Assessing a Standard Error Estimator</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="performance-criteria.html"><a href="performance-criteria.html#why-not-assess-the-estimated-se-directly"><i class="fa fa-check"></i><b>9.2.1</b> Why Not Assess the Estimated SE directly?</a></li>
<li class="chapter" data-level="9.2.2" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-ses-for-our-cluster-rct-simulation"><i class="fa fa-check"></i><b>9.2.2</b> Assessing SEs for Our Cluster RCT Simulation</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-confidence-intervals"><i class="fa fa-check"></i><b>9.3</b> Assessing Confidence Intervals</a>
<ul>
<li class="chapter" data-level="9.3.1" data-path="performance-criteria.html"><a href="performance-criteria.html#confidence-intervals-in-our-cluster-rct-example"><i class="fa fa-check"></i><b>9.3.1</b> Confidence Intervals in our Cluster RCT Example</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-inferential-procedures"><i class="fa fa-check"></i><b>9.4</b> Assessing an Inferential Procedure (Hypothesis Testing)</a>
<ul>
<li class="chapter" data-level="9.4.1" data-path="performance-criteria.html"><a href="performance-criteria.html#validity"><i class="fa fa-check"></i><b>9.4.1</b> Validity</a></li>
<li class="chapter" data-level="9.4.2" data-path="performance-criteria.html"><a href="performance-criteria.html#power"><i class="fa fa-check"></i><b>9.4.2</b> Power</a></li>
<li class="chapter" data-level="9.4.3" data-path="performance-criteria.html"><a href="performance-criteria.html#the-rejection-rate"><i class="fa fa-check"></i><b>9.4.3</b> The Rejection Rate</a></li>
<li class="chapter" data-level="9.4.4" data-path="performance-criteria.html"><a href="performance-criteria.html#inference-in-our-cluster-rct-simulation"><i class="fa fa-check"></i><b>9.4.4</b> Inference in our Cluster RCT Simulation</a></li>
</ul></li>
<li class="chapter" data-level="9.5" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-confidence-intervals"><i class="fa fa-check"></i><b>9.5</b> Assessing Confidence Intervals</a>
<ul>
<li class="chapter" data-level="9.5.1" data-path="performance-criteria.html"><a href="performance-criteria.html#confidence-intervals-in-our-cluster-rct-example-1"><i class="fa fa-check"></i><b>9.5.1</b> Confidence Intervals in our Cluster RCT Example</a></li>
</ul></li>
<li class="chapter" data-level="9.6" data-path="performance-criteria.html"><a href="performance-criteria.html#additional-thoughts-on-measuring-performance"><i class="fa fa-check"></i><b>9.6</b> Additional Thoughts on Measuring Performance</a>
<ul>
<li class="chapter" data-level="9.6.1" data-path="performance-criteria.html"><a href="performance-criteria.html#sec-relative-performance"><i class="fa fa-check"></i><b>9.6.1</b> Selecting Relative vs. Absolute Criteria</a></li>
<li class="chapter" data-level="9.6.2" data-path="performance-criteria.html"><a href="performance-criteria.html#robust-measures-of-performance"><i class="fa fa-check"></i><b>9.6.2</b> Robust Measures of Performance</a></li>
<li class="chapter" data-level="9.6.3" data-path="performance-criteria.html"><a href="performance-criteria.html#summary-of-peformance-measures"><i class="fa fa-check"></i><b>9.6.3</b> Summary of Peformance Measures</a></li>
</ul></li>
<li class="chapter" data-level="9.7" data-path="performance-criteria.html"><a href="performance-criteria.html#MCSE"><i class="fa fa-check"></i><b>9.7</b> Uncertainty in Performance Estimates (the Monte Carlo Standard Error)</a>
<ul>
<li class="chapter" data-level="9.7.1" data-path="performance-criteria.html"><a href="performance-criteria.html#mcse-for-relative-variance-estimators"><i class="fa fa-check"></i><b>9.7.1</b> MCSE for Relative Variance Estimators</a></li>
<li class="chapter" data-level="9.7.2" data-path="performance-criteria.html"><a href="performance-criteria.html#calculating-mcses-with-the-simhelpers-package"><i class="fa fa-check"></i><b>9.7.2</b> Calculating MCSEs With the <code>simhelpers</code> Package</a></li>
<li class="chapter" data-level="9.7.3" data-path="performance-criteria.html"><a href="performance-criteria.html#mcse-calculation-in-our-cluster-rct-example"><i class="fa fa-check"></i><b>9.7.3</b> MCSE Calculation in our Cluster RCT Example</a></li>
</ul></li>
<li class="chapter" data-level="9.8" data-path="performance-criteria.html"><a href="performance-criteria.html#exercises-6"><i class="fa fa-check"></i><b>9.8</b> Exercises</a></li>
</ul></li>
<li class="part"><span><b>III Multifactor Simulations</b></span></li>
<li class="chapter" data-level="10" data-path="exp-design.html"><a href="exp-design.html"><i class="fa fa-check"></i><b>10</b> Designing and executing multifactor simulations</a>
<ul>
<li class="chapter" data-level="10.1" data-path="exp-design.html"><a href="exp-design.html#choosing-parameter-combinations"><i class="fa fa-check"></i><b>10.1</b> Choosing parameter combinations</a></li>
<li class="chapter" data-level="10.2" data-path="exp-design.html"><a href="exp-design.html#using-pmap-to-run-multifactor-simulations"><i class="fa fa-check"></i><b>10.2</b> Using pmap to run multifactor simulations</a></li>
<li class="chapter" data-level="10.3" data-path="exp-design.html"><a href="exp-design.html#when-to-calculate-performance-metrics"><i class="fa fa-check"></i><b>10.3</b> When to calculate performance metrics</a>
<ul>
<li class="chapter" data-level="10.3.1" data-path="exp-design.html"><a href="exp-design.html#aggregate-as-you-simulate-inside"><i class="fa fa-check"></i><b>10.3.1</b> Aggregate as you simulate (inside)</a></li>
<li class="chapter" data-level="10.3.2" data-path="exp-design.html"><a href="exp-design.html#keep-all-simulation-runs-outside"><i class="fa fa-check"></i><b>10.3.2</b> Keep all simulation runs (outside)</a></li>
<li class="chapter" data-level="10.3.3" data-path="exp-design.html"><a href="exp-design.html#getting-raw-results-ready-for-analysis"><i class="fa fa-check"></i><b>10.3.3</b> Getting raw results ready for analysis</a></li>
</ul></li>
<li class="chapter" data-level="10.4" data-path="exp-design.html"><a href="exp-design.html#a-multifactor-evaluation-of-cluster-rct-estimators"><i class="fa fa-check"></i><b>10.4</b> A multifactor evaluation of cluster RCT estimators</a>
<ul>
<li class="chapter" data-level="10.4.1" data-path="exp-design.html"><a href="exp-design.html#choosing-parameters-for-the-clustered-rct"><i class="fa fa-check"></i><b>10.4.1</b> Choosing parameters for the Clustered RCT</a></li>
<li class="chapter" data-level="10.4.2" data-path="exp-design.html"><a href="exp-design.html#redundant-factor-combinations"><i class="fa fa-check"></i><b>10.4.2</b> Redundant factor combinations</a></li>
<li class="chapter" data-level="10.4.3" data-path="exp-design.html"><a href="exp-design.html#running-the-simulations"><i class="fa fa-check"></i><b>10.4.3</b> Running the simulations</a></li>
<li class="chapter" data-level="10.4.4" data-path="exp-design.html"><a href="exp-design.html#calculating-performance-metrics"><i class="fa fa-check"></i><b>10.4.4</b> Calculating performance metrics</a></li>
</ul></li>
<li class="chapter" data-level="10.5" data-path="exp-design.html"><a href="exp-design.html#exercises-7"><i class="fa fa-check"></i><b>10.5</b> Exercises</a>
<ul>
<li class="chapter" data-level="10.5.1" data-path="exp-design.html"><a href="exp-design.html#brown-and-forsythe-redux"><i class="fa fa-check"></i><b>10.5.1</b> Brown and Forsythe redux</a></li>
<li class="chapter" data-level="10.5.2" data-path="exp-design.html"><a href="exp-design.html#meta-regression"><i class="fa fa-check"></i><b>10.5.2</b> Meta-regression</a></li>
<li class="chapter" data-level="10.5.3" data-path="exp-design.html"><a href="exp-design.html#exercise:trimmed-mean"><i class="fa fa-check"></i><b>10.5.3</b> Comparing the trimmed mean, median and mean</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="11" data-path="presentation-of-results.html"><a href="presentation-of-results.html"><i class="fa fa-check"></i><b>11</b> Exploring and presenting simulation results</a>
<ul>
<li class="chapter" data-level="11.1" data-path="presentation-of-results.html"><a href="presentation-of-results.html#tabulation"><i class="fa fa-check"></i><b>11.1</b> Tabulation</a>
<ul>
<li class="chapter" data-level="11.1.1" data-path="presentation-of-results.html"><a href="presentation-of-results.html#example-estimators-of-treatment-variation"><i class="fa fa-check"></i><b>11.1.1</b> Example: estimators of treatment variation</a></li>
</ul></li>
<li class="chapter" data-level="11.2" data-path="presentation-of-results.html"><a href="presentation-of-results.html#visualization"><i class="fa fa-check"></i><b>11.2</b> Visualization</a>
<ul>
<li class="chapter" data-level="11.2.1" data-path="presentation-of-results.html"><a href="presentation-of-results.html#example-1-biserial-correlation-estimation"><i class="fa fa-check"></i><b>11.2.1</b> Example 1: Biserial correlation estimation</a></li>
<li class="chapter" data-level="11.2.2" data-path="presentation-of-results.html"><a href="presentation-of-results.html#example-2-variance-estimation-and-meta-regression"><i class="fa fa-check"></i><b>11.2.2</b> Example 2: Variance estimation and Meta-regression</a></li>
<li class="chapter" data-level="11.2.3" data-path="presentation-of-results.html"><a href="presentation-of-results.html#example-3-heat-maps-of-coverage"><i class="fa fa-check"></i><b>11.2.3</b> Example 3: Heat maps of coverage</a></li>
<li class="chapter" data-level="11.2.4" data-path="presentation-of-results.html"><a href="presentation-of-results.html#example-4-relative-performance-of-treatment-effect-estimators"><i class="fa fa-check"></i><b>11.2.4</b> Example 4: Relative performance of treatment effect estimators</a></li>
</ul></li>
<li class="chapter" data-level="11.3" data-path="presentation-of-results.html"><a href="presentation-of-results.html#modeling"><i class="fa fa-check"></i><b>11.3</b> Modeling</a>
<ul>
<li class="chapter" data-level="11.3.1" data-path="presentation-of-results.html"><a href="presentation-of-results.html#example-1-biserial-revisited"><i class="fa fa-check"></i><b>11.3.1</b> Example 1: Biserial, revisited</a></li>
<li class="chapter" data-level="11.3.2" data-path="presentation-of-results.html"><a href="presentation-of-results.html#example-2-comparing-methods-for-cross-classified-data"><i class="fa fa-check"></i><b>11.3.2</b> Example 2: Comparing methods for cross-classified data</a></li>
</ul></li>
<li class="chapter" data-level="11.4" data-path="presentation-of-results.html"><a href="presentation-of-results.html#reporting"><i class="fa fa-check"></i><b>11.4</b> Reporting</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="building-good-visualizations.html"><a href="building-good-visualizations.html"><i class="fa fa-check"></i><b>12</b> Building good visualizations</a>
<ul>
<li class="chapter" data-level="12.1" data-path="building-good-visualizations.html"><a href="building-good-visualizations.html#subsetting-and-many-small-multiples"><i class="fa fa-check"></i><b>12.1</b> Subsetting and Many Small Multiples</a></li>
<li class="chapter" data-level="12.2" data-path="building-good-visualizations.html"><a href="building-good-visualizations.html#bundling"><i class="fa fa-check"></i><b>12.2</b> Bundling</a></li>
<li class="chapter" data-level="12.3" data-path="building-good-visualizations.html"><a href="building-good-visualizations.html#aggregation"><i class="fa fa-check"></i><b>12.3</b> Aggregation</a></li>
<li class="chapter" data-level="12.4" data-path="building-good-visualizations.html"><a href="building-good-visualizations.html#assessing-true-ses"><i class="fa fa-check"></i><b>12.4</b> Assessing true SEs</a></li>
<li class="chapter" data-level="12.5" data-path="building-good-visualizations.html"><a href="building-good-visualizations.html#the-bias-se-rmse-plot"><i class="fa fa-check"></i><b>12.5</b> The Bias-SE-RMSE plot</a></li>
<li class="chapter" data-level="12.6" data-path="building-good-visualizations.html"><a href="building-good-visualizations.html#assessing-estimated-ses"><i class="fa fa-check"></i><b>12.6</b> Assessing estimated SEs</a></li>
<li class="chapter" data-level="12.7" data-path="building-good-visualizations.html"><a href="building-good-visualizations.html#assessing-confidence-intervals-1"><i class="fa fa-check"></i><b>12.7</b> Assessing confidence intervals</a></li>
<li class="chapter" data-level="12.8" data-path="building-good-visualizations.html"><a href="building-good-visualizations.html#exercises-8"><i class="fa fa-check"></i><b>12.8</b> Exercises</a>
<ul>
<li class="chapter" data-level="12.8.1" data-path="building-good-visualizations.html"><a href="building-good-visualizations.html#assessing-uncertainty"><i class="fa fa-check"></i><b>12.8.1</b> Assessing uncertainty</a></li>
<li class="chapter" data-level="12.8.2" data-path="building-good-visualizations.html"><a href="building-good-visualizations.html#assessing-power"><i class="fa fa-check"></i><b>12.8.2</b> Assessing power</a></li>
<li class="chapter" data-level="12.8.3" data-path="building-good-visualizations.html"><a href="building-good-visualizations.html#going-deeper-with-coverage"><i class="fa fa-check"></i><b>12.8.3</b> Going deeper with coverage</a></li>
<li class="chapter" data-level="12.8.4" data-path="building-good-visualizations.html"><a href="building-good-visualizations.html#pearson-correlations-with-a-bivariate-poisson-distribution"><i class="fa fa-check"></i><b>12.8.4</b> Pearson correlations with a bivariate Poisson distribution</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="13" data-path="special-topics-on-reporting-simulation-results.html"><a href="special-topics-on-reporting-simulation-results.html"><i class="fa fa-check"></i><b>13</b> Special Topics on Reporting Simulation Results</a>
<ul>
<li class="chapter" data-level="13.1" data-path="special-topics-on-reporting-simulation-results.html"><a href="special-topics-on-reporting-simulation-results.html#using-regression-to-analyze-simulation-results"><i class="fa fa-check"></i><b>13.1</b> Using regression to analyze simulation results</a>
<ul>
<li class="chapter" data-level="13.1.1" data-path="special-topics-on-reporting-simulation-results.html"><a href="special-topics-on-reporting-simulation-results.html#example-1-biserial-revisited-1"><i class="fa fa-check"></i><b>13.1.1</b> Example 1: Biserial, revisited</a></li>
<li class="chapter" data-level="13.1.2" data-path="special-topics-on-reporting-simulation-results.html"><a href="special-topics-on-reporting-simulation-results.html#example-2-cluster-rct-example-revisited"><i class="fa fa-check"></i><b>13.1.2</b> Example 2: Cluster RCT example, revisited</a></li>
</ul></li>
<li class="chapter" data-level="13.2" data-path="special-topics-on-reporting-simulation-results.html"><a href="special-topics-on-reporting-simulation-results.html#using-regression-trees-to-find-important-factors"><i class="fa fa-check"></i><b>13.2</b> Using regression trees to find important factors</a></li>
<li class="chapter" data-level="13.3" data-path="special-topics-on-reporting-simulation-results.html"><a href="special-topics-on-reporting-simulation-results.html#analyzing-results-with-few-iterations-per-scenario"><i class="fa fa-check"></i><b>13.3</b> Analyzing results with few iterations per scenario</a>
<ul>
<li class="chapter" data-level="13.3.1" data-path="special-topics-on-reporting-simulation-results.html"><a href="special-topics-on-reporting-simulation-results.html#example-clusterrct-with-only-100-replicates-per-scenario"><i class="fa fa-check"></i><b>13.3.1</b> Example: ClusterRCT with only 100 replicates per scenario</a></li>
</ul></li>
<li class="chapter" data-level="13.4" data-path="special-topics-on-reporting-simulation-results.html"><a href="special-topics-on-reporting-simulation-results.html#analyzing-results-when-some-trials-have-failed"><i class="fa fa-check"></i><b>13.4</b> Analyzing results when some trials have failed</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="case-study-comparing-different-estimators.html"><a href="case-study-comparing-different-estimators.html"><i class="fa fa-check"></i><b>14</b> Case study: Comparing different estimators</a>
<ul>
<li class="chapter" data-level="14.1" data-path="case-study-comparing-different-estimators.html"><a href="case-study-comparing-different-estimators.html#bias-variance-tradeoffs"><i class="fa fa-check"></i><b>14.1</b> Bias-variance tradeoffs</a></li>
</ul></li>
<li class="part"><span><b>IV Computational Considerations</b></span></li>
<li class="chapter" data-level="15" data-path="optimize-code.html"><a href="optimize-code.html"><i class="fa fa-check"></i><b>15</b> Optimizing code (and why you often shouldn’t)</a>
<ul>
<li class="chapter" data-level="15.1" data-path="optimize-code.html"><a href="optimize-code.html#hand-building-functions"><i class="fa fa-check"></i><b>15.1</b> Hand-building functions</a></li>
<li class="chapter" data-level="15.2" data-path="optimize-code.html"><a href="optimize-code.html#sec_comp_efficiency"><i class="fa fa-check"></i><b>15.2</b> Computational efficiency versus simplicity</a></li>
<li class="chapter" data-level="15.3" data-path="optimize-code.html"><a href="optimize-code.html#reusing-code-to-speed-up-computation"><i class="fa fa-check"></i><b>15.3</b> Reusing code to speed up computation</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="error-trapping-and-other-headaches.html"><a href="error-trapping-and-other-headaches.html"><i class="fa fa-check"></i><b>16</b> Error trapping and other headaches</a>
<ul>
<li class="chapter" data-level="16.0.1" data-path="error-trapping-and-other-headaches.html"><a href="error-trapping-and-other-headaches.html#what-to-do-with-warnings-in-simulations"><i class="fa fa-check"></i><b>16.0.1</b> What to do with warnings in simulations</a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="saving-files.html"><a href="saving-files.html"><i class="fa fa-check"></i><b>17</b> Saving files and results</a>
<ul>
<li class="chapter" data-level="17.1" data-path="saving-files.html"><a href="saving-files.html#saving-simulations-in-general"><i class="fa fa-check"></i><b>17.1</b> Saving simulations in general</a></li>
<li class="chapter" data-level="17.2" data-path="saving-files.html"><a href="saving-files.html#saving-simulations-as-you-go"><i class="fa fa-check"></i><b>17.2</b> Saving simulations as you go</a></li>
<li class="chapter" data-level="17.3" data-path="saving-files.html"><a href="saving-files.html#dynamically-making-directories"><i class="fa fa-check"></i><b>17.3</b> Dynamically making directories</a></li>
<li class="chapter" data-level="17.4" data-path="saving-files.html"><a href="saving-files.html#loading-and-combining-files-of-simulation-results"><i class="fa fa-check"></i><b>17.4</b> Loading and combining files of simulation results</a></li>
</ul></li>
<li class="chapter" data-level="18" data-path="parallel-processing.html"><a href="parallel-processing.html"><i class="fa fa-check"></i><b>18</b> Parallel Processing</a>
<ul>
<li class="chapter" data-level="18.1" data-path="parallel-processing.html"><a href="parallel-processing.html#parallel-on-your-computer"><i class="fa fa-check"></i><b>18.1</b> Parallel on your computer</a></li>
<li class="chapter" data-level="18.2" data-path="parallel-processing.html"><a href="parallel-processing.html#parallel-off-your-computer"><i class="fa fa-check"></i><b>18.2</b> Parallel off your computer</a>
<ul>
<li class="chapter" data-level="18.2.1" data-path="parallel-processing.html"><a href="parallel-processing.html#what-is-a-command-line-interface"><i class="fa fa-check"></i><b>18.2.1</b> What is a command-line interface?</a></li>
<li class="chapter" data-level="18.2.2" data-path="parallel-processing.html"><a href="parallel-processing.html#running-a-job-on-a-cluster"><i class="fa fa-check"></i><b>18.2.2</b> Running a job on a cluster</a></li>
<li class="chapter" data-level="18.2.3" data-path="parallel-processing.html"><a href="parallel-processing.html#checking-on-a-job"><i class="fa fa-check"></i><b>18.2.3</b> Checking on a job</a></li>
<li class="chapter" data-level="18.2.4" data-path="parallel-processing.html"><a href="parallel-processing.html#running-lots-of-jobs-on-a-cluster"><i class="fa fa-check"></i><b>18.2.4</b> Running lots of jobs on a cluster</a></li>
<li class="chapter" data-level="18.2.5" data-path="parallel-processing.html"><a href="parallel-processing.html#resources-for-harvards-odyssey"><i class="fa fa-check"></i><b>18.2.5</b> Resources for Harvard’s Odyssey</a></li>
<li class="chapter" data-level="18.2.6" data-path="parallel-processing.html"><a href="parallel-processing.html#acknowledgements-1"><i class="fa fa-check"></i><b>18.2.6</b> Acknowledgements</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="19" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html"><i class="fa fa-check"></i><b>19</b> Simulations as evidence</a>
<ul>
<li class="chapter" data-level="19.1" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#strategies-for-making-relevant-simulations"><i class="fa fa-check"></i><b>19.1</b> Strategies for making relevant simulations</a>
<ul>
<li class="chapter" data-level="19.1.1" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#make-your-simulation-general-with-an-extensive-multi-factor-experiment"><i class="fa fa-check"></i><b>19.1.1</b> Make your simulation general with an extensive multi-factor experiment</a></li>
<li class="chapter" data-level="19.1.2" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#use-previously-published-simulations-to-beat-them-at-their-own-game"><i class="fa fa-check"></i><b>19.1.2</b> Use previously published simulations to beat them at their own game</a></li>
<li class="chapter" data-level="19.1.3" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#calibrate-simulation-factors-to-real-data"><i class="fa fa-check"></i><b>19.1.3</b> Calibrate simulation factors to real data</a></li>
<li class="chapter" data-level="19.1.4" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#use-real-data-to-obtain-directly"><i class="fa fa-check"></i><b>19.1.4</b> Use real data to obtain directly</a></li>
<li class="chapter" data-level="19.1.5" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#fully-calibrated-simulations"><i class="fa fa-check"></i><b>19.1.5</b> Fully calibrated simulations</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>V Complex Data Structures</b></span></li>
<li class="chapter" data-level="20" data-path="sec:power.html"><a href="sec:power.html"><i class="fa fa-check"></i><b>20</b> Using simulation as a power calculator</a>
<ul>
<li class="chapter" data-level="20.1" data-path="sec:power.html"><a href="sec:power.html#getting-design-parameters-from-pilot-data"><i class="fa fa-check"></i><b>20.1</b> Getting design parameters from pilot data</a></li>
<li class="chapter" data-level="20.2" data-path="sec:power.html"><a href="sec:power.html#the-data-generating-process"><i class="fa fa-check"></i><b>20.2</b> The data generating process</a></li>
<li class="chapter" data-level="20.3" data-path="sec:power.html"><a href="sec:power.html#running-the-simulation-1"><i class="fa fa-check"></i><b>20.3</b> Running the simulation</a></li>
<li class="chapter" data-level="20.4" data-path="sec:power.html"><a href="sec:power.html#evaluating-power"><i class="fa fa-check"></i><b>20.4</b> Evaluating power</a>
<ul>
<li class="chapter" data-level="20.4.1" data-path="sec:power.html"><a href="sec:power.html#checking-validity-of-our-models"><i class="fa fa-check"></i><b>20.4.1</b> Checking validity of our models</a></li>
<li class="chapter" data-level="20.4.2" data-path="sec:power.html"><a href="sec:power.html#assessing-precision-se"><i class="fa fa-check"></i><b>20.4.2</b> Assessing Precision (SE)</a></li>
<li class="chapter" data-level="20.4.3" data-path="sec:power.html"><a href="sec:power.html#assessing-power-1"><i class="fa fa-check"></i><b>20.4.3</b> Assessing power</a></li>
<li class="chapter" data-level="20.4.4" data-path="sec:power.html"><a href="sec:power.html#assessing-minimum-detectable-effects"><i class="fa fa-check"></i><b>20.4.4</b> Assessing Minimum Detectable Effects</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="21" data-path="potential-outcomes.html"><a href="potential-outcomes.html"><i class="fa fa-check"></i><b>21</b> Simulation under the Potential Outcomes Framework</a>
<ul>
<li class="chapter" data-level="21.1" data-path="potential-outcomes.html"><a href="potential-outcomes.html#finite-vs.-superpopulation-inference"><i class="fa fa-check"></i><b>21.1</b> Finite vs. Superpopulation inference</a></li>
<li class="chapter" data-level="21.2" data-path="potential-outcomes.html"><a href="potential-outcomes.html#data-generation-processes-for-potential-outcomes"><i class="fa fa-check"></i><b>21.2</b> Data generation processes for potential outcomes</a></li>
<li class="chapter" data-level="21.3" data-path="potential-outcomes.html"><a href="potential-outcomes.html#finite-sample-performance-measures"><i class="fa fa-check"></i><b>21.3</b> Finite sample performance measures</a></li>
<li class="chapter" data-level="21.4" data-path="potential-outcomes.html"><a href="potential-outcomes.html#nested-finite-simulation-procedure"><i class="fa fa-check"></i><b>21.4</b> Nested finite simulation procedure</a></li>
</ul></li>
<li class="chapter" data-level="22" data-path="the-parametric-bootstrap.html"><a href="the-parametric-bootstrap.html"><i class="fa fa-check"></i><b>22</b> The Parametric bootstrap</a>
<ul>
<li class="chapter" data-level="22.1" data-path="the-parametric-bootstrap.html"><a href="the-parametric-bootstrap.html#air-conditioners-a-stolen-case-study"><i class="fa fa-check"></i><b>22.1</b> Air conditioners: a stolen case study</a></li>
</ul></li>
<li class="appendix"><span><b>Appendices</b></span></li>
<li class="chapter" data-level="A" data-path="coding-tidbits.html"><a href="coding-tidbits.html"><i class="fa fa-check"></i><b>A</b> Coding tidbits</a>
<ul>
<li class="chapter" data-level="A.1" data-path="coding-tidbits.html"><a href="coding-tidbits.html#more-repeating-oneself"><i class="fa fa-check"></i><b>A.1</b> How to repeat yourself</a>
<ul>
<li class="chapter" data-level="A.1.1" data-path="coding-tidbits.html"><a href="coding-tidbits.html#using-replicate"><i class="fa fa-check"></i><b>A.1.1</b> Using <code>replicate()</code></a></li>
<li class="chapter" data-level="A.1.2" data-path="coding-tidbits.html"><a href="coding-tidbits.html#using-map"><i class="fa fa-check"></i><b>A.1.2</b> Using <code>map()</code></a></li>
<li class="chapter" data-level="A.1.3" data-path="coding-tidbits.html"><a href="coding-tidbits.html#map-with-no-inputs"><i class="fa fa-check"></i><b>A.1.3</b> map with no inputs</a></li>
<li class="chapter" data-level="A.1.4" data-path="coding-tidbits.html"><a href="coding-tidbits.html#other-approaches-for-repetition"><i class="fa fa-check"></i><b>A.1.4</b> Other approaches for repetition</a></li>
</ul></li>
<li class="chapter" data-level="A.2" data-path="coding-tidbits.html"><a href="coding-tidbits.html#default-arguments"><i class="fa fa-check"></i><b>A.2</b> Default arguments for functions</a></li>
<li class="chapter" data-level="A.3" data-path="coding-tidbits.html"><a href="coding-tidbits.html#about-source-command"><i class="fa fa-check"></i><b>A.3</b> The source command and keeping things organized</a></li>
<li class="chapter" data-level="A.4" data-path="coding-tidbits.html"><a href="coding-tidbits.html#about-keeping-tests-with-FALSE"><i class="fa fa-check"></i><b>A.4</b> Testing and debugging code in your scripts</a></li>
<li class="chapter" data-level="A.5" data-path="coding-tidbits.html"><a href="coding-tidbits.html#about-browser-debugging"><i class="fa fa-check"></i><b>A.5</b> Debugging with browser</a></li>
<li class="chapter" data-level="A.6" data-path="coding-tidbits.html"><a href="coding-tidbits.html#about-stopifnot"><i class="fa fa-check"></i><b>A.6</b> Protecting your functions with “stop”</a></li>
</ul></li>
<li class="chapter" data-level="B" data-path="further-readings-and-resources.html"><a href="further-readings-and-resources.html"><i class="fa fa-check"></i><b>B</b> Further readings and resources</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Designing Monte Carlo Simulations in R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="data-generating-processes" class="section level1 hasAnchor" number="6">
<h1><span class="header-section-number">Chapter 6</span> Data-generating processes<a href="data-generating-processes.html#data-generating-processes" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>As we saw in Chapter <a href="simulation-structure.html#simulation-structure">4</a>, the first step of a simulation is creating artificial data based on some process where we know (and can control) the truth.
This step is what we call the data generating process (DGP).
Think of it as a recipe for cooking up artificial data, which can be applied over and over, any time we’re hungry for a new dataset.
Like a good recipe, a good DGP needs to be complete—it cannot be missing ingredients and it cannot omit any steps.
Unlike cooking or baking, however, DGPs are usually specified in terms of a statistical model, or a set of equations involving constants, parameter values, and random variables.
More complex DGPs, such as those for hierarchical data or other latent variable models, will often involve a series of several equations that describe different dimensions or levels of the model, which need to be followed in sequence to produce an artificial dataset.</p>
<p>In this chapter, we will look at how to instantiate a DGP as an R function (or perhaps a set of functions).
Designing DGPs and implementing them in R code involves making choices about what aspects of the model we want to be able to control and how to set up the parameters of the model.
We start by providing a high-level overview of DGPs and discussing some of the choices and challenges involved in designing them.
We then demonstrate how to write R functions for DGPs.
In the remainder, we present detailed examples involving a hierarchical DGP for generating data on students nested within schools and an item response theory DGP for generating data on responses to individual test items.</p>
<div id="DGP-examples" class="section level2 hasAnchor" number="6.1">
<h2><span class="header-section-number">6.1</span> Examples<a href="data-generating-processes.html#DGP-examples" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Before diving in, it is helpful to consider a few examples that we will return to throughout this and subsequent chapters.</p>
<div id="ANOVA-example" class="section level3 hasAnchor" number="6.1.1">
<h3><span class="header-section-number">6.1.1</span> Example 1: One-way analysis of variance<a href="data-generating-processes.html#ANOVA-example" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We have already seen one example of a DGP in the ANOVA example from Chapter <a href="case-ANOVA.html#case-ANOVA">5</a>. Here, we consider observations on some variable <span class="math inline">\(X\)</span> drawn from a population consisting of <span class="math inline">\(G\)</span> groups, where group <span class="math inline">\(g\)</span> has population mean <span class="math inline">\(\mu_g\)</span> and population variance <span class="math inline">\(\sigma_g^2\)</span> for <span class="math inline">\(g = 1,...,G\)</span>.
A simulated dataset consists of <span class="math inline">\(n_g\)</span> observations from each group <span class="math inline">\(g = 1,...,G\)</span>, where <span class="math inline">\(X_{ig}\)</span> is the measurement for observation <span class="math inline">\(i\)</span> in group <span class="math inline">\(g\)</span>.
The statistical model for these data can be written as follows:
<span class="math display">\[
X_{ig} = \mu_g + \epsilon_{ig}, \quad \mbox{with} \quad \epsilon_{ig} \sim N( 0, \sigma^2_g )
\]</span>
for <span class="math inline">\(i = 1,...,n_g\)</span> and <span class="math inline">\(g = 1,...,G\)</span>.
Alternately, we could write the model as
<span class="math display">\[
X_{ig} \sim N( \mu_g, \sigma_g^2 ).
\]</span></p>
</div>
<div id="BVPois-example" class="section level3 hasAnchor" number="6.1.2">
<h3><span class="header-section-number">6.1.2</span> Example 2: Bivariate Poisson model<a href="data-generating-processes.html#BVPois-example" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>As a second example, suppose that we want to understand how the usual Pearson sample correlation coefficient behaves with non-normal data and also to investigate how the Pearson correlation relates to Spearman’s rank correlation coefficient.
To look into such questions, one DGP we might entertain is a bivariate Poisson model, which is a distribution for a pair of counts, <span class="math inline">\(C_1,C_2\)</span>, where each count follows a Poisson distribution and where the pair of counts may be correlated.
We will denote the expected values of the counts as <span class="math inline">\(\mu_1\)</span> and <span class="math inline">\(\mu_2\)</span> and the Pearson correlation between the counts as <span class="math inline">\(\rho\)</span>.</p>
<p>To simulate a dataset based on this model, we would first need to choose how many observations to generate. Call this sample size <span class="math inline">\(N\)</span>.
One way to generate data following a bivariate Poisson model is to generate <em>three</em> independent Poisson random variables for each of the <span class="math inline">\(N\)</span> observations:
<span class="math display">\[
\begin{aligned}
Z_0 &amp;\sim Pois\left( \rho \sqrt{\mu_1 \mu_2}\right) \\
Z_1 &amp;\sim Pois\left(\mu_1 - \rho \sqrt{\mu_1 \mu_2}\right) \\
Z_2 &amp;\sim Pois\left(\mu_2 - \rho \sqrt{\mu_1 \mu_2}\right)
\end{aligned}
\]</span>
and then combine the pieces to create two dependent observations:
<span class="math display">\[
\begin{aligned}
C_1 &amp;= Z_0 + Z_1 \\
C_2 &amp;= Z_0 + Z_2.
\end{aligned}
\]</span>
An interesting feature of this model is that the range of possible correlations is constrained: only positive correlations are possible and, because each of the independent pieces must have a non-negative mean, the maximum possible correlation is <span class="math inline">\(\sqrt{\frac{\min\{\mu_1,\mu_2\}}{\max\{\mu_1,\mu_2\}}}\)</span>.</p>
</div>
<div id="CRT-example" class="section level3 hasAnchor" number="6.1.3">
<h3><span class="header-section-number">6.1.3</span> Example 3: Hierarchical linear model for a cluster-randomized trial<a href="data-generating-processes.html#CRT-example" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Cluster-randomized trials are randomized experiments where the unit of randomization is a <em>group</em> of individuals, rather than the individuals themselves.
For example, suppose we have a collection of schools and the students within them.
A cluster-randomized trial involves randomizing the <em>schools</em> into treatment or control conditions and then measuring an outcome such as academic performance on the multiple students within the schools.
Typically, researchers will be interested in the extent to which average outcomes differ across schools assigned to different conditions, which captures the impact of the treatment relative to the control condition.
We will index the schools using <span class="math inline">\(j = 1,...,J\)</span> and let <span class="math inline">\(n_j\)</span> denote the number of students observed in school <span class="math inline">\(j\)</span>.
Say that <span class="math inline">\(Y_{ij}\)</span> is the outcome measure for student <span class="math inline">\(i\)</span> in school <span class="math inline">\(j\)</span>, for <span class="math inline">\(1 = 1,...,n_j\)</span> and <span class="math inline">\(j = 1,...,J\)</span>, and let <span class="math inline">\(Z_j\)</span> be an indicator equal to 1 if school <span class="math inline">\(j\)</span> is assigned to the treatment condition and otherwise equal to 0.</p>
<p>A widely used approach for estimating impacts from cluster-randomized trials is heirarchical linear modeling (HLM).
One way to write an HLM is in two parts.
First, we consider a regression model that describes the distribution of the outcomes across students within school <span class="math inline">\(j\)</span>:
<span class="math display">\[
Y_{ij} = \beta_{0j} + \epsilon_{ij}, \qquad \epsilon_{ij} \sim N(0, \sigma_{\epsilon}^2),
\]</span>
where <span class="math inline">\(\beta_{0j}\)</span> is the average outcome across students in school <span class="math inline">\(j\)</span>.
Second, we allow that the school-level average outcomes differ by a treatment effect <span class="math inline">\(\gamma_{1}\)</span> and that, for schools within each condition, the average outcomes follow a normal distribution with variance <span class="math inline">\(\sigma_u^2\)</span>.
We can write these relationships as a regression equation for the school-specific average outcome:
<span class="math display">\[
\beta_{0j} = \gamma_{0} + \gamma_{10} Z_j + u_{0j}, \quad u_{0j} \sim N(0, \tau^2),
\]</span>
where <span class="math inline">\(\gamma_{0}\)</span> is the average outcome among schools in the control condition.</p>
<p>If we only consider the first stage of this model, it looks a bit like the one-way ANOVA model from the previous example:
in both cases, we have multiple observations from each of several groups.<br />
The main distinction is that the ANOVA model treats the <span class="math inline">\(G\)</span> groups as a fixed set, whereas the HLM treats the set of <span class="math inline">\(J\)</span> schools as sampled from a larger population of schools and includes a regression model describing the variation in the school-level average outcomes.</p>
</div>
</div>
<div id="components-of-a-dgp" class="section level2 hasAnchor" number="6.2">
<h2><span class="header-section-number">6.2</span> Components of a DGP<a href="data-generating-processes.html#components-of-a-dgp" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>A DGP involves a statistical model with parameters and random variables, but it also often includes further details as well, beyond those that we would consider to be part of the model as we would use it for analyzing real data.
In statistical analysis of real data, we often use models that describe only <em>part</em> of the distribution of the data, rather than its full, multivariate distribution.
For instance, when conducting a regression analysis, we are analyzing the distribution of an outcome or response variable, conditional on a set of predictor variables.
In other words, we take the predictor variables as <em>given</em> or <em>fixed</em>, rather than modeling their distribution.
When using an item response theory (IRT) model, we use responses to a set of items to estimate individual ability levels, given the set of items on the test.
We do not (usually) model the items themselves.
In contrast, if we are going to <em>generate</em> data for simulating a regression model or IRT model, we need to specify distributions for these additional features (the predictors in a regression model, the items in an IRT model); we can no longer just take them as given.</p>
<p>In designing and discussing DGPs, it is helpful to draw distinctions between the components of the focal statistical model and the remaining components of the DGP that are taken as given when analyzing real data. A first relevant distinction is between structural features, covariates, and outcomes (or more generally, endogenous quantities):</p>
<ul>
<li><strong>Structural features</strong> are quantities, such as the per-group sample sizes in the one-way ANOVA example, that describe the structure of a dataset but do not enter directly into the focal statistical model.
When analyzing real data, we usually take the structural features as they come, but when simulating data, we will need to make choices about the structural features.
For instance, in the HLM example involving students nested within schools, the number of students in each school is a structural feature.
To simulate data based on HLM, we will need to make choices about the number of schools and the distribution of the number of students in each school (e.g., we might specify that school sizes are uniformly distributed between specified minimum and maximum sizes), even though we do not have to consider these quantities when estimating a hierarchical model on real data.</li>
<li><strong>Covariates</strong> are variables in a dataset that we typically take as given when analyzing real data.
For instance, in the one-way ANOVA example, the group assignments of each observation is a covariate.
In the HLM example, covariates would include the treatment indicators <span class="math inline">\(Z_1,...,Z_J\)</span>. In a more elaborate version of the HLM, they might also include variables such as student demographic information, measures of past academic performance, or school-level characteristics such as the school’s geographic region or treatment assignment.
When analyzing real data, we condition on these quantities, but when specifying a DGP, we will need to make choices about how they are distributed (e.g., we might specify that students’ past academic performance is normally distributed).</li>
<li><strong>Outcomes and endogenous quantities</strong> are the variables whose distribution is described by the focal statistical model.
In the one-way ANOVA example, the outcome variable consists of the measurements <span class="math inline">\(X_{ig}\)</span> for <span class="math inline">\(i = 1,...,n_g\)</span> and <span class="math inline">\(g = 1,...,G\)</span>.
In the bivariate Poisson model, the outcomes consist of the component variables <span class="math inline">\(Z_1,Z_2,Z_3\)</span> and the observed counts <span class="math inline">\(C_1,C_2\)</span> because all of these quantities follow distributions that are specified as part of the focal model.
The focal statistical model specifies the distribution of these variables, and we will be interested in estimating the parameters controlling their distribution.</li>
</ul>
<p>Note that the focal statistical model only determines this third component of the DGP. The focal model consists of the equations describing what we would aim to estimate when analyzing real data.
In contrast, the full statistical model also includes additional elements specify how to generate the structural features and covariates—the pieces that are taken as given when analyzing real data.
Table <a href="data-generating-processes.html#tab:real-vs-sim">6.1</a> contrasts the role of structural features, covariates, and outcomes in real data analysis versus in simulations.</p>
<table style="width:100%;">
<caption><span id="tab:real-vs-sim">Table 6.1: </span> Real Data Analysis versus Simulation</caption>
<colgroup>
<col width="15%" />
<col width="42%" />
<col width="42%" />
</colgroup>
<thead>
<tr class="header">
<th>Component</th>
<th>Real world</th>
<th>Simulation world</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Structural features</td>
<td>We obtain data of a given sample size, sizes of clusters, etc.</td>
<td>We specify sample sizes, we specify how to generate cluster sizes</td>
</tr>
<tr class="even">
<td>Covariates</td>
<td>Data come with covariates</td>
<td>We specify how to generate covariates</td>
</tr>
<tr class="odd">
<td>Outcomes</td>
<td>Data come with outcome variables</td>
<td>We generate outcome data based on a focal model</td>
</tr>
<tr class="even">
<td>Parameter estimation</td>
<td>We estimate a statistical model to learn about the unknown parameters</td>
<td>We estimate a statistical model and compare the results to the true parameters</td>
</tr>
</tbody>
</table>
<p>For a given DGP, the full statistical model might involve distributions for structural features, distributions for covariates, and distributions for outcomes given the covariates.
Each of these distributions will involve parameters that control the properties of the distribution (such as the average and degree of variation in a variable).
We think of these parameters as falling into one of three categories: focal, auxiliary, or design.</p>
<ul>
<li><p><strong>Focal</strong> parameters are the quantities that we care about and seek to estimate in real data analysis.
These are typically parts of the focal statistical model, such as the population means <span class="math inline">\(\mu_1,...,\mu_G\)</span> in the one-way ANOVA model, the correlation between counts <span class="math inline">\(\rho\)</span> in the bivariate Poisson model, or the treatment effect <span class="math inline">\(\gamma_{1}\)</span> in the HLM example.</p></li>
<li><p><strong>Auxiliary</strong> parameters are the other quantities that go into the focal statistical model or some other part of the DGP, which we might not be substantively interested in when analyzing real data but which nonetheless affect the analysis.
For instance, in the one-way ANOVA model, we would consider the population variances <span class="math inline">\(\sigma_1^2,...,\sigma_G^2\)</span> to be auxiliary if we are not interested in investigating how they vary from group to group.
In the bivariate Poisson model we might consider the average counts <span class="math inline">\(\mu_1\)</span> and <span class="math inline">\(\mu_2\)</span> to be auxiliary parameters.</p></li>
<li><p><strong>Design</strong> parameters are the quantities that control how we generate structural features of the data.
For instance, in a cluster-randomized trial, the fraction of schools assigned to treatment is a design parameter that can be directly controlled by the researchers.
Additional design parameters might include the minimum and maximum number of students per school.
Typically, in a real data analysis, we would not directly estimate such parameters because we take the distribution of structural features as given.</p></li>
</ul>
<p>It is evident from this discussion that DGPs can involve <em>many</em> moving parts.
One of the central challenges in specifying DGPs is that the performance of estimation methods will generally be affected by the <em>full</em> statistical model—including the design parameters and distribution of structural features and covariates—even though they are not part of the focal model.</p>
</div>
<div id="DGP-functions" class="section level2 hasAnchor" number="6.3">
<h2><span class="header-section-number">6.3</span> A statistical model is a recipe for data generation<a href="data-generating-processes.html#DGP-functions" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Once we have decided on a full statistical model and written it down in mathematical terms, we need to translate it into code.
A function that implements a data-generating model should have the following form:</p>
<div class="sourceCode" id="cb123"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb123-1"><a href="data-generating-processes.html#cb123-1" tabindex="-1"></a>generate_data <span class="ot">&lt;-</span> <span class="cf">function</span>( </span>
<span id="cb123-2"><a href="data-generating-processes.html#cb123-2" tabindex="-1"></a>  focal_parameters, auxiliary_parameters, design_parameters</span>
<span id="cb123-3"><a href="data-generating-processes.html#cb123-3" tabindex="-1"></a>) {</span>
<span id="cb123-4"><a href="data-generating-processes.html#cb123-4" tabindex="-1"></a>  </span>
<span id="cb123-5"><a href="data-generating-processes.html#cb123-5" tabindex="-1"></a>  <span class="co"># generate pseudo-random numbers and use those to make some data</span></span>
<span id="cb123-6"><a href="data-generating-processes.html#cb123-6" tabindex="-1"></a>  </span>
<span id="cb123-7"><a href="data-generating-processes.html#cb123-7" tabindex="-1"></a>  <span class="fu">return</span>(sim_data)</span>
<span id="cb123-8"><a href="data-generating-processes.html#cb123-8" tabindex="-1"></a>}</span></code></pre></div>
<p>The function takes a set of parameter values as input, simulates random numbers and does calculations, and produces as output a set of simulated data.
Typically, the inputs will consist of multiple parameters, and these will include not only the focal model parameters, but also the auxiliary parameters, sample sizes, and other design parameters.
The output will typically be a dataset, mimicking what one would see in an analysis of real data.
In some cases, the output data might be augmented with some other latent quantities (normally unobserved in the real world) that can be used later to assess whether an estimation procedure produces results that are close to the truth.</p>
<p>We have already seen an example of a complete DGP function in the case study on one-way ANOVA (see Section <a href="case-ANOVA.html#case-anova-DGP">5.1</a>).
In this case study, we developed the following function to generate data for a single outcome from a set of <span class="math inline">\(G\)</span> groups:</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb124-1"><a href="data-generating-processes.html#cb124-1" tabindex="-1"></a>generate_ANOVA_data <span class="ot">&lt;-</span> <span class="cf">function</span>(mu, sigma_sq, sample_size) {</span>
<span id="cb124-2"><a href="data-generating-processes.html#cb124-2" tabindex="-1"></a>  </span>
<span id="cb124-3"><a href="data-generating-processes.html#cb124-3" tabindex="-1"></a>  N <span class="ot">&lt;-</span> <span class="fu">sum</span>(sample_size)</span>
<span id="cb124-4"><a href="data-generating-processes.html#cb124-4" tabindex="-1"></a>  G <span class="ot">&lt;-</span> <span class="fu">length</span>(sample_size)</span>
<span id="cb124-5"><a href="data-generating-processes.html#cb124-5" tabindex="-1"></a>  </span>
<span id="cb124-6"><a href="data-generating-processes.html#cb124-6" tabindex="-1"></a>  group <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>G, <span class="at">times =</span> sample_size))</span>
<span id="cb124-7"><a href="data-generating-processes.html#cb124-7" tabindex="-1"></a>  mu_long <span class="ot">&lt;-</span> <span class="fu">rep</span>(mu, <span class="at">times =</span> sample_size)</span>
<span id="cb124-8"><a href="data-generating-processes.html#cb124-8" tabindex="-1"></a>  sigma_long <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">sqrt</span>(sigma_sq), <span class="at">times =</span> sample_size)</span>
<span id="cb124-9"><a href="data-generating-processes.html#cb124-9" tabindex="-1"></a>  </span>
<span id="cb124-10"><a href="data-generating-processes.html#cb124-10" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N, <span class="at">mean =</span> mu_long, <span class="at">sd =</span> sigma_long)</span>
<span id="cb124-11"><a href="data-generating-processes.html#cb124-11" tabindex="-1"></a>  sim_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">group =</span> group, <span class="at">x =</span> x)</span>
<span id="cb124-12"><a href="data-generating-processes.html#cb124-12" tabindex="-1"></a>  </span>
<span id="cb124-13"><a href="data-generating-processes.html#cb124-13" tabindex="-1"></a>  <span class="fu">return</span>(sim_data)</span>
<span id="cb124-14"><a href="data-generating-processes.html#cb124-14" tabindex="-1"></a>}</span></code></pre></div>
<p>This function takes both the focal model parameters (<code>mu</code>, <code>sigma_sq</code>) and other design parameters that one might not think of as parameters per-se (<code>sample_size</code>).
When simulating, we have to specify quantities that we take for granted when analyzing real data.</p>
<p>How would we write a DGP function for the bivariate Poisson model? The equations in Section <a href="data-generating-processes.html#DGP-examples">6.1</a> give us the recipe, so it just a matter of re-expressing them in code.
For this model, the only design parameter is the sample size, <span class="math inline">\(N\)</span>;
the sole focal parameter is the correlation between the variates, <span class="math inline">\(\rho\)</span>; and
the auxiliary parameters are the expected counts <span class="math inline">\(\mu_1\)</span> and <span class="math inline">\(\mu_2\)</span>.
Our function should have all four of these quantities as inputs and should produce as output a dataset with two variables, <span class="math inline">\(C_1\)</span> and <span class="math inline">\(C_2\)</span>.
Here is one way to implement the model:</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb125-1"><a href="data-generating-processes.html#cb125-1" tabindex="-1"></a>r_bivariate_Poisson <span class="ot">&lt;-</span> <span class="cf">function</span>(N, mu1, mu2, <span class="at">rho =</span> <span class="dv">0</span>) {</span>
<span id="cb125-2"><a href="data-generating-processes.html#cb125-2" tabindex="-1"></a>  </span>
<span id="cb125-3"><a href="data-generating-processes.html#cb125-3" tabindex="-1"></a>  <span class="co"># covariance term, equal to E(Z_3)</span></span>
<span id="cb125-4"><a href="data-generating-processes.html#cb125-4" tabindex="-1"></a>  EZ3 <span class="ot">&lt;-</span> rho <span class="sc">*</span> <span class="fu">sqrt</span>(mu1 <span class="sc">*</span> mu2) </span>
<span id="cb125-5"><a href="data-generating-processes.html#cb125-5" tabindex="-1"></a>  </span>
<span id="cb125-6"><a href="data-generating-processes.html#cb125-6" tabindex="-1"></a>  <span class="co"># Generate independent components</span></span>
<span id="cb125-7"><a href="data-generating-processes.html#cb125-7" tabindex="-1"></a>  Z1 <span class="ot">&lt;-</span> <span class="fu">rpois</span>(N, <span class="at">lambda =</span> mu1 <span class="sc">-</span> EZ3)</span>
<span id="cb125-8"><a href="data-generating-processes.html#cb125-8" tabindex="-1"></a>  Z2 <span class="ot">&lt;-</span> <span class="fu">rpois</span>(N, <span class="at">lambda =</span> mu2 <span class="sc">-</span> EZ3)</span>
<span id="cb125-9"><a href="data-generating-processes.html#cb125-9" tabindex="-1"></a>  Z3 <span class="ot">&lt;-</span> <span class="fu">rpois</span>(N, <span class="at">lambda =</span> EZ3)</span>
<span id="cb125-10"><a href="data-generating-processes.html#cb125-10" tabindex="-1"></a>  </span>
<span id="cb125-11"><a href="data-generating-processes.html#cb125-11" tabindex="-1"></a>  <span class="co"># Assemble components</span></span>
<span id="cb125-12"><a href="data-generating-processes.html#cb125-12" tabindex="-1"></a>  dat <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb125-13"><a href="data-generating-processes.html#cb125-13" tabindex="-1"></a>    <span class="at">C1 =</span> Z1 <span class="sc">+</span> Z3,</span>
<span id="cb125-14"><a href="data-generating-processes.html#cb125-14" tabindex="-1"></a>    <span class="at">C2 =</span> Z2 <span class="sc">+</span> Z3</span>
<span id="cb125-15"><a href="data-generating-processes.html#cb125-15" tabindex="-1"></a>  )</span>
<span id="cb125-16"><a href="data-generating-processes.html#cb125-16" tabindex="-1"></a>  </span>
<span id="cb125-17"><a href="data-generating-processes.html#cb125-17" tabindex="-1"></a>  <span class="fu">return</span>(dat)</span>
<span id="cb125-18"><a href="data-generating-processes.html#cb125-18" tabindex="-1"></a>}</span></code></pre></div>
<p>Here we generate 5 observations from the bivariate Poisson with <span class="math inline">\(\rho = 0.5\)</span> and <span class="math inline">\(\mu_1 = \mu_2 = 4\)</span>:</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb126-1"><a href="data-generating-processes.html#cb126-1" tabindex="-1"></a><span class="fu">r_bivariate_Poisson</span>(<span class="dv">5</span>, <span class="at">rho =</span> <span class="fl">0.5</span>, <span class="at">mu1 =</span> <span class="dv">4</span>, <span class="at">mu2 =</span> <span class="dv">4</span>)</span></code></pre></div>
<pre><code>##   C1 C2
## 1  4  4
## 2  2  2
## 3  2  1
## 4  5  6
## 5  2  3</code></pre>
</div>
<div id="DGP-plotting" class="section level2 hasAnchor" number="6.4">
<h2><span class="header-section-number">6.4</span> Plot the artificial data<a href="data-generating-processes.html#DGP-plotting" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The whole purpose of writing a DGP is to produce something that can be treated just as if it were real data.
Considering that is our goal, we should act like it and engage in data analysis processes that we would apply whenever we analyze real data.
In particular, it is worthwhile to create one or more plots of the data generated by a DGP, just as we would if we were exploring a new real dataset for the first time.
This exercise can be very helpful for catching problems in the DGP function (about which more below).
Beyond just debugging, constructing graphic visualizations can be a very effective way to <em>study</em> a model and strengthen your understanding of how to interpret its parameters.</p>
In the one-way ANOVA example, it would be conventional to visualize the data with box plots or some other summary statistics for the data from each group.
For exploratory graphics, we prefer plots that include representations of the raw data points, not just summary statistics.
The figure below uses a density ridge-plot, filled in with points for each observation in each group.
The plot is based on a simulated dataset with 50 observations in each of five groups.
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ANOVA-bee-swarm"></span>
<img src="Designing-Simulations-in-R_files/figure-html/ANOVA-bee-swarm-1.png" alt="Densities of five heteroskedastic groups for the one-way ANOVA example." width="75%" />
<p class="caption">
Figure 6.1: Densities of five heteroskedastic groups for the one-way ANOVA example.
</p>
</div>
<p>Here is a plot of 30 observations from the bivariate Poisson distribution with means <span class="math inline">\(\mu_1 = 10, \mu_2 = 7\)</span> and correlation <span class="math inline">\(\rho = .65\)</span> (points are jittered slightly to avoid over-plotting):</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:bivariate-Poisson-scatter"></span>
<img src="Designing-Simulations-in-R_files/figure-html/bivariate-Poisson-scatter-1.png" alt="$N = 30$ observations from the bivariate Poisson distribution with $\mu_1 = 10, \mu_2 = 7, ho = .65$." width="75%" />
<p class="caption">
Figure 6.2: <span class="math inline">\(N = 30\)</span> observations from the bivariate Poisson distribution with <span class="math inline">\(\mu_1 = 10, \mu_2 = 7, ho = .65\)</span>.
</p>
</div>
<p>Plots like these are useful for building intuitions about a model. For instance, we can inspect <a href="data-generating-processes.html#fig:bivariate-Poisson-scatter">6.2</a> to get a sense of the order of magnitude and range of the observations, as well as the likelihood of obtaining multiple observations with identical counts.
Depending on the analysis procedures we will apply to the dataset, we might even create plots of transformations of the dataset, such as a histogram of the differences <span class="math inline">\(C_2 - C_1\)</span> or a scatterplot of the rank transformations of <span class="math inline">\(C_1\)</span> and <span class="math inline">\(C_2\)</span>.</p>
</div>
<div id="check-the-data-generating-function" class="section level2 hasAnchor" number="6.5">
<h2><span class="header-section-number">6.5</span> Check the data-generating function<a href="data-generating-processes.html#check-the-data-generating-function" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>An important part of programming in R—especially when writing custom functions—is finding ways to test and check the correctness of your code. Just writing a data-generating function is not enough. It is also <em>critical</em> to test whether the output it produces is correct. How best to do this will depend on the particulars of the DGP being implemented.</p>
<p>For many DGPs, a broadly useful strategy is to generate a very large sample of data—one so large that the sample distribution should very closely resemble the population distribution.
One can then test whether features of the sample distribution closely align with corresponding parameters of the population model.</p>
<p>For the heteroskedastic ANOVA problem, one basic thing we can do is check that the simulated data from each group follows a normal distribution.
In the following code, we simulate very large samples from each of the four groups, and check that the means and variances agree with the input parameters:</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb128-1"><a href="data-generating-processes.html#cb128-1" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">6</span>)</span>
<span id="cb128-2"><a href="data-generating-processes.html#cb128-2" tabindex="-1"></a>sigma_sq <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">1</span>)</span>
<span id="cb128-3"><a href="data-generating-processes.html#cb128-3" tabindex="-1"></a></span>
<span id="cb128-4"><a href="data-generating-processes.html#cb128-4" tabindex="-1"></a>check_data <span class="ot">&lt;-</span> <span class="fu">generate_ANOVA_data</span>( </span>
<span id="cb128-5"><a href="data-generating-processes.html#cb128-5" tabindex="-1"></a>  <span class="at">mu =</span> mu, </span>
<span id="cb128-6"><a href="data-generating-processes.html#cb128-6" tabindex="-1"></a>  <span class="at">sigma_sq =</span> sigma_sq,</span>
<span id="cb128-7"><a href="data-generating-processes.html#cb128-7" tabindex="-1"></a>  <span class="at">sample_size =</span> <span class="fu">rep</span>(<span class="dv">10000</span>, <span class="dv">4</span>) </span>
<span id="cb128-8"><a href="data-generating-processes.html#cb128-8" tabindex="-1"></a>)</span>
<span id="cb128-9"><a href="data-generating-processes.html#cb128-9" tabindex="-1"></a></span>
<span id="cb128-10"><a href="data-generating-processes.html#cb128-10" tabindex="-1"></a>chk <span class="ot">&lt;-</span> </span>
<span id="cb128-11"><a href="data-generating-processes.html#cb128-11" tabindex="-1"></a>  check_data <span class="sc">%&gt;%</span> </span>
<span id="cb128-12"><a href="data-generating-processes.html#cb128-12" tabindex="-1"></a>  <span class="fu">group_by</span>( group ) <span class="sc">%&gt;%</span></span>
<span id="cb128-13"><a href="data-generating-processes.html#cb128-13" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb128-14"><a href="data-generating-processes.html#cb128-14" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb128-15"><a href="data-generating-processes.html#cb128-15" tabindex="-1"></a>    <span class="at">mean =</span> <span class="fu">mean</span>(x),</span>
<span id="cb128-16"><a href="data-generating-processes.html#cb128-16" tabindex="-1"></a>    <span class="at">var =</span> <span class="fu">var</span>(x)</span>
<span id="cb128-17"><a href="data-generating-processes.html#cb128-17" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb128-18"><a href="data-generating-processes.html#cb128-18" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mu =</span> mu, <span class="at">sigma2 =</span> sigma_sq) <span class="sc">%&gt;%</span> </span>
<span id="cb128-19"><a href="data-generating-processes.html#cb128-19" tabindex="-1"></a>  <span class="fu">relocate</span>( group, n, mean, mu, var, sigma2 )</span>
<span id="cb128-20"><a href="data-generating-processes.html#cb128-20" tabindex="-1"></a>chk</span></code></pre></div>
<pre><code>## # A tibble: 4 × 6
##   group     n  mean    mu   var sigma2
##   &lt;fct&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
## 1 1     10000 0.988     1 2.97       3
## 2 2     10000 1.99      2 1.99       2
## 3 3     10000 5.02      5 5.00       5
## 4 4     10000 5.98      6 0.993      1</code></pre>
<p>It seems we are recovering our parameters.</p>
<p>We can also make some diagnostic plots to assess whether we have normal data (using QQ plots, where we expect a straight line if the data are normal):</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb130-1"><a href="data-generating-processes.html#cb130-1" tabindex="-1"></a><span class="fu">ggplot</span>( check_data ) <span class="sc">+</span></span>
<span id="cb130-2"><a href="data-generating-processes.html#cb130-2" tabindex="-1"></a>  <span class="fu">aes</span>( <span class="at">sample =</span> x, <span class="at">color =</span> group ) <span class="sc">+</span> </span>
<span id="cb130-3"><a href="data-generating-processes.html#cb130-3" tabindex="-1"></a>  <span class="fu">facet_wrap</span>( <span class="sc">~</span> group ) <span class="sc">+</span></span>
<span id="cb130-4"><a href="data-generating-processes.html#cb130-4" tabindex="-1"></a>  <span class="fu">stat_qq</span>() <span class="sc">+</span> <span class="fu">stat_qq_line</span>()</span></code></pre></div>
<p><img src="Designing-Simulations-in-R_files/figure-html/unnamed-chunk-77-1.png" width="75%" style="display: block; margin: auto;" />
This diagnostic looks good too.
Here, these checks may seem a bit silly, but most bugs are silly—at least once you find them!
In models that are even a little bit more complex, it is quite easy for small things such as a sign error to slip into your code.
Even simple checks such as these can be quite helpful in catching such bugs.</p>
</div>
<div id="case-cluster" class="section level2 hasAnchor" number="6.6">
<h2><span class="header-section-number">6.6</span> Example: Simulating clustered data<a href="data-generating-processes.html#case-cluster" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Writing code for a complicated DGP can feel like a daunting task, but if you first focus on a recipe for how the data is generated, it is often not too bad to then convert that recipe into code.
We now illustrate this process with a detailed case study involving a more complex data-generating process
Recent literature on multisite trials (where, for example, students are randomized to treatment or control within each of a series of sites) has explored how variation in the strength of effects across sites can affect how different data-analysis procedures behave <span class="citation">(e.g., <a href="#ref-miratrix2021applied">Miratrix, Weiss, and Henderson 2021</a>; <a href="#ref-Bloom:2016um">Bloom et al. 2016</a>)</span>.
In this example, we are going to extend this work to explore best practices for estimating treatment effects in cluster randomized trials.
In particular, we will investigate what happens when the treatment impact for each school is related to the size of the school.</p>
<div id="a-design-decision-what-do-we-want-to-manipulate" class="section level3 hasAnchor" number="6.6.1">
<h3><span class="header-section-number">6.6.1</span> A design decision: What do we want to manipulate?<a href="data-generating-processes.html#a-design-decision-what-do-we-want-to-manipulate" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In designing a simulation study, we need to find a DGP that will allow us to address the specific questions we are interested in investigating.
For instance, in the one-way ANOVA example, we wanted to see how different degrees of within-group variation impacted the performance of several hypothesis-testing procedures.
We therefore needed a data generation process that allowed us to control the extent of within-group variation.</p>
<p>To figure out what DGP to use for simulating data from a cluster-randomized trial, we need to consider how we are going to use those data in our simulation study.
Because we are interested in understanding what happens when school-specific effects are related to school size, we will need data with the following features:</p>
<ol style="list-style-type: lower-alpha">
<li>observations for students in each of several schools;</li>
<li>schools are different sizes and have different mean outcomes;</li>
<li>school-specific treatment effects correlate with school size; and</li>
<li>schools are assigned to different treatment conditions.</li>
</ol>
<p>A given dataset will consist of observations for individual students in schools, with each student having a school id, a treatment assignment (shared for all in the school), and an outcome.
A good starting point for building a DGP is to first sketch out what a simulated dataset should look like.
For this example, we need data like the following:</p>
<table>
<thead>
<tr class="header">
<th align="right">schoolID</th>
<th align="right">Z</th>
<th align="right">size</th>
<th align="right">studentID</th>
<th align="right">Y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">24</td>
<td align="right">1</td>
<td align="right">3.6</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">24</td>
<td align="right">3</td>
<td align="right">1.0</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">etc</td>
<td align="right">etc</td>
<td align="right">etc</td>
<td align="right">etc</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">24</td>
<td align="right">24</td>
<td align="right">2.0</td>
</tr>
<tr class="odd">
<td align="right">2</td>
<td align="right">0</td>
<td align="right">32</td>
<td align="right">1</td>
<td align="right">0.5</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">0</td>
<td align="right">32</td>
<td align="right">2</td>
<td align="right">1.5</td>
</tr>
<tr class="odd">
<td align="right">2</td>
<td align="right">0</td>
<td align="right">32</td>
<td align="right">3</td>
<td align="right">1.2</td>
</tr>
<tr class="even">
<td align="right">etc</td>
<td align="right">etc</td>
<td align="right">etc</td>
<td align="right">etc</td>
<td align="right">etc</td>
</tr>
</tbody>
</table>
<p>When running simulations, it is good practice to look at simple scenarios along with complex ones.
This lets us not only identify conditions where some aspect of the DGP is important, but also verify that the feature does <em>not</em> matter under scenarios where we know it should not.
Given this principle, we land on the following points:</p>
<ul>
<li>We need a DGP that lets us generate schools that are all the same size or that are all different sizes.</li>
<li>Our DGP should allow for variation in the school-specific treatment effects.</li>
<li>We should have the option to generate school-specific effects that are related or unrelated to school size.</li>
</ul>
</div>
<div id="a-model-for-a-cluster-rct" class="section level3 hasAnchor" number="6.6.2">
<h3><span class="header-section-number">6.6.2</span> A model for a cluster RCT<a href="data-generating-processes.html#a-model-for-a-cluster-rct" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>DGPs are expressed and communicated using mathematical models.
In developing a DGP, we often start by considering the model for the outcomes (along with its focal parameters), which covers some but not all of the steps in the full recipe for generating data.
It is helpful to write down the equations for the outcome model and then note what further quantities need to be generated (such as structural features and covariates).
Then we can consider how to generate these quantities with auxiliary models.</p>
<p>Section <a href="data-generating-processes.html#CRT-example">6.1.3</a> introduced a basic HLM for a cluster-randomized trial.
This model had two parts, starting with a model for our student outcome:
<span class="math display">\[ Y_{ij} = \beta_{0j} + \epsilon_{ij} \mbox{ with } \epsilon_{ij} \sim N( 0, \sigma^2_\epsilon ) \]</span>
where <span class="math inline">\(Y_{ij}\)</span> is the outcome for student <span class="math inline">\(i\)</span> in site <span class="math inline">\(j\)</span>, <span class="math inline">\(\beta_{0j}\)</span> is the average outcome in site <span class="math inline">\(j\)</span>, and <span class="math inline">\(\epsilon_{ij}\)</span> is the residual error for student <span class="math inline">\(i\)</span> in site <span class="math inline">\(j\)</span>.
The model was completed by specifying how the site-specific outcomes vary as a function of treatment assignment:
<span class="math display">\[ \beta_{0j} = \gamma_{0} + \gamma_{1} Z_j + u_j, \quad u_j \sim N( 0, \sigma^2_u ).\]</span>
This model has a constant treatment effect: if a school is assigned to treatment, then all outcomes in the cluster are raised by the amount <span class="math inline">\(\gamma_{1}\)</span>.
But we also want to allow the size of impact to vary by school size.
This suggests we will need to elaborate the model to include a treatment-by-size interaction term.</p>
<p>One approach for allowing the school-specific impacts to depend on school size is to introduce school size as a predictor, as in
<span class="math display">\[
\beta_{0j} = \gamma_{0} + \gamma_{1} Z_j + \gamma_{2} \left(Z_j \times n_j\right) + u_j.
\]</span>
A drawback of this approach is that changing the average size of the schools will change the average treatment impact.
A more interpretable approach is to allow treatment effects to depend on the <em>relative</em> school sizes.
To do this, we can define a covariate that describes the deviation in the school size relative to the average size.
Thus, let
<span class="math display">\[ S_j = \frac{n_j - \bar{n}}{ \bar{n} }, \]</span>
where <span class="math inline">\(\bar{n}\)</span> is the overall average school size.
Using this covariate, we then revise our equation for our site <span class="math inline">\(j\)</span> to:
<span class="math display">\[ \beta_{0j} = \gamma_{0} + \gamma_{1} Z_j + \gamma_{2} \left( Z_j \times S_j\right) + u_j. \]</span>
If <span class="math inline">\(\gamma_{2}\)</span> is positive, then bigger schools will have larger treatment impacts.
Because <span class="math inline">\(S_j\)</span> is centered at 0, the overall average impact across schools will be simply <span class="math inline">\(\gamma_{1}\)</span>.
(If <span class="math inline">\(S_j\)</span> was not centered at zero, then the overall average impact would be some function of <span class="math inline">\(\gamma_{1}\)</span> and <span class="math inline">\(\gamma_{2}\)</span>.)</p>
<p>Putting all of the above together, we now have an HLM to describe the distribution of outcomes conditional on the covariates and structural features:
<span class="math display">\[
\begin{aligned}
Y_{ij} &amp;= \beta_{0j} + \epsilon_{ij} \quad &amp;\epsilon_{ij} &amp;\sim N( 0, \sigma^2_\epsilon ) \\
\beta_{0j} &amp;= \gamma_{0} + \gamma_{1} Z_j + \gamma_{2} Z_j S_j + u_j \quad &amp; u_j &amp;\sim N( 0, \sigma^2_u )
\end{aligned}
\]</span>
Substituting the second equation into the first leads to a single equation for generating the student-level outcomes (or what is called the reduced form of the HLM):
<span class="math display">\[ Y_{ij} = \gamma_{0} + \gamma_{1} Z_j + \gamma_{2} Z_j S_j  + u_j + \epsilon_{ij}\]</span>
The parameters of this focal model are the mean outcome among control schools (<span class="math inline">\(\gamma_{0}\)</span>), the average treatment impact (<span class="math inline">\(\gamma_{1}\)</span>), the site-size by treatment interaction term (<span class="math inline">\(\gamma_{2}\)</span>), the amount of school-level variation (<span class="math inline">\(\sigma^2_u\)</span>), and the amount of within-school variation (<span class="math inline">\(\sigma^2_\epsilon\)</span>).</p>
<p>There are several ways that we could elaborate this model further.
For one, we might want to include a main effect for <span class="math inline">\(S_j\)</span>, so that average outcomes in the absence of treatment are also dependent on school size.
For another, we might revise the model to allow for school-to-school variation in treatment impacts that is not explained by school size.
For simplicity, we do not build in these further features, but see the exercises at the end of the chapter.</p>
<p>So far we have a mathematical model analogous to what we would write if we were <em>analyzing</em> the data.
To <em>generate</em> data, we also need a way to generate the structural features and covariates involved in the model.
First, we need to know the number of clusters (<span class="math inline">\(J\)</span>) and the sizes of the clusters (<span class="math inline">\(n_j\)</span>, for <span class="math inline">\(j = 1, ..., J\)</span>).
For illustrative purposes, we will generate size sizes from a uniform distribution with average school size <span class="math inline">\(\bar{n}\)</span> and a fixed parameter <span class="math inline">\(\alpha\)</span> that controls the degree of variation in school size. Mathematically,
<span class="math display">\[ n_j \sim \text{Unif}\left[ (1-\alpha)\bar{n}, (1+\alpha)\bar{n} \right].\]</span>
Equivalently, we could generate site sizes by taking
<span class="math display">\[n_j = \bar{n}(1 + \alpha U_j), \quad U_j \sim unif(-1, 1).\]</span>
For instance, if <span class="math inline">\(\bar{n} = 100\)</span> and <span class="math inline">\(\alpha = 0.25\)</span> then schools would range in size from 75 to 125.
This specification is nice because it is simple, with just two parameters, both of which are easy to interpret: <span class="math inline">\(\bar{n}\)</span> is the average school size and <span class="math inline">\(\alpha\)</span> is the degree of variation in school size.</p>
<p>To round out the model, we also need to define how to generate the treatment indicator, <span class="math inline">\(Z_j\)</span>.
To allow for different treatment allocations, we will specify a proportion <span class="math inline">\(p\)</span> of clusters assigned to treatment.
Because we are simulating a cluster-randomized trial, we do this by drawing a simple random sample (without replacement) of <span class="math inline">\(p \times J\)</span> schools out of the total sample of <span class="math inline">\(J\)</span> schools, then setting <span class="math inline">\(Z_j = 1\)</span> for these schools and <span class="math inline">\(Z_j = 0\)</span> for the remaining schools.
We will denote this process as <span class="math inline">\(Z_1,...,Z_J \sim SRS(p, J)\)</span>, where SRS stands for simple random sample.</p>
<p>Now that we have an auxiliary model for school sizes, let us look again at our treatment impact heterogeneity term:
<span class="math display">\[ \gamma_{2} Z_j S_j = \gamma_{2} Z_j \left(\frac{n_j - \bar{n}}{\bar{n}}\right) = \gamma_{2}  \alpha Z_j U_j, \]</span>
where <span class="math inline">\(U_j \sim \text{Unif}(-1,1)\)</span> is the uniform variable used to generate <span class="math inline">\(n_j\)</span>.
Because we have standardized by average school size, the importance of the covariate does not change as a function of average school size, but rather as a function of the relative variation parameter <span class="math inline">\(\alpha\)</span>.
Setting up a DGP with standardized quantities will make it easier to interpret simulation results, especially if we are looking at results from multiple scenarios with different parameter values.
To the extent feasible, we want the parameters of the DGP to change only one feature of the data, so that it is easier to isolate the influence of each parameter.</p>
</div>
<div id="from-equations-to-code" class="section level3 hasAnchor" number="6.6.3">
<h3><span class="header-section-number">6.6.3</span> From equations to code<a href="data-generating-processes.html#from-equations-to-code" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>When sketching out the equations for the DGP, we worked from the lowest level of the model (the students) to the higher level (schools) and then to the auxiliary models for covariates and structural features.
For writing code to based on the DGP, we will proceed in the opposite direction, from auxiliary to focal and from the highest level to the lowest.
First, we will generate the sites and their features:</p>
<ul>
<li>Generate school sizes</li>
<li>Generate school-level covariates</li>
<li>Generate school-level random effects</li>
</ul>
<p>Then we will generate the students inside the sites:</p>
<ul>
<li>Generate student residuals</li>
<li>Add everything up to generate student outcomes</li>
</ul>
<p>The mathematical model gives us the details we need to execute with each of these steps.</p>
<p>Here is the skeleton of a DGP function with arguments for each of the parameters we might want to control, including defaults for each (see <a href="coding-tidbits.html#default-arguments">A.2</a> for more on function defaults):</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb131-1"><a href="data-generating-processes.html#cb131-1" tabindex="-1"></a>gen_cluster_RCT <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb131-2"><a href="data-generating-processes.html#cb131-2" tabindex="-1"></a>    <span class="at">J =</span> <span class="dv">30</span>,</span>
<span id="cb131-3"><a href="data-generating-processes.html#cb131-3" tabindex="-1"></a>    <span class="at">n_bar =</span> <span class="dv">10</span>,</span>
<span id="cb131-4"><a href="data-generating-processes.html#cb131-4" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="dv">0</span>,</span>
<span id="cb131-5"><a href="data-generating-processes.html#cb131-5" tabindex="-1"></a>    <span class="at">p =</span> <span class="fl">0.5</span>,</span>
<span id="cb131-6"><a href="data-generating-processes.html#cb131-6" tabindex="-1"></a>    <span class="at">gamma_0 =</span> <span class="dv">0</span>, <span class="at">gamma_1 =</span> <span class="dv">0</span>, <span class="at">gamma_2 =</span> <span class="dv">0</span>,</span>
<span id="cb131-7"><a href="data-generating-processes.html#cb131-7" tabindex="-1"></a>    <span class="at">sigma2_u =</span> <span class="dv">0</span>, <span class="at">sigma2_e =</span> <span class="dv">1</span></span>
<span id="cb131-8"><a href="data-generating-processes.html#cb131-8" tabindex="-1"></a>) {</span>
<span id="cb131-9"><a href="data-generating-processes.html#cb131-9" tabindex="-1"></a>  </span>
<span id="cb131-10"><a href="data-generating-processes.html#cb131-10" tabindex="-1"></a>  <span class="co"># generate schools sizes </span></span>
<span id="cb131-11"><a href="data-generating-processes.html#cb131-11" tabindex="-1"></a>  <span class="co"># Code (see below) goes here</span></span>
<span id="cb131-12"><a href="data-generating-processes.html#cb131-12" tabindex="-1"></a>}</span></code></pre></div>
<p>Note that the inputs to this function are a mix of <em>model parameters</em> (<code>gamma_0</code>, <code>gamma_1</code>, <code>gamma_2</code>, representing coefficients in regressions), <em>auxilary parameters</em> (<code>sigma2_u</code>, <code>sigma2_e</code>, <code>alpha</code>, <code>n_bar</code>), and <em>design parameters</em> (<code>J</code>, <code>p</code>) that directly inform data generation.
We set default arguments (e.g., <code>gamma_0=0</code>) so that we can ignore aspects of the DGP that we do not care about for the moment.</p>
<p>Inside the model, we will have a block of code to generate the variables pertaining to schools, and then another to generate the variables pertaining to students.</p>
<p>We first make the schools:</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb132-1"><a href="data-generating-processes.html#cb132-1" tabindex="-1"></a>  n_min <span class="ot">&lt;-</span> <span class="fu">round</span>( n_bar <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> alpha) )</span>
<span id="cb132-2"><a href="data-generating-processes.html#cb132-2" tabindex="-1"></a>  n_max <span class="ot">&lt;-</span> <span class="fu">round</span>( n_bar <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> alpha) )</span>
<span id="cb132-3"><a href="data-generating-processes.html#cb132-3" tabindex="-1"></a>  nj <span class="ot">&lt;-</span> <span class="fu">sample</span>( n_min<span class="sc">:</span>n_max, J, <span class="at">replace =</span> <span class="cn">TRUE</span> )</span>
<span id="cb132-4"><a href="data-generating-processes.html#cb132-4" tabindex="-1"></a>  </span>
<span id="cb132-5"><a href="data-generating-processes.html#cb132-5" tabindex="-1"></a>  <span class="co"># Generate average control outcome for all schools</span></span>
<span id="cb132-6"><a href="data-generating-processes.html#cb132-6" tabindex="-1"></a>  <span class="co"># (the random effects)</span></span>
<span id="cb132-7"><a href="data-generating-processes.html#cb132-7" tabindex="-1"></a>  u0j <span class="ot">&lt;-</span> <span class="fu">rnorm</span>( J, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="fu">sqrt</span>(sigma2_u) )</span>
<span id="cb132-8"><a href="data-generating-processes.html#cb132-8" tabindex="-1"></a>  </span>
<span id="cb132-9"><a href="data-generating-processes.html#cb132-9" tabindex="-1"></a>  <span class="co"># randomize schools (proportion p to treatment)</span></span>
<span id="cb132-10"><a href="data-generating-processes.html#cb132-10" tabindex="-1"></a>  Zj <span class="ot">&lt;-</span> <span class="fu">ifelse</span>( <span class="fu">sample</span>( <span class="dv">1</span><span class="sc">:</span>J ) <span class="sc">&lt;=</span> J <span class="sc">*</span> p, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb132-11"><a href="data-generating-processes.html#cb132-11" tabindex="-1"></a>  </span>
<span id="cb132-12"><a href="data-generating-processes.html#cb132-12" tabindex="-1"></a>  <span class="co"># Calculate schools intercepts</span></span>
<span id="cb132-13"><a href="data-generating-processes.html#cb132-13" tabindex="-1"></a>  S_j <span class="ot">&lt;-</span> (nj <span class="sc">-</span> n_bar) <span class="sc">/</span> n_bar</span>
<span id="cb132-14"><a href="data-generating-processes.html#cb132-14" tabindex="-1"></a>  beta_0j <span class="ot">&lt;-</span> gamma_0 <span class="sc">+</span> gamma_1 <span class="sc">*</span> Zj <span class="sc">+</span> gamma_2 <span class="sc">*</span> Zj <span class="sc">*</span> S_j <span class="sc">+</span> u0j</span></code></pre></div>
<p>The code is a literal translation of the math we did before.
Note the line with <code>sample(1:J) &lt;= J*p</code>; this is a simple trick to generate a 0/1 indicator for control and treatment conditions.</p>
<p>There is also a serious error in the above code (serious in that the code will run and look fine in many cases, but not always do what we want); we leave it as an exercise (see below) to find and fix it.
<!-- JEP: Does this exercise support our pedagogical goals? If this is supposed to be intro chapter, then debugging a subtle problem seems like it could be counterproductive. -->
<!-- LWM: I think we hand-hold the debugging clearly in the exercises, so I am not worried, and the larger point is important? --></p>
<p>Next, we use the site characteristics to generate the individual-level variables:</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb133-1"><a href="data-generating-processes.html#cb133-1" tabindex="-1"></a>  <span class="co"># Make individual site membership</span></span>
<span id="cb133-2"><a href="data-generating-processes.html#cb133-2" tabindex="-1"></a>  sid <span class="ot">&lt;-</span> <span class="fu">as.factor</span>( <span class="fu">rep</span>( <span class="dv">1</span><span class="sc">:</span>J, nj ) )</span>
<span id="cb133-3"><a href="data-generating-processes.html#cb133-3" tabindex="-1"></a>  </span>
<span id="cb133-4"><a href="data-generating-processes.html#cb133-4" tabindex="-1"></a>  <span class="co"># Generate the individual-level errors and outcome</span></span>
<span id="cb133-5"><a href="data-generating-processes.html#cb133-5" tabindex="-1"></a>  N <span class="ot">&lt;-</span> <span class="fu">sum</span>( nj )</span>
<span id="cb133-6"><a href="data-generating-processes.html#cb133-6" tabindex="-1"></a>  e <span class="ot">&lt;-</span> <span class="fu">rnorm</span>( N, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="fu">sqrt</span>(sigma2_e) )</span>
<span id="cb133-7"><a href="data-generating-processes.html#cb133-7" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> beta_0j[sid] <span class="sc">+</span> e</span>
<span id="cb133-8"><a href="data-generating-processes.html#cb133-8" tabindex="-1"></a>  </span>
<span id="cb133-9"><a href="data-generating-processes.html#cb133-9" tabindex="-1"></a>  <span class="co"># Bundle into a dataset</span></span>
<span id="cb133-10"><a href="data-generating-processes.html#cb133-10" tabindex="-1"></a>  dd <span class="ot">&lt;-</span> <span class="fu">data.frame</span>( </span>
<span id="cb133-11"><a href="data-generating-processes.html#cb133-11" tabindex="-1"></a>    <span class="at">sid =</span> sid,</span>
<span id="cb133-12"><a href="data-generating-processes.html#cb133-12" tabindex="-1"></a>    <span class="at">Z =</span> Zj[ sid ],</span>
<span id="cb133-13"><a href="data-generating-processes.html#cb133-13" tabindex="-1"></a>    <span class="at">Yobs =</span> Y</span>
<span id="cb133-14"><a href="data-generating-processes.html#cb133-14" tabindex="-1"></a>  )</span></code></pre></div>
<p>A key piece here is the <code>rep()</code> function that takes a list and repeats each element of the list a specified number of times.
In particular, <code>rep()</code> repeats each number (<span class="math inline">\(1, 2, \ldots, J\)</span>), the corresponding number of times as listed in <code>nj</code>.
Putting the code above into the function skeleton will produce a complete DGP function (view the <a href="/case_study_code/gen_cluster_RCT.R">complete function here</a>).
We can then call the function as so:</p>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb134-1"><a href="data-generating-processes.html#cb134-1" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">gen_cluster_RCT</span>( </span>
<span id="cb134-2"><a href="data-generating-processes.html#cb134-2" tabindex="-1"></a>  <span class="at">J=</span><span class="dv">3</span>, <span class="at">n_bar =</span> <span class="dv">5</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">p =</span> <span class="fl">0.5</span>, </span>
<span id="cb134-3"><a href="data-generating-processes.html#cb134-3" tabindex="-1"></a>  <span class="at">gamma_0 =</span> <span class="dv">0</span>, <span class="at">gamma_1 =</span> <span class="fl">0.2</span>, <span class="at">gamma_2 =</span> <span class="fl">0.2</span>,</span>
<span id="cb134-4"><a href="data-generating-processes.html#cb134-4" tabindex="-1"></a>  <span class="at">sigma2_u =</span> <span class="fl">0.4</span>, <span class="at">sigma2_e =</span> <span class="dv">1</span></span>
<span id="cb134-5"><a href="data-generating-processes.html#cb134-5" tabindex="-1"></a>)</span>
<span id="cb134-6"><a href="data-generating-processes.html#cb134-6" tabindex="-1"></a></span>
<span id="cb134-7"><a href="data-generating-processes.html#cb134-7" tabindex="-1"></a>dat</span></code></pre></div>
<pre><code>##    sid Z       Yobs
## 1    1 1  2.3263686
## 2    1 1  2.0202277
## 3    1 1  3.5850632
## 4    1 1  0.9581332
## 5    1 1  2.6183761
## 6    1 1  0.3198559
## 7    2 0 -2.2305376
## 8    2 0  1.0479261
## 9    2 0 -0.6256389
## 10   2 0  1.0891353
## 11   2 0 -0.6051252
## 12   2 0 -0.3099363
## 13   2 0 -0.9828624
## 14   2 0 -0.5571326
## 15   3 0  0.1203995
## 16   3 0  1.7086978
## 17   3 0  0.1213685</code></pre>
<p>With this function, we can control the average size of the clusters (<code>n</code>), the number of clusters (<code>J</code>), the proportion treated (<code>p</code>), the average outcome in the control group (<code>gamma_0</code>), the average treatment effect (<code>gamma_1</code>), the site size by treatment interaction (<code>gamma_2</code>), the amount of cross site variation (<code>sigma2_u</code>), the residual variation (<code>sigma2_e</code>), and the amount of site size variation (<code>alpha</code>).
The next step is to test the code, making sure it is doing what we think it is.
In fact, it is not–there is a subtle bug that only appears under some specifications of the parameters; see the exercises for more on diagnosing and repairing this error.</p>
</div>
<div id="DGP-standardization" class="section level3 hasAnchor" number="6.6.4">
<h3><span class="header-section-number">6.6.4</span> Standardization in the DGP<a href="data-generating-processes.html#DGP-standardization" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>One difficulty with the current implementation of the model is that the magnitude of the different parameters are inter-connected.
For instance, raising or lowering the within-school variance (<span class="math inline">\(\sigma^2_u\)</span>) will increase the overall variation in <span class="math inline">\(Y\)</span>, and therefore affect our the interpretation of the treatment effect parameters, because a given value of <span class="math inline">\(\gamma_{1}\)</span> will be less consequential if there is more overall variation.
We can fix this issue by standardizing the model parameters.
Standardization will allow us to reduce the set of parameters we might want to manipulate and will ensure that varying the remaining parameters only affects one aspect of the DGP.</p>
<p>For a continuous, normally distributed outcome variable, a common approach to scaling is to constrain the overall variance of the outcome to a fixed value, such as 1 or 100.
The magnitude of the other parameters of the model can then be interpreted relative to this scale.
Often, we can also constrain the mean of the outcome to a fixed value, such as setting <span class="math inline">\(\gamma_0 = 0\)</span> without affecting the interpretation of the other parameters.</p>
<p>With the current model, the variance of the outcome across students in the control condition is
<span class="math display">\[
\begin{aligned}
\text{Var}( Y_{ij} | Z_j = 0) &amp;= \text{Var}( \beta_{0j} + \epsilon_{ij} | Z_j = 0) \\
&amp;= \text{Var}( \gamma_{0} + \gamma_{1} Z_j + \gamma_{2} Z_j S_j + u_j + \epsilon_{ij} | Z_j = 0) \\
&amp;= \text{Var}( \gamma_{0} + u_j + \epsilon_{ij} ) \\
&amp;= \sigma^2_u + \sigma^2_\epsilon.
\end{aligned}
\]</span>
To ensure that the total variance is held constant, we can redefine the variance parameters in terms of the intra-class correlation (ICC).
The ICC is defined as
<span class="math display">\[ ICC = \frac{ \sigma^2_u }{ \sigma^2_u + \sigma^2_\epsilon }.\]</span>
The ICC measures the degree of between-group variation as a proportion of the total variation of the outcome.
It plays an important role in power calculations for cluster-randomized trials.
If we want the total variance of the outcome to be 1, we need to set <span class="math inline">\(\sigma^2_u + \sigma^2_{\epsilon} = 1\)</span>, which the implies that <span class="math inline">\(ICC = \sigma^2_u\)</span>, and <span class="math inline">\(\sigma^2_\epsilon = 1 - ICC\)</span>.
Thus, we can call our DGP function as follows:</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb136-1"><a href="data-generating-processes.html#cb136-1" tabindex="-1"></a>ICC <span class="ot">&lt;-</span> <span class="fl">0.3</span></span>
<span id="cb136-2"><a href="data-generating-processes.html#cb136-2" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">gen_cluster_RCT</span>( </span>
<span id="cb136-3"><a href="data-generating-processes.html#cb136-3" tabindex="-1"></a>  <span class="at">J =</span> <span class="dv">30</span>, <span class="at">n_bar =</span> <span class="dv">20</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">p =</span> <span class="fl">0.5</span>,</span>
<span id="cb136-4"><a href="data-generating-processes.html#cb136-4" tabindex="-1"></a>  <span class="at">gamma_0 =</span> <span class="dv">0</span>, <span class="at">gamma_1 =</span> <span class="fl">0.3</span>, <span class="at">gamma_2 =</span> <span class="fl">0.2</span>,</span>
<span id="cb136-5"><a href="data-generating-processes.html#cb136-5" tabindex="-1"></a>  <span class="at">sigma2_u =</span> ICC, <span class="at">sigma2_e =</span> <span class="dv">1</span> <span class="sc">-</span> ICC</span>
<span id="cb136-6"><a href="data-generating-processes.html#cb136-6" tabindex="-1"></a>)</span></code></pre></div>
<p>Manipulating the ICC rather than separately manipulating <span class="math inline">\(\sigma^2_u\)</span> and <span class="math inline">\(\sigma^2_\epsilon\)</span> will let us change the degree of between-group variation without affecting the overall scale of the outcome.</p>
<p>A further consequence of setting the overall scale of the outcome to 1 is that the parameters controlling the treatment impact can now be interpreted as standardized mean difference effect sizes.
The standardized mean difference for a treatment impact is defined as the average impact over the standard deviation of the outcome among control observations.<a href="#fn11" class="footnote-ref" id="fnref11"><sup>11</sup></a>
Letting <span class="math inline">\(\delta\)</span> denote the standardized mean difference parameter,
<span class="math display">\[ \delta = \frac{E(Y | Z_j = 1) - E(Y | Z_j = 0)}{SD( Y | Z_j = 0 )} = \frac{\gamma_1}{\sqrt{ \sigma^2_u + \sigma^2_\epsilon } } \]</span>
Because we have constrained the total variance, <span class="math inline">\(\gamma_1\)</span> is equivalent to <span class="math inline">\(\delta\)</span>. This equivalence holds for any value of <span class="math inline">\(\gamma_0\)</span>, so we do not have to worry about manipulating <span class="math inline">\(\gamma_0\)</span> in the simulations—we can simply leave it at its default value.</p>
<!-- JEP: Do we want to discuss anything about interpretation of gamma_2? Or add an exercise about it? -->
<!-- LWM: I don't think there is a need -->
</div>
</div>
<div id="three-parameter-IRT" class="section level2 hasAnchor" number="6.7">
<h2><span class="header-section-number">6.7</span> Sometimes a DGP is all you need<a href="data-generating-processes.html#three-parameter-IRT" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We have introduced the data-generating process as only the first step in developing a simulation study. Indeed, there are many more considerations to come, which we will describe in subsequent chapters.
However, this first step is still very useful in its own right, even apart from the other components of a simulation.
Sometimes, a data-generating function is all you need to learn about a statistical model.</p>
<p>Writing data-generating functions is a very effective way to <em>study</em> a statistical model, such as a model that you might be learning about in a course or through self-study.
Writing code based on a model is a much more <em>active</em> process than listening to a lecture or reading a book or paper.
Coding requires you to make the mathematical notation tangible and can help you to notice details of the model that might be easily missed through listening or reading alone.</p>
<p>Suppose we are taking a first course psychometrics and have just been introduced to item response theory (IRT) models for binary response items.
Our instructor has just laid out a bunch of notation:</p>
<ul>
<li>We have data from a sample of <span class="math inline">\(N\)</span> individuals, each of whom responds to a set of <span class="math inline">\(M\)</span> test items.</li>
<li>We let <span class="math inline">\(X_{im} = 1\)</span> if respondent <span class="math inline">\(i\)</span> answers item <span class="math inline">\(m\)</span> correctly, with <span class="math inline">\(X_{im} = 0\)</span> otherwise, for <span class="math inline">\(i = 1,...,N\)</span> and <span class="math inline">\(m = 1,...,M\)</span>.</li>
<li>We imagine that each respondent has a latent ability <span class="math inline">\(\theta_i\)</span> on whatever domain the test measures.</li>
</ul>
<p>Now our instructor starts dropping models on us, and puts up a slide showing the equation for a three-parameter IRT model:
<span class="math display">\[
Pr(X_{im} = 1) = \gamma_m + (1 - \gamma_m) g\left( \alpha_m [\theta_i - \beta_m]\right),
\]</span>
where <span class="math inline">\(g(x)\)</span> is the cumulative logistic curve: <span class="math inline">\(g(x) = e^x / (1 + e^x)\)</span>.
The instructor explains that <span class="math inline">\(\alpha_m\)</span> is discrimination parameter that can take any real value, <span class="math inline">\(\beta_m\)</span> is a difficulty parameter that has to be greater than zero, and <span class="math inline">\(\gamma_m\)</span> is a guessing parameter between 0 and 1.
They also explain that the guessing parameter is often hard to estimate and so might get treated as fixed and known, based on the number of response options on the item.
For instance, if all the items have four options, then we might take <span class="math inline">\(\gamma_m = \frac{1}{4}\)</span> for <span class="math inline">\(m = 1,...,M\)</span>.
Finally, they explain that the ability parameters are assumed to follow a standard normal distribution, so <span class="math inline">\(\theta_i \sim N(0, 1)\)</span> in the population.</p>
<p>What is this madness? It certainly is a lot of notation to follow.
To make sense of all the moving pieces, let’s try simulating from the model using more-or-less arbitrary parameters.
To begin, we will need to pick a test length <span class="math inline">\(M\)</span> and a sample size <span class="math inline">\(N\)</span>.
Let’s use <span class="math inline">\(N = 7\)</span> participants and <span class="math inline">\(M = 4\)</span> items for starters:</p>
<div class="sourceCode" id="cb137"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb137-1"><a href="data-generating-processes.html#cb137-1" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb137-2"><a href="data-generating-processes.html#cb137-2" tabindex="-1"></a>M <span class="ot">&lt;-</span> <span class="dv">4</span></span></code></pre></div>
<p>The <span class="math inline">\(\theta_i\)</span> distribution seems like the next-simplest part of the model, so let’s generate some ability parameters:</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb138-1"><a href="data-generating-processes.html#cb138-1" tabindex="-1"></a>thetas <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N)</span></code></pre></div>
<p>Now we need sets of parameters <span class="math inline">\(\alpha_m, \beta_m, \gamma_m\)</span> for every item <span class="math inline">\(m = 1,...,M\)</span>.
Where do we get these?</p>
<p>For a particular fixed-length test, the set of item parameters would depend on the features of the actual test questions.
But we are not (yet) dealing with actual testing data, so we will need to make up an auxiliary model for these parameters.
Perhaps we could just simulate some values?
Arbitrarily, let’s draw the difficulty parameters from a normal distribution with mean <span class="math inline">\(\mu_\alpha = 0\)</span> and standard deviation <span class="math inline">\(\tau_\alpha = 1\)</span>.
The discrimination parameters have to be greater than zero, and values near <span class="math inline">\(\beta_m = 1\)</span> make the model simplify (in other words, if <span class="math inline">\(\beta_1 = 1\)</span> then we can drop the parameter from the model), so let’s draw them from a gamma distribution with mean <span class="math inline">\(\mu_\beta = 1\)</span> and standard deviation <span class="math inline">\(\tau_\beta = 0.2\)</span>.
This decision requires a bit of work: gamma distributions are usually parameterized in terms of shape and rate, not mean and standard deviation.
A bit of poking on Wikipedia gives us the answer, however:
shape is equal to <span class="math inline">\(\mu_\beta^2 \tau_\beta^2 = 0.2^2\)</span> and rate is equal to <span class="math inline">\(\mu_\beta \tau_\beta^2 = 0.2^2\)</span>.
Finally, we imagine that all the test questions have four possible responses, and therefore set <span class="math inline">\(\gamma_m = \frac{1}{4}\)</span> for all the items, just like the instructor suggested.
Each item requires three numbers; the easiest way to generate them is to let them all be independent of each other, so we do that.
With that, let’s make up some item parameters:</p>
<div class="sourceCode" id="cb139"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb139-1"><a href="data-generating-processes.html#cb139-1" tabindex="-1"></a>alphas <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(M, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="fl">1.5</span>)           <span class="co"># difficulty parameters</span></span>
<span id="cb139-2"><a href="data-generating-processes.html#cb139-2" tabindex="-1"></a>betas <span class="ot">&lt;-</span> <span class="fu">rgamma</span>(M, <span class="at">shape =</span> <span class="fl">0.2</span><span class="sc">^</span><span class="dv">2</span>, <span class="at">rate =</span> <span class="fl">0.2</span><span class="sc">^</span><span class="dv">2</span>)  <span class="co"># discrimination parameters</span></span>
<span id="cb139-3"><a href="data-generating-processes.html#cb139-3" tabindex="-1"></a>gammas <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span> <span class="sc">/</span> <span class="dv">4</span>, M)                          <span class="co"># guessing parameters</span></span></code></pre></div>
<p>A three-parameter IRT model describes the probability that a given respondent with ability <span class="math inline">\(\theta_i\)</span> answers each of the items on the test correctly.
To generate data based on the model, we need to produce scores on every item for every respondent, leading to a matrix of <span class="math inline">\(N\)</span> respondents by <span class="math inline">\(M\)</span> items.
To simplify this calculation, we write a function to compute the item probabilities for a single respondent:</p>
<div class="sourceCode" id="cb140"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb140-1"><a href="data-generating-processes.html#cb140-1" tabindex="-1"></a>r_scores <span class="ot">&lt;-</span> <span class="cf">function</span>(theta_i, alphas, betas, gammas, M) {</span>
<span id="cb140-2"><a href="data-generating-processes.html#cb140-2" tabindex="-1"></a>  pi_i <span class="ot">&lt;-</span> gammas <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> gammas) <span class="sc">*</span> <span class="fu">plogis</span>(alphas <span class="sc">*</span> (theta_i <span class="sc">-</span> betas))</span>
<span id="cb140-3"><a href="data-generating-processes.html#cb140-3" tabindex="-1"></a>  scores <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(M, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> pi_i)</span>
<span id="cb140-4"><a href="data-generating-processes.html#cb140-4" tabindex="-1"></a>  <span class="fu">names</span>(scores) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;q&quot;</span>,<span class="dv">1</span><span class="sc">:</span>M)</span>
<span id="cb140-5"><a href="data-generating-processes.html#cb140-5" tabindex="-1"></a>  <span class="fu">return</span>(scores)</span>
<span id="cb140-6"><a href="data-generating-processes.html#cb140-6" tabindex="-1"></a>}</span>
<span id="cb140-7"><a href="data-generating-processes.html#cb140-7" tabindex="-1"></a></span>
<span id="cb140-8"><a href="data-generating-processes.html#cb140-8" tabindex="-1"></a><span class="fu">r_scores</span>(thetas[<span class="dv">1</span>], <span class="at">alphas =</span> alphas, <span class="at">betas =</span> betas, </span>
<span id="cb140-9"><a href="data-generating-processes.html#cb140-9" tabindex="-1"></a>         <span class="at">gammas =</span> gammas, <span class="at">M =</span> M)</span></code></pre></div>
<pre><code>## q1 q2 q3 q4 
##  0  1  0  1</code></pre>
<p>The first line of the function calculates the probability of correctly answering all <span class="math inline">\(M\)</span> items, and stores the result in a vector <code>pi_i</code>.
In the next line, we simulate binary outcomes by flipping coins with the specified vector of probabilities.
Finally, we assign names to each item so that we can keep track of which score is for which item.
Now, using the <code>map()</code> function, we can run the function for every one of our respondents:</p>
<div class="sourceCode" id="cb142"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb142-1"><a href="data-generating-processes.html#cb142-1" tabindex="-1"></a><span class="fu">map_dfr</span>(</span>
<span id="cb142-2"><a href="data-generating-processes.html#cb142-2" tabindex="-1"></a>  thetas, <span class="at">.f =</span> r_scores, </span>
<span id="cb142-3"><a href="data-generating-processes.html#cb142-3" tabindex="-1"></a>  <span class="at">alphas =</span> alphas, <span class="at">betas =</span> betas, <span class="at">gammas =</span> gammas, <span class="at">M =</span> M</span>
<span id="cb142-4"><a href="data-generating-processes.html#cb142-4" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## # A tibble: 7 × 4
##      q1    q2    q3    q4
##   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;
## 1     0     0     1     0
## 2     1     1     0     0
## 3     1     0     0     0
## 4     1     1     1     1
## 5     0     0     0     1
## 6     1     0     1     1
## 7     0     1     0     0</code></pre>
<p>To make it easier to generate datasets with different characteristics, we bundle the above code chunks into a single data-generating function.
To do so, we have to decide what the input parameters should be.
We know we need to at least specify <span class="math inline">\(N\)</span> and <span class="math inline">\(M\)</span>.
We made assumptions about the item parameters, but we had to specify means and standard deviations for the difficulty and discrimination parameter distributions, so it is natural to allow those to be inputs also.
Our data-generating function will then be</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb144-1"><a href="data-generating-processes.html#cb144-1" tabindex="-1"></a>r_3PL_IRT <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb144-2"><a href="data-generating-processes.html#cb144-2" tabindex="-1"></a>    N, <span class="at">M =</span> <span class="dv">4</span>,</span>
<span id="cb144-3"><a href="data-generating-processes.html#cb144-3" tabindex="-1"></a>    <span class="at">diff_M =</span> <span class="dv">0</span>, <span class="at">diff_SD =</span> <span class="dv">1</span>,</span>
<span id="cb144-4"><a href="data-generating-processes.html#cb144-4" tabindex="-1"></a>    <span class="at">disc_M =</span> <span class="dv">1</span>, <span class="at">disc_SD =</span> <span class="fl">0.2</span>,</span>
<span id="cb144-5"><a href="data-generating-processes.html#cb144-5" tabindex="-1"></a>    <span class="at">item_options =</span> <span class="dv">4</span></span>
<span id="cb144-6"><a href="data-generating-processes.html#cb144-6" tabindex="-1"></a>) {</span>
<span id="cb144-7"><a href="data-generating-processes.html#cb144-7" tabindex="-1"></a>  <span class="co"># generate ability parameters</span></span>
<span id="cb144-8"><a href="data-generating-processes.html#cb144-8" tabindex="-1"></a>  thetas <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N)</span>
<span id="cb144-9"><a href="data-generating-processes.html#cb144-9" tabindex="-1"></a>  </span>
<span id="cb144-10"><a href="data-generating-processes.html#cb144-10" tabindex="-1"></a>  <span class="co"># generate item parameters</span></span>
<span id="cb144-11"><a href="data-generating-processes.html#cb144-11" tabindex="-1"></a>  alphas <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(M, <span class="at">mean =</span> diff_M, <span class="at">sd =</span> diff_SD)</span>
<span id="cb144-12"><a href="data-generating-processes.html#cb144-12" tabindex="-1"></a>  betas <span class="ot">&lt;-</span> <span class="fu">rgamma</span>(M, </span>
<span id="cb144-13"><a href="data-generating-processes.html#cb144-13" tabindex="-1"></a>                  <span class="at">shape =</span> disc_M<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> disc_SD<span class="sc">^</span><span class="dv">2</span>, </span>
<span id="cb144-14"><a href="data-generating-processes.html#cb144-14" tabindex="-1"></a>                  <span class="at">rate =</span> disc_M <span class="sc">*</span> disc_SD<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb144-15"><a href="data-generating-processes.html#cb144-15" tabindex="-1"></a>  gammas <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span> <span class="sc">/</span> item_options, M)</span>
<span id="cb144-16"><a href="data-generating-processes.html#cb144-16" tabindex="-1"></a></span>
<span id="cb144-17"><a href="data-generating-processes.html#cb144-17" tabindex="-1"></a>  <span class="co"># simulate item responses</span></span>
<span id="cb144-18"><a href="data-generating-processes.html#cb144-18" tabindex="-1"></a>  test_scores <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(</span>
<span id="cb144-19"><a href="data-generating-processes.html#cb144-19" tabindex="-1"></a>   thetas, <span class="at">.f =</span> r_scores, </span>
<span id="cb144-20"><a href="data-generating-processes.html#cb144-20" tabindex="-1"></a>    <span class="at">alphas =</span> alphas, <span class="at">betas =</span> betas, <span class="at">gammas =</span> gammas, <span class="at">M =</span> M</span>
<span id="cb144-21"><a href="data-generating-processes.html#cb144-21" tabindex="-1"></a>  )</span>
<span id="cb144-22"><a href="data-generating-processes.html#cb144-22" tabindex="-1"></a>  </span>
<span id="cb144-23"><a href="data-generating-processes.html#cb144-23" tabindex="-1"></a>  <span class="co"># calculate total score</span></span>
<span id="cb144-24"><a href="data-generating-processes.html#cb144-24" tabindex="-1"></a>  test_scores<span class="sc">$</span>total <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(test_scores)</span>
<span id="cb144-25"><a href="data-generating-processes.html#cb144-25" tabindex="-1"></a>  </span>
<span id="cb144-26"><a href="data-generating-processes.html#cb144-26" tabindex="-1"></a>  <span class="fu">return</span>(test_scores)</span>
<span id="cb144-27"><a href="data-generating-processes.html#cb144-27" tabindex="-1"></a>}</span>
<span id="cb144-28"><a href="data-generating-processes.html#cb144-28" tabindex="-1"></a></span>
<span id="cb144-29"><a href="data-generating-processes.html#cb144-29" tabindex="-1"></a><span class="fu">r_3PL_IRT</span>(<span class="at">N =</span> <span class="dv">7</span>, <span class="at">M =</span> <span class="dv">4</span>)</span></code></pre></div>
<pre><code>## # A tibble: 7 × 5
##      q1    q2    q3    q4 total
##   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt;
## 1     1     1     0     0     2
## 2     1     1     1     1     4
## 3     1     1     1     0     3
## 4     1     1     1     1     4
## 5     1     1     1     0     3
## 6     1     1     1     1     4
## 7     1     1     1     1     4</code></pre>
<p>Now let’s look at a much larger sample of participants, with a longer test that includes <span class="math inline">\(M = 12\)</span> items:</p>
<div class="sourceCode" id="cb146"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb146-1"><a href="data-generating-processes.html#cb146-1" tabindex="-1"></a>test_scores <span class="ot">&lt;-</span> <span class="fu">r_3PL_IRT</span>(<span class="at">N =</span> <span class="dv">10000</span>, <span class="at">M =</span> <span class="dv">12</span>)</span></code></pre></div>
<p>Having written a function for the 3-parameter logistic IRT model makes it easy to explore properties of the model.
For instance, we can easily visualize the distribution of the total scores on the test:</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb147-1"><a href="data-generating-processes.html#cb147-1" tabindex="-1"></a><span class="fu">ggplot</span>(test_scores, <span class="fu">aes</span>(total)) <span class="sc">+</span> </span>
<span id="cb147-2"><a href="data-generating-processes.html#cb147-2" tabindex="-1"></a>  <span class="fu">geom_bar</span>() <span class="sc">+</span> </span>
<span id="cb147-3"><a href="data-generating-processes.html#cb147-3" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">12.5</span>), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">12</span>,<span class="dv">2</span>))</span></code></pre></div>
<p><img src="Designing-Simulations-in-R_files/figure-html/unnamed-chunk-91-1.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Looking at item variation, we can examine the probability of correctly responding to each of the items by computing sample means for each item:</p>
<div class="sourceCode" id="cb148"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb148-1"><a href="data-generating-processes.html#cb148-1" tabindex="-1"></a>test_scores <span class="sc">%&gt;%</span></span>
<span id="cb148-2"><a href="data-generating-processes.html#cb148-2" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">&quot;q&quot;</span>), mean))</span></code></pre></div>
<pre><code>## # A tibble: 1 × 12
##      q1    q2    q3    q4    q5    q6    q7    q8
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 0.628  0.62 0.629 0.256 0.539 0.620 0.624 0.620
## # ℹ 4 more variables: q9 &lt;dbl&gt;, q10 &lt;dbl&gt;,
## #   q11 &lt;dbl&gt;, q12 &lt;dbl&gt;</code></pre>
<p>The percentage of correct responses varies from 25.6% to 63.3.
What are the correlations between individual items and the total score?
Let’s check:</p>
<div class="sourceCode" id="cb150"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb150-1"><a href="data-generating-processes.html#cb150-1" tabindex="-1"></a>test_scores <span class="sc">%&gt;%</span></span>
<span id="cb150-2"><a href="data-generating-processes.html#cb150-2" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">&quot;q&quot;</span>), <span class="sc">~</span> <span class="fu">cor</span>(.x, total)))</span></code></pre></div>
<pre><code>## # A tibble: 1 × 12
##      q1    q2     q3    q4    q5    q6    q7    q8
##   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 0.154 0.386 0.0195 0.227 0.445 0.411 0.386 0.421
## # ℹ 4 more variables: q9 &lt;dbl&gt;, q10 &lt;dbl&gt;,
## #   q11 &lt;dbl&gt;, q12 &lt;dbl&gt;</code></pre>
<p>Note that simulating a new dataset will produce different results for these summaries because generating each dataset entails sampling a new set of items (with different difficulty and discrimination).</p>
<p>Writing a DGP function makes it possible to study a model through exploration, simply by examining datasets generated by wiggling the model parameters up or down.
For instance, we could look at what happens to the distribution of total scores if the items covered a much broader range of difficulties (higher <span class="math inline">\(\tau_\alpha\)</span>) or are mis-calibrated to be too difficult (<span class="math inline">\(\mu_\tau &gt; 0\)</span>).
What if the items had varying numbers of response options, so the guessing parameters differ?
Are there item parameter values that will produce highly unrealistic distributions of total scores?
Exercises <a href="data-generating-processes.html#IRT-DGP-parameters">6.9.11</a>, <a href="data-generating-processes.html#IRT-DGP-checking">6.9.12</a>, and <a href="data-generating-processes.html#IRT-DGP-breaking">6.9.13</a> ask you to further explore these questions.</p>
<p>Overall, implementing the model as a data-generating function has allowed us to explore the model in a more active way than simply reading about it or listening to a lecture.
We have a more visceral feel about how the different parameters would create variation in our data—and it would be easy to tweak those parameters to see how things changed to learn even more.</p>
<!-- LWM: I like this example, but it would be great if we added some specific takeaways of what we are learning by these sorts of explorations. I had originally thought to look at how distribution of total score has changed as a function of student ability, but that would involve updating the DGP. To discuss. -->
</div>
<div id="more-to-explore" class="section level2 hasAnchor" number="6.8">
<h2><span class="header-section-number">6.8</span> More to explore<a href="data-generating-processes.html#more-to-explore" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This chapter has introduced the core components of a data-generating process and demonstrated how to move from formulating a full data-generating model to implementing the model in R code.
Our main aim has been to provide enough scaffolding for you to get started with simulating from and exploring a variety of models.
The exercises below will give you further practice in developing, testing, and extending DGP functions.
Of course, we have not covered every consideration and challenge that arises when writing DGPs for simulations—there is <em>much</em> more to explore!</p>
<p>We will cover some further challenges in subsequent chapters.
<!-- JEP: Links to specific further chapters? -->
<!-- LWM: TODO later when book is settled. -->
Yet more challenges will surely arise as you apply simulations in your own work.
Even though such challenges might not align with the examples or contexts that we have covered here, the concepts and principles that we have introduced should allow you to reason about potential solutions.
In doing so, we encourage you adopt the attitude of a chef in a test kitchen by trying out your ideas with code.
In the kitchen, there is often no way to know how a dish will turn out until you actually bake it and taste it.
Likewise, in developing a DGP, the best way to understand and evaluate a DGP is to write it out in code and explore the datasets that you can produce with it.</p>
</div>
<div id="exercises-3" class="section level2 hasAnchor" number="6.9">
<h2><span class="header-section-number">6.9</span> Exercises<a href="data-generating-processes.html#exercises-3" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="Welch-t-dgp" class="section level3 hasAnchor" number="6.9.1">
<h3><span class="header-section-number">6.9.1</span> The Welch test on a shifted-and-scaled <span class="math inline">\(t\)</span> distribution<a href="data-generating-processes.html#Welch-t-dgp" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The shifted-and-scaled <span class="math inline">\(t\)</span>-distribution has parameters <span class="math inline">\(\mu\)</span> (mean), <span class="math inline">\(\sigma\)</span> (scale), and <span class="math inline">\(\nu\)</span> (degrees of freedom).
If <span class="math inline">\(T\)</span> follows a student’s <span class="math inline">\(t\)</span>-distribution with <span class="math inline">\(\nu\)</span> degrees of freedom, then <span class="math inline">\(S = \mu + \sigma T\)</span> follows a shifted-and-scaled <span class="math inline">\(t\)</span>-distribution.</p>
<p>The following function will generate random draws from this distribution.
We additionally scale by <span class="math inline">\((\nu-2)/\nu\)</span> to achieve the target standard deviation (a <span class="math inline">\(t\)</span>-distribution has a variance of <span class="math inline">\(\nu/(\nu-2)\)</span>).</p>
<div class="sourceCode" id="cb152"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb152-1"><a href="data-generating-processes.html#cb152-1" tabindex="-1"></a>r_tss <span class="ot">&lt;-</span> <span class="cf">function</span>(n, mean, sd, df) {</span>
<span id="cb152-2"><a href="data-generating-processes.html#cb152-2" tabindex="-1"></a>  mean <span class="sc">+</span> sd <span class="sc">*</span> <span class="fu">sqrt</span>( (df<span class="dv">-2</span>)<span class="sc">/</span>df ) <span class="sc">*</span> <span class="fu">rt</span>(<span class="at">n =</span> n, <span class="at">df =</span> df)</span>
<span id="cb152-3"><a href="data-generating-processes.html#cb152-3" tabindex="-1"></a>}</span>
<span id="cb152-4"><a href="data-generating-processes.html#cb152-4" tabindex="-1"></a></span>
<span id="cb152-5"><a href="data-generating-processes.html#cb152-5" tabindex="-1"></a><span class="fu">r_tss</span>(<span class="at">n =</span> <span class="dv">8</span>, <span class="at">mean =</span> <span class="dv">3</span>, <span class="at">sd =</span> <span class="dv">2</span>, <span class="at">df =</span> <span class="dv">5</span>)</span></code></pre></div>
<pre><code>## [1]  0.02822602  3.87035901  4.51376755
## [4]  3.02447410 -0.26265918  2.29642811
## [7]  1.16346358  7.59634125</code></pre>
<ol style="list-style-type: decimal">
<li><p>Modify the Welch simulation’s <code>simulate_data()</code> function to generate data from shifted-and-scaled <span class="math inline">\(t\)</span>-distributions rather than from normal distributions. Include the degrees of freedom as an input argument.
Simulate a dataset with low degrees of freedom and plot it to see if you see a few outliers.</p></li>
<li><p>Now generate more data and calculate the means and standard deviations to see if they are correctly calibrated (i.e., generate a big dataset to ensure you get reliable mean and standard deviation estimates). Check <code>df</code> equal to 500, 5, 3, and 2.</p></li>
<li><p>Once you are satisfied you have a correct DGP function, re-run the Type-I error rate calculations from the prior exercises in Section <a href="case-ANOVA.html#exAnovaExercises">5.5</a> using a <span class="math inline">\(t\)</span>-distribution with 5 degrees of freedom.
Do the results change substantially?</p></li>
</ol>
</div>
<div id="plot-the-bivariate-poisson" class="section level3 hasAnchor" number="6.9.2">
<h3><span class="header-section-number">6.9.2</span> Plot the bivariate Poisson<a href="data-generating-processes.html#plot-the-bivariate-poisson" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In Section <a href="data-generating-processes.html#DGP-functions">6.3</a>, we provided an example of a DGP function for the bivariate Poisson model.
We demonstrated a plot of data simulated from this function in <a href="data-generating-processes.html#DGP-plotting">6.4</a>.
Create a similar plot but for a much larger sample size of <span class="math inline">\(N = 1000\)</span>.</p>
<p>With such a large dataset, it will likely be hard to distinguish individual observations because of over-plotting.
Create a better visual representation of the same simulated dataset, such as a heatmap or a contour plot.</p>
</div>
<div id="BVP-check" class="section level3 hasAnchor" number="6.9.3">
<h3><span class="header-section-number">6.9.3</span> Check the bivariate Poisson function<a href="data-generating-processes.html#BVP-check" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Although we presented a DGP function for the bivariate Poisson model, we have not demonstrated how to check that the function is correct—we’re leaving that to you!
Write some code to verify that the function <code>r_bivariate_Poisson()</code> is working properly.
Do this by generating a very large sample (say <span class="math inline">\(N = 10^4\)</span> or <span class="math inline">\(10^5\)</span>) and verifying the following:</p>
<ul>
<li>The sample means of <span class="math inline">\(C_1\)</span> and <span class="math inline">\(C_2\)</span> align with the specified population means.</li>
<li>The sample variances of <span class="math inline">\(C_1\)</span> and <span class="math inline">\(C_2\)</span> are close to the specified population means (because for a Poisson distribution <span class="math inline">\(\mathbb{E}(C_p) = \mathbb{V}(C_p)\)</span> for <span class="math inline">\(p = 1,2\)</span>).</li>
<li>The sample correlation aligns with the specified population correlation.</li>
<li>The observed counts <span class="math inline">\(C_1\)</span> and <span class="math inline">\(C_2\)</span> follow Poisson distributions.
<!-- LWM: How do you check to see if it follows?  Give some more hints here, and then refer to this problem later when asking again for gamma --></li>
</ul>
</div>
<div id="BVP-error" class="section level3 hasAnchor" number="6.9.4">
<h3><span class="header-section-number">6.9.4</span> Add error-catching to the bivariate Poisson function<a href="data-generating-processes.html#BVP-error" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In Section <a href="data-generating-processes.html#DGP-examples">6.1</a>, we noted that the bivariate Poisson function as we described it can only produce a constrained range of correlations, which a maximum value that depends on the ratio of <span class="math inline">\(\mu_1\)</span> to <span class="math inline">\(\mu_2\)</span>.
Our current implementation of the model does not handle this aspect of the model very well:</p>
<div class="sourceCode" id="cb154"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb154-1"><a href="data-generating-processes.html#cb154-1" tabindex="-1"></a><span class="fu">r_bivariate_Poisson</span>(<span class="dv">5</span>, <span class="at">rho =</span> <span class="fl">0.6</span>, <span class="at">mu1 =</span> <span class="dv">4</span>, <span class="at">mu2 =</span> <span class="dv">12</span>)</span></code></pre></div>
<pre><code>## Warning in rpois(N, lambda = mu1 - EZ3): NAs
## produced</code></pre>
<pre><code>##   C1 C2
## 1 NA 11
## 2 NA 11
## 3 NA 13
## 4 NA 15
## 5 NA  9</code></pre>
<p>For this combination of parameter values, <span class="math inline">\(\rho \times \sqrt{\mu_1 \mu_2}\)</span> is larger than <span class="math inline">\(\mu_1\)</span>, which leads to simulated values for <span class="math inline">\(C_1\)</span> that are all missing.
That makes it pretty hard to compute the correlation between <span class="math inline">\(C_1\)</span> and <span class="math inline">\(C_2\)</span>.</p>
<p>Please help us fix this issue! Revise <code>r_bivariate_Poisson()</code> so that it checks for allowable values of <span class="math inline">\(\rho\)</span>. If the user specifies a combination of parameters that does not make sense, make the function throw an error (using R’s <code>stop()</code> function).</p>
</div>
<div id="BVNB1" class="section level3 hasAnchor" number="6.9.5">
<h3><span class="header-section-number">6.9.5</span> A bivariate negative binomial distribution<a href="data-generating-processes.html#BVNB1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>One potential limitation of the bivariate Poisson distribution described above is that the variances of the counts are necessarily equal to the means (i.e., unit dispersion).
This limitation is inherited from the univariate Poisson distributions that each variate follows.
Just as with the corresponding univariate distributions, one way to relax this limitation is to consider distributions with marginals that are negative binomial rather than Poisson, thereby allowing for overdispersion.
<span class="citation">Cho et al. (<a href="#ref-Cho2023bivariate">2023</a>)</span> describes one type of bivariate negative binomial distribution and provides a method for constructing a bivariate negative binomial distribution by using latent, gamma-distributed components.
Their algorithm involves first generating components from gamma distributions with specified shape and scale parameters:
<span class="math display">\[
\begin{aligned}
Z_0 &amp;\sim \Gamma\left( \alpha_0, \beta\right) \\
Z_1 &amp;\sim \Gamma\left( \alpha_1, \beta\right) \\
Z_2 &amp;\sim \Gamma\left( \alpha_2, \beta\right)
\end{aligned}
\]</span>
for <span class="math inline">\(\alpha_0,\alpha_1,\alpha_2 &gt; 0\)</span> and <span class="math inline">\(\beta &gt; 0\)</span>.
They then simulate independent Poisson random variables as
<span class="math display">\[
\begin{aligned}
C_1 &amp;\sim Pois\left( Z_0 + Z_1 \right) \\
C_2 &amp;\sim Pois\left( \delta(Z_0 + Z_2) \right).
\end{aligned}
\]</span>
The resulting count variables follow marginal negative binomial distributions with moments
<span class="math display">\[
\begin{aligned}
\mathbb{E}(C_1) &amp;= (\alpha_0 + \alpha_1) \beta &amp; \mathbb{V}(C_1) &amp;= (\alpha_0 + \alpha_1) \beta (\beta + 1) \\
\mathbb{E}(C_2) &amp;= (\alpha_0 + \alpha_2) \beta \delta &amp; \mathbb{V}(C_2) &amp;= (\alpha_0 + \alpha_2) \beta \delta (\beta \delta + 1) \\
&amp; &amp; \text{Cov}(C_1, C_2) &amp;= \alpha_0 \beta^2 \delta.
\end{aligned}
\]</span>
The correlation between <span class="math inline">\(C_1\)</span> and <span class="math inline">\(C_2\)</span> is thus
<span class="math display">\[
\text{cor}(C_1, C_2) = \frac{\alpha_0}{\sqrt{(\alpha_0 + \alpha_1)(\alpha_0 + \alpha_2)}} \frac{\beta \sqrt{\delta}}{\sqrt{(\beta + 1)(\beta \delta + 1)}}.
\]</span></p>
<ol style="list-style-type: decimal">
<li><p>Write a DGP function that implements this distribution.</p></li>
<li><p>Write some code to check that the function produces data where each variate follows a negative binomial distribution and where the correlation agrees with the formula given above.</p></li>
<li><p>Consider parameter values that produce <span class="math inline">\(\mathbb{E}(C_1) = \mathbb{E}(C_2) = 10\)</span> and <span class="math inline">\(\mathbb{V}(C_1) = \mathbb{V}(C_2) = 15\)</span>. What are the minimum and maximum possible correlations between <span class="math inline">\(C_1\)</span> and <span class="math inline">\(C_2\)</span>?</p></li>
</ol>
</div>
<div id="BVNB2" class="section level3 hasAnchor" number="6.9.6">
<h3><span class="header-section-number">6.9.6</span> Another bivariate negative binomial distribution<a href="data-generating-processes.html#BVNB2" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Another model for generating bivariate counts with negative binomial marginal distributions is by using Gaussian copulas. Here is a mathematical recipe for this distribution, which will produce counts with marginal means <span class="math inline">\(\mu_1\)</span> and <span class="math inline">\(\mu_2\)</span> and marginal variances <span class="math inline">\(\mu_1 + \mu_1^2 / p_1\)</span> and <span class="math inline">\(\mu_2 + \mu_2^2 / p_2\)</span>. Start by generating variates from a bivariate standard normal distribution with correlation <span class="math inline">\(\rho\)</span>:
<span class="math display">\[
\left(\begin{array}{c}Z_1 \\ Z_2 \end{array}\right) \sim N\left(\left[\begin{array}{c}0 \\ 0\end{array}\right], \ \left[\begin{array}{cc}1  &amp; \rho \\ \rho &amp; 1\end{array}\right]\right)
\]</span>
Now find <span class="math inline">\(U_1 = \Phi(Z_1)\)</span> and <span class="math inline">\(U_1 = \Phi(Z_1)\)</span>, where <span class="math inline">\(\Phi()\)</span> is the standard normal cumulative distribution function (called <code>pnorm()</code> in R).
Then generate the counts by evaluating <span class="math inline">\(U_1\)</span> and <span class="math inline">\(U_2\)</span> with the negative binomial quantile function, <span class="math inline">\(F_{NB}^{-1}(x | \mu, p)\)</span> with mean parameters <span class="math inline">\(\mu\)</span> and size parameter <span class="math inline">\(p\)</span> (this function is called <code>qnbinom()</code> in R):
<span class="math display">\[
C_1 = F_{NB}^{-1}(U_1 | \mu_1, p_1) \qquad C_2 = F_{NB}^{-1}(U_2 |  \mu_2, p_2).
\]</span>
The resulting counts will be correlated, but the correlation will not be equal to <span class="math inline">\(\rho\)</span>.</p>
<ol style="list-style-type: decimal">
<li><p>Write a DGP function that implements this distribution.</p></li>
<li><p>Write some code to check that the function produces data where each variate follows a negative binomial distribution</p></li>
<li><p>Use the function to create a graph showing the population correlation between the observed counts as a function of <span class="math inline">\(\rho\)</span>. Use <span class="math inline">\(\mu_1 = \mu_2 = 10\)</span> and <span class="math inline">\(p_1 = p_2 = 20\)</span>. How does the range of correlations compare to the range from Exercise <a href="data-generating-processes.html#BVNB1">6.9.5</a>?</p></li>
</ol>
</div>
<div id="cluster-RCT-plot" class="section level3 hasAnchor" number="6.9.7">
<h3><span class="header-section-number">6.9.7</span> Plot the data from a cluster-randomized trial<a href="data-generating-processes.html#cluster-RCT-plot" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Run <code>gen_cluster_RCT()</code> with parameter values of your choice to produce data from a simulated cluster-randomized trial. Create a plot of the data that illustrates how student-level observations are nested within schools and how schools are assigned to different treatment conditions.</p>
</div>
<div id="cluster-RCT-checks" class="section level3 hasAnchor" number="6.9.8">
<h3><span class="header-section-number">6.9.8</span> Checking the Cluster RCT DGP<a href="data-generating-processes.html#cluster-RCT-checks" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<ol style="list-style-type: decimal">
<li><p>What is the variance of the outcomes generated by the model for the cluster-randomized trial if there are no treatment effects? (Try simulating data to check!) What other quick checks can you run on this DGP to make sure it is working correctly?</p></li>
<li><p>In <code>gen_cluster_RCT()</code> we have the following line of code to generate the number of individuals per site.</p>
<div class="sourceCode" id="cb157"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb157-1"><a href="data-generating-processes.html#cb157-1" tabindex="-1"></a>nj <span class="ot">&lt;-</span> <span class="fu">sample</span>( n_min<span class="sc">:</span>n_max, J, <span class="at">replace=</span><span class="cn">TRUE</span> )</span></code></pre></div>
<p>This code has an error. Generate a variety of datasets where you vary <code>n_min</code>, <code>n_max</code> and <code>J</code> to discover the error. Then repair the code.
Checking your data generating process across a range of scenarios is extremely important.</p></li>
</ol>
</div>
<div id="cluster-RCT-heterogeneity" class="section level3 hasAnchor" number="6.9.9">
<h3><span class="header-section-number">6.9.9</span> More school-level variation<a href="data-generating-processes.html#cluster-RCT-heterogeneity" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The DGP for the cluster-randomized trial allows for school-level treatment impact variation, but only to the extent that the variation is explained by school size. How could you modify your simulation to allow for school-level treatment impact variation that is not related to school size? Implement this change and generate some data to show how it works.</p>
</div>
<div id="cluster-RCT-baseline" class="section level3 hasAnchor" number="6.9.10">
<h3><span class="header-section-number">6.9.10</span> Cluster-randomized trial with baseline predictors<a href="data-generating-processes.html#cluster-RCT-baseline" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Extend the DGP for the cluster-randomized trial to include an individual-level covariate <span class="math inline">\(X\)</span> that is correlated with the outcome.
Do this by modifying the model for student-level outcomes as
<span class="math display">\[
Y_{ij} = \beta_{0j} + \beta_{1} X_{ij} + \epsilon_{ij}.
\]</span>
Keep the same <span class="math inline">\(\beta_1\)</span> for all sites.
To implement this model as a DGP, you will have to decide how to generate <span class="math inline">\(X_{ij}\)</span>.</p>
<ol style="list-style-type: decimal">
<li>Use words and equations to explain your auxiliary model for <span class="math inline">\(X_{ij}\)</span>.</li>
<li>Implement the model by modifying <code>gen_cluster_RCT()</code> accordingly.</li>
<li>Use your implementation to find the unconditional variance of the outcome, <span class="math inline">\(\text{Var}(Y | Z_j = 0)\)</span>, when <span class="math inline">\(\beta_1 = 0.6\)</span>.</li>
</ol>
</div>
<div id="IRT-DGP-parameters" class="section level3 hasAnchor" number="6.9.11">
<h3><span class="header-section-number">6.9.11</span> 3-parameter IRT datasets<a href="data-generating-processes.html#IRT-DGP-parameters" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>A challenge that arises with the IRT model described in Section <a href="data-generating-processes.html#three-parameter-IRT">6.7</a> is that the data are generated using <em>random parameters</em> (the person ability parameters <span class="math inline">\(\theta_1,...,\theta_N\)</span> and item characteristics <span class="math inline">\(\alpha_m, \beta_m, \gamma_m\)</span> for <span class="math inline">\(m = 1,...,M\)</span>) that we simulated from auxiliary models.
When applying IRT models to actual test data, the analyst’s goal will usually involve estimating at least some of these parameters: either using the model for <em>scoring</em> by estimating latent ability parameters or for <em>calibration</em> by estimating the item characteristics.
But each time we generate a new dataset with <code>r_3PL_IRT()</code>, those latent parameters will change.</p>
<p>In order to understand how well an estimation procedure will perform on data generated by our function, we will need to keep track of the parameter values, even though those values will not be known in real data analysis contexts.
Suppose that our main interest is in understanding how well we can recover the item characteristics.</p>
<ol style="list-style-type: decimal">
<li><p>Modify <code>r_3PL_IRT()</code> to return a list containing two datasets. The first entry in the list should be a dataset with the person-by-item responses, just as in the original function. The second entry in the list should be an <span class="math inline">\(M \times 3\)</span> dataset containing the item parameters.</p></li>
<li><p>An alternative strategy for implementing the three-parameter IRT DGP is to write two functions instead of one: a function to simulate a set of <span class="math inline">\(M\)</span> item parameters and a function to simulate the person-by-item responses. Complete the following function skeletons to implement this strategy. Demonstrate how to use the functions to simulate a dataset.</p>
<div class="sourceCode" id="cb158"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb158-1"><a href="data-generating-processes.html#cb158-1" tabindex="-1"></a>r_3PL_items <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb158-2"><a href="data-generating-processes.html#cb158-2" tabindex="-1"></a>  M, </span>
<span id="cb158-3"><a href="data-generating-processes.html#cb158-3" tabindex="-1"></a>  <span class="at">diff_M =</span> <span class="dv">0</span>, <span class="at">diff_SD =</span> <span class="dv">1</span>,</span>
<span id="cb158-4"><a href="data-generating-processes.html#cb158-4" tabindex="-1"></a>  <span class="at">disc_M =</span> <span class="dv">1</span>, <span class="at">disc_SD =</span> <span class="fl">0.2</span>,</span>
<span id="cb158-5"><a href="data-generating-processes.html#cb158-5" tabindex="-1"></a>  <span class="at">item_options =</span> <span class="dv">4</span></span>
<span id="cb158-6"><a href="data-generating-processes.html#cb158-6" tabindex="-1"></a>) {</span>
<span id="cb158-7"><a href="data-generating-processes.html#cb158-7" tabindex="-1"></a>  <span class="co"># Code here</span></span>
<span id="cb158-8"><a href="data-generating-processes.html#cb158-8" tabindex="-1"></a>  <span class="fu">return</span>(item_parameter_data)</span>
<span id="cb158-9"><a href="data-generating-processes.html#cb158-9" tabindex="-1"></a>}</span>
<span id="cb158-10"><a href="data-generating-processes.html#cb158-10" tabindex="-1"></a></span>
<span id="cb158-11"><a href="data-generating-processes.html#cb158-11" tabindex="-1"></a>r_3PL_data <span class="ot">&lt;-</span> <span class="cf">function</span>( N, item_data ) {</span>
<span id="cb158-12"><a href="data-generating-processes.html#cb158-12" tabindex="-1"></a>  <span class="co"># Generate item responses</span></span>
<span id="cb158-13"><a href="data-generating-processes.html#cb158-13" tabindex="-1"></a>  <span class="fu">return</span>(response_data)</span>
<span id="cb158-14"><a href="data-generating-processes.html#cb158-14" tabindex="-1"></a>}</span></code></pre></div></li>
<li><p>Describe the benefits and limitations of the two approaches you have implemented.</p></li>
<li><p>For your preferred strategy, modify your function(s) to also return the latent person ability parameters.</p></li>
</ol>
</div>
<div id="IRT-DGP-checking" class="section level3 hasAnchor" number="6.9.12">
<h3><span class="header-section-number">6.9.12</span> Check the 3-parameter IRT DGP<a href="data-generating-processes.html#IRT-DGP-checking" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>For one of the DGPs you wrote in Exercise <a href="data-generating-processes.html#IRT-DGP-parameters">6.9.11</a>, write code to check that the function is working properly. What features of the model will you check?</p>
</div>
<div id="IRT-DGP-breaking" class="section level3 hasAnchor" number="6.9.13">
<h3><span class="header-section-number">6.9.13</span> Explore the 3-parameter IRT model<a href="data-generating-processes.html#IRT-DGP-breaking" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Use the modified DGP function(s) you wrote for Exercise <a href="data-generating-processes.html#IRT-DGP-parameters">6.9.11</a> to explore the model. Simulate data and create visualizations to answer the following questions.</p>
<ol style="list-style-type: decimal">
<li>What happens to the distribution of total scores if the items covered a very broader range of difficulties (higher <span class="math inline">\(\tau_\alpha\)</span>)?</li>
<li>What happens if the items are mis-calibrated to be too difficult (<span class="math inline">\(\mu_\tau &gt; 0\)</span>)?</li>
<li>What if the items had varying numbers of response options, so the guessing parameters differ?</li>
<li>Find at least one combination of parameter values that will produce very extreme or unrealistic distributions of total scores.</li>
</ol>
</div>
<div id="meta-regression-DGP" class="section level3 hasAnchor" number="6.9.14">
<h3><span class="header-section-number">6.9.14</span> Random effects meta-regression<a href="data-generating-processes.html#meta-regression-DGP" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Meta-analysis involves working with quantitative findings reported by previous studies on a particular topic, in the form of effect size estimates and their standard errors, to generate integrative summaries and identify patterns in the findings that might not be evident from any previous study considered in isolation.
One model that is widely used in meta-analysis is the random effects meta-regression, which relates the effect sizes to known characteristics of the studies that are encoded in the form of predictors.
Consider a collection of <span class="math inline">\(K\)</span> studies. Let <span class="math inline">\(T_i\)</span> denote an effect size estimate and <span class="math inline">\(s_i\)</span> denote its standard error for study <span class="math inline">\(i\)</span>.
Let <span class="math inline">\(x_{i}\)</span> be a quantitative predictor variable that represents some characteristic of study <span class="math inline">\(i\)</span> (such as its year of publication).
The random effects meta-regression model assumes
<span class="math display">\[
T_i = \beta_0 + \beta_1 x_i + u_i + e_i,
\]</span>
where <span class="math inline">\(u_i \sim N(0, \tau^2)\)</span> and <span class="math inline">\(e_i \sim N(0, s_i^2)\)</span>.
In this model, <span class="math inline">\(\beta_0\)</span> corresponds to the expected effect size when <span class="math inline">\(x_i = 0\)</span> and <span class="math inline">\(\beta_1\)</span> describes the expected difference in effect size per one unit difference in <span class="math inline">\(x_i\)</span>.
The first error <span class="math inline">\(u_i\)</span> corresponds to the heterogeneity in the effect sizes above and beyond the variation explained by <span class="math inline">\(x_i\)</span>, and the second error <span class="math inline">\(e_i\)</span> corresponds to the sampling error, which we assume has known variance <span class="math inline">\(s_i^2\)</span>.</p>
<ol style="list-style-type: decimal">
<li><p>Of the variables in the random effects meta-regression model, which are structural features, which are covariates, and which are outcomes? Of the parameters described above, which would you classify as focal, which as auxiliary, and which as design parameters?</p></li>
<li><p>In addition to the focal model described above, what further assumptions or auxiliary models will be needed in order to simulate data for a random effects meta-regression? Propose an auxiliary model for any needed quantities.</p></li>
<li><p>Using your proposed auxiliary model, write a function to generate data for a random effects meta-regression. Demonstrate your function by creating a plot based on a simulated dataset with <span class="math inline">\(K = 30\)</span> effect sizes.</p></li>
<li><p>Write code to check the properties of your data-generating function.</p></li>
</ol>
</div>
<div id="Vevea-Hedges-DGP" class="section level3 hasAnchor" number="6.9.15">
<h3><span class="header-section-number">6.9.15</span> Meta-regression with selective reporting<a href="data-generating-processes.html#Vevea-Hedges-DGP" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><span class="citation">Vevea and Hedges (<a href="#ref-vevea1995general">1995</a>)</span> proposed a meta-regression model that allows for the possibility that not all primary study results are published.
They assume that primary study results are generated according to the random effects meta-regression model described in Exercise <a href="data-generating-processes.html#meta-regression-DGP">6.9.14</a>, but then only a subset of results are observed, where the probability of being included is a function of the result’s one-sided <span class="math inline">\(p\)</span>-value for the null hypothesis <span class="math inline">\(H_0: \delta \leq 0\)</span> against alternative <span class="math inline">\(H_A: \delta &gt; 0\)</span>.
Let <span class="math inline">\(p_i = 1 - \Phi(T_i / s_i)\)</span> be the one-sided <span class="math inline">\(p\)</span>-value for study result <span class="math inline">\(i\)</span>, where <span class="math inline">\(Phi()\)</span> is the standard normal cumulative distribution (<code>pnorm()</code> in R).
In one version of the selection model, the selection probability follows a piece-wise constant distribution with
<span class="math display">\[
\text{Pr}(T_i \text{ is observed}) = \begin{cases}
1 &amp; \text{if} \quad 0 \leq p_i &lt; .025 \\
\lambda_1 &amp; \text{if} \quad .025 \leq p_i &lt; .500 \\  
\lambda_2 &amp; \text{if} \quad .500 \leq  p_i &lt; 1
\end{cases}
\]</span>
for selection probabilities <span class="math inline">\(0 \leq \lambda_1 \leq 1\)</span> and <span class="math inline">\(0 \leq \lambda_2 \leq 1\)</span>.</p>
<ol style="list-style-type: decimal">
<li><p>Modify your data-generating function from Exercise <a href="data-generating-processes.html#meta-regression-DGP">6.9.14</a> to follow the Vevea-Hedges selection model. Ensure that the new data-generating function returns a total of <span class="math inline">\(K\)</span> primary study results.</p></li>
<li><p>Use the new function to generate a large number of effect size estimates, all with <span class="math inline">\(s_i = 0.35\)</span>, using parameters <span class="math inline">\(\beta_0 = 0.1\)</span>, <span class="math inline">\(\beta_1 = 0.0\)</span>, <span class="math inline">\(\tau = 0.1\)</span>, <span class="math inline">\(\lambda_1 = 0.5\)</span>, and <span class="math inline">\(\lambda_2 = 0.2\)</span>. Plot the distribution of observed effect size estimates.</p></li>
<li><p>Create several further plots using different values for <span class="math inline">\(\lambda_1\)</span> and <span class="math inline">\(\lambda_2\)</span>. How do these parameters affect the shape of the distribution?</p></li>
<li><p>Use the <code>selmodel()</code> function from the <code>metafor</code> package to estimate the Vevea-Hedges selection model based on one of your simulated datasets. (See Exercise <a href="data-analysis-procedures.html#Vevea-Hedges-estimation">7.5.7</a> for example syntax.) How do the estimates compare to the model parameters you’ve specified?</p></li>
</ol>

</div>
</div>
</div>
<h3>References</h3>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-Bloom:2016um" class="csl-entry">
Bloom, Howard S., Stephen W. Raudenbush, Michael J. Weiss, and Kristin Porter. 2016. <span>“<span class="nocase">Using Multisite Experiments to Study Cross-Site Variation in Treatment Effects: A Hybrid Approach With Fixed Intercepts and a Random Treatment Coefficient</span>.”</span> <em>Journal of Research on Educational Effectiveness</em> 10 (4): 0–0. <a href="https://doi.org/10.1080/19345747.2016.1264518">https://doi.org/10.1080/19345747.2016.1264518</a>.
</div>
<div id="ref-Cho2023bivariate" class="csl-entry">
Cho, Hunyong, Chuwen Liu, John S Preisser, and Di Wu. 2023. <span>“A Bivariate Zero-Inflated Negative Binomial Model and Its Applications to Biomedical Settings.”</span> <em>Statistical Methods in Medical Research</em> 32 (7): 1300–1317. <a href="https://doi.org/10.1177/09622802231172028">https://doi.org/10.1177/09622802231172028</a>.
</div>
<div id="ref-miratrix2021applied" class="csl-entry">
Miratrix, Luke W., Michael J. Weiss, and Brit Henderson. 2021. <span>“An <span>Applied Researcher</span>’s <span>Guide</span> to <span>Estimating Effects</span> from <span>Multisite Individually Randomized Trials</span>: <span>Estimands</span>, <span>Estimators</span>, and <span>Estimates</span>.”</span> <em>Journal of Research on Educational Effectiveness</em> 14 (1): 270–308. <a href="https://doi.org/10.1080/19345747.2020.1831115">https://doi.org/10.1080/19345747.2020.1831115</a>.
</div>
<div id="ref-vevea1995general" class="csl-entry">
Vevea, Jack L, and Larry V Hedges. 1995. <span>“A General Linear Model for Estimating Effect Size in the Presence of Publication Bias.”</span> <em>Psychometrika</em> 60 (3): 419–35. <a href="https://doi.org/10.1007/BF02294384">https://doi.org/10.1007/BF02294384</a>.
</div>
</div>
<div class="footnotes">
<hr />
<ol start="11">
<li id="fn11"><p>An alternative definition is based on the pooled standard deviation, but this is usually a bad choice if one suspects treatment variation. More treatment variation should not reduce the effect size for the same absolute average impact.<a href="data-generating-processes.html#fnref11" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="case-ANOVA.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="data-analysis-procedures.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": {
    "github": false,
    "facebook": true,
    "twitter": true,
    "linkedin": false,
    "weibo": false,
    "instapaper": false,
    "vk": false,
    "whatsapp": false,
    "all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
  },
  "fontsettings": {
    "theme": "white",
    "family": "sans",
    "size": 2
  },
  "edit": {
    "link": "https://github.com/jepusto/Designing-Simulations-in-R/edit/master/020-Data-generating-models.Rmd",
    "text": "Edit"
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": null,
    "text": null
  },
  "download": ["Designing-Simulations-in-R.pdf", "Designing-Simulations-in-R.epub"],
  "search": {
    "engine": "lunr",
    "options": null
  },
  "toc": {
    "collapse": "section",
    "scroll_highlight": true
  },
  "toolbar": {
    "position": "fixed"
  },
  "info": true
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
