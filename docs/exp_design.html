<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 9 Designing the multifactor simulation experiment | Designing Monte Carlo Simulations in R</title>
  <meta name="description" content="A text on designing, implementing, and reporting on Monte Carlo simulation studies" />
  <meta name="generator" content="bookdown 0.27 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 9 Designing the multifactor simulation experiment | Designing Monte Carlo Simulations in R" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="A text on designing, implementing, and reporting on Monte Carlo simulation studies" />
  <meta name="github-repo" content="jepusto/Designing-Simulations-in-R" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 9 Designing the multifactor simulation experiment | Designing Monte Carlo Simulations in R" />
  
  <meta name="twitter:description" content="A text on designing, implementing, and reporting on Monte Carlo simulation studies" />
  

<meta name="author" content="Luke W. Miratrix and James E. Pustejovsky (Equal authors)" />


<meta name="date" content="2022-07-21" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="case_Cronbach.html"/>
<link rel="next" href="case-study-comparing-different-estimators.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Designing Simulations in R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#license"><i class="fa fa-check"></i>License</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#about-the-authors"><i class="fa fa-check"></i>About the authors</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#acknowledgements"><i class="fa fa-check"></i>Acknowledgements</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="introduction.html"><a href="introduction.html#some-of-simulations-many-uses"><i class="fa fa-check"></i><b>1.1</b> Some of simulation’s many uses</a>
<ul>
<li class="chapter" data-level="1.1.1" data-path="introduction.html"><a href="introduction.html#comparing-statistical-approaches"><i class="fa fa-check"></i><b>1.1.1</b> Comparing statistical approaches</a></li>
<li class="chapter" data-level="1.1.2" data-path="introduction.html"><a href="introduction.html#assessing-performance-of-complex-pipelines"><i class="fa fa-check"></i><b>1.1.2</b> Assessing performance of complex pipelines</a></li>
<li class="chapter" data-level="1.1.3" data-path="introduction.html"><a href="introduction.html#assessing-performance-under-misspecification"><i class="fa fa-check"></i><b>1.1.3</b> Assessing performance under misspecification</a></li>
<li class="chapter" data-level="1.1.4" data-path="introduction.html"><a href="introduction.html#assessing-the-finite-sample-performance-of-a-statistical-approach"><i class="fa fa-check"></i><b>1.1.4</b> Assessing the finite sample performance of a statistical approach</a></li>
<li class="chapter" data-level="1.1.5" data-path="introduction.html"><a href="introduction.html#conducting-power-analyses"><i class="fa fa-check"></i><b>1.1.5</b> Conducting Power Analyses</a></li>
<li class="chapter" data-level="1.1.6" data-path="introduction.html"><a href="introduction.html#simulating-processess"><i class="fa fa-check"></i><b>1.1.6</b> Simulating processess</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="introduction.html"><a href="introduction.html#the-perils-of-simulation-as-evidence"><i class="fa fa-check"></i><b>1.2</b> The perils of simulation as evidence</a></li>
<li class="chapter" data-level="1.3" data-path="introduction.html"><a href="introduction.html#why-r-and-rstudio"><i class="fa fa-check"></i><b>1.3</b> Why R and RStudio?</a>
<ul>
<li class="chapter" data-level="1.3.1" data-path="introduction.html"><a href="introduction.html#templates-vs.-patterns"><i class="fa fa-check"></i><b>1.3.1</b> Templates vs. Patterns</a></li>
<li class="chapter" data-level="1.3.2" data-path="introduction.html"><a href="introduction.html#the-tidyverse-and-a-recommended-text"><i class="fa fa-check"></i><b>1.3.2</b> The tidyverse and a recommended text</a></li>
<li class="chapter" data-level="1.3.3" data-path="introduction.html"><a href="introduction.html#functions"><i class="fa fa-check"></i><b>1.3.3</b> Functions</a></li>
<li class="chapter" data-level="1.3.4" data-path="introduction.html"><a href="introduction.html#a-dangerous-function"><i class="fa fa-check"></i><b>1.3.4</b> A dangerous function</a></li>
<li class="chapter" data-level="1.3.5" data-path="introduction.html"><a href="introduction.html#function-skeletons"><i class="fa fa-check"></i><b>1.3.5</b> Function skeletons</a></li>
<li class="chapter" data-level="1.3.6" data-path="introduction.html"><a href="introduction.html#pipe-dreams"><i class="fa fa-check"></i><b>1.3.6</b> <code>%&gt;%</code> (Pipe) dreams</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="an-initial-simulation.html"><a href="an-initial-simulation.html"><i class="fa fa-check"></i><b>2</b> An initial simulation</a>
<ul>
<li class="chapter" data-level="2.1" data-path="an-initial-simulation.html"><a href="an-initial-simulation.html#simulation-for-a-single-scenario"><i class="fa fa-check"></i><b>2.1</b> Simulation for a single scenario</a></li>
<li class="chapter" data-level="2.2" data-path="an-initial-simulation.html"><a href="an-initial-simulation.html#simulating-across-different-scenarios"><i class="fa fa-check"></i><b>2.2</b> Simulating across different scenarios</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html"><i class="fa fa-check"></i><b>3</b> Structure of a simulation study</a>
<ul>
<li class="chapter" data-level="3.1" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#general-structure-of-a-simulation"><i class="fa fa-check"></i><b>3.1</b> General structure of a simulation</a></li>
<li class="chapter" data-level="3.2" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#tidy-simulations"><i class="fa fa-check"></i><b>3.2</b> Tidy simulations</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#the-data-generating-process-dgp"><i class="fa fa-check"></i><b>3.2.1</b> The Data Generating Process (DGP)</a></li>
<li class="chapter" data-level="3.2.2" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#estimation-methods"><i class="fa fa-check"></i><b>3.2.2</b> Estimation methods</a></li>
<li class="chapter" data-level="3.2.3" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#repetition"><i class="fa fa-check"></i><b>3.2.3</b> Repetition</a></li>
<li class="chapter" data-level="3.2.4" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#performance-summaries"><i class="fa fa-check"></i><b>3.2.4</b> Performance summaries</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#multiple-scenarios"><i class="fa fa-check"></i><b>3.3</b> Multiple Scenarios</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="case_ANOVA.html"><a href="case_ANOVA.html"><i class="fa fa-check"></i><b>4</b> Case Study: Heteroskedastic ANOVA</a>
<ul>
<li class="chapter" data-level="4.1" data-path="case_ANOVA.html"><a href="case_ANOVA.html#the-data-generating-model"><i class="fa fa-check"></i><b>4.1</b> The data-generating model</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="case_ANOVA.html"><a href="case_ANOVA.html#coding-remark"><i class="fa fa-check"></i><b>4.1.1</b> Coding remark</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="case_ANOVA.html"><a href="case_ANOVA.html#the-estimation-procedures"><i class="fa fa-check"></i><b>4.2</b> The estimation procedures</a></li>
<li class="chapter" data-level="4.3" data-path="case_ANOVA.html"><a href="case_ANOVA.html#replication"><i class="fa fa-check"></i><b>4.3</b> Replication</a></li>
<li class="chapter" data-level="4.4" data-path="case_ANOVA.html"><a href="case_ANOVA.html#calculating-rejection-rates"><i class="fa fa-check"></i><b>4.4</b> Calculating rejection rates</a></li>
<li class="chapter" data-level="4.5" data-path="case_ANOVA.html"><a href="case_ANOVA.html#exAnovaExercises"><i class="fa fa-check"></i><b>4.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="chap_DGP.html"><a href="chap_DGP.html"><i class="fa fa-check"></i><b>5</b> Data-generating models</a>
<ul>
<li class="chapter" data-level="5.1" data-path="chap_DGP.html"><a href="chap_DGP.html#a-statistical-model-is-a-recipe-for-data-generation"><i class="fa fa-check"></i><b>5.1</b> A statistical model is a recipe for data generation</a></li>
<li class="chapter" data-level="5.2" data-path="chap_DGP.html"><a href="chap_DGP.html#checking-the-data-generating-function"><i class="fa fa-check"></i><b>5.2</b> Checking the data-generating function</a></li>
<li class="chapter" data-level="5.3" data-path="chap_DGP.html"><a href="chap_DGP.html#case_cluster"><i class="fa fa-check"></i><b>5.3</b> Simulating clustered data</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="chap_DGP.html"><a href="chap_DGP.html#a-design-decision-what-do-we-want-to-manipulate"><i class="fa fa-check"></i><b>5.3.1</b> A design decision: What do we want to manipulate?</a></li>
<li class="chapter" data-level="5.3.2" data-path="chap_DGP.html"><a href="chap_DGP.html#a-model-for-a-cluster-rct"><i class="fa fa-check"></i><b>5.3.2</b> A model for a cluster RCT</a></li>
<li class="chapter" data-level="5.3.3" data-path="chap_DGP.html"><a href="chap_DGP.html#converting-our-model-to-code"><i class="fa fa-check"></i><b>5.3.3</b> Converting our model to code</a></li>
<li class="chapter" data-level="5.3.4" data-path="chap_DGP.html"><a href="chap_DGP.html#standardization-in-a-data-generating-process"><i class="fa fa-check"></i><b>5.3.4</b> Standardization in a data generating process</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="chap_DGP.html"><a href="chap_DGP.html#exercises"><i class="fa fa-check"></i><b>5.4</b> Exercises</a>
<ul>
<li class="chapter" data-level="5.4.1" data-path="chap_DGP.html"><a href="chap_DGP.html#ex_dgp"><i class="fa fa-check"></i><b>5.4.1</b> The Shifted-and-scaled t distribution</a></li>
<li class="chapter" data-level="5.4.2" data-path="chap_DGP.html"><a href="chap_DGP.html#the-cluster-rct-dgp"><i class="fa fa-check"></i><b>5.4.2</b> The Cluster RCT DGP</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="estimation-procedures.html"><a href="estimation-procedures.html"><i class="fa fa-check"></i><b>6</b> Estimation procedures</a>
<ul>
<li class="chapter" data-level="6.1" data-path="estimation-procedures.html"><a href="estimation-procedures.html#checking-the-estimation-function"><i class="fa fa-check"></i><b>6.1</b> Checking the estimation function</a></li>
<li class="chapter" data-level="6.2" data-path="estimation-procedures.html"><a href="estimation-procedures.html#checking-via-simulation"><i class="fa fa-check"></i><b>6.2</b> Checking via simulation</a></li>
<li class="chapter" data-level="6.3" data-path="estimation-procedures.html"><a href="estimation-procedures.html#multiple-estimation-procedures"><i class="fa fa-check"></i><b>6.3</b> Multiple estimation procedures</a></li>
<li class="chapter" data-level="6.4" data-path="estimation-procedures.html"><a href="estimation-procedures.html#exercises-1"><i class="fa fa-check"></i><b>6.4</b> Exercises</a></li>
<li class="chapter" data-level="6.5" data-path="estimation-procedures.html"><a href="estimation-procedures.html#more-welch-and-adding-the-bff-test"><i class="fa fa-check"></i><b>6.5</b> More Welch and adding the BFF test</a></li>
<li class="chapter" data-level="6.6" data-path="estimation-procedures.html"><a href="estimation-procedures.html#more-estimators-for-the-crt"><i class="fa fa-check"></i><b>6.6</b> More estimators for the CRT</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="performance-criteria.html"><a href="performance-criteria.html"><i class="fa fa-check"></i><b>7</b> Performance criteria</a>
<ul>
<li class="chapter" data-level="7.1" data-path="performance-criteria.html"><a href="performance-criteria.html#inference-vs.-estimation"><i class="fa fa-check"></i><b>7.1</b> Inference vs. Estimation</a></li>
<li class="chapter" data-level="7.2" data-path="performance-criteria.html"><a href="performance-criteria.html#comparing-estimators"><i class="fa fa-check"></i><b>7.2</b> Comparing estimators</a></li>
<li class="chapter" data-level="7.3" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-a-point-estimator"><i class="fa fa-check"></i><b>7.3</b> Assessing a point estimator</a>
<ul>
<li class="chapter" data-level="7.3.1" data-path="performance-criteria.html"><a href="performance-criteria.html#example-on-our-cluster-rct"><i class="fa fa-check"></i><b>7.3.1</b> Example on our Cluster RCT</a></li>
</ul></li>
<li class="chapter" data-level="7.4" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-a-standard-error-estimator"><i class="fa fa-check"></i><b>7.4</b> Assessing a standard error estimator</a>
<ul>
<li class="chapter" data-level="7.4.1" data-path="performance-criteria.html"><a href="performance-criteria.html#why-not-assess-the-estimate-se-directly"><i class="fa fa-check"></i><b>7.4.1</b> Why not assess the estimate SE directly?</a></li>
<li class="chapter" data-level="7.4.2" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-ses-for-our-cluster-rct-simulation"><i class="fa fa-check"></i><b>7.4.2</b> Assessing SEs for our Cluster RCT simulation</a></li>
</ul></li>
<li class="chapter" data-level="7.5" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-an-inferential-procedure"><i class="fa fa-check"></i><b>7.5</b> Assessing an inferential procedure</a>
<ul>
<li class="chapter" data-level="7.5.1" data-path="performance-criteria.html"><a href="performance-criteria.html#validity"><i class="fa fa-check"></i><b>7.5.1</b> Validity</a></li>
<li class="chapter" data-level="7.5.2" data-path="performance-criteria.html"><a href="performance-criteria.html#power"><i class="fa fa-check"></i><b>7.5.2</b> Power</a></li>
<li class="chapter" data-level="7.5.3" data-path="performance-criteria.html"><a href="performance-criteria.html#the-rejection-rate"><i class="fa fa-check"></i><b>7.5.3</b> The Rejection Rate</a></li>
<li class="chapter" data-level="7.5.4" data-path="performance-criteria.html"><a href="performance-criteria.html#our-cluster-rct-simulation"><i class="fa fa-check"></i><b>7.5.4</b> Our Cluster RCT Simulation</a></li>
</ul></li>
<li class="chapter" data-level="7.6" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-confidence-intervals"><i class="fa fa-check"></i><b>7.6</b> Assessing confidence intervals</a>
<ul>
<li class="chapter" data-level="7.6.1" data-path="performance-criteria.html"><a href="performance-criteria.html#clusters-with-confidence"><i class="fa fa-check"></i><b>7.6.1</b> Clusters with Confidence</a></li>
</ul></li>
<li class="chapter" data-level="7.7" data-path="performance-criteria.html"><a href="performance-criteria.html#further-measures-of-performance"><i class="fa fa-check"></i><b>7.7</b> Further measures of performance</a>
<ul>
<li class="chapter" data-level="7.7.1" data-path="performance-criteria.html"><a href="performance-criteria.html#sec_relative_performance"><i class="fa fa-check"></i><b>7.7.1</b> Relative vs. Absolute Criteria</a></li>
<li class="chapter" data-level="7.7.2" data-path="performance-criteria.html"><a href="performance-criteria.html#robust-measures-of-performance"><i class="fa fa-check"></i><b>7.7.2</b> Robust measures of performance</a></li>
<li class="chapter" data-level="7.7.3" data-path="performance-criteria.html"><a href="performance-criteria.html#summary-of-peformance-measures"><i class="fa fa-check"></i><b>7.7.3</b> Summary of peformance measures</a></li>
</ul></li>
<li class="chapter" data-level="7.8" data-path="performance-criteria.html"><a href="performance-criteria.html#uncertainty-in-our-performance-estimates-the-mcse"><i class="fa fa-check"></i><b>7.8</b> Uncertainty in our performance estimates (the MCSE)</a>
<ul>
<li class="chapter" data-level="7.8.1" data-path="performance-criteria.html"><a href="performance-criteria.html#mcse-for-variance-estimators"><i class="fa fa-check"></i><b>7.8.1</b> MCSE for variance estimators</a></li>
<li class="chapter" data-level="7.8.2" data-path="performance-criteria.html"><a href="performance-criteria.html#calculating-mcses-with-the-simhelpers-package"><i class="fa fa-check"></i><b>7.8.2</b> Calculating MCSEs with the simhelpers package</a></li>
<li class="chapter" data-level="7.8.3" data-path="performance-criteria.html"><a href="performance-criteria.html#cluster-rct-continued-do-we-have-enough-simulation-trials"><i class="fa fa-check"></i><b>7.8.3</b> Cluster RCT, continued: Do we have enough simulation trials?</a></li>
</ul></li>
<li class="chapter" data-level="7.9" data-path="performance-criteria.html"><a href="performance-criteria.html#exercises-2"><i class="fa fa-check"></i><b>7.9</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="case_Cronbach.html"><a href="case_Cronbach.html"><i class="fa fa-check"></i><b>8</b> Project: Cronbach Alpha</a>
<ul>
<li class="chapter" data-level="8.1" data-path="case_Cronbach.html"><a href="case_Cronbach.html#background"><i class="fa fa-check"></i><b>8.1</b> Background</a></li>
<li class="chapter" data-level="8.2" data-path="case_Cronbach.html"><a href="case_Cronbach.html#getting-started"><i class="fa fa-check"></i><b>8.2</b> Getting started</a></li>
<li class="chapter" data-level="8.3" data-path="case_Cronbach.html"><a href="case_Cronbach.html#the-data-generating-function"><i class="fa fa-check"></i><b>8.3</b> The data-generating function</a></li>
<li class="chapter" data-level="8.4" data-path="case_Cronbach.html"><a href="case_Cronbach.html#the-estimation-function"><i class="fa fa-check"></i><b>8.4</b> The estimation function</a>
<ul>
<li class="chapter" data-level="8.4.1" data-path="case_Cronbach.html"><a href="case_Cronbach.html#exercices-naive-confidence-intervals"><i class="fa fa-check"></i><b>8.4.1</b> Exercices (Naive confidence intervals)</a></li>
</ul></li>
<li class="chapter" data-level="8.5" data-path="case_Cronbach.html"><a href="case_Cronbach.html#estimator-performance"><i class="fa fa-check"></i><b>8.5</b> Estimator Performance</a>
<ul>
<li class="chapter" data-level="8.5.1" data-path="case_Cronbach.html"><a href="case_Cronbach.html#exercises-calculating-performance"><i class="fa fa-check"></i><b>8.5.1</b> Exercises (Calculating Performance)</a></li>
</ul></li>
<li class="chapter" data-level="8.6" data-path="case_Cronbach.html"><a href="case_Cronbach.html#replicate-and-the-simulation"><i class="fa fa-check"></i><b>8.6</b> Replicate (and the simulation)</a></li>
<li class="chapter" data-level="8.7" data-path="case_Cronbach.html"><a href="case_Cronbach.html#extension-confidence-interval-coverage"><i class="fa fa-check"></i><b>8.7</b> Extension: Confidence interval coverage</a></li>
<li class="chapter" data-level="8.8" data-path="case_Cronbach.html"><a href="case_Cronbach.html#a-taste-of-multiple-scenarios"><i class="fa fa-check"></i><b>8.8</b> A taste of multiple scenarios</a>
<ul>
<li class="chapter" data-level="8.8.1" data-path="case_Cronbach.html"><a href="case_Cronbach.html#exercises-3"><i class="fa fa-check"></i><b>8.8.1</b> Exercises</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="exp_design.html"><a href="exp_design.html"><i class="fa fa-check"></i><b>9</b> Designing the multifactor simulation experiment</a>
<ul>
<li class="chapter" data-level="9.1" data-path="exp_design.html"><a href="exp_design.html#choosing-parameter-combinations"><i class="fa fa-check"></i><b>9.1</b> Choosing parameter combinations</a></li>
<li class="chapter" data-level="9.2" data-path="exp_design.html"><a href="exp_design.html#example-the-clustered-rct"><i class="fa fa-check"></i><b>9.2</b> Example: The Clustered RCT</a></li>
<li class="chapter" data-level="9.3" data-path="exp_design.html"><a href="exp_design.html#using-pmap-to-run-multifactor-simulations"><i class="fa fa-check"></i><b>9.3</b> Using pmap to run multifactor simulations</a></li>
<li class="chapter" data-level="9.4" data-path="exp_design.html"><a href="exp_design.html#how-to-repeat-oneself"><i class="fa fa-check"></i><b>9.4</b> How to repeat oneself</a>
<ul>
<li class="chapter" data-level="9.4.1" data-path="exp_design.html"><a href="exp_design.html#getting-raw-results-ready-for-analysis"><i class="fa fa-check"></i><b>9.4.1</b> Getting raw results ready for analysis</a></li>
</ul></li>
<li class="chapter" data-level="9.5" data-path="exp_design.html"><a href="exp_design.html#running-the-cluster-rct-multifactor-experiment"><i class="fa fa-check"></i><b>9.5</b> Running the Cluster RCT Multifactor experiment</a>
<ul>
<li class="chapter" data-level="9.5.1" data-path="exp_design.html"><a href="exp_design.html#making-analyze_data-quiet"><i class="fa fa-check"></i><b>9.5.1</b> Making analyze_data() quiet</a></li>
</ul></li>
<li class="chapter" data-level="9.6" data-path="exp_design.html"><a href="exp_design.html#analyzing-a-multifactor-experiment"><i class="fa fa-check"></i><b>9.6</b> Analyzing a multifactor experiment</a>
<ul>
<li class="chapter" data-level="9.6.1" data-path="exp_design.html"><a href="exp_design.html#bundling"><i class="fa fa-check"></i><b>9.6.1</b> Bundling</a></li>
<li class="chapter" data-level="9.6.2" data-path="exp_design.html"><a href="exp_design.html#aggregation"><i class="fa fa-check"></i><b>9.6.2</b> Aggregation</a></li>
<li class="chapter" data-level="9.6.3" data-path="exp_design.html"><a href="exp_design.html#regression-summarization"><i class="fa fa-check"></i><b>9.6.3</b> Regression Summarization</a></li>
<li class="chapter" data-level="9.6.4" data-path="exp_design.html"><a href="exp_design.html#focus-on-subset-kick-rest-to-supplement"><i class="fa fa-check"></i><b>9.6.4</b> Focus on subset, kick rest to supplement</a></li>
</ul></li>
<li class="chapter" data-level="9.7" data-path="exp_design.html"><a href="exp_design.html#analyzing-results-when-some-trials-have-failed"><i class="fa fa-check"></i><b>9.7</b> Analyzing results when some trials have failed</a></li>
<li class="chapter" data-level="9.8" data-path="exp_design.html"><a href="exp_design.html#exercises-4"><i class="fa fa-check"></i><b>9.8</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="case-study-comparing-different-estimators.html"><a href="case-study-comparing-different-estimators.html"><i class="fa fa-check"></i><b>10</b> Case study: Comparing different estimators</a>
<ul>
<li class="chapter" data-level="10.1" data-path="case-study-comparing-different-estimators.html"><a href="case-study-comparing-different-estimators.html#the-data-generating-process"><i class="fa fa-check"></i><b>10.1</b> The data generating process</a></li>
<li class="chapter" data-level="10.2" data-path="case-study-comparing-different-estimators.html"><a href="case-study-comparing-different-estimators.html#the-data-analysis-methods"><i class="fa fa-check"></i><b>10.2</b> The data analysis methods</a></li>
<li class="chapter" data-level="10.3" data-path="case-study-comparing-different-estimators.html"><a href="case-study-comparing-different-estimators.html#the-simulation-itself"><i class="fa fa-check"></i><b>10.3</b> The simulation itself</a></li>
<li class="chapter" data-level="10.4" data-path="case-study-comparing-different-estimators.html"><a href="case-study-comparing-different-estimators.html#calculating-performance-measures-for-all-our-estimators"><i class="fa fa-check"></i><b>10.4</b> Calculating performance measures for all our estimators</a></li>
<li class="chapter" data-level="10.5" data-path="case-study-comparing-different-estimators.html"><a href="case-study-comparing-different-estimators.html#improving-the-visualization-of-the-results"><i class="fa fa-check"></i><b>10.5</b> Improving the visualization of the results</a></li>
<li class="chapter" data-level="10.6" data-path="case-study-comparing-different-estimators.html"><a href="case-study-comparing-different-estimators.html#extension-the-bias-variance-tradeoff"><i class="fa fa-check"></i><b>10.6</b> Extension: The Bias-variance tradeoff</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="visualization-case-studies.html"><a href="visualization-case-studies.html"><i class="fa fa-check"></i><b>11</b> Visualization Case Studies</a></li>
<li class="chapter" data-level="12" data-path="presentation-of-simulation-results.html"><a href="presentation-of-simulation-results.html"><i class="fa fa-check"></i><b>12</b> Presentation of simulation results</a>
<ul>
<li class="chapter" data-level="12.1" data-path="presentation-of-simulation-results.html"><a href="presentation-of-simulation-results.html#tabulation"><i class="fa fa-check"></i><b>12.1</b> Tabulation</a></li>
<li class="chapter" data-level="12.2" data-path="presentation-of-simulation-results.html"><a href="presentation-of-simulation-results.html#visualization"><i class="fa fa-check"></i><b>12.2</b> Visualization</a>
<ul>
<li class="chapter" data-level="12.2.1" data-path="presentation-of-simulation-results.html"><a href="presentation-of-simulation-results.html#example-1-biserial-correlation-estimation"><i class="fa fa-check"></i><b>12.2.1</b> Example 1: Biserial correlation estimation</a></li>
<li class="chapter" data-level="12.2.2" data-path="presentation-of-simulation-results.html"><a href="presentation-of-simulation-results.html#example-2-variance-estimation-and-meta-regression"><i class="fa fa-check"></i><b>12.2.2</b> Example 2: Variance estimation and Meta-regression</a></li>
<li class="chapter" data-level="12.2.3" data-path="presentation-of-simulation-results.html"><a href="presentation-of-simulation-results.html#example-heat-maps-of-coverage"><i class="fa fa-check"></i><b>12.2.3</b> Example: Heat maps of coverage</a></li>
</ul></li>
<li class="chapter" data-level="12.3" data-path="presentation-of-simulation-results.html"><a href="presentation-of-simulation-results.html#modeling"><i class="fa fa-check"></i><b>12.3</b> Modeling</a></li>
<li class="chapter" data-level="12.4" data-path="presentation-of-simulation-results.html"><a href="presentation-of-simulation-results.html#presentation"><i class="fa fa-check"></i><b>12.4</b> Presentation</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="sec_reproducability.html"><a href="sec_reproducability.html"><i class="fa fa-check"></i><b>13</b> Ensuring reproducibility</a>
<ul>
<li class="chapter" data-level="13.1" data-path="sec_reproducability.html"><a href="sec_reproducability.html#seeds-and-pseudo-random-number-generators"><i class="fa fa-check"></i><b>13.1</b> Seeds and pseudo-random number generators</a></li>
<li class="chapter" data-level="13.2" data-path="sec_reproducability.html"><a href="sec_reproducability.html#including-seed-in-our-simulation-driver"><i class="fa fa-check"></i><b>13.2</b> Including seed in our simulation driver</a></li>
<li class="chapter" data-level="13.3" data-path="sec_reproducability.html"><a href="sec_reproducability.html#reasons-for-setting-the-seed"><i class="fa fa-check"></i><b>13.3</b> Reasons for setting the seed</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="optimize_code.html"><a href="optimize_code.html"><i class="fa fa-check"></i><b>14</b> Optimizing code (and why you often shouldn’t)</a>
<ul>
<li class="chapter" data-level="14.1" data-path="optimize_code.html"><a href="optimize_code.html#hand-building-functions"><i class="fa fa-check"></i><b>14.1</b> Hand-building functions</a></li>
<li class="chapter" data-level="14.2" data-path="optimize_code.html"><a href="optimize_code.html#sec_comp_efficiency"><i class="fa fa-check"></i><b>14.2</b> Computational efficiency versus simplicity</a></li>
<li class="chapter" data-level="14.3" data-path="optimize_code.html"><a href="optimize_code.html#reusing-code-to-speed-up-computation"><i class="fa fa-check"></i><b>14.3</b> Reusing code to speed up computation</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="error-trapping-and-other-headaches.html"><a href="error-trapping-and-other-headaches.html"><i class="fa fa-check"></i><b>15</b> Error trapping and other headaches</a>
<ul>
<li class="chapter" data-level="15.1" data-path="error-trapping-and-other-headaches.html"><a href="error-trapping-and-other-headaches.html#safe_code"><i class="fa fa-check"></i><b>15.1</b> Safe code</a>
<ul>
<li class="chapter" data-level="15.1.1" data-path="error-trapping-and-other-headaches.html"><a href="error-trapping-and-other-headaches.html#what-to-do-with-warnings"><i class="fa fa-check"></i><b>15.1.1</b> What to do with warnings</a></li>
</ul></li>
<li class="chapter" data-level="15.2" data-path="error-trapping-and-other-headaches.html"><a href="error-trapping-and-other-headaches.html#saving_files"><i class="fa fa-check"></i><b>15.2</b> Saving files and results</a>
<ul>
<li class="chapter" data-level="15.2.1" data-path="error-trapping-and-other-headaches.html"><a href="error-trapping-and-other-headaches.html#saving-simulations-in-general"><i class="fa fa-check"></i><b>15.2.1</b> Saving simulations in general</a></li>
<li class="chapter" data-level="15.2.2" data-path="error-trapping-and-other-headaches.html"><a href="error-trapping-and-other-headaches.html#saving-simulations-as-you-go"><i class="fa fa-check"></i><b>15.2.2</b> Saving simulations as you go</a></li>
<li class="chapter" data-level="15.2.3" data-path="error-trapping-and-other-headaches.html"><a href="error-trapping-and-other-headaches.html#dynamically-making-directories"><i class="fa fa-check"></i><b>15.2.3</b> Dynamically making directories</a></li>
<li class="chapter" data-level="15.2.4" data-path="error-trapping-and-other-headaches.html"><a href="error-trapping-and-other-headaches.html#loading-and-combining-files-of-simulation-results"><i class="fa fa-check"></i><b>15.2.4</b> Loading and combining files of simulation results</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="16" data-path="on_functions.html"><a href="on_functions.html"><i class="fa fa-check"></i><b>16</b> Coding tidbits</a>
<ul>
<li class="chapter" data-level="16.1" data-path="on_functions.html"><a href="on_functions.html#repeating_oneself"><i class="fa fa-check"></i><b>16.1</b> Ways of repeating yourself</a></li>
<li class="chapter" data-level="16.2" data-path="on_functions.html"><a href="on_functions.html#default_arguments"><i class="fa fa-check"></i><b>16.2</b> Default arguments for functions</a></li>
<li class="chapter" data-level="16.3" data-path="on_functions.html"><a href="on_functions.html#testing-and-debugging-code-in-your-scripts"><i class="fa fa-check"></i><b>16.3</b> Testing and debugging code in your scripts</a></li>
<li class="chapter" data-level="16.4" data-path="on_functions.html"><a href="on_functions.html#keeping-things-organized-and-the-source-command"><i class="fa fa-check"></i><b>16.4</b> Keeping things organized and the source command</a></li>
<li class="chapter" data-level="16.5" data-path="on_functions.html"><a href="on_functions.html#debugging-with-browser"><i class="fa fa-check"></i><b>16.5</b> Debugging with browser</a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="parallel-processing.html"><a href="parallel-processing.html"><i class="fa fa-check"></i><b>17</b> Parallel Processing</a>
<ul>
<li class="chapter" data-level="17.1" data-path="parallel-processing.html"><a href="parallel-processing.html#parallel-on-your-computer"><i class="fa fa-check"></i><b>17.1</b> Parallel on your computer</a></li>
<li class="chapter" data-level="17.2" data-path="parallel-processing.html"><a href="parallel-processing.html#parallel-off-your-computer"><i class="fa fa-check"></i><b>17.2</b> Parallel off your computer</a>
<ul>
<li class="chapter" data-level="17.2.1" data-path="parallel-processing.html"><a href="parallel-processing.html#what-is-a-command-line-interface"><i class="fa fa-check"></i><b>17.2.1</b> What is a command-line interface?</a></li>
<li class="chapter" data-level="17.2.2" data-path="parallel-processing.html"><a href="parallel-processing.html#running-a-job-on-a-cluster"><i class="fa fa-check"></i><b>17.2.2</b> Running a job on a cluster</a></li>
<li class="chapter" data-level="17.2.3" data-path="parallel-processing.html"><a href="parallel-processing.html#checking-on-a-job"><i class="fa fa-check"></i><b>17.2.3</b> Checking on a job</a></li>
<li class="chapter" data-level="17.2.4" data-path="parallel-processing.html"><a href="parallel-processing.html#running-lots-of-jobs-on-a-cluster"><i class="fa fa-check"></i><b>17.2.4</b> Running lots of jobs on a cluster</a></li>
<li class="chapter" data-level="17.2.5" data-path="parallel-processing.html"><a href="parallel-processing.html#resources-for-harvards-odyssey"><i class="fa fa-check"></i><b>17.2.5</b> Resources for Harvard’s Odyssey</a></li>
<li class="chapter" data-level="17.2.6" data-path="parallel-processing.html"><a href="parallel-processing.html#acknowledgements-1"><i class="fa fa-check"></i><b>17.2.6</b> Acknowledgements</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="18" data-path="case-study-the-power-and-validity-of-neymans-ate-estimate.html"><a href="case-study-the-power-and-validity-of-neymans-ate-estimate.html"><i class="fa fa-check"></i><b>18</b> Case study: The Power and Validity of Neyman’s ATE Estimate</a>
<ul>
<li class="chapter" data-level="18.1" data-path="case-study-the-power-and-validity-of-neymans-ate-estimate.html"><a href="case-study-the-power-and-validity-of-neymans-ate-estimate.html#step-1-write-a-function-for-a-specific-simulation-given-specific-parameters."><i class="fa fa-check"></i><b>18.1</b> Step 1: Write a function for a specific simulation given specific parameters.</a>
<ul>
<li class="chapter" data-level="18.1.1" data-path="case-study-the-power-and-validity-of-neymans-ate-estimate.html"><a href="case-study-the-power-and-validity-of-neymans-ate-estimate.html#running-our-single-trial-more-than-once"><i class="fa fa-check"></i><b>18.1.1</b> Running our single trial more than once</a></li>
</ul></li>
<li class="chapter" data-level="18.2" data-path="case-study-the-power-and-validity-of-neymans-ate-estimate.html"><a href="case-study-the-power-and-validity-of-neymans-ate-estimate.html#step-2-make-a-dataframe-of-all-experimental-combinations-desired"><i class="fa fa-check"></i><b>18.2</b> Step 2: Make a dataframe of all experimental combinations desired</a></li>
<li class="chapter" data-level="18.3" data-path="case-study-the-power-and-validity-of-neymans-ate-estimate.html"><a href="case-study-the-power-and-validity-of-neymans-ate-estimate.html#step-3-explore-results"><i class="fa fa-check"></i><b>18.3</b> Step 3: Explore results</a>
<ul>
<li class="chapter" data-level="18.3.1" data-path="case-study-the-power-and-validity-of-neymans-ate-estimate.html"><a href="case-study-the-power-and-validity-of-neymans-ate-estimate.html#visualizing-experimental-results"><i class="fa fa-check"></i><b>18.3.1</b> Visualizing experimental results</a></li>
<li class="chapter" data-level="18.3.2" data-path="case-study-the-power-and-validity-of-neymans-ate-estimate.html"><a href="case-study-the-power-and-validity-of-neymans-ate-estimate.html#looking-at-main-effects"><i class="fa fa-check"></i><b>18.3.2</b> Looking at main effects</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="19" data-path="simulation-under-the-potential-outcomes-framework.html"><a href="simulation-under-the-potential-outcomes-framework.html"><i class="fa fa-check"></i><b>19</b> Simulation under the Potential Outcomes Framework</a>
<ul>
<li class="chapter" data-level="19.1" data-path="simulation-under-the-potential-outcomes-framework.html"><a href="simulation-under-the-potential-outcomes-framework.html#finite-vs.-superpopulation-inference"><i class="fa fa-check"></i><b>19.1</b> Finite vs. Superpopulation inference</a></li>
<li class="chapter" data-level="19.2" data-path="simulation-under-the-potential-outcomes-framework.html"><a href="simulation-under-the-potential-outcomes-framework.html#data-generation-processes-for-potential-outcomes"><i class="fa fa-check"></i><b>19.2</b> Data generation processes for potential outcomes</a></li>
<li class="chapter" data-level="19.3" data-path="simulation-under-the-potential-outcomes-framework.html"><a href="simulation-under-the-potential-outcomes-framework.html#finite-sample-performance-measures"><i class="fa fa-check"></i><b>19.3</b> Finite sample performance measures</a></li>
<li class="chapter" data-level="19.4" data-path="simulation-under-the-potential-outcomes-framework.html"><a href="simulation-under-the-potential-outcomes-framework.html#nested-finite-simulation-procedure"><i class="fa fa-check"></i><b>19.4</b> Nested finite simulation procedure</a></li>
</ul></li>
<li class="chapter" data-level="20" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html"><i class="fa fa-check"></i><b>20</b> Simulations as evidence</a>
<ul>
<li class="chapter" data-level="20.1" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#use-extensive-multi-factor-simulations"><i class="fa fa-check"></i><b>20.1</b> Use extensive multi-factor simulations</a></li>
<li class="chapter" data-level="20.2" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#beat-them-at-their-own-game"><i class="fa fa-check"></i><b>20.2</b> Beat them at their own game</a></li>
<li class="chapter" data-level="20.3" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#calibrated-simulations"><i class="fa fa-check"></i><b>20.3</b> Calibrated simulations</a></li>
</ul></li>
<li class="chapter" data-level="21" data-path="the-parametric-bootstrap.html"><a href="the-parametric-bootstrap.html"><i class="fa fa-check"></i><b>21</b> The Parametric bootstrap</a>
<ul>
<li class="chapter" data-level="21.1" data-path="the-parametric-bootstrap.html"><a href="the-parametric-bootstrap.html#air-conditioners-a-stolen-case-study"><i class="fa fa-check"></i><b>21.1</b> Air conditioners: a stolen case study</a></li>
</ul></li>
<li class="chapter" data-level="22" data-path="further-readings-and-resources.html"><a href="further-readings-and-resources.html"><i class="fa fa-check"></i><b>22</b> Further readings and resources</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Designing Monte Carlo Simulations in R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="exp_design" class="section level1 hasAnchor" number="9">
<h1><span class="header-section-number">Chapter 9</span> Designing the multifactor simulation experiment<a href="exp_design.html#exp_design" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>So far, we’ve created code that will give us results for a single combination of parameter values.
In practice, simulation studies typically examine a range of different values, including varying the level of the true parameter values and perhaps also varying sample sizes, to explore a range of different scenarios.
We either want reassurance that our findings are general, or we want to understand what aspects of the context lead to our found results.
A single simulation gives us no hint as to either of these questions.
It is only by looking across a range of settings that we can fully understand trade-offs, general rules, and limits.
Let’s now look at the remaining piece of the simulation puzzle: the study’s experimental design.</p>
<p>Simulation studies often take the form of <strong>full factorial</strong> designed experiments. In full factorials, each factor (a particular knob a researcher might turn to change the simulation conditions) is varied across multiple levels, and the design includes <em>every</em> possible combination of the levels of every factor. One way to represent such a design is as a list of factors and levels.</p>
<p>For example, for the Cronbach alpha simulation, we might want to vary:</p>
<ul>
<li>the sample size, with values of 50 or 100; and</li>
<li>the number of items, with values of 4 or 8.</li>
<li>the true value of alpha, with values ranging from 0.1 to 0.9;</li>
<li>the degrees of freedom of the multivariate <span class="math inline">\(t\)</span> distribution, with values of 5, 10, 20, or 100;</li>
</ul>
<p>We first express the simulation parameters as a list of factors, each factor having a list of values to explore.
We will then run a simulation for every possible combination of these values.
We call this a <span class="math inline">\(2 \times 2 \times 9 \times 4\)</span> factorial design, where each element is the number of options for that factor.
Here is code that generates all the scenarios we will run given the above design, storing these combinations in a data frame, <code>params</code>, that represents the full experimental design:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="exp_design.html#cb1-1" aria-hidden="true" tabindex="-1"></a>design_factors <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb1-2"><a href="exp_design.html#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">100</span>),</span>
<span id="cb1-3"><a href="exp_design.html#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">p =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">8</span>),</span>
<span id="cb1-4"><a href="exp_design.html#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">alpha =</span> <span class="fu">seq</span>(<span class="fl">0.1</span>, <span class="fl">0.9</span>, <span class="fl">0.1</span>),</span>
<span id="cb1-5"><a href="exp_design.html#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">df =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">100</span>)</span>
<span id="cb1-6"><a href="exp_design.html#cb1-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-7"><a href="exp_design.html#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="exp_design.html#cb1-8" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">cross_df</span>(design_factors)</span>
<span id="cb1-9"><a href="exp_design.html#cb1-9" aria-hidden="true" tabindex="-1"></a>params</span></code></pre></div>
<pre><code>## # A tibble: 144 × 4
##        n     p alpha    df
##    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1    50     4   0.1     5
##  2   100     4   0.1     5
##  3    50     8   0.1     5
##  4   100     8   0.1     5
##  5    50     4   0.2     5
##  6   100     4   0.2     5
##  7    50     8   0.2     5
##  8   100     8   0.2     5
##  9    50     4   0.3     5
## 10   100     4   0.3     5
## # … with 134 more rows</code></pre>
<p>We have a total of <span class="math inline">\(2 \times 2 \times 9 \times 4 = 144\)</span> cells, each cell corresponding to a simulation scenario to explore.</p>
<div id="choosing-parameter-combinations" class="section level2 hasAnchor" number="9.1">
<h2><span class="header-section-number">9.1</span> Choosing parameter combinations<a href="exp_design.html#choosing-parameter-combinations" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>How do we go about choosing parameter values to examine?
Choosing which parameters to use is a central part of good simulation design because the primary limitation of simulation studies is always their <em>generalizability</em>.
On the one hand, it’s difficult to extrapolate findings from a simulation study beyond the set of simulation conditions that were examined. On the other hand, it’s often difficult or impossible to examine the full space of all possible parameter values, except for very simple problems. Even in the Cronbach alpha simulation, we’ve got four factors, and the last three could each take an infinite number of different levels, in theory. How can we come up with a defensible set of levels to examine?</p>
<p>The choice of simulation conditions needs to be made in the context of the problem or model that you’re studying, so it’s a bit difficult to offer valid, decontextualized advice.
We can provide a few observations all the same:</p>
<ol style="list-style-type: decimal">
<li><p>For research simulations, it often is important to be able to relate your findings to previous research. This suggests that you should select parameter levels to make this possible, such as by looking at sample sizes similar to those examined in previous studies. That said, previous simulation studies are not always perfect (actually, there’s a lot of really crummy ones out there!), and so prior work should not geneally be your sole guide or justification.</p></li>
<li><p>Generally, it is better to err on the side of being more comprehensive. You learn more by looking at a broader range of conditions, and you can always boil down your results to a more limited set of conditions for purposes of presentation.</p></li>
<li><p>It is also important to explore breakdown points (e.g., what sample size is too small for a method to work?) rather than focusing only on conditions where a method might be expected to work well. Pushing the boundaries and identifying conditions where estimation methods break will help you to provide better guidance for how the methods should be used in practice.</p></li>
</ol>
<p>An important point regarding (2) is that you can be more comprehensive and then have fewer replications per scenario.
For example, say you were planning on doing 1000 simulations per scenario, but then you realize there is some new factor that you don’t think matters, but that you believe other researchers will worry about.
You could add in that factor, say with four levels, and then do 250 simulations per scenario.
The total work remains the same.</p>
<p>When analyzing the final simulation you can then first verify you do not see trends along this new factor, and then marganalize out the factor in your summaries of results.
Marginalizing out a factor (i.e., averaging your performance metrics across the additional factor) is a powerful technique of making a claim about how your methods work <em>on average</em> across a <em>range</em> of scenarios, rather than for a specific scenario.</p>
<p>Overall, you generally want to vary parameters that you believe matter, or that you think other people will believe matter.
The first is so you can learn.
The second is to build your case.</p>
<p>Once you have identified your parameters you then have to decide on the levels of the parameter you will include in the simulation.
There are three strategies you might take:</p>
<ol style="list-style-type: decimal">
<li>Vary a parameter over its entire range (or nearly so).</li>
<li>Choose parameter levels to represent realistic practical range.
<ul>
<li>Empirical justification based on systematic reviews of applications</li>
<li>Or at least informal impressions of what’s realistic in practice</li>
</ul></li>
<li>Choose parameters to emulate one important application.</li>
</ol>
<p>In the above (1) is the most general—but also the most computationally intensive.
(2) will focus attention, ideally, on what is of practical relevance to a practitioner.
(3) is usually coupled with a subsequent applied data analysis, and in this case the simulation is often used to enrich that analysis.
For example, if the simulation shows the methods work for data with the given form of the target application, people may be more willing to believe the application’s findings.</p>
<p>Regardless of how you select your primary parameters, you should also vary nuisance parameters (at least a little) to test sensitivity of results.
While simulations will (generally) never be fully generalizable, you can certainly make them so they avoid the obvious things a critic might identify as an easy dismissal of your findings.</p>
<p>To recap, as you think about your parameter selection, always keep the following design principles and acknowledgements:</p>
<ul>
<li>The primary limitation of simulation studies is <strong>generalizability</strong>.</li>
<li>Choose conditions that allow you to relate findings to previous work.</li>
<li>Err towards being comprehensive.
<ul>
<li>The goal should be to build an understanding of the major moving parts.</li>
<li>Presentation of results can always be tailored to illustrate trends.</li>
</ul></li>
<li>Explore breakdown points (e.g., what sample size is too small for applying a given method?).</li>
</ul>
<p>And fully expect to add and subtract from your set of parameters as you get your initial simulation results! No one ever runs just a single simulation.</p>
</div>
<div id="example-the-clustered-rct" class="section level2 hasAnchor" number="9.2">
<h2><span class="header-section-number">9.2</span> Example: The Clustered RCT<a href="exp_design.html#example-the-clustered-rct" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Choosing parameters is the heart of the multifactor experiment.
Extending our case study presented in Section <span class="citation">(<a href="#ref-case_cluster" role="doc-biblioref"><strong>case_cluster?</strong></a>)</span> to a multifactor simulation, let’s think about how to design our full experiment.</p>
<p>So far, we have only investigated a single scenario at a time, although our modular approach does make exploring a range of scenarios by re-calling our simulation function relatively straightforward.
But how do our findings generalize? When are the different methods differently appropriate?
To answer this, we need to extend to a multifactor simulation to <em>systematically</em> explore trends across contexts for our three estimators.
We begin by identifying some questions we might have, given our preliminary results.</p>
<p>Regarding bias, in our initial simulation, we noticed that Linear Regression is estimating a person-weighted quantity, and so would be considered biased for the site-average ATE.
We might next ask, how much does bias change if we change the site-size by impact relationship?</p>
<p>For precision, we also saw that Linear Regression has a higher standard error.
But is this a general finding? When does this occur?
Are there contexts where linear regression will do better than the others?
Originally we thought aggregation would lose information becuase little sites will have the same weight as big sites, but be more imprecisely estimated.
Were we wrong? Or perhaps if site size was even more variable, Agg might do worse and worse.</p>
<p>Finally, the estimated SEs all appeared to be good, although they were rather variable, relative to the true SE.
We might then ask, is this always the case? Will the estimated SEs fall apart (e.g., be way too large or way too small, in general) in different contexts?</p>
<p>To answer these questions we need to more systematically explore the space of models. But we have a lot of knobs to turn.
In our simulation, we can generate fake cluster randomized data with the following features:</p>
<ul>
<li><p>The treatment impact of the site can vary, and vary with the site size</p></li>
<li><p>We can have sites of different sizes if we want</p></li>
<li><p>We can also vary:</p>
<ul>
<li>the site intercept variance</li>
<li>the residual variance,</li>
<li>the treatment impact</li>
<li>the site size</li>
<li>the number of sites, …</li>
</ul></li>
</ul>
<p>We cannot easily vary all of these.
We instead reflect on our research questions, speculate as to what is likely to matter, and then consider varying the following:</p>
<ul>
<li>Average site size: Does the number of students/site matter?</li>
<li>Number of sites: Do cluster-robust SEs work with fewer sites?</li>
<li>Variation in site size: Varying site sizes cause bias or break things?</li>
<li>Correlation of site size and site impact: Will correlation cause bias?</li>
<li>Cross site variation: Does the amount of site variation matter?</li>
</ul>
<p>When designing the final factors, it is important to ensure those factors are isolated, in that changing one of them is not changing a host of other things that might impact performance.
For example, in our case, if we simply added more cross site variation by directly increasing the random effects for the clusters, our total variation will increase.
If we see that methods deteriorate, we then have a confound: is it the cross site variation causing the problem, or is it the total variation?
We therefore want to vary site variation while controlling total variation; this is why we use the ICC knob discussed in the section on the data generation process.</p>
</div>
<div id="using-pmap-to-run-multifactor-simulations" class="section level2 hasAnchor" number="9.3">
<h2><span class="header-section-number">9.3</span> Using pmap to run multifactor simulations<a href="exp_design.html#using-pmap-to-run-multifactor-simulations" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>To run simulations across all of our factor combinations, we are going to use a very useful method in the <code>purrr</code> package called <code>pmap()</code>.
<code>pmap()</code> marches down a set of lists, running a function on each <span class="math inline">\(p\)</span>-tuple of elements, taking the <span class="math inline">\(i^{th}\)</span> element from each list for iteration <span class="math inline">\(i\)</span>, and passing them as parameters to the specified function.
<code>pmap()</code> then returns the results of this sequence of function calls as a list of results.</p>
<p>Here is a small illustration:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="exp_design.html#cb3-1" aria-hidden="true" tabindex="-1"></a>my_function <span class="ot">&lt;-</span> <span class="cf">function</span>( a, b, theta, scale ) {</span>
<span id="cb3-2"><a href="exp_design.html#cb3-2" aria-hidden="true" tabindex="-1"></a>    scale <span class="sc">*</span> (a <span class="sc">+</span> theta<span class="sc">*</span>(b<span class="sc">-</span>a))</span>
<span id="cb3-3"><a href="exp_design.html#cb3-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-4"><a href="exp_design.html#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="exp_design.html#cb3-5" aria-hidden="true" tabindex="-1"></a>args <span class="ot">=</span> <span class="fu">list</span>( <span class="at">a =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, </span>
<span id="cb3-6"><a href="exp_design.html#cb3-6" aria-hidden="true" tabindex="-1"></a>             <span class="at">b =</span> <span class="dv">5</span><span class="sc">:</span><span class="dv">7</span>, </span>
<span id="cb3-7"><a href="exp_design.html#cb3-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">theta =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.3</span>, <span class="fl">0.7</span>) )</span>
<span id="cb3-8"><a href="exp_design.html#cb3-8" aria-hidden="true" tabindex="-1"></a>purrr<span class="sc">::</span><span class="fu">pmap_dbl</span>(  args, my_function, <span class="at">scale =</span> <span class="dv">10</span> )</span></code></pre></div>
<pre><code>## [1] 18 32 58</code></pre>
<p>One important note is the variable names for the lists being iterated over must correspond exactly to function arguments of the called function.
Extra parameters can be passed after the function name; these will be held constant, and passed to each function call.
See how <code>scale</code> is the same for all calls.</p>
<p>As we see above, <code>pmap()</code> has variants such as <code>_dbl</code> or <code>_df</code> just like the <code>map()</code> and <code>map2()</code> methods.
These variants will automatically stack or convert the list of things returned into a tidier collection (for <code>_dbl</code> it will convert to a vector of numbers, for <code>_df</code> it will stack the results to make a large dataframe, assuming each thing returned is a little dataframe).</p>
<p>So far, this is great, but it does not quite look like what we want: our factors are stored as a dataframe, not three lists.
This is where R gets interesting: in R, the columns of a dataframe are stored as a list of vectors or lists (with each of the vectors or lists having the exact same length).
This works beautifully with <code>pmap()</code>.
Witness:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="exp_design.html#cb5-1" aria-hidden="true" tabindex="-1"></a>args[[<span class="dv">2</span>]]</span></code></pre></div>
<pre><code>## [1] 5 6 7</code></pre>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="exp_design.html#cb7-1" aria-hidden="true" tabindex="-1"></a>a_df <span class="ot">=</span> <span class="fu">as.data.frame</span>(args)</span>
<span id="cb7-2"><a href="exp_design.html#cb7-2" aria-hidden="true" tabindex="-1"></a>a_df</span></code></pre></div>
<pre><code>##   a b theta
## 1 1 5   0.2
## 2 2 6   0.3
## 3 3 7   0.7</code></pre>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="exp_design.html#cb9-1" aria-hidden="true" tabindex="-1"></a>a_df[[<span class="dv">2</span>]]</span></code></pre></div>
<pre><code>## [1] 5 6 7</code></pre>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="exp_design.html#cb11-1" aria-hidden="true" tabindex="-1"></a>purrr<span class="sc">::</span><span class="fu">pmap_dbl</span>( a_df, my_function, <span class="at">scale =</span> <span class="dv">10</span>)</span></code></pre></div>
<pre><code>## [1] 18 32 58</code></pre>
<p>We can pass <code>a_df</code> to <code>pmap</code>, and <code>pmap</code> takes it as a list of lists, and therefore does exactly what it did before.</p>
<p>All of this means <code>pmap()</code> can run a specified function on each row of a dataset.
Continuing the Cronbach Alpha simulation from above, we would have the following:</p>
<p>We add a column to <code>params</code> to record the desired 500 replications per condition.
The above code calls our <code>run_alpha_sim()</code> method for each row of our list of scenarios we want to explore.
Even better, we are storing the results <strong>as a new variable in the same dataset</strong>.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="exp_design.html#cb13-1" aria-hidden="true" tabindex="-1"></a>sim_results</span></code></pre></div>
<pre><code>## # A tibble: 144 × 6
##        n     p alpha    df iterations res         
##    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt; &lt;list&gt;      
##  1    50     4   0.1     5        500 &lt;df [4 × 3]&gt;
##  2   100     4   0.1     5        500 &lt;df [4 × 3]&gt;
##  3    50     8   0.1     5        500 &lt;df [4 × 3]&gt;
##  4   100     8   0.1     5        500 &lt;df [4 × 3]&gt;
##  5    50     4   0.2     5        500 &lt;df [4 × 3]&gt;
##  6   100     4   0.2     5        500 &lt;df [4 × 3]&gt;
##  7    50     8   0.2     5        500 &lt;df [4 × 3]&gt;
##  8   100     8   0.2     5        500 &lt;df [4 × 3]&gt;
##  9    50     4   0.3     5        500 &lt;df [4 × 3]&gt;
## 10   100     4   0.3     5        500 &lt;df [4 × 3]&gt;
## # … with 134 more rows</code></pre>
<p>We are creating a <strong>list-column</strong>, where each element in our list column is the little summary of our simulation results for that scenario.
Here is the third scenario, for example:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="exp_design.html#cb15-1" aria-hidden="true" tabindex="-1"></a>sim_results<span class="sc">$</span>res[[<span class="dv">3</span>]]</span></code></pre></div>
<pre><code>##         criterion         est        MCSE
## 1      alpha bias -0.07810538 0.015587246
## 2      alpha RMSE  0.35684535 0.002040271
## 3 V relative bias  0.40563277 0.004957216
## 4        coverage  0.83000000 0.009746794</code></pre>
<p>We finally use <code>unnest()</code> to expand the <code>res</code> variable, replicating the values of the main variables once for each row in the nested dataset:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="exp_design.html#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb17-2"><a href="exp_design.html#cb17-2" aria-hidden="true" tabindex="-1"></a>sim_results <span class="ot">&lt;-</span> <span class="fu">unnest</span>(sim_results, <span class="at">cols =</span> res) <span class="sc">%&gt;%</span></span>
<span id="cb17-3"><a href="exp_design.html#cb17-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>( <span class="sc">-</span>iterations )</span>
<span id="cb17-4"><a href="exp_design.html#cb17-4" aria-hidden="true" tabindex="-1"></a>sim_results</span></code></pre></div>
<pre><code>## # A tibble: 576 × 7
##        n     p alpha    df criterion           est     MCSE
##    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;             &lt;dbl&gt;    &lt;dbl&gt;
##  1    50     4   0.1     5 alpha bias      -0.0671 0.0135  
##  2    50     4   0.1     5 alpha RMSE       0.309  0.000536
##  3    50     4   0.1     5 V relative bias  0.601  0.00172 
##  4    50     4   0.1     5 coverage         0.854  0.00975 
##  5   100     4   0.1     5 alpha bias      -0.0469 0.0105  
##  6   100     4   0.1     5 alpha RMSE       0.239  0.000480
##  7   100     4   0.1     5 V relative bias  0.462  0.00165 
##  8   100     4   0.1     5 coverage         0.804  0.00975 
##  9    50     8   0.1     5 alpha bias      -0.0781 0.0156  
## 10    50     8   0.1     5 alpha RMSE       0.357  0.00204 
## # … with 566 more rows</code></pre>
<p>We can put all of this together in a a tidy workflow as follows:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="exp_design.html#cb19-1" aria-hidden="true" tabindex="-1"></a>sim_results <span class="ot">&lt;-</span> </span>
<span id="cb19-2"><a href="exp_design.html#cb19-2" aria-hidden="true" tabindex="-1"></a>  params <span class="sc">%&gt;%</span></span>
<span id="cb19-3"><a href="exp_design.html#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">res =</span> <span class="fu">pmap</span>(., <span class="at">.f =</span> run_alpha_sim)) <span class="sc">%&gt;%</span></span>
<span id="cb19-4"><a href="exp_design.html#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(<span class="at">cols =</span> res)</span></code></pre></div>
<p>If we wanted to use parallel processing (more on this later) we can also simply use the <code>simhelpers</code> package (the following code is auto-generated by the <code>create_skeleton()</code> method as well):</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="exp_design.html#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession) <span class="co"># choose an appropriate plan from the future package</span></span>
<span id="cb20-2"><a href="exp_design.html#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">evaluate_by_row</span>(params, run_alpha_sim)</span></code></pre></div>
<p>We save using the tidyverse writing command; see “R for Data Science”
textbook, 11.5.
We can ensure we have a directory by making one via <code>dir.create()</code> (see Section <span class="citation">(<a href="#ref-saving_files" role="doc-biblioref"><strong>saving_files?</strong></a>)</span> for more on files):</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="exp_design.html#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(<span class="st">&quot;results&quot;</span>, <span class="at">showWarnings =</span> <span class="cn">FALSE</span> )</span>
<span id="cb21-2"><a href="exp_design.html#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>( res, <span class="st">&quot;results/simulation_CRT.csv&quot;</span> )</span></code></pre></div>
</div>
<div id="how-to-repeat-oneself" class="section level2 hasAnchor" number="9.4">
<h2><span class="header-section-number">9.4</span> How to repeat oneself<a href="exp_design.html#how-to-repeat-oneself" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We have three core elements in our simulation:
- Generate data
- Analyze data
- Assess performance</p>
<p>In arranging these elements, we have a choice: do we compute performance measures for each simulation scenario as we go (inside) vs. computing after we get all of our individual results (outside)?</p>
<p><em>INSIDE (aggregate as you simulate):</em>
In this approach, we, for each scenario defined by a specific combination of factors, run our simulation for that scenario, assess the performance, and then return a nice summary table of how well our methods did.
This is the most straightforward, given what we have done so far: we have a method to run a simulation for a scenario, and we simply run that method for a bunch of scenarios and collate.</p>
<p>After the <code>pmap()</code> call, we would end up with a dataframe with all our simulations, one simulation context per row (or maybe bundles, one for each method), with
our measured performance outcomes. This is ideally all we need to analyze.</p>
<p>We have less data to store, and it is easier to compartmentalize.
On the cons side, we have no ability to add new performance measures on the fly.</p>
<p>This seems pretty good.
That being said, sometimes we might want to use a lot of disk space and keep
much more. In particular, each row of the above corresponds to the summary
of a whole collection of individual runs. We might instead store all of
these runs, which brings us to the other approach.</p>
<p><em>OUTSIDE (keep all simulation runs):</em>
In this approach we do not aggregate, but instead, for each scenario, return the entire set of individual estimates.
The benefit of this is, given the raw estimates, you can dynamically add or change how you calculate performance measures.
You do, however, end up with massive amounts of data to store and manipulate.</p>
<p>To move from inside to outside, we just take the summarizing step out of <code>run_alpha_sim()</code>.
E.g.,:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="exp_design.html#cb22-1" aria-hidden="true" tabindex="-1"></a>run_alpha_sim_raw <span class="ot">&lt;-</span> <span class="cf">function</span>(iterations, n, p, alpha, df, <span class="at">coverage =</span> <span class="fl">0.95</span>, <span class="at">seed =</span> <span class="cn">NULL</span>) {</span>
<span id="cb22-2"><a href="exp_design.html#cb22-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-3"><a href="exp_design.html#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(seed)) <span class="fu">set.seed</span>(seed)</span>
<span id="cb22-4"><a href="exp_design.html#cb22-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-5"><a href="exp_design.html#cb22-5" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> </span>
<span id="cb22-6"><a href="exp_design.html#cb22-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">replicate</span>(<span class="at">n =</span> iterations, {</span>
<span id="cb22-7"><a href="exp_design.html#cb22-7" aria-hidden="true" tabindex="-1"></a>      dat <span class="ot">&lt;-</span> <span class="fu">r_mvt_items</span>(<span class="at">n =</span> n, <span class="at">p =</span> p, <span class="at">alpha =</span> alpha, <span class="at">df =</span> df)</span>
<span id="cb22-8"><a href="exp_design.html#cb22-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">estimate_alpha</span>(dat, <span class="at">coverage =</span> coverage)</span>
<span id="cb22-9"><a href="exp_design.html#cb22-9" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">simplify =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb22-10"><a href="exp_design.html#cb22-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>()</span>
<span id="cb22-11"><a href="exp_design.html#cb22-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-12"><a href="exp_design.html#cb22-12" aria-hidden="true" tabindex="-1"></a>  results</span>
<span id="cb22-13"><a href="exp_design.html#cb22-13" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Each call to <code>run_alpha_sim_raw()</code> now gives one row per simulation trial.
We replicate our simulation parameters for each row.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="exp_design.html#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">run_alpha_sim_raw</span>( <span class="dv">4</span>, <span class="dv">50</span>, <span class="dv">6</span>, <span class="fl">0.5</span>, <span class="dv">3</span> )</span></code></pre></div>
<pre><code>##           A       Var_A       CI_L      CI_U
## 1 0.5576305 0.009393158 0.32036756 0.7120638
## 2 0.6831500 0.004818908 0.51320891 0.7937639
## 3 0.4041050 0.017044363 0.08449929 0.6121348
## 4 0.6075081 0.007394395 0.39699678 0.7445289</code></pre>
<p>The primary advantage of this is we can then generate new performance measures, as they
occur to us, later on. The disadvantage is this result file will be <span class="math inline">\(R\)</span>
times as many rows as the older file, which can get quite, quite large.</p>
<p>But disk space is cheap!
Here we run the same experiment with our more
complete storage. Note how the <code>pmap_df</code> stacks the
multiple rows from each run, giving us everything nicely bundled up:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="exp_design.html#cb25-1" aria-hidden="true" tabindex="-1"></a>params<span class="sc">$</span>res <span class="ot">&lt;-</span> params <span class="sc">%&gt;%</span> </span>
<span id="cb25-2"><a href="exp_design.html#cb25-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pmap</span>( run_alpha_sim_raw, <span class="at">iterations =</span> <span class="dv">500</span> )</span>
<span id="cb25-3"><a href="exp_design.html#cb25-3" aria-hidden="true" tabindex="-1"></a>sim_results_full <span class="ot">&lt;-</span> <span class="fu">unnest</span>( params,</span>
<span id="cb25-4"><a href="exp_design.html#cb25-4" aria-hidden="true" tabindex="-1"></a>                            <span class="at">cols =</span> res ) </span></code></pre></div>
<p>We end up with a lot more rows:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="exp_design.html#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>( sim_results_full )</span></code></pre></div>
<pre><code>## [1] 72000</code></pre>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="exp_design.html#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>( sim_results )</span></code></pre></div>
<pre><code>## [1] 576</code></pre>
<p>We next save our results:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="exp_design.html#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>( sim_results_full, <span class="st">&quot;results/cronbach_results_full.rds&quot;</span> )</span></code></pre></div>
<p>Compare the file sizes: one is several k, the other is around 20 megabytes.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="exp_design.html#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">file.size</span>(<span class="st">&quot;results/cronbach_results.rds&quot;</span>) <span class="sc">/</span> <span class="dv">1024</span></span></code></pre></div>
<pre><code>## [1] 8.286133</code></pre>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="exp_design.html#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">file.size</span>(<span class="st">&quot;results/cronbach_results_full.rds&quot;</span>) <span class="sc">/</span> <span class="dv">1024</span></span></code></pre></div>
<pre><code>## [1] 2114.216</code></pre>
<div id="getting-raw-results-ready-for-analysis" class="section level3 hasAnchor" number="9.4.1">
<h3><span class="header-section-number">9.4.1</span> Getting raw results ready for analysis<a href="exp_design.html#getting-raw-results-ready-for-analysis" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>If we generated raw results then we need to collapse them by experimental run
before calculating performance measures so we can explore the trends across the
experiments.
We do this by grouping our data and calling <code>alpha_performance()</code> for each group:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="exp_design.html#cb35-1" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> sim_results_full <span class="sc">%&gt;%</span></span>
<span id="cb35-2"><a href="exp_design.html#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest_by</span>( n, p, alpha, df, <span class="at">.key =</span> <span class="st">&quot;alpha_sims&quot;</span> )</span>
<span id="cb35-3"><a href="exp_design.html#cb35-3" aria-hidden="true" tabindex="-1"></a>results</span></code></pre></div>
<pre><code>## # A tibble: 144 × 5
## # Rowwise:  n, p, alpha, df
##        n     p alpha    df         alpha_sims
##    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;list&lt;tibble[,4]&gt;&gt;
##  1    50     4   0.1     5          [500 × 4]
##  2    50     4   0.1    10          [500 × 4]
##  3    50     4   0.1    20          [500 × 4]
##  4    50     4   0.1   100          [500 × 4]
##  5    50     4   0.2     5          [500 × 4]
##  6    50     4   0.2    10          [500 × 4]
##  7    50     4   0.2    20          [500 × 4]
##  8    50     4   0.2   100          [500 × 4]
##  9    50     4   0.3     5          [500 × 4]
## 10    50     4   0.3    10          [500 × 4]
## # … with 134 more rows</code></pre>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="exp_design.html#cb37-1" aria-hidden="true" tabindex="-1"></a>results<span class="sc">$</span>performance <span class="ot">=</span> <span class="fu">map2</span>( results<span class="sc">$</span>alpha_sims, </span>
<span id="cb37-2"><a href="exp_design.html#cb37-2" aria-hidden="true" tabindex="-1"></a>                               results<span class="sc">$</span>alpha, alpha_performance )</span>
<span id="cb37-3"><a href="exp_design.html#cb37-3" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> results <span class="sc">%&gt;%</span></span>
<span id="cb37-4"><a href="exp_design.html#cb37-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>( <span class="sc">-</span>alpha_sims ) <span class="sc">%&gt;%</span></span>
<span id="cb37-5"><a href="exp_design.html#cb37-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>( <span class="at">cols=</span><span class="st">&quot;performance&quot;</span> ) </span>
<span id="cb37-6"><a href="exp_design.html#cb37-6" aria-hidden="true" tabindex="-1"></a>results</span></code></pre></div>
<pre><code>## # A tibble: 576 × 7
## # Groups:   n, p, alpha, df [144]
##        n     p alpha    df criterion           est     MCSE
##    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;             &lt;dbl&gt;    &lt;dbl&gt;
##  1    50     4   0.1     5 alpha bias      -0.0798 0.0143  
##  2    50     4   0.1     5 alpha RMSE       0.328  0.000661
##  3    50     4   0.1     5 V relative bias  0.557  0.00186 
##  4    50     4   0.1     5 coverage         0.82   0.00975 
##  5    50     4   0.1    10 alpha bias      -0.0384 0.0124  
##  6    50     4   0.1    10 alpha RMSE       0.280  0.000700
##  7    50     4   0.1    10 V relative bias  0.661  0.00281 
##  8    50     4   0.1    10 coverage         0.892  0.00975 
##  9    50     4   0.1    20 alpha bias      -0.0390 0.0101  
## 10    50     4   0.1    20 alpha RMSE       0.229  0.000348
## # … with 566 more rows</code></pre>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="exp_design.html#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: This is HORRIBLE.  There has to be a better way.</span></span></code></pre></div>
<p>Now, if we want to add a performance metric, we can simply change <code>alpha_performance</code> and recalculate, without running the time-intensive simulations.
Being able to re-analyze your results is generally a far easier fix than running all the simulations again
after changing the <code>run_alpha_sim()</code> method.</p>
<p>The results of summarizing during the simulation vs. after as we just did
leads to essentially the same place, however, although our old results are in long format (with one row per simulation metric vs. the metrics being columns).</p>
</div>
</div>
<div id="running-the-cluster-rct-multifactor-experiment" class="section level2 hasAnchor" number="9.5">
<h2><span class="header-section-number">9.5</span> Running the Cluster RCT Multifactor experiment<a href="exp_design.html#running-the-cluster-rct-multifactor-experiment" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Running our cluster RCT simulation is the exact same code as we have used before.
Simulations take awhile to run so we save them so we can analyze at our leisure.
Because we are not exactly sure what performance metrics we want, we will save our individual results, and calculate performance metrics on the full data.
I.e., we are storing the individual runs, not the analyzed results!</p>
<p>The code is as follows:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="exp_design.html#cb40-1" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> </span>
<span id="cb40-2"><a href="exp_design.html#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cross_df</span>(design_factors) <span class="sc">%&gt;%</span></span>
<span id="cb40-3"><a href="exp_design.html#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb40-4"><a href="exp_design.html#cb40-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">reps =</span> <span class="dv">100</span>,</span>
<span id="cb40-5"><a href="exp_design.html#cb40-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">20200320</span> <span class="sc">+</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()</span>
<span id="cb40-6"><a href="exp_design.html#cb40-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb40-7"><a href="exp_design.html#cb40-7" aria-hidden="true" tabindex="-1"></a>params<span class="sc">$</span>res <span class="ot">=</span> <span class="fu">pmap</span>(params, <span class="at">.f =</span> one_CRT_sim )</span>
<span id="cb40-8"><a href="exp_design.html#cb40-8" aria-hidden="true" tabindex="-1"></a>res <span class="ot">=</span> params <span class="sc">%&gt;%</span> <span class="fu">unnest</span>( <span class="at">cols=</span><span class="fu">c</span>(data) )</span>
<span id="cb40-9"><a href="exp_design.html#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>( res, <span class="at">file =</span> <span class="st">&quot;results/simulation_CRT.rds&quot;</span> )</span></code></pre></div>
<p>The seed is for reproducibility; we discuss this more later on.</p>
<p>We then group by our simulation factors and calculate all our performance metrics at once directly.
For example, here is the code for calculating performance measures across our simulation for the cluster randomized experiments example:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="exp_design.html#cb41-1" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">read_csv</span>( <span class="at">file =</span> <span class="st">&quot;results/simulation_CRT.csv&quot;</span> )</span></code></pre></div>
<pre><code>## Rows: 202500 Columns: 14
## ── Column specification ────────────────────────────────────────────────────────
## Delimiter: &quot;,&quot;
## chr  (1): method
## dbl (13): n_bar, J, ATE, size_coef, ICC, alpha, reps, seed, runID, ATE_hat, ...
## 
## ℹ Use `spec()` to retrieve the full column specification for this data.
## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="exp_design.html#cb43-1" aria-hidden="true" tabindex="-1"></a>sres <span class="ot">&lt;-</span> </span>
<span id="cb43-2"><a href="exp_design.html#cb43-2" aria-hidden="true" tabindex="-1"></a>  res <span class="sc">%&gt;%</span> </span>
<span id="cb43-3"><a href="exp_design.html#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>( n_bar, J, ATE, size_coef, ICC, alpha, method ) <span class="sc">%&gt;%</span></span>
<span id="cb43-4"><a href="exp_design.html#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>( </span>
<span id="cb43-5"><a href="exp_design.html#cb43-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">bias =</span> <span class="fu">mean</span>(ATE_hat <span class="sc">-</span> ATE),</span>
<span id="cb43-6"><a href="exp_design.html#cb43-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">SE =</span> <span class="fu">sd</span>( ATE_hat ),</span>
<span id="cb43-7"><a href="exp_design.html#cb43-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">RMSE =</span> <span class="fu">sqrt</span>( <span class="fu">mean</span>( (ATE_hat <span class="sc">-</span> ATE )<span class="sc">^</span><span class="dv">2</span> ) ),</span>
<span id="cb43-8"><a href="exp_design.html#cb43-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">ESE_hat =</span> <span class="fu">sqrt</span>( <span class="fu">mean</span>( SE_hat<span class="sc">^</span><span class="dv">2</span> ) ),</span>
<span id="cb43-9"><a href="exp_design.html#cb43-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">SD_SE_hat =</span> <span class="fu">sqrt</span>( <span class="fu">sd</span>( SE_hat<span class="sc">^</span><span class="dv">2</span> ) ),</span>
<span id="cb43-10"><a href="exp_design.html#cb43-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">power =</span> <span class="fu">mean</span>( p_value <span class="sc">&lt;=</span> <span class="fl">0.05</span> ),</span>
<span id="cb43-11"><a href="exp_design.html#cb43-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">R =</span> <span class="fu">n</span>(),</span>
<span id="cb43-12"><a href="exp_design.html#cb43-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span></span>
<span id="cb43-13"><a href="exp_design.html#cb43-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb43-14"><a href="exp_design.html#cb43-14" aria-hidden="true" tabindex="-1"></a>sres</span></code></pre></div>
<pre><code>## # A tibble: 810 × 14
##    n_bar     J   ATE size_coef   ICC alpha method     bias    SE  RMSE ESE_hat
##    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;
##  1    20     5   0.2         0   0     0   Agg     0.00806 0.200 0.200   0.197
##  2    20     5   0.2         0   0     0   LR      0.00806 0.200 0.200   0.197
##  3    20     5   0.2         0   0     0   MLM     0.00806 0.200 0.200   0.234
##  4    20     5   0.2         0   0     0.5 Agg     0.0265  0.211 0.213   0.217
##  5    20     5   0.2         0   0     0.5 LR      0.0214  0.209 0.210   0.209
##  6    20     5   0.2         0   0     0.5 MLM     0.0234  0.208 0.209   0.244
##  7    20     5   0.2         0   0     0.8 Agg    -0.0186  0.239 0.239   0.224
##  8    20     5   0.2         0   0     0.8 LR     -0.0114  0.226 0.226   0.200
##  9    20     5   0.2         0   0     0.8 MLM    -0.0153  0.227 0.227   0.246
## 10    20     5   0.2         0   0.2   0   Agg    -0.00585 0.446 0.445   0.455
## # … with 800 more rows, and 3 more variables: SD_SE_hat &lt;dbl&gt;, power &lt;dbl&gt;,
## #   R &lt;int&gt;</code></pre>
<div id="making-analyze_data-quiet" class="section level3 hasAnchor" number="9.5.1">
<h3><span class="header-section-number">9.5.1</span> Making analyze_data() quiet<a href="exp_design.html#making-analyze_data-quiet" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>If we run our simulation when there is little cluster variation, we start getting a lot of messages and warnings from our MLM estimator.
For example, from a single call we get:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="exp_design.html#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">analyze_data</span>(dat)</span></code></pre></div>
<pre><code>## # A tibble: 3 × 4
##   method ATE_hat SE_hat p_value
##   &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;
## 1 MLM      -1.12  0.928   0.396
## 2 LR       -1.12  0.494   0.265
## 3 Agg      -1.12  0.494   0.265</code></pre>
<p>When we scale up to our full simulations, these warnings can become a nuisance.
Furthermore, we have found that the <code>lmer</code> command can sometimes just fail (we believe there is some bug in the optimizer that fails if things are just perfectly wrong).
If this was on simulation run 944 out of 1000, we would lose everything!
To protect ourselves, we trap messages and warnings as so (see Chapter @(#safe_code) for more on this):</p>
<pre><code>quiet_lmer = quietly( lmer )
analyze_data &lt;- function( dat ) {
    
    # MLM
    M1 &lt;- quiet_lmer( Yobs ~ 1 + Z + (1|sid), data=dat )
    message1 = ifelse( length( M1$message ) &gt; 0, 1, 0 )
    warning1 = ifelse( length( M1$warning ) &gt; 0, 1, 0 )

   ...

    # Compile our results
    tibble( 
      method = c( &quot;MLM&quot;, &quot;LR&quot;, &quot;Agg&quot; ),
      ATE_hat = c( est1, est2, est3 ),
      SE_hat = c( se1, se2, se3 ),
      p_value = c( pv1, pv2, pv3 ),
      message = c( message1, 0, 0 ),
      warning = c( warning1, 0, 0 )
    )
}</code></pre>
<p>We now get a note about the message regarding convergence saved in our results:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="exp_design.html#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">analyze_data</span>(dat)</span></code></pre></div>
<pre><code>## # A tibble: 3 × 6
##   method ATE_hat SE_hat p_value message warning
##   &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
## 1 MLM      -1.12  0.928   0.396       0       0
## 2 LR       -1.12  0.494   0.265       0       0
## 3 Agg      -1.12  0.494   0.265       0       0</code></pre>
</div>
</div>
<div id="analyzing-a-multifactor-experiment" class="section level2 hasAnchor" number="9.6">
<h2><span class="header-section-number">9.6</span> Analyzing a multifactor experiment<a href="exp_design.html#analyzing-a-multifactor-experiment" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Once we have performance measures for all our simulation scenarios, how do we explore them?
For our Cluster RCT simulation, we have 270 different simulation runs across our factors (with three rows per simulation run, one for each method).
How can we visualize and understand trends across this complex domain?</p>
<p>There are several techniques for summarizing across the data that one might use.</p>
<div id="bundling" class="section level3 hasAnchor" number="9.6.1">
<h3><span class="header-section-number">9.6.1</span> Bundling<a href="exp_design.html#bundling" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>As a first step, we might bundle the simulations by the primary factors of interest.
We would then plot these bundles as box plots to see central tendency along with variation.
With bundling, we would need a good number of simulation runs per scenario, so that the MCSE in the performance measures does not make our boxplots look substantially more variable than the truth.</p>
<p>For example, as a first step to understanding bias, we might bundle our results by ICC.
In this code we are making groups of method by ICC level so we get side-by-side boxplots for each ICC level considered:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="exp_design.html#cb50-1" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">readRDS</span>( <span class="st">&quot;results/simulation_CRT.rds&quot;</span> )</span>
<span id="cb50-2"><a href="exp_design.html#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>( sres, <span class="fu">aes</span>( ICC, bias, <span class="at">col=</span>method, <span class="at">group=</span><span class="fu">paste0</span>(ICC,method) ) ) <span class="sc">+</span></span>
<span id="cb50-3"><a href="exp_design.html#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>( alpha <span class="sc">~</span> size_coef, <span class="at">labeller =</span> label_both ) <span class="sc">+</span></span>
<span id="cb50-4"><a href="exp_design.html#cb50-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">coef =</span> <span class="cn">Inf</span>) <span class="sc">+</span></span>
<span id="cb50-5"><a href="exp_design.html#cb50-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>( <span class="at">yintercept =</span> <span class="dv">0</span> ) <span class="sc">+</span></span>
<span id="cb50-6"><a href="exp_design.html#cb50-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb50-7"><a href="exp_design.html#cb50-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>( <span class="at">breaks =</span> <span class="fu">unique</span>( sres<span class="sc">$</span>ICC) )</span></code></pre></div>
<p><img src="Designing-Simulations-in-R_files/figure-html/clusterRCT_plot_bias_v1-1.png" width="672" /></p>
<p>Each box is a collection of simulation trials. E.g., for <code>ICC = 0.6</code>, <code>size_coef = 0.2</code>, and <code>alpha = 0.8</code> we have 9 scenarios representing the varying level 1 and level 2 sample sizes:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="exp_design.html#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>( sres, ICC <span class="sc">==</span> <span class="fl">0.6</span>, size_coef <span class="sc">==</span> <span class="fl">0.2</span>,</span>
<span id="cb51-2"><a href="exp_design.html#cb51-2" aria-hidden="true" tabindex="-1"></a>        alpha <span class="sc">==</span> <span class="fl">0.8</span>, method<span class="sc">==</span><span class="st">&quot;Agg&quot;</span> ) <span class="sc">%&gt;%</span></span>
<span id="cb51-3"><a href="exp_design.html#cb51-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>( n_bar<span class="sc">:</span>alpha, bias )</span></code></pre></div>
<pre><code>## # A tibble: 9 × 7
##   n_bar     J   ATE size_coef   ICC alpha     bias
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;
## 1    20     5   0.2       0.2   0.6   0.8 -0.00452
## 2    20    20   0.2       0.2   0.6   0.8 -0.0182 
## 3    20    80   0.2       0.2   0.6   0.8 -0.00921
## 4    80     5   0.2       0.2   0.6   0.8  0.119  
## 5    80    20   0.2       0.2   0.6   0.8  0.00210
## 6    80    80   0.2       0.2   0.6   0.8  0.00641
## 7   320     5   0.2       0.2   0.6   0.8 -0.00182
## 8   320    20   0.2       0.2   0.6   0.8 -0.00219
## 9   320    80   0.2       0.2   0.6   0.8  0.00632</code></pre>
<p>We are seeing a few outliers for some of the boxplots, suggesting that there are other factors driving bias. We could try bundling along different aspects to see:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="exp_design.html#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>( sres, <span class="fu">aes</span>( <span class="fu">as.factor</span>(n_bar), bias, <span class="at">col=</span>method, <span class="at">group=</span><span class="fu">paste0</span>(n_bar,method) ) ) <span class="sc">+</span></span>
<span id="cb53-2"><a href="exp_design.html#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>( alpha <span class="sc">~</span>  size_coef, <span class="at">labeller =</span> label_both ) <span class="sc">+</span></span>
<span id="cb53-3"><a href="exp_design.html#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">coef =</span> <span class="cn">Inf</span>) <span class="sc">+</span></span>
<span id="cb53-4"><a href="exp_design.html#cb53-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>( <span class="at">yintercept =</span> <span class="dv">0</span> ) <span class="sc">+</span></span>
<span id="cb53-5"><a href="exp_design.html#cb53-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code></pre></div>
<p><img src="Designing-Simulations-in-R_files/figure-html/clusterRCT_plot_bias_v2-1.png" width="672" /></p>
<p>No progress there. Perhaps it is instability or MCSE.
We make a note to investigate further, later on.</p>
</div>
<div id="aggregation" class="section level3 hasAnchor" number="9.6.2">
<h3><span class="header-section-number">9.6.2</span> Aggregation<a href="exp_design.html#aggregation" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The boxplots are hard for seeing trends.
Instead of bundling, we can therefore aggregate, to look at overall trends rather than individual simulation variation.
This is especially important if the number of replicates within each scenario is small, because then each scenario’s performance is measured with a lot of error.</p>
<p>With aggregation, we average over some of the factors, collapsing our simulation results down to fewer moving parts.
This is better than having not had those factors in the first place!
Averaging over a factor is a more general answer than having not varied the factor at all.</p>
<p>For example, if we average across ICC and site variation, and see how the methods change performance as a function of <span class="math inline">\(J\)</span>, we would know that this is a general trend across a range of scenarios defined by different ICC and site variation levels.
Our conclusions would then be more general than if we picked a single ICC and amount of site variation: in this latter case we would not know if we would see our trend more broadly.</p>
<p>Also, with aggregation, we can have a smaller number of replications per factor combination.
The averaging will, in effect, give a lot more reps per aggregated performance measure.</p>
<p>A caution with aggregation is that it can be deceitful if you have scaling issues or extreme outliers.
With bias, our scale is fairly well set, so we are good!
But if we were aggregating standard errors over sample size, then the larger standard errors of the smaller sample size simulations (and the greater variability in estimating those standard errors) would swamp the standard errors of the larger sample sizes.
Usually, with aggregation, we want to average over something we believe will not change massively over the marginalized-out factors.
Alternatively, we can average over a relative measure, which tend to be more invariant and comparable across scenarios.</p>
<p>For our cluster RCT, we might aggregate as follows:</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="exp_design.html#cb54-1" aria-hidden="true" tabindex="-1"></a>ssres <span class="ot">&lt;-</span> </span>
<span id="cb54-2"><a href="exp_design.html#cb54-2" aria-hidden="true" tabindex="-1"></a>  sres <span class="sc">%&gt;%</span> </span>
<span id="cb54-3"><a href="exp_design.html#cb54-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>( ICC, method, alpha, size_coef ) <span class="sc">%&gt;%</span></span>
<span id="cb54-4"><a href="exp_design.html#cb54-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>( <span class="at">bias =</span> <span class="fu">mean</span>( bias ) )</span>
<span id="cb54-5"><a href="exp_design.html#cb54-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-6"><a href="exp_design.html#cb54-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>( ssres, <span class="fu">aes</span>( ICC, bias, <span class="at">col=</span>method ) ) <span class="sc">+</span></span>
<span id="cb54-7"><a href="exp_design.html#cb54-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>( alpha <span class="sc">~</span>  size_coef, <span class="at">labeller =</span> label_both ) <span class="sc">+</span></span>
<span id="cb54-8"><a href="exp_design.html#cb54-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="at">alpha=</span><span class="fl">0.75</span> ) <span class="sc">+</span> </span>
<span id="cb54-9"><a href="exp_design.html#cb54-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>( <span class="at">alpha=</span><span class="fl">0.75</span> ) <span class="sc">+</span></span>
<span id="cb54-10"><a href="exp_design.html#cb54-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>( <span class="at">yintercept =</span> <span class="dv">0</span> ) <span class="sc">+</span></span>
<span id="cb54-11"><a href="exp_design.html#cb54-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code></pre></div>
<p><img src="Designing-Simulations-in-R_files/figure-html/unnamed-chunk-18-1.png" width="672" /></p>
<p>This shows that site variation leads to greater bias, but only if the coefficient for size is nonzero.
We also see that all the estimators must be the same if site variation is 0, with the overplotted lines on the top row of the figure.</p>
</div>
<div id="regression-summarization" class="section level3 hasAnchor" number="9.6.3">
<h3><span class="header-section-number">9.6.3</span> Regression Summarization<a href="exp_design.html#regression-summarization" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>One can treat the simulation results as a dataset in its own right.
In this case we can regress a performance measure against the methods and various factor levels to get “main effects” of how the different levels impact performance holding the other levels constant.
The main effect of the method will tell us if a method is, on average, higher or lower than the baseline method.
The main effect of the factors will tell us if that factor impacts the performance measure.</p>
<p>These regressions can also include interactions between method and factor, to see if some factors impact different methods differently.
They can also include interactions between factors, which allows us to explore how the impact of a factor can matter more or less, depending on other aspects of the context.</p>
<p>For our cluster RCT, we might have, for example:</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="exp_design.html#cb55-1" aria-hidden="true" tabindex="-1"></a>sres_f <span class="ot">=</span> sres <span class="sc">%&gt;%</span></span>
<span id="cb55-2"><a href="exp_design.html#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>( <span class="fu">across</span>( <span class="fu">c</span>( n_bar, J, size_coef, ICC, alpha ), factor ) )</span>
<span id="cb55-3"><a href="exp_design.html#cb55-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-4"><a href="exp_design.html#cb55-4" aria-hidden="true" tabindex="-1"></a>M <span class="ot">&lt;-</span> <span class="fu">lm</span>( bias <span class="sc">~</span> (n_bar <span class="sc">+</span> J <span class="sc">+</span> size_coef <span class="sc">+</span> ICC <span class="sc">+</span> alpha) <span class="sc">*</span> method, </span>
<span id="cb55-5"><a href="exp_design.html#cb55-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">data =</span> sres_f )</span>
<span id="cb55-6"><a href="exp_design.html#cb55-6" aria-hidden="true" tabindex="-1"></a>stargazer<span class="sc">::</span><span class="fu">stargazer</span>(M, <span class="at">type =</span> <span class="st">&quot;text&quot;</span>,</span>
<span id="cb55-7"><a href="exp_design.html#cb55-7" aria-hidden="true" tabindex="-1"></a>                     <span class="at">single.row =</span> <span class="cn">TRUE</span> )</span></code></pre></div>
<pre><code>## 
## ==================================================
##                            Dependent variable:    
##                        ---------------------------
##                                   bias            
## --------------------------------------------------
## n_bar80                       0.002 (0.004)       
## n_bar320                     -0.005 (0.004)       
## J20                          -0.005 (0.004)       
## J80                           0.001 (0.004)       
## size_coef0.2                  0.001 (0.003)       
## ICC0.2                        0.003 (0.005)       
## ICC0.4                       0.00003 (0.005)      
## ICC0.6                       -0.003 (0.005)       
## ICC0.8                       -0.004 (0.005)       
## alpha0.5                     0.010** (0.004)      
## alpha0.8                      0.006 (0.004)       
## methodLR                     -0.013* (0.008)      
## methodMLM                     0.002 (0.008)       
## n_bar80:methodLR             -0.001 (0.005)       
## n_bar320:methodLR            -0.001 (0.005)       
## n_bar80:methodMLM            -0.0004 (0.005)      
## n_bar320:methodMLM           -0.001 (0.005)       
## J20:methodLR                  0.005 (0.005)       
## J80:methodLR                  0.004 (0.005)       
## J20:methodMLM                 0.001 (0.005)       
## J80:methodMLM                 0.001 (0.005)       
## size_coef0.2:methodLR       0.018*** (0.004)      
## size_coef0.2:methodMLM        0.003 (0.004)       
## ICC0.2:methodLR               0.001 (0.007)       
## ICC0.4:methodLR               0.001 (0.007)       
## ICC0.6:methodLR               0.001 (0.007)       
## ICC0.8:methodLR               0.003 (0.007)       
## ICC0.2:methodMLM             -0.005 (0.007)       
## ICC0.4:methodMLM             -0.005 (0.007)       
## ICC0.6:methodMLM             -0.006 (0.007)       
## ICC0.8:methodMLM             -0.006 (0.007)       
## alpha0.5:methodLR             0.008 (0.005)       
## alpha0.8:methodLR           0.020*** (0.005)      
## alpha0.5:methodMLM            0.001 (0.005)       
## alpha0.8:methodMLM            0.003 (0.005)       
## Constant                     -0.003 (0.005)       
## --------------------------------------------------
## Observations                       810            
## R2                                0.165           
## Adjusted R2                       0.127           
## Residual Std. Error         0.026 (df = 774)      
## F Statistic              4.367*** (df = 35; 774)  
## ==================================================
## Note:                  *p&lt;0.1; **p&lt;0.05; ***p&lt;0.01</code></pre>
<p>We can quickly get a lot of features, and this approach can be hard to interpret. But picking out the significant coefficents does provide a lot of clues, rather rapidly.
E.g., many features interact with the LR method for bias. The other methods seem less impacted.</p>
</div>
<div id="focus-on-subset-kick-rest-to-supplement" class="section level3 hasAnchor" number="9.6.4">
<h3><span class="header-section-number">9.6.4</span> Focus on subset, kick rest to supplement<a href="exp_design.html#focus-on-subset-kick-rest-to-supplement" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Frequently researchers might simply filter the simulation results to a single factor level for some nuisance parameter.
For example, we might examine ICC of 0.20 only, as this is a “reasonable” value given substance matter knowledge.
We would then consider the other levels as a “sensitivity” analysis vaguely alluded to in our main report and placed elsewhere, such as an online supplemental appendix.</p>
<p>It would be our job, in this case, to verify that our reported findings on the main results indeed were echoed in our other, set-aside, simulation runs.</p>
</div>
</div>
<div id="analyzing-results-when-some-trials-have-failed" class="section level2 hasAnchor" number="9.7">
<h2><span class="header-section-number">9.7</span> Analyzing results when some trials have failed<a href="exp_design.html#analyzing-results-when-some-trials-have-failed" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>If methods fail, then this is something to investigate in its own right.
Ideally, failure is not too common, so we can drop those trials, or keep them, without really impacting our overall results.
But one should at least know what one is ignoring.</p>
<p>For example, in our cluster RCT, we know we have, at least sometimes, convergence issues.
We know that ICC is an important feature, so we can explore how often we get a convergence message by ICC level:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="exp_design.html#cb57-1" aria-hidden="true" tabindex="-1"></a>res <span class="sc">%&gt;%</span> </span>
<span id="cb57-2"><a href="exp_design.html#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>( method, ICC ) <span class="sc">%&gt;%</span></span>
<span id="cb57-3"><a href="exp_design.html#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>( <span class="at">message =</span> <span class="fu">mean</span>( message ) ) <span class="sc">%&gt;%</span></span>
<span id="cb57-4"><a href="exp_design.html#cb57-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>( <span class="at">names_from =</span> <span class="st">&quot;method&quot;</span>, <span class="at">values_from=</span><span class="st">&quot;message&quot;</span> )</span></code></pre></div>
<pre><code>## # A tibble: 5 × 4
##     ICC   Agg    LR      MLM
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;
## 1   0       0     0 0.499   
## 2   0.2     0     0 0.0139  
## 3   0.4     0     0 0.00311 
## 4   0.6     0     0 0.00104 
## 5   0.8     0     0 0.000444</code></pre>
<p>We see that when the ICC is 0 we get a lot of convergence issues, but as soon as we pull away from 0 it drops off considerably.
At this point we might decide to drop those runs with a message or keep them.
In this case, we decide to keep.
It shouldn’t matter much in any case except the ICC = 0 case, and we know the convergence is due to trying to estimate a 0 variance, and thus is in some sense expected.
Furthermore, we know people using these methods would likely ignore these messages, and thus we are faithfully capturing how these methods would be used in practice.
We might eventually, however, want to do a separate analysis of the ICC = 0 context to see if the MLM approach actually falls apart, or if it is just throwing error messages.</p>
</div>
<div id="exercises-4" class="section level2 hasAnchor" number="9.8">
<h2><span class="header-section-number">9.8</span> Exercises<a href="exp_design.html#exercises-4" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ol style="list-style-type: decimal">
<li>For our cluster RCT, use the simulation results to assess how much better (or worse) the different methods are to each other in terms of confidence interval coverage. What scenarios tend to result in the worst coverage?</li>
</ol>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="case_Cronbach.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="case-study-comparing-different-estimators.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/jepusto/Designing-Simulations-in-R/edit/master/070-experimental-design.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["Designing-Simulations-in-R.pdf", "Designing-Simulations-in-R.epub"],
"search": {
"engine": "lunr",
"options": null
},
"toc": {
"collapse": "section",
"scroll_highlight": true
},
"toolbar": {
"position": "fixed"
},
"info": true
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
