<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 12 Error trapping and other headaches | Designing Monte Carlo Simulations in R</title>
  <meta name="description" content="A text on designing, implementing, and reporting on Monte Carlo simulation studies" />
  <meta name="generator" content="bookdown 0.26 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 12 Error trapping and other headaches | Designing Monte Carlo Simulations in R" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="A text on designing, implementing, and reporting on Monte Carlo simulation studies" />
  <meta name="github-repo" content="jepusto/Designing-Simulations-in-R" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 12 Error trapping and other headaches | Designing Monte Carlo Simulations in R" />
  
  <meta name="twitter:description" content="A text on designing, implementing, and reporting on Monte Carlo simulation studies" />
  

<meta name="author" content="James E. Pustejovsky and Luke W. Miratrix" />


<meta name="date" content="2022-05-10" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="case_cluster.html"/>
<link rel="next" href="exp_design.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Designing Simulations in R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#some-of-simulations-many-uses"><i class="fa fa-check"></i><b>1.1</b> Some of simulation’s many uses</a>
<ul>
<li class="chapter" data-level="1.1.1" data-path="index.html"><a href="index.html#comparing-statistical-approaches"><i class="fa fa-check"></i><b>1.1.1</b> Comparing statistical approaches</a></li>
<li class="chapter" data-level="1.1.2" data-path="index.html"><a href="index.html#assessing-performance-of-complex-pipelines"><i class="fa fa-check"></i><b>1.1.2</b> Assessing performance of complex pipelines</a></li>
<li class="chapter" data-level="1.1.3" data-path="index.html"><a href="index.html#assessing-performance-under-misspecification"><i class="fa fa-check"></i><b>1.1.3</b> Assessing performance under misspecification</a></li>
<li class="chapter" data-level="1.1.4" data-path="index.html"><a href="index.html#assessing-the-finite-sample-performance-of-a-statistical-approach"><i class="fa fa-check"></i><b>1.1.4</b> Assessing the finite sample performance of a statistical approach</a></li>
<li class="chapter" data-level="1.1.5" data-path="index.html"><a href="index.html#conducting-power-analyses"><i class="fa fa-check"></i><b>1.1.5</b> Conducting Power Analyses</a></li>
<li class="chapter" data-level="1.1.6" data-path="index.html"><a href="index.html#simulating-processess"><i class="fa fa-check"></i><b>1.1.6</b> Simulating processess</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#the-perils-of-simulation-as-evidence"><i class="fa fa-check"></i><b>1.2</b> The perils of simulation as evidence</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#why-r-and-rstudio"><i class="fa fa-check"></i><b>1.3</b> Why R and RStudio?</a>
<ul>
<li class="chapter" data-level="1.3.1" data-path="index.html"><a href="index.html#functions"><i class="fa fa-check"></i><b>1.3.1</b> Functions</a></li>
<li class="chapter" data-level="1.3.2" data-path="index.html"><a href="index.html#a-dangerous-function"><i class="fa fa-check"></i><b>1.3.2</b> A dangerous function</a></li>
<li class="chapter" data-level="1.3.3" data-path="index.html"><a href="index.html#function-skeletons"><i class="fa fa-check"></i><b>1.3.3</b> Function skeletons</a></li>
<li class="chapter" data-level="1.3.4" data-path="index.html"><a href="index.html#pipe-dreams"><i class="fa fa-check"></i><b>1.3.4</b> <code>%&gt;%</code> (Pipe) dreams</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="an-initial-simulation.html"><a href="an-initial-simulation.html"><i class="fa fa-check"></i><b>2</b> An initial simulation</a>
<ul>
<li class="chapter" data-level="2.1" data-path="an-initial-simulation.html"><a href="an-initial-simulation.html#simulation-for-a-single-scenario"><i class="fa fa-check"></i><b>2.1</b> Simulation for a single scenario</a></li>
<li class="chapter" data-level="2.2" data-path="an-initial-simulation.html"><a href="an-initial-simulation.html#simulating-across-different-scenarios"><i class="fa fa-check"></i><b>2.2</b> Simulating across different scenarios</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html"><i class="fa fa-check"></i><b>3</b> Structure of a simulation study</a>
<ul>
<li class="chapter" data-level="3.1" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#general-structure-of-a-simulation"><i class="fa fa-check"></i><b>3.1</b> General structure of a simulation</a></li>
<li class="chapter" data-level="3.2" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#tidy-simulations"><i class="fa fa-check"></i><b>3.2</b> Tidy simulations</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#data-generating-model"><i class="fa fa-check"></i><b>3.2.1</b> Data-generating model</a></li>
<li class="chapter" data-level="3.2.2" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#estimation-methods"><i class="fa fa-check"></i><b>3.2.2</b> Estimation methods</a></li>
<li class="chapter" data-level="3.2.3" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#repetition"><i class="fa fa-check"></i><b>3.2.3</b> Repetition</a></li>
<li class="chapter" data-level="3.2.4" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#performance-summaries"><i class="fa fa-check"></i><b>3.2.4</b> Performance summaries</a></li>
<li class="chapter" data-level="3.2.5" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#results"><i class="fa fa-check"></i><b>3.2.5</b> Results</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#multiple-scenarios"><i class="fa fa-check"></i><b>3.3</b> Multiple Scenarios</a></li>
<li class="chapter" data-level="3.4" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#keeping-the-pieces-organized"><i class="fa fa-check"></i><b>3.4</b> Keeping the pieces organized</a></li>
<li class="chapter" data-level="3.5" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#further-readings-resources"><i class="fa fa-check"></i><b>3.5</b> Further readings &amp; resources</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="case_ANOVA.html"><a href="case_ANOVA.html"><i class="fa fa-check"></i><b>4</b> Case Study: Heteroskedastic ANOVA</a>
<ul>
<li class="chapter" data-level="4.1" data-path="case_ANOVA.html"><a href="case_ANOVA.html#the-data-generating-model"><i class="fa fa-check"></i><b>4.1</b> The data-generating model</a></li>
<li class="chapter" data-level="4.2" data-path="case_ANOVA.html"><a href="case_ANOVA.html#the-estimation-procedures"><i class="fa fa-check"></i><b>4.2</b> The estimation procedures</a></li>
<li class="chapter" data-level="4.3" data-path="case_ANOVA.html"><a href="case_ANOVA.html#replication"><i class="fa fa-check"></i><b>4.3</b> Replication</a></li>
<li class="chapter" data-level="4.4" data-path="case_ANOVA.html"><a href="case_ANOVA.html#calculating-rejection-rates"><i class="fa fa-check"></i><b>4.4</b> Calculating rejection rates</a></li>
<li class="chapter" data-level="4.5" data-path="case_ANOVA.html"><a href="case_ANOVA.html#exAnovaExercises"><i class="fa fa-check"></i><b>4.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="data-generating-models.html"><a href="data-generating-models.html"><i class="fa fa-check"></i><b>5</b> Data-generating models</a>
<ul>
<li class="chapter" data-level="5.1" data-path="data-generating-models.html"><a href="data-generating-models.html#computational-efficiency-versus-simplicity"><i class="fa fa-check"></i><b>5.1</b> Computational efficiency versus simplicity</a></li>
<li class="chapter" data-level="5.2" data-path="data-generating-models.html"><a href="data-generating-models.html#checking-the-data-generating-function"><i class="fa fa-check"></i><b>5.2</b> Checking the data-generating function</a></li>
<li class="chapter" data-level="5.3" data-path="data-generating-models.html"><a href="data-generating-models.html#exercises"><i class="fa fa-check"></i><b>5.3</b> Exercises</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="data-generating-models.html"><a href="data-generating-models.html#shifted-and-scaled-t-distribution"><i class="fa fa-check"></i><b>5.3.1</b> Shifted-and-scaled t distribution</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="estimation-procedures.html"><a href="estimation-procedures.html"><i class="fa fa-check"></i><b>6</b> Estimation procedures</a>
<ul>
<li class="chapter" data-level="6.1" data-path="estimation-procedures.html"><a href="estimation-procedures.html#further-notes-on-computational-efficiency"><i class="fa fa-check"></i><b>6.1</b> Further notes on computational efficiency</a></li>
<li class="chapter" data-level="6.2" data-path="estimation-procedures.html"><a href="estimation-procedures.html#checking-the-estimation-function"><i class="fa fa-check"></i><b>6.2</b> Checking the estimation function</a></li>
<li class="chapter" data-level="6.3" data-path="estimation-procedures.html"><a href="estimation-procedures.html#exercises-1"><i class="fa fa-check"></i><b>6.3</b> Exercises</a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="estimation-procedures.html"><a href="estimation-procedures.html#adding-the-bff-test"><i class="fa fa-check"></i><b>6.3.1</b> Adding the BFF* test</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="performance-criteria.html"><a href="performance-criteria.html"><i class="fa fa-check"></i><b>7</b> Performance criteria</a>
<ul>
<li class="chapter" data-level="7.1" data-path="performance-criteria.html"><a href="performance-criteria.html#inference-vs.-estimation"><i class="fa fa-check"></i><b>7.1</b> Inference vs. Estimation</a></li>
<li class="chapter" data-level="7.2" data-path="performance-criteria.html"><a href="performance-criteria.html#evaluation-of-estimation-methods"><i class="fa fa-check"></i><b>7.2</b> Evaluation of Estimation Methods</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-actual-properties"><i class="fa fa-check"></i><b>7.2.1</b> Assessing actual properties</a></li>
<li class="chapter" data-level="7.2.2" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-estimated-properties"><i class="fa fa-check"></i><b>7.2.2</b> Assessing estimated properties</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-a-point-estimator"><i class="fa fa-check"></i><b>7.3</b> Assessing a point estimator</a></li>
<li class="chapter" data-level="7.4" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-a-standard-error-estimator"><i class="fa fa-check"></i><b>7.4</b> Assessing a standard error estimator</a>
<ul>
<li class="chapter" data-level="7.4.1" data-path="performance-criteria.html"><a href="performance-criteria.html#why-not-assess-widehatse-directly"><i class="fa fa-check"></i><b>7.4.1</b> Why not assess <span class="math inline">\(widehat{SE}\)</span> directly?</a></li>
</ul></li>
<li class="chapter" data-level="7.5" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-a-hypothesis-testing-procedure"><i class="fa fa-check"></i><b>7.5</b> Assessing a hypothesis testing procedure</a>
<ul>
<li class="chapter" data-level="7.5.1" data-path="performance-criteria.html"><a href="performance-criteria.html#validity"><i class="fa fa-check"></i><b>7.5.1</b> Validity</a></li>
<li class="chapter" data-level="7.5.2" data-path="performance-criteria.html"><a href="performance-criteria.html#power"><i class="fa fa-check"></i><b>7.5.2</b> Power</a></li>
</ul></li>
<li class="chapter" data-level="7.6" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-confidence-intervals"><i class="fa fa-check"></i><b>7.6</b> Assessing confidence intervals</a></li>
<li class="chapter" data-level="7.7" data-path="performance-criteria.html"><a href="performance-criteria.html#uncertainty-in-our-performance-estimates-the-mcse"><i class="fa fa-check"></i><b>7.7</b> Uncertainty in our performance estimates (the MCSE)</a>
<ul>
<li class="chapter" data-level="7.7.1" data-path="performance-criteria.html"><a href="performance-criteria.html#mcse-for-variance-estimators"><i class="fa fa-check"></i><b>7.7.1</b> MCSE for variance estimators</a></li>
<li class="chapter" data-level="7.7.2" data-path="performance-criteria.html"><a href="performance-criteria.html#the-simhelpers-package-and-mcses"><i class="fa fa-check"></i><b>7.7.2</b> The simhelpers package and MCSEs</a></li>
</ul></li>
<li class="chapter" data-level="7.8" data-path="performance-criteria.html"><a href="performance-criteria.html#absolute-vs.-relative-performance-measures"><i class="fa fa-check"></i><b>7.8</b> Absolute vs. relative performance measures</a></li>
<li class="chapter" data-level="7.9" data-path="performance-criteria.html"><a href="performance-criteria.html#exercises-simulating-cronbachs-alpha"><i class="fa fa-check"></i><b>7.9</b> Exercises: Simulating Cronbach’s alpha</a>
<ul>
<li class="chapter" data-level="7.9.1" data-path="performance-criteria.html"><a href="performance-criteria.html#the-data-generating-function"><i class="fa fa-check"></i><b>7.9.1</b> The data-generating function</a></li>
<li class="chapter" data-level="7.9.2" data-path="performance-criteria.html"><a href="performance-criteria.html#the-estimation-function"><i class="fa fa-check"></i><b>7.9.2</b> The estimation function</a></li>
<li class="chapter" data-level="7.9.3" data-path="performance-criteria.html"><a href="performance-criteria.html#replicates"><i class="fa fa-check"></i><b>7.9.3</b> Replicates</a></li>
<li class="chapter" data-level="7.9.4" data-path="performance-criteria.html"><a href="performance-criteria.html#estimator-performance"><i class="fa fa-check"></i><b>7.9.4</b> Estimator performance</a></li>
<li class="chapter" data-level="7.9.5" data-path="performance-criteria.html"><a href="performance-criteria.html#confidence-interval-coverage"><i class="fa fa-check"></i><b>7.9.5</b> Confidence interval coverage</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="case_Cronbach.html"><a href="case_Cronbach.html"><i class="fa fa-check"></i><b>8</b> Case study: Cronbach Alpha</a>
<ul>
<li class="chapter" data-level="8.1" data-path="case_Cronbach.html"><a href="case_Cronbach.html#data-generating-model-1"><i class="fa fa-check"></i><b>8.1</b> Data-generating model</a></li>
<li class="chapter" data-level="8.2" data-path="case_Cronbach.html"><a href="case_Cronbach.html#estimation-procedures-1"><i class="fa fa-check"></i><b>8.2</b> Estimation procedures</a></li>
<li class="chapter" data-level="8.3" data-path="case_Cronbach.html"><a href="case_Cronbach.html#performance-calculations"><i class="fa fa-check"></i><b>8.3</b> Performance calculations</a></li>
<li class="chapter" data-level="8.4" data-path="case_Cronbach.html"><a href="case_Cronbach.html#simulation-driver"><i class="fa fa-check"></i><b>8.4</b> Simulation driver</a></li>
<li class="chapter" data-level="8.5" data-path="case_Cronbach.html"><a href="case_Cronbach.html#running-the-simulation"><i class="fa fa-check"></i><b>8.5</b> Running the simulation</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="ensuring-reproducibility.html"><a href="ensuring-reproducibility.html"><i class="fa fa-check"></i><b>9</b> Ensuring reproducibility</a>
<ul>
<li class="chapter" data-level="9.1" data-path="ensuring-reproducibility.html"><a href="ensuring-reproducibility.html#seeds-and-pseudo-random-number-generators"><i class="fa fa-check"></i><b>9.1</b> Seeds and pseudo-random number generators</a></li>
<li class="chapter" data-level="9.2" data-path="ensuring-reproducibility.html"><a href="ensuring-reproducibility.html#including-seed-in-our-simulation-driver"><i class="fa fa-check"></i><b>9.2</b> Including seed in our simulation driver</a></li>
<li class="chapter" data-level="9.3" data-path="ensuring-reproducibility.html"><a href="ensuring-reproducibility.html#reasons-for-setting-the-seed"><i class="fa fa-check"></i><b>9.3</b> Reasons for setting the seed</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="index.html"><a href="index.html#functions"><i class="fa fa-check"></i><b>10</b> More on functions</a>
<ul>
<li class="chapter" data-level="10.1" data-path="functions.html"><a href="functions.html"><i class="fa fa-check"></i><b>10.1</b> Default arguments for functions</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="case_cluster.html"><a href="case_cluster.html"><i class="fa fa-check"></i><b>11</b> Case study: A simulation with clustered data</a>
<ul>
<li class="chapter" data-level="11.1" data-path="case_cluster.html"><a href="case_cluster.html#a-design-decision-what-do-we-want-to-manipulate"><i class="fa fa-check"></i><b>11.1</b> A design decision: What do we want to manipulate?</a></li>
<li class="chapter" data-level="11.2" data-path="case_cluster.html"><a href="case_cluster.html#a-mathematical-model-for-cluster-randomized-data"><i class="fa fa-check"></i><b>11.2</b> A mathematical model for cluster-randomized data</a></li>
<li class="chapter" data-level="11.3" data-path="case_cluster.html"><a href="case_cluster.html#multilevel-data-generation-is-a-recipe-using-a-statistical-model"><i class="fa fa-check"></i><b>11.3</b> Multilevel data generation is a recipe using a statistical model</a>
<ul>
<li class="chapter" data-level="11.3.1" data-path="case_cluster.html"><a href="case_cluster.html#generating-the-multisite-data"><i class="fa fa-check"></i><b>11.3.1</b> Generating the multisite data</a></li>
</ul></li>
<li class="chapter" data-level="11.4" data-path="case_cluster.html"><a href="case_cluster.html#analyzing-our-data"><i class="fa fa-check"></i><b>11.4</b> Analyzing our data</a></li>
<li class="chapter" data-level="11.5" data-path="case_cluster.html"><a href="case_cluster.html#the-simulation"><i class="fa fa-check"></i><b>11.5</b> The simulation</a></li>
<li class="chapter" data-level="11.6" data-path="case_cluster.html"><a href="case_cluster.html#analysis-of-our-single-scenario"><i class="fa fa-check"></i><b>11.6</b> Analysis of our single scenario</a>
<ul>
<li class="chapter" data-level="11.6.1" data-path="case_cluster.html"><a href="case_cluster.html#are-the-estimators-biased"><i class="fa fa-check"></i><b>11.6.1</b> Are the estimators biased?</a></li>
<li class="chapter" data-level="11.6.2" data-path="case_cluster.html"><a href="case_cluster.html#which-method-has-the-smallest-standard-error"><i class="fa fa-check"></i><b>11.6.2</b> Which method has the smallest standard error?</a></li>
<li class="chapter" data-level="11.6.3" data-path="case_cluster.html"><a href="case_cluster.html#which-method-has-the-smallest-root-mean-squared-error"><i class="fa fa-check"></i><b>11.6.3</b> Which method has the smallest Root Mean Squared Error?</a></li>
<li class="chapter" data-level="11.6.4" data-path="case_cluster.html"><a href="case_cluster.html#do-the-methods-have-correctly-estimated-standard-errors"><i class="fa fa-check"></i><b>11.6.4</b> Do the methods have correctly estimated standard errors?</a></li>
<li class="chapter" data-level="11.6.5" data-path="case_cluster.html"><a href="case_cluster.html#did-we-have-enough-simulation-trials"><i class="fa fa-check"></i><b>11.6.5</b> Did we have enough simulation trials?</a></li>
</ul></li>
<li class="chapter" data-level="11.7" data-path="case_cluster.html"><a href="case_cluster.html#extending-to-a-multifactor-simulation"><i class="fa fa-check"></i><b>11.7</b> Extending to a multifactor simulation</a></li>
<li class="chapter" data-level="11.8" data-path="case_cluster.html"><a href="case_cluster.html#standardization-in-a-data-generating-process"><i class="fa fa-check"></i><b>11.8</b> Standardization in a data generating process</a></li>
<li class="chapter" data-level="11.9" data-path="case_cluster.html"><a href="case_cluster.html#making-analyze_data-quiet"><i class="fa fa-check"></i><b>11.9</b> Making analyze_data() quiet</a></li>
<li class="chapter" data-level="11.10" data-path="case_cluster.html"><a href="case_cluster.html#where-to-compute-performance-measures-inside-vs.-outside"><i class="fa fa-check"></i><b>11.10</b> Where to compute performance measures: inside vs. outside?</a></li>
<li class="chapter" data-level="11.11" data-path="case_cluster.html"><a href="case_cluster.html#run-the-simulation"><i class="fa fa-check"></i><b>11.11</b> Run the simulation</a></li>
<li class="chapter" data-level="11.12" data-path="case_cluster.html"><a href="case_cluster.html#analyzing-our-results"><i class="fa fa-check"></i><b>11.12</b> Analyzing our results</a>
<ul>
<li class="chapter" data-level="11.12.1" data-path="case_cluster.html"><a href="case_cluster.html#checking-on-convergence-issues"><i class="fa fa-check"></i><b>11.12.1</b> Checking on convergence issues</a></li>
<li class="chapter" data-level="11.12.2" data-path="case_cluster.html"><a href="case_cluster.html#calculating-standard-metrics"><i class="fa fa-check"></i><b>11.12.2</b> Calculating standard metrics</a></li>
<li class="chapter" data-level="11.12.3" data-path="case_cluster.html"><a href="case_cluster.html#bias-analysis"><i class="fa fa-check"></i><b>11.12.3</b> Bias analysis</a></li>
</ul></li>
<li class="chapter" data-level="11.13" data-path="case_cluster.html"><a href="case_cluster.html#exercises-2"><i class="fa fa-check"></i><b>11.13</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="error-trapping-and-other-headaches.html"><a href="error-trapping-and-other-headaches.html"><i class="fa fa-check"></i><b>12</b> Error trapping and other headaches</a>
<ul>
<li class="chapter" data-level="12.1" data-path="error-trapping-and-other-headaches.html"><a href="error-trapping-and-other-headaches.html#safe_code"><i class="fa fa-check"></i><b>12.1</b> Safe code</a>
<ul>
<li class="chapter" data-level="12.1.1" data-path="error-trapping-and-other-headaches.html"><a href="error-trapping-and-other-headaches.html#what-to-do-with-warnings"><i class="fa fa-check"></i><b>12.1.1</b> What to do with warnings</a></li>
</ul></li>
<li class="chapter" data-level="12.2" data-path="error-trapping-and-other-headaches.html"><a href="error-trapping-and-other-headaches.html#saving-files-and-results"><i class="fa fa-check"></i><b>12.2</b> Saving files and results</a>
<ul>
<li class="chapter" data-level="12.2.1" data-path="error-trapping-and-other-headaches.html"><a href="error-trapping-and-other-headaches.html#saving-simulations-as-you-go"><i class="fa fa-check"></i><b>12.2.1</b> Saving simulations as you go</a></li>
<li class="chapter" data-level="12.2.2" data-path="error-trapping-and-other-headaches.html"><a href="error-trapping-and-other-headaches.html#dynamically-making-directories"><i class="fa fa-check"></i><b>12.2.2</b> Dynamically making directories</a></li>
<li class="chapter" data-level="12.2.3" data-path="error-trapping-and-other-headaches.html"><a href="error-trapping-and-other-headaches.html#loading-and-combining-files-of-simulation-results"><i class="fa fa-check"></i><b>12.2.3</b> Loading and combining files of simulation results</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="13" data-path="exp_design.html"><a href="exp_design.html"><i class="fa fa-check"></i><b>13</b> Designing the multifactor simulation experiment</a>
<ul>
<li class="chapter" data-level="13.1" data-path="exp_design.html"><a href="exp_design.html#choosing-parameter-combinations"><i class="fa fa-check"></i><b>13.1</b> Choosing parameter combinations</a></li>
<li class="chapter" data-level="13.2" data-path="exp_design.html"><a href="exp_design.html#using-pmap-to-run-multifactor-simulations"><i class="fa fa-check"></i><b>13.2</b> Using pmap to run multifactor simulations</a></li>
<li class="chapter" data-level="13.3" data-path="exp_design.html"><a href="exp_design.html#keeping-things-organized-and-the-source-command"><i class="fa fa-check"></i><b>13.3</b> Keeping things organized and the source command</a></li>
<li class="chapter" data-level="13.4" data-path="exp_design.html"><a href="exp_design.html#analyzing-results-from-a-multifactor-experiment"><i class="fa fa-check"></i><b>13.4</b> Analyzing results from a multifactor experiment</a>
<ul>
<li class="chapter" data-level="13.4.1" data-path="exp_design.html"><a href="exp_design.html#bundling"><i class="fa fa-check"></i><b>13.4.1</b> Bundling</a></li>
<li class="chapter" data-level="13.4.2" data-path="exp_design.html"><a href="exp_design.html#aggregation"><i class="fa fa-check"></i><b>13.4.2</b> Aggregation</a></li>
<li class="chapter" data-level="13.4.3" data-path="exp_design.html"><a href="exp_design.html#regression-summarization"><i class="fa fa-check"></i><b>13.4.3</b> Regression Summarization</a></li>
<li class="chapter" data-level="13.4.4" data-path="exp_design.html"><a href="exp_design.html#focus-on-subset-kick-rest-to-supplement"><i class="fa fa-check"></i><b>13.4.4</b> Focus on subset, kick rest to supplement</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="14" data-path="case-study-a-simulation-to-compare-different-estimators.html"><a href="case-study-a-simulation-to-compare-different-estimators.html"><i class="fa fa-check"></i><b>14</b> Case study: A simulation to compare different estimators</a>
<ul>
<li class="chapter" data-level="14.1" data-path="case-study-a-simulation-to-compare-different-estimators.html"><a href="case-study-a-simulation-to-compare-different-estimators.html#the-data-generating-process"><i class="fa fa-check"></i><b>14.1</b> The data generating process</a></li>
<li class="chapter" data-level="14.2" data-path="case-study-a-simulation-to-compare-different-estimators.html"><a href="case-study-a-simulation-to-compare-different-estimators.html#the-data-analysis-methods"><i class="fa fa-check"></i><b>14.2</b> The data analysis methods</a></li>
<li class="chapter" data-level="14.3" data-path="case-study-a-simulation-to-compare-different-estimators.html"><a href="case-study-a-simulation-to-compare-different-estimators.html#the-simulation-itself"><i class="fa fa-check"></i><b>14.3</b> The simulation itself</a></li>
<li class="chapter" data-level="14.4" data-path="case-study-a-simulation-to-compare-different-estimators.html"><a href="case-study-a-simulation-to-compare-different-estimators.html#calculating-performance-measures-for-all-our-estimators"><i class="fa fa-check"></i><b>14.4</b> Calculating performance measures for all our estimators</a></li>
<li class="chapter" data-level="14.5" data-path="case-study-a-simulation-to-compare-different-estimators.html"><a href="case-study-a-simulation-to-compare-different-estimators.html#improving-the-visualization-of-the-results"><i class="fa fa-check"></i><b>14.5</b> Improving the visualization of the results</a></li>
<li class="chapter" data-level="14.6" data-path="case-study-a-simulation-to-compare-different-estimators.html"><a href="case-study-a-simulation-to-compare-different-estimators.html#extension-the-bias-variance-tradeoff"><i class="fa fa-check"></i><b>14.6</b> Extension: The Bias-variance tradeoff</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="parallel-processing.html"><a href="parallel-processing.html"><i class="fa fa-check"></i><b>15</b> Parallel Processing</a>
<ul>
<li class="chapter" data-level="15.1" data-path="parallel-processing.html"><a href="parallel-processing.html#parallel-on-your-computer"><i class="fa fa-check"></i><b>15.1</b> Parallel on your computer</a></li>
<li class="chapter" data-level="15.2" data-path="parallel-processing.html"><a href="parallel-processing.html#parallel-off-your-computer"><i class="fa fa-check"></i><b>15.2</b> Parallel off your computer</a>
<ul>
<li class="chapter" data-level="15.2.1" data-path="parallel-processing.html"><a href="parallel-processing.html#what-is-a-command-line-interface"><i class="fa fa-check"></i><b>15.2.1</b> What is a command-line interface?</a></li>
<li class="chapter" data-level="15.2.2" data-path="parallel-processing.html"><a href="parallel-processing.html#running-a-job-on-a-cluster"><i class="fa fa-check"></i><b>15.2.2</b> Running a job on a cluster</a></li>
<li class="chapter" data-level="15.2.3" data-path="parallel-processing.html"><a href="parallel-processing.html#checking-on-a-job"><i class="fa fa-check"></i><b>15.2.3</b> Checking on a job</a></li>
<li class="chapter" data-level="15.2.4" data-path="parallel-processing.html"><a href="parallel-processing.html#running-lots-of-jobs-on-a-cluster"><i class="fa fa-check"></i><b>15.2.4</b> Running lots of jobs on a cluster</a></li>
<li class="chapter" data-level="15.2.5" data-path="parallel-processing.html"><a href="parallel-processing.html#resources-for-harvards-odyssey"><i class="fa fa-check"></i><b>15.2.5</b> Resources for Harvard’s Odyssey</a></li>
<li class="chapter" data-level="15.2.6" data-path="parallel-processing.html"><a href="parallel-processing.html#acknowledgements"><i class="fa fa-check"></i><b>15.2.6</b> Acknowledgements</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="16" data-path="case-study-the-power-and-validity-of-neymans-ate-estimate.html"><a href="case-study-the-power-and-validity-of-neymans-ate-estimate.html"><i class="fa fa-check"></i><b>16</b> Case study: The Power and Validity of Neyman’s ATE Estimate</a>
<ul>
<li class="chapter" data-level="16.1" data-path="case-study-the-power-and-validity-of-neymans-ate-estimate.html"><a href="case-study-the-power-and-validity-of-neymans-ate-estimate.html#step-1-write-a-function-for-a-specific-simulation-given-specific-parameters."><i class="fa fa-check"></i><b>16.1</b> Step 1: Write a function for a specific simulation given specific parameters.</a>
<ul>
<li class="chapter" data-level="16.1.1" data-path="case-study-the-power-and-validity-of-neymans-ate-estimate.html"><a href="case-study-the-power-and-validity-of-neymans-ate-estimate.html#running-our-single-trial-more-than-once"><i class="fa fa-check"></i><b>16.1.1</b> Running our single trial more than once</a></li>
</ul></li>
<li class="chapter" data-level="16.2" data-path="case-study-the-power-and-validity-of-neymans-ate-estimate.html"><a href="case-study-the-power-and-validity-of-neymans-ate-estimate.html#step-2-make-a-dataframe-of-all-experimental-combinations-desired"><i class="fa fa-check"></i><b>16.2</b> Step 2: Make a dataframe of all experimental combinations desired</a></li>
<li class="chapter" data-level="16.3" data-path="case-study-the-power-and-validity-of-neymans-ate-estimate.html"><a href="case-study-the-power-and-validity-of-neymans-ate-estimate.html#step-3-explore-results"><i class="fa fa-check"></i><b>16.3</b> Step 3: Explore results</a>
<ul>
<li class="chapter" data-level="16.3.1" data-path="case-study-the-power-and-validity-of-neymans-ate-estimate.html"><a href="case-study-the-power-and-validity-of-neymans-ate-estimate.html#visualizing-experimental-results"><i class="fa fa-check"></i><b>16.3.1</b> Visualizing experimental results</a></li>
<li class="chapter" data-level="16.3.2" data-path="case-study-the-power-and-validity-of-neymans-ate-estimate.html"><a href="case-study-the-power-and-validity-of-neymans-ate-estimate.html#looking-at-main-effects"><i class="fa fa-check"></i><b>16.3.2</b> Looking at main effects</a></li>
</ul></li>
<li class="chapter" data-level="16.4" data-path="case-study-the-power-and-validity-of-neymans-ate-estimate.html"><a href="case-study-the-power-and-validity-of-neymans-ate-estimate.html#addendum-saving-more-details"><i class="fa fa-check"></i><b>16.4</b> Addendum: Saving more details</a>
<ul>
<li class="chapter" data-level="16.4.1" data-path="case-study-the-power-and-validity-of-neymans-ate-estimate.html"><a href="case-study-the-power-and-validity-of-neymans-ate-estimate.html#getting-results-ready-for-analysis"><i class="fa fa-check"></i><b>16.4.1</b> Getting results ready for analysis</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="17" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html"><i class="fa fa-check"></i><b>17</b> Design, analysis, and presentation of simulation results</a>
<ul>
<li class="chapter" data-level="17.1" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html#designing-the-simulation-experiment"><i class="fa fa-check"></i><b>17.1</b> Designing the simulation experiment</a></li>
<li class="chapter" data-level="17.2" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html#choosing-parameter-levels"><i class="fa fa-check"></i><b>17.2</b> Choosing parameter levels</a></li>
<li class="chapter" data-level="17.3" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html#presentation"><i class="fa fa-check"></i><b>17.3</b> Presentation</a></li>
<li class="chapter" data-level="17.4" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html#tabulation"><i class="fa fa-check"></i><b>17.4</b> Tabulation</a></li>
<li class="chapter" data-level="17.5" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html#visualization"><i class="fa fa-check"></i><b>17.5</b> Visualization</a>
<ul>
<li class="chapter" data-level="17.5.1" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html#example-1-biserial-correlation-estimation"><i class="fa fa-check"></i><b>17.5.1</b> Example 1: Biserial correlation estimation</a></li>
<li class="chapter" data-level="17.5.2" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html#example-2-variance-estimation-and-meta-regression"><i class="fa fa-check"></i><b>17.5.2</b> Example 2: Variance estimation and Meta-regression</a></li>
<li class="chapter" data-level="17.5.3" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html#example-heat-maps-of-coverage"><i class="fa fa-check"></i><b>17.5.3</b> Example: Heat maps of coverage</a></li>
</ul></li>
<li class="chapter" data-level="17.6" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html#modeling"><i class="fa fa-check"></i><b>17.6</b> Modeling</a></li>
<li class="chapter" data-level="17.7" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html#presentation-1"><i class="fa fa-check"></i><b>17.7</b> Presentation</a></li>
</ul></li>
<li class="chapter" data-level="18" data-path="simulation-under-the-potential-outcomes-framework.html"><a href="simulation-under-the-potential-outcomes-framework.html"><i class="fa fa-check"></i><b>18</b> Simulation under the Potential Outcomes Framework</a>
<ul>
<li class="chapter" data-level="18.1" data-path="simulation-under-the-potential-outcomes-framework.html"><a href="simulation-under-the-potential-outcomes-framework.html#finite-vs.-superpopulation-inference"><i class="fa fa-check"></i><b>18.1</b> Finite vs. Superpopulation inference</a></li>
<li class="chapter" data-level="18.2" data-path="simulation-under-the-potential-outcomes-framework.html"><a href="simulation-under-the-potential-outcomes-framework.html#data-generation-processes-for-potential-outcomes"><i class="fa fa-check"></i><b>18.2</b> Data generation processes for potential outcomes</a></li>
<li class="chapter" data-level="18.3" data-path="simulation-under-the-potential-outcomes-framework.html"><a href="simulation-under-the-potential-outcomes-framework.html#finite-sample-performance-measures"><i class="fa fa-check"></i><b>18.3</b> Finite sample performance measures</a></li>
<li class="chapter" data-level="18.4" data-path="simulation-under-the-potential-outcomes-framework.html"><a href="simulation-under-the-potential-outcomes-framework.html#nested-finite-simulation-procedure"><i class="fa fa-check"></i><b>18.4</b> Nested finite simulation procedure</a></li>
<li class="chapter" data-level="18.5" data-path="simulation-under-the-potential-outcomes-framework.html"><a href="simulation-under-the-potential-outcomes-framework.html#calibrated-simulations-and-the-potential-outcomes-framework"><i class="fa fa-check"></i><b>18.5</b> Calibrated simulations and the potential outcomes framework</a></li>
</ul></li>
<li class="chapter" data-level="19" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html"><i class="fa fa-check"></i><b>19</b> Simulations as evidence</a>
<ul>
<li class="chapter" data-level="19.1" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#use-extensive-multi-factor-simulations"><i class="fa fa-check"></i><b>19.1</b> Use extensive multi-factor simulations</a></li>
<li class="chapter" data-level="19.2" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#beat-them-at-their-own-game"><i class="fa fa-check"></i><b>19.2</b> Beat them at their own game</a></li>
<li class="chapter" data-level="19.3" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#calibrated-simulations"><i class="fa fa-check"></i><b>19.3</b> Calibrated simulations</a></li>
</ul></li>
<li class="chapter" data-level="20" data-path="the-parametric-bootstrap.html"><a href="the-parametric-bootstrap.html"><i class="fa fa-check"></i><b>20</b> The Parametric bootstrap</a>
<ul>
<li class="chapter" data-level="20.1" data-path="the-parametric-bootstrap.html"><a href="the-parametric-bootstrap.html#air-conditioners-a-stolen-case-study"><i class="fa fa-check"></i><b>20.1</b> Air conditioners: a stolen case study</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Designing Monte Carlo Simulations in R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="error-trapping-and-other-headaches" class="section level1 hasAnchor" number="12">
<h1><span class="header-section-number">Chapter 12</span> Error trapping and other headaches<a href="error-trapping-and-other-headaches.html#error-trapping-and-other-headaches" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>If you have an advanced estimator, or are relying on some package, it is quite possible that every so often your estimate will trigger an error, or give you a NA result, or something similarly bad.
More innocuous, you might have estimators that can generate warnings; if you run 10,000 trials, that can add up to a lot of warnings which can be overwhelming to sort through.
In some cases, these warnings might be coupled with the estimator returning a very off result; it is unclear, in this case, whether we should include that result in our overall performance measures for that estimator.
After all, it tried to warn us!</p>
<p>In this section, we talk about some ways to make your simulations safe and robust, and also discuss some ways to track warnings and include them in peformance measures.</p>
<div id="safe_code" class="section level2 hasAnchor" number="12.1">
<h2><span class="header-section-number">12.1</span> Safe code<a href="error-trapping-and-other-headaches.html#safe_code" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Sometimes if you write a function that does a lot of complex things with
uncertain objects – i.e. consider a complex estimator using an unstable package not of your own creation – you can run into trouble where you have a intermittent error.</p>
<p>This can really be annoying; consider the case where your simulation crashes on 1 out of 500 chance: if you run 1000 simulation trials, your program will likely not make it to the end, thus wasting all of your time.
You can write code that can, instead of stopping when it reaches an error, trap the error and move on with the next simulation trial.</p>
<p>To illustrate, consider the following broken function:</p>
<div class="sourceCode" id="cb251"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb251-1"><a href="error-trapping-and-other-headaches.html#cb251-1" aria-hidden="true" tabindex="-1"></a>my_complex_function <span class="ot">=</span> <span class="cf">function</span>( param ) {</span>
<span id="cb251-2"><a href="error-trapping-and-other-headaches.html#cb251-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb251-3"><a href="error-trapping-and-other-headaches.html#cb251-3" aria-hidden="true" tabindex="-1"></a>    vals <span class="ot">=</span> <span class="fu">rnorm</span>( param, <span class="at">mean =</span> <span class="fl">0.5</span> )</span>
<span id="cb251-4"><a href="error-trapping-and-other-headaches.html#cb251-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ( <span class="fu">sum</span>( vals ) <span class="sc">&gt;</span> <span class="dv">5</span> ) {</span>
<span id="cb251-5"><a href="error-trapping-and-other-headaches.html#cb251-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">broken_code</span>( <span class="dv">4</span> )</span>
<span id="cb251-6"><a href="error-trapping-and-other-headaches.html#cb251-6" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb251-7"><a href="error-trapping-and-other-headaches.html#cb251-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sqrt</span>( <span class="fu">sum</span>( vals ) )</span>
<span id="cb251-8"><a href="error-trapping-and-other-headaches.html#cb251-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb251-9"><a href="error-trapping-and-other-headaches.html#cb251-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>We run it like so:</p>
<div class="sourceCode" id="cb252"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb252-1"><a href="error-trapping-and-other-headaches.html#cb252-1" aria-hidden="true" tabindex="-1"></a><span class="fu">my_complex_function</span>( <span class="dv">1</span> )</span></code></pre></div>
<pre><code>## [1] 1.233594</code></pre>
<div class="sourceCode" id="cb254"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb254-1"><a href="error-trapping-and-other-headaches.html#cb254-1" aria-hidden="true" tabindex="-1"></a><span class="fu">my_complex_function</span>( <span class="dv">7</span> )</span></code></pre></div>
<pre><code>## Error in broken_code(4): could not find function &quot;broken_code&quot;</code></pre>
<div class="sourceCode" id="cb256"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb256-1"><a href="error-trapping-and-other-headaches.html#cb256-1" aria-hidden="true" tabindex="-1"></a>resu <span class="ot">=</span> <span class="fu">rerun</span>( <span class="dv">20</span>, <span class="fu">my_complex_function</span>( <span class="dv">7</span> ) )</span></code></pre></div>
<pre><code>## Warning in sqrt(sum(vals)): NaNs produced</code></pre>
<pre><code>## Error in broken_code(4): could not find function &quot;broken_code&quot;</code></pre>
<p>Oh no! Our function crashes sometimes.
To trap the errors we use the purrr package to make a “safe” function as so:</p>
<div class="sourceCode" id="cb259"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb259-1"><a href="error-trapping-and-other-headaches.html#cb259-1" aria-hidden="true" tabindex="-1"></a>my_safe_function <span class="ot">=</span> <span class="fu">safely</span>( my_complex_function )</span>
<span id="cb259-2"><a href="error-trapping-and-other-headaches.html#cb259-2" aria-hidden="true" tabindex="-1"></a><span class="fu">my_safe_function</span>( <span class="dv">7</span> )</span></code></pre></div>
<pre><code>## $result
## [1] 1.340666
## 
## $error
## NULL</code></pre>
<p>There are other function wrappers in this family, such as “possibly”:</p>
<div class="sourceCode" id="cb261"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb261-1"><a href="error-trapping-and-other-headaches.html#cb261-1" aria-hidden="true" tabindex="-1"></a>my_possible_function <span class="ot">=</span> <span class="fu">possibly</span>( my_complex_function, </span>
<span id="cb261-2"><a href="error-trapping-and-other-headaches.html#cb261-2" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">otherwise =</span> <span class="cn">NA</span> )</span>
<span id="cb261-3"><a href="error-trapping-and-other-headaches.html#cb261-3" aria-hidden="true" tabindex="-1"></a><span class="fu">my_possible_function</span>( <span class="dv">7</span> )</span></code></pre></div>
<pre><code>## [1] 1.89293</code></pre>
<div class="sourceCode" id="cb263"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb263-1"><a href="error-trapping-and-other-headaches.html#cb263-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as.numeric</span>( <span class="fu">rerun</span>( <span class="dv">10</span>, <span class="fu">my_possible_function</span>(<span class="dv">7</span>) ) )</span></code></pre></div>
<pre><code>## Warning in sqrt(sum(vals)): NaNs produced</code></pre>
<pre><code>##  [1] 0.2912577 0.9354464       NaN 2.0169705 2.1757312        NA        NA
##  [8]        NA        NA 1.8955811</code></pre>
<p>Finally, we can use “quietly” to make warnings and stuff go away:</p>
<div class="sourceCode" id="cb266"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb266-1"><a href="error-trapping-and-other-headaches.html#cb266-1" aria-hidden="true" tabindex="-1"></a>my_quiet_function <span class="ot">=</span> <span class="fu">quietly</span>( my_complex_function )</span>
<span id="cb266-2"><a href="error-trapping-and-other-headaches.html#cb266-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-3"><a href="error-trapping-and-other-headaches.html#cb266-3" aria-hidden="true" tabindex="-1"></a><span class="fu">my_quiet_function</span>( <span class="dv">1</span> )</span></code></pre></div>
<pre><code>## $result
## [1] NaN
## 
## $output
## [1] &quot;&quot;
## 
## $warnings
## [1] &quot;NaNs produced&quot;
## 
## $messages
## character(0)</code></pre>
<p>This can be especially valuable to control massive amounts of printout in a simulation. If you have lots of extraneous printout, it can slow down the execution of your code far more than you might think.</p>
<div id="what-to-do-with-warnings" class="section level3 hasAnchor" number="12.1.1">
<h3><span class="header-section-number">12.1.1</span> What to do with warnings<a href="error-trapping-and-other-headaches.html#what-to-do-with-warnings" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Sometimes our analytic strategy might give some sort of warning (or fail altogether).
For example, from the cluster randomized experiment case study we have:</p>
<div class="sourceCode" id="cb268"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb268-1"><a href="error-trapping-and-other-headaches.html#cb268-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">101012</span>)  <span class="co"># (I picked this to show a warning.)</span></span>
<span id="cb268-2"><a href="error-trapping-and-other-headaches.html#cb268-2" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">=</span> <span class="fu">gen_dat_model</span>( <span class="at">J =</span> <span class="dv">50</span>, <span class="at">n_bar =</span> <span class="dv">100</span>, <span class="at">sigma2_u =</span> <span class="dv">0</span> )</span>
<span id="cb268-3"><a href="error-trapping-and-other-headaches.html#cb268-3" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">lmer</span>( Yobs <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> Z <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>sid), <span class="at">data=</span>dat )</span></code></pre></div>
<pre><code>## boundary (singular) fit: see help(&#39;isSingular&#39;)</code></pre>
<p>We have to make a deliberate decision as to what to do about this:</p>
<ul>
<li>Keep these “weird” trials?</li>
<li>Drop them?</li>
</ul>
<p>If you decide to drop them, you should drop the entire simulation iteration including the other estimators, even if they worked fine!
If there is something particularly unusual about the dataset, then dropping for one estimator, and keeping for the others that maybe didn’t give a warning, but did struggle to estimate the estimand, would be unfair: in the final performance measures the estimators that did not give a warning could be being held to a higher standard, making the comparisons between estimators biased.</p>
<p>If your estimators generate warnings, you should calculate the rate of errors or warning messages as a performance measure.
Especially if you drop some trials, it is important to see how often things are acting pecularly.</p>
<p>The main tool for doing this is the <code>quietly()</code> function:</p>
<div class="sourceCode" id="cb270"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb270-1"><a href="error-trapping-and-other-headaches.html#cb270-1" aria-hidden="true" tabindex="-1"></a>quiet_lmer <span class="ot">=</span> <span class="fu">quietly</span>( lmer )</span>
<span id="cb270-2"><a href="error-trapping-and-other-headaches.html#cb270-2" aria-hidden="true" tabindex="-1"></a>qmod <span class="ot">&lt;-</span> <span class="fu">quiet_lmer</span>( Yobs <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> Z <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>sid), <span class="at">data=</span>dat )</span>
<span id="cb270-3"><a href="error-trapping-and-other-headaches.html#cb270-3" aria-hidden="true" tabindex="-1"></a>qmod</span></code></pre></div>
<pre><code>## $result
## Linear mixed model fit by REML [&#39;lmerModLmerTest&#39;]
## Formula: ..1
##    Data: ..2
## REML criterion at convergence: 6485.293
## Random effects:
##  Groups   Name        Std.Dev.
##  sid      (Intercept) 0.0000  
##  Residual             0.9879  
## Number of obs: 2302, groups:  sid, 50
## Fixed Effects:
## (Intercept)            Z  
##    -0.03143      0.03433  
## optimizer (nloptwrap) convergence code: 0 (OK) ; 0 optimizer warnings; 1 lme4 warnings 
## 
## $output
## [1] &quot;&quot;
## 
## $warnings
## character(0)
## 
## $messages
## [1] &quot;boundary (singular) fit: see help(&#39;isSingular&#39;)\n&quot;</code></pre>
<p>You then might have, in your analyzing code:</p>
<div class="sourceCode" id="cb272"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb272-1"><a href="error-trapping-and-other-headaches.html#cb272-1" aria-hidden="true" tabindex="-1"></a>analyze_data <span class="ot">&lt;-</span> <span class="cf">function</span>( dat ) {</span>
<span id="cb272-2"><a href="error-trapping-and-other-headaches.html#cb272-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb272-3"><a href="error-trapping-and-other-headaches.html#cb272-3" aria-hidden="true" tabindex="-1"></a>    M1 <span class="ot">&lt;-</span> <span class="fu">quiet_lmer</span>( Yobs <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> Z <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>sid), <span class="at">data=</span>dat )</span>
<span id="cb272-4"><a href="error-trapping-and-other-headaches.html#cb272-4" aria-hidden="true" tabindex="-1"></a>    message1 <span class="ot">=</span> <span class="fu">ifelse</span>( <span class="fu">length</span>( M1<span class="sc">$</span>message ) <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span> )</span>
<span id="cb272-5"><a href="error-trapping-and-other-headaches.html#cb272-5" aria-hidden="true" tabindex="-1"></a>    warning1 <span class="ot">=</span> <span class="fu">ifelse</span>( <span class="fu">length</span>( M1<span class="sc">$</span>warning ) <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span> )</span>
<span id="cb272-6"><a href="error-trapping-and-other-headaches.html#cb272-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-7"><a href="error-trapping-and-other-headaches.html#cb272-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compile our results</span></span>
<span id="cb272-8"><a href="error-trapping-and-other-headaches.html#cb272-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>( <span class="at">ATE_hat =</span> <span class="fu">coef</span>(M1)[<span class="st">&quot;Z&quot;</span>],</span>
<span id="cb272-9"><a href="error-trapping-and-other-headaches.html#cb272-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">SE_hat =</span> <span class="fu">se.coef</span>(M1)[<span class="st">&quot;Z&quot;</span>],</span>
<span id="cb272-10"><a href="error-trapping-and-other-headaches.html#cb272-10" aria-hidden="true" tabindex="-1"></a>            <span class="at">message =</span> message1,</span>
<span id="cb272-11"><a href="error-trapping-and-other-headaches.html#cb272-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">warning =</span> warning1 )</span>
<span id="cb272-12"><a href="error-trapping-and-other-headaches.html#cb272-12" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Now you have your primary estimates, and also flags for whether there was a convergence issue.
In the analysis section you can then evaluate what proportion of the time there was a warning or message, and then do subset analyses to those simulation trials where there was no such warning.</p>
</div>
</div>
<div id="saving-files-and-results" class="section level2 hasAnchor" number="12.2">
<h2><span class="header-section-number">12.2</span> Saving files and results<a href="error-trapping-and-other-headaches.html#saving-files-and-results" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Always save your simulation results to a file.
Simulations are painful and time consuming to run, and you will invariably want to analyze the results of them in a variety of different ways, once you have looked at your preliminary analysis.
We advocate saving your simulation as soon as it is complete.
But there are some ways to do better than that, such as saving as you go.
This can protect you if your simulation occasionally crashes, or if you want to rerun only parts of your simulation for some reason.</p>
<div id="saving-simulations-as-you-go" class="section level3 hasAnchor" number="12.2.1">
<h3><span class="header-section-number">12.2.1</span> Saving simulations as you go<a href="error-trapping-and-other-headaches.html#saving-simulations-as-you-go" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>If you are not sure you have time to run your entire simulation, or you think your computer might crash half way through, or something similar, you can save each chunk you run as you go, in its own file. You then stack those files at the end to get your final results.
With clever design, you can even then selectively delete files to rerun only parts of your larger simulation—but be sure to rerun everything from scratch before you run off and publish your results, to avoid embarrassing errors.</p>
<p>Here, for example, is a script from a research project examining how one might use post-stratification to improve the precision of an IV estimate.
This is the script that runs the simulation.
Note the sourcing of other scripts that have all the relevant functions; these are not important here.
Due to modular programming, we can see what this script does, even without those detail.</p>
<div class="sourceCode" id="cb273"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb273-1"><a href="error-trapping-and-other-headaches.html#cb273-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>( <span class="st">&quot;pack_simulation_functions.R&quot;</span> )</span>
<span id="cb273-2"><a href="error-trapping-and-other-headaches.html#cb273-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb273-3"><a href="error-trapping-and-other-headaches.html#cb273-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> ( <span class="sc">!</span><span class="fu">file.exists</span>(<span class="st">&quot;results/frags&quot;</span> ) ) {</span>
<span id="cb273-4"><a href="error-trapping-and-other-headaches.html#cb273-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(<span class="st">&quot;results/frags&quot;</span>)</span>
<span id="cb273-5"><a href="error-trapping-and-other-headaches.html#cb273-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb273-6"><a href="error-trapping-and-other-headaches.html#cb273-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb273-7"><a href="error-trapping-and-other-headaches.html#cb273-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of simulation replicates per scenario</span></span>
<span id="cb273-8"><a href="error-trapping-and-other-headaches.html#cb273-8" aria-hidden="true" tabindex="-1"></a>R <span class="ot">=</span> <span class="dv">1000</span></span>
<span id="cb273-9"><a href="error-trapping-and-other-headaches.html#cb273-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb273-10"><a href="error-trapping-and-other-headaches.html#cb273-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Do simulation breaking up R into this many chunks</span></span>
<span id="cb273-11"><a href="error-trapping-and-other-headaches.html#cb273-11" aria-hidden="true" tabindex="-1"></a>M_CHUNK <span class="ot">=</span> <span class="dv">10</span></span>
<span id="cb273-12"><a href="error-trapping-and-other-headaches.html#cb273-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb273-13"><a href="error-trapping-and-other-headaches.html#cb273-13" aria-hidden="true" tabindex="-1"></a><span class="do">###### Set up the multifactor simulation #######</span></span>
<span id="cb273-14"><a href="error-trapping-and-other-headaches.html#cb273-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb273-15"><a href="error-trapping-and-other-headaches.html#cb273-15" aria-hidden="true" tabindex="-1"></a><span class="co"># chunkNo is a hack to make a bunch of smaller chunks for doing parallel more</span></span>
<span id="cb273-16"><a href="error-trapping-and-other-headaches.html#cb273-16" aria-hidden="true" tabindex="-1"></a><span class="co"># efficiently.</span></span>
<span id="cb273-17"><a href="error-trapping-and-other-headaches.html#cb273-17" aria-hidden="true" tabindex="-1"></a>factors <span class="ot">=</span> <span class="fu">expand_grid</span>( <span class="at">chunkNo =</span> <span class="dv">1</span><span class="sc">:</span>M_CHUNK,</span>
<span id="cb273-18"><a href="error-trapping-and-other-headaches.html#cb273-18" aria-hidden="true" tabindex="-1"></a>                       <span class="at">N =</span> <span class="fu">c</span>( <span class="dv">500</span>, <span class="dv">1000</span>, <span class="dv">2000</span> ),</span>
<span id="cb273-19"><a href="error-trapping-and-other-headaches.html#cb273-19" aria-hidden="true" tabindex="-1"></a>                       <span class="at">pi_c =</span> <span class="fu">c</span>( <span class="fl">0.05</span>, <span class="fl">0.075</span>, <span class="fl">0.10</span> ),</span>
<span id="cb273-20"><a href="error-trapping-and-other-headaches.html#cb273-20" aria-hidden="true" tabindex="-1"></a>                       <span class="at">nt_shift =</span> <span class="fu">c</span>( <span class="sc">-</span><span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span> ),</span>
<span id="cb273-21"><a href="error-trapping-and-other-headaches.html#cb273-21" aria-hidden="true" tabindex="-1"></a>                       <span class="at">pred_comp =</span> <span class="fu">c</span>( <span class="st">&quot;yes&quot;</span>, <span class="st">&quot;no&quot;</span> ),</span>
<span id="cb273-22"><a href="error-trapping-and-other-headaches.html#cb273-22" aria-hidden="true" tabindex="-1"></a>                       <span class="at">pred_Y =</span> <span class="fu">c</span>( <span class="st">&quot;yes&quot;</span>, <span class="st">&quot;no&quot;</span> ),</span>
<span id="cb273-23"><a href="error-trapping-and-other-headaches.html#cb273-23" aria-hidden="true" tabindex="-1"></a>                       <span class="at">het_tx =</span> <span class="fu">c</span>( <span class="st">&quot;yes&quot;</span>, <span class="st">&quot;no&quot;</span> ),</span>
<span id="cb273-24"><a href="error-trapping-and-other-headaches.html#cb273-24" aria-hidden="true" tabindex="-1"></a>                       <span class="at">sd0 =</span> <span class="dv">1</span></span>
<span id="cb273-25"><a href="error-trapping-and-other-headaches.html#cb273-25" aria-hidden="true" tabindex="-1"></a>                       )</span>
<span id="cb273-26"><a href="error-trapping-and-other-headaches.html#cb273-26" aria-hidden="true" tabindex="-1"></a>factors <span class="ot">&lt;-</span> factors <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb273-27"><a href="error-trapping-and-other-headaches.html#cb273-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">reps =</span> R <span class="sc">/</span> M_CHUNK,</span>
<span id="cb273-28"><a href="error-trapping-and-other-headaches.html#cb273-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">16200320</span> <span class="sc">+</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()</span>
<span id="cb273-29"><a href="error-trapping-and-other-headaches.html#cb273-29" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>This generates a data frame of all our factor combinations.
This is our list of “tasks” (each row of factors).
These tasks have repeats: the “chunks” means we do a portion of each scenario, as specified by our simulation factors, as a process.
This would allow for greater parallelization (e.g., if we had more cores), and also lets us save our work without finishing an entire scenario of, in this case, 1000 iterations.</p>
<p>To set up our simulation we make a little helper method to do one row.
With each row, once we have run it, we save it to disk.
This means if we kill our simulation half-way through, most of the work would be saved.
Our function is then going to either do the simulation (and save the result to disk immediately), or, if it can find the file with the results from a previous run, load those results from disk:</p>
<div class="sourceCode" id="cb274"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb274-1"><a href="error-trapping-and-other-headaches.html#cb274-1" aria-hidden="true" tabindex="-1"></a>safe_run_sim <span class="ot">=</span> <span class="fu">safely</span>( run_sim )</span>
<span id="cb274-2"><a href="error-trapping-and-other-headaches.html#cb274-2" aria-hidden="true" tabindex="-1"></a>file_saving_sim <span class="ot">=</span> <span class="cf">function</span>( chunkNo, seed, ... ) {</span>
<span id="cb274-3"><a href="error-trapping-and-other-headaches.html#cb274-3" aria-hidden="true" tabindex="-1"></a>    fname <span class="ot">=</span> <span class="fu">paste0</span>( <span class="st">&quot;results/frags/fragment_&quot;</span>, chunkNo, <span class="st">&quot;_&quot;</span>, seed, <span class="st">&quot;.rds&quot;</span> )</span>
<span id="cb274-4"><a href="error-trapping-and-other-headaches.html#cb274-4" aria-hidden="true" tabindex="-1"></a>    res <span class="ot">=</span> <span class="cn">NA</span></span>
<span id="cb274-5"><a href="error-trapping-and-other-headaches.html#cb274-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ( <span class="sc">!</span><span class="fu">file.exists</span>(fname) ) {</span>
<span id="cb274-6"><a href="error-trapping-and-other-headaches.html#cb274-6" aria-hidden="true" tabindex="-1"></a>        res <span class="ot">=</span> <span class="fu">safe_run_sim</span>( <span class="at">chunkNo=</span>chunkNo, <span class="at">seed=</span>seed, ... )</span>
<span id="cb274-7"><a href="error-trapping-and-other-headaches.html#cb274-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">saveRDS</span>(res, <span class="at">file =</span> fname )</span>
<span id="cb274-8"><a href="error-trapping-and-other-headaches.html#cb274-8" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb274-9"><a href="error-trapping-and-other-headaches.html#cb274-9" aria-hidden="true" tabindex="-1"></a>        res <span class="ot">=</span> <span class="fu">readRDS</span>( <span class="at">file=</span>fname )</span>
<span id="cb274-10"><a href="error-trapping-and-other-headaches.html#cb274-10" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb274-11"><a href="error-trapping-and-other-headaches.html#cb274-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>( res )</span>
<span id="cb274-12"><a href="error-trapping-and-other-headaches.html#cb274-12" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Note how we wrap our core <code>run_sim</code> method in <code>safely</code>; it was crashing very occasionally, and so to make the code more robust, we wrapped it so we could see any error messages.</p>
<p>We next run the simulation.
We shuffle the rows of our task list so that which process gets what task is randomized.
If some tasks are much longer (e.g., due to larger sample size) then this will get balanced out across our processes.</p>
<p>We have an <code>if-then</code> structure to easily switch between parallel and nonparallel code.
This makes debugging easier: when running in parallel, stuff printed to the console does not show until the simulation is over.
Plus it would be all mixed up since multiple processes are working simultaneously.</p>
<p>This overall structure allows the researcher to delete one of the “fragment” files from the disk, run the simulation code, and have it just do one tiny piece of the simulation.
This means the researcher can insert a <code>browser()</code> command somewhere inside the code, and debug the code, in the natural context of how the simulation is being run.</p>
<div class="sourceCode" id="cb275"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb275-1"><a href="error-trapping-and-other-headaches.html#cb275-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Shuffle the rows so we run in random order to load balance.</span></span>
<span id="cb275-2"><a href="error-trapping-and-other-headaches.html#cb275-2" aria-hidden="true" tabindex="-1"></a>factors <span class="ot">=</span> <span class="fu">sample_n</span>(factors, <span class="fu">nrow</span>(factors) )</span>
<span id="cb275-3"><a href="error-trapping-and-other-headaches.html#cb275-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb275-4"><a href="error-trapping-and-other-headaches.html#cb275-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> ( <span class="cn">TRUE</span> ) {</span>
<span id="cb275-5"><a href="error-trapping-and-other-headaches.html#cb275-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Run in parallel</span></span>
<span id="cb275-6"><a href="error-trapping-and-other-headaches.html#cb275-6" aria-hidden="true" tabindex="-1"></a>    parallel<span class="sc">::</span><span class="fu">detectCores</span>()</span>
<span id="cb275-7"><a href="error-trapping-and-other-headaches.html#cb275-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb275-8"><a href="error-trapping-and-other-headaches.html#cb275-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(future)</span>
<span id="cb275-9"><a href="error-trapping-and-other-headaches.html#cb275-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(furrr)</span>
<span id="cb275-10"><a href="error-trapping-and-other-headaches.html#cb275-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb275-11"><a href="error-trapping-and-other-headaches.html#cb275-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">#plan(multiprocess) # choose an appropriate plan from future package</span></span>
<span id="cb275-12"><a href="error-trapping-and-other-headaches.html#cb275-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">#plan(multicore)</span></span>
<span id="cb275-13"><a href="error-trapping-and-other-headaches.html#cb275-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plan</span>(multisession, <span class="at">workers =</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>() <span class="sc">-</span> <span class="dv">2</span> )</span>
<span id="cb275-14"><a href="error-trapping-and-other-headaches.html#cb275-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb275-15"><a href="error-trapping-and-other-headaches.html#cb275-15" aria-hidden="true" tabindex="-1"></a>    factors<span class="sc">$</span>res <span class="ot">&lt;-</span> <span class="fu">future_pmap</span>(factors, <span class="at">.f =</span> file_saving_sim,</span>
<span id="cb275-16"><a href="error-trapping-and-other-headaches.html#cb275-16" aria-hidden="true" tabindex="-1"></a>                          <span class="at">.options =</span> <span class="fu">furrr_options</span>(<span class="at">seed =</span> <span class="cn">NULL</span>),</span>
<span id="cb275-17"><a href="error-trapping-and-other-headaches.html#cb275-17" aria-hidden="true" tabindex="-1"></a>                          <span class="at">.progress =</span> <span class="cn">TRUE</span> )</span>
<span id="cb275-18"><a href="error-trapping-and-other-headaches.html#cb275-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb275-19"><a href="error-trapping-and-other-headaches.html#cb275-19" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb275-20"><a href="error-trapping-and-other-headaches.html#cb275-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Run not in parallel, used for debugging</span></span>
<span id="cb275-21"><a href="error-trapping-and-other-headaches.html#cb275-21" aria-hidden="true" tabindex="-1"></a>  factors<span class="sc">$</span>res <span class="ot">&lt;-</span> <span class="fu">pmap</span>(factors, <span class="at">.f =</span> file_saving_sim )</span>
<span id="cb275-22"><a href="error-trapping-and-other-headaches.html#cb275-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb275-23"><a href="error-trapping-and-other-headaches.html#cb275-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb275-24"><a href="error-trapping-and-other-headaches.html#cb275-24" aria-hidden="true" tabindex="-1"></a>tictoc<span class="sc">::</span><span class="fu">toc</span>()</span></code></pre></div>
<p>Our method cleverly loads files in, or generates them, for each chunk.
The seed setting ensures reproducibility.
Once we are done, we need to clean up our results:</p>
<div class="sourceCode" id="cb276"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb276-1"><a href="error-trapping-and-other-headaches.html#cb276-1" aria-hidden="true" tabindex="-1"></a>sim_results <span class="ot">&lt;-</span> </span>
<span id="cb276-2"><a href="error-trapping-and-other-headaches.html#cb276-2" aria-hidden="true" tabindex="-1"></a>    factors <span class="sc">%&gt;%</span> </span>
<span id="cb276-3"><a href="error-trapping-and-other-headaches.html#cb276-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unnest</span>(<span class="at">cols =</span> res)</span>
<span id="cb276-4"><a href="error-trapping-and-other-headaches.html#cb276-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb276-5"><a href="error-trapping-and-other-headaches.html#cb276-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Cut apart the results and error messages</span></span>
<span id="cb276-6"><a href="error-trapping-and-other-headaches.html#cb276-6" aria-hidden="true" tabindex="-1"></a>sim_results<span class="sc">$</span>sr <span class="ot">=</span> <span class="fu">rep</span>( <span class="fu">c</span>(<span class="st">&quot;res&quot;</span>,<span class="st">&quot;err&quot;</span>), <span class="fu">nrow</span>(sim_results)<span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb276-7"><a href="error-trapping-and-other-headaches.html#cb276-7" aria-hidden="true" tabindex="-1"></a>sim_results <span class="ot">=</span> <span class="fu">pivot_wider</span>( sim_results, <span class="at">names_from =</span> sr, <span class="at">values_from =</span> res )</span>
<span id="cb276-8"><a href="error-trapping-and-other-headaches.html#cb276-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb276-9"><a href="error-trapping-and-other-headaches.html#cb276-9" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>( sim_results, <span class="at">file=</span><span class="st">&quot;results/simulation_results.rds&quot;</span> )</span></code></pre></div>
</div>
<div id="dynamically-making-directories" class="section level3 hasAnchor" number="12.2.2">
<h3><span class="header-section-number">12.2.2</span> Dynamically making directories<a href="error-trapping-and-other-headaches.html#dynamically-making-directories" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>If you are generating a lot of files, then you should put them somewhere.
But where?
It is nice to dynamically generate a directory for your files on fly.
One way to do this is to write a function that will make any needed directory, if it doesn’t exist, and then put your file in that spot.
For example, you might have your own version of <code>write_csv</code> as:</p>
<div class="sourceCode" id="cb277"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb277-1"><a href="error-trapping-and-other-headaches.html#cb277-1" aria-hidden="true" tabindex="-1"></a>my_write_csv <span class="ot">&lt;-</span> <span class="cf">function</span>( data, path, file ) {</span>
<span id="cb277-2"><a href="error-trapping-and-other-headaches.html#cb277-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb277-3"><a href="error-trapping-and-other-headaches.html#cb277-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ( <span class="sc">!</span><span class="fu">dir.exists</span>( here<span class="sc">::</span><span class="fu">here</span>( path ) ) ) {</span>
<span id="cb277-4"><a href="error-trapping-and-other-headaches.html#cb277-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>( here<span class="sc">::</span><span class="fu">here</span>( path ), <span class="at">recursive=</span><span class="cn">TRUE</span> ) </span>
<span id="cb277-5"><a href="error-trapping-and-other-headaches.html#cb277-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb277-6"><a href="error-trapping-and-other-headaches.html#cb277-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>( data, <span class="fu">paste0</span>( path, file ) )</span>
<span id="cb277-7"><a href="error-trapping-and-other-headaches.html#cb277-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>This will look for a path (starting from your R Project, by taking advantage of the <code>here</code> package), and put your data file in that spot.
If the spot doesn’t exist, it will make it for you.</p>
</div>
<div id="loading-and-combining-files-of-simulation-results" class="section level3 hasAnchor" number="12.2.3">
<h3><span class="header-section-number">12.2.3</span> Loading and combining files of simulation results<a href="error-trapping-and-other-headaches.html#loading-and-combining-files-of-simulation-results" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Once your simulation files are all generated, the following code will stack them all into a giant set of results, assuming all the files are themselves data frames stored in RDS objects.
This function will try and stack all files found in a given directory; for it to work, you should ensure there are no other files stored there.</p>
<div class="sourceCode" id="cb278"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb278-1"><a href="error-trapping-and-other-headaches.html#cb278-1" aria-hidden="true" tabindex="-1"></a>load.all.sims <span class="ot">=</span> <span class="cf">function</span>( <span class="at">filehead=</span><span class="st">&quot;results/&quot;</span> ) {</span>
<span id="cb278-2"><a href="error-trapping-and-other-headaches.html#cb278-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb278-3"><a href="error-trapping-and-other-headaches.html#cb278-3" aria-hidden="true" tabindex="-1"></a>  files <span class="ot">=</span> <span class="fu">list.files</span>( filehead, <span class="at">full.names=</span><span class="cn">TRUE</span>)</span>
<span id="cb278-4"><a href="error-trapping-and-other-headaches.html#cb278-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb278-5"><a href="error-trapping-and-other-headaches.html#cb278-5" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">=</span> <span class="fu">map_df</span>( files, <span class="cf">function</span>( fname ) {</span>
<span id="cb278-6"><a href="error-trapping-and-other-headaches.html#cb278-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>( <span class="st">&quot;Reading results from &quot;</span>, fname, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span> )</span>
<span id="cb278-7"><a href="error-trapping-and-other-headaches.html#cb278-7" aria-hidden="true" tabindex="-1"></a>    rs <span class="ot">=</span> <span class="fu">readRDS</span>( <span class="at">file =</span> fname )</span>
<span id="cb278-8"><a href="error-trapping-and-other-headaches.html#cb278-8" aria-hidden="true" tabindex="-1"></a>    rs<span class="sc">$</span>filename <span class="ot">=</span> fname</span>
<span id="cb278-9"><a href="error-trapping-and-other-headaches.html#cb278-9" aria-hidden="true" tabindex="-1"></a>    rs</span>
<span id="cb278-10"><a href="error-trapping-and-other-headaches.html#cb278-10" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb278-11"><a href="error-trapping-and-other-headaches.html#cb278-11" aria-hidden="true" tabindex="-1"></a>  res</span>
<span id="cb278-12"><a href="error-trapping-and-other-headaches.html#cb278-12" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>You would use as so:</p>
<div class="sourceCode" id="cb279"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb279-1"><a href="error-trapping-and-other-headaches.html#cb279-1" aria-hidden="true" tabindex="-1"></a>results <span class="ot">=</span> <span class="fu">load.all.sims</span>( <span class="at">filehead=</span><span class="st">&quot;raw_results/&quot;</span> )</span></code></pre></div>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="case_cluster.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="exp_design.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/rstudio/bookdown-demo/edit/master/048-Error-traping.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["Designing-Simulations-in-R.pdf", "Designing-Simulations-in-R.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
