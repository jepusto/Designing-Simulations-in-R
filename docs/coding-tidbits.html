<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>A Coding Reference | Designing Monte Carlo Simulations in R</title>
  <meta name="description" content="A text on designing, implementing, and reporting on Monte Carlo simulation studies" />
  <meta name="generator" content="bookdown 0.43 and GitBook 2.6.7" />

  <meta property="og:title" content="A Coding Reference | Designing Monte Carlo Simulations in R" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="A text on designing, implementing, and reporting on Monte Carlo simulation studies" />
  <meta name="github-repo" content="jepusto/Designing-Simulations-in-R" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="A Coding Reference | Designing Monte Carlo Simulations in R" />
  
  <meta name="twitter:description" content="A text on designing, implementing, and reporting on Monte Carlo simulation studies" />
  

<meta name="author" content="Luke W. Miratrix and James E. Pustejovsky (Equal authors)" />


<meta name="date" content="2025-07-18" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="the-parametric-bootstrap.html"/>
<link rel="next" href="further-readings-and-resources.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Designing Simulations in R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#license"><i class="fa fa-check"></i>License</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#about-the-authors"><i class="fa fa-check"></i>About the authors</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#acknowledgements"><i class="fa fa-check"></i>Acknowledgements</a></li>
</ul></li>
<li class="part"><span><b>I An Introductory Look</b></span></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="introduction.html"><a href="introduction.html#some-of-simulations-many-uses"><i class="fa fa-check"></i><b>1.1</b> Some of simulation’s many uses</a>
<ul>
<li class="chapter" data-level="1.1.1" data-path="introduction.html"><a href="introduction.html#comparing-statistical-approaches"><i class="fa fa-check"></i><b>1.1.1</b> Comparing statistical approaches</a></li>
<li class="chapter" data-level="1.1.2" data-path="introduction.html"><a href="introduction.html#assessing-performance-of-complex-pipelines"><i class="fa fa-check"></i><b>1.1.2</b> Assessing performance of complex pipelines</a></li>
<li class="chapter" data-level="1.1.3" data-path="introduction.html"><a href="introduction.html#assessing-performance-under-misspecification"><i class="fa fa-check"></i><b>1.1.3</b> Assessing performance under misspecification</a></li>
<li class="chapter" data-level="1.1.4" data-path="introduction.html"><a href="introduction.html#assessing-the-finite-sample-performance-of-a-statistical-approach"><i class="fa fa-check"></i><b>1.1.4</b> Assessing the finite-sample performance of a statistical approach</a></li>
<li class="chapter" data-level="1.1.5" data-path="introduction.html"><a href="introduction.html#conducting-power-analyses"><i class="fa fa-check"></i><b>1.1.5</b> Conducting Power Analyses</a></li>
<li class="chapter" data-level="1.1.6" data-path="introduction.html"><a href="introduction.html#simulating-processess"><i class="fa fa-check"></i><b>1.1.6</b> Simulating processess</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="introduction.html"><a href="introduction.html#the-perils-of-simulation-as-evidence"><i class="fa fa-check"></i><b>1.2</b> The perils of simulation as evidence</a></li>
<li class="chapter" data-level="1.3" data-path="introduction.html"><a href="introduction.html#simulating-to-learn"><i class="fa fa-check"></i><b>1.3</b> Simulating to learn</a></li>
<li class="chapter" data-level="1.4" data-path="introduction.html"><a href="introduction.html#why-r"><i class="fa fa-check"></i><b>1.4</b> Why R?</a></li>
<li class="chapter" data-level="1.5" data-path="introduction.html"><a href="introduction.html#organization-of-the-text"><i class="fa fa-check"></i><b>1.5</b> Organization of the text</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html"><i class="fa fa-check"></i><b>2</b> Programming Preliminaries</a>
<ul>
<li class="chapter" data-level="2.1" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#welcome-to-the-tidyverse"><i class="fa fa-check"></i><b>2.1</b> Welcome to the tidyverse</a></li>
<li class="chapter" data-level="2.2" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#functions"><i class="fa fa-check"></i><b>2.2</b> Functions</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#rolling-your-own"><i class="fa fa-check"></i><b>2.2.1</b> Rolling your own</a></li>
<li class="chapter" data-level="2.2.2" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#a-dangerous-function"><i class="fa fa-check"></i><b>2.2.2</b> A dangerous function</a></li>
<li class="chapter" data-level="2.2.3" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#using-named-arguments"><i class="fa fa-check"></i><b>2.2.3</b> Using Named Arguments</a></li>
<li class="chapter" data-level="2.2.4" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#argument-defaults"><i class="fa fa-check"></i><b>2.2.4</b> Argument Defaults</a></li>
<li class="chapter" data-level="2.2.5" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#function-skeletons"><i class="fa fa-check"></i><b>2.2.5</b> Function skeletons</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#pipe-dreams"><i class="fa fa-check"></i><b>2.3</b> <code>\&gt;</code> (Pipe) dreams</a></li>
<li class="chapter" data-level="2.4" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#recipes-versus-patterns"><i class="fa fa-check"></i><b>2.4</b> Recipes versus Patterns</a></li>
<li class="chapter" data-level="2.5" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#exercises"><i class="fa fa-check"></i><b>2.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="t-test-simulation.html"><a href="t-test-simulation.html"><i class="fa fa-check"></i><b>3</b> An initial simulation</a>
<ul>
<li class="chapter" data-level="3.1" data-path="t-test-simulation.html"><a href="t-test-simulation.html#simulating-a-single-scenario"><i class="fa fa-check"></i><b>3.1</b> Simulating a single scenario</a></li>
<li class="chapter" data-level="3.2" data-path="t-test-simulation.html"><a href="t-test-simulation.html#a-non-normal-population-distribution"><i class="fa fa-check"></i><b>3.2</b> A non-normal population distribution</a></li>
<li class="chapter" data-level="3.3" data-path="t-test-simulation.html"><a href="t-test-simulation.html#simulating-across-different-scenarios"><i class="fa fa-check"></i><b>3.3</b> Simulating across different scenarios</a></li>
<li class="chapter" data-level="3.4" data-path="t-test-simulation.html"><a href="t-test-simulation.html#extending-the-simulation-design"><i class="fa fa-check"></i><b>3.4</b> Extending the simulation design</a></li>
<li class="chapter" data-level="3.5" data-path="t-test-simulation.html"><a href="t-test-simulation.html#exercises-1"><i class="fa fa-check"></i><b>3.5</b> Exercises</a></li>
</ul></li>
<li class="part"><span><b>II Structure and Mechanics of a Simulation Study</b></span></li>
<li class="chapter" data-level="4" data-path="simulation-structure.html"><a href="simulation-structure.html"><i class="fa fa-check"></i><b>4</b> Structure of a simulation study</a>
<ul>
<li class="chapter" data-level="4.1" data-path="simulation-structure.html"><a href="simulation-structure.html#general-structure-of-a-simulation"><i class="fa fa-check"></i><b>4.1</b> General structure of a simulation</a></li>
<li class="chapter" data-level="4.2" data-path="simulation-structure.html"><a href="simulation-structure.html#tidy-modular-simulations"><i class="fa fa-check"></i><b>4.2</b> Tidy, modular simulations</a></li>
<li class="chapter" data-level="4.3" data-path="simulation-structure.html"><a href="simulation-structure.html#skeleton-of-a-simulation-study"><i class="fa fa-check"></i><b>4.3</b> Skeleton of a simulation study</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="simulation-structure.html"><a href="simulation-structure.html#data-generating-process"><i class="fa fa-check"></i><b>4.3.1</b> Data-Generating Process</a></li>
<li class="chapter" data-level="4.3.2" data-path="simulation-structure.html"><a href="simulation-structure.html#data-analysis-procedure"><i class="fa fa-check"></i><b>4.3.2</b> Data Analysis Procedure</a></li>
<li class="chapter" data-level="4.3.3" data-path="simulation-structure.html"><a href="simulation-structure.html#repetition"><i class="fa fa-check"></i><b>4.3.3</b> Repetition</a></li>
<li class="chapter" data-level="4.3.4" data-path="simulation-structure.html"><a href="simulation-structure.html#performance-summaries"><i class="fa fa-check"></i><b>4.3.4</b> Performance summaries</a></li>
<li class="chapter" data-level="4.3.5" data-path="simulation-structure.html"><a href="simulation-structure.html#multifactor-simulations"><i class="fa fa-check"></i><b>4.3.5</b> Multifactor simulations</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="simulation-structure.html"><a href="simulation-structure.html#exercises-2"><i class="fa fa-check"></i><b>4.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="case-ANOVA.html"><a href="case-ANOVA.html"><i class="fa fa-check"></i><b>5</b> Case Study: Heteroskedastic ANOVA and Welch</a>
<ul>
<li class="chapter" data-level="5.1" data-path="case-ANOVA.html"><a href="case-ANOVA.html#case-anova-DGP"><i class="fa fa-check"></i><b>5.1</b> The data-generating model</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="case-ANOVA.html"><a href="case-ANOVA.html#now-make-a-function"><i class="fa fa-check"></i><b>5.1.1</b> Now make a function</a></li>
<li class="chapter" data-level="5.1.2" data-path="case-ANOVA.html"><a href="case-ANOVA.html#cautious-coding"><i class="fa fa-check"></i><b>5.1.2</b> Cautious coding</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="case-ANOVA.html"><a href="case-ANOVA.html#the-hypothesis-testing-procedures"><i class="fa fa-check"></i><b>5.2</b> The hypothesis testing procedures</a></li>
<li class="chapter" data-level="5.3" data-path="case-ANOVA.html"><a href="case-ANOVA.html#running-the-simulation"><i class="fa fa-check"></i><b>5.3</b> Running the simulation</a></li>
<li class="chapter" data-level="5.4" data-path="case-ANOVA.html"><a href="case-ANOVA.html#summarizing-test-performance"><i class="fa fa-check"></i><b>5.4</b> Summarizing test performance</a></li>
<li class="chapter" data-level="5.5" data-path="case-ANOVA.html"><a href="case-ANOVA.html#exAnovaExercises"><i class="fa fa-check"></i><b>5.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="data-generating-processes.html"><a href="data-generating-processes.html"><i class="fa fa-check"></i><b>6</b> Data-generating processes</a>
<ul>
<li class="chapter" data-level="6.1" data-path="data-generating-processes.html"><a href="data-generating-processes.html#DGP-examples"><i class="fa fa-check"></i><b>6.1</b> Examples</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="data-generating-processes.html"><a href="data-generating-processes.html#ANOVA-example"><i class="fa fa-check"></i><b>6.1.1</b> Example 1: One-way analysis of variance</a></li>
<li class="chapter" data-level="6.1.2" data-path="data-generating-processes.html"><a href="data-generating-processes.html#BVPois-example"><i class="fa fa-check"></i><b>6.1.2</b> Example 2: Bivariate Poisson model</a></li>
<li class="chapter" data-level="6.1.3" data-path="data-generating-processes.html"><a href="data-generating-processes.html#CRT-example"><i class="fa fa-check"></i><b>6.1.3</b> Example 3: Hierarchical linear model for a cluster-randomized trial</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="data-generating-processes.html"><a href="data-generating-processes.html#components-of-a-dgp"><i class="fa fa-check"></i><b>6.2</b> Components of a DGP</a></li>
<li class="chapter" data-level="6.3" data-path="data-generating-processes.html"><a href="data-generating-processes.html#DGP-functions"><i class="fa fa-check"></i><b>6.3</b> A statistical model is a recipe for data generation</a></li>
<li class="chapter" data-level="6.4" data-path="data-generating-processes.html"><a href="data-generating-processes.html#DGP-plotting"><i class="fa fa-check"></i><b>6.4</b> Plot the artificial data</a></li>
<li class="chapter" data-level="6.5" data-path="data-generating-processes.html"><a href="data-generating-processes.html#check-the-data-generating-function"><i class="fa fa-check"></i><b>6.5</b> Check the data-generating function</a></li>
<li class="chapter" data-level="6.6" data-path="data-generating-processes.html"><a href="data-generating-processes.html#case-cluster"><i class="fa fa-check"></i><b>6.6</b> Example: Simulating clustered data</a>
<ul>
<li class="chapter" data-level="6.6.1" data-path="data-generating-processes.html"><a href="data-generating-processes.html#a-design-decision-what-do-we-want-to-manipulate"><i class="fa fa-check"></i><b>6.6.1</b> A design decision: What do we want to manipulate?</a></li>
<li class="chapter" data-level="6.6.2" data-path="data-generating-processes.html"><a href="data-generating-processes.html#a-model-for-a-cluster-rct"><i class="fa fa-check"></i><b>6.6.2</b> A model for a cluster RCT</a></li>
<li class="chapter" data-level="6.6.3" data-path="data-generating-processes.html"><a href="data-generating-processes.html#from-equations-to-code"><i class="fa fa-check"></i><b>6.6.3</b> From equations to code</a></li>
<li class="chapter" data-level="6.6.4" data-path="data-generating-processes.html"><a href="data-generating-processes.html#DGP-standardization"><i class="fa fa-check"></i><b>6.6.4</b> Standardization in the DGP</a></li>
</ul></li>
<li class="chapter" data-level="6.7" data-path="data-generating-processes.html"><a href="data-generating-processes.html#three-parameter-IRT"><i class="fa fa-check"></i><b>6.7</b> Sometimes a DGP is all you need</a></li>
<li class="chapter" data-level="6.8" data-path="data-generating-processes.html"><a href="data-generating-processes.html#more-to-explore"><i class="fa fa-check"></i><b>6.8</b> More to explore</a></li>
<li class="chapter" data-level="6.9" data-path="data-generating-processes.html"><a href="data-generating-processes.html#exercises-3"><i class="fa fa-check"></i><b>6.9</b> Exercises</a>
<ul>
<li class="chapter" data-level="6.9.1" data-path="data-generating-processes.html"><a href="data-generating-processes.html#Welch-t-dgp"><i class="fa fa-check"></i><b>6.9.1</b> The Welch test on a shifted-and-scaled <span class="math inline">\(t\)</span> distribution</a></li>
<li class="chapter" data-level="6.9.2" data-path="data-generating-processes.html"><a href="data-generating-processes.html#plot-the-bivariate-poisson"><i class="fa fa-check"></i><b>6.9.2</b> Plot the bivariate Poisson</a></li>
<li class="chapter" data-level="6.9.3" data-path="data-generating-processes.html"><a href="data-generating-processes.html#BVP-check"><i class="fa fa-check"></i><b>6.9.3</b> Check the bivariate Poisson function</a></li>
<li class="chapter" data-level="6.9.4" data-path="data-generating-processes.html"><a href="data-generating-processes.html#BVP-error"><i class="fa fa-check"></i><b>6.9.4</b> Add error-catching to the bivariate Poisson function</a></li>
<li class="chapter" data-level="6.9.5" data-path="data-generating-processes.html"><a href="data-generating-processes.html#BVNB1"><i class="fa fa-check"></i><b>6.9.5</b> A bivariate negative binomial distribution</a></li>
<li class="chapter" data-level="6.9.6" data-path="data-generating-processes.html"><a href="data-generating-processes.html#BVNB2"><i class="fa fa-check"></i><b>6.9.6</b> Another bivariate negative binomial distribution</a></li>
<li class="chapter" data-level="6.9.7" data-path="data-generating-processes.html"><a href="data-generating-processes.html#cluster-RCT-plot"><i class="fa fa-check"></i><b>6.9.7</b> Plot the data from a cluster-randomized trial</a></li>
<li class="chapter" data-level="6.9.8" data-path="data-generating-processes.html"><a href="data-generating-processes.html#cluster-RCT-checks"><i class="fa fa-check"></i><b>6.9.8</b> Checking the Cluster RCT DGP</a></li>
<li class="chapter" data-level="6.9.9" data-path="data-generating-processes.html"><a href="data-generating-processes.html#cluster-RCT-heterogeneity"><i class="fa fa-check"></i><b>6.9.9</b> More school-level variation</a></li>
<li class="chapter" data-level="6.9.10" data-path="data-generating-processes.html"><a href="data-generating-processes.html#cluster-RCT-baseline"><i class="fa fa-check"></i><b>6.9.10</b> Cluster-randomized trial with baseline predictors</a></li>
<li class="chapter" data-level="6.9.11" data-path="data-generating-processes.html"><a href="data-generating-processes.html#IRT-DGP-parameters"><i class="fa fa-check"></i><b>6.9.11</b> 3-parameter IRT datasets</a></li>
<li class="chapter" data-level="6.9.12" data-path="data-generating-processes.html"><a href="data-generating-processes.html#IRT-DGP-checking"><i class="fa fa-check"></i><b>6.9.12</b> Check the 3-parameter IRT DGP</a></li>
<li class="chapter" data-level="6.9.13" data-path="data-generating-processes.html"><a href="data-generating-processes.html#IRT-DGP-breaking"><i class="fa fa-check"></i><b>6.9.13</b> Explore the 3-parameter IRT model</a></li>
<li class="chapter" data-level="6.9.14" data-path="data-generating-processes.html"><a href="data-generating-processes.html#meta-regression-DGP"><i class="fa fa-check"></i><b>6.9.14</b> Random effects meta-regression</a></li>
<li class="chapter" data-level="6.9.15" data-path="data-generating-processes.html"><a href="data-generating-processes.html#Vevea-Hedges-DGP"><i class="fa fa-check"></i><b>6.9.15</b> Meta-regression with selective reporting</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html"><i class="fa fa-check"></i><b>7</b> Data analysis procedures</a>
<ul>
<li class="chapter" data-level="7.1" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#estimation-functions"><i class="fa fa-check"></i><b>7.1</b> Writing estimation functions</a></li>
<li class="chapter" data-level="7.2" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#multiple-estimation-procedures"><i class="fa fa-check"></i><b>7.2</b> Including Multiple Data Analysis Procedures</a></li>
<li class="chapter" data-level="7.3" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#validating-an-estimation-function"><i class="fa fa-check"></i><b>7.3</b> Validating an Estimation Function</a>
<ul>
<li class="chapter" data-level="7.3.1" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#checking-against-existing-implementations"><i class="fa fa-check"></i><b>7.3.1</b> Checking against existing implementations</a></li>
<li class="chapter" data-level="7.3.2" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#checking-novel-procedures"><i class="fa fa-check"></i><b>7.3.2</b> Checking novel procedures</a></li>
<li class="chapter" data-level="7.3.3" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#checking-with-simulations"><i class="fa fa-check"></i><b>7.3.3</b> Checking with simulations</a></li>
</ul></li>
<li class="chapter" data-level="7.4" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#handling-errors-warnings-and-other-hiccups"><i class="fa fa-check"></i><b>7.4</b> Handling errors, warnings, and other hiccups</a>
<ul>
<li class="chapter" data-level="7.4.1" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#capturing-errors-and-warnings"><i class="fa fa-check"></i><b>7.4.1</b> Capturing errors and warnings</a></li>
<li class="chapter" data-level="7.4.2" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#adapting-for-errors"><i class="fa fa-check"></i><b>7.4.2</b> Adapting estimation procedures for errors and warnings</a></li>
</ul></li>
<li class="chapter" data-level="7.5" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#exercises-4"><i class="fa fa-check"></i><b>7.5</b> Exercises</a>
<ul>
<li class="chapter" data-level="7.5.1" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#BFFs-forever"><i class="fa fa-check"></i><b>7.5.1</b> More Heteroskedastic ANOVA</a></li>
<li class="chapter" data-level="7.5.2" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#contingent-testing"><i class="fa fa-check"></i><b>7.5.2</b> Contingent testing</a></li>
<li class="chapter" data-level="7.5.3" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#cross-check-CRT-estimators"><i class="fa fa-check"></i><b>7.5.3</b> Check the cluster-RCT functions</a></li>
<li class="chapter" data-level="7.5.4" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#CRT-ANCOVA-estimators"><i class="fa fa-check"></i><b>7.5.4</b> Extending the cluster-RCT functions</a></li>
<li class="chapter" data-level="7.5.5" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#contingent-estimator-processing"><i class="fa fa-check"></i><b>7.5.5</b> Contingent estimator processing</a></li>
<li class="chapter" data-level="7.5.6" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#IRT-3PL-estimation"><i class="fa fa-check"></i><b>7.5.6</b> Estimating 3-parameter item response theory models</a></li>
<li class="chapter" data-level="7.5.7" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#Vevea-Hedges-estimation"><i class="fa fa-check"></i><b>7.5.7</b> Meta-regression with selective reporting</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html"><i class="fa fa-check"></i><b>8</b> Running the Simulation Process</a>
<ul>
<li class="chapter" data-level="8.1" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#repeating-oneself"><i class="fa fa-check"></i><b>8.1</b> Repeating oneself</a></li>
<li class="chapter" data-level="8.2" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#one-run-at-a-time"><i class="fa fa-check"></i><b>8.2</b> One run at a time</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#one-run-reparameterization"><i class="fa fa-check"></i><b>8.2.1</b> Reparameterizing</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#bundle-sim-demo"><i class="fa fa-check"></i><b>8.3</b> Bundling simulations with <code>simhelpers</code></a></li>
<li class="chapter" data-level="8.4" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#seeds-and-pseudo-RNGs"><i class="fa fa-check"></i><b>8.4</b> Seeds and pseudo-random number generators</a></li>
<li class="chapter" data-level="8.5" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#exercises-5"><i class="fa fa-check"></i><b>8.5</b> Exercises</a>
<ul>
<li class="chapter" data-level="8.5.1" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#Welch-simulation"><i class="fa fa-check"></i><b>8.5.1</b> Welch simulations</a></li>
<li class="chapter" data-level="8.5.2" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#Pearson-sampling-distributions"><i class="fa fa-check"></i><b>8.5.2</b> Compare sampling distributions of Pearson’s correlation coefficients</a></li>
<li class="chapter" data-level="8.5.3" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#reparameterization-redux"><i class="fa fa-check"></i><b>8.5.3</b> Reparameterization, redux</a></li>
<li class="chapter" data-level="8.5.4" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#fancy-cluster-RCT-sims"><i class="fa fa-check"></i><b>8.5.4</b> Fancy clustered RCT simulations</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="performance-criteria.html"><a href="performance-criteria.html"><i class="fa fa-check"></i><b>9</b> Performance criteria</a>
<ul>
<li class="chapter" data-level="9.1" data-path="performance-criteria.html"><a href="performance-criteria.html#different-kinds-of-performance"><i class="fa fa-check"></i><b>9.1</b> Different kinds of performance</a></li>
<li class="chapter" data-level="9.2" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-a-point-estimator"><i class="fa fa-check"></i><b>9.2</b> Assessing a Point Estimator</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="performance-criteria.html"><a href="performance-criteria.html#comparing-the-performances-of-the-cluster-rct-estimation-procedures"><i class="fa fa-check"></i><b>9.2.1</b> Comparing the Performances of the Cluster RCT Estimation Procedures</a></li>
<li class="chapter" data-level="9.2.2" data-path="performance-criteria.html"><a href="performance-criteria.html#estimands-not-represented-by-a-parameter"><i class="fa fa-check"></i><b>9.2.2</b> Estimands Not Represented By a Parameter</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-a-standard-error-estimator"><i class="fa fa-check"></i><b>9.3</b> Assessing a Standard Error Estimator</a>
<ul>
<li class="chapter" data-level="9.3.1" data-path="performance-criteria.html"><a href="performance-criteria.html#why-not-assess-the-estimated-se-directly"><i class="fa fa-check"></i><b>9.3.1</b> Why Not Assess the Estimated SE directly?</a></li>
<li class="chapter" data-level="9.3.2" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-ses-for-our-cluster-rct-simulation"><i class="fa fa-check"></i><b>9.3.2</b> Assessing SEs for Our Cluster RCT Simulation</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-an-inferential-procedure-hypothesis-testing"><i class="fa fa-check"></i><b>9.4</b> Assessing an Inferential Procedure (Hypothesis Testing)</a>
<ul>
<li class="chapter" data-level="9.4.1" data-path="performance-criteria.html"><a href="performance-criteria.html#validity"><i class="fa fa-check"></i><b>9.4.1</b> Validity</a></li>
<li class="chapter" data-level="9.4.2" data-path="performance-criteria.html"><a href="performance-criteria.html#power"><i class="fa fa-check"></i><b>9.4.2</b> Power</a></li>
<li class="chapter" data-level="9.4.3" data-path="performance-criteria.html"><a href="performance-criteria.html#the-rejection-rate"><i class="fa fa-check"></i><b>9.4.3</b> The Rejection Rate</a></li>
<li class="chapter" data-level="9.4.4" data-path="performance-criteria.html"><a href="performance-criteria.html#inference-in-our-cluster-rct-simulation"><i class="fa fa-check"></i><b>9.4.4</b> Inference in our Cluster RCT Simulation</a></li>
</ul></li>
<li class="chapter" data-level="9.5" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-confidence-intervals"><i class="fa fa-check"></i><b>9.5</b> Assessing Confidence Intervals</a>
<ul>
<li class="chapter" data-level="9.5.1" data-path="performance-criteria.html"><a href="performance-criteria.html#confidence-intervals-in-our-cluster-rct-example"><i class="fa fa-check"></i><b>9.5.1</b> Confidence Intervals in our Cluster RCT Example</a></li>
</ul></li>
<li class="chapter" data-level="9.6" data-path="performance-criteria.html"><a href="performance-criteria.html#additional-thoughts-on-measuring-performance"><i class="fa fa-check"></i><b>9.6</b> Additional Thoughts on Measuring Performance</a>
<ul>
<li class="chapter" data-level="9.6.1" data-path="performance-criteria.html"><a href="performance-criteria.html#sec-relative-performance"><i class="fa fa-check"></i><b>9.6.1</b> Selecting Relative vs. Absolute Criteria</a></li>
<li class="chapter" data-level="9.6.2" data-path="performance-criteria.html"><a href="performance-criteria.html#robust-measures-of-performance"><i class="fa fa-check"></i><b>9.6.2</b> Robust Measures of Performance</a></li>
<li class="chapter" data-level="9.6.3" data-path="performance-criteria.html"><a href="performance-criteria.html#summary-of-peformance-measures"><i class="fa fa-check"></i><b>9.6.3</b> Summary of Peformance Measures</a></li>
</ul></li>
<li class="chapter" data-level="9.7" data-path="performance-criteria.html"><a href="performance-criteria.html#uncertainty-in-performance-estimates-the-monte-carlo-standard-error"><i class="fa fa-check"></i><b>9.7</b> Uncertainty in Performance Estimates (the Monte Carlo Standard Error)</a>
<ul>
<li class="chapter" data-level="9.7.1" data-path="performance-criteria.html"><a href="performance-criteria.html#mcse-for-relative-variance-estimators"><i class="fa fa-check"></i><b>9.7.1</b> MCSE for Relative Variance Estimators</a></li>
<li class="chapter" data-level="9.7.2" data-path="performance-criteria.html"><a href="performance-criteria.html#calculating-mcses-with-the-simhelpers-package"><i class="fa fa-check"></i><b>9.7.2</b> Calculating MCSEs With the <code>simhelpers</code> Package</a></li>
<li class="chapter" data-level="9.7.3" data-path="performance-criteria.html"><a href="performance-criteria.html#mcse-calculation-in-our-cluster-rct-example"><i class="fa fa-check"></i><b>9.7.3</b> MCSE Calculation in our Cluster RCT Example</a></li>
</ul></li>
<li class="chapter" data-level="9.8" data-path="performance-criteria.html"><a href="performance-criteria.html#exercises-6"><i class="fa fa-check"></i><b>9.8</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="case_Cronbach.html"><a href="case_Cronbach.html"><i class="fa fa-check"></i><b>10</b> Project: Cronbach Alpha</a>
<ul>
<li class="chapter" data-level="10.1" data-path="case_Cronbach.html"><a href="case_Cronbach.html#background"><i class="fa fa-check"></i><b>10.1</b> Background</a></li>
<li class="chapter" data-level="10.2" data-path="case_Cronbach.html"><a href="case_Cronbach.html#getting-started"><i class="fa fa-check"></i><b>10.2</b> Getting started</a></li>
<li class="chapter" data-level="10.3" data-path="case_Cronbach.html"><a href="case_Cronbach.html#the-data-generating-function"><i class="fa fa-check"></i><b>10.3</b> The data-generating function</a></li>
<li class="chapter" data-level="10.4" data-path="case_Cronbach.html"><a href="case_Cronbach.html#the-estimation-function"><i class="fa fa-check"></i><b>10.4</b> The estimation function</a>
<ul>
<li class="chapter" data-level="10.4.1" data-path="case_Cronbach.html"><a href="case_Cronbach.html#exercises-naive-confidence-intervals"><i class="fa fa-check"></i><b>10.4.1</b> Exercises (Naive confidence intervals)</a></li>
</ul></li>
<li class="chapter" data-level="10.5" data-path="case_Cronbach.html"><a href="case_Cronbach.html#estimator-performance"><i class="fa fa-check"></i><b>10.5</b> Estimator performance</a>
<ul>
<li class="chapter" data-level="10.5.1" data-path="case_Cronbach.html"><a href="case_Cronbach.html#exercises-calculating-performance"><i class="fa fa-check"></i><b>10.5.1</b> Exercises (Calculating Performance)</a></li>
</ul></li>
<li class="chapter" data-level="10.6" data-path="case_Cronbach.html"><a href="case_Cronbach.html#replication-and-the-simulation"><i class="fa fa-check"></i><b>10.6</b> Replication (and the simulation)</a></li>
<li class="chapter" data-level="10.7" data-path="case_Cronbach.html"><a href="case_Cronbach.html#extension-confidence-interval-coverage"><i class="fa fa-check"></i><b>10.7</b> Extension: Confidence interval coverage</a></li>
<li class="chapter" data-level="10.8" data-path="case_Cronbach.html"><a href="case_Cronbach.html#a-taste-of-multiple-scenarios"><i class="fa fa-check"></i><b>10.8</b> A taste of multiple scenarios</a>
<ul>
<li class="chapter" data-level="10.8.1" data-path="case_Cronbach.html"><a href="case_Cronbach.html#exercises-7"><i class="fa fa-check"></i><b>10.8.1</b> Exercises</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>III Multifactor Simulations</b></span></li>
<li class="chapter" data-level="11" data-path="exp-design.html"><a href="exp-design.html"><i class="fa fa-check"></i><b>11</b> Designing the multifactor simulation experiment</a>
<ul>
<li class="chapter" data-level="11.1" data-path="exp-design.html"><a href="exp-design.html#choosing-parameter-combinations"><i class="fa fa-check"></i><b>11.1</b> Choosing parameter combinations</a>
<ul>
<li class="chapter" data-level="11.1.1" data-path="exp-design.html"><a href="exp-design.html#choosing-parameters-for-the-clustered-rct"><i class="fa fa-check"></i><b>11.1.1</b> Choosing parameters for the Clustered RCT</a></li>
<li class="chapter" data-level="11.1.2" data-path="exp-design.html"><a href="exp-design.html#redundant-factor-combinations"><i class="fa fa-check"></i><b>11.1.2</b> Redundant factor combinations</a></li>
</ul></li>
<li class="chapter" data-level="11.2" data-path="exp-design.html"><a href="exp-design.html#using-pmap-to-run-multifactor-simulations"><i class="fa fa-check"></i><b>11.2</b> Using pmap to run multifactor simulations</a></li>
<li class="chapter" data-level="11.3" data-path="exp-design.html"><a href="exp-design.html#when-to-calculate-performance-metrics-when-running-multiple-simulations"><i class="fa fa-check"></i><b>11.3</b> When to calculate performance metrics when running multiple simulations</a>
<ul>
<li class="chapter" data-level="11.3.1" data-path="exp-design.html"><a href="exp-design.html#aggregate-as-you-simulate-inside"><i class="fa fa-check"></i><b>11.3.1</b> Aggregate as you simulate (inside)</a></li>
<li class="chapter" data-level="11.3.2" data-path="exp-design.html"><a href="exp-design.html#keep-all-simulation-runs-outside"><i class="fa fa-check"></i><b>11.3.2</b> Keep all simulation runs (outside)</a></li>
<li class="chapter" data-level="11.3.3" data-path="exp-design.html"><a href="exp-design.html#getting-raw-results-ready-for-analysis"><i class="fa fa-check"></i><b>11.3.3</b> Getting raw results ready for analysis</a></li>
</ul></li>
<li class="chapter" data-level="11.4" data-path="exp-design.html"><a href="exp-design.html#running-the-cluster-rct-multifactor-experiment"><i class="fa fa-check"></i><b>11.4</b> Running the Cluster RCT multifactor experiment</a>
<ul>
<li class="chapter" data-level="11.4.1" data-path="exp-design.html"><a href="exp-design.html#calculating-performance-metrics"><i class="fa fa-check"></i><b>11.4.1</b> Calculating performance metrics</a></li>
<li class="chapter" data-level="11.4.2" data-path="exp-design.html"><a href="exp-design.html#making-analyze_data-quiet"><i class="fa fa-check"></i><b>11.4.2</b> Making analyze_data() quiet</a></li>
</ul></li>
<li class="chapter" data-level="11.5" data-path="exp-design.html"><a href="exp-design.html#exercises-8"><i class="fa fa-check"></i><b>11.5</b> Exercises</a>
<ul>
<li class="chapter" data-level="11.5.1" data-path="exp-design.html"><a href="exp-design.html#exercise:trimmed-mean"><i class="fa fa-check"></i><b>11.5.1</b> Comparing the trimmed mean, median and mean</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="12" data-path="presentation-of-results.html"><a href="presentation-of-results.html"><i class="fa fa-check"></i><b>12</b> Presenting multifactor simulation results</a>
<ul>
<li class="chapter" data-level="12.1" data-path="presentation-of-results.html"><a href="presentation-of-results.html#tabulation"><i class="fa fa-check"></i><b>12.1</b> Tabulation</a>
<ul>
<li class="chapter" data-level="12.1.1" data-path="presentation-of-results.html"><a href="presentation-of-results.html#example-estimators-of-treatment-variation"><i class="fa fa-check"></i><b>12.1.1</b> Example: estimators of treatment variation</a></li>
</ul></li>
<li class="chapter" data-level="12.2" data-path="presentation-of-results.html"><a href="presentation-of-results.html#visualization"><i class="fa fa-check"></i><b>12.2</b> Visualization</a>
<ul>
<li class="chapter" data-level="12.2.1" data-path="presentation-of-results.html"><a href="presentation-of-results.html#example-1-biserial-correlation-estimation"><i class="fa fa-check"></i><b>12.2.1</b> Example 1: Biserial correlation estimation</a></li>
<li class="chapter" data-level="12.2.2" data-path="presentation-of-results.html"><a href="presentation-of-results.html#example-2-variance-estimation-and-meta-regression"><i class="fa fa-check"></i><b>12.2.2</b> Example 2: Variance estimation and Meta-regression</a></li>
<li class="chapter" data-level="12.2.3" data-path="presentation-of-results.html"><a href="presentation-of-results.html#example-3-heat-maps-of-coverage"><i class="fa fa-check"></i><b>12.2.3</b> Example 3: Heat maps of coverage</a></li>
<li class="chapter" data-level="12.2.4" data-path="presentation-of-results.html"><a href="presentation-of-results.html#example-4-relative-performance-of-treatment-effect-estimators"><i class="fa fa-check"></i><b>12.2.4</b> Example 4: Relative performance of treatment effect estimators</a></li>
</ul></li>
<li class="chapter" data-level="12.3" data-path="presentation-of-results.html"><a href="presentation-of-results.html#modeling"><i class="fa fa-check"></i><b>12.3</b> Modeling</a>
<ul>
<li class="chapter" data-level="12.3.1" data-path="presentation-of-results.html"><a href="presentation-of-results.html#example-1-biserial-revisited"><i class="fa fa-check"></i><b>12.3.1</b> Example 1: Biserial, revisited</a></li>
<li class="chapter" data-level="12.3.2" data-path="presentation-of-results.html"><a href="presentation-of-results.html#example-2-comparing-methods-for-cross-classified-data"><i class="fa fa-check"></i><b>12.3.2</b> Example 2: Comparing methods for cross-classified data</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="13" data-path="building-good-vizualizations.html"><a href="building-good-vizualizations.html"><i class="fa fa-check"></i><b>13</b> Building good vizualizations</a>
<ul>
<li class="chapter" data-level="13.1" data-path="building-good-vizualizations.html"><a href="building-good-vizualizations.html#subsetting-and-many-small-multiples"><i class="fa fa-check"></i><b>13.1</b> Subsetting and Many Small Multiples</a></li>
<li class="chapter" data-level="13.2" data-path="building-good-vizualizations.html"><a href="building-good-vizualizations.html#bundling"><i class="fa fa-check"></i><b>13.2</b> Bundling</a></li>
<li class="chapter" data-level="13.3" data-path="building-good-vizualizations.html"><a href="building-good-vizualizations.html#aggregation"><i class="fa fa-check"></i><b>13.3</b> Aggregation</a></li>
<li class="chapter" data-level="13.4" data-path="building-good-vizualizations.html"><a href="building-good-vizualizations.html#assessing-true-ses"><i class="fa fa-check"></i><b>13.4</b> Assessing true SEs</a></li>
<li class="chapter" data-level="13.5" data-path="building-good-vizualizations.html"><a href="building-good-vizualizations.html#the-bias-se-rmse-plot"><i class="fa fa-check"></i><b>13.5</b> The Bias-SE-RMSE plot</a></li>
<li class="chapter" data-level="13.6" data-path="building-good-vizualizations.html"><a href="building-good-vizualizations.html#assessing-estimated-ses"><i class="fa fa-check"></i><b>13.6</b> Assessing estimated SEs</a></li>
<li class="chapter" data-level="13.7" data-path="building-good-vizualizations.html"><a href="building-good-vizualizations.html#assessing-confidence-intervals-1"><i class="fa fa-check"></i><b>13.7</b> Assessing confidence intervals</a></li>
<li class="chapter" data-level="13.8" data-path="building-good-vizualizations.html"><a href="building-good-vizualizations.html#exercises-9"><i class="fa fa-check"></i><b>13.8</b> Exercises</a>
<ul>
<li class="chapter" data-level="13.8.1" data-path="building-good-vizualizations.html"><a href="building-good-vizualizations.html#assessing-uncertainty"><i class="fa fa-check"></i><b>13.8.1</b> Assessing uncertainty</a></li>
<li class="chapter" data-level="13.8.2" data-path="building-good-vizualizations.html"><a href="building-good-vizualizations.html#assessing-power"><i class="fa fa-check"></i><b>13.8.2</b> Assessing power</a></li>
<li class="chapter" data-level="13.8.3" data-path="building-good-vizualizations.html"><a href="building-good-vizualizations.html#going-deeper-with-coverage"><i class="fa fa-check"></i><b>13.8.3</b> Going deeper with coverage</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="14" data-path="special-topics-on-reporting-simulation-results.html"><a href="special-topics-on-reporting-simulation-results.html"><i class="fa fa-check"></i><b>14</b> Special Topics on Reporting Simulation Results</a>
<ul>
<li class="chapter" data-level="14.1" data-path="special-topics-on-reporting-simulation-results.html"><a href="special-topics-on-reporting-simulation-results.html#using-regression-to-analyze-simulation-results"><i class="fa fa-check"></i><b>14.1</b> Using regression to analyze simulation results</a>
<ul>
<li class="chapter" data-level="14.1.1" data-path="special-topics-on-reporting-simulation-results.html"><a href="special-topics-on-reporting-simulation-results.html#example-1-biserial-revisited-1"><i class="fa fa-check"></i><b>14.1.1</b> Example 1: Biserial, revisited</a></li>
<li class="chapter" data-level="14.1.2" data-path="special-topics-on-reporting-simulation-results.html"><a href="special-topics-on-reporting-simulation-results.html#example-2-cluster-rct-example-revisited"><i class="fa fa-check"></i><b>14.1.2</b> Example 2: Cluster RCT example, revisited</a></li>
</ul></li>
<li class="chapter" data-level="14.2" data-path="special-topics-on-reporting-simulation-results.html"><a href="special-topics-on-reporting-simulation-results.html#using-regression-trees-to-find-important-factors"><i class="fa fa-check"></i><b>14.2</b> Using regression trees to find important factors</a></li>
<li class="chapter" data-level="14.3" data-path="special-topics-on-reporting-simulation-results.html"><a href="special-topics-on-reporting-simulation-results.html#analyzing-results-with-few-iterations-per-scenario"><i class="fa fa-check"></i><b>14.3</b> Analyzing results with few iterations per scenario</a>
<ul>
<li class="chapter" data-level="14.3.1" data-path="special-topics-on-reporting-simulation-results.html"><a href="special-topics-on-reporting-simulation-results.html#example-clusterrct-with-only-100-replicates-per-scenario"><i class="fa fa-check"></i><b>14.3.1</b> Example: ClusterRCT with only 100 replicates per scenario</a></li>
</ul></li>
<li class="chapter" data-level="14.4" data-path="special-topics-on-reporting-simulation-results.html"><a href="special-topics-on-reporting-simulation-results.html#what-to-do-with-warnings-in-simulations"><i class="fa fa-check"></i><b>14.4</b> What to do with warnings in simulations</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="case-study-comparing-different-estimators.html"><a href="case-study-comparing-different-estimators.html"><i class="fa fa-check"></i><b>15</b> Case study: Comparing different estimators</a>
<ul>
<li class="chapter" data-level="15.1" data-path="case-study-comparing-different-estimators.html"><a href="case-study-comparing-different-estimators.html#bias-variance-tradeoffs"><i class="fa fa-check"></i><b>15.1</b> Bias-variance tradeoffs</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html"><i class="fa fa-check"></i><b>16</b> Simulations as evidence</a>
<ul>
<li class="chapter" data-level="16.1" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#strategies-for-making-relevant-simulations"><i class="fa fa-check"></i><b>16.1</b> Strategies for making relevant simulations</a>
<ul>
<li class="chapter" data-level="16.1.1" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#make-your-simulation-general-with-an-extensive-multi-factor-experiment"><i class="fa fa-check"></i><b>16.1.1</b> Make your simulation general with an extensive multi-factor experiment</a></li>
<li class="chapter" data-level="16.1.2" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#use-previously-published-simulations-to-beat-them-at-their-own-game"><i class="fa fa-check"></i><b>16.1.2</b> Use previously published simulations to beat them at their own game</a></li>
<li class="chapter" data-level="16.1.3" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#calibrate-simulation-factors-to-real-data"><i class="fa fa-check"></i><b>16.1.3</b> Calibrate simulation factors to real data</a></li>
<li class="chapter" data-level="16.1.4" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#use-real-data-to-obtain-directly"><i class="fa fa-check"></i><b>16.1.4</b> Use real data to obtain directly</a></li>
<li class="chapter" data-level="16.1.5" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#fully-calibrated-simulations"><i class="fa fa-check"></i><b>16.1.5</b> Fully calibrated simulations</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>IV Computational Considerations</b></span></li>
<li class="chapter" data-level="17" data-path="organizing-a-simulation-project.html"><a href="organizing-a-simulation-project.html"><i class="fa fa-check"></i><b>17</b> Organizing a simulation project</a>
<ul>
<li class="chapter" data-level="17.1" data-path="organizing-a-simulation-project.html"><a href="organizing-a-simulation-project.html#well-structured-r-scripts"><i class="fa fa-check"></i><b>17.1</b> Well structured R scripts</a>
<ul>
<li class="chapter" data-level="17.1.1" data-path="organizing-a-simulation-project.html"><a href="organizing-a-simulation-project.html#about-source-command"><i class="fa fa-check"></i><b>17.1.1</b> The source command</a></li>
<li class="chapter" data-level="17.1.2" data-path="organizing-a-simulation-project.html"><a href="organizing-a-simulation-project.html#putting-headers-in-your-.r-file"><i class="fa fa-check"></i><b>17.1.2</b> Putting headers in your .R file</a></li>
<li class="chapter" data-level="17.1.3" data-path="organizing-a-simulation-project.html"><a href="organizing-a-simulation-project.html#about-keeping-tests-with-FALSE"><i class="fa fa-check"></i><b>17.1.3</b> Storing testing code in your scripts</a></li>
</ul></li>
<li class="chapter" data-level="17.2" data-path="organizing-a-simulation-project.html"><a href="organizing-a-simulation-project.html#principled-directory-structures"><i class="fa fa-check"></i><b>17.2</b> Principled directory structures</a></li>
<li class="chapter" data-level="17.3" data-path="organizing-a-simulation-project.html"><a href="organizing-a-simulation-project.html#saving-files"><i class="fa fa-check"></i><b>17.3</b> Saving simulation results</a>
<ul>
<li class="chapter" data-level="17.3.1" data-path="organizing-a-simulation-project.html"><a href="organizing-a-simulation-project.html#saving-simulations-in-general"><i class="fa fa-check"></i><b>17.3.1</b> Saving simulations in general</a></li>
<li class="chapter" data-level="17.3.2" data-path="organizing-a-simulation-project.html"><a href="organizing-a-simulation-project.html#saving-simulations-as-you-go"><i class="fa fa-check"></i><b>17.3.2</b> Saving simulations as you go</a></li>
<li class="chapter" data-level="17.3.3" data-path="organizing-a-simulation-project.html"><a href="organizing-a-simulation-project.html#dynamically-making-directories"><i class="fa fa-check"></i><b>17.3.3</b> Dynamically making directories</a></li>
<li class="chapter" data-level="17.3.4" data-path="organizing-a-simulation-project.html"><a href="organizing-a-simulation-project.html#loading-and-combining-files-of-simulation-results"><i class="fa fa-check"></i><b>17.3.4</b> Loading and combining files of simulation results</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="18" data-path="parallel-processing.html"><a href="parallel-processing.html"><i class="fa fa-check"></i><b>18</b> Parallel Processing</a>
<ul>
<li class="chapter" data-level="18.1" data-path="parallel-processing.html"><a href="parallel-processing.html#parallel-on-your-computer"><i class="fa fa-check"></i><b>18.1</b> Parallel on your computer</a></li>
<li class="chapter" data-level="18.2" data-path="parallel-processing.html"><a href="parallel-processing.html#parallel-off-your-computer"><i class="fa fa-check"></i><b>18.2</b> Parallel off your computer</a>
<ul>
<li class="chapter" data-level="18.2.1" data-path="parallel-processing.html"><a href="parallel-processing.html#what-is-a-command-line-interface"><i class="fa fa-check"></i><b>18.2.1</b> What is a command-line interface?</a></li>
<li class="chapter" data-level="18.2.2" data-path="parallel-processing.html"><a href="parallel-processing.html#running-a-job-on-a-cluster"><i class="fa fa-check"></i><b>18.2.2</b> Running a job on a cluster</a></li>
<li class="chapter" data-level="18.2.3" data-path="parallel-processing.html"><a href="parallel-processing.html#checking-on-a-job"><i class="fa fa-check"></i><b>18.2.3</b> Checking on a job</a></li>
<li class="chapter" data-level="18.2.4" data-path="parallel-processing.html"><a href="parallel-processing.html#running-lots-of-jobs-on-a-cluster"><i class="fa fa-check"></i><b>18.2.4</b> Running lots of jobs on a cluster</a></li>
<li class="chapter" data-level="18.2.5" data-path="parallel-processing.html"><a href="parallel-processing.html#resources-for-harvards-odyssey"><i class="fa fa-check"></i><b>18.2.5</b> Resources for Harvard’s Odyssey</a></li>
<li class="chapter" data-level="18.2.6" data-path="parallel-processing.html"><a href="parallel-processing.html#acknowledgements-1"><i class="fa fa-check"></i><b>18.2.6</b> Acknowledgements</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="19" data-path="debugging-and-testing.html"><a href="debugging-and-testing.html"><i class="fa fa-check"></i><b>19</b> Debugging and Testing</a>
<ul>
<li class="chapter" data-level="19.1" data-path="debugging-and-testing.html"><a href="debugging-and-testing.html#about-print"><i class="fa fa-check"></i><b>19.1</b> Debugging with <code>print()</code></a></li>
<li class="chapter" data-level="19.2" data-path="debugging-and-testing.html"><a href="debugging-and-testing.html#about-browser-debugging"><i class="fa fa-check"></i><b>19.2</b> Debugging with browser</a></li>
<li class="chapter" data-level="19.3" data-path="debugging-and-testing.html"><a href="debugging-and-testing.html#debugging-with-debug"><i class="fa fa-check"></i><b>19.3</b> Debugging with debug</a></li>
<li class="chapter" data-level="19.4" data-path="debugging-and-testing.html"><a href="debugging-and-testing.html#about-stopifnot"><i class="fa fa-check"></i><b>19.4</b> Protecting your functions with “stop”</a></li>
<li class="chapter" data-level="19.5" data-path="debugging-and-testing.html"><a href="debugging-and-testing.html#testing-your-code"><i class="fa fa-check"></i><b>19.5</b> Testing your code</a></li>
</ul></li>
<li class="part"><span><b>V Complex Data Structures</b></span></li>
<li class="chapter" data-level="20" data-path="sec:power.html"><a href="sec:power.html"><i class="fa fa-check"></i><b>20</b> Using simulation as a power calculator</a>
<ul>
<li class="chapter" data-level="20.1" data-path="sec:power.html"><a href="sec:power.html#getting-design-parameters-from-pilot-data"><i class="fa fa-check"></i><b>20.1</b> Getting design parameters from pilot data</a></li>
<li class="chapter" data-level="20.2" data-path="sec:power.html"><a href="sec:power.html#the-data-generating-process"><i class="fa fa-check"></i><b>20.2</b> The data generating process</a></li>
<li class="chapter" data-level="20.3" data-path="sec:power.html"><a href="sec:power.html#running-the-simulation-1"><i class="fa fa-check"></i><b>20.3</b> Running the simulation</a></li>
<li class="chapter" data-level="20.4" data-path="sec:power.html"><a href="sec:power.html#evaluating-power"><i class="fa fa-check"></i><b>20.4</b> Evaluating power</a>
<ul>
<li class="chapter" data-level="20.4.1" data-path="sec:power.html"><a href="sec:power.html#checking-validity-of-our-models"><i class="fa fa-check"></i><b>20.4.1</b> Checking validity of our models</a></li>
<li class="chapter" data-level="20.4.2" data-path="sec:power.html"><a href="sec:power.html#assessing-precision-se"><i class="fa fa-check"></i><b>20.4.2</b> Assessing Precision (SE)</a></li>
<li class="chapter" data-level="20.4.3" data-path="sec:power.html"><a href="sec:power.html#assessing-power-1"><i class="fa fa-check"></i><b>20.4.3</b> Assessing power</a></li>
<li class="chapter" data-level="20.4.4" data-path="sec:power.html"><a href="sec:power.html#assessing-minimum-detectable-effects"><i class="fa fa-check"></i><b>20.4.4</b> Assessing Minimum Detectable Effects</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="21" data-path="potential-outcomes.html"><a href="potential-outcomes.html"><i class="fa fa-check"></i><b>21</b> Simulation under the Potential Outcomes Framework</a>
<ul>
<li class="chapter" data-level="21.1" data-path="potential-outcomes.html"><a href="potential-outcomes.html#finite-vs.-superpopulation-inference"><i class="fa fa-check"></i><b>21.1</b> Finite vs. Superpopulation inference</a></li>
<li class="chapter" data-level="21.2" data-path="potential-outcomes.html"><a href="potential-outcomes.html#data-generation-processes-for-potential-outcomes"><i class="fa fa-check"></i><b>21.2</b> Data generation processes for potential outcomes</a></li>
<li class="chapter" data-level="21.3" data-path="potential-outcomes.html"><a href="potential-outcomes.html#finite-sample-performance-measures"><i class="fa fa-check"></i><b>21.3</b> Finite sample performance measures</a></li>
<li class="chapter" data-level="21.4" data-path="potential-outcomes.html"><a href="potential-outcomes.html#nested-finite-simulation-procedure"><i class="fa fa-check"></i><b>21.4</b> Nested finite simulation procedure</a></li>
</ul></li>
<li class="chapter" data-level="22" data-path="the-parametric-bootstrap.html"><a href="the-parametric-bootstrap.html"><i class="fa fa-check"></i><b>22</b> The Parametric bootstrap</a>
<ul>
<li class="chapter" data-level="22.1" data-path="the-parametric-bootstrap.html"><a href="the-parametric-bootstrap.html#air-conditioners-a-stolen-case-study"><i class="fa fa-check"></i><b>22.1</b> Air conditioners: a stolen case study</a></li>
</ul></li>
<li class="appendix"><span><b>Appendices</b></span></li>
<li class="chapter" data-level="A" data-path="coding-tidbits.html"><a href="coding-tidbits.html"><i class="fa fa-check"></i><b>A</b> Coding Reference</a>
<ul>
<li class="chapter" data-level="A.1" data-path="coding-tidbits.html"><a href="coding-tidbits.html#more-repeating-oneself"><i class="fa fa-check"></i><b>A.1</b> How to repeat yourself</a>
<ul>
<li class="chapter" data-level="A.1.1" data-path="coding-tidbits.html"><a href="coding-tidbits.html#using-replicate"><i class="fa fa-check"></i><b>A.1.1</b> Using <code>replicate()</code></a></li>
<li class="chapter" data-level="A.1.2" data-path="coding-tidbits.html"><a href="coding-tidbits.html#using-map"><i class="fa fa-check"></i><b>A.1.2</b> Using <code>map()</code></a></li>
<li class="chapter" data-level="A.1.3" data-path="coding-tidbits.html"><a href="coding-tidbits.html#map-with-no-inputs"><i class="fa fa-check"></i><b>A.1.3</b> map with no inputs</a></li>
<li class="chapter" data-level="A.1.4" data-path="coding-tidbits.html"><a href="coding-tidbits.html#other-approaches-for-repetition"><i class="fa fa-check"></i><b>A.1.4</b> Other approaches for repetition</a></li>
</ul></li>
<li class="chapter" data-level="A.2" data-path="coding-tidbits.html"><a href="coding-tidbits.html#default-arguments"><i class="fa fa-check"></i><b>A.2</b> Default arguments for functions</a></li>
<li class="chapter" data-level="A.3" data-path="coding-tidbits.html"><a href="coding-tidbits.html#profiling-code"><i class="fa fa-check"></i><b>A.3</b> Profiling Code</a>
<ul>
<li class="chapter" data-level="A.3.1" data-path="coding-tidbits.html"><a href="coding-tidbits.html#using-sys.time-and-system.time"><i class="fa fa-check"></i><b>A.3.1</b> Using <code>Sys.time()</code> and <code>system.time()</code></a></li>
<li class="chapter" data-level="A.3.2" data-path="coding-tidbits.html"><a href="coding-tidbits.html#the-tictoc-package"><i class="fa fa-check"></i><b>A.3.2</b> The <code>tictoc</code> package</a></li>
<li class="chapter" data-level="A.3.3" data-path="coding-tidbits.html"><a href="coding-tidbits.html#the-bench-package"><i class="fa fa-check"></i><b>A.3.3</b> The <code>bench</code> package</a></li>
<li class="chapter" data-level="A.3.4" data-path="coding-tidbits.html"><a href="coding-tidbits.html#profiling-with-profvis"><i class="fa fa-check"></i><b>A.3.4</b> Profiling with <code>profvis</code></a></li>
</ul></li>
<li class="chapter" data-level="A.4" data-path="coding-tidbits.html"><a href="coding-tidbits.html#optimize-code"><i class="fa fa-check"></i><b>A.4</b> Optimizing code (and why you often shouldn’t)</a>
<ul>
<li class="chapter" data-level="A.4.1" data-path="coding-tidbits.html"><a href="coding-tidbits.html#hand-building-functions"><i class="fa fa-check"></i><b>A.4.1</b> Hand-building functions</a></li>
<li class="chapter" data-level="A.4.2" data-path="coding-tidbits.html"><a href="coding-tidbits.html#sec_comp_efficiency"><i class="fa fa-check"></i><b>A.4.2</b> Computational efficiency versus simplicity</a></li>
<li class="chapter" data-level="A.4.3" data-path="coding-tidbits.html"><a href="coding-tidbits.html#reusing-code-to-speed-up-computation"><i class="fa fa-check"></i><b>A.4.3</b> Reusing code to speed up computation</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="B" data-path="further-readings-and-resources.html"><a href="further-readings-and-resources.html"><i class="fa fa-check"></i><b>B</b> Further readings and resources</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Designing Monte Carlo Simulations in R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="coding-tidbits" class="section level1 hasAnchor" number="23">
<h1><span class="header-section-number">A</span> Coding Reference<a href="coding-tidbits.html#coding-tidbits" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>In this appendix chapter we give a bit more detail on some core programming skills that we use throughout the book.</p>
<div id="more-repeating-oneself" class="section level2 hasAnchor" number="23.1">
<h2><span class="header-section-number">A.1</span> How to repeat yourself<a href="coding-tidbits.html#more-repeating-oneself" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>At the heart of simulation is replication: we want to do the same task over and over. In this book we have showcased a variety of tools to replicate a random process. In this section we give a formal presentation of these tools.</p>
<div id="using-replicate" class="section level3 hasAnchor" number="23.1.1">
<h3><span class="header-section-number">A.1.1</span> Using <code>replicate()</code><a href="coding-tidbits.html#using-replicate" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>replicate( n, expr, simplify )</code> method is a base-R function, which takes two arguments: a number <code>n</code> and an expression <code>expr</code> to run repeatedly. You can set <code>simplify = FALSE</code> to get the output of the function as a list, and if you set <code>simplify = TRUE</code> then R will try to simplify your results into an array.</p>
<p>For simple tasks where your expression gives you a single number, replicate will produce a vector of numbers:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="coding-tidbits.html#cb1-1" tabindex="-1"></a><span class="fu">replicate</span>( <span class="dv">5</span>, <span class="fu">mean</span>( <span class="fu">rpois</span>( <span class="dv">3</span>, <span class="at">lambda =</span> <span class="dv">1</span> ) ) )</span></code></pre></div>
<pre><code>## [1] 1.3333333 2.0000000 0.6666667 0.3333333 1.3333333</code></pre>
<p>If you do not simplify, you then will need to massage your results:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="coding-tidbits.html#cb3-1" tabindex="-1"></a>one_run <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb3-2"><a href="coding-tidbits.html#cb3-2" tabindex="-1"></a>  dd <span class="ot">=</span> <span class="fu">rpois</span>( <span class="dv">3</span>, <span class="at">lambda =</span> <span class="dv">1</span> )</span>
<span id="cb3-3"><a href="coding-tidbits.html#cb3-3" tabindex="-1"></a>  <span class="fu">tibble</span>( <span class="at">mean =</span> <span class="fu">mean</span>( dd ), <span class="at">sd =</span> <span class="fu">sd</span>( dd ) )</span>
<span id="cb3-4"><a href="coding-tidbits.html#cb3-4" tabindex="-1"></a>}</span>
<span id="cb3-5"><a href="coding-tidbits.html#cb3-5" tabindex="-1"></a>rps <span class="ot">&lt;-</span> <span class="fu">replicate</span>( <span class="dv">2</span>, <span class="fu">one_run</span>(), <span class="at">simplify =</span> <span class="cn">FALSE</span> )</span>
<span id="cb3-6"><a href="coding-tidbits.html#cb3-6" tabindex="-1"></a>rps</span></code></pre></div>
<pre><code>## [[1]]
## # A tibble: 1 × 2
##    mean    sd
##   &lt;dbl&gt; &lt;dbl&gt;
## 1  2.33  1.15
## 
## [[2]]
## # A tibble: 1 × 2
##    mean    sd
##   &lt;dbl&gt; &lt;dbl&gt;
## 1  1.33  1.53</code></pre>
<p>In particular, you will probably stack all your tibbles to make one large dataset:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="coding-tidbits.html#cb5-1" tabindex="-1"></a>rps <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>( rps )</span>
<span id="cb5-2"><a href="coding-tidbits.html#cb5-2" tabindex="-1"></a>rps</span></code></pre></div>
<pre><code>## # A tibble: 2 × 2
##    mean    sd
##   &lt;dbl&gt; &lt;dbl&gt;
## 1  2.33  1.15
## 2  1.33  1.53</code></pre>
<p>Note that you give replicate a full piece of code that would run on its own. You can even give a whole block of code in curly braces.
This is exactly the same code as before:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="coding-tidbits.html#cb7-1" tabindex="-1"></a>rps <span class="ot">&lt;-</span> <span class="fu">replicate</span>( <span class="dv">2</span>, {</span>
<span id="cb7-2"><a href="coding-tidbits.html#cb7-2" tabindex="-1"></a>  dd <span class="ot">=</span> <span class="fu">rpois</span>( <span class="dv">3</span>, <span class="at">lambda =</span> <span class="dv">1</span> )</span>
<span id="cb7-3"><a href="coding-tidbits.html#cb7-3" tabindex="-1"></a>  <span class="fu">tibble</span>( <span class="at">mean =</span> <span class="fu">mean</span>( dd ), <span class="at">sd =</span> <span class="fu">sd</span>( dd ) )</span>
<span id="cb7-4"><a href="coding-tidbits.html#cb7-4" tabindex="-1"></a>}, <span class="at">simplify =</span> <span class="cn">FALSE</span> ) <span class="sc">%&gt;%</span></span>
<span id="cb7-5"><a href="coding-tidbits.html#cb7-5" tabindex="-1"></a>  <span class="fu">bind_rows</span>()</span></code></pre></div>
<p>The <code>replicate()</code> method is good for simple tasks, but for more general use, you will probably want to use <code>map()</code>.</p>
</div>
<div id="using-map" class="section level3 hasAnchor" number="23.1.2">
<h3><span class="header-section-number">A.1.2</span> Using <code>map()</code><a href="coding-tidbits.html#using-map" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The tidyverse way of repeating oneself is the <code>map()</code> method. The nice thing about <code>map()</code> is you map over a list of values, and thus can call a function repeatedly, but with a shifting set of inputs.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="coding-tidbits.html#cb8-1" tabindex="-1"></a>one_run_v2 <span class="ot">&lt;-</span> <span class="cf">function</span>( N ) {</span>
<span id="cb8-2"><a href="coding-tidbits.html#cb8-2" tabindex="-1"></a>  dd <span class="ot">=</span> <span class="fu">rpois</span>( N, <span class="at">lambda =</span> <span class="dv">1</span> )</span>
<span id="cb8-3"><a href="coding-tidbits.html#cb8-3" tabindex="-1"></a>  <span class="fu">tibble</span>( <span class="at">mean =</span> <span class="fu">mean</span>( dd ), <span class="at">sd =</span> <span class="fu">sd</span>( dd ) )</span>
<span id="cb8-4"><a href="coding-tidbits.html#cb8-4" tabindex="-1"></a>}</span>
<span id="cb8-5"><a href="coding-tidbits.html#cb8-5" tabindex="-1"></a>n_list <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">5</span>)</span>
<span id="cb8-6"><a href="coding-tidbits.html#cb8-6" tabindex="-1"></a>rps <span class="ot">&lt;-</span> <span class="fu">map</span>( n_list, one_run_v2 )</span>
<span id="cb8-7"><a href="coding-tidbits.html#cb8-7" tabindex="-1"></a>rps</span></code></pre></div>
<pre><code>## [[1]]
## # A tibble: 1 × 2
##    mean    sd
##   &lt;dbl&gt; &lt;dbl&gt;
## 1   0.5 0.707
## 
## [[2]]
## # A tibble: 1 × 2
##    mean    sd
##   &lt;dbl&gt; &lt;dbl&gt;
## 1   1.2  1.10</code></pre>
<p>You again would want to stack your results:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="coding-tidbits.html#cb10-1" tabindex="-1"></a><span class="fu">bind_rows</span>(rps)</span></code></pre></div>
<pre><code>## # A tibble: 2 × 2
##    mean    sd
##   &lt;dbl&gt; &lt;dbl&gt;
## 1   0.5 0.707
## 2   1.2 1.10</code></pre>
<p>We have a small issue here, however, which is we lost what we <em>gave</em> <code>map()</code> for each call.
If we know we only get one row back from each call, we can add the column directly:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="coding-tidbits.html#cb12-1" tabindex="-1"></a>rps<span class="sc">$</span>n <span class="ot">=</span> n_list</span></code></pre></div>
<p>A better approach is to <em>name</em> your list of input parameters, and then your <code>map</code> function can add those names for you as a new column when you stack:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="coding-tidbits.html#cb13-1" tabindex="-1"></a>n_list <span class="sc">%&gt;%</span></span>
<span id="cb13-2"><a href="coding-tidbits.html#cb13-2" tabindex="-1"></a>  <span class="fu">set_names</span>() <span class="sc">%&gt;%</span></span>
<span id="cb13-3"><a href="coding-tidbits.html#cb13-3" tabindex="-1"></a>  <span class="fu">map</span>( one_run_v2 ) <span class="sc">%&gt;%</span></span>
<span id="cb13-4"><a href="coding-tidbits.html#cb13-4" tabindex="-1"></a>  <span class="fu">bind_rows</span>( <span class="at">.id =</span> <span class="st">&quot;n&quot;</span> )</span></code></pre></div>
<pre><code>## # A tibble: 2 × 3
##   n      mean    sd
##   &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 2       0.5 0.707
## 2 5       0.6 0.894</code></pre>
<p>An advantage here is if you are returning multiple rows (e.g., one row for each estimator tested in a more complex simulation), all the rows will get named correctly and automatically.</p>
<p>In older tidyverse worlds, you will see methods such as <code>map_dbl()</code> or <code>map_dfr()</code>. These will automatically massage your output into the target type. <code>map_dfr()</code> will automatically bind rows, and <code>map_dbl()</code> will try to simplify the output into a list of doubles. Modern tidyverse no longer likes this, which we find somewhat sad.</p>
<p>To read more about <code>map()</code>, check out out <a href="https://r4ds.had.co.nz/iteration.html#the-map-functions">Section 21.5 of R for Data Science (1st edition)</a>, which provides a more thorough introduction to mapping.</p>
</div>
<div id="map-with-no-inputs" class="section level3 hasAnchor" number="23.1.3">
<h3><span class="header-section-number">A.1.3</span> map with no inputs<a href="coding-tidbits.html#map-with-no-inputs" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>If you do not have parameters, but still want to use <code>map()</code>, you can. E.g.,</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="coding-tidbits.html#cb15-1" tabindex="-1"></a><span class="fu">map_dfr</span>( <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, \(.) <span class="fu">one_run</span>() )</span></code></pre></div>
<pre><code>## # A tibble: 3 × 2
##    mean    sd
##   &lt;dbl&gt; &lt;dbl&gt;
## 1 1.33  0.577
## 2 1.33  1.15 
## 3 0.667 1.15</code></pre>
<p>The weird “(.)” is a shorthand for a function that takes one argument and then calls <code>one_run()</code> with no arguments. We are using the 1:3 notation to just make a list of the right length (3 replicates, in this case) to map over. A lot of fuss! Just use <code>replicate()</code></p>
<p>To make all of this more clear, consider passing arguments that you manipulate on the fly:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="coding-tidbits.html#cb17-1" tabindex="-1"></a><span class="fu">map_dfr</span>( n_list, \(x) <span class="fu">one_run_v2</span>( x<span class="sc">*</span>x ) )</span></code></pre></div>
<pre><code>## # A tibble: 2 × 2
##    mean    sd
##   &lt;dbl&gt; &lt;dbl&gt;
## 1  0.75 0.957
## 2  1    1.08</code></pre>
<p>Anonymous functions, as these are called, can be useful to connect your pieces of simulation together.</p>
</div>
<div id="other-approaches-for-repetition" class="section level3 hasAnchor" number="23.1.4">
<h3><span class="header-section-number">A.1.4</span> Other approaches for repetition<a href="coding-tidbits.html#other-approaches-for-repetition" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In the past, there was a tidyverse method called <code>rerun()</code>, but it is currently out of favor.
Originally, <code>rerun()</code> did exactly that: you gave it a number and a block of code, and it would rerun the block of code that many times, giving you the results as a list.
<code>rerun()</code> and <code>replicate()</code> are near equivalents.
As we saw, <code>replicate()</code> does what its name suggests—it replicates the result of an expression a specified number of times. Setting <code>simplify = FALSE</code> returns the output as a list (just like <code>rerun()</code> did).</p>
</div>
</div>
<div id="default-arguments" class="section level2 hasAnchor" number="23.2">
<h2><span class="header-section-number">A.2</span> Default arguments for functions<a href="coding-tidbits.html#default-arguments" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>To write functions that are both easy to use and configurable, set default arguments.
For example,</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="coding-tidbits.html#cb19-1" tabindex="-1"></a>my_function <span class="ot">=</span> <span class="cf">function</span>( <span class="at">a =</span> <span class="dv">10</span>, <span class="at">b =</span> <span class="dv">20</span> ) {</span>
<span id="cb19-2"><a href="coding-tidbits.html#cb19-2" tabindex="-1"></a>     <span class="dv">100</span> <span class="sc">*</span> a <span class="sc">+</span> b</span>
<span id="cb19-3"><a href="coding-tidbits.html#cb19-3" tabindex="-1"></a>}</span>
<span id="cb19-4"><a href="coding-tidbits.html#cb19-4" tabindex="-1"></a></span>
<span id="cb19-5"><a href="coding-tidbits.html#cb19-5" tabindex="-1"></a><span class="fu">my_function</span>()</span></code></pre></div>
<pre><code>## [1] 1020</code></pre>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="coding-tidbits.html#cb21-1" tabindex="-1"></a><span class="fu">my_function</span>( <span class="dv">5</span> )</span></code></pre></div>
<pre><code>## [1] 520</code></pre>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="coding-tidbits.html#cb23-1" tabindex="-1"></a><span class="fu">my_function</span>( <span class="at">b =</span> <span class="dv">5</span> )</span></code></pre></div>
<pre><code>## [1] 1005</code></pre>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="coding-tidbits.html#cb25-1" tabindex="-1"></a><span class="fu">my_function</span>( <span class="at">b =</span> <span class="dv">5</span>, <span class="at">a =</span> <span class="dv">1</span> )</span></code></pre></div>
<pre><code>## [1] 105</code></pre>
<p>We can still call <code>my_function()</code> when we don’t know what the arguments are, but then when we know more about the function, we can specify things of interest.
Lots of R commands work exactly this way, and for good reason.</p>
<p>Especially for code to generate random datasets, default arguments can be a lifesaver as you can then call the method before you know exactly what everything means.</p>
<p>For example, consider the <code>blkvar</code> package that has some code to generate blocked randomized datasets.
We might locate a promising method, and type it in:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="coding-tidbits.html#cb27-1" tabindex="-1"></a><span class="fu">library</span>( blkvar )</span>
<span id="cb27-2"><a href="coding-tidbits.html#cb27-2" tabindex="-1"></a><span class="fu">generate_blocked_data</span>()</span></code></pre></div>
<pre><code>## Error in generate_blocked_data(): argument &quot;n_k&quot; is missing, with no default</code></pre>
<p>That didn’t work, but let’s provide some block sizes and see what happens:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="coding-tidbits.html#cb29-1" tabindex="-1"></a><span class="fu">generate_blocked_data</span>( <span class="at">n_k =</span> <span class="fu">c</span>( <span class="dv">3</span>, <span class="dv">2</span> ) )</span></code></pre></div>
<pre><code>##    B         Y0       Y1
## 1 B1  2.1293052 7.562547
## 2 B1  0.9047112 6.083406
## 3 B1  1.5610107 5.964833
## 4 B2 -0.6706372 4.685531
## 5 B2 -1.4542470 3.501930</code></pre>
<p>Nice! We see that we have a block ID and the control and treatment potential outcomes. We also don’t see a random assignment variable, so that tells us we probably need some other methods as well.
But we can play with this as it stands right away.</p>
<p>Next we can see that there are many things we might tune:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="coding-tidbits.html#cb31-1" tabindex="-1"></a><span class="fu">args</span>( generate_blocked_data )</span></code></pre></div>
<pre><code>## function (n_k, sigma_alpha = 1, sigma_beta = 0, beta = 5, sigma_0 = 1, 
##     sigma_1 = 1, corr = 0.5, exact = FALSE) 
## NULL</code></pre>
<p>The documentation will tell us more, but if we just need some sample data, we can quickly assess our method before having to do much reading and understanding.
Only once we have identified what we need do we have to turn to the documentation itself.</p>
</div>
<div id="profiling-code" class="section level2 hasAnchor" number="23.3">
<h2><span class="header-section-number">A.3</span> Profiling Code<a href="coding-tidbits.html#profiling-code" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Simulations can be extremely time intensive.
With a large simulation it can also be hard to determine <em>why</em>, exactly, the simulation is as long as it is.
Is it one of the methods?
Is it just that as sample size grows, the time grows far more rapidly than one might expect?
Knowing the answer to these questions can allow you to plan out your simulation and, sometimes, make some hard choices as to what things you want to include.</p>
<p>There are a variety of tools for timing code.
We are going to go through a few useful ones here.</p>
<div id="using-sys.time-and-system.time" class="section level3 hasAnchor" number="23.3.1">
<h3><span class="header-section-number">A.3.1</span> Using <code>Sys.time()</code> and <code>system.time()</code><a href="coding-tidbits.html#using-sys.time-and-system.time" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The simplest way to time code is to use the <code>system.time()</code> function.
This function takes an expression and returns the time it took to run that expression.
For example:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="coding-tidbits.html#cb33-1" tabindex="-1"></a>time <span class="ot">&lt;-</span> <span class="fu">system.time</span>( <span class="fu">rnorm</span>( <span class="dv">1000000</span> ) )</span>
<span id="cb33-2"><a href="coding-tidbits.html#cb33-2" tabindex="-1"></a>time</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.024   0.001   0.025</code></pre>
<p>Elapsed time is how much time actually passed.
The user time is how much time your computer spent on the task at hand, not including if it paused to do something else (like deal with a mouse click or pop-up message).
With current computers with multiple cores, you would expect user and elapsed time to be very similar.</p>
<p>You can also start and stop a clock by checking the system time:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="coding-tidbits.html#cb35-1" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb35-2"><a href="coding-tidbits.html#cb35-2" tabindex="-1"></a>A <span class="ot">=</span> <span class="fu">rnorm</span>( <span class="dv">1000000</span> )</span>
<span id="cb35-3"><a href="coding-tidbits.html#cb35-3" tabindex="-1"></a><span class="fu">mean</span>(A)</span></code></pre></div>
<pre><code>## [1] 0.001044344</code></pre>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="coding-tidbits.html#cb37-1" tabindex="-1"></a><span class="fu">sd</span>(A)</span></code></pre></div>
<pre><code>## [1] 0.9988996</code></pre>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="coding-tidbits.html#cb39-1" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb39-2"><a href="coding-tidbits.html#cb39-2" tabindex="-1"></a>tot_time <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb39-3"><a href="coding-tidbits.html#cb39-3" tabindex="-1"></a>tot_time</span></code></pre></div>
<pre><code>## Time difference of 0.03121209 secs</code></pre>
<p>This can be useful, but be careful, as the time is stored along with the units. If your simulation takes a long time, it will flip from a lot of seconds to a few minutes, and you can end up thinking something that took much, much longer was actually fast.</p>
</div>
<div id="the-tictoc-package" class="section level3 hasAnchor" number="23.3.2">
<h3><span class="header-section-number">A.3.2</span> The <code>tictoc</code> package<a href="coding-tidbits.html#the-tictoc-package" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>tictoc</code> package is a very simple way to time code.
It has two functions, <code>tic()</code> and <code>toc()</code>, which you can use to mark the start and end of a block of code.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="coding-tidbits.html#cb41-1" tabindex="-1"></a><span class="fu">library</span>( tictoc )</span>
<span id="cb41-2"><a href="coding-tidbits.html#cb41-2" tabindex="-1"></a><span class="fu">tic</span>(<span class="st">&quot;Generating data&quot;</span>)</span>
<span id="cb41-3"><a href="coding-tidbits.html#cb41-3" tabindex="-1"></a>A <span class="ot">=</span> <span class="fu">rnorm</span>( <span class="dv">1000000</span> )</span>
<span id="cb41-4"><a href="coding-tidbits.html#cb41-4" tabindex="-1"></a><span class="fu">toc</span>()</span></code></pre></div>
<pre><code>## Generating data: 0.027 sec elapsed</code></pre>
<p>It is basically like <code>Sys.time()</code> but it has a few more features, such as being able to label the time you are measuring.</p>
</div>
<div id="the-bench-package" class="section level3 hasAnchor" number="23.3.3">
<h3><span class="header-section-number">A.3.3</span> The <code>bench</code> package<a href="coding-tidbits.html#the-bench-package" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>bench</code> package provides some powerful tools for timing code, and is in particular good for comparing different ways of doing the same (or similar) thing.
<code>bench::mark()</code> runs each expression 10 times (by default) and tracks how long the computations take. It then summarizes the distribution of timings.
For example, we can time how long it takes to analyze some data from our cluster RCT experiment:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="coding-tidbits.html#cb43-1" tabindex="-1"></a><span class="fu">library</span>( bench )</span>
<span id="cb43-2"><a href="coding-tidbits.html#cb43-2" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">gen_cluster_RCT</span>(<span class="at">n_bar=</span><span class="dv">100</span>, <span class="at">J =</span> <span class="dv">100</span>)</span>
<span id="cb43-3"><a href="coding-tidbits.html#cb43-3" tabindex="-1"></a>timings <span class="ot">&lt;-</span> <span class="fu">mark</span>(</span>
<span id="cb43-4"><a href="coding-tidbits.html#cb43-4" tabindex="-1"></a>      <span class="at">MLM =</span> <span class="fu">quiet_analysis_MLM</span>(dat),</span>
<span id="cb43-5"><a href="coding-tidbits.html#cb43-5" tabindex="-1"></a>      <span class="at">OLS =</span> <span class="fu">analysis_OLS</span>(dat),</span>
<span id="cb43-6"><a href="coding-tidbits.html#cb43-6" tabindex="-1"></a>      <span class="at">agg =</span> <span class="fu">analysis_agg</span>(dat),</span>
<span id="cb43-7"><a href="coding-tidbits.html#cb43-7" tabindex="-1"></a>      <span class="at">check =</span> <span class="cn">FALSE</span></span>
<span id="cb43-8"><a href="coding-tidbits.html#cb43-8" tabindex="-1"></a>)</span>
<span id="cb43-9"><a href="coding-tidbits.html#cb43-9" tabindex="-1"></a>timings</span></code></pre></div>
<pre><code>## # A tibble: 3 × 6
##   expression      min   median `itr/sec` mem_alloc `gc/sec`
##   &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt;
## 1 MLM         65.94ms  66.94ms      14.9    30.3MB    44.8 
## 2 OLS         35.76ms  36.57ms      26.9    3.31MB     4.48
## 3 agg          2.62ms   2.68ms     368.     1.11MB    10.6</code></pre>
<p>You can even get a viz of how long everything took:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="coding-tidbits.html#cb45-1" tabindex="-1"></a><span class="fu">plot</span>( timings )</span></code></pre></div>
<p><img src="Designing-Simulations-in-R_files/figure-html/unnamed-chunk-18-1.png" width="672" /></p>
<p>The “gc” coloring in the above indicates runs where “garbage collection” took place, meaning R paused to empty out some used memory.</p>
<p>You can also use <code>bench::press()</code> to run a variety of configurations to explore how timing works under changed parameters.
To illustrate, let’s compare how long each method for the cluster RCT running example takes:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="coding-tidbits.html#cb46-1" tabindex="-1"></a><span class="fu">source</span>( here<span class="sc">::</span><span class="fu">here</span>(<span class="st">&quot;case_study_code/clustered_data_simulation.R&quot;</span> ) )</span>
<span id="cb46-2"><a href="coding-tidbits.html#cb46-2" tabindex="-1"></a>timings <span class="ot">&lt;-</span> bench<span class="sc">::</span><span class="fu">press</span>(</span>
<span id="cb46-3"><a href="coding-tidbits.html#cb46-3" tabindex="-1"></a>  <span class="at">n_bar =</span> <span class="fu">c</span>( <span class="dv">10</span>, <span class="dv">100</span> ),</span>
<span id="cb46-4"><a href="coding-tidbits.html#cb46-4" tabindex="-1"></a>  <span class="at">J =</span> <span class="fu">c</span>( <span class="dv">10</span>, <span class="dv">100</span> ),</span>
<span id="cb46-5"><a href="coding-tidbits.html#cb46-5" tabindex="-1"></a>  {</span>
<span id="cb46-6"><a href="coding-tidbits.html#cb46-6" tabindex="-1"></a>    dat <span class="ot">&lt;-</span> <span class="fu">gen_cluster_RCT</span>(<span class="at">n_bar=</span>n_bar, <span class="at">J =</span> J)</span>
<span id="cb46-7"><a href="coding-tidbits.html#cb46-7" tabindex="-1"></a>    bench<span class="sc">::</span><span class="fu">mark</span>(</span>
<span id="cb46-8"><a href="coding-tidbits.html#cb46-8" tabindex="-1"></a>      <span class="at">MLM =</span> <span class="fu">quiet_analysis_MLM</span>(dat),</span>
<span id="cb46-9"><a href="coding-tidbits.html#cb46-9" tabindex="-1"></a>      <span class="at">OLS =</span> <span class="fu">analysis_OLS</span>(dat),</span>
<span id="cb46-10"><a href="coding-tidbits.html#cb46-10" tabindex="-1"></a>      <span class="at">agg =</span> <span class="fu">analysis_agg</span>(dat),</span>
<span id="cb46-11"><a href="coding-tidbits.html#cb46-11" tabindex="-1"></a>      <span class="at">check =</span> <span class="cn">FALSE</span></span>
<span id="cb46-12"><a href="coding-tidbits.html#cb46-12" tabindex="-1"></a>    )</span>
<span id="cb46-13"><a href="coding-tidbits.html#cb46-13" tabindex="-1"></a>  }</span>
<span id="cb46-14"><a href="coding-tidbits.html#cb46-14" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## Running with:
##   n_bar     J</code></pre>
<pre><code>## 1    10    10</code></pre>
<pre><code>## 2   100    10</code></pre>
<pre><code>## 3    10   100</code></pre>
<pre><code>## 4   100   100</code></pre>
<p>And we can make our custom plot of time:</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="coding-tidbits.html#cb52-1" tabindex="-1"></a>timings<span class="sc">$</span>name <span class="ot">=</span> <span class="fu">attr</span>( timings<span class="sc">$</span>expression, <span class="st">&quot;description&quot;</span> )</span>
<span id="cb52-2"><a href="coding-tidbits.html#cb52-2" tabindex="-1"></a><span class="fu">ggplot</span>( timings, <span class="fu">aes</span>( n_bar, median, <span class="at">color =</span> <span class="fu">as.factor</span>(J) ) ) <span class="sc">+</span></span>
<span id="cb52-3"><a href="coding-tidbits.html#cb52-3" tabindex="-1"></a>  <span class="fu">facet_wrap</span>( <span class="sc">~</span> name ) <span class="sc">+</span></span>
<span id="cb52-4"><a href="coding-tidbits.html#cb52-4" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">geom_line</span>()</span></code></pre></div>
<p><img src="Designing-Simulations-in-R_files/figure-html/unnamed-chunk-20-1.png" width="672" /></p>
<p>Note the <code>timings</code> object is not quite a classic tibble, and the expression at start captures the code run. The “name” line grabs the names given in the initial evaluation so we can make the plot the way we want.</p>
</div>
<div id="profiling-with-profvis" class="section level3 hasAnchor" number="23.3.4">
<h3><span class="header-section-number">A.3.4</span> Profiling with <code>profvis</code><a href="coding-tidbits.html#profiling-with-profvis" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Sometimes you don’t have a head to head comparison in mind, but are instead trying to find out <em>where</em> in your full simulation the time is being spent.
The <code>profvis</code> package allows for exploring this sort of question.
You “profile” a block of code and then you can explore the results in a browser inside of RStudio.</p>
<p>For example, you might have the following:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="coding-tidbits.html#cb53-1" tabindex="-1"></a><span class="fu">profvis</span>( {</span>
<span id="cb53-2"><a href="coding-tidbits.html#cb53-2" tabindex="-1"></a>  <span class="fu">replicate</span>( <span class="dv">10</span>, { </span>
<span id="cb53-3"><a href="coding-tidbits.html#cb53-3" tabindex="-1"></a>    data <span class="ot">&lt;-</span> <span class="fu">gen_cluster_RCT</span>( <span class="at">n_bar =</span> <span class="dv">100</span>, <span class="at">J =</span> <span class="dv">100</span> )</span>
<span id="cb53-4"><a href="coding-tidbits.html#cb53-4" tabindex="-1"></a>    res1 <span class="ot">&lt;-</span> <span class="fu">quiet_analysis_MLM</span>(data)</span>
<span id="cb53-5"><a href="coding-tidbits.html#cb53-5" tabindex="-1"></a>    res2 <span class="ot">&lt;-</span> <span class="fu">analysis_OLS</span>(data)</span>
<span id="cb53-6"><a href="coding-tidbits.html#cb53-6" tabindex="-1"></a>    res3 <span class="ot">&lt;-</span> <span class="fu">analysis_agg</span>(data)</span>
<span id="cb53-7"><a href="coding-tidbits.html#cb53-7" tabindex="-1"></a>  } )</span>
<span id="cb53-8"><a href="coding-tidbits.html#cb53-8" tabindex="-1"></a>} )</span></code></pre></div>
<p>In the browser you will get the code you ran, and you can see how long each line took to run.
You will get little “time” bars—the bigger the bar, the greater fraction of time that line took versus the other lines.</p>
<p>You can also click on the “Data” tab and it will give you a series of cascades of function calls, so you can see how long each function took to run.
You click on a function to expand it, and it will show you how long each part inside took.</p>
</div>
</div>
<div id="optimize-code" class="section level2 hasAnchor" number="23.4">
<h2><span class="header-section-number">A.4</span> Optimizing code (and why you often shouldn’t)<a href="coding-tidbits.html#optimize-code" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Optimizing code is when you spend a bit more human effort to write code that will run faster on your computer.
In some cases, this can be a critical boost to running a simulation, where you inherently will be doing things a lot of times.
Cutting runtime down will always be tempting, as it allows you to run more replicates and get more precisely estimated performance measures for your simulation.</p>
<p>That being said, generally optimize code only after discovering you need to.
Optimizing as you go usually means you will spend a lot of time wrestling with code far more complicated than it needs to be.
For example, often it is the estimation method that will take a lot of computational time, so having very fast data generation code will not help shorten the overall run time of a simulation much, as you are tweaking something that is only a small part of the overall pie, in terms of time.
Keep things simple; in general your time is more important than the computer’s time.</p>
<p>Overall, computational efficiency should usually be a secondary consideration when you are starting to design a simulation study.
It is better to produce accurate code, even if it is a bit slow, than to write code that is speedy but hard to follow (or even worse, that produces incorrect results).</p>
<p>That warning made, in the next sections we will look at a few optimization efforts applied to the ANOVA example from Section <a href="case-ANOVA.html#case-ANOVA">5</a> to illustrate some principles of optimization that come up a lot in simulation projects.</p>
<div id="hand-building-functions" class="section level3 hasAnchor" number="23.4.1">
<h3><span class="header-section-number">A.4.1</span> Hand-building functions<a href="coding-tidbits.html#hand-building-functions" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In our initial ANOVA simulation we used the system-implemented ANOVA.
An alternative approach would be to “hand roll” the ANOVA F statistic and test directly.
Doing so by hand can set you up to implement modified versions of these tests later on.
Also, although hand-building a method does take more work to program, it can result in a faster piece of code (this actually is the case here) which in turn can make the overall simulation faster.</p>
<p>Following the formulas on p. 129 of Brown and Forsythe (1974) we write our own function as so:</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="coding-tidbits.html#cb54-1" tabindex="-1"></a>ANOVA_F <span class="ot">&lt;-</span> <span class="cf">function</span>(sim_data) {</span>
<span id="cb54-2"><a href="coding-tidbits.html#cb54-2" tabindex="-1"></a></span>
<span id="cb54-3"><a href="coding-tidbits.html#cb54-3" tabindex="-1"></a>  x_bar <span class="ot">&lt;-</span> <span class="fu">with</span>(sim_data, <span class="fu">tapply</span>(x, group, mean))</span>
<span id="cb54-4"><a href="coding-tidbits.html#cb54-4" tabindex="-1"></a>  s_sq <span class="ot">&lt;-</span> <span class="fu">with</span>(sim_data, <span class="fu">tapply</span>(x, group, var))</span>
<span id="cb54-5"><a href="coding-tidbits.html#cb54-5" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">table</span>(sim_data<span class="sc">$</span>group)</span>
<span id="cb54-6"><a href="coding-tidbits.html#cb54-6" tabindex="-1"></a>  g <span class="ot">&lt;-</span> <span class="fu">length</span>(x_bar)</span>
<span id="cb54-7"><a href="coding-tidbits.html#cb54-7" tabindex="-1"></a></span>
<span id="cb54-8"><a href="coding-tidbits.html#cb54-8" tabindex="-1"></a>  df1 <span class="ot">&lt;-</span> g <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb54-9"><a href="coding-tidbits.html#cb54-9" tabindex="-1"></a>  df2 <span class="ot">&lt;-</span> <span class="fu">sum</span>(n) <span class="sc">-</span> g</span>
<span id="cb54-10"><a href="coding-tidbits.html#cb54-10" tabindex="-1"></a></span>
<span id="cb54-11"><a href="coding-tidbits.html#cb54-11" tabindex="-1"></a>  msbtw <span class="ot">&lt;-</span> <span class="fu">sum</span>(n <span class="sc">*</span> (x_bar <span class="sc">-</span> <span class="fu">mean</span>(sim_data<span class="sc">$</span>x))<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> df1</span>
<span id="cb54-12"><a href="coding-tidbits.html#cb54-12" tabindex="-1"></a>  mswn <span class="ot">&lt;-</span> <span class="fu">sum</span>((n <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> s_sq) <span class="sc">/</span> df2</span>
<span id="cb54-13"><a href="coding-tidbits.html#cb54-13" tabindex="-1"></a>  fstat <span class="ot">&lt;-</span> msbtw <span class="sc">/</span> mswn</span>
<span id="cb54-14"><a href="coding-tidbits.html#cb54-14" tabindex="-1"></a>  pval <span class="ot">&lt;-</span> <span class="fu">pf</span>(fstat, df1, df2, <span class="at">lower.tail =</span> <span class="cn">FALSE</span>)</span>
<span id="cb54-15"><a href="coding-tidbits.html#cb54-15" tabindex="-1"></a></span>
<span id="cb54-16"><a href="coding-tidbits.html#cb54-16" tabindex="-1"></a>  <span class="fu">return</span>(pval)</span>
<span id="cb54-17"><a href="coding-tidbits.html#cb54-17" tabindex="-1"></a>}</span></code></pre></div>
<p>We are using data as generated in Chapter <a href="data-generating-processes.html#data-generating-processes">6</a>.
To see the difference between our version and R’s version, we benchmark:</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="coding-tidbits.html#cb55-1" tabindex="-1"></a>timings <span class="ot">&lt;-</span> bench<span class="sc">::</span><span class="fu">mark</span>(<span class="at">Rfunction =</span> <span class="fu">ANOVA_F_aov</span>(sim_data),</span>
<span id="cb55-2"><a href="coding-tidbits.html#cb55-2" tabindex="-1"></a>                          <span class="at">direct    =</span> <span class="fu">ANOVA_F</span>(sim_data))</span>
<span id="cb55-3"><a href="coding-tidbits.html#cb55-3" tabindex="-1"></a><span class="fu">summary</span>( timings )[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>] <span class="sc">%&gt;%</span></span>
<span id="cb55-4"><a href="coding-tidbits.html#cb55-4" tabindex="-1"></a>  <span class="fu">mutate</span>( <span class="at">ratio =</span> <span class="fu">as.numeric</span>( <span class="fu">max</span>(median)<span class="sc">/</span>median ) ) <span class="sc">%&gt;%</span></span>
<span id="cb55-5"><a href="coding-tidbits.html#cb55-5" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>( <span class="at">digits =</span> <span class="dv">2</span> )</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">expression</th>
<th align="right">min</th>
<th align="right">median</th>
<th align="right">itr/sec</th>
<th align="right">ratio</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Rfunction</td>
<td align="right">188.3µs</td>
<td align="right">198µs</td>
<td align="right">4914.61</td>
<td align="right">1.00</td>
</tr>
<tr class="even">
<td align="left">direct</td>
<td align="right">83.5µs</td>
<td align="right">87µs</td>
<td align="right">11192.61</td>
<td align="right">2.28</td>
</tr>
</tbody>
</table>
<p>The direct function is 2.3 times faster than the built-in R function.</p>
<p>This result is not unusual.
Built-in R functions usually include lots of checks and error-handling, which take time to compute. These checks are crucial for messy, real-world data analysis but unnecessary with our pristine, simulated data.
Here we can skip them by doing the calculations directly.</p>
<p>In general, however, this is a trade-off: writing something yourself gives you a lot of chance to do something wrong, throwing off all your simulations.
It might be faster, but you may pay dearly for it in terms of extra hours coding and debugging.
Optimize only if you need to!</p>
</div>
<div id="sec_comp_efficiency" class="section level3 hasAnchor" number="23.4.2">
<h3><span class="header-section-number">A.4.2</span> Computational efficiency versus simplicity<a href="coding-tidbits.html#sec_comp_efficiency" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>On the data generation side, an alternative approach to having a function that, for each call, generates a single set of data, would be to write a function that generates <em>multiple</em> sets of simulated data all at once.</p>
<p>For example, for our ANOVA example we could specify that we want <code>R</code> replications of the study and have the function spit out a matrix with <code>R</code> columns, one for each simulated dataset:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="coding-tidbits.html#cb56-1" tabindex="-1"></a>generate_data_matrix <span class="ot">&lt;-</span> <span class="cf">function</span>(mu, sigma_sq, sample_size, R) {</span>
<span id="cb56-2"><a href="coding-tidbits.html#cb56-2" tabindex="-1"></a></span>
<span id="cb56-3"><a href="coding-tidbits.html#cb56-3" tabindex="-1"></a>  N <span class="ot">&lt;-</span> <span class="fu">sum</span>(sample_size) </span>
<span id="cb56-4"><a href="coding-tidbits.html#cb56-4" tabindex="-1"></a>  g <span class="ot">&lt;-</span> <span class="fu">length</span>(sample_size) </span>
<span id="cb56-5"><a href="coding-tidbits.html#cb56-5" tabindex="-1"></a>  </span>
<span id="cb56-6"><a href="coding-tidbits.html#cb56-6" tabindex="-1"></a>  group <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>g, <span class="at">times =</span> sample_size) </span>
<span id="cb56-7"><a href="coding-tidbits.html#cb56-7" tabindex="-1"></a>  mu_long <span class="ot">&lt;-</span> <span class="fu">rep</span>(mu, <span class="at">times =</span> sample_size)</span>
<span id="cb56-8"><a href="coding-tidbits.html#cb56-8" tabindex="-1"></a>  sigma_long <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">sqrt</span>(sigma_sq), <span class="at">times =</span> sample_size) </span>
<span id="cb56-9"><a href="coding-tidbits.html#cb56-9" tabindex="-1"></a></span>
<span id="cb56-10"><a href="coding-tidbits.html#cb56-10" tabindex="-1"></a>  x_mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(N <span class="sc">*</span> R, <span class="at">mean =</span> mu_long, <span class="at">sd =</span> sigma_long),</span>
<span id="cb56-11"><a href="coding-tidbits.html#cb56-11" tabindex="-1"></a>                  <span class="at">nrow =</span> N, <span class="at">ncol =</span> R)</span>
<span id="cb56-12"><a href="coding-tidbits.html#cb56-12" tabindex="-1"></a>  sim_data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">group =</span> group, <span class="at">x_mat =</span> x_mat)</span>
<span id="cb56-13"><a href="coding-tidbits.html#cb56-13" tabindex="-1"></a>    </span>
<span id="cb56-14"><a href="coding-tidbits.html#cb56-14" tabindex="-1"></a>  <span class="fu">return</span>(sim_data)</span>
<span id="cb56-15"><a href="coding-tidbits.html#cb56-15" tabindex="-1"></a>}</span>
<span id="cb56-16"><a href="coding-tidbits.html#cb56-16" tabindex="-1"></a></span>
<span id="cb56-17"><a href="coding-tidbits.html#cb56-17" tabindex="-1"></a><span class="fu">generate_data_matrix</span>(<span class="at">mu =</span> mu, <span class="at">sigma_sq =</span> sigma_sq,</span>
<span id="cb56-18"><a href="coding-tidbits.html#cb56-18" tabindex="-1"></a>                     <span class="at">sample_size =</span> sample_size, <span class="at">R =</span> <span class="dv">4</span>)</span></code></pre></div>
<pre><code>## $group
##  [1] 1 1 1 2 2 2 2 2 2 3 3 4 4 4 4
## 
## $x_mat
##            [,1]       [,2]        [,3]       [,4]
##  [1,] 0.3849793  1.4609015  0.76873188  0.4737298
##  [2,] 1.0977006  1.9530084 -2.88905081  2.9202654
##  [3,] 0.9708439 -0.4864465 -0.08839672  2.9991909
##  [4,] 1.1603777  3.4345484  4.27810359  0.1581287
##  [5,] 3.2931176  2.6906485  4.64474586  1.5987259
##  [6,] 0.1830885  0.3512344  2.40389150  2.3522888
##  [7,] 3.2904309  1.7444436  1.80262972  3.0065420
##  [8,] 0.8340684  0.8524091  1.71937004 -0.3707763
##  [9,] 2.2832115  1.4540723  3.43886917  3.9678618
## [10,] 3.3910300  4.6234472  4.09152956  4.6557176
## [11,] 5.0435932  2.0994752  5.43177293  2.6886428
## [12,] 5.2330271  5.7078381  4.14230299  3.9918688
## [13,] 5.4037607  5.4732105  6.38622289  6.2805354
## [14,] 6.2869568  4.0393061  6.30887152  6.6075947
## [15,] 3.6852648  5.2248913  6.77291194  5.7575038</code></pre>
<p>This approach is a bit more computationally efficient because the setup calculations (getting <code>N</code>, <code>g</code>, <code>group</code>, <code>mu_full</code>, and <code>sigma_full</code>) only have to be done once instead of once per replication. It also makes clever use of vector recycling in the call to <code>rnorm()</code>. However, the structure of the resulting data is more complicated, which will make it more difficult to do the later estimation steps.
Furthermore, if the number of replicates <code>R</code> is large and each replication produces a large dataset, this “all-at-once” approach will entail generating and holding very large amounts of data in memory, which can create other performance issues.
On balance, we recommend the simpler approach of writing a function that generates a single simulated dataset per call (unless and until you have a principled reason to do otherwise).
It is usually the case that most time spent in the simulation is the <em>analyzing</em> of the data, not the generating it, so these savings are usually not worth the bother.</p>
</div>
<div id="reusing-code-to-speed-up-computation" class="section level3 hasAnchor" number="23.4.3">
<h3><span class="header-section-number">A.4.3</span> Reusing code to speed up computation<a href="coding-tidbits.html#reusing-code-to-speed-up-computation" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Once we have our own ANOVA method to go with our own Welch method, we see some glaring redundancies.
In particular, both <code>ANOVA_F</code> and <code>Welch_F</code> start by taking the simulated data and calculating summary statistics for each group, using the following code:</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="coding-tidbits.html#cb58-1" tabindex="-1"></a>x_bar <span class="ot">&lt;-</span> <span class="fu">with</span>(sim_data, <span class="fu">tapply</span>(x, group, mean))</span>
<span id="cb58-2"><a href="coding-tidbits.html#cb58-2" tabindex="-1"></a>s_sq <span class="ot">&lt;-</span> <span class="fu">with</span>(sim_data, <span class="fu">tapply</span>(x, group, var))</span>
<span id="cb58-3"><a href="coding-tidbits.html#cb58-3" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">table</span>(sim_data<span class="sc">$</span>group)</span></code></pre></div>
<p>In the interest of not repeating ourselves, it would better to pull this code out as a separate function and then re-write the <code>ANOVA_F</code> and <code>Welch_F</code> functions to take the summary statistics as input. Here is a function that takes simulated data and returns a list of summary statistics:</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="coding-tidbits.html#cb59-1" tabindex="-1"></a>summarize_data <span class="ot">&lt;-</span> <span class="cf">function</span>(sim_data) {</span>
<span id="cb59-2"><a href="coding-tidbits.html#cb59-2" tabindex="-1"></a>  x_bar <span class="ot">&lt;-</span> <span class="fu">with</span>(sim_data, <span class="fu">tapply</span>(x, group, mean))</span>
<span id="cb59-3"><a href="coding-tidbits.html#cb59-3" tabindex="-1"></a>  s_sq <span class="ot">&lt;-</span> <span class="fu">with</span>(sim_data, <span class="fu">tapply</span>(x, group, var))</span>
<span id="cb59-4"><a href="coding-tidbits.html#cb59-4" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">table</span>(sim_data<span class="sc">$</span>group)</span>
<span id="cb59-5"><a href="coding-tidbits.html#cb59-5" tabindex="-1"></a></span>
<span id="cb59-6"><a href="coding-tidbits.html#cb59-6" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb59-7"><a href="coding-tidbits.html#cb59-7" tabindex="-1"></a>    <span class="at">x_bar =</span> <span class="fu">as.numeric</span>( x_bar ),</span>
<span id="cb59-8"><a href="coding-tidbits.html#cb59-8" tabindex="-1"></a>    <span class="at">s_sq =</span> <span class="fu">as.numeric</span>( s_sq ),</span>
<span id="cb59-9"><a href="coding-tidbits.html#cb59-9" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">as.numeric</span>( n )</span>
<span id="cb59-10"><a href="coding-tidbits.html#cb59-10" tabindex="-1"></a>  )</span>
<span id="cb59-11"><a href="coding-tidbits.html#cb59-11" tabindex="-1"></a>}</span></code></pre></div>
<p>We just packaged the code from above:</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="coding-tidbits.html#cb60-1" tabindex="-1"></a>sim_data <span class="ot">=</span> <span class="fu">generate_data</span>(<span class="at">mu=</span>mu, <span class="at">sigma_sq=</span>sigma_sq, <span class="at">sample_size=</span>sample_size)</span>
<span id="cb60-2"><a href="coding-tidbits.html#cb60-2" tabindex="-1"></a><span class="fu">summarize_data</span>(sim_data)</span></code></pre></div>
<pre><code>## $x_bar
## [1] 2.524787 2.393851 6.480954 5.829849
## 
## $s_sq
## [1] 0.7525967 1.3335488 8.6997448 1.0521108
## 
## $n
## [1] 3 6 2 4</code></pre>
<p>Now we can re-write both our <span class="math inline">\(F\)</span>-test functions to use the output of this function:</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="coding-tidbits.html#cb62-1" tabindex="-1"></a>ANOVA_F_agg <span class="ot">&lt;-</span> <span class="cf">function</span>(x_bar, s_sq, n) {</span>
<span id="cb62-2"><a href="coding-tidbits.html#cb62-2" tabindex="-1"></a>  g <span class="ot">=</span> <span class="fu">length</span>(x_bar)</span>
<span id="cb62-3"><a href="coding-tidbits.html#cb62-3" tabindex="-1"></a>  df1 <span class="ot">&lt;-</span> g <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb62-4"><a href="coding-tidbits.html#cb62-4" tabindex="-1"></a>  df2 <span class="ot">&lt;-</span> <span class="fu">sum</span>(n) <span class="sc">-</span> g</span>
<span id="cb62-5"><a href="coding-tidbits.html#cb62-5" tabindex="-1"></a>  </span>
<span id="cb62-6"><a href="coding-tidbits.html#cb62-6" tabindex="-1"></a>  msbtw <span class="ot">&lt;-</span> <span class="fu">sum</span>(n <span class="sc">*</span> (x_bar <span class="sc">-</span> <span class="fu">weighted.mean</span>(x_bar, <span class="at">w =</span> n))<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> df1</span>
<span id="cb62-7"><a href="coding-tidbits.html#cb62-7" tabindex="-1"></a>  mswn <span class="ot">&lt;-</span> <span class="fu">sum</span>((n <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> s_sq) <span class="sc">/</span> df2</span>
<span id="cb62-8"><a href="coding-tidbits.html#cb62-8" tabindex="-1"></a>  fstat <span class="ot">&lt;-</span> msbtw <span class="sc">/</span> mswn</span>
<span id="cb62-9"><a href="coding-tidbits.html#cb62-9" tabindex="-1"></a>  pval <span class="ot">&lt;-</span> <span class="fu">pf</span>(fstat, df1, df2, <span class="at">lower.tail =</span> <span class="cn">FALSE</span>)</span>
<span id="cb62-10"><a href="coding-tidbits.html#cb62-10" tabindex="-1"></a> </span>
<span id="cb62-11"><a href="coding-tidbits.html#cb62-11" tabindex="-1"></a>  <span class="fu">return</span>(pval)</span>
<span id="cb62-12"><a href="coding-tidbits.html#cb62-12" tabindex="-1"></a>}</span>
<span id="cb62-13"><a href="coding-tidbits.html#cb62-13" tabindex="-1"></a></span>
<span id="cb62-14"><a href="coding-tidbits.html#cb62-14" tabindex="-1"></a>summary_stats <span class="ot">&lt;-</span> <span class="fu">summarize_data</span>(sim_data)</span>
<span id="cb62-15"><a href="coding-tidbits.html#cb62-15" tabindex="-1"></a><span class="fu">with</span>(summary_stats, <span class="fu">ANOVA_F_agg</span>(<span class="at">x_bar =</span> x_bar, <span class="at">s_sq =</span> s_sq, <span class="at">n =</span> n))</span></code></pre></div>
<pre><code>## [1] 0.003052341</code></pre>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="coding-tidbits.html#cb64-1" tabindex="-1"></a>Welch_F_agg <span class="ot">&lt;-</span> <span class="cf">function</span>(x_bar, s_sq, n) {</span>
<span id="cb64-2"><a href="coding-tidbits.html#cb64-2" tabindex="-1"></a>  g <span class="ot">=</span> <span class="fu">length</span>(x_bar)</span>
<span id="cb64-3"><a href="coding-tidbits.html#cb64-3" tabindex="-1"></a>  w <span class="ot">&lt;-</span> n <span class="sc">/</span> s_sq</span>
<span id="cb64-4"><a href="coding-tidbits.html#cb64-4" tabindex="-1"></a>  u <span class="ot">&lt;-</span> <span class="fu">sum</span>(w)</span>
<span id="cb64-5"><a href="coding-tidbits.html#cb64-5" tabindex="-1"></a>  x_tilde <span class="ot">&lt;-</span> <span class="fu">sum</span>(w <span class="sc">*</span> x_bar) <span class="sc">/</span> u</span>
<span id="cb64-6"><a href="coding-tidbits.html#cb64-6" tabindex="-1"></a>  msbtw <span class="ot">&lt;-</span> <span class="fu">sum</span>(w <span class="sc">*</span> (x_bar <span class="sc">-</span> x_tilde)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> (g <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb64-7"><a href="coding-tidbits.html#cb64-7" tabindex="-1"></a></span>
<span id="cb64-8"><a href="coding-tidbits.html#cb64-8" tabindex="-1"></a>  G <span class="ot">&lt;-</span> <span class="fu">sum</span>((<span class="dv">1</span> <span class="sc">-</span> w <span class="sc">/</span> u)<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> (n <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb64-9"><a href="coding-tidbits.html#cb64-9" tabindex="-1"></a>  denom <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">+</span>  G <span class="sc">*</span> <span class="dv">2</span> <span class="sc">*</span> (g <span class="sc">-</span> <span class="dv">2</span>) <span class="sc">/</span> (g<span class="sc">^</span><span class="dv">2</span> <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb64-10"><a href="coding-tidbits.html#cb64-10" tabindex="-1"></a>  W <span class="ot">&lt;-</span> msbtw <span class="sc">/</span> denom</span>
<span id="cb64-11"><a href="coding-tidbits.html#cb64-11" tabindex="-1"></a>  f <span class="ot">&lt;-</span> (g<span class="sc">^</span><span class="dv">2</span> <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">/</span> (<span class="dv">3</span> <span class="sc">*</span> G)</span>
<span id="cb64-12"><a href="coding-tidbits.html#cb64-12" tabindex="-1"></a></span>
<span id="cb64-13"><a href="coding-tidbits.html#cb64-13" tabindex="-1"></a>  pval <span class="ot">&lt;-</span> <span class="fu">pf</span>(W, <span class="at">df1 =</span> g <span class="sc">-</span> <span class="dv">1</span>, <span class="at">df2 =</span> f, <span class="at">lower.tail =</span> <span class="cn">FALSE</span>)</span>
<span id="cb64-14"><a href="coding-tidbits.html#cb64-14" tabindex="-1"></a></span>
<span id="cb64-15"><a href="coding-tidbits.html#cb64-15" tabindex="-1"></a>  <span class="fu">return</span>(pval)</span>
<span id="cb64-16"><a href="coding-tidbits.html#cb64-16" tabindex="-1"></a>}</span>
<span id="cb64-17"><a href="coding-tidbits.html#cb64-17" tabindex="-1"></a></span>
<span id="cb64-18"><a href="coding-tidbits.html#cb64-18" tabindex="-1"></a><span class="fu">with</span>(summary_stats, <span class="fu">Welch_F_agg</span>(<span class="at">x_bar =</span> x_bar, <span class="at">s_sq =</span> s_sq, <span class="at">n =</span> n))</span></code></pre></div>
<pre><code>## [1] 0.04992483</code></pre>
<p>The results are the same as before.</p>
<p>We should always test any optimized code against something we know is stable, since optimization is an easy way to get bad bugs.
Here we check against R’s implementation:</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="coding-tidbits.html#cb66-1" tabindex="-1"></a>summary_stats <span class="ot">&lt;-</span> <span class="fu">summarize_data</span>(sim_data)</span>
<span id="cb66-2"><a href="coding-tidbits.html#cb66-2" tabindex="-1"></a>F_results <span class="ot">&lt;-</span> <span class="fu">with</span>(summary_stats,</span>
<span id="cb66-3"><a href="coding-tidbits.html#cb66-3" tabindex="-1"></a>                  <span class="fu">ANOVA_F_agg</span>(<span class="at">x_bar =</span> x_bar, <span class="at">s_sq =</span> s_sq, <span class="at">n =</span> n))</span>
<span id="cb66-4"><a href="coding-tidbits.html#cb66-4" tabindex="-1"></a>aov_results <span class="ot">&lt;-</span> <span class="fu">oneway.test</span>(x <span class="sc">~</span> <span class="fu">factor</span>(group), <span class="at">data =</span> sim_data, </span>
<span id="cb66-5"><a href="coding-tidbits.html#cb66-5" tabindex="-1"></a>                           <span class="at">var.equal =</span> <span class="cn">TRUE</span>)</span>
<span id="cb66-6"><a href="coding-tidbits.html#cb66-6" tabindex="-1"></a><span class="fu">all.equal</span>(aov_results<span class="sc">$</span>p.value, F_results)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="coding-tidbits.html#cb68-1" tabindex="-1"></a>W_results <span class="ot">&lt;-</span> <span class="fu">with</span>(summary_stats,</span>
<span id="cb68-2"><a href="coding-tidbits.html#cb68-2" tabindex="-1"></a>                  <span class="fu">Welch_F_agg</span>( <span class="at">x_bar =</span> x_bar,</span>
<span id="cb68-3"><a href="coding-tidbits.html#cb68-3" tabindex="-1"></a>                               <span class="at">s_sq =</span> s_sq, <span class="at">n =</span> n))</span>
<span id="cb68-4"><a href="coding-tidbits.html#cb68-4" tabindex="-1"></a>aov_results <span class="ot">&lt;-</span> <span class="fu">oneway.test</span>(x <span class="sc">~</span> <span class="fu">factor</span>(group),</span>
<span id="cb68-5"><a href="coding-tidbits.html#cb68-5" tabindex="-1"></a>                           <span class="at">data =</span> sim_data, </span>
<span id="cb68-6"><a href="coding-tidbits.html#cb68-6" tabindex="-1"></a>                           <span class="at">var.equal =</span> <span class="cn">FALSE</span>)</span>
<span id="cb68-7"><a href="coding-tidbits.html#cb68-7" tabindex="-1"></a><span class="fu">all.equal</span>(aov_results<span class="sc">$</span>p.value, W_results)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p>Here we are able to check against a known baseline.
Checking estimation functions can be a bit more difficult for procedures that are not already implemented in R. For example, the two other procedures examined by Brown and Forsythe, the James’ test and Brown and Forsythe’s <span class="math inline">\(F*\)</span> test, are not available in base R.
They are, however, available in the user-contributed package <code>onewaytests</code>, found by searching for “Brown-Forsythe” at <a href="http://rseek.org/" class="uri">http://rseek.org/</a>. We could benchmark our calculations against this package, but of course there is some risk that the package might not be correct. Another route is to verify your results on numerical examples reported in authoritative papers, on the assumption that there’s less risk of an error there. In the original paper that proposed the test, Welch (1951) provides a worked numerical example of the procedure. He reports the following summary statistics:</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="coding-tidbits.html#cb70-1" tabindex="-1"></a>g <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb70-2"><a href="coding-tidbits.html#cb70-2" tabindex="-1"></a>x_bar <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">27.8</span>, <span class="fl">24.1</span>, <span class="fl">22.2</span>)</span>
<span id="cb70-3"><a href="coding-tidbits.html#cb70-3" tabindex="-1"></a>s_sq <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">60.1</span>, <span class="fl">6.3</span>, <span class="fl">15.4</span>)</span>
<span id="cb70-4"><a href="coding-tidbits.html#cb70-4" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">20</span>, <span class="dv">10</span>)</span></code></pre></div>
<p>He also reports <span class="math inline">\(W = 3.35\)</span> and <span class="math inline">\(f = 22.6\)</span>. Replicating the calculations with our <code>Welch_F_agg</code> function:</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="coding-tidbits.html#cb71-1" tabindex="-1"></a><span class="fu">Welch_F_agg</span>(<span class="at">x_bar =</span> x_bar, <span class="at">s_sq =</span> s_sq, <span class="at">n =</span> n)</span></code></pre></div>
<pre><code>## [1] 0.05479049</code></pre>
<p>We get slightly different results! But we know that our function is correct—or at least consistent with <code>oneway.test</code>—so what’s going on? It turns out that there was an error in some of Welch’s intermediate calculations, which can only be spotted because he reported all of his work in the paper.</p>
<p>We then put all these pieces in our revised <code>one_run()</code> method as so:</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="coding-tidbits.html#cb73-1" tabindex="-1"></a>one_run_fast <span class="ot">&lt;-</span> <span class="cf">function</span>( mu, sigma_sq, sample_size ) {</span>
<span id="cb73-2"><a href="coding-tidbits.html#cb73-2" tabindex="-1"></a>  sim_data <span class="ot">&lt;-</span> <span class="fu">generate_data</span>(<span class="at">mu =</span> mu, <span class="at">sigma_sq =</span> sigma_sq,</span>
<span id="cb73-3"><a href="coding-tidbits.html#cb73-3" tabindex="-1"></a>                            <span class="at">sample_size =</span> sample_size)</span>
<span id="cb73-4"><a href="coding-tidbits.html#cb73-4" tabindex="-1"></a>  summary_stats <span class="ot">&lt;-</span> <span class="fu">summarize_data</span>(sim_data)</span>
<span id="cb73-5"><a href="coding-tidbits.html#cb73-5" tabindex="-1"></a>  anova_p <span class="ot">&lt;-</span> <span class="fu">with</span>(summary_stats, </span>
<span id="cb73-6"><a href="coding-tidbits.html#cb73-6" tabindex="-1"></a>                  <span class="fu">ANOVA_F_agg</span>(<span class="at">x_bar =</span> x_bar,<span class="at">s_sq =</span> s_sq, <span class="at">n =</span> n))</span>
<span id="cb73-7"><a href="coding-tidbits.html#cb73-7" tabindex="-1"></a>  Welch_p <span class="ot">&lt;-</span> <span class="fu">with</span>(summary_stats, </span>
<span id="cb73-8"><a href="coding-tidbits.html#cb73-8" tabindex="-1"></a>                  <span class="fu">Welch_F_agg</span>(<span class="at">x_bar =</span> x_bar, <span class="at">s_sq =</span> s_sq, <span class="at">n =</span> n))</span>
<span id="cb73-9"><a href="coding-tidbits.html#cb73-9" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">ANOVA =</span> anova_p, <span class="at">Welch =</span> Welch_p)</span>
<span id="cb73-10"><a href="coding-tidbits.html#cb73-10" tabindex="-1"></a>}</span>
<span id="cb73-11"><a href="coding-tidbits.html#cb73-11" tabindex="-1"></a></span>
<span id="cb73-12"><a href="coding-tidbits.html#cb73-12" tabindex="-1"></a><span class="fu">one_run_fast</span>( <span class="at">mu =</span> mu, <span class="at">sigma_sq =</span> sigma_sq,</span>
<span id="cb73-13"><a href="coding-tidbits.html#cb73-13" tabindex="-1"></a>              <span class="at">sample_size =</span> sample_size )</span></code></pre></div>
<pre><code>## # A tibble: 1 × 2
##      ANOVA   Welch
##      &lt;dbl&gt;   &lt;dbl&gt;
## 1 0.000354 0.00796</code></pre>
<p>The reason this is important is we are now doing our group aggregation only once, rather than once per method.
We benchmark to see our speedup:</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="coding-tidbits.html#cb75-1" tabindex="-1"></a>timings <span class="ot">&lt;-</span> bench<span class="sc">::</span><span class="fu">mark</span>(<span class="at">original =</span> <span class="fu">one_run</span>(<span class="at">mu =</span> mu, <span class="at">sigma_sq =</span> sigma_sq, </span>
<span id="cb75-2"><a href="coding-tidbits.html#cb75-2" tabindex="-1"></a>                                          <span class="at">sample_size =</span> sample_size),</span>
<span id="cb75-3"><a href="coding-tidbits.html#cb75-3" tabindex="-1"></a>                       <span class="at">one_agg =</span> <span class="fu">one_run_fast</span>(<span class="at">mu =</span> mu, <span class="at">sigma_sq =</span> sigma_sq, </span>
<span id="cb75-4"><a href="coding-tidbits.html#cb75-4" tabindex="-1"></a>                                              <span class="at">sample_size =</span> sample_size),</span>
<span id="cb75-5"><a href="coding-tidbits.html#cb75-5" tabindex="-1"></a>                       <span class="at">check=</span><span class="cn">FALSE</span>)</span>
<span id="cb75-6"><a href="coding-tidbits.html#cb75-6" tabindex="-1"></a>timings[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>] <span class="sc">%&gt;%</span></span>
<span id="cb75-7"><a href="coding-tidbits.html#cb75-7" tabindex="-1"></a>  <span class="fu">mutate</span>( <span class="at">ratio =</span> <span class="fu">as.numeric</span>( <span class="fu">max</span>(median) <span class="sc">/</span> median ) ) <span class="sc">%&gt;%</span></span>
<span id="cb75-8"><a href="coding-tidbits.html#cb75-8" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>( <span class="at">digits =</span> <span class="dv">2</span> )</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">expression</th>
<th align="right">min</th>
<th align="right">median</th>
<th align="right">itr/sec</th>
<th align="right">ratio</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">original</td>
<td align="right">539µs</td>
<td align="right">557µs</td>
<td align="right">1757.59</td>
<td align="right">1.00</td>
</tr>
<tr class="even">
<td align="left">one_agg</td>
<td align="right">449µs</td>
<td align="right">469µs</td>
<td align="right">2088.69</td>
<td align="right">1.19</td>
</tr>
</tbody>
</table>
<p>Our improvement is fairly modest.</p>
<p>To recap, there are two advantages of this kind of coding:</p>
<ol style="list-style-type: decimal">
<li><p>Code reuse is generally good because when you have the same code in multiple places it can make it harder to read and understand your code. If you see two blocks of code you might worry they are only mostly similar, not exactly similar, and waste time trying to differentiate. If you have a single, well-named function, you immediately know what a block of code is doing.</p></li>
<li><p>Saving the results of calculations can speed up your computation since you are saving your partial work. This can be useful to reduce calculations that are particularly time intensive.</p></li>
</ol>
<p>That said, optimizing code is dangerous (it is an easy way to introduce bugs into your simulation workflow) and time consuming for you (thinking through and writing all the fancy code is time you are not doing something else).
But it sure can be satisfying to spend an extra weekend hacking away at this sort of thing!</p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="the-parametric-bootstrap.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="further-readings-and-resources.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": {
    "github": false,
    "facebook": true,
    "twitter": true,
    "linkedin": false,
    "weibo": false,
    "instapaper": false,
    "vk": false,
    "whatsapp": false,
    "all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
  },
  "fontsettings": {
    "theme": "white",
    "family": "sans",
    "size": 2
  },
  "edit": {
    "link": "https://github.com/jepusto/Designing-Simulations-in-R/edit/master/200-coding-tidbits.Rmd",
    "text": "Edit"
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": null,
    "text": null
  },
  "download": ["Designing-Simulations-in-R.pdf", "Designing-Simulations-in-R.epub"],
  "search": {
    "engine": "lunr",
    "options": null
  },
  "toc": {
    "collapse": "section",
    "scroll_highlight": true
  },
  "toolbar": {
    "position": "fixed"
  },
  "info": true
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
