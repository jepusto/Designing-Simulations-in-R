<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 17 Optimizing code (and why you often shouldn’t) | Designing Monte Carlo Simulations in R</title>
  <meta name="description" content="A text on designing, implementing, and reporting on Monte Carlo simulation studies" />
  <meta name="generator" content="bookdown 0.38 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 17 Optimizing code (and why you often shouldn’t) | Designing Monte Carlo Simulations in R" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="A text on designing, implementing, and reporting on Monte Carlo simulation studies" />
  <meta name="github-repo" content="jepusto/Designing-Simulations-in-R" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 17 Optimizing code (and why you often shouldn’t) | Designing Monte Carlo Simulations in R" />
  
  <meta name="twitter:description" content="A text on designing, implementing, and reporting on Monte Carlo simulation studies" />
  

<meta name="author" content="Luke W. Miratrix and James E. Pustejovsky (Equal authors)" />


<meta name="date" content="2024-07-03" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="sec-reproducability.html"/>
<link rel="next" href="error-trapping-and-other-headaches.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>
<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Designing Simulations in R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#license"><i class="fa fa-check"></i>License</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#about-the-authors"><i class="fa fa-check"></i>About the authors</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#acknowledgements"><i class="fa fa-check"></i>Acknowledgements</a></li>
</ul></li>
<li class="part"><span><b>I An Introductory Look</b></span></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="introduction.html"><a href="introduction.html#some-of-simulations-many-uses"><i class="fa fa-check"></i><b>1.1</b> Some of simulation’s many uses</a>
<ul>
<li class="chapter" data-level="1.1.1" data-path="introduction.html"><a href="introduction.html#comparing-statistical-approaches"><i class="fa fa-check"></i><b>1.1.1</b> Comparing statistical approaches</a></li>
<li class="chapter" data-level="1.1.2" data-path="introduction.html"><a href="introduction.html#assessing-performance-of-complex-pipelines"><i class="fa fa-check"></i><b>1.1.2</b> Assessing performance of complex pipelines</a></li>
<li class="chapter" data-level="1.1.3" data-path="introduction.html"><a href="introduction.html#assessing-performance-under-misspecification"><i class="fa fa-check"></i><b>1.1.3</b> Assessing performance under misspecification</a></li>
<li class="chapter" data-level="1.1.4" data-path="introduction.html"><a href="introduction.html#assessing-the-finite-sample-performance-of-a-statistical-approach"><i class="fa fa-check"></i><b>1.1.4</b> Assessing the finite sample performance of a statistical approach</a></li>
<li class="chapter" data-level="1.1.5" data-path="introduction.html"><a href="introduction.html#conducting-power-analyses"><i class="fa fa-check"></i><b>1.1.5</b> Conducting Power Analyses</a></li>
<li class="chapter" data-level="1.1.6" data-path="introduction.html"><a href="introduction.html#simulating-processess"><i class="fa fa-check"></i><b>1.1.6</b> Simulating processess</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="introduction.html"><a href="introduction.html#the-perils-of-simulation-as-evidence"><i class="fa fa-check"></i><b>1.2</b> The perils of simulation as evidence</a></li>
<li class="chapter" data-level="1.3" data-path="introduction.html"><a href="introduction.html#simulation-hacking"><i class="fa fa-check"></i><b>1.3</b> Simulation-hacking</a></li>
<li class="chapter" data-level="1.4" data-path="introduction.html"><a href="introduction.html#simulating-to-learn"><i class="fa fa-check"></i><b>1.4</b> Simulating to learn</a></li>
<li class="chapter" data-level="1.5" data-path="introduction.html"><a href="introduction.html#organization-of-the-text"><i class="fa fa-check"></i><b>1.5</b> Organization of the text</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html"><i class="fa fa-check"></i><b>2</b> Programming Preliminaries</a>
<ul>
<li class="chapter" data-level="2.1" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#why-r"><i class="fa fa-check"></i><b>2.1</b> Why R?</a></li>
<li class="chapter" data-level="2.2" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#welcome-to-the-tidyverse"><i class="fa fa-check"></i><b>2.2</b> Welcome to the tidyverse</a></li>
<li class="chapter" data-level="2.3" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#functions"><i class="fa fa-check"></i><b>2.3</b> Functions</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#rolling-your-own"><i class="fa fa-check"></i><b>2.3.1</b> Rolling your own</a></li>
<li class="chapter" data-level="2.3.2" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#a-dangerous-function"><i class="fa fa-check"></i><b>2.3.2</b> A dangerous function</a></li>
<li class="chapter" data-level="2.3.3" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#using-named-arguments"><i class="fa fa-check"></i><b>2.3.3</b> Using Named Arguments</a></li>
<li class="chapter" data-level="2.3.4" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#argument-defaults"><i class="fa fa-check"></i><b>2.3.4</b> Argument Defaults</a></li>
<li class="chapter" data-level="2.3.5" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#function-skeletons"><i class="fa fa-check"></i><b>2.3.5</b> Function skeletons</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#pipe-dreams"><i class="fa fa-check"></i><b>2.4</b> <code>%&gt;%</code> (Pipe) dreams</a></li>
<li class="chapter" data-level="2.5" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#recipes-versus-patterns"><i class="fa fa-check"></i><b>2.5</b> Recipes versus Patterns</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="t-test-simulation.html"><a href="t-test-simulation.html"><i class="fa fa-check"></i><b>3</b> An initial simulation</a>
<ul>
<li class="chapter" data-level="3.1" data-path="t-test-simulation.html"><a href="t-test-simulation.html#simulating-a-single-scenario"><i class="fa fa-check"></i><b>3.1</b> Simulating a single scenario</a></li>
<li class="chapter" data-level="3.2" data-path="t-test-simulation.html"><a href="t-test-simulation.html#a-non-normal-population-distribution"><i class="fa fa-check"></i><b>3.2</b> A non-normal population distribution</a></li>
<li class="chapter" data-level="3.3" data-path="t-test-simulation.html"><a href="t-test-simulation.html#simulating-across-different-scenarios"><i class="fa fa-check"></i><b>3.3</b> Simulating across different scenarios</a></li>
<li class="chapter" data-level="3.4" data-path="t-test-simulation.html"><a href="t-test-simulation.html#extending-the-simulation-design"><i class="fa fa-check"></i><b>3.4</b> Extending the simulation design</a></li>
<li class="chapter" data-level="3.5" data-path="t-test-simulation.html"><a href="t-test-simulation.html#exercises"><i class="fa fa-check"></i><b>3.5</b> Exercises</a></li>
<li class="chapter" data-level="3.6" data-path="t-test-simulation.html"><a href="t-test-simulation.html#challenges"><i class="fa fa-check"></i><b>3.6</b> Challenges</a></li>
</ul></li>
<li class="part"><span><b>II Structure and Mechanics of a Simulation Study</b></span></li>
<li class="chapter" data-level="4" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html"><i class="fa fa-check"></i><b>4</b> Structure of a simulation study</a>
<ul>
<li class="chapter" data-level="4.1" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#general-structure-of-a-simulation"><i class="fa fa-check"></i><b>4.1</b> General structure of a simulation</a></li>
<li class="chapter" data-level="4.2" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#tidy-modular-simulations"><i class="fa fa-check"></i><b>4.2</b> Tidy, modular simulations</a></li>
<li class="chapter" data-level="4.3" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#skeleton-of-a-simulation-study"><i class="fa fa-check"></i><b>4.3</b> Skeleton of a simulation study</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#data-generating-process"><i class="fa fa-check"></i><b>4.3.1</b> Data-Generating Process</a></li>
<li class="chapter" data-level="4.3.2" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#data-analysis-procedure"><i class="fa fa-check"></i><b>4.3.2</b> Data Analysis Procedure</a></li>
<li class="chapter" data-level="4.3.3" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#repetition"><i class="fa fa-check"></i><b>4.3.3</b> Repetition</a></li>
<li class="chapter" data-level="4.3.4" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#performance-summaries"><i class="fa fa-check"></i><b>4.3.4</b> Performance summaries</a></li>
<li class="chapter" data-level="4.3.5" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#multifactor-simulations"><i class="fa fa-check"></i><b>4.3.5</b> Multifactor simulations</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#exercises-1"><i class="fa fa-check"></i><b>4.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="case-ANOVA.html"><a href="case-ANOVA.html"><i class="fa fa-check"></i><b>5</b> Case Study: Heteroskedastic ANOVA</a>
<ul>
<li class="chapter" data-level="5.1" data-path="case-ANOVA.html"><a href="case-ANOVA.html#the-data-generating-model"><i class="fa fa-check"></i><b>5.1</b> The data-generating model</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="case-ANOVA.html"><a href="case-ANOVA.html#now-make-a-function"><i class="fa fa-check"></i><b>5.1.1</b> Now make a function</a></li>
<li class="chapter" data-level="5.1.2" data-path="case-ANOVA.html"><a href="case-ANOVA.html#cautious-coding"><i class="fa fa-check"></i><b>5.1.2</b> Cautious coding</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="case-ANOVA.html"><a href="case-ANOVA.html#the-hypothesis-testing-procedures"><i class="fa fa-check"></i><b>5.2</b> The hypothesis testing procedures</a></li>
<li class="chapter" data-level="5.3" data-path="case-ANOVA.html"><a href="case-ANOVA.html#running-the-simulation"><i class="fa fa-check"></i><b>5.3</b> Running the simulation</a></li>
<li class="chapter" data-level="5.4" data-path="case-ANOVA.html"><a href="case-ANOVA.html#summarizing-test-performance"><i class="fa fa-check"></i><b>5.4</b> Summarizing Test Performance</a></li>
<li class="chapter" data-level="5.5" data-path="case-ANOVA.html"><a href="case-ANOVA.html#exAnovaExercises"><i class="fa fa-check"></i><b>5.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="data-generating-processes.html"><a href="data-generating-processes.html"><i class="fa fa-check"></i><b>6</b> Data-Generating Processes</a>
<ul>
<li class="chapter" data-level="6.1" data-path="data-generating-processes.html"><a href="data-generating-processes.html#a-statistical-model-is-a-recipe-for-data-generation"><i class="fa fa-check"></i><b>6.1</b> A statistical model is a recipe for data generation</a></li>
<li class="chapter" data-level="6.2" data-path="data-generating-processes.html"><a href="data-generating-processes.html#checking-the-data-generating-function"><i class="fa fa-check"></i><b>6.2</b> Checking the data-generating function</a></li>
<li class="chapter" data-level="6.3" data-path="data-generating-processes.html"><a href="data-generating-processes.html#case-cluster"><i class="fa fa-check"></i><b>6.3</b> Example: Simulating clustered data</a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="data-generating-processes.html"><a href="data-generating-processes.html#a-design-decision-what-do-we-want-to-manipulate"><i class="fa fa-check"></i><b>6.3.1</b> A design decision: What do we want to manipulate?</a></li>
<li class="chapter" data-level="6.3.2" data-path="data-generating-processes.html"><a href="data-generating-processes.html#a-model-for-a-cluster-rct"><i class="fa fa-check"></i><b>6.3.2</b> A model for a cluster RCT</a></li>
<li class="chapter" data-level="6.3.3" data-path="data-generating-processes.html"><a href="data-generating-processes.html#converting-our-model-to-code"><i class="fa fa-check"></i><b>6.3.3</b> Converting our model to code</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="data-generating-processes.html"><a href="data-generating-processes.html#exercises-2"><i class="fa fa-check"></i><b>6.4</b> Exercises</a>
<ul>
<li class="chapter" data-level="6.4.1" data-path="data-generating-processes.html"><a href="data-generating-processes.html#ex_dgp"><i class="fa fa-check"></i><b>6.4.1</b> The Welch test on a shifted-and-scaled <span class="math inline">\(t\)</span> distribution</a></li>
<li class="chapter" data-level="6.4.2" data-path="data-generating-processes.html"><a href="data-generating-processes.html#checking-and-extending-the-cluster-rct-dgp"><i class="fa fa-check"></i><b>6.4.2</b> Checking and extending the Cluster RCT DGP</a></li>
</ul></li>
<li class="chapter" data-level="6.5" data-path="data-generating-processes.html"><a href="data-generating-processes.html#extension-standardization-in-a-data-generating-process"><i class="fa fa-check"></i><b>6.5</b> Extension: Standardization in a data generating process</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html"><i class="fa fa-check"></i><b>7</b> Data analysis procedures</a>
<ul>
<li class="chapter" data-level="7.1" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#validating-estimation-procedures"><i class="fa fa-check"></i><b>7.1</b> Validating Estimation Procedures</a></li>
<li class="chapter" data-level="7.2" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#checking-via-simulation"><i class="fa fa-check"></i><b>7.2</b> Checking via simulation</a></li>
<li class="chapter" data-level="7.3" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#including-multiple-estimation-procedures"><i class="fa fa-check"></i><b>7.3</b> Including Multiple estimation procedures</a></li>
<li class="chapter" data-level="7.4" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#exercises-3"><i class="fa fa-check"></i><b>7.4</b> Exercises</a>
<ul>
<li class="chapter" data-level="7.4.1" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#more-welch-and-adding-the-bff-test"><i class="fa fa-check"></i><b>7.4.1</b> More Welch and adding the BFF test</a></li>
<li class="chapter" data-level="7.4.2" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#more-estimators-for-cluster-randomized-trials"><i class="fa fa-check"></i><b>7.4.2</b> More estimators for Cluster Randomized Trials</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html"><i class="fa fa-check"></i><b>8</b> Running the Simulation Process</a>
<ul>
<li class="chapter" data-level="8.1" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#writing-simulations-quick-with-the-simhelpers-package"><i class="fa fa-check"></i><b>8.1</b> Writing simulations quick with the simhelpers package</a></li>
<li class="chapter" data-level="8.2" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#adding-checks-and-balances"><i class="fa fa-check"></i><b>8.2</b> Adding Checks and Balances</a></li>
<li class="chapter" data-level="8.3" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#exercises-4"><i class="fa fa-check"></i><b>8.3</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="performance-criteria.html"><a href="performance-criteria.html"><i class="fa fa-check"></i><b>9</b> Performance criteria</a>
<ul>
<li class="chapter" data-level="9.1" data-path="performance-criteria.html"><a href="performance-criteria.html#inference-vs.-estimation"><i class="fa fa-check"></i><b>9.1</b> Inference vs. Estimation</a></li>
<li class="chapter" data-level="9.2" data-path="performance-criteria.html"><a href="performance-criteria.html#ways-of-assessing-and-comparing-estimation-procedures"><i class="fa fa-check"></i><b>9.2</b> Ways of Assessing and Comparing Estimation Procedures</a></li>
<li class="chapter" data-level="9.3" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-a-point-estimator"><i class="fa fa-check"></i><b>9.3</b> Assessing a Point Estimator</a>
<ul>
<li class="chapter" data-level="9.3.1" data-path="performance-criteria.html"><a href="performance-criteria.html#comparing-the-performances-of-the-cluster-rct-estimation-procedures"><i class="fa fa-check"></i><b>9.3.1</b> Comparing the Performances of the Cluster RCT Estimation Procedures</a></li>
<li class="chapter" data-level="9.3.2" data-path="performance-criteria.html"><a href="performance-criteria.html#handling-estimands-not-represented-by-a-parameter"><i class="fa fa-check"></i><b>9.3.2</b> Handling Estimands Not Represented By a Parameter</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-a-standard-error-estimator"><i class="fa fa-check"></i><b>9.4</b> Assessing a Standard Error Estimator</a>
<ul>
<li class="chapter" data-level="9.4.1" data-path="performance-criteria.html"><a href="performance-criteria.html#why-not-assess-the-estimated-se-directly"><i class="fa fa-check"></i><b>9.4.1</b> Why Not Assess the Estimated SE directly?</a></li>
<li class="chapter" data-level="9.4.2" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-ses-for-our-cluster-rct-simulation"><i class="fa fa-check"></i><b>9.4.2</b> Assessing SEs for Our Cluster RCT Simulation</a></li>
</ul></li>
<li class="chapter" data-level="9.5" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-an-inferential-procedure-hypothesis-testing"><i class="fa fa-check"></i><b>9.5</b> Assessing an Inferential Procedure (Hypothesis Testing)</a>
<ul>
<li class="chapter" data-level="9.5.1" data-path="performance-criteria.html"><a href="performance-criteria.html#validity"><i class="fa fa-check"></i><b>9.5.1</b> Validity</a></li>
<li class="chapter" data-level="9.5.2" data-path="performance-criteria.html"><a href="performance-criteria.html#power"><i class="fa fa-check"></i><b>9.5.2</b> Power</a></li>
<li class="chapter" data-level="9.5.3" data-path="performance-criteria.html"><a href="performance-criteria.html#the-rejection-rate"><i class="fa fa-check"></i><b>9.5.3</b> The Rejection Rate</a></li>
<li class="chapter" data-level="9.5.4" data-path="performance-criteria.html"><a href="performance-criteria.html#inference-in-our-cluster-rct-simulation"><i class="fa fa-check"></i><b>9.5.4</b> Inference in our Cluster RCT Simulation</a></li>
</ul></li>
<li class="chapter" data-level="9.6" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-confidence-intervals"><i class="fa fa-check"></i><b>9.6</b> Assessing Confidence Intervals</a>
<ul>
<li class="chapter" data-level="9.6.1" data-path="performance-criteria.html"><a href="performance-criteria.html#confidence-intervals-in-our-cluster-rct-example"><i class="fa fa-check"></i><b>9.6.1</b> Confidence Intervals in our Cluster RCT Example</a></li>
</ul></li>
<li class="chapter" data-level="9.7" data-path="performance-criteria.html"><a href="performance-criteria.html#additional-thoughts-on-measuring-performance"><i class="fa fa-check"></i><b>9.7</b> Additional Thoughts on Measuring Performance</a>
<ul>
<li class="chapter" data-level="9.7.1" data-path="performance-criteria.html"><a href="performance-criteria.html#sec-relative-performance"><i class="fa fa-check"></i><b>9.7.1</b> Selecting Relative vs. Absolute Criteria</a></li>
<li class="chapter" data-level="9.7.2" data-path="performance-criteria.html"><a href="performance-criteria.html#robust-measures-of-performance"><i class="fa fa-check"></i><b>9.7.2</b> Robust Measures of Performance</a></li>
<li class="chapter" data-level="9.7.3" data-path="performance-criteria.html"><a href="performance-criteria.html#summary-of-peformance-measures"><i class="fa fa-check"></i><b>9.7.3</b> Summary of Peformance Measures</a></li>
</ul></li>
<li class="chapter" data-level="9.8" data-path="performance-criteria.html"><a href="performance-criteria.html#uncertainty-in-performance-estimates-the-mcse"><i class="fa fa-check"></i><b>9.8</b> Uncertainty in Performance Estimates (the MCSE)</a>
<ul>
<li class="chapter" data-level="9.8.1" data-path="performance-criteria.html"><a href="performance-criteria.html#mcse-for-relative-variance-estimators"><i class="fa fa-check"></i><b>9.8.1</b> MCSE for Relative Variance Estimators</a></li>
<li class="chapter" data-level="9.8.2" data-path="performance-criteria.html"><a href="performance-criteria.html#calculating-mcses-with-the-simhelpers-package"><i class="fa fa-check"></i><b>9.8.2</b> Calculating MCSEs With the <code>simhelpers</code> Package</a></li>
<li class="chapter" data-level="9.8.3" data-path="performance-criteria.html"><a href="performance-criteria.html#mcse-calculation-in-our-cluster-rct-example"><i class="fa fa-check"></i><b>9.8.3</b> MCSE Calculation in our Cluster RCT Example</a></li>
</ul></li>
<li class="chapter" data-level="9.9" data-path="performance-criteria.html"><a href="performance-criteria.html#exercises-5"><i class="fa fa-check"></i><b>9.9</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="case_Cronbach.html"><a href="case_Cronbach.html"><i class="fa fa-check"></i><b>10</b> Project: Cronbach Alpha</a>
<ul>
<li class="chapter" data-level="10.1" data-path="case_Cronbach.html"><a href="case_Cronbach.html#background"><i class="fa fa-check"></i><b>10.1</b> Background</a></li>
<li class="chapter" data-level="10.2" data-path="case_Cronbach.html"><a href="case_Cronbach.html#getting-started"><i class="fa fa-check"></i><b>10.2</b> Getting started</a></li>
<li class="chapter" data-level="10.3" data-path="case_Cronbach.html"><a href="case_Cronbach.html#the-data-generating-function"><i class="fa fa-check"></i><b>10.3</b> The data-generating function</a></li>
<li class="chapter" data-level="10.4" data-path="case_Cronbach.html"><a href="case_Cronbach.html#the-estimation-function"><i class="fa fa-check"></i><b>10.4</b> The estimation function</a>
<ul>
<li class="chapter" data-level="10.4.1" data-path="case_Cronbach.html"><a href="case_Cronbach.html#exercices-naive-confidence-intervals"><i class="fa fa-check"></i><b>10.4.1</b> Exercices (Naive confidence intervals)</a></li>
</ul></li>
<li class="chapter" data-level="10.5" data-path="case_Cronbach.html"><a href="case_Cronbach.html#estimator-performance"><i class="fa fa-check"></i><b>10.5</b> Estimator performance</a>
<ul>
<li class="chapter" data-level="10.5.1" data-path="case_Cronbach.html"><a href="case_Cronbach.html#exercises-calculating-performance"><i class="fa fa-check"></i><b>10.5.1</b> Exercises (Calculating Performance)</a></li>
</ul></li>
<li class="chapter" data-level="10.6" data-path="case_Cronbach.html"><a href="case_Cronbach.html#replication-and-the-simulation"><i class="fa fa-check"></i><b>10.6</b> Replication (and the simulation)</a></li>
<li class="chapter" data-level="10.7" data-path="case_Cronbach.html"><a href="case_Cronbach.html#extension-confidence-interval-coverage"><i class="fa fa-check"></i><b>10.7</b> Extension: Confidence interval coverage</a></li>
<li class="chapter" data-level="10.8" data-path="case_Cronbach.html"><a href="case_Cronbach.html#a-taste-of-multiple-scenarios"><i class="fa fa-check"></i><b>10.8</b> A taste of multiple scenarios</a>
<ul>
<li class="chapter" data-level="10.8.1" data-path="case_Cronbach.html"><a href="case_Cronbach.html#exercises-6"><i class="fa fa-check"></i><b>10.8.1</b> Exercises</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="11" data-path="case-study-attrition-in-a-simple-randomized-experiment.html"><a href="case-study-attrition-in-a-simple-randomized-experiment.html"><i class="fa fa-check"></i><b>11</b> Case study: Attrition in a simple randomized experiment</a>
<ul>
<li class="chapter" data-level="11.1" data-path="case-study-attrition-in-a-simple-randomized-experiment.html"><a href="case-study-attrition-in-a-simple-randomized-experiment.html#the-data-generating-process"><i class="fa fa-check"></i><b>11.1</b> The data generating process</a></li>
<li class="chapter" data-level="11.2" data-path="case-study-attrition-in-a-simple-randomized-experiment.html"><a href="case-study-attrition-in-a-simple-randomized-experiment.html#estimators"><i class="fa fa-check"></i><b>11.2</b> Estimators</a></li>
<li class="chapter" data-level="11.3" data-path="case-study-attrition-in-a-simple-randomized-experiment.html"><a href="case-study-attrition-in-a-simple-randomized-experiment.html#performance-criteria-1"><i class="fa fa-check"></i><b>11.3</b> Performance criteria</a></li>
</ul></li>
<li class="part"><span><b>III Multifactor Simulations</b></span></li>
<li class="chapter" data-level="12" data-path="exp-design.html"><a href="exp-design.html"><i class="fa fa-check"></i><b>12</b> Designing the multifactor simulation experiment</a>
<ul>
<li class="chapter" data-level="12.1" data-path="exp-design.html"><a href="exp-design.html#choosing-parameter-combinations"><i class="fa fa-check"></i><b>12.1</b> Choosing parameter combinations</a>
<ul>
<li class="chapter" data-level="12.1.1" data-path="exp-design.html"><a href="exp-design.html#choosing-parameters-for-the-clustered-rct"><i class="fa fa-check"></i><b>12.1.1</b> Choosing parameters for the Clustered RCT</a></li>
</ul></li>
<li class="chapter" data-level="12.2" data-path="exp-design.html"><a href="exp-design.html#using-pmap-to-run-multifactor-simulations"><i class="fa fa-check"></i><b>12.2</b> Using pmap to run multifactor simulations</a></li>
<li class="chapter" data-level="12.3" data-path="exp-design.html"><a href="exp-design.html#ways-of-repeating-oneself"><i class="fa fa-check"></i><b>12.3</b> Ways of repeating oneself</a>
<ul>
<li class="chapter" data-level="12.3.1" data-path="exp-design.html"><a href="exp-design.html#getting-raw-results-ready-for-analysis"><i class="fa fa-check"></i><b>12.3.1</b> Getting raw results ready for analysis</a></li>
</ul></li>
<li class="chapter" data-level="12.4" data-path="exp-design.html"><a href="exp-design.html#running-the-cluster-rct-multifactor-experiment"><i class="fa fa-check"></i><b>12.4</b> Running the Cluster RCT multifactor experiment</a>
<ul>
<li class="chapter" data-level="12.4.1" data-path="exp-design.html"><a href="exp-design.html#making-analyze_data-quiet"><i class="fa fa-check"></i><b>12.4.1</b> Making analyze_data() quiet</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="13" data-path="analyzing-the-multifactor-experiment.html"><a href="analyzing-the-multifactor-experiment.html"><i class="fa fa-check"></i><b>13</b> Analyzing the multifactor experiment</a>
<ul>
<li class="chapter" data-level="13.1" data-path="analyzing-the-multifactor-experiment.html"><a href="analyzing-the-multifactor-experiment.html#bundling"><i class="fa fa-check"></i><b>13.1</b> Bundling</a></li>
<li class="chapter" data-level="13.2" data-path="analyzing-the-multifactor-experiment.html"><a href="analyzing-the-multifactor-experiment.html#aggregation"><i class="fa fa-check"></i><b>13.2</b> Aggregation</a></li>
<li class="chapter" data-level="13.3" data-path="analyzing-the-multifactor-experiment.html"><a href="analyzing-the-multifactor-experiment.html#regression-summarization"><i class="fa fa-check"></i><b>13.3</b> Regression Summarization</a></li>
<li class="chapter" data-level="13.4" data-path="analyzing-the-multifactor-experiment.html"><a href="analyzing-the-multifactor-experiment.html#focus-on-subset-kick-rest-to-supplement"><i class="fa fa-check"></i><b>13.4</b> Focus on subset, kick rest to supplement</a></li>
<li class="chapter" data-level="13.5" data-path="analyzing-the-multifactor-experiment.html"><a href="analyzing-the-multifactor-experiment.html#analyzing-results-when-some-trials-have-failed"><i class="fa fa-check"></i><b>13.5</b> Analyzing results when some trials have failed</a></li>
<li class="chapter" data-level="13.6" data-path="analyzing-the-multifactor-experiment.html"><a href="analyzing-the-multifactor-experiment.html#a-demonstration-of-visualization"><i class="fa fa-check"></i><b>13.6</b> A demonstration of visualization</a>
<ul>
<li class="chapter" data-level="13.6.1" data-path="analyzing-the-multifactor-experiment.html"><a href="analyzing-the-multifactor-experiment.html#the-initial-analysis"><i class="fa fa-check"></i><b>13.6.1</b> The initial analysis</a></li>
<li class="chapter" data-level="13.6.2" data-path="analyzing-the-multifactor-experiment.html"><a href="analyzing-the-multifactor-experiment.html#focusing-on-validity"><i class="fa fa-check"></i><b>13.6.2</b> Focusing on validity</a></li>
<li class="chapter" data-level="13.6.3" data-path="analyzing-the-multifactor-experiment.html"><a href="analyzing-the-multifactor-experiment.html#looking-at-main-effects"><i class="fa fa-check"></i><b>13.6.3</b> Looking at main effects</a></li>
<li class="chapter" data-level="13.6.4" data-path="analyzing-the-multifactor-experiment.html"><a href="analyzing-the-multifactor-experiment.html#recap"><i class="fa fa-check"></i><b>13.6.4</b> Recap</a></li>
</ul></li>
<li class="chapter" data-level="13.7" data-path="analyzing-the-multifactor-experiment.html"><a href="analyzing-the-multifactor-experiment.html#exercises-7"><i class="fa fa-check"></i><b>13.7</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="case-study-comparing-different-estimators.html"><a href="case-study-comparing-different-estimators.html"><i class="fa fa-check"></i><b>14</b> Case study: Comparing different estimators</a>
<ul>
<li class="chapter" data-level="14.1" data-path="case-study-comparing-different-estimators.html"><a href="case-study-comparing-different-estimators.html#the-data-generating-process-1"><i class="fa fa-check"></i><b>14.1</b> The data generating process</a></li>
<li class="chapter" data-level="14.2" data-path="case-study-comparing-different-estimators.html"><a href="case-study-comparing-different-estimators.html#the-data-analysis-methods"><i class="fa fa-check"></i><b>14.2</b> The data analysis methods</a></li>
<li class="chapter" data-level="14.3" data-path="case-study-comparing-different-estimators.html"><a href="case-study-comparing-different-estimators.html#the-simulation-itself"><i class="fa fa-check"></i><b>14.3</b> The simulation itself</a></li>
<li class="chapter" data-level="14.4" data-path="case-study-comparing-different-estimators.html"><a href="case-study-comparing-different-estimators.html#calculating-performance-measures-for-all-our-estimators"><i class="fa fa-check"></i><b>14.4</b> Calculating performance measures for all our estimators</a></li>
<li class="chapter" data-level="14.5" data-path="case-study-comparing-different-estimators.html"><a href="case-study-comparing-different-estimators.html#improving-the-visualization-of-the-results"><i class="fa fa-check"></i><b>14.5</b> Improving the visualization of the results</a></li>
<li class="chapter" data-level="14.6" data-path="case-study-comparing-different-estimators.html"><a href="case-study-comparing-different-estimators.html#extension-the-bias-variance-tradeoff"><i class="fa fa-check"></i><b>14.6</b> Extension: The Bias-variance tradeoff</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="presentation-of-simulation-results.html"><a href="presentation-of-simulation-results.html"><i class="fa fa-check"></i><b>15</b> Presentation of simulation results</a>
<ul>
<li class="chapter" data-level="15.1" data-path="presentation-of-simulation-results.html"><a href="presentation-of-simulation-results.html#tabulation"><i class="fa fa-check"></i><b>15.1</b> Tabulation</a></li>
<li class="chapter" data-level="15.2" data-path="presentation-of-simulation-results.html"><a href="presentation-of-simulation-results.html#visualization"><i class="fa fa-check"></i><b>15.2</b> Visualization</a>
<ul>
<li class="chapter" data-level="15.2.1" data-path="presentation-of-simulation-results.html"><a href="presentation-of-simulation-results.html#example-1-biserial-correlation-estimation"><i class="fa fa-check"></i><b>15.2.1</b> Example 1: Biserial correlation estimation</a></li>
<li class="chapter" data-level="15.2.2" data-path="presentation-of-simulation-results.html"><a href="presentation-of-simulation-results.html#example-2-variance-estimation-and-meta-regression"><i class="fa fa-check"></i><b>15.2.2</b> Example 2: Variance estimation and Meta-regression</a></li>
<li class="chapter" data-level="15.2.3" data-path="presentation-of-simulation-results.html"><a href="presentation-of-simulation-results.html#example-heat-maps-of-coverage"><i class="fa fa-check"></i><b>15.2.3</b> Example: Heat maps of coverage</a></li>
</ul></li>
<li class="chapter" data-level="15.3" data-path="presentation-of-simulation-results.html"><a href="presentation-of-simulation-results.html#modeling"><i class="fa fa-check"></i><b>15.3</b> Modeling</a></li>
</ul></li>
<li class="part"><span><b>IV Common Challenges with Large-Scale Simulations</b></span></li>
<li class="chapter" data-level="16" data-path="sec-reproducability.html"><a href="sec-reproducability.html"><i class="fa fa-check"></i><b>16</b> Ensuring reproducibility</a>
<ul>
<li class="chapter" data-level="16.1" data-path="sec-reproducability.html"><a href="sec-reproducability.html#seeds-and-pseudo-random-number-generators"><i class="fa fa-check"></i><b>16.1</b> Seeds and pseudo-random number generators</a></li>
<li class="chapter" data-level="16.2" data-path="sec-reproducability.html"><a href="sec-reproducability.html#including-seed-in-our-simulation-driver"><i class="fa fa-check"></i><b>16.2</b> Including seed in our simulation driver</a></li>
<li class="chapter" data-level="16.3" data-path="sec-reproducability.html"><a href="sec-reproducability.html#reasons-for-setting-the-seed"><i class="fa fa-check"></i><b>16.3</b> Reasons for setting the seed</a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="optimize-code.html"><a href="optimize-code.html"><i class="fa fa-check"></i><b>17</b> Optimizing code (and why you often shouldn’t)</a>
<ul>
<li class="chapter" data-level="17.1" data-path="optimize-code.html"><a href="optimize-code.html#hand-building-functions"><i class="fa fa-check"></i><b>17.1</b> Hand-building functions</a></li>
<li class="chapter" data-level="17.2" data-path="optimize-code.html"><a href="optimize-code.html#sec_comp_efficiency"><i class="fa fa-check"></i><b>17.2</b> Computational efficiency versus simplicity</a></li>
<li class="chapter" data-level="17.3" data-path="optimize-code.html"><a href="optimize-code.html#reusing-code-to-speed-up-computation"><i class="fa fa-check"></i><b>17.3</b> Reusing code to speed up computation</a></li>
</ul></li>
<li class="chapter" data-level="18" data-path="error-trapping-and-other-headaches.html"><a href="error-trapping-and-other-headaches.html"><i class="fa fa-check"></i><b>18</b> Error trapping and other headaches</a>
<ul>
<li class="chapter" data-level="18.1" data-path="error-trapping-and-other-headaches.html"><a href="error-trapping-and-other-headaches.html#safe_code"><i class="fa fa-check"></i><b>18.1</b> Safe code</a>
<ul>
<li class="chapter" data-level="18.1.1" data-path="error-trapping-and-other-headaches.html"><a href="error-trapping-and-other-headaches.html#making-a-safe-function-call"><i class="fa fa-check"></i><b>18.1.1</b> Making a safe function call</a></li>
<li class="chapter" data-level="18.1.2" data-path="error-trapping-and-other-headaches.html"><a href="error-trapping-and-other-headaches.html#what-to-do-with-warnings-in-simulations"><i class="fa fa-check"></i><b>18.1.2</b> What to do with warnings in simulations</a></li>
</ul></li>
<li class="chapter" data-level="18.2" data-path="error-trapping-and-other-headaches.html"><a href="error-trapping-and-other-headaches.html#about-stopifnot"><i class="fa fa-check"></i><b>18.2</b> Protecting your functions with “stop”</a></li>
</ul></li>
<li class="chapter" data-level="19" data-path="saving-files.html"><a href="saving-files.html"><i class="fa fa-check"></i><b>19</b> Saving files and results</a>
<ul>
<li class="chapter" data-level="19.1" data-path="saving-files.html"><a href="saving-files.html#saving-simulations-in-general"><i class="fa fa-check"></i><b>19.1</b> Saving simulations in general</a></li>
<li class="chapter" data-level="19.2" data-path="saving-files.html"><a href="saving-files.html#saving-simulations-as-you-go"><i class="fa fa-check"></i><b>19.2</b> Saving simulations as you go</a></li>
<li class="chapter" data-level="19.3" data-path="saving-files.html"><a href="saving-files.html#dynamically-making-directories"><i class="fa fa-check"></i><b>19.3</b> Dynamically making directories</a></li>
<li class="chapter" data-level="19.4" data-path="saving-files.html"><a href="saving-files.html#loading-and-combining-files-of-simulation-results"><i class="fa fa-check"></i><b>19.4</b> Loading and combining files of simulation results</a></li>
</ul></li>
<li class="chapter" data-level="20" data-path="parallel-processing.html"><a href="parallel-processing.html"><i class="fa fa-check"></i><b>20</b> Parallel Processing</a>
<ul>
<li class="chapter" data-level="20.1" data-path="parallel-processing.html"><a href="parallel-processing.html#parallel-on-your-computer"><i class="fa fa-check"></i><b>20.1</b> Parallel on your computer</a></li>
<li class="chapter" data-level="20.2" data-path="parallel-processing.html"><a href="parallel-processing.html#parallel-off-your-computer"><i class="fa fa-check"></i><b>20.2</b> Parallel off your computer</a>
<ul>
<li class="chapter" data-level="20.2.1" data-path="parallel-processing.html"><a href="parallel-processing.html#what-is-a-command-line-interface"><i class="fa fa-check"></i><b>20.2.1</b> What is a command-line interface?</a></li>
<li class="chapter" data-level="20.2.2" data-path="parallel-processing.html"><a href="parallel-processing.html#running-a-job-on-a-cluster"><i class="fa fa-check"></i><b>20.2.2</b> Running a job on a cluster</a></li>
<li class="chapter" data-level="20.2.3" data-path="parallel-processing.html"><a href="parallel-processing.html#checking-on-a-job"><i class="fa fa-check"></i><b>20.2.3</b> Checking on a job</a></li>
<li class="chapter" data-level="20.2.4" data-path="parallel-processing.html"><a href="parallel-processing.html#running-lots-of-jobs-on-a-cluster"><i class="fa fa-check"></i><b>20.2.4</b> Running lots of jobs on a cluster</a></li>
<li class="chapter" data-level="20.2.5" data-path="parallel-processing.html"><a href="parallel-processing.html#resources-for-harvards-odyssey"><i class="fa fa-check"></i><b>20.2.5</b> Resources for Harvard’s Odyssey</a></li>
<li class="chapter" data-level="20.2.6" data-path="parallel-processing.html"><a href="parallel-processing.html#acknowledgements-1"><i class="fa fa-check"></i><b>20.2.6</b> Acknowledgements</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="21" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html"><i class="fa fa-check"></i><b>21</b> Simulations as evidence</a>
<ul>
<li class="chapter" data-level="21.1" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#use-extensive-multi-factor-simulations"><i class="fa fa-check"></i><b>21.1</b> Use extensive multi-factor simulations</a></li>
<li class="chapter" data-level="21.2" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#beat-them-at-their-own-game"><i class="fa fa-check"></i><b>21.2</b> Beat them at their own game</a></li>
<li class="chapter" data-level="21.3" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#calibrated-simulations"><i class="fa fa-check"></i><b>21.3</b> Calibrated simulations</a></li>
</ul></li>
<li class="part"><span><b>V Specialized Use-Cases</b></span></li>
<li class="chapter" data-level="22" data-path="using-simulation-as-a-power-calculator.html"><a href="using-simulation-as-a-power-calculator.html"><i class="fa fa-check"></i><b>22</b> Using simulation as a power calculator</a>
<ul>
<li class="chapter" data-level="22.1" data-path="using-simulation-as-a-power-calculator.html"><a href="using-simulation-as-a-power-calculator.html#getting-design-parameters-from-pilot-data"><i class="fa fa-check"></i><b>22.1</b> Getting design parameters from pilot data</a></li>
<li class="chapter" data-level="22.2" data-path="using-simulation-as-a-power-calculator.html"><a href="using-simulation-as-a-power-calculator.html#the-data-generating-process-2"><i class="fa fa-check"></i><b>22.2</b> The data generating process</a></li>
<li class="chapter" data-level="22.3" data-path="using-simulation-as-a-power-calculator.html"><a href="using-simulation-as-a-power-calculator.html#running-the-simulation-1"><i class="fa fa-check"></i><b>22.3</b> Running the simulation</a></li>
<li class="chapter" data-level="22.4" data-path="using-simulation-as-a-power-calculator.html"><a href="using-simulation-as-a-power-calculator.html#evaluating-power"><i class="fa fa-check"></i><b>22.4</b> Evaluating power</a>
<ul>
<li class="chapter" data-level="22.4.1" data-path="using-simulation-as-a-power-calculator.html"><a href="using-simulation-as-a-power-calculator.html#checking-validity-of-our-models"><i class="fa fa-check"></i><b>22.4.1</b> Checking validity of our models</a></li>
<li class="chapter" data-level="22.4.2" data-path="using-simulation-as-a-power-calculator.html"><a href="using-simulation-as-a-power-calculator.html#assessing-precision-se"><i class="fa fa-check"></i><b>22.4.2</b> Assessing Precision (SE)</a></li>
<li class="chapter" data-level="22.4.3" data-path="using-simulation-as-a-power-calculator.html"><a href="using-simulation-as-a-power-calculator.html#assessing-power"><i class="fa fa-check"></i><b>22.4.3</b> Assessing power</a></li>
<li class="chapter" data-level="22.4.4" data-path="using-simulation-as-a-power-calculator.html"><a href="using-simulation-as-a-power-calculator.html#assessing-minimum-detectable-effects"><i class="fa fa-check"></i><b>22.4.4</b> Assessing Minimum Detectable Effects</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="23" data-path="chap-potential-outcomes.html"><a href="chap-potential-outcomes.html"><i class="fa fa-check"></i><b>23</b> Simulation under the Potential Outcomes Framework</a>
<ul>
<li class="chapter" data-level="23.1" data-path="chap-potential-outcomes.html"><a href="chap-potential-outcomes.html#finite-vs.-superpopulation-inference"><i class="fa fa-check"></i><b>23.1</b> Finite vs. Superpopulation inference</a></li>
<li class="chapter" data-level="23.2" data-path="chap-potential-outcomes.html"><a href="chap-potential-outcomes.html#data-generation-processes-for-potential-outcomes"><i class="fa fa-check"></i><b>23.2</b> Data generation processes for potential outcomes</a></li>
<li class="chapter" data-level="23.3" data-path="chap-potential-outcomes.html"><a href="chap-potential-outcomes.html#finite-sample-performance-measures"><i class="fa fa-check"></i><b>23.3</b> Finite sample performance measures</a></li>
<li class="chapter" data-level="23.4" data-path="chap-potential-outcomes.html"><a href="chap-potential-outcomes.html#nested-finite-simulation-procedure"><i class="fa fa-check"></i><b>23.4</b> Nested finite simulation procedure</a></li>
</ul></li>
<li class="chapter" data-level="24" data-path="the-parametric-bootstrap.html"><a href="the-parametric-bootstrap.html"><i class="fa fa-check"></i><b>24</b> The Parametric bootstrap</a>
<ul>
<li class="chapter" data-level="24.1" data-path="the-parametric-bootstrap.html"><a href="the-parametric-bootstrap.html#air-conditioners-a-stolen-case-study"><i class="fa fa-check"></i><b>24.1</b> Air conditioners: a stolen case study</a></li>
</ul></li>
<li class="part"><span><b>VI Appendices</b></span></li>
<li class="appendix"><span><b>Appendix</b></span></li>
<li class="chapter" data-level="A" data-path="on-functions.html"><a href="on-functions.html"><i class="fa fa-check"></i><b>A</b> Coding tidbits</a>
<ul>
<li class="chapter" data-level="A.1" data-path="on-functions.html"><a href="on-functions.html#repeating-oneself"><i class="fa fa-check"></i><b>A.1</b> Other ways of repeating yourself</a></li>
<li class="chapter" data-level="A.2" data-path="on-functions.html"><a href="on-functions.html#default-arguments"><i class="fa fa-check"></i><b>A.2</b> Default arguments for functions</a></li>
<li class="chapter" data-level="A.3" data-path="on-functions.html"><a href="on-functions.html#testing-and-debugging-code-in-your-scripts"><i class="fa fa-check"></i><b>A.3</b> Testing and debugging code in your scripts</a></li>
<li class="chapter" data-level="A.4" data-path="on-functions.html"><a href="on-functions.html#keep-multiple-files-of-code"><i class="fa fa-check"></i><b>A.4</b> Keep multiple files of code</a></li>
<li class="chapter" data-level="A.5" data-path="on-functions.html"><a href="on-functions.html#the-source-command-and-keeping-things-organized"><i class="fa fa-check"></i><b>A.5</b> The source command and keeping things organized</a></li>
<li class="chapter" data-level="A.6" data-path="on-functions.html"><a href="on-functions.html#debugging-with-browser"><i class="fa fa-check"></i><b>A.6</b> Debugging with browser</a></li>
</ul></li>
<li class="chapter" data-level="B" data-path="further-readings-and-resources.html"><a href="further-readings-and-resources.html"><i class="fa fa-check"></i><b>B</b> Further readings and resources</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Designing Monte Carlo Simulations in R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="optimize-code" class="section level1 hasAnchor" number="17">
<h1><span class="header-section-number">Chapter 17</span> Optimizing code (and why you often shouldn’t)<a href="optimize-code.html#optimize-code" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Optimizing code is when you spend a bit more human effort to write code that will run faster on your computer.
In some cases, this can be a critical boost to running a simulation, where you inherently will be doing things a lot of times.
Cutting runtime down will always be tempting, as it allows you to run more replicates and get more precisely estimated performance measures for your simulation.</p>
<p>That being said, beyond a few obvious coding tricks we will discuss, one should optimize code only after you discover you need to.
Optimizing as you go usually means you will spend a lot of time wrestling with code far more complicated than it needs to be.
For example, often it is the estimation method that will take a lot of computational time, so having very fast data generation code won’t help overall simulation runtimes much, as you are tweaking something that is only a small part of the overall pie, in terms of time.
Keep things simple; in general your time is more important than the computer’s time.</p>
<p>In the next sections we will look at a few optimization efforts applied to the ANOVA example in the prior chapters.</p>
<div id="hand-building-functions" class="section level2 hasAnchor" number="17.1">
<h2><span class="header-section-number">17.1</span> Hand-building functions<a href="optimize-code.html#hand-building-functions" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In the Welch example above, we used the system-implemented ANOVA.
An alternative approach would be to “hand roll” the ANOVA F statistic and test directly.
Doing so by hand can set you up to implement modified versions of these tests later on.
Also, although hand-building a method does take more work to program, it can result in a faster piece of code (this actually is the case here) which in turn can make the overall simulation faster.</p>
<p>Following the formulas on p. 129 of Brown and Forsythe (1974) we have (using data as generated in Chapter <a href="data-generating-processes.html#data-generating-processes">6</a>:</p>
<div class="sourceCode" id="cb396"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb396-1"><a href="optimize-code.html#cb396-1" tabindex="-1"></a>ANOVA_F <span class="ot">&lt;-</span> <span class="cf">function</span>(sim_data) {</span>
<span id="cb396-2"><a href="optimize-code.html#cb396-2" tabindex="-1"></a></span>
<span id="cb396-3"><a href="optimize-code.html#cb396-3" tabindex="-1"></a>  x_bar <span class="ot">&lt;-</span> <span class="fu">with</span>(sim_data, <span class="fu">tapply</span>(x, group, mean))</span>
<span id="cb396-4"><a href="optimize-code.html#cb396-4" tabindex="-1"></a>  s_sq <span class="ot">&lt;-</span> <span class="fu">with</span>(sim_data, <span class="fu">tapply</span>(x, group, var))</span>
<span id="cb396-5"><a href="optimize-code.html#cb396-5" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">table</span>(sim_data<span class="sc">$</span>group)</span>
<span id="cb396-6"><a href="optimize-code.html#cb396-6" tabindex="-1"></a>  g <span class="ot">&lt;-</span> <span class="fu">length</span>(x_bar)</span>
<span id="cb396-7"><a href="optimize-code.html#cb396-7" tabindex="-1"></a></span>
<span id="cb396-8"><a href="optimize-code.html#cb396-8" tabindex="-1"></a>  df1 <span class="ot">&lt;-</span> g <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb396-9"><a href="optimize-code.html#cb396-9" tabindex="-1"></a>  df2 <span class="ot">&lt;-</span> <span class="fu">sum</span>(n) <span class="sc">-</span> g</span>
<span id="cb396-10"><a href="optimize-code.html#cb396-10" tabindex="-1"></a></span>
<span id="cb396-11"><a href="optimize-code.html#cb396-11" tabindex="-1"></a>  msbtw <span class="ot">&lt;-</span> <span class="fu">sum</span>(n <span class="sc">*</span> (x_bar <span class="sc">-</span> <span class="fu">mean</span>(sim_data<span class="sc">$</span>x))<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> df1</span>
<span id="cb396-12"><a href="optimize-code.html#cb396-12" tabindex="-1"></a>  mswn <span class="ot">&lt;-</span> <span class="fu">sum</span>((n <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> s_sq) <span class="sc">/</span> df2</span>
<span id="cb396-13"><a href="optimize-code.html#cb396-13" tabindex="-1"></a>  fstat <span class="ot">&lt;-</span> msbtw <span class="sc">/</span> mswn</span>
<span id="cb396-14"><a href="optimize-code.html#cb396-14" tabindex="-1"></a>  pval <span class="ot">&lt;-</span> <span class="fu">pf</span>(fstat, df1, df2, <span class="at">lower.tail =</span> <span class="cn">FALSE</span>)</span>
<span id="cb396-15"><a href="optimize-code.html#cb396-15" tabindex="-1"></a></span>
<span id="cb396-16"><a href="optimize-code.html#cb396-16" tabindex="-1"></a>  <span class="fu">return</span>(pval)</span>
<span id="cb396-17"><a href="optimize-code.html#cb396-17" tabindex="-1"></a>}</span>
<span id="cb396-18"><a href="optimize-code.html#cb396-18" tabindex="-1"></a></span>
<span id="cb396-19"><a href="optimize-code.html#cb396-19" tabindex="-1"></a><span class="fu">ANOVA_F</span>(sim_data)</span></code></pre></div>
<pre><code>## [1] 0.009208908</code></pre>
<p>To see the difference between our version and R’s version, we can use an R package called <code>microbenchmark</code> to test how long the computations take for each version of the function.
The <code>microbenchmark</code> function runs each expression 100 times (by default) and tracks how long the computations take. It then summarizes the distribution of timings:</p>
<div class="sourceCode" id="cb398"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb398-1"><a href="optimize-code.html#cb398-1" tabindex="-1"></a><span class="fu">library</span>(microbenchmark)</span>
<span id="cb398-2"><a href="optimize-code.html#cb398-2" tabindex="-1"></a>timings <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(<span class="at">Rfunction =</span> <span class="fu">ANOVA_F_aov</span>(sim_data),</span>
<span id="cb398-3"><a href="optimize-code.html#cb398-3" tabindex="-1"></a>                          <span class="at">direct    =</span> <span class="fu">ANOVA_F</span>(sim_data))</span>
<span id="cb398-4"><a href="optimize-code.html#cb398-4" tabindex="-1"></a>timings</span></code></pre></div>
<pre><code>## Unit: microseconds
##       expr   min     lq    mean median     uq
##  Rfunction 396.1 433.15 588.332 458.95 699.05
##     direct 144.9 170.10 228.273 188.90 251.20
##     max neval
##  2309.4   100
##   550.3   100</code></pre>
<p>The direct function is 2.6 times faster than the built-in R function.</p>
<p>This result is not unusual.
Built-in R functions usually include lots of checks and error-handling, which take time to compute. These checks are crucial for messy, real-world data analysis but unnecessary with our pristine, simulated data.
Here we can skip them by doing the calculations directly.
In general, however, this is a trade-off: writing something yourself gives you a lot of chance to do something wrong, throwing off all your simulations. It might be faster, but you may pay dearly for it in terms of extra hours coding and debugging.
Optimize only if you need to!</p>
</div>
<div id="sec_comp_efficiency" class="section level2 hasAnchor" number="17.2">
<h2><span class="header-section-number">17.2</span> Computational efficiency versus simplicity<a href="optimize-code.html#sec_comp_efficiency" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>An alternative approach to having a function that, for each call, generates a single set of data, would be to write a function that generates <em>multiple</em> sets of simulated data all at once.</p>
<p>For example, for our ANOVA example we could specify that we want <code>R</code> replications of the study and have the function spit out a matrix with <code>R</code> columns, one for each simulated dataset:</p>
<div class="sourceCode" id="cb400"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb400-1"><a href="optimize-code.html#cb400-1" tabindex="-1"></a>generate_data_matrix <span class="ot">&lt;-</span> <span class="cf">function</span>(mu, sigma_sq, sample_size, R) {</span>
<span id="cb400-2"><a href="optimize-code.html#cb400-2" tabindex="-1"></a></span>
<span id="cb400-3"><a href="optimize-code.html#cb400-3" tabindex="-1"></a>  N <span class="ot">&lt;-</span> <span class="fu">sum</span>(sample_size) </span>
<span id="cb400-4"><a href="optimize-code.html#cb400-4" tabindex="-1"></a>  g <span class="ot">&lt;-</span> <span class="fu">length</span>(sample_size) </span>
<span id="cb400-5"><a href="optimize-code.html#cb400-5" tabindex="-1"></a>  </span>
<span id="cb400-6"><a href="optimize-code.html#cb400-6" tabindex="-1"></a>  group <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>g, <span class="at">times =</span> sample_size) </span>
<span id="cb400-7"><a href="optimize-code.html#cb400-7" tabindex="-1"></a>  mu_long <span class="ot">&lt;-</span> <span class="fu">rep</span>(mu, <span class="at">times =</span> sample_size)</span>
<span id="cb400-8"><a href="optimize-code.html#cb400-8" tabindex="-1"></a>  sigma_long <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">sqrt</span>(sigma_sq), <span class="at">times =</span> sample_size) </span>
<span id="cb400-9"><a href="optimize-code.html#cb400-9" tabindex="-1"></a></span>
<span id="cb400-10"><a href="optimize-code.html#cb400-10" tabindex="-1"></a>  x_mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(N <span class="sc">*</span> R, <span class="at">mean =</span> mu_long, <span class="at">sd =</span> sigma_long),</span>
<span id="cb400-11"><a href="optimize-code.html#cb400-11" tabindex="-1"></a>                  <span class="at">nrow =</span> N, <span class="at">ncol =</span> R)</span>
<span id="cb400-12"><a href="optimize-code.html#cb400-12" tabindex="-1"></a>  sim_data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">group =</span> group, <span class="at">x_mat =</span> x_mat)</span>
<span id="cb400-13"><a href="optimize-code.html#cb400-13" tabindex="-1"></a>    </span>
<span id="cb400-14"><a href="optimize-code.html#cb400-14" tabindex="-1"></a>  <span class="fu">return</span>(sim_data)</span>
<span id="cb400-15"><a href="optimize-code.html#cb400-15" tabindex="-1"></a>}</span>
<span id="cb400-16"><a href="optimize-code.html#cb400-16" tabindex="-1"></a></span>
<span id="cb400-17"><a href="optimize-code.html#cb400-17" tabindex="-1"></a><span class="fu">generate_data_matrix</span>(<span class="at">mu =</span> mu, <span class="at">sigma_sq =</span> sigma_sq,</span>
<span id="cb400-18"><a href="optimize-code.html#cb400-18" tabindex="-1"></a>                     <span class="at">sample_size =</span> sample_size, <span class="at">R =</span> <span class="dv">4</span>)</span></code></pre></div>
<pre><code>## $group
##  [1] 1 1 1 2 2 2 2 2 2 3 3 4 4 4 4
## 
## $x_mat
##             [,1]      [,2]       [,3]       [,4]
##  [1,]  2.1639323  1.646791 -0.9445957  1.2050393
##  [2,] -2.8225439  3.289125  0.8863700  3.7816431
##  [3,]  1.3419979 -3.020363  1.6196826  0.6425271
##  [4,] -0.5939495  1.184961  1.0200117  2.8301117
##  [5,]  0.1054279  3.499446  1.0267897  2.3166570
##  [6,]  4.0618127  4.340879  4.1291935 -1.0532910
##  [7,]  2.0611736  2.544518  1.3772973 -0.3861088
##  [8,]  2.2921786  2.299136  0.1706634  2.0329848
##  [9,]  2.5000308  3.686171  1.8712605  2.8557713
## [10,]  4.0966732  5.824634  6.6448117  2.6354699
## [11,]  5.9111997  3.480771  2.9453236  4.1680932
## [12,]  6.2201594  6.116809  5.8446326  6.2140816
## [13,]  5.9843999  6.488239  7.1954303  6.6280499
## [14,]  6.3928820  4.699057  5.9033074  8.8796297
## [15,]  7.9611464  7.282270  5.9095360  5.9131754</code></pre>
<p>This approach is a bit more computationally efficient because the setup calculations (getting <code>N</code>, <code>g</code>, <code>group</code>, <code>mu_full</code>, and <code>sigma_full</code>) only have to be done once instead of once per replication. It also makes clever use of vector recycling in the call to <code>rnorm()</code>. However, the structure of the resulting data is more complicated, which will make it more difficult to do the later estimation steps.
Furthermore, if the number of replicates <code>R</code> is large and each replication produces a large dataset, this “all-at-once” approach will entail generating and holding very large amounts of data in memory, which can create other performance issues.
On balance, we recommend the simpler approach of writing a function that generates a single simulated dataset per call (unless and until you have a principled reason to do otherwise).</p>
</div>
<div id="reusing-code-to-speed-up-computation" class="section level2 hasAnchor" number="17.3">
<h2><span class="header-section-number">17.3</span> Reusing code to speed up computation<a href="optimize-code.html#reusing-code-to-speed-up-computation" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Computational and programming efficiency should usually be a secondary consideration when you are starting to design a simulation study.
It is better to produce accurate code, even if it is a bit slow, than to write code that is speedy but hard to follow (or even worse, that produces incorrect results).
All that said, there is some glaring redundancy in the two functions used for the ANOVA simulation.
Both <code>ANOVA_F</code> and <code>Welch_F</code> start by taking the simulated data and calculating summary statistics for each group, using the following code:</p>
<div class="sourceCode" id="cb402"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb402-1"><a href="optimize-code.html#cb402-1" tabindex="-1"></a>x_bar <span class="ot">&lt;-</span> <span class="fu">with</span>(sim_data, <span class="fu">tapply</span>(x, group, mean))</span>
<span id="cb402-2"><a href="optimize-code.html#cb402-2" tabindex="-1"></a>s_sq <span class="ot">&lt;-</span> <span class="fu">with</span>(sim_data, <span class="fu">tapply</span>(x, group, var))</span>
<span id="cb402-3"><a href="optimize-code.html#cb402-3" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">table</span>(sim_data<span class="sc">$</span>group)</span>
<span id="cb402-4"><a href="optimize-code.html#cb402-4" tabindex="-1"></a>g <span class="ot">&lt;-</span> <span class="fu">length</span>(x_bar)</span></code></pre></div>
<p>In the interest of not repeating ourselves, it would better to pull this code out as a separate function and then re-write the <code>ANOVA_F</code> and <code>Welch_F</code> functions to take the summary statistics as input. Here is a function that takes simulated data and returns a list of summary statistics:</p>
<div class="sourceCode" id="cb403"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb403-1"><a href="optimize-code.html#cb403-1" tabindex="-1"></a>summarize_data <span class="ot">&lt;-</span> <span class="cf">function</span>(sim_data) {</span>
<span id="cb403-2"><a href="optimize-code.html#cb403-2" tabindex="-1"></a>  </span>
<span id="cb403-3"><a href="optimize-code.html#cb403-3" tabindex="-1"></a>  res <span class="ot">&lt;-</span> sim_data <span class="sc">%&gt;%</span> </span>
<span id="cb403-4"><a href="optimize-code.html#cb403-4" tabindex="-1"></a>    <span class="fu">group_by</span>( group ) <span class="sc">%&gt;%</span></span>
<span id="cb403-5"><a href="optimize-code.html#cb403-5" tabindex="-1"></a>    <span class="fu">summarise</span>( <span class="at">x_bar =</span> <span class="fu">mean</span>( x ),</span>
<span id="cb403-6"><a href="optimize-code.html#cb403-6" tabindex="-1"></a>               <span class="at">s_sq =</span> <span class="fu">var</span>( x ),</span>
<span id="cb403-7"><a href="optimize-code.html#cb403-7" tabindex="-1"></a>               <span class="at">n =</span> <span class="fu">n</span>() )</span>
<span id="cb403-8"><a href="optimize-code.html#cb403-8" tabindex="-1"></a>  res</span>
<span id="cb403-9"><a href="optimize-code.html#cb403-9" tabindex="-1"></a>}</span></code></pre></div>
<p>We just packaged the code from above, and puts our results in a nice table (and thus pivoted to using tidyverse to calculate these things):</p>
<div class="sourceCode" id="cb404"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb404-1"><a href="optimize-code.html#cb404-1" tabindex="-1"></a>sim_data <span class="ot">=</span> <span class="fu">generate_data</span>(<span class="at">mu=</span>mu, <span class="at">sigma_sq=</span>sigma_sq, <span class="at">sample_size=</span>sample_size)</span>
<span id="cb404-2"><a href="optimize-code.html#cb404-2" tabindex="-1"></a><span class="fu">summarize_data</span>(sim_data)</span></code></pre></div>
<pre><code>## # A tibble: 4 × 4
##   group x_bar  s_sq     n
##   &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt;
## 1     1  1.90 1.42      3
## 2     2  1.82 2.10      6
## 3     3  4.40 0.626     2
## 4     4  6.58 0.485     4</code></pre>
<p>Now we can re-write both <span class="math inline">\(F\)</span>-test functions to use the output of this function:</p>
<div class="sourceCode" id="cb406"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb406-1"><a href="optimize-code.html#cb406-1" tabindex="-1"></a>ANOVA_F_agg <span class="ot">&lt;-</span> <span class="cf">function</span>(x_bar, s_sq, n) {</span>
<span id="cb406-2"><a href="optimize-code.html#cb406-2" tabindex="-1"></a>  g <span class="ot">=</span> <span class="fu">length</span>(x_bar)</span>
<span id="cb406-3"><a href="optimize-code.html#cb406-3" tabindex="-1"></a>  df1 <span class="ot">&lt;-</span> g <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb406-4"><a href="optimize-code.html#cb406-4" tabindex="-1"></a>  df2 <span class="ot">&lt;-</span> <span class="fu">sum</span>(n) <span class="sc">-</span> g</span>
<span id="cb406-5"><a href="optimize-code.html#cb406-5" tabindex="-1"></a>  </span>
<span id="cb406-6"><a href="optimize-code.html#cb406-6" tabindex="-1"></a>  msbtw <span class="ot">&lt;-</span> <span class="fu">sum</span>(n <span class="sc">*</span> (x_bar <span class="sc">-</span> <span class="fu">weighted.mean</span>(x_bar, <span class="at">w =</span> n))<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> df1</span>
<span id="cb406-7"><a href="optimize-code.html#cb406-7" tabindex="-1"></a>  mswn <span class="ot">&lt;-</span> <span class="fu">sum</span>((n <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> s_sq) <span class="sc">/</span> df2</span>
<span id="cb406-8"><a href="optimize-code.html#cb406-8" tabindex="-1"></a>  fstat <span class="ot">&lt;-</span> msbtw <span class="sc">/</span> mswn</span>
<span id="cb406-9"><a href="optimize-code.html#cb406-9" tabindex="-1"></a>  pval <span class="ot">&lt;-</span> <span class="fu">pf</span>(fstat, df1, df2, <span class="at">lower.tail =</span> <span class="cn">FALSE</span>)</span>
<span id="cb406-10"><a href="optimize-code.html#cb406-10" tabindex="-1"></a> </span>
<span id="cb406-11"><a href="optimize-code.html#cb406-11" tabindex="-1"></a>  <span class="fu">return</span>(pval)</span>
<span id="cb406-12"><a href="optimize-code.html#cb406-12" tabindex="-1"></a>}</span>
<span id="cb406-13"><a href="optimize-code.html#cb406-13" tabindex="-1"></a></span>
<span id="cb406-14"><a href="optimize-code.html#cb406-14" tabindex="-1"></a>summary_stats <span class="ot">&lt;-</span> <span class="fu">summarize_data</span>(sim_data)</span>
<span id="cb406-15"><a href="optimize-code.html#cb406-15" tabindex="-1"></a><span class="fu">with</span>(summary_stats, <span class="fu">ANOVA_F_agg</span>(<span class="at">x_bar =</span> x_bar, <span class="at">s_sq =</span> s_sq, <span class="at">n =</span> n))</span></code></pre></div>
<pre><code>## [1] 0.0003129849</code></pre>
<div class="sourceCode" id="cb408"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb408-1"><a href="optimize-code.html#cb408-1" tabindex="-1"></a>Welch_F_agg <span class="ot">&lt;-</span> <span class="cf">function</span>(x_bar, s_sq, n) {</span>
<span id="cb408-2"><a href="optimize-code.html#cb408-2" tabindex="-1"></a>  g <span class="ot">=</span> <span class="fu">length</span>(x_bar)</span>
<span id="cb408-3"><a href="optimize-code.html#cb408-3" tabindex="-1"></a>  w <span class="ot">&lt;-</span> n <span class="sc">/</span> s_sq</span>
<span id="cb408-4"><a href="optimize-code.html#cb408-4" tabindex="-1"></a>  u <span class="ot">&lt;-</span> <span class="fu">sum</span>(w)</span>
<span id="cb408-5"><a href="optimize-code.html#cb408-5" tabindex="-1"></a>  x_tilde <span class="ot">&lt;-</span> <span class="fu">sum</span>(w <span class="sc">*</span> x_bar) <span class="sc">/</span> u</span>
<span id="cb408-6"><a href="optimize-code.html#cb408-6" tabindex="-1"></a>  msbtw <span class="ot">&lt;-</span> <span class="fu">sum</span>(w <span class="sc">*</span> (x_bar <span class="sc">-</span> x_tilde)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> (g <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb408-7"><a href="optimize-code.html#cb408-7" tabindex="-1"></a></span>
<span id="cb408-8"><a href="optimize-code.html#cb408-8" tabindex="-1"></a>  G <span class="ot">&lt;-</span> <span class="fu">sum</span>((<span class="dv">1</span> <span class="sc">-</span> w <span class="sc">/</span> u)<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> (n <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb408-9"><a href="optimize-code.html#cb408-9" tabindex="-1"></a>  denom <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">+</span>  G <span class="sc">*</span> <span class="dv">2</span> <span class="sc">*</span> (g <span class="sc">-</span> <span class="dv">2</span>) <span class="sc">/</span> (g<span class="sc">^</span><span class="dv">2</span> <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb408-10"><a href="optimize-code.html#cb408-10" tabindex="-1"></a>  W <span class="ot">&lt;-</span> msbtw <span class="sc">/</span> denom</span>
<span id="cb408-11"><a href="optimize-code.html#cb408-11" tabindex="-1"></a>  f <span class="ot">&lt;-</span> (g<span class="sc">^</span><span class="dv">2</span> <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">/</span> (<span class="dv">3</span> <span class="sc">*</span> G)</span>
<span id="cb408-12"><a href="optimize-code.html#cb408-12" tabindex="-1"></a></span>
<span id="cb408-13"><a href="optimize-code.html#cb408-13" tabindex="-1"></a>  pval <span class="ot">&lt;-</span> <span class="fu">pf</span>(W, <span class="at">df1 =</span> g <span class="sc">-</span> <span class="dv">1</span>, <span class="at">df2 =</span> f, <span class="at">lower.tail =</span> <span class="cn">FALSE</span>)</span>
<span id="cb408-14"><a href="optimize-code.html#cb408-14" tabindex="-1"></a></span>
<span id="cb408-15"><a href="optimize-code.html#cb408-15" tabindex="-1"></a>  <span class="fu">return</span>(pval)</span>
<span id="cb408-16"><a href="optimize-code.html#cb408-16" tabindex="-1"></a>}</span>
<span id="cb408-17"><a href="optimize-code.html#cb408-17" tabindex="-1"></a></span>
<span id="cb408-18"><a href="optimize-code.html#cb408-18" tabindex="-1"></a><span class="fu">with</span>(summary_stats, <span class="fu">ANOVA_F_agg</span>(<span class="at">x_bar =</span> x_bar, <span class="at">s_sq =</span> s_sq, <span class="at">n =</span> n))</span></code></pre></div>
<pre><code>## [1] 0.0003129849</code></pre>
<p>The results are the same as before.</p>
<p>We should always test any optimized code against something we know is stable, since optimization is an easy way to get bad bugs.
Here we check against R’s implementation:</p>
<div class="sourceCode" id="cb410"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb410-1"><a href="optimize-code.html#cb410-1" tabindex="-1"></a>summary_stats <span class="ot">&lt;-</span> <span class="fu">summarize_data</span>(sim_data)</span>
<span id="cb410-2"><a href="optimize-code.html#cb410-2" tabindex="-1"></a>F_results <span class="ot">&lt;-</span> <span class="fu">with</span>(summary_stats,</span>
<span id="cb410-3"><a href="optimize-code.html#cb410-3" tabindex="-1"></a>                  <span class="fu">ANOVA_F_agg</span>(<span class="at">x_bar =</span> x_bar, <span class="at">s_sq =</span> s_sq, <span class="at">n =</span> n))</span>
<span id="cb410-4"><a href="optimize-code.html#cb410-4" tabindex="-1"></a>aov_results <span class="ot">&lt;-</span> <span class="fu">oneway.test</span>(x <span class="sc">~</span> <span class="fu">factor</span>(group), <span class="at">data =</span> sim_data, </span>
<span id="cb410-5"><a href="optimize-code.html#cb410-5" tabindex="-1"></a>                           <span class="at">var.equal =</span> <span class="cn">TRUE</span>)</span>
<span id="cb410-6"><a href="optimize-code.html#cb410-6" tabindex="-1"></a><span class="fu">all.equal</span>(aov_results<span class="sc">$</span>p.value, F_results)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb412"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb412-1"><a href="optimize-code.html#cb412-1" tabindex="-1"></a>W_results <span class="ot">&lt;-</span> <span class="fu">with</span>(summary_stats,</span>
<span id="cb412-2"><a href="optimize-code.html#cb412-2" tabindex="-1"></a>                  <span class="fu">Welch_F_agg</span>( <span class="at">x_bar =</span> x_bar,</span>
<span id="cb412-3"><a href="optimize-code.html#cb412-3" tabindex="-1"></a>                               <span class="at">s_sq =</span> s_sq, <span class="at">n =</span> n))</span>
<span id="cb412-4"><a href="optimize-code.html#cb412-4" tabindex="-1"></a>aov_results <span class="ot">&lt;-</span> <span class="fu">oneway.test</span>(x <span class="sc">~</span> <span class="fu">factor</span>(group),</span>
<span id="cb412-5"><a href="optimize-code.html#cb412-5" tabindex="-1"></a>                           <span class="at">data =</span> sim_data, </span>
<span id="cb412-6"><a href="optimize-code.html#cb412-6" tabindex="-1"></a>                           <span class="at">var.equal =</span> <span class="cn">FALSE</span>)</span>
<span id="cb412-7"><a href="optimize-code.html#cb412-7" tabindex="-1"></a><span class="fu">all.equal</span>(aov_results<span class="sc">$</span>p.value, W_results)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p>Here we are able to check against a known baseline.
Checking estimation functions can be a bit more difficult for procedures that are not already implemented in R. For example, the two other procedures examined by Brown and Forsythe, the James’ test and Brown and Forsythe’s <span class="math inline">\(F*\)</span> test, are not available in base R.
They are, however, available in the user-contributed package <code>onewaytests</code>, found by searching for “Brown-Forsythe” at <a href="http://rseek.org/" class="uri">http://rseek.org/</a>. We could benchmark our calculations against this package, but of course there is some risk that the package might not be correct. Another route is to verify your results on numerical examples reported in authoritative papers, on the assumption that there’s less risk of an error there. In the original paper that proposed the test, Welch (1951) provides a worked numerical example of the procedure. He reports the following summary statistics:</p>
<div class="sourceCode" id="cb414"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb414-1"><a href="optimize-code.html#cb414-1" tabindex="-1"></a>g <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb414-2"><a href="optimize-code.html#cb414-2" tabindex="-1"></a>x_bar <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">27.8</span>, <span class="fl">24.1</span>, <span class="fl">22.2</span>)</span>
<span id="cb414-3"><a href="optimize-code.html#cb414-3" tabindex="-1"></a>s_sq <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">60.1</span>, <span class="fl">6.3</span>, <span class="fl">15.4</span>)</span>
<span id="cb414-4"><a href="optimize-code.html#cb414-4" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">20</span>, <span class="dv">10</span>)</span></code></pre></div>
<p>He also reports <span class="math inline">\(W = 3.35\)</span> and <span class="math inline">\(f = 22.6\)</span>. Replicating the calculations with our <code>Welch_F_agg</code> function:</p>
<div class="sourceCode" id="cb415"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb415-1"><a href="optimize-code.html#cb415-1" tabindex="-1"></a><span class="fu">Welch_F_agg</span>(<span class="at">x_bar =</span> x_bar, <span class="at">s_sq =</span> s_sq, <span class="at">n =</span> n)</span></code></pre></div>
<pre><code>## [1] 0.05479049</code></pre>
<p>We get slightly different results! But we know that our function is correct—or at least consistent with <code>oneway.test</code>—so what’s going on? It turns out that there was an error in some of Welch’s intermediate calculations, which can only be spotted because he reported all of his work in the paper.</p>
<p>We then put all these pieces in our revised <code>one_run()</code> method as so:</p>
<div class="sourceCode" id="cb417"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb417-1"><a href="optimize-code.html#cb417-1" tabindex="-1"></a>one_run_fast <span class="ot">&lt;-</span> <span class="cf">function</span>( mu, sigma_sq, sample_size ) {</span>
<span id="cb417-2"><a href="optimize-code.html#cb417-2" tabindex="-1"></a>  sim_data <span class="ot">&lt;-</span> <span class="fu">generate_data</span>(<span class="at">mu =</span> mu, <span class="at">sigma_sq =</span> sigma_sq,</span>
<span id="cb417-3"><a href="optimize-code.html#cb417-3" tabindex="-1"></a>                            <span class="at">sample_size =</span> sample_size)</span>
<span id="cb417-4"><a href="optimize-code.html#cb417-4" tabindex="-1"></a>  summary_stats <span class="ot">&lt;-</span> <span class="fu">summarize_data</span>(sim_data)</span>
<span id="cb417-5"><a href="optimize-code.html#cb417-5" tabindex="-1"></a>  anova_p <span class="ot">&lt;-</span> <span class="fu">with</span>(summary_stats, </span>
<span id="cb417-6"><a href="optimize-code.html#cb417-6" tabindex="-1"></a>                  <span class="fu">ANOVA_F_agg</span>(<span class="at">x_bar =</span> x_bar,<span class="at">s_sq =</span> s_sq, <span class="at">n =</span> n))</span>
<span id="cb417-7"><a href="optimize-code.html#cb417-7" tabindex="-1"></a>  Welch_p <span class="ot">&lt;-</span> <span class="fu">with</span>(summary_stats, </span>
<span id="cb417-8"><a href="optimize-code.html#cb417-8" tabindex="-1"></a>                  <span class="fu">Welch_F_agg</span>(<span class="at">x_bar =</span> x_bar, <span class="at">s_sq =</span> s_sq, <span class="at">n =</span> n))</span>
<span id="cb417-9"><a href="optimize-code.html#cb417-9" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">ANOVA =</span> anova_p, <span class="at">Welch =</span> Welch_p)</span>
<span id="cb417-10"><a href="optimize-code.html#cb417-10" tabindex="-1"></a>}</span>
<span id="cb417-11"><a href="optimize-code.html#cb417-11" tabindex="-1"></a></span>
<span id="cb417-12"><a href="optimize-code.html#cb417-12" tabindex="-1"></a><span class="fu">one_run_fast</span>( <span class="at">mu =</span> mu, <span class="at">sigma_sq =</span> sigma_sq,</span>
<span id="cb417-13"><a href="optimize-code.html#cb417-13" tabindex="-1"></a>              <span class="at">sample_size =</span> sample_size )</span></code></pre></div>
<pre><code>## # A tibble: 1 × 2
##      ANOVA  Welch
##      &lt;dbl&gt;  &lt;dbl&gt;
## 1 0.000982 0.0209</code></pre>
<p>The reason this is important is we are now doing our group aggregation only once, rather than once per method. We can use our microbenchmark to see our speedup:</p>
<div class="sourceCode" id="cb419"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb419-1"><a href="optimize-code.html#cb419-1" tabindex="-1"></a><span class="fu">library</span>(microbenchmark)</span>
<span id="cb419-2"><a href="optimize-code.html#cb419-2" tabindex="-1"></a>timings <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(<span class="at">noagg =</span> <span class="fu">one_run</span>(<span class="at">mu =</span> mu, <span class="at">sigma_sq =</span> sigma_sq, </span>
<span id="cb419-3"><a href="optimize-code.html#cb419-3" tabindex="-1"></a>                                          <span class="at">sample_size =</span> sample_size),</span>
<span id="cb419-4"><a href="optimize-code.html#cb419-4" tabindex="-1"></a>                          <span class="at">agg =</span> <span class="fu">one_run_fast</span>(<span class="at">mu =</span> mu, <span class="at">sigma_sq =</span> sigma_sq, </span>
<span id="cb419-5"><a href="optimize-code.html#cb419-5" tabindex="-1"></a>                                             <span class="at">sample_size =</span> sample_size) )</span>
<span id="cb419-6"><a href="optimize-code.html#cb419-6" tabindex="-1"></a>timings</span></code></pre></div>
<pre><code>## Unit: milliseconds
##   expr    min     lq     mean  median      uq
##  noagg 1.1908 1.3373 2.124915 1.60425 2.18975
##    agg 2.6710 3.1207 4.199560 4.19420 4.91855
##      max neval
##  25.1221   100
##  10.9427   100</code></pre>
<p>And our relative speedup is:</p>
<div class="sourceCode" id="cb421"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb421-1"><a href="optimize-code.html#cb421-1" tabindex="-1"></a><span class="fu">with</span>(<span class="fu">summary</span>(timings), <span class="fu">round</span>(mean[<span class="dv">1</span>] <span class="sc">/</span> mean[<span class="dv">2</span>], <span class="dv">1</span>))</span></code></pre></div>
<pre><code>## [1] 0.5</code></pre>
<p>To recap, there are two advantages of this kind of coding:</p>
<ol style="list-style-type: decimal">
<li><p>Code reuse is generally good because when you have the same code in multiple places it can make it harder to read and understand your code. If you see two blocks of code you might worry they are only mostly similar, not exactly similar, and waste time trying to differentiate. If you have a single, well-named function, you immediately know what a block of code is doing.</p></li>
<li><p>Saving the results of calculations can speed up your computation since you are saving your partial work. This can be useful to reduce calculations that are particularly time intensive.</p></li>
</ol>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="sec-reproducability.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="error-trapping-and-other-headaches.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/jepusto/Designing-Simulations-in-R/edit/master/090-optimization.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["Designing-Simulations-in-R.pdf", "Designing-Simulations-in-R.epub"],
"search": {
"engine": "lunr",
"options": null
},
"toc": {
"collapse": "section",
"scroll_highlight": true
},
"toolbar": {
"position": "fixed"
},
"info": true
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
