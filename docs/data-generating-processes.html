<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 6 Data-Generating Processes | Designing Monte Carlo Simulations in R</title>
  <meta name="description" content="A text on designing, implementing, and reporting on Monte Carlo simulation studies" />
  <meta name="generator" content="bookdown 0.43 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 6 Data-Generating Processes | Designing Monte Carlo Simulations in R" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="A text on designing, implementing, and reporting on Monte Carlo simulation studies" />
  <meta name="github-repo" content="jepusto/Designing-Simulations-in-R" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 6 Data-Generating Processes | Designing Monte Carlo Simulations in R" />
  
  <meta name="twitter:description" content="A text on designing, implementing, and reporting on Monte Carlo simulation studies" />
  

<meta name="author" content="Luke W. Miratrix and James E. Pustejovsky (Equal authors)" />


<meta name="date" content="2025-06-05" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="case-ANOVA.html"/>
<link rel="next" href="data-analysis-procedures.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>
<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Designing Simulations in R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#license"><i class="fa fa-check"></i>License</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#about-the-authors"><i class="fa fa-check"></i>About the authors</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#acknowledgements"><i class="fa fa-check"></i>Acknowledgements</a></li>
</ul></li>
<li class="part"><span><b>I An Introductory Look</b></span></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="introduction.html"><a href="introduction.html#some-of-simulations-many-uses"><i class="fa fa-check"></i><b>1.1</b> Some of simulation’s many uses</a>
<ul>
<li class="chapter" data-level="1.1.1" data-path="introduction.html"><a href="introduction.html#comparing-statistical-approaches"><i class="fa fa-check"></i><b>1.1.1</b> Comparing statistical approaches</a></li>
<li class="chapter" data-level="1.1.2" data-path="introduction.html"><a href="introduction.html#assessing-performance-of-complex-pipelines"><i class="fa fa-check"></i><b>1.1.2</b> Assessing performance of complex pipelines</a></li>
<li class="chapter" data-level="1.1.3" data-path="introduction.html"><a href="introduction.html#assessing-performance-under-misspecification"><i class="fa fa-check"></i><b>1.1.3</b> Assessing performance under misspecification</a></li>
<li class="chapter" data-level="1.1.4" data-path="introduction.html"><a href="introduction.html#assessing-the-finite-sample-performance-of-a-statistical-approach"><i class="fa fa-check"></i><b>1.1.4</b> Assessing the finite-sample performance of a statistical approach</a></li>
<li class="chapter" data-level="1.1.5" data-path="introduction.html"><a href="introduction.html#conducting-power-analyses"><i class="fa fa-check"></i><b>1.1.5</b> Conducting Power Analyses</a></li>
<li class="chapter" data-level="1.1.6" data-path="introduction.html"><a href="introduction.html#simulating-processess"><i class="fa fa-check"></i><b>1.1.6</b> Simulating processess</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="introduction.html"><a href="introduction.html#the-perils-of-simulation-as-evidence"><i class="fa fa-check"></i><b>1.2</b> The perils of simulation as evidence</a></li>
<li class="chapter" data-level="1.3" data-path="introduction.html"><a href="introduction.html#simulating-to-learn"><i class="fa fa-check"></i><b>1.3</b> Simulating to learn</a></li>
<li class="chapter" data-level="1.4" data-path="introduction.html"><a href="introduction.html#why-r"><i class="fa fa-check"></i><b>1.4</b> Why R?</a></li>
<li class="chapter" data-level="1.5" data-path="introduction.html"><a href="introduction.html#organization-of-the-text"><i class="fa fa-check"></i><b>1.5</b> Organization of the text</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html"><i class="fa fa-check"></i><b>2</b> Programming Preliminaries</a>
<ul>
<li class="chapter" data-level="2.1" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#welcome-to-the-tidyverse"><i class="fa fa-check"></i><b>2.1</b> Welcome to the tidyverse</a></li>
<li class="chapter" data-level="2.2" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#functions"><i class="fa fa-check"></i><b>2.2</b> Functions</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#rolling-your-own"><i class="fa fa-check"></i><b>2.2.1</b> Rolling your own</a></li>
<li class="chapter" data-level="2.2.2" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#a-dangerous-function"><i class="fa fa-check"></i><b>2.2.2</b> A dangerous function</a></li>
<li class="chapter" data-level="2.2.3" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#using-named-arguments"><i class="fa fa-check"></i><b>2.2.3</b> Using Named Arguments</a></li>
<li class="chapter" data-level="2.2.4" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#argument-defaults"><i class="fa fa-check"></i><b>2.2.4</b> Argument Defaults</a></li>
<li class="chapter" data-level="2.2.5" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#function-skeletons"><i class="fa fa-check"></i><b>2.2.5</b> Function skeletons</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#pipe-dreams"><i class="fa fa-check"></i><b>2.3</b> <code>\&gt;</code> (Pipe) dreams</a></li>
<li class="chapter" data-level="2.4" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#recipes-versus-patterns"><i class="fa fa-check"></i><b>2.4</b> Recipes versus Patterns</a></li>
<li class="chapter" data-level="2.5" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#exercises"><i class="fa fa-check"></i><b>2.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="t-test-simulation.html"><a href="t-test-simulation.html"><i class="fa fa-check"></i><b>3</b> An initial simulation</a>
<ul>
<li class="chapter" data-level="3.1" data-path="t-test-simulation.html"><a href="t-test-simulation.html#simulating-a-single-scenario"><i class="fa fa-check"></i><b>3.1</b> Simulating a single scenario</a></li>
<li class="chapter" data-level="3.2" data-path="t-test-simulation.html"><a href="t-test-simulation.html#a-non-normal-population-distribution"><i class="fa fa-check"></i><b>3.2</b> A non-normal population distribution</a></li>
<li class="chapter" data-level="3.3" data-path="t-test-simulation.html"><a href="t-test-simulation.html#simulating-across-different-scenarios"><i class="fa fa-check"></i><b>3.3</b> Simulating across different scenarios</a></li>
<li class="chapter" data-level="3.4" data-path="t-test-simulation.html"><a href="t-test-simulation.html#extending-the-simulation-design"><i class="fa fa-check"></i><b>3.4</b> Extending the simulation design</a></li>
<li class="chapter" data-level="3.5" data-path="t-test-simulation.html"><a href="t-test-simulation.html#exercises-1"><i class="fa fa-check"></i><b>3.5</b> Exercises</a></li>
</ul></li>
<li class="part"><span><b>II Structure and Mechanics of a Simulation Study</b></span></li>
<li class="chapter" data-level="4" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html"><i class="fa fa-check"></i><b>4</b> Structure of a simulation study</a>
<ul>
<li class="chapter" data-level="4.1" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#general-structure-of-a-simulation"><i class="fa fa-check"></i><b>4.1</b> General structure of a simulation</a></li>
<li class="chapter" data-level="4.2" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#tidy-modular-simulations"><i class="fa fa-check"></i><b>4.2</b> Tidy, modular simulations</a></li>
<li class="chapter" data-level="4.3" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#skeleton-of-a-simulation-study"><i class="fa fa-check"></i><b>4.3</b> Skeleton of a simulation study</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#data-generating-process"><i class="fa fa-check"></i><b>4.3.1</b> Data-Generating Process</a></li>
<li class="chapter" data-level="4.3.2" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#data-analysis-procedure"><i class="fa fa-check"></i><b>4.3.2</b> Data Analysis Procedure</a></li>
<li class="chapter" data-level="4.3.3" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#repetition"><i class="fa fa-check"></i><b>4.3.3</b> Repetition</a></li>
<li class="chapter" data-level="4.3.4" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#performance-summaries"><i class="fa fa-check"></i><b>4.3.4</b> Performance summaries</a></li>
<li class="chapter" data-level="4.3.5" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#multifactor-simulations"><i class="fa fa-check"></i><b>4.3.5</b> Multifactor simulations</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#exercises-2"><i class="fa fa-check"></i><b>4.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="case-ANOVA.html"><a href="case-ANOVA.html"><i class="fa fa-check"></i><b>5</b> Case Study: Heteroskedastic ANOVA</a>
<ul>
<li class="chapter" data-level="5.1" data-path="case-ANOVA.html"><a href="case-ANOVA.html#the-data-generating-model"><i class="fa fa-check"></i><b>5.1</b> The data-generating model</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="case-ANOVA.html"><a href="case-ANOVA.html#now-make-a-function"><i class="fa fa-check"></i><b>5.1.1</b> Now make a function</a></li>
<li class="chapter" data-level="5.1.2" data-path="case-ANOVA.html"><a href="case-ANOVA.html#cautious-coding"><i class="fa fa-check"></i><b>5.1.2</b> Cautious coding</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="case-ANOVA.html"><a href="case-ANOVA.html#the-hypothesis-testing-procedures"><i class="fa fa-check"></i><b>5.2</b> The hypothesis testing procedures</a></li>
<li class="chapter" data-level="5.3" data-path="case-ANOVA.html"><a href="case-ANOVA.html#running-the-simulation"><i class="fa fa-check"></i><b>5.3</b> Running the simulation</a></li>
<li class="chapter" data-level="5.4" data-path="case-ANOVA.html"><a href="case-ANOVA.html#summarizing-test-performance"><i class="fa fa-check"></i><b>5.4</b> Summarizing test performance</a></li>
<li class="chapter" data-level="5.5" data-path="case-ANOVA.html"><a href="case-ANOVA.html#exAnovaExercises"><i class="fa fa-check"></i><b>5.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="data-generating-processes.html"><a href="data-generating-processes.html"><i class="fa fa-check"></i><b>6</b> Data-Generating Processes</a>
<ul>
<li class="chapter" data-level="6.1" data-path="data-generating-processes.html"><a href="data-generating-processes.html#a-statistical-model-is-a-recipe-for-data-generation"><i class="fa fa-check"></i><b>6.1</b> A statistical model is a recipe for data generation</a></li>
<li class="chapter" data-level="6.2" data-path="data-generating-processes.html"><a href="data-generating-processes.html#checking-the-data-generating-function"><i class="fa fa-check"></i><b>6.2</b> Checking the data-generating function</a></li>
<li class="chapter" data-level="6.3" data-path="data-generating-processes.html"><a href="data-generating-processes.html#case-cluster"><i class="fa fa-check"></i><b>6.3</b> Example: Simulating clustered data</a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="data-generating-processes.html"><a href="data-generating-processes.html#a-design-decision-what-do-we-want-to-manipulate"><i class="fa fa-check"></i><b>6.3.1</b> A design decision: What do we want to manipulate?</a></li>
<li class="chapter" data-level="6.3.2" data-path="data-generating-processes.html"><a href="data-generating-processes.html#a-model-for-a-cluster-rct"><i class="fa fa-check"></i><b>6.3.2</b> A model for a cluster RCT</a></li>
<li class="chapter" data-level="6.3.3" data-path="data-generating-processes.html"><a href="data-generating-processes.html#converting-our-model-to-code"><i class="fa fa-check"></i><b>6.3.3</b> Converting our model to code</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="data-generating-processes.html"><a href="data-generating-processes.html#case-cluster-stand"><i class="fa fa-check"></i><b>6.4</b> Extension: Standardization in a data generating process</a></li>
<li class="chapter" data-level="6.5" data-path="data-generating-processes.html"><a href="data-generating-processes.html#exercises-3"><i class="fa fa-check"></i><b>6.5</b> Exercises</a>
<ul>
<li class="chapter" data-level="6.5.1" data-path="data-generating-processes.html"><a href="data-generating-processes.html#ex_dgp"><i class="fa fa-check"></i><b>6.5.1</b> The Welch test on a shifted-and-scaled <span class="math inline">\(t\)</span> distribution</a></li>
<li class="chapter" data-level="6.5.2" data-path="data-generating-processes.html"><a href="data-generating-processes.html#checking-and-extending-the-cluster-rct-dgp"><i class="fa fa-check"></i><b>6.5.2</b> Checking and extending the Cluster RCT DGP</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html"><i class="fa fa-check"></i><b>7</b> Data analysis procedures</a>
<ul>
<li class="chapter" data-level="7.1" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#validating-estimation-procedures"><i class="fa fa-check"></i><b>7.1</b> Validating Estimation Procedures</a></li>
<li class="chapter" data-level="7.2" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#checking-via-simulation"><i class="fa fa-check"></i><b>7.2</b> Checking via simulation</a></li>
<li class="chapter" data-level="7.3" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#including-multiple-estimation-procedures"><i class="fa fa-check"></i><b>7.3</b> Including Multiple estimation procedures</a></li>
<li class="chapter" data-level="7.4" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#exercises-4"><i class="fa fa-check"></i><b>7.4</b> Exercises</a>
<ul>
<li class="chapter" data-level="7.4.1" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#more-welch-and-adding-the-bff-test"><i class="fa fa-check"></i><b>7.4.1</b> More Welch and adding the BFF test</a></li>
<li class="chapter" data-level="7.4.2" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#more-estimators-for-cluster-randomized-trials"><i class="fa fa-check"></i><b>7.4.2</b> More estimators for Cluster Randomized Trials</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html"><i class="fa fa-check"></i><b>8</b> Running the Simulation Process</a>
<ul>
<li class="chapter" data-level="8.1" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#writing-simulations-quick-with-the-simhelpers-package"><i class="fa fa-check"></i><b>8.1</b> Writing simulations quick with the simhelpers package</a></li>
<li class="chapter" data-level="8.2" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#adding-checks-and-balances"><i class="fa fa-check"></i><b>8.2</b> Adding Checks and Balances</a></li>
<li class="chapter" data-level="8.3" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#exercises-5"><i class="fa fa-check"></i><b>8.3</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="performance-criteria.html"><a href="performance-criteria.html"><i class="fa fa-check"></i><b>9</b> Performance criteria</a>
<ul>
<li class="chapter" data-level="9.1" data-path="performance-criteria.html"><a href="performance-criteria.html#different-kinds-of-performance"><i class="fa fa-check"></i><b>9.1</b> Different kinds of performance</a></li>
<li class="chapter" data-level="9.2" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-a-point-estimator"><i class="fa fa-check"></i><b>9.2</b> Assessing a Point Estimator</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="performance-criteria.html"><a href="performance-criteria.html#comparing-the-performances-of-the-cluster-rct-estimation-procedures"><i class="fa fa-check"></i><b>9.2.1</b> Comparing the Performances of the Cluster RCT Estimation Procedures</a></li>
<li class="chapter" data-level="9.2.2" data-path="performance-criteria.html"><a href="performance-criteria.html#estimands-not-represented-by-a-parameter"><i class="fa fa-check"></i><b>9.2.2</b> Estimands Not Represented By a Parameter</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-a-standard-error-estimator"><i class="fa fa-check"></i><b>9.3</b> Assessing a Standard Error Estimator</a>
<ul>
<li class="chapter" data-level="9.3.1" data-path="performance-criteria.html"><a href="performance-criteria.html#why-not-assess-the-estimated-se-directly"><i class="fa fa-check"></i><b>9.3.1</b> Why Not Assess the Estimated SE directly?</a></li>
<li class="chapter" data-level="9.3.2" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-ses-for-our-cluster-rct-simulation"><i class="fa fa-check"></i><b>9.3.2</b> Assessing SEs for Our Cluster RCT Simulation</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-an-inferential-procedure-hypothesis-testing"><i class="fa fa-check"></i><b>9.4</b> Assessing an Inferential Procedure (Hypothesis Testing)</a>
<ul>
<li class="chapter" data-level="9.4.1" data-path="performance-criteria.html"><a href="performance-criteria.html#validity"><i class="fa fa-check"></i><b>9.4.1</b> Validity</a></li>
<li class="chapter" data-level="9.4.2" data-path="performance-criteria.html"><a href="performance-criteria.html#power"><i class="fa fa-check"></i><b>9.4.2</b> Power</a></li>
<li class="chapter" data-level="9.4.3" data-path="performance-criteria.html"><a href="performance-criteria.html#the-rejection-rate"><i class="fa fa-check"></i><b>9.4.3</b> The Rejection Rate</a></li>
<li class="chapter" data-level="9.4.4" data-path="performance-criteria.html"><a href="performance-criteria.html#inference-in-our-cluster-rct-simulation"><i class="fa fa-check"></i><b>9.4.4</b> Inference in our Cluster RCT Simulation</a></li>
</ul></li>
<li class="chapter" data-level="9.5" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-confidence-intervals"><i class="fa fa-check"></i><b>9.5</b> Assessing Confidence Intervals</a>
<ul>
<li class="chapter" data-level="9.5.1" data-path="performance-criteria.html"><a href="performance-criteria.html#confidence-intervals-in-our-cluster-rct-example"><i class="fa fa-check"></i><b>9.5.1</b> Confidence Intervals in our Cluster RCT Example</a></li>
</ul></li>
<li class="chapter" data-level="9.6" data-path="performance-criteria.html"><a href="performance-criteria.html#additional-thoughts-on-measuring-performance"><i class="fa fa-check"></i><b>9.6</b> Additional Thoughts on Measuring Performance</a>
<ul>
<li class="chapter" data-level="9.6.1" data-path="performance-criteria.html"><a href="performance-criteria.html#sec-relative-performance"><i class="fa fa-check"></i><b>9.6.1</b> Selecting Relative vs. Absolute Criteria</a></li>
<li class="chapter" data-level="9.6.2" data-path="performance-criteria.html"><a href="performance-criteria.html#robust-measures-of-performance"><i class="fa fa-check"></i><b>9.6.2</b> Robust Measures of Performance</a></li>
<li class="chapter" data-level="9.6.3" data-path="performance-criteria.html"><a href="performance-criteria.html#summary-of-peformance-measures"><i class="fa fa-check"></i><b>9.6.3</b> Summary of Peformance Measures</a></li>
</ul></li>
<li class="chapter" data-level="9.7" data-path="performance-criteria.html"><a href="performance-criteria.html#uncertainty-in-performance-estimates-the-monte-carlo-standard-error"><i class="fa fa-check"></i><b>9.7</b> Uncertainty in Performance Estimates (the Monte Carlo Standard Error)</a>
<ul>
<li class="chapter" data-level="9.7.1" data-path="performance-criteria.html"><a href="performance-criteria.html#mcse-for-relative-variance-estimators"><i class="fa fa-check"></i><b>9.7.1</b> MCSE for Relative Variance Estimators</a></li>
<li class="chapter" data-level="9.7.2" data-path="performance-criteria.html"><a href="performance-criteria.html#calculating-mcses-with-the-simhelpers-package"><i class="fa fa-check"></i><b>9.7.2</b> Calculating MCSEs With the <code>simhelpers</code> Package</a></li>
<li class="chapter" data-level="9.7.3" data-path="performance-criteria.html"><a href="performance-criteria.html#mcse-calculation-in-our-cluster-rct-example"><i class="fa fa-check"></i><b>9.7.3</b> MCSE Calculation in our Cluster RCT Example</a></li>
</ul></li>
<li class="chapter" data-level="9.8" data-path="performance-criteria.html"><a href="performance-criteria.html#exercises-6"><i class="fa fa-check"></i><b>9.8</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="case_Cronbach.html"><a href="case_Cronbach.html"><i class="fa fa-check"></i><b>10</b> Project: Cronbach Alpha</a>
<ul>
<li class="chapter" data-level="10.1" data-path="case_Cronbach.html"><a href="case_Cronbach.html#background"><i class="fa fa-check"></i><b>10.1</b> Background</a></li>
<li class="chapter" data-level="10.2" data-path="case_Cronbach.html"><a href="case_Cronbach.html#getting-started"><i class="fa fa-check"></i><b>10.2</b> Getting started</a></li>
<li class="chapter" data-level="10.3" data-path="case_Cronbach.html"><a href="case_Cronbach.html#the-data-generating-function"><i class="fa fa-check"></i><b>10.3</b> The data-generating function</a></li>
<li class="chapter" data-level="10.4" data-path="case_Cronbach.html"><a href="case_Cronbach.html#the-estimation-function"><i class="fa fa-check"></i><b>10.4</b> The estimation function</a>
<ul>
<li class="chapter" data-level="10.4.1" data-path="case_Cronbach.html"><a href="case_Cronbach.html#exercises-naive-confidence-intervals"><i class="fa fa-check"></i><b>10.4.1</b> Exercises (Naive confidence intervals)</a></li>
</ul></li>
<li class="chapter" data-level="10.5" data-path="case_Cronbach.html"><a href="case_Cronbach.html#estimator-performance"><i class="fa fa-check"></i><b>10.5</b> Estimator performance</a>
<ul>
<li class="chapter" data-level="10.5.1" data-path="case_Cronbach.html"><a href="case_Cronbach.html#exercises-calculating-performance"><i class="fa fa-check"></i><b>10.5.1</b> Exercises (Calculating Performance)</a></li>
</ul></li>
<li class="chapter" data-level="10.6" data-path="case_Cronbach.html"><a href="case_Cronbach.html#replication-and-the-simulation"><i class="fa fa-check"></i><b>10.6</b> Replication (and the simulation)</a></li>
<li class="chapter" data-level="10.7" data-path="case_Cronbach.html"><a href="case_Cronbach.html#extension-confidence-interval-coverage"><i class="fa fa-check"></i><b>10.7</b> Extension: Confidence interval coverage</a></li>
<li class="chapter" data-level="10.8" data-path="case_Cronbach.html"><a href="case_Cronbach.html#a-taste-of-multiple-scenarios"><i class="fa fa-check"></i><b>10.8</b> A taste of multiple scenarios</a>
<ul>
<li class="chapter" data-level="10.8.1" data-path="case_Cronbach.html"><a href="case_Cronbach.html#exercises-7"><i class="fa fa-check"></i><b>10.8.1</b> Exercises</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>III Multifactor Simulations</b></span></li>
<li class="chapter" data-level="11" data-path="exp-design.html"><a href="exp-design.html"><i class="fa fa-check"></i><b>11</b> Designing the multifactor simulation experiment</a>
<ul>
<li class="chapter" data-level="11.1" data-path="exp-design.html"><a href="exp-design.html#choosing-parameter-combinations"><i class="fa fa-check"></i><b>11.1</b> Choosing parameter combinations</a>
<ul>
<li class="chapter" data-level="11.1.1" data-path="exp-design.html"><a href="exp-design.html#choosing-parameters-for-the-clustered-rct"><i class="fa fa-check"></i><b>11.1.1</b> Choosing parameters for the Clustered RCT</a></li>
</ul></li>
<li class="chapter" data-level="11.2" data-path="exp-design.html"><a href="exp-design.html#using-pmap-to-run-multifactor-simulations"><i class="fa fa-check"></i><b>11.2</b> Using pmap to run multifactor simulations</a></li>
<li class="chapter" data-level="11.3" data-path="exp-design.html"><a href="exp-design.html#when-to-calculate-performance-metrics-when-running-multiple-simulations"><i class="fa fa-check"></i><b>11.3</b> When to calculate performance metrics when running multiple simulations</a>
<ul>
<li class="chapter" data-level="11.3.1" data-path="exp-design.html"><a href="exp-design.html#aggregate-as-you-simulate-inside"><i class="fa fa-check"></i><b>11.3.1</b> Aggregate as you simulate (inside)</a></li>
<li class="chapter" data-level="11.3.2" data-path="exp-design.html"><a href="exp-design.html#keep-all-simulation-runs-outside"><i class="fa fa-check"></i><b>11.3.2</b> Keep all simulation runs (outside)</a></li>
<li class="chapter" data-level="11.3.3" data-path="exp-design.html"><a href="exp-design.html#getting-raw-results-ready-for-analysis"><i class="fa fa-check"></i><b>11.3.3</b> Getting raw results ready for analysis</a></li>
</ul></li>
<li class="chapter" data-level="11.4" data-path="exp-design.html"><a href="exp-design.html#running-the-cluster-rct-multifactor-experiment"><i class="fa fa-check"></i><b>11.4</b> Running the Cluster RCT multifactor experiment</a>
<ul>
<li class="chapter" data-level="11.4.1" data-path="exp-design.html"><a href="exp-design.html#making-analyze_data-quiet"><i class="fa fa-check"></i><b>11.4.1</b> Making analyze_data() quiet</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="12" data-path="presentation-of-simulation-results.html"><a href="presentation-of-simulation-results.html"><i class="fa fa-check"></i><b>12</b> Presentation of simulation results</a>
<ul>
<li class="chapter" data-level="12.1" data-path="presentation-of-simulation-results.html"><a href="presentation-of-simulation-results.html#tabulation"><i class="fa fa-check"></i><b>12.1</b> Tabulation</a>
<ul>
<li class="chapter" data-level="12.1.1" data-path="presentation-of-simulation-results.html"><a href="presentation-of-simulation-results.html#example-estimators-of-treatment-variation"><i class="fa fa-check"></i><b>12.1.1</b> Example: estimators of treatment variation</a></li>
</ul></li>
<li class="chapter" data-level="12.2" data-path="presentation-of-simulation-results.html"><a href="presentation-of-simulation-results.html#visualization"><i class="fa fa-check"></i><b>12.2</b> Visualization</a>
<ul>
<li class="chapter" data-level="12.2.1" data-path="presentation-of-simulation-results.html"><a href="presentation-of-simulation-results.html#example-1-biserial-correlation-estimation"><i class="fa fa-check"></i><b>12.2.1</b> Example 1: Biserial correlation estimation</a></li>
<li class="chapter" data-level="12.2.2" data-path="presentation-of-simulation-results.html"><a href="presentation-of-simulation-results.html#example-2-variance-estimation-and-meta-regression"><i class="fa fa-check"></i><b>12.2.2</b> Example 2: Variance estimation and Meta-regression</a></li>
<li class="chapter" data-level="12.2.3" data-path="presentation-of-simulation-results.html"><a href="presentation-of-simulation-results.html#example-3-heat-maps-of-coverage"><i class="fa fa-check"></i><b>12.2.3</b> Example 3: Heat maps of coverage</a></li>
<li class="chapter" data-level="12.2.4" data-path="presentation-of-simulation-results.html"><a href="presentation-of-simulation-results.html#example-4-relative-performance-of-treatment-effect-estimators"><i class="fa fa-check"></i><b>12.2.4</b> Example 4: Relative performance of treatment effect estimators</a></li>
</ul></li>
<li class="chapter" data-level="12.3" data-path="presentation-of-simulation-results.html"><a href="presentation-of-simulation-results.html#modeling"><i class="fa fa-check"></i><b>12.3</b> Modeling</a>
<ul>
<li class="chapter" data-level="12.3.1" data-path="presentation-of-simulation-results.html"><a href="presentation-of-simulation-results.html#example-1-biserial-revisited"><i class="fa fa-check"></i><b>12.3.1</b> Example 1: Biserial, revisited</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="13" data-path="analyzing-the-multifactor-experiment.html"><a href="analyzing-the-multifactor-experiment.html"><i class="fa fa-check"></i><b>13</b> Analyzing the multifactor experiment</a>
<ul>
<li class="chapter" data-level="13.1" data-path="analyzing-the-multifactor-experiment.html"><a href="analyzing-the-multifactor-experiment.html#ways-of-exploring-multifactor-simulations"><i class="fa fa-check"></i><b>13.1</b> Ways of exploring multifactor simulations</a>
<ul>
<li class="chapter" data-level="13.1.1" data-path="analyzing-the-multifactor-experiment.html"><a href="analyzing-the-multifactor-experiment.html#plot-everything-with-many-small-multiples"><i class="fa fa-check"></i><b>13.1.1</b> Plot everything with many small multiples</a></li>
<li class="chapter" data-level="13.1.2" data-path="analyzing-the-multifactor-experiment.html"><a href="analyzing-the-multifactor-experiment.html#bundling"><i class="fa fa-check"></i><b>13.1.2</b> Bundling</a></li>
<li class="chapter" data-level="13.1.3" data-path="analyzing-the-multifactor-experiment.html"><a href="analyzing-the-multifactor-experiment.html#aggregation"><i class="fa fa-check"></i><b>13.1.3</b> Aggregation</a></li>
<li class="chapter" data-level="13.1.4" data-path="analyzing-the-multifactor-experiment.html"><a href="analyzing-the-multifactor-experiment.html#regression-summarization"><i class="fa fa-check"></i><b>13.1.4</b> Regression Summarization</a></li>
<li class="chapter" data-level="13.1.5" data-path="analyzing-the-multifactor-experiment.html"><a href="analyzing-the-multifactor-experiment.html#focus-on-a-subset-kick-rest-to-supplement"><i class="fa fa-check"></i><b>13.1.5</b> Focus on a subset, kick rest to supplement</a></li>
</ul></li>
<li class="chapter" data-level="13.2" data-path="analyzing-the-multifactor-experiment.html"><a href="analyzing-the-multifactor-experiment.html#analyzing-results-with-few-iterations-per-scenario"><i class="fa fa-check"></i><b>13.2</b> Analyzing results with few iterations per scenario</a></li>
<li class="chapter" data-level="13.3" data-path="analyzing-the-multifactor-experiment.html"><a href="analyzing-the-multifactor-experiment.html#analyzing-results-when-some-trials-have-failed"><i class="fa fa-check"></i><b>13.3</b> Analyzing results when some trials have failed</a></li>
<li class="chapter" data-level="13.4" data-path="analyzing-the-multifactor-experiment.html"><a href="analyzing-the-multifactor-experiment.html#case-study-power-for-a-randomized-trial"><i class="fa fa-check"></i><b>13.4</b> Case study: power for a randomized trial</a>
<ul>
<li class="chapter" data-level="13.4.1" data-path="analyzing-the-multifactor-experiment.html"><a href="analyzing-the-multifactor-experiment.html#the-initial-analysis"><i class="fa fa-check"></i><b>13.4.1</b> The initial analysis</a></li>
<li class="chapter" data-level="13.4.2" data-path="analyzing-the-multifactor-experiment.html"><a href="analyzing-the-multifactor-experiment.html#focusing-on-validity"><i class="fa fa-check"></i><b>13.4.2</b> Focusing on validity</a></li>
<li class="chapter" data-level="13.4.3" data-path="analyzing-the-multifactor-experiment.html"><a href="analyzing-the-multifactor-experiment.html#aggregate-to-look-at-main-effects"><i class="fa fa-check"></i><b>13.4.3</b> Aggregate to look at main effects</a></li>
<li class="chapter" data-level="13.4.4" data-path="analyzing-the-multifactor-experiment.html"><a href="analyzing-the-multifactor-experiment.html#recap"><i class="fa fa-check"></i><b>13.4.4</b> Recap</a></li>
</ul></li>
<li class="chapter" data-level="13.5" data-path="analyzing-the-multifactor-experiment.html"><a href="analyzing-the-multifactor-experiment.html#exercises-8"><i class="fa fa-check"></i><b>13.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="case-study-comparing-different-estimators.html"><a href="case-study-comparing-different-estimators.html"><i class="fa fa-check"></i><b>14</b> Case study: Comparing different estimators</a>
<ul>
<li class="chapter" data-level="14.1" data-path="case-study-comparing-different-estimators.html"><a href="case-study-comparing-different-estimators.html#the-data-generating-process"><i class="fa fa-check"></i><b>14.1</b> The data generating process</a></li>
<li class="chapter" data-level="14.2" data-path="case-study-comparing-different-estimators.html"><a href="case-study-comparing-different-estimators.html#the-data-analysis-methods"><i class="fa fa-check"></i><b>14.2</b> The data analysis methods</a></li>
<li class="chapter" data-level="14.3" data-path="case-study-comparing-different-estimators.html"><a href="case-study-comparing-different-estimators.html#the-simulation-itself"><i class="fa fa-check"></i><b>14.3</b> The simulation itself</a></li>
<li class="chapter" data-level="14.4" data-path="case-study-comparing-different-estimators.html"><a href="case-study-comparing-different-estimators.html#calculating-performance-measures-for-all-our-estimators"><i class="fa fa-check"></i><b>14.4</b> Calculating performance measures for all our estimators</a></li>
<li class="chapter" data-level="14.5" data-path="case-study-comparing-different-estimators.html"><a href="case-study-comparing-different-estimators.html#improving-the-visualization-of-the-results"><i class="fa fa-check"></i><b>14.5</b> Improving the visualization of the results</a></li>
<li class="chapter" data-level="14.6" data-path="case-study-comparing-different-estimators.html"><a href="case-study-comparing-different-estimators.html#extension-the-bias-variance-tradeoff"><i class="fa fa-check"></i><b>14.6</b> Extension: The Bias-variance tradeoff</a></li>
</ul></li>
<li class="part"><span><b>IV Common Challenges with Large-Scale Simulations</b></span></li>
<li class="chapter" data-level="15" data-path="sec-reproducability.html"><a href="sec-reproducability.html"><i class="fa fa-check"></i><b>15</b> Ensuring reproducibility</a>
<ul>
<li class="chapter" data-level="15.1" data-path="sec-reproducability.html"><a href="sec-reproducability.html#seeds-and-pseudo-random-number-generators"><i class="fa fa-check"></i><b>15.1</b> Seeds and pseudo-random number generators</a></li>
<li class="chapter" data-level="15.2" data-path="sec-reproducability.html"><a href="sec-reproducability.html#including-seed-in-our-simulation-driver"><i class="fa fa-check"></i><b>15.2</b> Including seed in our simulation driver</a></li>
<li class="chapter" data-level="15.3" data-path="sec-reproducability.html"><a href="sec-reproducability.html#reasons-for-setting-the-seed"><i class="fa fa-check"></i><b>15.3</b> Reasons for setting the seed</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="optimize-code.html"><a href="optimize-code.html"><i class="fa fa-check"></i><b>16</b> Optimizing code (and why you often shouldn’t)</a>
<ul>
<li class="chapter" data-level="16.1" data-path="optimize-code.html"><a href="optimize-code.html#hand-building-functions"><i class="fa fa-check"></i><b>16.1</b> Hand-building functions</a></li>
<li class="chapter" data-level="16.2" data-path="optimize-code.html"><a href="optimize-code.html#sec_comp_efficiency"><i class="fa fa-check"></i><b>16.2</b> Computational efficiency versus simplicity</a></li>
<li class="chapter" data-level="16.3" data-path="optimize-code.html"><a href="optimize-code.html#reusing-code-to-speed-up-computation"><i class="fa fa-check"></i><b>16.3</b> Reusing code to speed up computation</a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="error-trapping-and-other-headaches.html"><a href="error-trapping-and-other-headaches.html"><i class="fa fa-check"></i><b>17</b> Error trapping and other headaches</a>
<ul>
<li class="chapter" data-level="17.1" data-path="error-trapping-and-other-headaches.html"><a href="error-trapping-and-other-headaches.html#safe_code"><i class="fa fa-check"></i><b>17.1</b> Safe code</a>
<ul>
<li class="chapter" data-level="17.1.1" data-path="error-trapping-and-other-headaches.html"><a href="error-trapping-and-other-headaches.html#making-a-safe-function-call"><i class="fa fa-check"></i><b>17.1.1</b> Making a safe function call</a></li>
<li class="chapter" data-level="17.1.2" data-path="error-trapping-and-other-headaches.html"><a href="error-trapping-and-other-headaches.html#what-to-do-with-warnings-in-simulations"><i class="fa fa-check"></i><b>17.1.2</b> What to do with warnings in simulations</a></li>
</ul></li>
<li class="chapter" data-level="17.2" data-path="error-trapping-and-other-headaches.html"><a href="error-trapping-and-other-headaches.html#about-stopifnot"><i class="fa fa-check"></i><b>17.2</b> Protecting your functions with “stop”</a></li>
</ul></li>
<li class="chapter" data-level="18" data-path="saving-files.html"><a href="saving-files.html"><i class="fa fa-check"></i><b>18</b> Saving files and results</a>
<ul>
<li class="chapter" data-level="18.1" data-path="saving-files.html"><a href="saving-files.html#saving-simulations-in-general"><i class="fa fa-check"></i><b>18.1</b> Saving simulations in general</a></li>
<li class="chapter" data-level="18.2" data-path="saving-files.html"><a href="saving-files.html#saving-simulations-as-you-go"><i class="fa fa-check"></i><b>18.2</b> Saving simulations as you go</a></li>
<li class="chapter" data-level="18.3" data-path="saving-files.html"><a href="saving-files.html#dynamically-making-directories"><i class="fa fa-check"></i><b>18.3</b> Dynamically making directories</a></li>
<li class="chapter" data-level="18.4" data-path="saving-files.html"><a href="saving-files.html#loading-and-combining-files-of-simulation-results"><i class="fa fa-check"></i><b>18.4</b> Loading and combining files of simulation results</a></li>
</ul></li>
<li class="chapter" data-level="19" data-path="parallel-processing.html"><a href="parallel-processing.html"><i class="fa fa-check"></i><b>19</b> Parallel Processing</a>
<ul>
<li class="chapter" data-level="19.1" data-path="parallel-processing.html"><a href="parallel-processing.html#parallel-on-your-computer"><i class="fa fa-check"></i><b>19.1</b> Parallel on your computer</a></li>
<li class="chapter" data-level="19.2" data-path="parallel-processing.html"><a href="parallel-processing.html#parallel-off-your-computer"><i class="fa fa-check"></i><b>19.2</b> Parallel off your computer</a>
<ul>
<li class="chapter" data-level="19.2.1" data-path="parallel-processing.html"><a href="parallel-processing.html#what-is-a-command-line-interface"><i class="fa fa-check"></i><b>19.2.1</b> What is a command-line interface?</a></li>
<li class="chapter" data-level="19.2.2" data-path="parallel-processing.html"><a href="parallel-processing.html#running-a-job-on-a-cluster"><i class="fa fa-check"></i><b>19.2.2</b> Running a job on a cluster</a></li>
<li class="chapter" data-level="19.2.3" data-path="parallel-processing.html"><a href="parallel-processing.html#checking-on-a-job"><i class="fa fa-check"></i><b>19.2.3</b> Checking on a job</a></li>
<li class="chapter" data-level="19.2.4" data-path="parallel-processing.html"><a href="parallel-processing.html#running-lots-of-jobs-on-a-cluster"><i class="fa fa-check"></i><b>19.2.4</b> Running lots of jobs on a cluster</a></li>
<li class="chapter" data-level="19.2.5" data-path="parallel-processing.html"><a href="parallel-processing.html#resources-for-harvards-odyssey"><i class="fa fa-check"></i><b>19.2.5</b> Resources for Harvard’s Odyssey</a></li>
<li class="chapter" data-level="19.2.6" data-path="parallel-processing.html"><a href="parallel-processing.html#acknowledgements-1"><i class="fa fa-check"></i><b>19.2.6</b> Acknowledgements</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="20" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html"><i class="fa fa-check"></i><b>20</b> Simulations as evidence</a>
<ul>
<li class="chapter" data-level="20.1" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#strategies-for-making-relevant-simulations"><i class="fa fa-check"></i><b>20.1</b> Strategies for making relevant simulations</a>
<ul>
<li class="chapter" data-level="20.1.1" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#make-your-simulation-general-with-an-extensive-multi-factor-experiment"><i class="fa fa-check"></i><b>20.1.1</b> Make your simulation general with an extensive multi-factor experiment</a></li>
<li class="chapter" data-level="20.1.2" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#use-previously-published-simulations-to-beat-them-at-their-own-game"><i class="fa fa-check"></i><b>20.1.2</b> Use previously published simulations to beat them at their own game</a></li>
<li class="chapter" data-level="20.1.3" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#calibrate-simulation-factors-to-real-data"><i class="fa fa-check"></i><b>20.1.3</b> Calibrate simulation factors to real data</a></li>
<li class="chapter" data-level="20.1.4" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#use-real-data-to-obtain-directly"><i class="fa fa-check"></i><b>20.1.4</b> Use real data to obtain directly</a></li>
<li class="chapter" data-level="20.1.5" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#fully-calibrated-simulations"><i class="fa fa-check"></i><b>20.1.5</b> Fully calibrated simulations</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>V Specialized Use-Cases</b></span></li>
<li class="chapter" data-level="21" data-path="using-simulation-as-a-power-calculator.html"><a href="using-simulation-as-a-power-calculator.html"><i class="fa fa-check"></i><b>21</b> Using simulation as a power calculator</a>
<ul>
<li class="chapter" data-level="21.1" data-path="using-simulation-as-a-power-calculator.html"><a href="using-simulation-as-a-power-calculator.html#getting-design-parameters-from-pilot-data"><i class="fa fa-check"></i><b>21.1</b> Getting design parameters from pilot data</a></li>
<li class="chapter" data-level="21.2" data-path="using-simulation-as-a-power-calculator.html"><a href="using-simulation-as-a-power-calculator.html#the-data-generating-process-1"><i class="fa fa-check"></i><b>21.2</b> The data generating process</a></li>
<li class="chapter" data-level="21.3" data-path="using-simulation-as-a-power-calculator.html"><a href="using-simulation-as-a-power-calculator.html#running-the-simulation-1"><i class="fa fa-check"></i><b>21.3</b> Running the simulation</a></li>
<li class="chapter" data-level="21.4" data-path="using-simulation-as-a-power-calculator.html"><a href="using-simulation-as-a-power-calculator.html#evaluating-power"><i class="fa fa-check"></i><b>21.4</b> Evaluating power</a>
<ul>
<li class="chapter" data-level="21.4.1" data-path="using-simulation-as-a-power-calculator.html"><a href="using-simulation-as-a-power-calculator.html#checking-validity-of-our-models"><i class="fa fa-check"></i><b>21.4.1</b> Checking validity of our models</a></li>
<li class="chapter" data-level="21.4.2" data-path="using-simulation-as-a-power-calculator.html"><a href="using-simulation-as-a-power-calculator.html#assessing-precision-se"><i class="fa fa-check"></i><b>21.4.2</b> Assessing Precision (SE)</a></li>
<li class="chapter" data-level="21.4.3" data-path="using-simulation-as-a-power-calculator.html"><a href="using-simulation-as-a-power-calculator.html#assessing-power"><i class="fa fa-check"></i><b>21.4.3</b> Assessing power</a></li>
<li class="chapter" data-level="21.4.4" data-path="using-simulation-as-a-power-calculator.html"><a href="using-simulation-as-a-power-calculator.html#assessing-minimum-detectable-effects"><i class="fa fa-check"></i><b>21.4.4</b> Assessing Minimum Detectable Effects</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="22" data-path="potential-outcomes.html"><a href="potential-outcomes.html"><i class="fa fa-check"></i><b>22</b> Simulation under the Potential Outcomes Framework</a>
<ul>
<li class="chapter" data-level="22.1" data-path="potential-outcomes.html"><a href="potential-outcomes.html#finite-vs.-superpopulation-inference"><i class="fa fa-check"></i><b>22.1</b> Finite vs. Superpopulation inference</a></li>
<li class="chapter" data-level="22.2" data-path="potential-outcomes.html"><a href="potential-outcomes.html#data-generation-processes-for-potential-outcomes"><i class="fa fa-check"></i><b>22.2</b> Data generation processes for potential outcomes</a></li>
<li class="chapter" data-level="22.3" data-path="potential-outcomes.html"><a href="potential-outcomes.html#finite-sample-performance-measures"><i class="fa fa-check"></i><b>22.3</b> Finite sample performance measures</a></li>
<li class="chapter" data-level="22.4" data-path="potential-outcomes.html"><a href="potential-outcomes.html#nested-finite-simulation-procedure"><i class="fa fa-check"></i><b>22.4</b> Nested finite simulation procedure</a></li>
</ul></li>
<li class="chapter" data-level="23" data-path="the-parametric-bootstrap.html"><a href="the-parametric-bootstrap.html"><i class="fa fa-check"></i><b>23</b> The Parametric bootstrap</a>
<ul>
<li class="chapter" data-level="23.1" data-path="the-parametric-bootstrap.html"><a href="the-parametric-bootstrap.html#air-conditioners-a-stolen-case-study"><i class="fa fa-check"></i><b>23.1</b> Air conditioners: a stolen case study</a></li>
</ul></li>
<li class="appendix"><span><b>Appendices</b></span></li>
<li class="chapter" data-level="A" data-path="coding-tidbits.html"><a href="coding-tidbits.html"><i class="fa fa-check"></i><b>A</b> Coding tidbits</a>
<ul>
<li class="chapter" data-level="A.1" data-path="coding-tidbits.html"><a href="coding-tidbits.html#repeating-oneself"><i class="fa fa-check"></i><b>A.1</b> How to repeat yourself</a>
<ul>
<li class="chapter" data-level="A.1.1" data-path="coding-tidbits.html"><a href="coding-tidbits.html#using-replicate"><i class="fa fa-check"></i><b>A.1.1</b> Using <code>replicate()</code></a></li>
<li class="chapter" data-level="A.1.2" data-path="coding-tidbits.html"><a href="coding-tidbits.html#using-map"><i class="fa fa-check"></i><b>A.1.2</b> Using <code>map()</code></a></li>
<li class="chapter" data-level="A.1.3" data-path="coding-tidbits.html"><a href="coding-tidbits.html#map-with-no-inputs"><i class="fa fa-check"></i><b>A.1.3</b> map with no inputs</a></li>
<li class="chapter" data-level="A.1.4" data-path="coding-tidbits.html"><a href="coding-tidbits.html#other-approaches-for-repetition"><i class="fa fa-check"></i><b>A.1.4</b> Other approaches for repetition</a></li>
</ul></li>
<li class="chapter" data-level="A.2" data-path="coding-tidbits.html"><a href="coding-tidbits.html#default-arguments"><i class="fa fa-check"></i><b>A.2</b> Default arguments for functions</a></li>
<li class="chapter" data-level="A.3" data-path="coding-tidbits.html"><a href="coding-tidbits.html#testing-and-debugging-code-in-your-scripts"><i class="fa fa-check"></i><b>A.3</b> Testing and debugging code in your scripts</a></li>
<li class="chapter" data-level="A.4" data-path="coding-tidbits.html"><a href="coding-tidbits.html#the-source-command-and-keeping-things-organized"><i class="fa fa-check"></i><b>A.4</b> The source command and keeping things organized</a></li>
<li class="chapter" data-level="A.5" data-path="coding-tidbits.html"><a href="coding-tidbits.html#debugging-with-browser"><i class="fa fa-check"></i><b>A.5</b> Debugging with browser</a></li>
</ul></li>
<li class="chapter" data-level="B" data-path="further-readings-and-resources.html"><a href="further-readings-and-resources.html"><i class="fa fa-check"></i><b>B</b> Further readings and resources</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Designing Monte Carlo Simulations in R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="data-generating-processes" class="section level1 hasAnchor" number="6">
<h1><span class="header-section-number">Chapter 6</span> Data-Generating Processes<a href="data-generating-processes.html#data-generating-processes" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>The data generating process (DGP) is the recipe we use to create fake data that we then analyze.
Often we express our DGP as a specific model, with parameters that we can set to generate data.
The advantage of this is, generally, when we generate from a specified model we know the “right answer,” and can thus compare our estimates to this right answer in order to assess whether our estimation procedures worked.</p>
<p>The easiest way to describe a DGP is usually via a mathematical model, which is fundamentally a sequence of equations and random variables that define a series of steps.
Describing DGPs in this way is especially important for more complex DGPs, such as those for hierarchical data.
These models will often be a series of chained linear equations that use a set of parameters that we set out.
Once we have them, we can convert these equations to code by simply following these laid out steps.</p>
<p>In this chapter, after giving a high level overview of the DGP process, we will walk through a running example of clustered data.
In particular, we are going to focus on generating two-level data of students nested in schools.</p>
<p>There are several ingredients of a full mathematical model that we could use to generate data.</p>
<p><strong>COVARIATES, STRUCTURAL COVARIATES, and OUTCOMES</strong>
Covariates are the things that we are usually given when analyzing real data, such as student demographics, or school-level characteristics such as the school’s treatment assignment.
Structural covariates are covariates that we do not tend to think of as covariates per se; they are more just consequences of the data.
These are elements such as the number of observations in each school or proportion treated in each school.</p>
<p>In the real world statistical analysis, we rarely model covariates, but instead condition on them.
In a simulation, however, we have to decide how they come to be.</p>
<p>Structural covariates are also a consequence of how we decide to generate data; for example, if we are generating sites of different size, we may put a distribution on site size, and generate the sizes according to that distribution.</p>
<p>Outcomes are a type of covariate that are usually dependent on other covariates in our model.
In other words, some covariates depend on other covariates, which can govern the order that we can generate all of our data.</p>
<p><strong>MODEL</strong>
This is the parametric relationship between everything, such as a specification of how the outcomes are linked to the covariates.
This includes specification of the randomness (the distribution of the residuals, etc.).
The model will usually contain equations that one might see in an analysis of data that looks like what we are trying to generate.</p>
<p>The full model will also have some extra parts that define how to generate the covariates and structural covariates.
For example, we might specify that site sizes are uniformly distributed between a specified minimum and maximum size, or that some covariate is normally distributed.
We might also specify an equation that connects size size to site average treatment impact, or things of that nature.</p>
<p><strong>PARAMETERS</strong>
For a given model, parameters describe how strong a relationship there is between covariate and outcome, variance of the residuals, and so forth.
We usually estimate these <em>from</em> data.
Critically, if we know them, we can <em>generate new data</em>.</p>
<p><strong>DESIGN PARAMETERS</strong>
Design parameters are the parameters that go with the parts of our model that we normally would not use when analyzing our data.
These are, e.g., the number of sites, the range of allowed site sizes.
These will control how we generate the structural covariates.
We might also have parameters governing covariate generation, such as means and variances and so forth.</p>
<p>For example, for the Welch data earlier we have, for observation <span class="math inline">\(i\)</span> in group <span class="math inline">\(g\)</span>, a mathematical representation of our data of:</p>
<p><span class="math display">\[ X_{ig} = \mu_g + \epsilon_{ig} \mbox{ with } \epsilon_{ig} \sim N( 0, \sigma^2_g ) \]</span></p>
<p>These math equations would also come along with specified parameter values (the <span class="math inline">\(\mu_g\)</span>, the <span class="math inline">\(\sigma^2_g\)</span>), and the design parameter of the sample sizes <span class="math inline">\(n_g\)</span>.</p>
<div id="a-statistical-model-is-a-recipe-for-data-generation" class="section level2 hasAnchor" number="6.1">
<h2><span class="header-section-number">6.1</span> A statistical model is a recipe for data generation<a href="data-generating-processes.html#a-statistical-model-is-a-recipe-for-data-generation" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Once we have a recipe (our mathematical model), the next step is to translate it to code.
In the real world:</p>
<ul>
<li>We obtain data, we pick a model, we estimate parameters.</li>
<li>The data comes with covariates and outcomes.</li>
<li>It also comes with sample size, sizes of the clusters, etc.</li>
</ul>
<p>In the simulation world, by comparison:</p>
<ul>
<li>We pick a model, we decide how much data, we generate covariates, we pick the parameters, and then we generate outcomes.</li>
<li>We need to decide how many clusters we have, how big the clusters are, etc.</li>
<li>We have to specify how the covariates are made. This last piece is very different from real-world analysis.</li>
</ul>
<p>In terms of code, a function that implements a data-generating model should have the following form:</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb122-1"><a href="data-generating-processes.html#cb122-1" tabindex="-1"></a>generate_data <span class="ot">&lt;-</span> <span class="cf">function</span>(parameters) {</span>
<span id="cb122-2"><a href="data-generating-processes.html#cb122-2" tabindex="-1"></a>  </span>
<span id="cb122-3"><a href="data-generating-processes.html#cb122-3" tabindex="-1"></a>  <span class="co"># generate pseudo-random numbers and use those to</span></span>
<span id="cb122-4"><a href="data-generating-processes.html#cb122-4" tabindex="-1"></a>  <span class="co"># make some data</span></span>
<span id="cb122-5"><a href="data-generating-processes.html#cb122-5" tabindex="-1"></a>  </span>
<span id="cb122-6"><a href="data-generating-processes.html#cb122-6" tabindex="-1"></a>  <span class="fu">return</span>(sim_data)</span>
<span id="cb122-7"><a href="data-generating-processes.html#cb122-7" tabindex="-1"></a>}</span></code></pre></div>
<p>The function takes a set of parameter values as input, simulates random numbers and does calculations, and produces as output a set of simulated data.
Again, there will in general be multiple parameters, and these will include not only the model parameters (e.g. the coefficients of a regression), but also sample sizes and other study design parameters.
The output will typically be a dataframe, mimicking what data one would see in the “real world,” possibly augmented by some other latent (normally unobserved in the real world) values that we can use later on to assess whether the estimation procedures we are checking are close to the truth.</p>
<p>For example, from our Welch case study, we had the following method that generates grouped data with a single outcome.</p>
<div class="sourceCode" id="cb123"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb123-1"><a href="data-generating-processes.html#cb123-1" tabindex="-1"></a>generate_data <span class="ot">&lt;-</span> <span class="cf">function</span>(mu, sigma_sq, sample_size) {</span>
<span id="cb123-2"><a href="data-generating-processes.html#cb123-2" tabindex="-1"></a>  </span>
<span id="cb123-3"><a href="data-generating-processes.html#cb123-3" tabindex="-1"></a>  N <span class="ot">&lt;-</span> <span class="fu">sum</span>(sample_size) </span>
<span id="cb123-4"><a href="data-generating-processes.html#cb123-4" tabindex="-1"></a>  g <span class="ot">&lt;-</span> <span class="fu">length</span>(sample_size) </span>
<span id="cb123-5"><a href="data-generating-processes.html#cb123-5" tabindex="-1"></a>  </span>
<span id="cb123-6"><a href="data-generating-processes.html#cb123-6" tabindex="-1"></a>  group <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>g, <span class="at">times =</span> sample_size) </span>
<span id="cb123-7"><a href="data-generating-processes.html#cb123-7" tabindex="-1"></a>  mu_long <span class="ot">&lt;-</span> <span class="fu">rep</span>(mu, <span class="at">times =</span> sample_size)</span>
<span id="cb123-8"><a href="data-generating-processes.html#cb123-8" tabindex="-1"></a>  sigma_long <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">sqrt</span>(sigma_sq), <span class="at">times =</span> sample_size) </span>
<span id="cb123-9"><a href="data-generating-processes.html#cb123-9" tabindex="-1"></a>  </span>
<span id="cb123-10"><a href="data-generating-processes.html#cb123-10" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N, <span class="at">mean =</span> mu_long, <span class="at">sd =</span> sigma_long)</span>
<span id="cb123-11"><a href="data-generating-processes.html#cb123-11" tabindex="-1"></a>  sim_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">group =</span> group, <span class="at">x =</span> x)</span>
<span id="cb123-12"><a href="data-generating-processes.html#cb123-12" tabindex="-1"></a>  </span>
<span id="cb123-13"><a href="data-generating-processes.html#cb123-13" tabindex="-1"></a>  <span class="fu">return</span>(sim_data)</span>
<span id="cb123-14"><a href="data-generating-processes.html#cb123-14" tabindex="-1"></a>}</span></code></pre></div>
<p>Our function takes both parameters as we normally thing of them (<code>mu</code>, <code>sigma_sq</code>), and other values that we might not think of as parameters per-se (<code>sample_size</code>).
When simulating data, we have to specify quantities that we, when analyzing data, often have to take for granted.</p>
</div>
<div id="checking-the-data-generating-function" class="section level2 hasAnchor" number="6.2">
<h2><span class="header-section-number">6.2</span> Checking the data-generating function<a href="data-generating-processes.html#checking-the-data-generating-function" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>An important part of programming in R—particularly when writing functions—is finding ways to test and check the correctness of your code. Thus, after writing a data-generating function, we need to consider how to test whether the output it produces is correct. How best to do this will depend on the data-generating process being implemented.</p>
<p>For the heteroskedastic ANOVA problem, one basic thing we could do is check that the simulated data from each group follows a normal distribution. By generating very large samples from each group, we can effectively check characteristics of the population distribution.
In the following code, we simulate very large samples from each of the four groups, and check that the means and variances agree with the input parameters:</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb124-1"><a href="data-generating-processes.html#cb124-1" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">6</span>)</span>
<span id="cb124-2"><a href="data-generating-processes.html#cb124-2" tabindex="-1"></a>sigma_sq <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">1</span>)</span>
<span id="cb124-3"><a href="data-generating-processes.html#cb124-3" tabindex="-1"></a></span>
<span id="cb124-4"><a href="data-generating-processes.html#cb124-4" tabindex="-1"></a>check_data <span class="ot">&lt;-</span> <span class="fu">generate_data</span>( <span class="at">mu =</span> mu, <span class="at">sigma_sq =</span> sigma_sq,</span>
<span id="cb124-5"><a href="data-generating-processes.html#cb124-5" tabindex="-1"></a>                             <span class="at">sample_size =</span> <span class="fu">rep</span>(<span class="dv">10000</span>, <span class="dv">4</span>) )</span>
<span id="cb124-6"><a href="data-generating-processes.html#cb124-6" tabindex="-1"></a></span>
<span id="cb124-7"><a href="data-generating-processes.html#cb124-7" tabindex="-1"></a>chk <span class="ot">&lt;-</span> check_data <span class="sc">%&gt;%</span> <span class="fu">group_by</span>( group ) <span class="sc">%&gt;%</span></span>
<span id="cb124-8"><a href="data-generating-processes.html#cb124-8" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>( <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb124-9"><a href="data-generating-processes.html#cb124-9" tabindex="-1"></a>                    <span class="at">mean =</span> <span class="fu">mean</span>( x ),</span>
<span id="cb124-10"><a href="data-generating-processes.html#cb124-10" tabindex="-1"></a>                    <span class="at">var =</span> <span class="fu">var</span>( x ) ) <span class="sc">%&gt;%</span></span>
<span id="cb124-11"><a href="data-generating-processes.html#cb124-11" tabindex="-1"></a>  <span class="fu">mutate</span>( <span class="at">mu =</span> mu,</span>
<span id="cb124-12"><a href="data-generating-processes.html#cb124-12" tabindex="-1"></a>          <span class="at">sigma2 =</span> sigma_sq ) <span class="sc">%&gt;%</span></span>
<span id="cb124-13"><a href="data-generating-processes.html#cb124-13" tabindex="-1"></a>  <span class="fu">relocate</span>( group, n, mean, mu, var, sigma2 )</span>
<span id="cb124-14"><a href="data-generating-processes.html#cb124-14" tabindex="-1"></a>chk</span></code></pre></div>
<pre><code>## # A tibble: 4 × 6
##   group     n  mean    mu   var sigma2
##   &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
## 1     1 10000 0.996     1  3.00      3
## 2     2 10000 1.99      2  2.01      2
## 3     3 10000 4.98      5  5.04      5
## 4     4 10000 5.99      6  1.01      1</code></pre>
<p>We are recovering our parameters.</p>
<p>We can also make some diagnostic plots to assess whether we have normal data (using QQ plots, where we expect a straight line if the data are normal):</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb126-1"><a href="data-generating-processes.html#cb126-1" tabindex="-1"></a><span class="fu">ggplot</span>( check_data, <span class="fu">aes</span>( <span class="at">sample=</span>x ) ) <span class="sc">+</span></span>
<span id="cb126-2"><a href="data-generating-processes.html#cb126-2" tabindex="-1"></a>  <span class="fu">facet_wrap</span>( <span class="sc">~</span> group ) <span class="sc">+</span></span>
<span id="cb126-3"><a href="data-generating-processes.html#cb126-3" tabindex="-1"></a>  <span class="fu">stat_qq</span>()</span></code></pre></div>
<p><img src="Designing-Simulations-in-R_files/figure-html/unnamed-chunk-74-1.png" width="75%" style="display: block; margin: auto;" /></p>
<p>We again check out.
Here, these checks may seem a bit silly, but most bugs are silly—at least once you find them!
It is easy for small things such as a sign error to happen once your model gets a bit more complex; even simple checks such as these can be quite helpful.</p>
</div>
<div id="case-cluster" class="section level2 hasAnchor" number="6.3">
<h2><span class="header-section-number">6.3</span> Example: Simulating clustered data<a href="data-generating-processes.html#case-cluster" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Generating data with complex structure can be intimidating, but if you set out a recipe for how the data is generated it is often not to bad to build that recipe up with code.
We will next provide a more complex example with a case study of using simulation to determine best practices for analyzing data from a cluster-randomized RCT of students nested in schools.</p>
<p>Recent literature on multisite trials (where, for example, students are randomized to treatment or control within each of a series of sites) has explored how variation in the size of impacts across sites can affect how estimators behave, and what models we should use when there is impact variation (e.g., <span class="citation">(<a href="#ref-miratrix2021applied"><strong>miratrix2021applied?</strong></a>)</span>, <span class="citation">Bloom et al. (<a href="#ref-Bloom:2016um">2016</a>)</span>).
We are going to extend this work to explore best practices for estimating treatment effects in cluster randomized trials.</p>
<p>Cluster randomized trials are randomized experiments where the unit of randomization is a group of individuals, rather than the individuals themselves.
For example, if we have a collection of schools, with students in schools, a cluster randomized trial would randomize the <em>schools</em> into treatment or control, and then measure our outcome on the <em>students</em> inside the schools.
We might be trying to estimate, for example, whether the average score of the treatment schools is different from the average score of the control schools.
In particular, we want to investigate what happens when the average treatment impact of a school is related to the size of the school.</p>
<p>Often we will design a data generating process to allow us to answer a specific question.
For our Welch example, we wanted to know how different amounts of variation in different groups impacted estimation.
We therefore needed a data generation process that allowed us to control that variation.
To figure out what we need for our clustered data example, we need to think about how we are going to use those data in our simulation study.</p>
<div id="a-design-decision-what-do-we-want-to-manipulate" class="section level3 hasAnchor" number="6.3.1">
<h3><span class="header-section-number">6.3.1</span> A design decision: What do we want to manipulate?<a href="data-generating-processes.html#a-design-decision-what-do-we-want-to-manipulate" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>There are a lot of ways we might generate cluster randomized trial data.
To pick between the many options, we need to think about the goals of the simulation.</p>
<p>Overall, our final data should be a collection of clusters with different sizes and different baseline mean outcomes.
Some of the clusters will be treated, and some not.
We can imagine our final data being individual students in schools, with each student having a school id, a treatment assignment (shared for all in the school) and an outcome.
A good starting point for building a DGP is to first write down a sketch of what the eventual data might look like on a piece of scratch paper.
In our case, for example, we might write down:</p>
<table>
<thead>
<tr class="header">
<th align="right">schoolID</th>
<th align="right">Z</th>
<th align="right">size</th>
<th align="right">studentID</th>
<th align="right">Y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">24</td>
<td align="right">1</td>
<td align="right">3.6</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">24</td>
<td align="right">3</td>
<td align="right">1.0</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">etc</td>
<td align="right">etc</td>
<td align="right">etc</td>
<td align="right">etc</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">24</td>
<td align="right">24</td>
<td align="right">2.0</td>
</tr>
<tr class="odd">
<td align="right">2</td>
<td align="right">0</td>
<td align="right">32</td>
<td align="right">1</td>
<td align="right">0.5</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">0</td>
<td align="right">32</td>
<td align="right">2</td>
<td align="right">1.5</td>
</tr>
<tr class="odd">
<td align="right">2</td>
<td align="right">0</td>
<td align="right">32</td>
<td align="right">3</td>
<td align="right">1.2</td>
</tr>
<tr class="even">
<td align="right">etc</td>
<td align="right">etc</td>
<td align="right">etc</td>
<td align="right">etc</td>
<td align="right">etc</td>
</tr>
</tbody>
</table>
<p>We know we are planning on comparing multiple estimators, seeing how they behave differently under different conditions.
We also know that we are interested in what happens when the size of the treatment impact varies across sites, and in particular what happens when it is associated with site size.</p>
<p>Given these goals and beliefs, we might think:</p>
<ol style="list-style-type: decimal">
<li>We figure if all the sites are the same size, then all the estimators will probably be ok. But if sites vary, then maybe we could have issues with our estimators.</li>
<li>Also, if site size varies, but has nothing to do with impact, then all the estimators might still be ok, at least for bias, but if size is associated with treatment impact, then maybe how our estimators end up averaging across sites is going to matter.</li>
</ol>
<p>Usually, when running a simulation, it is good practice to test the simple option along with the complex one.
We want to both check that something does not matter as well as verify that it does.
Given this, we land on the following points:</p>
<ul>
<li>We need a DGP that has the option to make all-same-size sites or variable size sites.</li>
<li>Our DGP should have some impact variation across sites.</li>
<li>Our DGP should allow for different sites to have different treatment impacts.</li>
<li>We should have the option to connect impact variation to site size.</li>
</ul>
</div>
<div id="a-model-for-a-cluster-rct" class="section level3 hasAnchor" number="6.3.2">
<h3><span class="header-section-number">6.3.2</span> A model for a cluster RCT<a href="data-generating-processes.html#a-model-for-a-cluster-rct" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>It is usually easiest to start a recipe for data generating by writing down the mathematical model.
Write down something, and then, if you do not yet know how to generate some part of what you wrote down, specify how to generate those parts that you are using, in an iterative process.</p>
<p>For our model, we start with a model for our student outcome:</p>
<p><span class="math display">\[ Y_{ij} = \beta_{0j} + \epsilon_{ij} \mbox{ with } \epsilon_{ij} \sim N( 0, \sigma^2_\epsilon ) \]</span>
where <span class="math inline">\(Y_{ij}\)</span> is the outcome for student <span class="math inline">\(i\)</span> in site <span class="math inline">\(j\)</span>, <span class="math inline">\(\beta_{0j}\)</span> is the average outcome in site <span class="math inline">\(j\)</span>, and <span class="math inline">\(\epsilon_{ij}\)</span> is the residual error for student <span class="math inline">\(i\)</span> in site <span class="math inline">\(j\)</span>.</p>
<p>We then need to figure out how to make the average outcome in site <span class="math inline">\(j\)</span>.
In looking at our goals, we want <span class="math inline">\(\beta_{0j}\)</span> to depend on treatment assignment.
We might then write down:</p>
<p><span class="math display">\[ \beta_{0j} = \gamma_0 + \gamma_1 Z_j + u_j \mbox{ with } u_j \sim N( 0, \sigma^2_u )\]</span>
saying the average outcome in site <span class="math inline">\(j\)</span> is the average outcome in the control group (<span class="math inline">\(\gamma_0\)</span>) plus some treatment impact (<span class="math inline">\(\gamma_1\)</span>) if the site is treated.
We added a <span class="math inline">\(u_j\)</span> so that our different sites can be different from each other in terms of their average outcome, even if they are not treated.
To keep things simple, we are having a common treatment impact within cluster: if we treat a cluster, everyone in the cluster is raised by some specified amount.</p>
<p>But we also want the size of impact to possibly vary by site size.
This suggests we also want a treatment by site size interaction term.
Instead of just using the site size, however, we are going to standardize our site sizes so they are more interpretable.
This makes it so if we double the sizes of all the sites, it does not change our size covariate: we want the size covariate to be relative size, not absolute.
To do this, we create a covariate which is the percent of the average site size that a site is:
<span class="math display">\[ S_j = \frac{n_j - \bar{n}}{ \bar{n} } \]</span></p>
<p>where <span class="math inline">\(\bar{n}\)</span> is the average site size. Using this covariate, we then revise our equation for our site <span class="math inline">\(j\)</span> to:
<span class="math display">\[ \beta_{0j} = \gamma_{0} + \gamma_{1} Z_j + \gamma_2 Z_j S_j + u_j \]</span>
A nice thing about <span class="math inline">\(S_j\)</span> is that it is centered at 0, meaning the average site has an impact of just <span class="math inline">\(\gamma_1\)</span>.
If <span class="math inline">\(S_j\)</span> was not centered at zero, then our overall average impact in our data would be a mix of the <span class="math inline">\(\gamma_1\)</span> and the <span class="math inline">\(\gamma_2\)</span>.
By centering, we make it so the average impact is just <span class="math inline">\(\gamma_1\)</span>–<span class="math inline">\(\gamma_1\)</span> is our target site average treatment impact.</p>
<p>If we put all the above together, we see we have specified a multilevel model to describe our data:
<span class="math display">\[
\begin{aligned}
Y_{ij} &amp;= \beta_{0j} + \epsilon_{ij} \\
\epsilon_{ij} &amp;\sim N( 0, \sigma^2_\epsilon ) \\
\beta_{0j} &amp;= \gamma_{0} + \gamma_{1} Z_j + \gamma_2 Z_j S_j + u_j \\
u_j &amp;\sim N( 0, \sigma^2_u )
\end{aligned}
\]</span>
Our parameters are the mean outcome of control unit (<span class="math inline">\(\gamma_0\)</span>), the average treatment impact (<span class="math inline">\(\gamma_1\)</span>), the amount of cross site variation (<span class="math inline">\(\sigma^2_u\)</span>), and residual variation (<span class="math inline">\(\sigma^2_\epsilon\)</span>).
Our <span class="math inline">\(\gamma_2\)</span> is our site-size by treatment interaction term: bigger sites will (assuming <span class="math inline">\(\gamma_2\)</span> is positive) have larger treatment impacts.</p>
<p>If you prefer the reduced form, it would be:</p>
<p><span class="math display">\[ Y_{ij} = \gamma_{0} + \gamma_{1} Z_j + \gamma_2 Z_j S_j  + u_j + \epsilon_{ij}  \]</span>
We might also include a main effect for <span class="math inline">\(S_j\)</span>.
A main effect would make larger sites systematically different than smaller sites at baseline, rather than having it only be part of our treatment variation term.
For simplicity we drop it here.</p>
<p>In reviewing the above, we might notice that we do not have any variation in treatment impact that is not explained by site size.
We could once again revise our model to include a term for this, but we will leave it out for now.
See the exercises at the end of the chapter.</p>
<p>So far we have a mathematical model analogous to what we would write if we were <em>analyzing</em> the data.
To <em>generate</em> data, we also need several other quantities specified.
First, we need to know the number of clusters (<span class="math inline">\(J\)</span>) and the sizes of the clusters (<span class="math inline">\(n_j\)</span>, for <span class="math inline">\(j = 1, \ldots, J\)</span>).
We have to provide a recipe for generating these sizes.
We might try</p>
<p><span class="math display">\[ n_j \sim unif( (1-\alpha)\bar{n}, (1+\alpha)\bar{n} ) = \bar{n} + \bar{n}\alpha \cdot unif(-1, 1) ,\]</span>
with a fixed <span class="math inline">\(\alpha\)</span> to control the amount of variation in cluster size.
If <span class="math inline">\(\bar{n} = 100\)</span> and <span class="math inline">\(\alpha = 0.25\)</span> then we would, for example, have sites ranging from 75 to 125 in size.
This specification is nice in that we can determine two parameters, <span class="math inline">\(\bar{n}\)</span> and <span class="math inline">\(\alpha\)</span>, to get our site sizes, and both parameters are easy to comprehend: average site size and amount of site size variation.</p>
<p>Given how we are generating site size, look again at our treatment impact heterogeneity term:</p>
<p><span class="math display">\[ \gamma_2 Z_j S_j = \gamma_2 Z_j \left(\frac{n_j - \bar{n}}{\bar{n}}\right) = \gamma_2 Z_j \alpha U_j, \]</span>
where <span class="math inline">\(U_j\)</span> is the <span class="math inline">\(U_j \sim unif(-1,1)\)</span> uniform variable used to generate <span class="math inline">\(n_j\)</span>.
Due to our standardizing by average site size, we make our covariate not change in terms of its importance as a function of site size, but rather as a function of site variation <span class="math inline">\(\alpha\)</span>.
In particular, <span class="math inline">\(\frac{n_j - \bar{n}}{\bar{n}}\)</span> will range from <span class="math inline">\(-\alpha\)</span> to <span class="math inline">\(\alpha\)</span>, regardless of average site size.
Carefully setting up a DGP so the “knobs” we use are standardized like this can make interpreting the simulation results much easier.
Consider if we did not standardize and just had <span class="math inline">\(\gamma_2 n_j\)</span> in our equation: in this case, for a set <span class="math inline">\(\gamma_2\)</span>, the overall average impact would grow if we changed the average site size, which could make interpreting the results across scenarios very confusing.
We generally want the parameters in our DGP to change only one aspect of our simulation, if possible, to make isolating effects of different DGP characteristics easier.</p>
<p>We next need to define how we generate our treatment indicator, <span class="math inline">\(Z_j\)</span>.
We might specify the proportion <span class="math inline">\(p\)</span> of clusters we will assign to treatment, and then generate <span class="math inline">\(Z_j = 1\)</span> or <span class="math inline">\(Z_j = 0\)</span> using a simple random sampling approach on our <span class="math inline">\(J\)</span> clusters.
We will see code for this below.</p>
</div>
<div id="converting-our-model-to-code" class="section level3 hasAnchor" number="6.3.3">
<h3><span class="header-section-number">6.3.3</span> Converting our model to code<a href="data-generating-processes.html#converting-our-model-to-code" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>When sketching out our DGP mathematically we worked from the students to the schools.
For actual data generation, we will now follow our final model, but go by layers in the other direction.
First, we generate the sites:</p>
<ul>
<li>Generate site sizes</li>
<li>Generate site-level covariates</li>
<li>Generate site level random effects</li>
</ul>
<p>Then we generate the students inside the sites:</p>
<ul>
<li>Generate student covariates</li>
<li>Generate student residuals</li>
<li>Add everything up to generate student outcomes</li>
</ul>
<p>The mathematical model gives us exactly the details we need to execute on these steps.</p>
<p>We start by specifying a function with all the parameters we might want to pass it, including defaults for each (see <a href="coding-tidbits.html#default-arguments">A.2</a> for more on function defaults):</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb127-1"><a href="data-generating-processes.html#cb127-1" tabindex="-1"></a>gen_dat_model <span class="ot">&lt;-</span> <span class="cf">function</span>( <span class="at">n_bar =</span> <span class="dv">10</span>,</span>
<span id="cb127-2"><a href="data-generating-processes.html#cb127-2" tabindex="-1"></a>                           <span class="at">J =</span> <span class="dv">30</span>,</span>
<span id="cb127-3"><a href="data-generating-processes.html#cb127-3" tabindex="-1"></a>                           <span class="at">p =</span> <span class="fl">0.5</span>,</span>
<span id="cb127-4"><a href="data-generating-processes.html#cb127-4" tabindex="-1"></a>                           <span class="at">gamma_0 =</span> <span class="dv">0</span>, <span class="at">gamma_1 =</span> <span class="dv">0</span>, <span class="at">gamma_2 =</span> <span class="dv">0</span>,</span>
<span id="cb127-5"><a href="data-generating-processes.html#cb127-5" tabindex="-1"></a>                           <span class="at">sigma2_u =</span> <span class="dv">0</span>, <span class="at">sigma2_e =</span> <span class="dv">1</span>,</span>
<span id="cb127-6"><a href="data-generating-processes.html#cb127-6" tabindex="-1"></a>                           <span class="at">alpha =</span> <span class="dv">0</span> ) {</span>
<span id="cb127-7"><a href="data-generating-processes.html#cb127-7" tabindex="-1"></a>  <span class="co"># Code (see below) goes here.</span></span>
<span id="cb127-8"><a href="data-generating-processes.html#cb127-8" tabindex="-1"></a>}</span></code></pre></div>
<p>Note our parameters are a mix of <em>model parameters</em> (<code>gamma_0</code>, <code>gamma_1</code>, <code>sigma2_e</code>, etc., representing coefficients in regressions, variance terms, etc.) and <em>design parameters</em> (<code>n_bar</code>, <code>J</code>, <code>p</code>) that directly inform data generation.
We set default arguments (e.g., <code>gamma_0=0</code>) so we can ignore aspects of the DGP that we do not care about later on.</p>
<p>Inside the model, we will have a block of code to generate the sites, and then another to generate the students.</p>
<p><strong>Make the sites.</strong>
We make the sites first:</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb128-1"><a href="data-generating-processes.html#cb128-1" tabindex="-1"></a><span class="co"># generate site sizes </span></span>
<span id="cb128-2"><a href="data-generating-processes.html#cb128-2" tabindex="-1"></a>n_min <span class="ot">=</span> <span class="fu">round</span>( n_bar <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> alpha) )</span>
<span id="cb128-3"><a href="data-generating-processes.html#cb128-3" tabindex="-1"></a>n_max <span class="ot">=</span> <span class="fu">round</span>( n_bar <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> alpha) )</span>
<span id="cb128-4"><a href="data-generating-processes.html#cb128-4" tabindex="-1"></a>nj <span class="ot">&lt;-</span> <span class="fu">sample</span>( n_min<span class="sc">:</span>n_max, J, <span class="at">replace=</span><span class="cn">TRUE</span> )</span>
<span id="cb128-5"><a href="data-generating-processes.html#cb128-5" tabindex="-1"></a></span>
<span id="cb128-6"><a href="data-generating-processes.html#cb128-6" tabindex="-1"></a><span class="co"># Generate average control outcome and average ATE for all sites</span></span>
<span id="cb128-7"><a href="data-generating-processes.html#cb128-7" tabindex="-1"></a><span class="co"># (The random effects)</span></span>
<span id="cb128-8"><a href="data-generating-processes.html#cb128-8" tabindex="-1"></a>u0j <span class="ot">=</span> <span class="fu">rnorm</span>( J, <span class="at">mean=</span><span class="dv">0</span>, <span class="at">sd=</span><span class="fu">sqrt</span>( sigma2_u ) )</span>
<span id="cb128-9"><a href="data-generating-processes.html#cb128-9" tabindex="-1"></a></span>
<span id="cb128-10"><a href="data-generating-processes.html#cb128-10" tabindex="-1"></a><span class="co"># randomize units within each site (proportion p to treatment)</span></span>
<span id="cb128-11"><a href="data-generating-processes.html#cb128-11" tabindex="-1"></a>Zj <span class="ot">=</span> <span class="fu">ifelse</span>( <span class="fu">sample</span>( <span class="dv">1</span><span class="sc">:</span>J ) <span class="sc">&lt;=</span> J <span class="sc">*</span> p, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb128-12"><a href="data-generating-processes.html#cb128-12" tabindex="-1"></a></span>
<span id="cb128-13"><a href="data-generating-processes.html#cb128-13" tabindex="-1"></a><span class="co"># Calculate site intercept for each site</span></span>
<span id="cb128-14"><a href="data-generating-processes.html#cb128-14" tabindex="-1"></a>beta_0j <span class="ot">=</span> gamma_0 <span class="sc">+</span> gamma_1 <span class="sc">*</span> Zj <span class="sc">+</span> gamma_2 <span class="sc">*</span> Zj <span class="sc">*</span> (nj<span class="sc">-</span>n_bar)<span class="sc">/</span>n_bar <span class="sc">+</span> u0j</span></code></pre></div>
<p>The code is a literal translation of the math we did before.
Note the line with <code>sample(1:J) &lt;= J*p</code>; this is a simple trick to generate a treatment and control 0/1 indicator.</p>
<p>There is also a serious error in the above code (serious in that the code will run and look fine in many cases, but not always do what we want); we leave it as an exercise (see below) to find and fix it.</p>
<p><strong>Make the individuals.</strong>
We next use the site characteristics to then generate the individuals.</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb129-1"><a href="data-generating-processes.html#cb129-1" tabindex="-1"></a><span class="co"># Make individual site membership</span></span>
<span id="cb129-2"><a href="data-generating-processes.html#cb129-2" tabindex="-1"></a>sid <span class="ot">=</span> <span class="fu">as.factor</span>( <span class="fu">rep</span>( <span class="dv">1</span><span class="sc">:</span>J, nj ) )</span>
<span id="cb129-3"><a href="data-generating-processes.html#cb129-3" tabindex="-1"></a>dd <span class="ot">=</span> <span class="fu">data.frame</span>( <span class="at">sid =</span> sid )</span>
<span id="cb129-4"><a href="data-generating-processes.html#cb129-4" tabindex="-1"></a></span>
<span id="cb129-5"><a href="data-generating-processes.html#cb129-5" tabindex="-1"></a><span class="co"># Make individual level tx variables</span></span>
<span id="cb129-6"><a href="data-generating-processes.html#cb129-6" tabindex="-1"></a>dd<span class="sc">$</span>Z <span class="ot">=</span> Zj[ dd<span class="sc">$</span>sid ]</span>
<span id="cb129-7"><a href="data-generating-processes.html#cb129-7" tabindex="-1"></a></span>
<span id="cb129-8"><a href="data-generating-processes.html#cb129-8" tabindex="-1"></a><span class="co"># Generate the residuals </span></span>
<span id="cb129-9"><a href="data-generating-processes.html#cb129-9" tabindex="-1"></a>N <span class="ot">=</span> <span class="fu">sum</span>( nj )</span>
<span id="cb129-10"><a href="data-generating-processes.html#cb129-10" tabindex="-1"></a>e <span class="ot">=</span> <span class="fu">rnorm</span>( N, <span class="at">mean=</span><span class="dv">0</span>, <span class="at">sd=</span><span class="fu">sqrt</span>( sigma2_e ) )</span>
<span id="cb129-11"><a href="data-generating-processes.html#cb129-11" tabindex="-1"></a></span>
<span id="cb129-12"><a href="data-generating-processes.html#cb129-12" tabindex="-1"></a><span class="co"># Bundle and send out</span></span>
<span id="cb129-13"><a href="data-generating-processes.html#cb129-13" tabindex="-1"></a>dd <span class="ot">&lt;-</span> <span class="fu">mutate</span>( dd, </span>
<span id="cb129-14"><a href="data-generating-processes.html#cb129-14" tabindex="-1"></a>              <span class="at">sid=</span><span class="fu">as.factor</span>(sid),</span>
<span id="cb129-15"><a href="data-generating-processes.html#cb129-15" tabindex="-1"></a>              <span class="at">Yobs =</span> beta_0j[sid] <span class="sc">+</span> e, </span>
<span id="cb129-16"><a href="data-generating-processes.html#cb129-16" tabindex="-1"></a>              <span class="at">Z =</span> Zj[ sid ] )</span></code></pre></div>
<p>A key piece here is the <code>rep()</code> function that takes a list and repeats each element of the list a specified number of times.
In particular, <code>rep()</code> repeats each number (<span class="math inline">\(1, 2, /ldots,J\)</span>), the corresponding number of times as listed in <code>nj</code>.</p>
<p>Once we put the above code in our function skeleton, we can our function as so:</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb130-1"><a href="data-generating-processes.html#cb130-1" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">gen_dat_model</span>( <span class="at">n_bar =</span> <span class="dv">5</span>, <span class="at">J=</span><span class="dv">3</span>, <span class="at">p =</span> <span class="fl">0.5</span>, </span>
<span id="cb130-2"><a href="data-generating-processes.html#cb130-2" tabindex="-1"></a>                      <span class="at">gamma_0 =</span> <span class="dv">0</span>, <span class="at">gamma_1 =</span> <span class="fl">0.2</span>, <span class="at">gamma_2 =</span> <span class="fl">0.2</span>,</span>
<span id="cb130-3"><a href="data-generating-processes.html#cb130-3" tabindex="-1"></a>                      <span class="at">sigma2_u =</span> <span class="fl">0.4</span>, <span class="at">sigma2_e =</span> <span class="dv">1</span>,</span>
<span id="cb130-4"><a href="data-generating-processes.html#cb130-4" tabindex="-1"></a>                      <span class="at">alpha =</span> <span class="fl">0.5</span> )</span>
<span id="cb130-5"><a href="data-generating-processes.html#cb130-5" tabindex="-1"></a></span>
<span id="cb130-6"><a href="data-generating-processes.html#cb130-6" tabindex="-1"></a>dat</span></code></pre></div>
<pre><code>##    sid Z         Yobs
## 1    1 1  0.776953794
## 2    1 1 -0.007218711
## 3    1 1  0.292033611
## 4    1 1 -0.971344824
## 5    1 1 -0.553448559
## 6    2 0  1.174974987
## 7    2 0  0.052906424
## 8    3 0  0.844204532
## 9    3 0 -1.019060761
## 10   3 0 -1.693720092
## 11   3 0 -0.760304217
## 12   3 0  0.481981528
## 13   3 0 -1.636520240</code></pre>
<p>Our data generation code is complete.
We can control the average size of the clusters (<code>n</code>), the number of clusters (<code>J</code>), the proportion treated (<code>p</code>), the average outcome in the control group (<code>gamma_0</code>), the average treatment effect (<code>gamma_1</code>), the site size by treatment interaction (<code>gamma_2</code>), the amount of cross site variation (<code>sigma2_u</code>), the residual variation (<code>sigma2_e</code>), and the amount of site size variation (<code>alpha</code>).
The next step is to test the code, making sure it is doing what we think it is.
In fact, it is not–there is a subtle bug that only appears under some specifications of the parameters; see the exercises for more on testing ones code, and for diagnosing and repairing this error in particular.</p>
</div>
</div>
<div id="case-cluster-stand" class="section level2 hasAnchor" number="6.4">
<h2><span class="header-section-number">6.4</span> Extension: Standardization in a data generating process<a href="data-generating-processes.html#case-cluster-stand" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In this chapter, we made a model to generate data for a cluster randomized trial.
Given our model, we can generate data by specifying our parameters and variables of <span class="math inline">\(\gamma_{0}, \gamma_{1}, \gamma_{2}, \sigma^2_\epsilon, \sigma^2_u, \bar{n}, \alpha, J, p\)</span>.</p>
<p>One factor that tends to show up when working with multisite data is how much variation there is within sites vs between sites.
For example, the Intra-Class Correlation (ICC), a measure of how much of the variation in the outcome is due to differences between sites, is a major component for power calculations.
Because of this, we will likely want to manipulate the amount of within vs. between variation in our simulations.</p>
<p>An easy way to do this would be to simply raise or lower the amount of variation within sites (<span class="math inline">\(\sigma^2_u\)</span>).
This unfortunately has a side effect: if we increase <span class="math inline">\(\sigma^2_u\)</span>, our overall variation of <span class="math inline">\(Y\)</span> will also increase.
This will make it hard to think about, e.g., power, since we have confounded within vs. between variation with overall variation (which is itself bad for power).
It also impacts interpretation of coefficients.
A treatment effect of 0.2 on our outcome scale is “smaller” if there is more overall variation.</p>
<p>Right now, our model is
<span class="math display">\[ Y_{ij} = \gamma_{0} + \gamma_{1} Z_j + \gamma_2 Z_j \left(\frac{n_j - \bar{n}}{\bar{n}} \right)  + u_j + \epsilon_{ij}  \]</span></p>
<p>Given our model, the variance of our control-side outcomes is
<span class="math display">\[
\begin{aligned}
var( Y_{ij}(0) ) &amp;= var( \beta_{0j} + \epsilon_{ij} ) \\
&amp;= var( \gamma_{0} + \gamma_{1} Z_j + \gamma_{2}Z_j \tilde{n}_j + u_j + \epsilon_{ij} ) \\
&amp;= var( \gamma_{0} + u_j + \epsilon_{ij} ) \\
&amp;= \sigma^2_u + \sigma^2_\epsilon
\end{aligned}
\]</span>
(We drop the terms with the <span class="math inline">\(Z_j\)</span> because we are looking at control-side variation, where nothing is treated.)
We see that as we increase either within or between variation, overall variation increases.</p>
<p>We can improve our data generating process to allow for directly controlling the amount of within vs. between variation without it being confounded with overall variation.
To do this we first (1) Standardize our data and then (2) reparameterize, so we have human-selected parameters that we can interpret that we then <em>translate</em> to our list of data generation parameters.
In particular, we will index our DGP with the more interpretable parameter of the Intra-Class Correlation (ICC), and standardize our DGP so it is all in effect size units.</p>
<p>The effect size of an impact is defined as the impact over the control-side standard deviation.
(Sometimes people use the pooled standard deviation, but this is usually a bad choice if one suspects treatment variation. More treatment variation should not reduce the effect size for the same absolute average impact.)</p>
<p><span class="math display">\[ ES = \frac{\gamma_1}{SD( Y | Z_j = 0 )} = \frac{\gamma_1}{\sqrt{ \sigma^2_u + \sigma^2_\epsilon } } \]</span></p>
<p>The way we think about how “big” <span class="math inline">\(\gamma_1\)</span> is depends on how much site variation and residual variation there is.
But it is also easier to detect effects when the residual variation is small.
Effect sizes “standardize out” these sorts of tensions. We can use that.</p>
<p>In particular, we will use the Intraclass Correlation Coeffiicent (ICC), defined as
<span class="math display">\[ ICC = \frac{ \sigma^2_u }{ \sigma^2_\epsilon + \sigma^2_u } . \]</span>
The ICC is a measure of within vs. between variation.</p>
<p>What we then do is first standardized our data, meaning we ensure the control side variance equals 1.
Using the above, this means <span class="math inline">\(\sigma^2_u + \sigma^2_\epsilon = 1\)</span>.
It also gives us <span class="math inline">\(ICC = \sigma^2_u\)</span>, and <span class="math inline">\(\sigma^2_\epsilon = 1 - ICC\)</span>.</p>
<p>Our two model parameters are now tied together by our single ICC tuning parameter.
The core idea is we can now manipulate the aspects of the DGP we want while holding other aspects of the DGP constant.
Given our standardized scale, we have dropped a parameter from our set of parameters we might want to vary, and ensured that varying the other parameter (now the ICC) is varying only one aspect of the DGP, not both.
Before, increasing <span class="math inline">\(\sigma^2_u\)</span> had two consequences: total variation and relative amount of variation at the school level.
Now, manipulating ICC only does the latter.</p>
<p>E.g., we can call our DGP function as follows:</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb132-1"><a href="data-generating-processes.html#cb132-1" tabindex="-1"></a>ICC <span class="ot">=</span> <span class="fl">0.3</span></span>
<span id="cb132-2"><a href="data-generating-processes.html#cb132-2" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">gen_dat_model</span>( <span class="at">n_bar =</span> <span class="dv">20</span>, <span class="at">J =</span> <span class="dv">30</span>, <span class="at">p =</span> <span class="fl">0.5</span>,</span>
<span id="cb132-3"><a href="data-generating-processes.html#cb132-3" tabindex="-1"></a>                      <span class="at">gamma_0 =</span> <span class="dv">0</span>, <span class="at">gamma_1 =</span> <span class="fl">0.3</span>, <span class="at">gamma_2 =</span> <span class="fl">0.2</span>,</span>
<span id="cb132-4"><a href="data-generating-processes.html#cb132-4" tabindex="-1"></a>                      <span class="at">sigma2_u =</span> ICC, <span class="at">sigma2_e =</span> <span class="dv">1</span> <span class="sc">-</span> ICC,</span>
<span id="cb132-5"><a href="data-generating-processes.html#cb132-5" tabindex="-1"></a>                      <span class="at">alpha =</span> <span class="fl">0.5</span> )</span></code></pre></div>
</div>
<div id="exercises-3" class="section level2 hasAnchor" number="6.5">
<h2><span class="header-section-number">6.5</span> Exercises<a href="data-generating-processes.html#exercises-3" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="ex_dgp" class="section level3 hasAnchor" number="6.5.1">
<h3><span class="header-section-number">6.5.1</span> The Welch test on a shifted-and-scaled <span class="math inline">\(t\)</span> distribution<a href="data-generating-processes.html#ex_dgp" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The shifted-and-scaled <span class="math inline">\(t\)</span>-distribution has parameters <span class="math inline">\(\mu\)</span> (mean), <span class="math inline">\(\sigma\)</span> (scale), and <span class="math inline">\(\nu\)</span> (degrees of freedom).
If <span class="math inline">\(T\)</span> follows a student’s <span class="math inline">\(t\)</span>-distribution with <span class="math inline">\(\nu\)</span> degrees of freedom, then <span class="math inline">\(S = \mu + \sigma T\)</span> follows a shifted-and-scaled <span class="math inline">\(t\)</span>-distribution.</p>
<p>The following function will generate random draws from this distribution (the scaling of <span class="math inline">\((\nu-2)/\nu\)</span> is to account for a non-scaled <span class="math inline">\(t\)</span>-distribution having a variance of <span class="math inline">\(\nu/(\nu-2)\)</span>).</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb133-1"><a href="data-generating-processes.html#cb133-1" tabindex="-1"></a>r_tss <span class="ot">&lt;-</span> <span class="cf">function</span>(n, mean, sd, df) {</span>
<span id="cb133-2"><a href="data-generating-processes.html#cb133-2" tabindex="-1"></a>  mean <span class="sc">+</span> sd <span class="sc">*</span> <span class="fu">sqrt</span>( (df<span class="dv">-2</span>)<span class="sc">/</span>df ) <span class="sc">*</span> <span class="fu">rt</span>(<span class="at">n =</span> n, <span class="at">df =</span> df)</span>
<span id="cb133-3"><a href="data-generating-processes.html#cb133-3" tabindex="-1"></a>}</span>
<span id="cb133-4"><a href="data-generating-processes.html#cb133-4" tabindex="-1"></a></span>
<span id="cb133-5"><a href="data-generating-processes.html#cb133-5" tabindex="-1"></a><span class="fu">r_tss</span>(<span class="at">n =</span> <span class="dv">8</span>, <span class="at">mean =</span> <span class="dv">3</span>, <span class="at">sd =</span> <span class="dv">2</span>, <span class="at">df =</span> <span class="dv">5</span>)</span></code></pre></div>
<pre><code>## [1]  2.1573751  3.5381963  4.3321615  0.9812902
## [5]  4.3675072  5.2172568 -2.1179124  6.2531454</code></pre>
<ol style="list-style-type: decimal">
<li><p>Modify the Welch simulation’s <code>simulate_data()</code> function to generate data from shifted-and-scaled <span class="math inline">\(t\)</span>-distributions rather than from normal distributions. Include the degrees of freedom as an input argument.
Simulate a dataset with low degrees of freedom and plot it to see if you see a few outliers.</p></li>
<li><p>Now generate more data and calculate the means and standard deviations to see if they are correctly calibrated (generate a big dataset to ensure you get reliable mean and standard deviation estimates). Check <code>df</code> equal to 500, 5, 3, and 2.</p></li>
<li><p>Once you are satisfied you have a correct DGP function, re-run the Type-I error rate calculations from the prior exercises in Section <a href="case-ANOVA.html#exAnovaExercises">5.5</a> using a <span class="math inline">\(t\)</span>-distribution with 5 degrees of freedom.
Do the results change substantially?</p></li>
</ol>
</div>
<div id="checking-and-extending-the-cluster-rct-dgp" class="section level3 hasAnchor" number="6.5.2">
<h3><span class="header-section-number">6.5.2</span> Checking and extending the Cluster RCT DGP<a href="data-generating-processes.html#checking-and-extending-the-cluster-rct-dgp" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<ol start="4" style="list-style-type: decimal">
<li><p>What is the variance of the outcomes generated by our model if there is no treatment effect? (Try simulating data to check!) What other quick checks can you make on your DGP to make sure it is working?</p></li>
<li><p>In <code>gen_dat_model()</code> we have the following line of code to generate the number of individuals per site.</p></li>
</ol>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb135-1"><a href="data-generating-processes.html#cb135-1" tabindex="-1"></a>nj <span class="ot">&lt;-</span> <span class="fu">sample</span>( n_min<span class="sc">:</span>n_max, J, <span class="at">replace=</span><span class="cn">TRUE</span> )</span></code></pre></div>
<p>This code has an error. Generate a variety of datasets where you vary <code>n_min</code>, <code>n_max</code> and <code>J</code> to discover the error. Then repair the code.
Checking your data generating process across a range of scenarios is extremely important.</p>
<ol start="6" style="list-style-type: decimal">
<li><p>The DGP allows for site-level treatment impact variation–but only if it is related to site size. How could you modify your simulation to allow for site-level treatment impact variation that is not related to site size? Implement this change and generate some data to show how it works.</p></li>
<li><p>Extend the data generating process to include an individual level covariate <span class="math inline">\(X\)</span> that is predictive of outcome. In particular, you will want to adjust your level one equation to</p></li>
</ol>
<p><span class="math display">\[ Y_{ij} = \beta_{0j} + \beta_{1} X_{ij} + \epsilon_{ij} . \]</span>
Keep the same <span class="math inline">\(\beta_1\)</span> for all sites.
You will have to specify how to generate your <span class="math inline">\(X_{ij}\)</span>.
For starters, just generate it as a standard normal, and do not worry about having the mean of <span class="math inline">\(X_{ij}\)</span> vary by sites unless you are excited to try to get that to work.</p>

</div>
</div>
</div>
<h3>References</h3>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-Bloom:2016um" class="csl-entry">
Bloom, Howard S., Stephen W. Raudenbush, Michael J. Weiss, and Kristin Porter. 2016. <span>“<span class="nocase">Using Multisite Experiments to Study Cross-Site Variation in Treatment Effects: A Hybrid Approach With Fixed Intercepts and a Random Treatment Coefficient</span>.”</span> <em>Journal of Research on Educational Effectiveness</em> 10 (4): 0–0. <a href="https://doi.org/10.1080/19345747.2016.1264518">https://doi.org/10.1080/19345747.2016.1264518</a>.
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="case-ANOVA.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="data-analysis-procedures.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": {
    "github": false,
    "facebook": true,
    "twitter": true,
    "linkedin": false,
    "weibo": false,
    "instapaper": false,
    "vk": false,
    "whatsapp": false,
    "all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
  },
  "fontsettings": {
    "theme": "white",
    "family": "sans",
    "size": 2
  },
  "edit": {
    "link": "https://github.com/jepusto/Designing-Simulations-in-R/edit/master/020-Data-generating-models.Rmd",
    "text": "Edit"
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": null,
    "text": null
  },
  "download": ["Designing-Simulations-in-R.pdf", "Designing-Simulations-in-R.epub"],
  "search": {
    "engine": "lunr",
    "options": null
  },
  "toc": {
    "collapse": "section",
    "scroll_highlight": true
  },
  "toolbar": {
    "position": "fixed"
  },
  "info": true
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
