<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 11 Case study: A simulation with clustered data | Designing Monte Carlo Simulations in R</title>
  <meta name="description" content="A text on designing, implementing, and reporting on Monte Carlo simulation studies" />
  <meta name="generator" content="bookdown 0.26 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 11 Case study: A simulation with clustered data | Designing Monte Carlo Simulations in R" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="A text on designing, implementing, and reporting on Monte Carlo simulation studies" />
  <meta name="github-repo" content="jepusto/Designing-Simulations-in-R" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 11 Case study: A simulation with clustered data | Designing Monte Carlo Simulations in R" />
  
  <meta name="twitter:description" content="A text on designing, implementing, and reporting on Monte Carlo simulation studies" />
  

<meta name="author" content="James E. Pustejovsky and Luke W. Miratrix" />


<meta name="date" content="2022-05-12" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="functions.html"/>
<link rel="next" href="error-trapping-and-other-headaches.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Designing Simulations in R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#license"><i class="fa fa-check"></i>License</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="about-the-authors.html"><a href="about-the-authors.html"><i class="fa fa-check"></i>About the authors</a></li>
<li class="chapter" data-level="" data-path="acknowledgements.html"><a href="acknowledgements.html"><i class="fa fa-check"></i>Acknowledgements</a></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="introduction.html"><a href="introduction.html#some-of-simulations-many-uses"><i class="fa fa-check"></i><b>1.1</b> Some of simulation’s many uses</a>
<ul>
<li class="chapter" data-level="1.1.1" data-path="introduction.html"><a href="introduction.html#comparing-statistical-approaches"><i class="fa fa-check"></i><b>1.1.1</b> Comparing statistical approaches</a></li>
<li class="chapter" data-level="1.1.2" data-path="introduction.html"><a href="introduction.html#assessing-performance-of-complex-pipelines"><i class="fa fa-check"></i><b>1.1.2</b> Assessing performance of complex pipelines</a></li>
<li class="chapter" data-level="1.1.3" data-path="introduction.html"><a href="introduction.html#assessing-performance-under-misspecification"><i class="fa fa-check"></i><b>1.1.3</b> Assessing performance under misspecification</a></li>
<li class="chapter" data-level="1.1.4" data-path="introduction.html"><a href="introduction.html#assessing-the-finite-sample-performance-of-a-statistical-approach"><i class="fa fa-check"></i><b>1.1.4</b> Assessing the finite sample performance of a statistical approach</a></li>
<li class="chapter" data-level="1.1.5" data-path="introduction.html"><a href="introduction.html#conducting-power-analyses"><i class="fa fa-check"></i><b>1.1.5</b> Conducting Power Analyses</a></li>
<li class="chapter" data-level="1.1.6" data-path="introduction.html"><a href="introduction.html#simulating-processess"><i class="fa fa-check"></i><b>1.1.6</b> Simulating processess</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="introduction.html"><a href="introduction.html#the-perils-of-simulation-as-evidence"><i class="fa fa-check"></i><b>1.2</b> The perils of simulation as evidence</a></li>
<li class="chapter" data-level="1.3" data-path="introduction.html"><a href="introduction.html#why-r-and-rstudio"><i class="fa fa-check"></i><b>1.3</b> Why R and RStudio?</a></li>
<li class="chapter" data-level="1.4" data-path="introduction.html"><a href="introduction.html#some-preliminaries"><i class="fa fa-check"></i><b>1.4</b> Some preliminaries</a>
<ul>
<li class="chapter" data-level="1.4.1" data-path="introduction.html"><a href="introduction.html#functions"><i class="fa fa-check"></i><b>1.4.1</b> Functions</a></li>
<li class="chapter" data-level="1.4.2" data-path="introduction.html"><a href="introduction.html#a-dangerous-function"><i class="fa fa-check"></i><b>1.4.2</b> A dangerous function</a></li>
<li class="chapter" data-level="1.4.3" data-path="introduction.html"><a href="introduction.html#function-skeletons"><i class="fa fa-check"></i><b>1.4.3</b> Function skeletons</a></li>
<li class="chapter" data-level="1.4.4" data-path="introduction.html"><a href="introduction.html#pipe-dreams"><i class="fa fa-check"></i><b>1.4.4</b> <code>%&gt;%</code> (Pipe) dreams</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="an-initial-simulation.html"><a href="an-initial-simulation.html"><i class="fa fa-check"></i><b>2</b> An initial simulation</a>
<ul>
<li class="chapter" data-level="2.1" data-path="an-initial-simulation.html"><a href="an-initial-simulation.html#simulation-for-a-single-scenario"><i class="fa fa-check"></i><b>2.1</b> Simulation for a single scenario</a></li>
<li class="chapter" data-level="2.2" data-path="an-initial-simulation.html"><a href="an-initial-simulation.html#simulating-across-different-scenarios"><i class="fa fa-check"></i><b>2.2</b> Simulating across different scenarios</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html"><i class="fa fa-check"></i><b>3</b> Structure of a simulation study</a>
<ul>
<li class="chapter" data-level="3.1" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#general-structure-of-a-simulation"><i class="fa fa-check"></i><b>3.1</b> General structure of a simulation</a></li>
<li class="chapter" data-level="3.2" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#tidy-simulations"><i class="fa fa-check"></i><b>3.2</b> Tidy simulations</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#data-generating-model"><i class="fa fa-check"></i><b>3.2.1</b> Data-generating model</a></li>
<li class="chapter" data-level="3.2.2" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#estimation-methods"><i class="fa fa-check"></i><b>3.2.2</b> Estimation methods</a></li>
<li class="chapter" data-level="3.2.3" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#repetition"><i class="fa fa-check"></i><b>3.2.3</b> Repetition</a></li>
<li class="chapter" data-level="3.2.4" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#performance-summaries"><i class="fa fa-check"></i><b>3.2.4</b> Performance summaries</a></li>
<li class="chapter" data-level="3.2.5" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#results"><i class="fa fa-check"></i><b>3.2.5</b> Results</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#multiple-scenarios"><i class="fa fa-check"></i><b>3.3</b> Multiple Scenarios</a></li>
<li class="chapter" data-level="3.4" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#keeping-the-pieces-organized"><i class="fa fa-check"></i><b>3.4</b> Keeping the pieces organized</a></li>
<li class="chapter" data-level="3.5" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#further-readings-resources"><i class="fa fa-check"></i><b>3.5</b> Further readings &amp; resources</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="case_ANOVA.html"><a href="case_ANOVA.html"><i class="fa fa-check"></i><b>4</b> Case Study: Heteroskedastic ANOVA</a>
<ul>
<li class="chapter" data-level="4.1" data-path="case_ANOVA.html"><a href="case_ANOVA.html#the-data-generating-model"><i class="fa fa-check"></i><b>4.1</b> The data-generating model</a></li>
<li class="chapter" data-level="4.2" data-path="case_ANOVA.html"><a href="case_ANOVA.html#the-estimation-procedures"><i class="fa fa-check"></i><b>4.2</b> The estimation procedures</a></li>
<li class="chapter" data-level="4.3" data-path="case_ANOVA.html"><a href="case_ANOVA.html#replication"><i class="fa fa-check"></i><b>4.3</b> Replication</a></li>
<li class="chapter" data-level="4.4" data-path="case_ANOVA.html"><a href="case_ANOVA.html#calculating-rejection-rates"><i class="fa fa-check"></i><b>4.4</b> Calculating rejection rates</a></li>
<li class="chapter" data-level="4.5" data-path="case_ANOVA.html"><a href="case_ANOVA.html#exAnovaExercises"><i class="fa fa-check"></i><b>4.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="data-generating-models.html"><a href="data-generating-models.html"><i class="fa fa-check"></i><b>5</b> Data-generating models</a>
<ul>
<li class="chapter" data-level="5.1" data-path="data-generating-models.html"><a href="data-generating-models.html#computational-efficiency-versus-simplicity"><i class="fa fa-check"></i><b>5.1</b> Computational efficiency versus simplicity</a></li>
<li class="chapter" data-level="5.2" data-path="data-generating-models.html"><a href="data-generating-models.html#checking-the-data-generating-function"><i class="fa fa-check"></i><b>5.2</b> Checking the data-generating function</a></li>
<li class="chapter" data-level="5.3" data-path="data-generating-models.html"><a href="data-generating-models.html#exercises"><i class="fa fa-check"></i><b>5.3</b> Exercises</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="data-generating-models.html"><a href="data-generating-models.html#shifted-and-scaled-t-distribution"><i class="fa fa-check"></i><b>5.3.1</b> Shifted-and-scaled t distribution</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="estimation-procedures.html"><a href="estimation-procedures.html"><i class="fa fa-check"></i><b>6</b> Estimation procedures</a>
<ul>
<li class="chapter" data-level="6.1" data-path="estimation-procedures.html"><a href="estimation-procedures.html#further-notes-on-computational-efficiency"><i class="fa fa-check"></i><b>6.1</b> Further notes on computational efficiency</a></li>
<li class="chapter" data-level="6.2" data-path="estimation-procedures.html"><a href="estimation-procedures.html#checking-the-estimation-function"><i class="fa fa-check"></i><b>6.2</b> Checking the estimation function</a></li>
<li class="chapter" data-level="6.3" data-path="estimation-procedures.html"><a href="estimation-procedures.html#exercises-1"><i class="fa fa-check"></i><b>6.3</b> Exercises</a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="estimation-procedures.html"><a href="estimation-procedures.html#adding-the-bff-test"><i class="fa fa-check"></i><b>6.3.1</b> Adding the BFF* test</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="performance-criteria.html"><a href="performance-criteria.html"><i class="fa fa-check"></i><b>7</b> Performance criteria</a>
<ul>
<li class="chapter" data-level="7.1" data-path="performance-criteria.html"><a href="performance-criteria.html#inference-vs.-estimation"><i class="fa fa-check"></i><b>7.1</b> Inference vs. Estimation</a></li>
<li class="chapter" data-level="7.2" data-path="performance-criteria.html"><a href="performance-criteria.html#evaluation-of-estimation-methods"><i class="fa fa-check"></i><b>7.2</b> Evaluation of Estimation Methods</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-actual-properties"><i class="fa fa-check"></i><b>7.2.1</b> Assessing actual properties</a></li>
<li class="chapter" data-level="7.2.2" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-estimated-properties"><i class="fa fa-check"></i><b>7.2.2</b> Assessing estimated properties</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-a-point-estimator"><i class="fa fa-check"></i><b>7.3</b> Assessing a point estimator</a></li>
<li class="chapter" data-level="7.4" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-a-standard-error-estimator"><i class="fa fa-check"></i><b>7.4</b> Assessing a standard error estimator</a>
<ul>
<li class="chapter" data-level="7.4.1" data-path="performance-criteria.html"><a href="performance-criteria.html#why-not-assess-widehatse-directly"><i class="fa fa-check"></i><b>7.4.1</b> Why not assess <span class="math inline">\(widehat{SE}\)</span> directly?</a></li>
</ul></li>
<li class="chapter" data-level="7.5" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-a-hypothesis-testing-procedure"><i class="fa fa-check"></i><b>7.5</b> Assessing a hypothesis testing procedure</a>
<ul>
<li class="chapter" data-level="7.5.1" data-path="performance-criteria.html"><a href="performance-criteria.html#validity"><i class="fa fa-check"></i><b>7.5.1</b> Validity</a></li>
<li class="chapter" data-level="7.5.2" data-path="performance-criteria.html"><a href="performance-criteria.html#power"><i class="fa fa-check"></i><b>7.5.2</b> Power</a></li>
</ul></li>
<li class="chapter" data-level="7.6" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-confidence-intervals"><i class="fa fa-check"></i><b>7.6</b> Assessing confidence intervals</a></li>
<li class="chapter" data-level="7.7" data-path="performance-criteria.html"><a href="performance-criteria.html#uncertainty-in-our-performance-estimates-the-mcse"><i class="fa fa-check"></i><b>7.7</b> Uncertainty in our performance estimates (the MCSE)</a>
<ul>
<li class="chapter" data-level="7.7.1" data-path="performance-criteria.html"><a href="performance-criteria.html#mcse-for-variance-estimators"><i class="fa fa-check"></i><b>7.7.1</b> MCSE for variance estimators</a></li>
<li class="chapter" data-level="7.7.2" data-path="performance-criteria.html"><a href="performance-criteria.html#the-simhelpers-package-and-mcses"><i class="fa fa-check"></i><b>7.7.2</b> The simhelpers package and MCSEs</a></li>
</ul></li>
<li class="chapter" data-level="7.8" data-path="performance-criteria.html"><a href="performance-criteria.html#absolute-vs.-relative-performance-measures"><i class="fa fa-check"></i><b>7.8</b> Absolute vs. relative performance measures</a></li>
<li class="chapter" data-level="7.9" data-path="performance-criteria.html"><a href="performance-criteria.html#exercises-simulating-cronbachs-alpha"><i class="fa fa-check"></i><b>7.9</b> Exercises: Simulating Cronbach’s alpha</a>
<ul>
<li class="chapter" data-level="7.9.1" data-path="performance-criteria.html"><a href="performance-criteria.html#the-data-generating-function"><i class="fa fa-check"></i><b>7.9.1</b> The data-generating function</a></li>
<li class="chapter" data-level="7.9.2" data-path="performance-criteria.html"><a href="performance-criteria.html#the-estimation-function"><i class="fa fa-check"></i><b>7.9.2</b> The estimation function</a></li>
<li class="chapter" data-level="7.9.3" data-path="performance-criteria.html"><a href="performance-criteria.html#replicates"><i class="fa fa-check"></i><b>7.9.3</b> Replicates</a></li>
<li class="chapter" data-level="7.9.4" data-path="performance-criteria.html"><a href="performance-criteria.html#estimator-performance"><i class="fa fa-check"></i><b>7.9.4</b> Estimator performance</a></li>
<li class="chapter" data-level="7.9.5" data-path="performance-criteria.html"><a href="performance-criteria.html#confidence-interval-coverage"><i class="fa fa-check"></i><b>7.9.5</b> Confidence interval coverage</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="case_Cronbach.html"><a href="case_Cronbach.html"><i class="fa fa-check"></i><b>8</b> Case study: Cronbach Alpha</a>
<ul>
<li class="chapter" data-level="8.1" data-path="case_Cronbach.html"><a href="case_Cronbach.html#data-generating-model-1"><i class="fa fa-check"></i><b>8.1</b> Data-generating model</a></li>
<li class="chapter" data-level="8.2" data-path="case_Cronbach.html"><a href="case_Cronbach.html#estimation-procedures-1"><i class="fa fa-check"></i><b>8.2</b> Estimation procedures</a></li>
<li class="chapter" data-level="8.3" data-path="case_Cronbach.html"><a href="case_Cronbach.html#performance-calculations"><i class="fa fa-check"></i><b>8.3</b> Performance calculations</a></li>
<li class="chapter" data-level="8.4" data-path="case_Cronbach.html"><a href="case_Cronbach.html#simulation-driver"><i class="fa fa-check"></i><b>8.4</b> Simulation driver</a></li>
<li class="chapter" data-level="8.5" data-path="case_Cronbach.html"><a href="case_Cronbach.html#running-the-simulation"><i class="fa fa-check"></i><b>8.5</b> Running the simulation</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="ensuring-reproducibility.html"><a href="ensuring-reproducibility.html"><i class="fa fa-check"></i><b>9</b> Ensuring reproducibility</a>
<ul>
<li class="chapter" data-level="9.1" data-path="ensuring-reproducibility.html"><a href="ensuring-reproducibility.html#seeds-and-pseudo-random-number-generators"><i class="fa fa-check"></i><b>9.1</b> Seeds and pseudo-random number generators</a></li>
<li class="chapter" data-level="9.2" data-path="ensuring-reproducibility.html"><a href="ensuring-reproducibility.html#including-seed-in-our-simulation-driver"><i class="fa fa-check"></i><b>9.2</b> Including seed in our simulation driver</a></li>
<li class="chapter" data-level="9.3" data-path="ensuring-reproducibility.html"><a href="ensuring-reproducibility.html#reasons-for-setting-the-seed"><i class="fa fa-check"></i><b>9.3</b> Reasons for setting the seed</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="introduction.html"><a href="introduction.html#functions"><i class="fa fa-check"></i><b>10</b> More on functions</a>
<ul>
<li class="chapter" data-level="10.1" data-path="functions.html"><a href="functions.html"><i class="fa fa-check"></i><b>10.1</b> Default arguments for functions</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="case_cluster.html"><a href="case_cluster.html"><i class="fa fa-check"></i><b>11</b> Case study: A simulation with clustered data</a>
<ul>
<li class="chapter" data-level="11.1" data-path="case_cluster.html"><a href="case_cluster.html#a-design-decision-what-do-we-want-to-manipulate"><i class="fa fa-check"></i><b>11.1</b> A design decision: What do we want to manipulate?</a></li>
<li class="chapter" data-level="11.2" data-path="case_cluster.html"><a href="case_cluster.html#a-mathematical-model-for-cluster-randomized-data"><i class="fa fa-check"></i><b>11.2</b> A mathematical model for cluster-randomized data</a></li>
<li class="chapter" data-level="11.3" data-path="case_cluster.html"><a href="case_cluster.html#multilevel-data-generation-is-a-recipe-using-a-statistical-model"><i class="fa fa-check"></i><b>11.3</b> Multilevel data generation is a recipe using a statistical model</a>
<ul>
<li class="chapter" data-level="11.3.1" data-path="case_cluster.html"><a href="case_cluster.html#generating-the-multisite-data"><i class="fa fa-check"></i><b>11.3.1</b> Generating the multisite data</a></li>
</ul></li>
<li class="chapter" data-level="11.4" data-path="case_cluster.html"><a href="case_cluster.html#analyzing-our-data"><i class="fa fa-check"></i><b>11.4</b> Analyzing our data</a></li>
<li class="chapter" data-level="11.5" data-path="case_cluster.html"><a href="case_cluster.html#the-simulation"><i class="fa fa-check"></i><b>11.5</b> The simulation</a></li>
<li class="chapter" data-level="11.6" data-path="case_cluster.html"><a href="case_cluster.html#analysis-of-our-single-scenario"><i class="fa fa-check"></i><b>11.6</b> Analysis of our single scenario</a>
<ul>
<li class="chapter" data-level="11.6.1" data-path="case_cluster.html"><a href="case_cluster.html#are-the-estimators-biased"><i class="fa fa-check"></i><b>11.6.1</b> Are the estimators biased?</a></li>
<li class="chapter" data-level="11.6.2" data-path="case_cluster.html"><a href="case_cluster.html#which-method-has-the-smallest-standard-error"><i class="fa fa-check"></i><b>11.6.2</b> Which method has the smallest standard error?</a></li>
<li class="chapter" data-level="11.6.3" data-path="case_cluster.html"><a href="case_cluster.html#which-method-has-the-smallest-root-mean-squared-error"><i class="fa fa-check"></i><b>11.6.3</b> Which method has the smallest Root Mean Squared Error?</a></li>
<li class="chapter" data-level="11.6.4" data-path="case_cluster.html"><a href="case_cluster.html#do-the-methods-have-correctly-estimated-standard-errors"><i class="fa fa-check"></i><b>11.6.4</b> Do the methods have correctly estimated standard errors?</a></li>
<li class="chapter" data-level="11.6.5" data-path="case_cluster.html"><a href="case_cluster.html#did-we-have-enough-simulation-trials"><i class="fa fa-check"></i><b>11.6.5</b> Did we have enough simulation trials?</a></li>
</ul></li>
<li class="chapter" data-level="11.7" data-path="case_cluster.html"><a href="case_cluster.html#extending-to-a-multifactor-simulation"><i class="fa fa-check"></i><b>11.7</b> Extending to a multifactor simulation</a></li>
<li class="chapter" data-level="11.8" data-path="case_cluster.html"><a href="case_cluster.html#standardization-in-a-data-generating-process"><i class="fa fa-check"></i><b>11.8</b> Standardization in a data generating process</a></li>
<li class="chapter" data-level="11.9" data-path="case_cluster.html"><a href="case_cluster.html#making-analyze_data-quiet"><i class="fa fa-check"></i><b>11.9</b> Making analyze_data() quiet</a></li>
<li class="chapter" data-level="11.10" data-path="case_cluster.html"><a href="case_cluster.html#where-to-compute-performance-measures-inside-vs.-outside"><i class="fa fa-check"></i><b>11.10</b> Where to compute performance measures: inside vs. outside?</a></li>
<li class="chapter" data-level="11.11" data-path="case_cluster.html"><a href="case_cluster.html#run-the-simulation"><i class="fa fa-check"></i><b>11.11</b> Run the simulation</a></li>
<li class="chapter" data-level="11.12" data-path="case_cluster.html"><a href="case_cluster.html#analyzing-our-results"><i class="fa fa-check"></i><b>11.12</b> Analyzing our results</a>
<ul>
<li class="chapter" data-level="11.12.1" data-path="case_cluster.html"><a href="case_cluster.html#checking-on-convergence-issues"><i class="fa fa-check"></i><b>11.12.1</b> Checking on convergence issues</a></li>
<li class="chapter" data-level="11.12.2" data-path="case_cluster.html"><a href="case_cluster.html#calculating-standard-metrics"><i class="fa fa-check"></i><b>11.12.2</b> Calculating standard metrics</a></li>
<li class="chapter" data-level="11.12.3" data-path="case_cluster.html"><a href="case_cluster.html#bias-analysis"><i class="fa fa-check"></i><b>11.12.3</b> Bias analysis</a></li>
</ul></li>
<li class="chapter" data-level="11.13" data-path="case_cluster.html"><a href="case_cluster.html#exercises-2"><i class="fa fa-check"></i><b>11.13</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="error-trapping-and-other-headaches.html"><a href="error-trapping-and-other-headaches.html"><i class="fa fa-check"></i><b>12</b> Error trapping and other headaches</a>
<ul>
<li class="chapter" data-level="12.1" data-path="error-trapping-and-other-headaches.html"><a href="error-trapping-and-other-headaches.html#safe_code"><i class="fa fa-check"></i><b>12.1</b> Safe code</a>
<ul>
<li class="chapter" data-level="12.1.1" data-path="error-trapping-and-other-headaches.html"><a href="error-trapping-and-other-headaches.html#what-to-do-with-warnings"><i class="fa fa-check"></i><b>12.1.1</b> What to do with warnings</a></li>
</ul></li>
<li class="chapter" data-level="12.2" data-path="error-trapping-and-other-headaches.html"><a href="error-trapping-and-other-headaches.html#saving-files-and-results"><i class="fa fa-check"></i><b>12.2</b> Saving files and results</a>
<ul>
<li class="chapter" data-level="12.2.1" data-path="error-trapping-and-other-headaches.html"><a href="error-trapping-and-other-headaches.html#saving-simulations-as-you-go"><i class="fa fa-check"></i><b>12.2.1</b> Saving simulations as you go</a></li>
<li class="chapter" data-level="12.2.2" data-path="error-trapping-and-other-headaches.html"><a href="error-trapping-and-other-headaches.html#dynamically-making-directories"><i class="fa fa-check"></i><b>12.2.2</b> Dynamically making directories</a></li>
<li class="chapter" data-level="12.2.3" data-path="error-trapping-and-other-headaches.html"><a href="error-trapping-and-other-headaches.html#loading-and-combining-files-of-simulation-results"><i class="fa fa-check"></i><b>12.2.3</b> Loading and combining files of simulation results</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="13" data-path="exp_design.html"><a href="exp_design.html"><i class="fa fa-check"></i><b>13</b> Designing the multifactor simulation experiment</a>
<ul>
<li class="chapter" data-level="13.1" data-path="exp_design.html"><a href="exp_design.html#choosing-parameter-combinations"><i class="fa fa-check"></i><b>13.1</b> Choosing parameter combinations</a></li>
<li class="chapter" data-level="13.2" data-path="exp_design.html"><a href="exp_design.html#using-pmap-to-run-multifactor-simulations"><i class="fa fa-check"></i><b>13.2</b> Using pmap to run multifactor simulations</a></li>
<li class="chapter" data-level="13.3" data-path="exp_design.html"><a href="exp_design.html#keeping-things-organized-and-the-source-command"><i class="fa fa-check"></i><b>13.3</b> Keeping things organized and the source command</a></li>
<li class="chapter" data-level="13.4" data-path="exp_design.html"><a href="exp_design.html#analyzing-results-from-a-multifactor-experiment"><i class="fa fa-check"></i><b>13.4</b> Analyzing results from a multifactor experiment</a>
<ul>
<li class="chapter" data-level="13.4.1" data-path="exp_design.html"><a href="exp_design.html#bundling"><i class="fa fa-check"></i><b>13.4.1</b> Bundling</a></li>
<li class="chapter" data-level="13.4.2" data-path="exp_design.html"><a href="exp_design.html#aggregation"><i class="fa fa-check"></i><b>13.4.2</b> Aggregation</a></li>
<li class="chapter" data-level="13.4.3" data-path="exp_design.html"><a href="exp_design.html#regression-summarization"><i class="fa fa-check"></i><b>13.4.3</b> Regression Summarization</a></li>
<li class="chapter" data-level="13.4.4" data-path="exp_design.html"><a href="exp_design.html#focus-on-subset-kick-rest-to-supplement"><i class="fa fa-check"></i><b>13.4.4</b> Focus on subset, kick rest to supplement</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="14" data-path="case-study-a-simulation-to-compare-different-estimators.html"><a href="case-study-a-simulation-to-compare-different-estimators.html"><i class="fa fa-check"></i><b>14</b> Case study: A simulation to compare different estimators</a>
<ul>
<li class="chapter" data-level="14.1" data-path="case-study-a-simulation-to-compare-different-estimators.html"><a href="case-study-a-simulation-to-compare-different-estimators.html#the-data-generating-process"><i class="fa fa-check"></i><b>14.1</b> The data generating process</a></li>
<li class="chapter" data-level="14.2" data-path="case-study-a-simulation-to-compare-different-estimators.html"><a href="case-study-a-simulation-to-compare-different-estimators.html#the-data-analysis-methods"><i class="fa fa-check"></i><b>14.2</b> The data analysis methods</a></li>
<li class="chapter" data-level="14.3" data-path="case-study-a-simulation-to-compare-different-estimators.html"><a href="case-study-a-simulation-to-compare-different-estimators.html#the-simulation-itself"><i class="fa fa-check"></i><b>14.3</b> The simulation itself</a></li>
<li class="chapter" data-level="14.4" data-path="case-study-a-simulation-to-compare-different-estimators.html"><a href="case-study-a-simulation-to-compare-different-estimators.html#calculating-performance-measures-for-all-our-estimators"><i class="fa fa-check"></i><b>14.4</b> Calculating performance measures for all our estimators</a></li>
<li class="chapter" data-level="14.5" data-path="case-study-a-simulation-to-compare-different-estimators.html"><a href="case-study-a-simulation-to-compare-different-estimators.html#improving-the-visualization-of-the-results"><i class="fa fa-check"></i><b>14.5</b> Improving the visualization of the results</a></li>
<li class="chapter" data-level="14.6" data-path="case-study-a-simulation-to-compare-different-estimators.html"><a href="case-study-a-simulation-to-compare-different-estimators.html#extension-the-bias-variance-tradeoff"><i class="fa fa-check"></i><b>14.6</b> Extension: The Bias-variance tradeoff</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="parallel-processing.html"><a href="parallel-processing.html"><i class="fa fa-check"></i><b>15</b> Parallel Processing</a>
<ul>
<li class="chapter" data-level="15.1" data-path="parallel-processing.html"><a href="parallel-processing.html#parallel-on-your-computer"><i class="fa fa-check"></i><b>15.1</b> Parallel on your computer</a></li>
<li class="chapter" data-level="15.2" data-path="parallel-processing.html"><a href="parallel-processing.html#parallel-off-your-computer"><i class="fa fa-check"></i><b>15.2</b> Parallel off your computer</a>
<ul>
<li class="chapter" data-level="15.2.1" data-path="parallel-processing.html"><a href="parallel-processing.html#what-is-a-command-line-interface"><i class="fa fa-check"></i><b>15.2.1</b> What is a command-line interface?</a></li>
<li class="chapter" data-level="15.2.2" data-path="parallel-processing.html"><a href="parallel-processing.html#running-a-job-on-a-cluster"><i class="fa fa-check"></i><b>15.2.2</b> Running a job on a cluster</a></li>
<li class="chapter" data-level="15.2.3" data-path="parallel-processing.html"><a href="parallel-processing.html#checking-on-a-job"><i class="fa fa-check"></i><b>15.2.3</b> Checking on a job</a></li>
<li class="chapter" data-level="15.2.4" data-path="parallel-processing.html"><a href="parallel-processing.html#running-lots-of-jobs-on-a-cluster"><i class="fa fa-check"></i><b>15.2.4</b> Running lots of jobs on a cluster</a></li>
<li class="chapter" data-level="15.2.5" data-path="parallel-processing.html"><a href="parallel-processing.html#resources-for-harvards-odyssey"><i class="fa fa-check"></i><b>15.2.5</b> Resources for Harvard’s Odyssey</a></li>
<li class="chapter" data-level="15.2.6" data-path="parallel-processing.html"><a href="parallel-processing.html#acknowledgements-1"><i class="fa fa-check"></i><b>15.2.6</b> Acknowledgements</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="16" data-path="case-study-the-power-and-validity-of-neymans-ate-estimate.html"><a href="case-study-the-power-and-validity-of-neymans-ate-estimate.html"><i class="fa fa-check"></i><b>16</b> Case study: The Power and Validity of Neyman’s ATE Estimate</a>
<ul>
<li class="chapter" data-level="16.1" data-path="case-study-the-power-and-validity-of-neymans-ate-estimate.html"><a href="case-study-the-power-and-validity-of-neymans-ate-estimate.html#step-1-write-a-function-for-a-specific-simulation-given-specific-parameters."><i class="fa fa-check"></i><b>16.1</b> Step 1: Write a function for a specific simulation given specific parameters.</a>
<ul>
<li class="chapter" data-level="16.1.1" data-path="case-study-the-power-and-validity-of-neymans-ate-estimate.html"><a href="case-study-the-power-and-validity-of-neymans-ate-estimate.html#running-our-single-trial-more-than-once"><i class="fa fa-check"></i><b>16.1.1</b> Running our single trial more than once</a></li>
</ul></li>
<li class="chapter" data-level="16.2" data-path="case-study-the-power-and-validity-of-neymans-ate-estimate.html"><a href="case-study-the-power-and-validity-of-neymans-ate-estimate.html#step-2-make-a-dataframe-of-all-experimental-combinations-desired"><i class="fa fa-check"></i><b>16.2</b> Step 2: Make a dataframe of all experimental combinations desired</a></li>
<li class="chapter" data-level="16.3" data-path="case-study-the-power-and-validity-of-neymans-ate-estimate.html"><a href="case-study-the-power-and-validity-of-neymans-ate-estimate.html#step-3-explore-results"><i class="fa fa-check"></i><b>16.3</b> Step 3: Explore results</a>
<ul>
<li class="chapter" data-level="16.3.1" data-path="case-study-the-power-and-validity-of-neymans-ate-estimate.html"><a href="case-study-the-power-and-validity-of-neymans-ate-estimate.html#visualizing-experimental-results"><i class="fa fa-check"></i><b>16.3.1</b> Visualizing experimental results</a></li>
<li class="chapter" data-level="16.3.2" data-path="case-study-the-power-and-validity-of-neymans-ate-estimate.html"><a href="case-study-the-power-and-validity-of-neymans-ate-estimate.html#looking-at-main-effects"><i class="fa fa-check"></i><b>16.3.2</b> Looking at main effects</a></li>
</ul></li>
<li class="chapter" data-level="16.4" data-path="case-study-the-power-and-validity-of-neymans-ate-estimate.html"><a href="case-study-the-power-and-validity-of-neymans-ate-estimate.html#addendum-saving-more-details"><i class="fa fa-check"></i><b>16.4</b> Addendum: Saving more details</a>
<ul>
<li class="chapter" data-level="16.4.1" data-path="case-study-the-power-and-validity-of-neymans-ate-estimate.html"><a href="case-study-the-power-and-validity-of-neymans-ate-estimate.html#getting-results-ready-for-analysis"><i class="fa fa-check"></i><b>16.4.1</b> Getting results ready for analysis</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="17" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html"><i class="fa fa-check"></i><b>17</b> Design, analysis, and presentation of simulation results</a>
<ul>
<li class="chapter" data-level="17.1" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html#designing-the-simulation-experiment"><i class="fa fa-check"></i><b>17.1</b> Designing the simulation experiment</a></li>
<li class="chapter" data-level="17.2" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html#choosing-parameter-levels"><i class="fa fa-check"></i><b>17.2</b> Choosing parameter levels</a></li>
<li class="chapter" data-level="17.3" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html#presentation"><i class="fa fa-check"></i><b>17.3</b> Presentation</a></li>
<li class="chapter" data-level="17.4" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html#tabulation"><i class="fa fa-check"></i><b>17.4</b> Tabulation</a></li>
<li class="chapter" data-level="17.5" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html#visualization"><i class="fa fa-check"></i><b>17.5</b> Visualization</a>
<ul>
<li class="chapter" data-level="17.5.1" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html#example-1-biserial-correlation-estimation"><i class="fa fa-check"></i><b>17.5.1</b> Example 1: Biserial correlation estimation</a></li>
<li class="chapter" data-level="17.5.2" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html#example-2-variance-estimation-and-meta-regression"><i class="fa fa-check"></i><b>17.5.2</b> Example 2: Variance estimation and Meta-regression</a></li>
<li class="chapter" data-level="17.5.3" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html#example-heat-maps-of-coverage"><i class="fa fa-check"></i><b>17.5.3</b> Example: Heat maps of coverage</a></li>
</ul></li>
<li class="chapter" data-level="17.6" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html#modeling"><i class="fa fa-check"></i><b>17.6</b> Modeling</a></li>
<li class="chapter" data-level="17.7" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html#presentation-1"><i class="fa fa-check"></i><b>17.7</b> Presentation</a></li>
</ul></li>
<li class="chapter" data-level="18" data-path="simulation-under-the-potential-outcomes-framework.html"><a href="simulation-under-the-potential-outcomes-framework.html"><i class="fa fa-check"></i><b>18</b> Simulation under the Potential Outcomes Framework</a>
<ul>
<li class="chapter" data-level="18.1" data-path="simulation-under-the-potential-outcomes-framework.html"><a href="simulation-under-the-potential-outcomes-framework.html#finite-vs.-superpopulation-inference"><i class="fa fa-check"></i><b>18.1</b> Finite vs. Superpopulation inference</a></li>
<li class="chapter" data-level="18.2" data-path="simulation-under-the-potential-outcomes-framework.html"><a href="simulation-under-the-potential-outcomes-framework.html#data-generation-processes-for-potential-outcomes"><i class="fa fa-check"></i><b>18.2</b> Data generation processes for potential outcomes</a></li>
<li class="chapter" data-level="18.3" data-path="simulation-under-the-potential-outcomes-framework.html"><a href="simulation-under-the-potential-outcomes-framework.html#finite-sample-performance-measures"><i class="fa fa-check"></i><b>18.3</b> Finite sample performance measures</a></li>
<li class="chapter" data-level="18.4" data-path="simulation-under-the-potential-outcomes-framework.html"><a href="simulation-under-the-potential-outcomes-framework.html#nested-finite-simulation-procedure"><i class="fa fa-check"></i><b>18.4</b> Nested finite simulation procedure</a></li>
<li class="chapter" data-level="18.5" data-path="simulation-under-the-potential-outcomes-framework.html"><a href="simulation-under-the-potential-outcomes-framework.html#calibrated-simulations-and-the-potential-outcomes-framework"><i class="fa fa-check"></i><b>18.5</b> Calibrated simulations and the potential outcomes framework</a></li>
</ul></li>
<li class="chapter" data-level="19" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html"><i class="fa fa-check"></i><b>19</b> Simulations as evidence</a>
<ul>
<li class="chapter" data-level="19.1" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#use-extensive-multi-factor-simulations"><i class="fa fa-check"></i><b>19.1</b> Use extensive multi-factor simulations</a></li>
<li class="chapter" data-level="19.2" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#beat-them-at-their-own-game"><i class="fa fa-check"></i><b>19.2</b> Beat them at their own game</a></li>
<li class="chapter" data-level="19.3" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#calibrated-simulations"><i class="fa fa-check"></i><b>19.3</b> Calibrated simulations</a></li>
</ul></li>
<li class="chapter" data-level="20" data-path="the-parametric-bootstrap.html"><a href="the-parametric-bootstrap.html"><i class="fa fa-check"></i><b>20</b> The Parametric bootstrap</a>
<ul>
<li class="chapter" data-level="20.1" data-path="the-parametric-bootstrap.html"><a href="the-parametric-bootstrap.html#air-conditioners-a-stolen-case-study"><i class="fa fa-check"></i><b>20.1</b> Air conditioners: a stolen case study</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Designing Monte Carlo Simulations in R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="case_cluster" class="section level1 hasAnchor" number="11">
<h1><span class="header-section-number">Chapter 11</span> Case study: A simulation with clustered data<a href="case_cluster.html#case_cluster" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Generating data with complex structure can be intimidating, but if you set out a recipe for how the data is generated it is often not to bad to build that recipe up with code.
We will illustrate how to tackle this kind of data with a case study of best practices for analyzing data from a cluster-randomized RCT of students nested in schools.</p>
<p>A lot of the current literature on multisite trials is exploring how variation in the size of impacts across sites can cause bad things can happen. What does it mean for this particular context?</p>
<p>There are various ways of analyzing such data:</p>
<ul>
<li>Individual Level Analysis
<ul>
<li>Multilevel modeling (MLM): Fit a multilevel model to account for dependencies within cluster.</li>
<li>Linear regression (LR): Fit a linear model and use cluster robust standard errors.</li>
</ul></li>
<li>Aggregation
<ul>
<li>Aggregation (Agg): Calculate average outcomes for each cluster and fit a linear model with heteroskedastic robust SEs</li>
</ul></li>
</ul>
<p>We might then ask, are any of these strategies biased? When and how much?
Are any of these strategies more precise (have smaller SEs)?
Are the standard errors for these different strategies valid?
We might think aggregation should be worse since we are losing information, right?
If so, how much is lost?</p>
<p>To make this investigation a bit more rich, we are also going to ask a final question that will influence our data generating process.
We want to investigate what happens when the impact of a site depends on the site size.
This is a common question that has gained some attention in the education world, where we might reasonably think sites of different sizes may respond to treatment differently.
We want to know if our studied methods would end up giving us biased results, should there be such a relationship.</p>
<div id="a-design-decision-what-do-we-want-to-manipulate" class="section level2 hasAnchor" number="11.1">
<h2><span class="header-section-number">11.1</span> A design decision: What do we want to manipulate?<a href="case_cluster.html#a-design-decision-what-do-we-want-to-manipulate" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>There are a lot of ways we might generate data.
To figure out what kinds of controls we have on that process, we need to think about the goals of the simulation.</p>
<p>In our case, for example, we might think:</p>
<ol style="list-style-type: decimal">
<li>We figure if all the sites are the same size, we are probably safe. But if sites vary, then we could have issues with our estimators.</li>
<li>Also, if site size varies, but has nothing to do with impact, then we are probably good, at least for bias, but if it is associated then how we average our sites is going to matter.</li>
</ol>
<p>Usually it is good practice to keep the simple option along with the complex one.
We want to both check that something does not matter as well as verify it does.</p>
<p>Given this, we land on the following points:</p>
<ul>
<li>We need to consider both all-same-size sites and variable size sites.</li>
<li>Our DGP probably should have some impact variation across sites.</li>
<li>We should probably connect impact variation to site size to explore a more malicious context.</li>
<li>For simplicity we will simply include a site size by treatment interaction term to get our heterogeneity.</li>
</ul>
</div>
<div id="a-mathematical-model-for-cluster-randomized-data" class="section level2 hasAnchor" number="11.2">
<h2><span class="header-section-number">11.2</span> A mathematical model for cluster-randomized data<a href="case_cluster.html#a-mathematical-model-for-cluster-randomized-data" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The easiest way to write down a recipe for data generation is with a mathematical model.
This is especially important for more complex DGPs, such as those for hierarchical data.</p>
<p>We know we want a collection of clusters with different sizes and different baseline mean outcomes.
To keep things simple, we might want a common treatment shift within cluster: if we treat a cluster, everyone is raised by some specified amount.</p>
<p>We want to have some measure of site size.
For starters, lets create a covariate which is the percent of the average site size that a site is:
<span class="math display">\[ S_j = \frac{n_j - \bar{n}}{ \bar{n} } \]</span></p>
<p>Using this coveriate, we could end up with this model to describe our data:
<span class="math display">\[
\begin{aligned}
Y_{ij} &amp;= \beta_{0j} + \epsilon_{ij} \\
\epsilon_{ij} &amp;\sim N( 0, \sigma^2_\epsilon ) \\
\beta_{0j} &amp;= \gamma_{0} + \gamma_{1} Z_j + \gamma_2 Z_j S_j + u_j \\
u_j &amp;\sim N( 0, \sigma^2_u )
\end{aligned}
\]</span>
Our parameters are the mean outcome of control unit (<span class="math inline">\(\gamma_0\)</span>), the treatment Impact (<span class="math inline">\(\gamma_1\)</span>), the amount of cross site variation (<span class="math inline">\(\sigma^2_u\)</span>), and residual variation (<span class="math inline">\(\sigma^2_\epsilon\)</span>).
Our <span class="math inline">\(\gamma_2\)</span> is our site-size by treatment interaction term: bigger sites will (assuming <span class="math inline">\(\gamma_2\)</span> is positive) have larger treatment impacts.</p>
<p>If you prefer the reduced form, it would be:</p>
<p><span class="math display">\[ Y_{ij} = \gamma_{0} + \gamma_{1} Z_j + \gamma_2 Z_j S_j  + u_j + \epsilon_{ij}  \]</span>
We might also include a main effect for <span class="math inline">\(S_j\)</span>.
This would make larger sites systematically different than smaller sites at baseline, rather than having it only be part of our treatment variation term.
For simplicity we drop it here.</p>
<p>To generate data, we would also need several other quantities specified.
First, we need to know the number of clusters (<span class="math inline">\(J\)</span>), the sizes of the clusters (<span class="math inline">\(n_j\)</span>, for <span class="math inline">\(j = 1, \ldots, J\)</span>).
We have to provide a recipe for generating these sizes. We might try</p>
<p><span class="math display">\[ n_j \sim unif( (1-\alpha)\bar{n}, (1+\alpha)\bar{n} ) \]</span>
with a fixed <span class="math inline">\(\alpha\)</span> to control the amount of variation in cluster size.
If <span class="math inline">\(\bar{n} = 100\)</span> and <span class="math inline">\(\alpha = 0.25\)</span> then we would, for example, have sites ranging from 75 to 125 in size.</p>
<p>Given how we are generating site size, look again at our treatment impact heterogeneity term:</p>
<p><span class="math display">\[ \gamma_2 Z_j \left(\frac{n_j - \bar{n}}{\bar{n}}\right)  \]</span>
Note how we are standardizing by average site size to make our covariate not change in terms of its importance as a function of site size, but rather as a function of <span class="math inline">\(\alpha\)</span>.
In particular, <span class="math inline">\(\frac{n_j - \bar{n}}{\bar{n}}\)</span> will range from <span class="math inline">\(-\alpha\)</span> to <span class="math inline">\(\alpha\)</span>, regardless of average site size.
Carefully setting up a DGP so the “knobs” we use are standardized like this can make interpreting the simulation results much easier.
Consider if we did not divide by <span class="math inline">\(\bar{n}\)</span>: then larger sites would also have more severe heterogeniety in treatment impact; this could make interpreting the results very confusing.</p>
<p>We next need to define how we generate our treatment indicator, <span class="math inline">\(Z_j\)</span>.
We might specify some proportion <span class="math inline">\(p\)</span> assigned to treatment, and set <span class="math inline">\(Z_j = 1\)</span> or <span class="math inline">\(Z_j = 0\)</span> using a simple random sampling approach on our <span class="math inline">\(J\)</span> units.</p>
</div>
<div id="multilevel-data-generation-is-a-recipe-using-a-statistical-model" class="section level2 hasAnchor" number="11.3">
<h2><span class="header-section-number">11.3</span> Multilevel data generation is a recipe using a statistical model<a href="case_cluster.html#multilevel-data-generation-is-a-recipe-using-a-statistical-model" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Now let’s translate our mathematical model to code.
In the real world:</p>
<ul>
<li>We obtain data, we pick a model, we estimate parameters</li>
<li>The data comes with covariates and outcomes</li>
<li>It also comes with sample size, sizes of the clusters, etc.</li>
</ul>
<p>In the simulation world, by comparison:</p>
<ul>
<li>We pick a model, we decide how much data, we generate covariates, we pick the parameters, and then we generate outcomes</li>
<li>We need to decide how many clusters, how big the clusters are, etc.</li>
<li>We have to specify how the covariates are made. This piece is very different from real-world analysis.</li>
</ul>
<p>Step 1: Generate your sites</p>
<ul>
<li>Generate site-level covariates</li>
<li>Generate sample size within each site</li>
<li>Generate site level random effects</li>
</ul>
<p>Step 2: Generate your students inside the sites</p>
<ul>
<li>Generate student covariates</li>
<li>Generate student residuals</li>
<li>Add everything up to generate student outcomes</li>
</ul>
<p>The mathematical model gives us exactly the details we need to execute on these steps.
In particular, we can translate the math directly to R code, and then finally put it all in a function.</p>
<p>In general, we have several components to our model:</p>
<p><em>COVARIATES and STRUCTURAL COVARIATES</em>
Covariates are the things that we are usually given when analyzing real data.
This is a broad definition, including things beside baseline information:</p>
<ul>
<li>Conventional: student demographics, school-level characteristics, treatment assignment</li>
<li>Structural: number of observations in each school, proportion treated in each school</li>
</ul>
<p>We don’t often think of these things as “covariates” but in a simulation we have to get them from somewhere.</p>
<p><em>MODEL</em>
This is the parametric relationship between everything: how the outcomes are linked to the covariates.
This includes specification of any additional randomness (residuals, etc.)</p>
<p><em>DESIGN PARAMETERS</em>
These are, e.g., the number of sites or variation in site size.
These control how we generate the structural covariates.
In the real world, we don’t tend to think of these things are covariates per se, they are more just consequences of the data.
We rarely model them, but instead coniditon on them, in a statistical analysis.</p>
<p><em>PARAMETERS</em>
These are the specifics: for a given model, parameters describe degree of variability, what the slope is, and so forth.
We usually estimate these FROM data.
Critically, if we know them, we can GENERATE NEW DATA.</p>
<div id="generating-the-multisite-data" class="section level3 hasAnchor" number="11.3.1">
<h3><span class="header-section-number">11.3.1</span> Generating the multisite data<a href="case_cluster.html#generating-the-multisite-data" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We know we will need to generate and then analyze data.
First lets focus on the “generate” piece.
Borrowing from our DGP skeleton, we specify a function with all the parameters we might want to pass it, including defaults for each (see @(#default_arguments) for more on function defaults):</p>
<div class="sourceCode" id="cb212"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb212-1"><a href="case_cluster.html#cb212-1" aria-hidden="true" tabindex="-1"></a>gen_dat_model <span class="ot">&lt;-</span> <span class="cf">function</span>( <span class="at">n_bar =</span> <span class="dv">10</span>,</span>
<span id="cb212-2"><a href="case_cluster.html#cb212-2" aria-hidden="true" tabindex="-1"></a>                           <span class="at">J =</span> <span class="dv">30</span>,</span>
<span id="cb212-3"><a href="case_cluster.html#cb212-3" aria-hidden="true" tabindex="-1"></a>                           <span class="at">p =</span> <span class="fl">0.5</span>,</span>
<span id="cb212-4"><a href="case_cluster.html#cb212-4" aria-hidden="true" tabindex="-1"></a>                           <span class="at">gamma_0 =</span> <span class="dv">0</span>, <span class="at">gamma_1 =</span> <span class="dv">0</span>, <span class="at">gamma_2 =</span> <span class="dv">0</span>,</span>
<span id="cb212-5"><a href="case_cluster.html#cb212-5" aria-hidden="true" tabindex="-1"></a>                           <span class="at">sigma2_u =</span> <span class="dv">0</span>, <span class="at">sigma2_e =</span> <span class="dv">1</span>,</span>
<span id="cb212-6"><a href="case_cluster.html#cb212-6" aria-hidden="true" tabindex="-1"></a>                           <span class="at">alpha =</span> <span class="dv">0</span> ) {</span>
<span id="cb212-7"><a href="case_cluster.html#cb212-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Code (see below) goes here.</span></span>
<span id="cb212-8"><a href="case_cluster.html#cb212-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Note our parameters are a mix of <em>model parameters</em> (gamma_0, gamma_1, sigma2_e, etc., representing coefficients in regressions, variance terms, etc.) and <em>design parameters</em> (n_bar, J, p) that directly inform data generation.
We set default arguments (e.g., gamma_0=0) so we can ignore aspects of your DGP that we don’t care about later on.</p>
<p><em>Make the sites.</em>
We make the sites first:</p>
<div class="sourceCode" id="cb213"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb213-1"><a href="case_cluster.html#cb213-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># generate site sizes </span></span>
<span id="cb213-2"><a href="case_cluster.html#cb213-2" aria-hidden="true" tabindex="-1"></a>  n_min <span class="ot">=</span> <span class="fu">round</span>( n_bar <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> alpha) )</span>
<span id="cb213-3"><a href="case_cluster.html#cb213-3" aria-hidden="true" tabindex="-1"></a>  n_max <span class="ot">=</span> <span class="fu">round</span>( n_bar <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> alpha) )</span>
<span id="cb213-4"><a href="case_cluster.html#cb213-4" aria-hidden="true" tabindex="-1"></a>  nj <span class="ot">&lt;-</span> <span class="fu">sample</span>( n_min<span class="sc">:</span>n_max, J, <span class="at">replace=</span><span class="cn">TRUE</span> )</span>
<span id="cb213-5"><a href="case_cluster.html#cb213-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb213-6"><a href="case_cluster.html#cb213-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate average control outcome and average ATE for all sites</span></span>
<span id="cb213-7"><a href="case_cluster.html#cb213-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># (The random effects)</span></span>
<span id="cb213-8"><a href="case_cluster.html#cb213-8" aria-hidden="true" tabindex="-1"></a>  u0j <span class="ot">=</span> <span class="fu">rnorm</span>( J, <span class="at">mean=</span><span class="dv">0</span>, <span class="at">sd=</span><span class="fu">sqrt</span>( sigma2_u ) )</span>
<span id="cb213-9"><a href="case_cluster.html#cb213-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb213-10"><a href="case_cluster.html#cb213-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># randomize units within each site (proportion p to treatment)</span></span>
<span id="cb213-11"><a href="case_cluster.html#cb213-11" aria-hidden="true" tabindex="-1"></a>  Zj <span class="ot">=</span> <span class="fu">ifelse</span>( <span class="fu">sample</span>( <span class="dv">1</span><span class="sc">:</span>J ) <span class="sc">&lt;=</span> J <span class="sc">*</span> p, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb213-12"><a href="case_cluster.html#cb213-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb213-13"><a href="case_cluster.html#cb213-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate site intercept for each site</span></span>
<span id="cb213-14"><a href="case_cluster.html#cb213-14" aria-hidden="true" tabindex="-1"></a>  beta_0j <span class="ot">=</span> gamma_0 <span class="sc">+</span> gamma_1 <span class="sc">*</span> Zj <span class="sc">+</span> gamma_2 <span class="sc">*</span> Zj <span class="sc">*</span> (nj<span class="sc">-</span>n_bar)<span class="sc">/</span>n_bar <span class="sc">+</span> u0j</span></code></pre></div>
<p>Note the line with <code>sample(1:J) &lt;= J*p</code>; this is a simple trick to generate treatment and control.</p>
<p>There is also a serious error in the above code; we leave it as an exercise (see below) to find and fix it.</p>
<p><em>Make the individuals.</em>
Then the individuals</p>
<div class="sourceCode" id="cb214"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb214-1"><a href="case_cluster.html#cb214-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make individual site membership</span></span>
<span id="cb214-2"><a href="case_cluster.html#cb214-2" aria-hidden="true" tabindex="-1"></a>  sid <span class="ot">=</span> <span class="fu">as.factor</span>( <span class="fu">rep</span>( <span class="dv">1</span><span class="sc">:</span>J, nj ) )</span>
<span id="cb214-3"><a href="case_cluster.html#cb214-3" aria-hidden="true" tabindex="-1"></a>  dd <span class="ot">=</span> <span class="fu">data.frame</span>( <span class="at">sid =</span> sid )</span>
<span id="cb214-4"><a href="case_cluster.html#cb214-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb214-5"><a href="case_cluster.html#cb214-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make individual level tx variables</span></span>
<span id="cb214-6"><a href="case_cluster.html#cb214-6" aria-hidden="true" tabindex="-1"></a>  dd<span class="sc">$</span>Z <span class="ot">=</span> Zj[ dd<span class="sc">$</span>sid ]</span>
<span id="cb214-7"><a href="case_cluster.html#cb214-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb214-8"><a href="case_cluster.html#cb214-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate the residuals </span></span>
<span id="cb214-9"><a href="case_cluster.html#cb214-9" aria-hidden="true" tabindex="-1"></a>  N <span class="ot">=</span> <span class="fu">sum</span>( nj )</span>
<span id="cb214-10"><a href="case_cluster.html#cb214-10" aria-hidden="true" tabindex="-1"></a>  e <span class="ot">=</span> <span class="fu">rnorm</span>( N, <span class="at">mean=</span><span class="dv">0</span>, <span class="at">sd=</span><span class="fu">sqrt</span>( sigma2_e ) )</span>
<span id="cb214-11"><a href="case_cluster.html#cb214-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb214-12"><a href="case_cluster.html#cb214-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Bundle and send out</span></span>
<span id="cb214-13"><a href="case_cluster.html#cb214-13" aria-hidden="true" tabindex="-1"></a>  dd <span class="ot">&lt;-</span> <span class="fu">mutate</span>( dd, </span>
<span id="cb214-14"><a href="case_cluster.html#cb214-14" aria-hidden="true" tabindex="-1"></a>                <span class="at">sid=</span><span class="fu">as.factor</span>(sid),</span>
<span id="cb214-15"><a href="case_cluster.html#cb214-15" aria-hidden="true" tabindex="-1"></a>                <span class="at">Yobs =</span> beta_0j[sid] <span class="sc">+</span> e, </span>
<span id="cb214-16"><a href="case_cluster.html#cb214-16" aria-hidden="true" tabindex="-1"></a>                <span class="at">Z =</span> Zj[ sid ] )</span></code></pre></div>
<p>The <code>rep</code> command will repeat each number, 1, 2… J, the corresponding number of times as listed in nj.</p>
<p>We wrap it all in a function, and when we call it we get:</p>
<div class="sourceCode" id="cb215"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb215-1"><a href="case_cluster.html#cb215-1" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">gen_dat_model</span>( <span class="at">n=</span><span class="dv">5</span>, <span class="at">J=</span><span class="dv">3</span>, <span class="at">p=</span><span class="fl">0.5</span>, </span>
<span id="cb215-2"><a href="case_cluster.html#cb215-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">gamma_0=</span><span class="dv">0</span>, <span class="at">gamma_1=</span><span class="fl">0.2</span>, <span class="at">gamma_2=</span><span class="fl">0.2</span>,</span>
<span id="cb215-3"><a href="case_cluster.html#cb215-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">sigma2_u =</span> <span class="fl">0.4</span>, <span class="at">sigma2_e =</span> <span class="dv">1</span>,</span>
<span id="cb215-4"><a href="case_cluster.html#cb215-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">alpha =</span> <span class="fl">0.5</span> )</span>
<span id="cb215-5"><a href="case_cluster.html#cb215-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb215-6"><a href="case_cluster.html#cb215-6" aria-hidden="true" tabindex="-1"></a>dat</span></code></pre></div>
<pre><code>##    sid Z       Yobs
## 1    1 0  1.3752789
## 2    1 0  0.5802912
## 3    1 0  1.2390264
## 4    1 0 -0.3707643
## 5    1 0  0.3861877
## 6    2 0  1.7129609
## 7    2 0 -0.2930146
## 8    2 0  2.3357674
## 9    2 0  0.9447586
## 10   2 0  3.4317594
## 11   3 1 -1.5382230
## 12   3 1 -2.3565531
## 13   3 1  0.9347565</code></pre>
</div>
</div>
<div id="analyzing-our-data" class="section level2 hasAnchor" number="11.4">
<h2><span class="header-section-number">11.4</span> Analyzing our data<a href="case_cluster.html#analyzing-our-data" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>To analyze our data, we use two libraries, the <code>lme4</code> package (for multilevel modeling), the <code>arm</code> package (which gives us nice access to standard errors, with <code>se.fixef()</code>), and <code>lmerTest</code> (which gives us <span class="math inline">\(p\)</span>-values for multilevel modeling).
We also need the <code>estimatr</code> package to get robust SEs with <code>lm_robust</code>.</p>
<div class="sourceCode" id="cb217"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb217-1"><a href="case_cluster.html#cb217-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>( lme4 )</span>
<span id="cb217-2"><a href="case_cluster.html#cb217-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>( arm )</span>
<span id="cb217-3"><a href="case_cluster.html#cb217-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>( lmerTest )</span>
<span id="cb217-4"><a href="case_cluster.html#cb217-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>( estimatr )</span></code></pre></div>
<p>We have three analysis functions, which we can put in three different methods:</p>
<p>Multilevel Regression (MLM):</p>
<div class="sourceCode" id="cb218"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb218-1"><a href="case_cluster.html#cb218-1" aria-hidden="true" tabindex="-1"></a>analysis_MLM <span class="ot">&lt;-</span> <span class="cf">function</span>( dat ) {</span>
<span id="cb218-2"><a href="case_cluster.html#cb218-2" aria-hidden="true" tabindex="-1"></a>  M1 <span class="ot">=</span> <span class="fu">lmer</span>( Yobs <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> Z <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>sid),</span>
<span id="cb218-3"><a href="case_cluster.html#cb218-3" aria-hidden="true" tabindex="-1"></a>             <span class="at">data=</span>dat )</span>
<span id="cb218-4"><a href="case_cluster.html#cb218-4" aria-hidden="true" tabindex="-1"></a>  est <span class="ot">=</span> <span class="fu">fixef</span>( M1 )[[<span class="st">&quot;Z&quot;</span>]]</span>
<span id="cb218-5"><a href="case_cluster.html#cb218-5" aria-hidden="true" tabindex="-1"></a>  se <span class="ot">=</span> <span class="fu">se.fixef</span>( M1 )[[<span class="st">&quot;Z&quot;</span>]]</span>
<span id="cb218-6"><a href="case_cluster.html#cb218-6" aria-hidden="true" tabindex="-1"></a>  pv <span class="ot">=</span> <span class="fu">summary</span>(M1)<span class="sc">$</span>coefficients[<span class="st">&quot;Z&quot;</span>,<span class="dv">5</span>]</span>
<span id="cb218-7"><a href="case_cluster.html#cb218-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>( <span class="at">ATE_hat =</span> est, <span class="at">SE_hat =</span> se, <span class="at">p_value =</span> pv )</span>
<span id="cb218-8"><a href="case_cluster.html#cb218-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Linear Regression with Cluster-Robust Standard Errors (LM):</p>
<div class="sourceCode" id="cb219"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb219-1"><a href="case_cluster.html#cb219-1" aria-hidden="true" tabindex="-1"></a>analysis_OLS <span class="ot">&lt;-</span> <span class="cf">function</span>( dat ) {</span>
<span id="cb219-2"><a href="case_cluster.html#cb219-2" aria-hidden="true" tabindex="-1"></a>  M2 <span class="ot">&lt;-</span> <span class="fu">lm_robust</span>( Yobs <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> Z, </span>
<span id="cb219-3"><a href="case_cluster.html#cb219-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">data=</span>dat, <span class="at">clusters=</span>sid )</span>
<span id="cb219-4"><a href="case_cluster.html#cb219-4" aria-hidden="true" tabindex="-1"></a>  est <span class="ot">&lt;-</span> M2<span class="sc">$</span>coefficients[[<span class="st">&quot;Z&quot;</span>]]</span>
<span id="cb219-5"><a href="case_cluster.html#cb219-5" aria-hidden="true" tabindex="-1"></a>  se  <span class="ot">&lt;-</span> M2<span class="sc">$</span>std.error[[<span class="st">&quot;Z&quot;</span>]]</span>
<span id="cb219-6"><a href="case_cluster.html#cb219-6" aria-hidden="true" tabindex="-1"></a>  pv <span class="ot">&lt;-</span> M2<span class="sc">$</span>p.value[[<span class="st">&quot;Z&quot;</span>]]</span>
<span id="cb219-7"><a href="case_cluster.html#cb219-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>( <span class="at">ATE_hat =</span> est, <span class="at">SE_hat =</span> se, <span class="at">p_value =</span> pv )</span>
<span id="cb219-8"><a href="case_cluster.html#cb219-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Aggregate data (Agg):</p>
<div class="sourceCode" id="cb220"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb220-1"><a href="case_cluster.html#cb220-1" aria-hidden="true" tabindex="-1"></a>analysis_agg <span class="ot">&lt;-</span> <span class="cf">function</span>( dat ) {</span>
<span id="cb220-2"><a href="case_cluster.html#cb220-2" aria-hidden="true" tabindex="-1"></a>  datagg <span class="ot">&lt;-</span> </span>
<span id="cb220-3"><a href="case_cluster.html#cb220-3" aria-hidden="true" tabindex="-1"></a>    dat <span class="sc">%&gt;%</span> </span>
<span id="cb220-4"><a href="case_cluster.html#cb220-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>( sid, Z ) <span class="sc">%&gt;%</span></span>
<span id="cb220-5"><a href="case_cluster.html#cb220-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>( </span>
<span id="cb220-6"><a href="case_cluster.html#cb220-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">Ybar =</span> <span class="fu">mean</span>( Yobs ),</span>
<span id="cb220-7"><a href="case_cluster.html#cb220-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">n =</span> <span class="fu">n</span>() </span>
<span id="cb220-8"><a href="case_cluster.html#cb220-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb220-9"><a href="case_cluster.html#cb220-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb220-10"><a href="case_cluster.html#cb220-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>( <span class="fu">nrow</span>( datagg ) <span class="sc">==</span> <span class="fu">length</span>(<span class="fu">unique</span>(dat<span class="sc">$</span>sid) ) )</span>
<span id="cb220-11"><a href="case_cluster.html#cb220-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb220-12"><a href="case_cluster.html#cb220-12" aria-hidden="true" tabindex="-1"></a>  M3 <span class="ot">&lt;-</span> <span class="fu">lm_robust</span>( Ybar <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> Z, </span>
<span id="cb220-13"><a href="case_cluster.html#cb220-13" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data=</span>datagg, <span class="at">se_type =</span> <span class="st">&quot;HC2&quot;</span> )</span>
<span id="cb220-14"><a href="case_cluster.html#cb220-14" aria-hidden="true" tabindex="-1"></a>  est <span class="ot">&lt;-</span> M3<span class="sc">$</span>coefficients[[<span class="st">&quot;Z&quot;</span>]]</span>
<span id="cb220-15"><a href="case_cluster.html#cb220-15" aria-hidden="true" tabindex="-1"></a>  se <span class="ot">&lt;-</span> M3<span class="sc">$</span>std.error[[<span class="st">&quot;Z&quot;</span>]]</span>
<span id="cb220-16"><a href="case_cluster.html#cb220-16" aria-hidden="true" tabindex="-1"></a>  pv <span class="ot">&lt;-</span> M3<span class="sc">$</span>p.value[[<span class="st">&quot;Z&quot;</span>]]</span>
<span id="cb220-17"><a href="case_cluster.html#cb220-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>( <span class="at">ATE_hat =</span> est, <span class="at">SE_hat =</span> se, <span class="at">p_value =</span> pv )</span>
<span id="cb220-18"><a href="case_cluster.html#cb220-18" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>And then a single function that puts all these together:</p>
<div class="sourceCode" id="cb221"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb221-1"><a href="case_cluster.html#cb221-1" aria-hidden="true" tabindex="-1"></a>analyze_data <span class="ot">=</span> <span class="cf">function</span>( dat ) {</span>
<span id="cb221-2"><a href="case_cluster.html#cb221-2" aria-hidden="true" tabindex="-1"></a>  MLM <span class="ot">=</span> <span class="fu">analysis_MLM</span>( dat )</span>
<span id="cb221-3"><a href="case_cluster.html#cb221-3" aria-hidden="true" tabindex="-1"></a>  LR <span class="ot">=</span> <span class="fu">analysis_OLS</span>( dat )</span>
<span id="cb221-4"><a href="case_cluster.html#cb221-4" aria-hidden="true" tabindex="-1"></a>  Agg <span class="ot">=</span> <span class="fu">analysis_agg</span>( dat )</span>
<span id="cb221-5"><a href="case_cluster.html#cb221-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb221-6"><a href="case_cluster.html#cb221-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>( <span class="at">MLM =</span> MLM, <span class="at">LR =</span> LR, <span class="at">Agg =</span> Agg,</span>
<span id="cb221-7"><a href="case_cluster.html#cb221-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">.id =</span> <span class="st">&quot;method&quot;</span> )</span>
<span id="cb221-8"><a href="case_cluster.html#cb221-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>When we pass a dataset to it, we get a nice table of results that we can evaluate:</p>
<div class="sourceCode" id="cb222"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb222-1"><a href="case_cluster.html#cb222-1" aria-hidden="true" tabindex="-1"></a><span class="fu">analyze_data</span>( dat )</span></code></pre></div>
<pre><code>## # A tibble: 3 × 4
##   method ATE_hat SE_hat p_value
##   &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;
## 1 MLM      -2.12  0.968   0.186
## 2 LR       -2.12  0.492   0.145
## 3 Agg      -2.12  0.492   0.145</code></pre>
<p>Each method for analysis is a single line. We record estimated impact, estimated standard error, and a nominal p-value.
Note how the <code>bind_rows()</code> method can take naming on the fly, and give us a column of <code>method</code>, which will be very useful to keep track of what estimated what.
We intentionally wrap up our results with a data frame to make later processing of data with the tidyverse package much easier.</p>
</div>
<div id="the-simulation" class="section level2 hasAnchor" number="11.5">
<h2><span class="header-section-number">11.5</span> The simulation<a href="case_cluster.html#the-simulation" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>So we have our two steps, and the next step of our simulation is to rerun them both a bunch of times.
Always start with a single scenario to figure out if your code is working and if your intuition is working.</p>
<div class="sourceCode" id="cb224"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb224-1"><a href="case_cluster.html#cb224-1" aria-hidden="true" tabindex="-1"></a>ATE <span class="ot">&lt;-</span> <span class="fl">0.30</span></span>
<span id="cb224-2"><a href="case_cluster.html#cb224-2" aria-hidden="true" tabindex="-1"></a>R <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb224-3"><a href="case_cluster.html#cb224-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb224-4"><a href="case_cluster.html#cb224-4" aria-hidden="true" tabindex="-1"></a>one_run <span class="ot">&lt;-</span> <span class="cf">function</span>( ATE ) {</span>
<span id="cb224-5"><a href="case_cluster.html#cb224-5" aria-hidden="true" tabindex="-1"></a>      dat <span class="ot">&lt;-</span> <span class="fu">gen_dat_model</span>( <span class="at">n_bar =</span> <span class="dv">200</span>, <span class="at">J=</span><span class="dv">30</span>, </span>
<span id="cb224-6"><a href="case_cluster.html#cb224-6" aria-hidden="true" tabindex="-1"></a>                          <span class="at">gamma_1 =</span> ATE, <span class="at">gamma_2 =</span> <span class="fl">0.5</span>,</span>
<span id="cb224-7"><a href="case_cluster.html#cb224-7" aria-hidden="true" tabindex="-1"></a>                          <span class="at">sigma2_u =</span> <span class="fl">0.20</span>, <span class="at">sigma2_e =</span> <span class="fl">0.80</span>,</span>
<span id="cb224-8"><a href="case_cluster.html#cb224-8" aria-hidden="true" tabindex="-1"></a>                          <span class="at">alpha =</span> <span class="fl">0.75</span> )</span>
<span id="cb224-9"><a href="case_cluster.html#cb224-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">analyze_data</span>(dat)  </span>
<span id="cb224-10"><a href="case_cluster.html#cb224-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb224-11"><a href="case_cluster.html#cb224-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb224-12"><a href="case_cluster.html#cb224-12" aria-hidden="true" tabindex="-1"></a>tictoc<span class="sc">::</span><span class="fu">tic</span>()  <span class="co"># Start the clock!</span></span>
<span id="cb224-13"><a href="case_cluster.html#cb224-13" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>( <span class="dv">40404</span> )</span>
<span id="cb224-14"><a href="case_cluster.html#cb224-14" aria-hidden="true" tabindex="-1"></a>runs <span class="ot">&lt;-</span> </span>
<span id="cb224-15"><a href="case_cluster.html#cb224-15" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">rerun</span>( R, <span class="fu">one_run</span>( ATE ) ) <span class="sc">%&gt;%</span></span>
<span id="cb224-16"><a href="case_cluster.html#cb224-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>( <span class="at">.id=</span><span class="st">&quot;runID&quot;</span> )</span>
<span id="cb224-17"><a href="case_cluster.html#cb224-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb224-18"><a href="case_cluster.html#cb224-18" aria-hidden="true" tabindex="-1"></a>tictoc<span class="sc">::</span><span class="fu">toc</span>()</span></code></pre></div>
<pre><code>## 365.94 sec elapsed</code></pre>
<p>We have the individual results of all our methods applied to each generated dataset.</p>
</div>
<div id="analysis-of-our-single-scenario" class="section level2 hasAnchor" number="11.6">
<h2><span class="header-section-number">11.6</span> Analysis of our single scenario<a href="case_cluster.html#analysis-of-our-single-scenario" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>For our single scenario, we can now evaluate how well the estimators did.
In particular we have these primary questions:</p>
<ul>
<li>Is it biased? (bias)</li>
<li>Is it precise? (standard error)</li>
<li>Does it predict well? (RMSE)</li>
<li>Can we estimate uncertainty well? (i.e., are our estimated SEs about right?)</li>
</ul>
<p>We systematically go through answering these questions for our initial scenario.</p>
<div id="are-the-estimators-biased" class="section level3 hasAnchor" number="11.6.1">
<h3><span class="header-section-number">11.6.1</span> Are the estimators biased?<a href="case_cluster.html#are-the-estimators-biased" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Bias is with respect to a target estimand.
Here we assess whether our estimates are systematically different from the parameter we used to generate the data (this is the ATE parameter).
We also calculate the MCSE for the bias using a simple sampling formula.</p>
<div class="sourceCode" id="cb226"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb226-1"><a href="case_cluster.html#cb226-1" aria-hidden="true" tabindex="-1"></a>runs <span class="sc">%&gt;%</span> </span>
<span id="cb226-2"><a href="case_cluster.html#cb226-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>( method ) <span class="sc">%&gt;%</span></span>
<span id="cb226-3"><a href="case_cluster.html#cb226-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>( </span>
<span id="cb226-4"><a href="case_cluster.html#cb226-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_ATE_hat =</span> <span class="fu">mean</span>( ATE_hat ),</span>
<span id="cb226-5"><a href="case_cluster.html#cb226-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">bias =</span> <span class="fu">mean</span>( ATE_hat <span class="sc">-</span> ATE ),</span>
<span id="cb226-6"><a href="case_cluster.html#cb226-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">SE_bias =</span> <span class="fu">sd</span>( ATE_hat <span class="sc">-</span> ATE ) <span class="sc">/</span> <span class="fu">sqrt</span>(R)</span>
<span id="cb226-7"><a href="case_cluster.html#cb226-7" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<pre><code>## # A tibble: 3 × 4
##   method mean_ATE_hat    bias SE_bias
##   &lt;chr&gt;         &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
## 1 Agg           0.306 0.00561 0.00531
## 2 LR            0.390 0.0899  0.00580
## 3 MLM           0.308 0.00788 0.00531</code></pre>
<p>Linear regression is biased. There is no evidence of bias for Agg or MLM.
This is because the linear regression is targeting the person-average average treatment effect.
Our data generating process makes larger sites have larger effects, so the person average is going to be higher since those larger sites will count more.
The Agg and MLM methods, by contrast, estimate the site-average effect; this is in line with our DGP.</p>
</div>
<div id="which-method-has-the-smallest-standard-error" class="section level3 hasAnchor" number="11.6.2">
<h3><span class="header-section-number">11.6.2</span> Which method has the smallest standard error?<a href="case_cluster.html#which-method-has-the-smallest-standard-error" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The true Standard Error is simply how variable the point estimates are, i.e., the standard deviation of the point estimates for a given estimator.
The standard error is a measure of how stable our estimates are across datasets that all came from the same data generating process.
We calculate the standard error, and also the relative standard error using linear regression as a baseline:</p>
<div class="sourceCode" id="cb228"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb228-1"><a href="case_cluster.html#cb228-1" aria-hidden="true" tabindex="-1"></a>true_SE <span class="ot">&lt;-</span> runs <span class="sc">%&gt;%</span> </span>
<span id="cb228-2"><a href="case_cluster.html#cb228-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>( method ) <span class="sc">%&gt;%</span></span>
<span id="cb228-3"><a href="case_cluster.html#cb228-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>( </span>
<span id="cb228-4"><a href="case_cluster.html#cb228-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">SE =</span> <span class="fu">sd</span>( ATE_hat )</span>
<span id="cb228-5"><a href="case_cluster.html#cb228-5" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb228-6"><a href="case_cluster.html#cb228-6" aria-hidden="true" tabindex="-1"></a>true_SE <span class="sc">%&gt;%</span></span>
<span id="cb228-7"><a href="case_cluster.html#cb228-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>( <span class="at">per_SE =</span> SE <span class="sc">/</span> SE[method<span class="sc">==</span><span class="st">&quot;LR&quot;</span>] )</span></code></pre></div>
<pre><code>## # A tibble: 3 × 3
##   method    SE per_SE
##   &lt;chr&gt;  &lt;dbl&gt;  &lt;dbl&gt;
## 1 Agg    0.168  0.916
## 2 LR     0.183  1    
## 3 MLM    0.168  0.916</code></pre>
<p>The other methods appear to have SEs about 8% smaller than Linear Regression</p>
</div>
<div id="which-method-has-the-smallest-root-mean-squared-error" class="section level3 hasAnchor" number="11.6.3">
<h3><span class="header-section-number">11.6.3</span> Which method has the smallest Root Mean Squared Error?<a href="case_cluster.html#which-method-has-the-smallest-root-mean-squared-error" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>So far linear regression is not doing well: it has bias and it also has a larger standard error than the other two.
We can assess overall performance by combining these two quantities with the RMSE:</p>
<div class="sourceCode" id="cb230"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb230-1"><a href="case_cluster.html#cb230-1" aria-hidden="true" tabindex="-1"></a>runs <span class="sc">%&gt;%</span> </span>
<span id="cb230-2"><a href="case_cluster.html#cb230-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>( method ) <span class="sc">%&gt;%</span></span>
<span id="cb230-3"><a href="case_cluster.html#cb230-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>( </span>
<span id="cb230-4"><a href="case_cluster.html#cb230-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">RMSE =</span> <span class="fu">sqrt</span>( <span class="fu">mean</span>( (ATE_hat <span class="sc">-</span> ATE)<span class="sc">^</span><span class="dv">2</span> ) )</span>
<span id="cb230-5"><a href="case_cluster.html#cb230-5" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<pre><code>## # A tibble: 3 × 2
##   method  RMSE
##   &lt;chr&gt;  &lt;dbl&gt;
## 1 Agg    0.168
## 2 LR     0.204
## 3 MLM    0.168</code></pre>
<p>RMSE is a way of taking both bias and variance into account, all at once.
Here, LR’s bias plus increased variability is giving it a higher RMSE.
For Agg and MLM, the RMSE is basically the standard error; this makes sense as they are not biased.
For LR we see a slight bump to the RMSE, but clearly the standard error dominates the bias term.
This is especially the case as RMSE is the square root of the bias and standard errors <em>squared</em>; this makes difference between them even more extreme.</p>
</div>
<div id="do-the-methods-have-correctly-estimated-standard-errors" class="section level3 hasAnchor" number="11.6.4">
<h3><span class="header-section-number">11.6.4</span> Do the methods have correctly estimated standard errors?<a href="case_cluster.html#do-the-methods-have-correctly-estimated-standard-errors" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>To assess this, we can look at the average <em>estimated</em> (squared) standard error and compare it to the true standard error.
Our standard errors are <em>inflated</em> if they are systematically larger than they should be, across the simulation runs.
We can also look at how stable our standard error estimates are, by taking the standard deviation of our standard error estimates.</p>
<div class="sourceCode" id="cb232"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb232-1"><a href="case_cluster.html#cb232-1" aria-hidden="true" tabindex="-1"></a>runs <span class="sc">%&gt;%</span>  <span class="fu">group_by</span>( method ) <span class="sc">%&gt;%</span></span>
<span id="cb232-2"><a href="case_cluster.html#cb232-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>( </span>
<span id="cb232-3"><a href="case_cluster.html#cb232-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">SE =</span> <span class="fu">sd</span>( ATE_hat ),</span>
<span id="cb232-4"><a href="case_cluster.html#cb232-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_SE_hat =</span> <span class="fu">sqrt</span>( <span class="fu">mean</span>( SE_hat<span class="sc">^</span><span class="dv">2</span> ) ),</span>
<span id="cb232-5"><a href="case_cluster.html#cb232-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">infl =</span> <span class="dv">100</span> <span class="sc">*</span> mean_SE_hat <span class="sc">/</span> SE,</span>
<span id="cb232-6"><a href="case_cluster.html#cb232-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd_SE_hat =</span> <span class="fu">sd</span>( SE_hat ),</span>
<span id="cb232-7"><a href="case_cluster.html#cb232-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">stability =</span> <span class="dv">100</span> <span class="sc">*</span> sd_SE_hat <span class="sc">/</span> SE )</span></code></pre></div>
<pre><code>## # A tibble: 3 × 6
##   method    SE mean_SE_hat  infl sd_SE_hat stability
##   &lt;chr&gt;  &lt;dbl&gt;       &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
## 1 Agg    0.168       0.174  104.    0.0232      13.8
## 2 LR     0.183       0.185  101.    0.0309      16.8
## 3 MLM    0.168       0.174  104.    0.0232      13.8</code></pre>
<p>All of the SEs appear to be a bit conservative on average. (3 or 4 percentage points too big).</p>
<p>The stability of the SE-hats is also of interest.
The last column shows how variable the standard error estimates are relative to the true standard error.
50% would mean the standard error estimates can easily be off by 50% of the truth, which is not particularly good.</p>
</div>
<div id="did-we-have-enough-simulation-trials" class="section level3 hasAnchor" number="11.6.5">
<h3><span class="header-section-number">11.6.5</span> Did we have enough simulation trials?<a href="case_cluster.html#did-we-have-enough-simulation-trials" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Finally, we can check our MCSEs for our performance measures to see if we have enough runs to believe these differences:</p>
<div class="sourceCode" id="cb234"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb234-1"><a href="case_cluster.html#cb234-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>( simhelpers )</span>
<span id="cb234-2"><a href="case_cluster.html#cb234-2" aria-hidden="true" tabindex="-1"></a>runs<span class="sc">$</span>ATE <span class="ot">=</span> ATE</span>
<span id="cb234-3"><a href="case_cluster.html#cb234-3" aria-hidden="true" tabindex="-1"></a>runs <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(method) <span class="sc">%&gt;%</span></span>
<span id="cb234-4"><a href="case_cluster.html#cb234-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_modify</span>(</span>
<span id="cb234-5"><a href="case_cluster.html#cb234-5" aria-hidden="true" tabindex="-1"></a>      <span class="sc">~</span> <span class="fu">calc_absolute</span>( ., <span class="at">estimates =</span> ATE_hat, <span class="at">true_param =</span> ATE,</span>
<span id="cb234-6"><a href="case_cluster.html#cb234-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">perfm_criteria =</span> <span class="fu">c</span>(<span class="st">&quot;bias&quot;</span>,<span class="st">&quot;rmse&quot;</span>)) )</span></code></pre></div>
<pre><code>## # A tibble: 3 × 6
## # Groups:   method [3]
##   method     K    bias bias_mcse  rmse rmse_mcse
##   &lt;chr&gt;  &lt;int&gt;   &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;
## 1 Agg     1000 0.00561   0.00531 0.168   0.00461
## 2 LR      1000 0.0899    0.00580 0.204   0.00520
## 3 MLM     1000 0.00788   0.00531 0.168   0.00461</code></pre>
<p>We see the MCSEs are small relative to the linear regression bias term and the RMSEs: we simulated enough runs to see these gross trneds.</p>
</div>
</div>
<div id="extending-to-a-multifactor-simulation" class="section level2 hasAnchor" number="11.7">
<h2><span class="header-section-number">11.7</span> Extending to a multifactor simulation<a href="case_cluster.html#extending-to-a-multifactor-simulation" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>So far, our case study illustrates how multisite simulation (or any simulation) can be constructed by using a model as a recipe for data generation.
We have also reinforced our basic message that making functions to wrap parts of simulation substantially eases code construction.
But we only investigated a single scenario.
How do our findings generalize? When are the different methods differently appropriate?
To answer this, we need to extend to a multifactor simulation to systematically explore trends across contexts for our three estimators.
We begin by identifying some questions we might have given our preliminary results.</p>
<p>Regarding bias, in our initial simulation, we noticed that Linear Regression is estimating a person-weighted quantity, and so would be considered biased for the site-average ATE.
We might next ask, how much does bias change if we change the site-size by impact relationship?</p>
<p>For precision, we also saw that Linear Regression has a higher standard error.
But is this a general finding? When does this occur?
Are there contexts where linear regression will do better than the others?
Originally we thought aggregation would lose information becuase little sites will have the same weight as big sites, but be more imprecisely estimated.
Were we wrong? Or perhaps if site size was even more variable, Agg might do worse and worse.</p>
<p>Finally, the estimated SEs all appeared to be good, although they were rather variable, relative to the true SE.
We might then ask, is this always the case? Will the estimated SEs fall apart (e.g., be way too large or way too small, in general) in different contexts?</p>
<p>To answer these questions we need to more systematically explore the space of models. But we have a lot of knobs to turn.
In our simulation, we can generate fake cluster randomized data with the following features:</p>
<ul>
<li><p>The treatment impact of the site can vary, and vary with the site size</p></li>
<li><p>We can have sites of different sizes if we want</p></li>
<li><p>We can also vary:</p>
<ul>
<li>the site intercept variance</li>
<li>the residual variance,</li>
<li>the treatment impact</li>
<li>the site size</li>
<li>the number of sites, …</li>
</ul></li>
</ul>
<p>We cannot easily vary all of these.
We instead reflect on our research questions, speculate as to what is likely to matter, and then consider varying the following:</p>
<ul>
<li>Average site size: Does the number of students/site matter?</li>
<li>Number of sites: Do cluster-robust SEs work with fewer sites?</li>
<li>Variation in site size: Varying site sizes cause bias or break things?</li>
<li>Correlation of site size and site impact: Will correlation cause bias?</li>
<li>Cross site variation: Does the amount of site variation matter?</li>
</ul>
<p>Even so, we have a problem: How do we index cross site variation?
If we simply add more cross site variation, our total variation will increase.
If methods deteriorate, we then have a confound: is it the cross site variation causing the problem, or is it the total variation?
We therefore want to vary site variation while controlling total variation.</p>
<p>In extending our simulation we will also come across all sorts of concerns such as how to handle convergence issues in the modeling.
We also need to think about how to deal with nuisance factors and how to summarize complex simulations.
Finally, how do we choose appropriate factors and not become beholden to the parameters in our model?</p>
</div>
<div id="standardization-in-a-data-generating-process" class="section level2 hasAnchor" number="11.8">
<h2><span class="header-section-number">11.8</span> Standardization in a data generating process<a href="case_cluster.html#standardization-in-a-data-generating-process" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Given our model, we can generate data by specifying our parameters and variables of <span class="math inline">\(\gamma_{0}, \gamma_{1}, \gamma_{2}, \sigma^2_\epsilon, \sigma^2_u, \bar{n}, \alpha, J, p\)</span>.</p>
<p>Now, as discussed above, we want to manipulate within vs. between variation. If we just add more between variation (increase <span class="math inline">\(\sigma^2_u\)</span>), our overall variation of <span class="math inline">\(Y\)</span> will increase.
This will make it hard to think about, e.g., power, since we have confounded within vs. between variation with overall variation (which is itself bad for power).
It also impacts interpretation of coefficients. A treatment effect of 0.2 on our outcome scale is “smaller” if there is more overall variation.</p>
<p>To handle this we first (1) Standardize our data and then (2) reparameterize, so we have human-selected parameters that we can interpret that we then <em>translate</em> to our list of data generation parameters.
This allows us to, for exmaple, operate in standard quantities such as effect size units.
It also allows us ot index our DGP with more interpretable parameters such as the Intra-Class Correlation (ICC).</p>
<p>Our model is
<span class="math display">\[ Y_{ij} = \gamma_{0} + \gamma_{1} Z_j + \gamma_2 Z_j \left(\frac{n_j - \bar{n}}{\bar{n}} \right)  + u_j + \epsilon_{ij}  \]</span></p>
<p>The variance of our control-side outcomes is
<span class="math display">\[
\begin{aligned}
var( Y_{ij}(0) ) &amp;= var( \beta_{0j} + \epsilon_{ij} ) \\
&amp;= var( \gamma_{0} + \gamma_{1} Z_j + \gamma_{2}Z_j \tilde{n}_j + u_j + \epsilon_{ij} ) \\
&amp;= \sigma^2_u + \sigma^2_\epsilon
\end{aligned}
\]</span>
The effect size of an impact is defined as the impact over the control-side standard deviation.
(Sometimes people use the pooled standard deviation, but this is usually a bad choice if one suspects treatment variation. More treatment variation should not reduce the effect size for the same absolute average impact.)</p>
<p><span class="math display">\[ ES = \frac{\gamma_1}{SD( Y | Z_j = 0 )} = \frac{\gamma_1}{\sqrt{ \sigma^2_u + \sigma^2_\epsilon } } \]</span></p>
<p>The way we think about how “big” <span class="math inline">\(\gamma_1\)</span> is depends on how much site variation and residual variation there is.
But it is also easier to detect effects when the residual variation is small.
Effect sizes “standardize out” these sorts of tensions. We can use that.</p>
<p>In particular, we will use the Intraclass Correlation Coeffiicent (ICC), defined as
<span class="math display">\[ ICC = \frac{ \sigma^2_u }{ \sigma^2_\epsilon + \sigma^2_u } . \]</span>
The ICC is a measure of within vs. between variation.</p>
<p>What we then do is first standardized our data, meaning we ensure the control side variance equals 1.
Using the above, this means <span class="math inline">\(\sigma^2_u + \sigma^2_\epsilon = 1\)</span>.
It also gives us <span class="math inline">\(ICC = \sigma^2_u\)</span>, and <span class="math inline">\(\sigma^2_\epsilon = 1 - ICC\)</span>.</p>
<p>Our two model parameters are now tied together by our single ICC tuning parameter.
The core idea is we can now manipulate the aspects of the DGP we want while holding other aspects of the DGP constant.
Given our standardized scale, we have dropped a parameter from our set we might want to vary, and ensured varying the other parameter (now the ICC) is varying only one aspect of the DGP, not both.
Before, increasing <span class="math inline">\(\sigma^2_u\)</span> had two consequences: total variation and relative amount of variation at the school level.
Manipulating ICC only does the latter.</p>
<p>Our revised code is then, at the simulation driver level:</p>
<div class="sourceCode" id="cb236"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb236-1"><a href="case_cluster.html#cb236-1" aria-hidden="true" tabindex="-1"></a>run_CRT_sim <span class="ot">&lt;-</span> <span class="cf">function</span>(reps, </span>
<span id="cb236-2"><a href="case_cluster.html#cb236-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">n_bar =</span> <span class="dv">10</span>, <span class="at">J =</span> <span class="dv">30</span>, <span class="at">p =</span> <span class="fl">0.5</span>,</span>
<span id="cb236-3"><a href="case_cluster.html#cb236-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">ATE =</span> <span class="dv">0</span>, <span class="at">ICC =</span> <span class="fl">0.4</span>,</span>
<span id="cb236-4"><a href="case_cluster.html#cb236-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">size_coef =</span> <span class="dv">0</span>, <span class="at">alpha =</span> <span class="dv">0</span>,</span>
<span id="cb236-5"><a href="case_cluster.html#cb236-5" aria-hidden="true" tabindex="-1"></a>                        <span class="at">seed =</span> <span class="cn">NULL</span>, <span class="at">aggregate =</span> <span class="cn">TRUE</span>) {</span>
<span id="cb236-6"><a href="case_cluster.html#cb236-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-7"><a href="case_cluster.html#cb236-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>( ICC <span class="sc">&gt;=</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> ICC <span class="sc">&lt;</span> <span class="dv">1</span> )</span>
<span id="cb236-8"><a href="case_cluster.html#cb236-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb236-9"><a href="case_cluster.html#cb236-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scat</span>( <span class="st">&quot;Running n=%d, J=%d, ICC=%.2f, ATE=%.2f (%d replicates)</span><span class="sc">\n</span><span class="st">&quot;</span>, n_bar, J, ICC, ATE, reps)</span>
<span id="cb236-10"><a href="case_cluster.html#cb236-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-11"><a href="case_cluster.html#cb236-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(seed)) <span class="fu">set.seed</span>(seed)</span>
<span id="cb236-12"><a href="case_cluster.html#cb236-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-13"><a href="case_cluster.html#cb236-13" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> </span>
<span id="cb236-14"><a href="case_cluster.html#cb236-14" aria-hidden="true" tabindex="-1"></a>    purrr<span class="sc">::</span><span class="fu">rerun</span>( reps, {</span>
<span id="cb236-15"><a href="case_cluster.html#cb236-15" aria-hidden="true" tabindex="-1"></a>      dat <span class="ot">&lt;-</span> <span class="fu">gen_dat_model</span>( <span class="at">n_bar =</span> n_bar, <span class="at">J =</span> J, <span class="at">p =</span> p,</span>
<span id="cb236-16"><a href="case_cluster.html#cb236-16" aria-hidden="true" tabindex="-1"></a>                            <span class="at">gamma_0 =</span> <span class="dv">0</span>, <span class="at">gamma_1 =</span> ATE, <span class="at">gamma_2 =</span> size_coef,</span>
<span id="cb236-17"><a href="case_cluster.html#cb236-17" aria-hidden="true" tabindex="-1"></a>                            <span class="at">sigma2_u =</span> ICC, <span class="at">sigma2_e =</span> <span class="dv">1</span> <span class="sc">-</span> ICC,</span>
<span id="cb236-18"><a href="case_cluster.html#cb236-18" aria-hidden="true" tabindex="-1"></a>                            <span class="at">alpha =</span> alpha )</span>
<span id="cb236-19"><a href="case_cluster.html#cb236-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">analyze_data</span>(dat)</span>
<span id="cb236-20"><a href="case_cluster.html#cb236-20" aria-hidden="true" tabindex="-1"></a>    }) <span class="sc">%&gt;%</span></span>
<span id="cb236-21"><a href="case_cluster.html#cb236-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>( <span class="at">.id=</span><span class="st">&quot;runID&quot;</span> )</span>
<span id="cb236-22"><a href="case_cluster.html#cb236-22" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Note the <code>stopifnot</code>: it is wise to ensure our parameter transforms are all reasonable, so we don’t get unexplained errors or strange results.</p>
<p>Also note how we are transforming our ICC parameter into specific other parameters to maintain our effect size interpretation of our
simulation.
We don’t need to modify the <code>gen_dat_model</code> method: we are just specifying the constellation of parameters as a function of the parameters we want to directly control in the simulation.</p>
</div>
<div id="making-analyze_data-quiet" class="section level2 hasAnchor" number="11.9">
<h2><span class="header-section-number">11.9</span> Making analyze_data() quiet<a href="case_cluster.html#making-analyze_data-quiet" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>If we run our simulation when there is little cluster variation, we start getting a lot of warnings from our MLM estimator:</p>
<p>When we scale up to our full simulations, these warnings can become a nuisance.
Furthermore, the <code>lmer</code> command can sometimes just fails (we believe there is some bug in the optimizer that fails if things are just perfectly wrong).
If this was on simulation run 944 out of 1000, we would lose everything!
To protect ourselves, we trap messages and warnings as so (see Chapter @(#safe_code) for more on this):</p>
<pre><code>quiet_lmer = quietly( lmer )
analyze_data &lt;- function( dat ) {
    
    # MLM
    dat &lt;- dat
    M1 &lt;- quiet_lmer( Yobs ~ 1 + Z + (1|sid), data=dat )
    message1 = ifelse( length( M1$message ) &gt; 0, 1, 0 )
    warning1 = ifelse( length( M1$warning ) &gt; 0, 1, 0 )

   ...

    # Compile our results
    tibble( 
      method = c( &quot;MLM&quot;, &quot;LR&quot;, &quot;Agg&quot; ),
      ATE_hat = c( est1, est2, est3 ),
      SE_hat = c( se1, se2, se3 ),
      p_value = c( pv1, pv2, pv3 ),
      message = c( message1, 0, 0 ),
      warning = c( warning1, 0, 0 )
    )</code></pre>
<p>We now get a note about the message regarding convergence saved in our results:</p>
<div class="sourceCode" id="cb238"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb238-1"><a href="case_cluster.html#cb238-1" aria-hidden="true" tabindex="-1"></a><span class="fu">analyze_data</span>(dat)</span></code></pre></div>
<pre><code>## # A tibble: 3 × 4
##   method ATE_hat SE_hat p_value
##   &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;
## 1 MLM      -2.12  0.968   0.186
## 2 LR       -2.12  0.492   0.145
## 3 Agg      -2.12  0.492   0.145</code></pre>
</div>
<div id="where-to-compute-performance-measures-inside-vs.-outside" class="section level2 hasAnchor" number="11.10">
<h2><span class="header-section-number">11.10</span> Where to compute performance measures: inside vs. outside?<a href="case_cluster.html#where-to-compute-performance-measures-inside-vs.-outside" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>INSIDE (aggregate as you simulate):
For each scenario we get a tidy result of our performance measures
Less data to store, easier to compartmentalize
No ability to add new performance measures on the fly</p>
<p>OUTSIDE (keep all simulation runs):
You can dynamically add or change how you calculate performance measures
End up with massive amounts of data to store and manipulate</p>
</div>
<div id="run-the-simulation" class="section level2 hasAnchor" number="11.11">
<h2><span class="header-section-number">11.11</span> Run the simulation<a href="case_cluster.html#run-the-simulation" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Running our simulation is the exact same code as we have used before.
Simulations take awhile to run so we save them so we can analyze at our leisure.
Here we are storing the individual runs, not the analyzed results!</p>
<div class="sourceCode" id="cb240"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb240-1"><a href="case_cluster.html#cb240-1" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> </span>
<span id="cb240-2"><a href="case_cluster.html#cb240-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cross_df</span>(design_factors) <span class="sc">%&gt;%</span></span>
<span id="cb240-3"><a href="case_cluster.html#cb240-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb240-4"><a href="case_cluster.html#cb240-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">reps =</span> <span class="dv">100</span>,</span>
<span id="cb240-5"><a href="case_cluster.html#cb240-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">20200320</span> <span class="sc">+</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()</span>
<span id="cb240-6"><a href="case_cluster.html#cb240-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb240-7"><a href="case_cluster.html#cb240-7" aria-hidden="true" tabindex="-1"></a>params<span class="sc">$</span>res <span class="ot">=</span> <span class="fu">pmap</span>(params, <span class="at">.f =</span> one_CRT_sim )</span>
<span id="cb240-8"><a href="case_cluster.html#cb240-8" aria-hidden="true" tabindex="-1"></a>res <span class="ot">=</span> params <span class="sc">%&gt;%</span> <span class="fu">unnest</span>( <span class="at">cols=</span><span class="fu">c</span>(data) )</span>
<span id="cb240-9"><a href="case_cluster.html#cb240-9" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>( res, <span class="at">file =</span> <span class="st">&quot;results/simulation_CRT.rds&quot;</span> )</span></code></pre></div>
</div>
<div id="analyzing-our-results" class="section level2 hasAnchor" number="11.12">
<h2><span class="header-section-number">11.12</span> Analyzing our results<a href="case_cluster.html#analyzing-our-results" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Now that we have run our simulation, we turn to our questions listed above, extending our initial findings from our initial scenario to assess trends across our simulation factors.</p>
<div id="checking-on-convergence-issues" class="section level3 hasAnchor" number="11.12.1">
<h3><span class="header-section-number">11.12.1</span> Checking on convergence issues<a href="case_cluster.html#checking-on-convergence-issues" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>First, we explore how often we get a convergence message:</p>
<div class="sourceCode" id="cb241"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb241-1"><a href="case_cluster.html#cb241-1" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">readRDS</span>( <span class="st">&quot;results/simulation_CRT.rds&quot;</span> )</span>
<span id="cb241-2"><a href="case_cluster.html#cb241-2" aria-hidden="true" tabindex="-1"></a>res <span class="sc">%&gt;%</span> </span>
<span id="cb241-3"><a href="case_cluster.html#cb241-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>( method, ICC ) <span class="sc">%&gt;%</span></span>
<span id="cb241-4"><a href="case_cluster.html#cb241-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>( <span class="at">message =</span> <span class="fu">mean</span>( message ) ) <span class="sc">%&gt;%</span></span>
<span id="cb241-5"><a href="case_cluster.html#cb241-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>( <span class="at">names_from =</span> <span class="st">&quot;method&quot;</span>, <span class="at">values_from=</span><span class="st">&quot;message&quot;</span> )</span></code></pre></div>
<pre><code>## # A tibble: 5 × 4
##     ICC   Agg    LR      MLM
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;
## 1   0       0     0 0.499   
## 2   0.2     0     0 0.0139  
## 3   0.4     0     0 0.00311 
## 4   0.6     0     0 0.00104 
## 5   0.8     0     0 0.000444</code></pre>
<p>We see that when the ICC is 0 we get a lot of convergence issues, but as soon as we pull away from 0 it drops off considerably.
At this point we might decide to drop those runs with a message or keep them.
In this case, we decide to keep (it shouldn’t matter much in any case except the ICC = 0 case).
We might eventually want to do a separate analysis of the ICC = 0 context to see if the MLM approach actually falls apart, or if it is just throwing error messages.</p>
</div>
<div id="calculating-standard-metrics" class="section level3 hasAnchor" number="11.12.2">
<h3><span class="header-section-number">11.12.2</span> Calculating standard metrics<a href="case_cluster.html#calculating-standard-metrics" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Once we have our individual runs for our difference scenarios, we group and calculate our performance metrics for each group.</p>
<div class="sourceCode" id="cb243"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb243-1"><a href="case_cluster.html#cb243-1" aria-hidden="true" tabindex="-1"></a>sres <span class="ot">&lt;-</span> </span>
<span id="cb243-2"><a href="case_cluster.html#cb243-2" aria-hidden="true" tabindex="-1"></a>  res <span class="sc">%&gt;%</span> </span>
<span id="cb243-3"><a href="case_cluster.html#cb243-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>( n_bar, J, ATE, size_coef, ICC, alpha, method ) <span class="sc">%&gt;%</span></span>
<span id="cb243-4"><a href="case_cluster.html#cb243-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>( </span>
<span id="cb243-5"><a href="case_cluster.html#cb243-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">bias =</span> <span class="fu">mean</span>(ATE_hat <span class="sc">-</span> ATE),</span>
<span id="cb243-6"><a href="case_cluster.html#cb243-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">SE =</span> <span class="fu">sd</span>( ATE_hat ),</span>
<span id="cb243-7"><a href="case_cluster.html#cb243-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">RMSE =</span> <span class="fu">sqrt</span>( <span class="fu">mean</span>( (ATE_hat <span class="sc">-</span> ATE )<span class="sc">^</span><span class="dv">2</span> ) ),</span>
<span id="cb243-8"><a href="case_cluster.html#cb243-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">ESE_hat =</span> <span class="fu">sqrt</span>( <span class="fu">mean</span>( SE_hat<span class="sc">^</span><span class="dv">2</span> ) ),</span>
<span id="cb243-9"><a href="case_cluster.html#cb243-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">SD_SE_hat =</span> <span class="fu">sqrt</span>( <span class="fu">sd</span>( SE_hat<span class="sc">^</span><span class="dv">2</span> ) ),</span>
<span id="cb243-10"><a href="case_cluster.html#cb243-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">power =</span> <span class="fu">mean</span>( p_value <span class="sc">&lt;=</span> <span class="fl">0.05</span> ),</span>
<span id="cb243-11"><a href="case_cluster.html#cb243-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">R =</span> <span class="fu">n</span>(),</span>
<span id="cb243-12"><a href="case_cluster.html#cb243-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span></span>
<span id="cb243-13"><a href="case_cluster.html#cb243-13" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
</div>
<div id="bias-analysis" class="section level3 hasAnchor" number="11.12.3">
<h3><span class="header-section-number">11.12.3</span> Bias analysis<a href="case_cluster.html#bias-analysis" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>As a first step to understanding bias, we might bundle our results by ICC.
In this code we are making groups of method by ICC level so we get side-by-side boxplots for each ICC level considered:</p>
<div class="sourceCode" id="cb244"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb244-1"><a href="case_cluster.html#cb244-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>( sres, <span class="fu">aes</span>( ICC, bias, <span class="at">col=</span>method, <span class="at">group=</span><span class="fu">paste0</span>(ICC,method) ) ) <span class="sc">+</span></span>
<span id="cb244-2"><a href="case_cluster.html#cb244-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>( alpha <span class="sc">~</span> size_coef, <span class="at">labeller =</span> label_both ) <span class="sc">+</span></span>
<span id="cb244-3"><a href="case_cluster.html#cb244-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">coef =</span> <span class="cn">Inf</span>) <span class="sc">+</span></span>
<span id="cb244-4"><a href="case_cluster.html#cb244-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>( <span class="at">yintercept =</span> <span class="dv">0</span> ) <span class="sc">+</span></span>
<span id="cb244-5"><a href="case_cluster.html#cb244-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb244-6"><a href="case_cluster.html#cb244-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>( <span class="at">breaks =</span> <span class="fu">unique</span>( sres<span class="sc">$</span>ICC) )</span></code></pre></div>
<p><img src="Designing-Simulations-in-R_files/figure-html/unnamed-chunk-117-1.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Each box is a collection of simulation trials. E.g., for <code>ICC = 0.6</code>, <code>size_coef = 0.2</code>, and <code>alpha = 0.8</code> we have 9 scenarios representing the varying level 1 and level 2 sample sizes:</p>
<div class="sourceCode" id="cb245"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb245-1"><a href="case_cluster.html#cb245-1" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>( sres, ICC <span class="sc">==</span> <span class="fl">0.6</span>, size_coef <span class="sc">==</span> <span class="fl">0.2</span>,</span>
<span id="cb245-2"><a href="case_cluster.html#cb245-2" aria-hidden="true" tabindex="-1"></a>        alpha <span class="sc">==</span> <span class="fl">0.8</span>, method<span class="sc">==</span><span class="st">&quot;Agg&quot;</span> ) <span class="sc">%&gt;%</span></span>
<span id="cb245-3"><a href="case_cluster.html#cb245-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>( n_bar<span class="sc">:</span>alpha, bias )</span></code></pre></div>
<pre><code>## # A tibble: 9 × 7
##   n_bar     J   ATE size_coef   ICC alpha     bias
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;
## 1    20     5   0.2       0.2   0.6   0.8 -0.00452
## 2    20    20   0.2       0.2   0.6   0.8 -0.0182 
## 3    20    80   0.2       0.2   0.6   0.8 -0.00921
## 4    80     5   0.2       0.2   0.6   0.8  0.119  
## 5    80    20   0.2       0.2   0.6   0.8  0.00210
## 6    80    80   0.2       0.2   0.6   0.8  0.00641
## 7   320     5   0.2       0.2   0.6   0.8 -0.00182
## 8   320    20   0.2       0.2   0.6   0.8 -0.00219
## 9   320    80   0.2       0.2   0.6   0.8  0.00632</code></pre>
<p>We are seeing a few outliers for some of the boxplots, suggesting that there are other factors driving bias. We could try bundling along different aspects to see:</p>
<div class="sourceCode" id="cb247"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb247-1"><a href="case_cluster.html#cb247-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>( sres, <span class="fu">aes</span>( <span class="fu">as.factor</span>(n_bar), bias, <span class="at">col=</span>method, <span class="at">group=</span><span class="fu">paste0</span>(n_bar,method) ) ) <span class="sc">+</span></span>
<span id="cb247-2"><a href="case_cluster.html#cb247-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>( alpha <span class="sc">~</span>  size_coef, <span class="at">labeller =</span> label_both ) <span class="sc">+</span></span>
<span id="cb247-3"><a href="case_cluster.html#cb247-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">coef =</span> <span class="cn">Inf</span>) <span class="sc">+</span></span>
<span id="cb247-4"><a href="case_cluster.html#cb247-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>( <span class="at">yintercept =</span> <span class="dv">0</span> ) <span class="sc">+</span></span>
<span id="cb247-5"><a href="case_cluster.html#cb247-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code></pre></div>
<p><img src="Designing-Simulations-in-R_files/figure-html/unnamed-chunk-119-1.png" width="75%" style="display: block; margin: auto;" /></p>
<p>No progress there. Perhaps it is instability or MCSE.</p>
<p>The boxplots are hard for seeing trends.
Instead of bundling, we can therefore aggregate:</p>
<div class="sourceCode" id="cb248"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb248-1"><a href="case_cluster.html#cb248-1" aria-hidden="true" tabindex="-1"></a>ssres <span class="ot">&lt;-</span> </span>
<span id="cb248-2"><a href="case_cluster.html#cb248-2" aria-hidden="true" tabindex="-1"></a>  sres <span class="sc">%&gt;%</span> </span>
<span id="cb248-3"><a href="case_cluster.html#cb248-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>( ICC, method, alpha, size_coef ) <span class="sc">%&gt;%</span></span>
<span id="cb248-4"><a href="case_cluster.html#cb248-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>( <span class="at">bias =</span> <span class="fu">mean</span>( bias ) )</span>
<span id="cb248-5"><a href="case_cluster.html#cb248-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-6"><a href="case_cluster.html#cb248-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>( ssres, <span class="fu">aes</span>( ICC, bias, <span class="at">col=</span>method ) ) <span class="sc">+</span></span>
<span id="cb248-7"><a href="case_cluster.html#cb248-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>( alpha <span class="sc">~</span>  size_coef, <span class="at">labeller =</span> label_both ) <span class="sc">+</span></span>
<span id="cb248-8"><a href="case_cluster.html#cb248-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="at">alpha=</span><span class="fl">0.75</span> ) <span class="sc">+</span> </span>
<span id="cb248-9"><a href="case_cluster.html#cb248-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>( <span class="at">alpha=</span><span class="fl">0.75</span> ) <span class="sc">+</span></span>
<span id="cb248-10"><a href="case_cluster.html#cb248-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>( <span class="at">yintercept =</span> <span class="dv">0</span> ) <span class="sc">+</span></span>
<span id="cb248-11"><a href="case_cluster.html#cb248-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code></pre></div>
<p><img src="Designing-Simulations-in-R_files/figure-html/unnamed-chunk-120-1.png" width="75%" style="display: block; margin: auto;" /></p>
<p>This shows that site variation leads to greater bias, but only if the coefficient for size is nonzero.
We also see that all the estimators must be the same if site variation is 0, with the overplotted lines on the top row of the figure.</p>
</div>
</div>
<div id="exercises-2" class="section level2 hasAnchor" number="11.13">
<h2><span class="header-section-number">11.13</span> Exercises<a href="case_cluster.html#exercises-2" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ol style="list-style-type: decimal">
<li><p>What is the variance of the outcomes generated by our model if there is no treatment effect? (Try simulating data to check!) What other quick checks can you make on your DGP to make sure it is working?</p></li>
<li><p>In gen_dat_model we have the following line of code to generate the number of individuals per site.</p></li>
</ol>
<div class="sourceCode" id="cb249"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb249-1"><a href="case_cluster.html#cb249-1" aria-hidden="true" tabindex="-1"></a>nj <span class="ot">&lt;-</span> <span class="fu">sample</span>( n_min<span class="sc">:</span>n_max, J, </span>
<span id="cb249-2"><a href="case_cluster.html#cb249-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">replace=</span><span class="cn">TRUE</span> )</span></code></pre></div>
<p>This code has an error. Generate a variety of datasets where you vary <code>n_min</code>, <code>n_max</code> and <code>J</code> to discover the error. Then repair the code.
Checking your data generating process across a range of scenarios is extremely important.</p>
<ol start="2" style="list-style-type: decimal">
<li><p>Extend the data generating process to include individual level covariates?</p></li>
<li><p>As foreground to the following chapters, can you explore multiple scenarios to see if the trends are common? First write a function that takes a set of parameters and runs the entire simulation and returns the results as a small dataframe.
Then use code like this to make a graph of some result measure as a function of a varying parameter (you pick which parameter you wish to vary):</p></li>
</ol>
<div class="sourceCode" id="cb250"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb250-1"><a href="case_cluster.html#cb250-1" aria-hidden="true" tabindex="-1"></a>vals <span class="ot">=</span> <span class="fu">seq</span>( start, stop, <span class="at">length.out =</span> <span class="dv">5</span> )</span>
<span id="cb250-2"><a href="case_cluster.html#cb250-2" aria-hidden="true" tabindex="-1"></a>res <span class="ot">=</span> <span class="fu">map_df</span>( vals, my_simulation_function, </span>
<span id="cb250-3"><a href="case_cluster.html#cb250-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">par1 =</span> val1, <span class="at">par2 =</span> val2, etc )</span></code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="functions.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="error-trapping-and-other-headaches.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/jepusto/Designing-Simulations-in-R/edit/master/047-case-study-clustered-data.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["Designing-Simulations-in-R.pdf", "Designing-Simulations-in-R.epub"],
"search": {
"engine": "lunr",
"options": null
},
"toc": {
"collapse": "section",
"scroll_highlight": true
},
"toolbar": {
"position": "fixed"
},
"info": true
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
