<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta property="og:title" content="6.6 Example: Simulating clustered data | Designing Monte Carlo Simulations in R" />
<meta property="og:type" content="book" />

<meta property="og:description" content="A text on designing, implementing, and reporting on Monte Carlo simulation studies" />
<meta name="github-repo" content="jepusto/Designing-Simulations-in-R" />

<meta name="author" content="Luke W. Miratrix and James E. Pustejovsky (Equal authors)" />

<meta name="date" content="2025-06-19" />

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<meta name="description" content="A text on designing, implementing, and reporting on Monte Carlo simulation studies">

<title>6.6 Example: Simulating clustered data | Designing Monte Carlo Simulations in R</title>

<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="libs/navigation-1.1/tabsets.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>


<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
/* show arrow before summary tag as in bootstrap
TODO: remove if bootstrap in updated in html_document (rmarkdown#1485) */
details > summary {
  display: list-item;
  cursor: pointer;
}
</style>
</head>

<body>

<div class="container-fluid main-container">


<div class="row">
<div class="col-sm-12">
<div id="TOC">
<ul>
<li class="has-sub"><a href="index.html#welcome" id="toc-welcome">Welcome</a>
<ul>
<li><a href="license.html#license" id="toc-license">License</a></li>
<li><a href="about-the-authors.html#about-the-authors" id="toc-about-the-authors">About the authors</a></li>
<li><a href="acknowledgements.html#acknowledgements" id="toc-acknowledgements">Acknowledgements</a></li>
</ul></li>
<li class="part"><span><b>I An Introductory Look</b></span></li>
<li class="has-sub"><a href="1-introduction.html#introduction" id="toc-introduction"><span class="toc-section-number">1</span> Introduction</a>
<ul>
<li class="has-sub"><a href="1.1-some-of-simulations-many-uses.html#some-of-simulations-many-uses" id="toc-some-of-simulations-many-uses"><span class="toc-section-number">1.1</span> Some of simulation’s many uses</a>
<ul>
<li><a href="1.1-some-of-simulations-many-uses.html#comparing-statistical-approaches" id="toc-comparing-statistical-approaches"><span class="toc-section-number">1.1.1</span> Comparing statistical approaches</a></li>
<li><a href="1.1-some-of-simulations-many-uses.html#assessing-performance-of-complex-pipelines" id="toc-assessing-performance-of-complex-pipelines"><span class="toc-section-number">1.1.2</span> Assessing performance of complex pipelines</a></li>
<li><a href="1.1-some-of-simulations-many-uses.html#assessing-performance-under-misspecification" id="toc-assessing-performance-under-misspecification"><span class="toc-section-number">1.1.3</span> Assessing performance under misspecification</a></li>
<li><a href="1.1-some-of-simulations-many-uses.html#assessing-the-finite-sample-performance-of-a-statistical-approach" id="toc-assessing-the-finite-sample-performance-of-a-statistical-approach"><span class="toc-section-number">1.1.4</span> Assessing the finite-sample performance of a statistical approach</a></li>
<li><a href="1.1-some-of-simulations-many-uses.html#conducting-power-analyses" id="toc-conducting-power-analyses"><span class="toc-section-number">1.1.5</span> Conducting Power Analyses</a></li>
<li><a href="1.1-some-of-simulations-many-uses.html#simulating-processess" id="toc-simulating-processess"><span class="toc-section-number">1.1.6</span> Simulating processess</a></li>
</ul></li>
<li><a href="1.2-the-perils-of-simulation-as-evidence.html#the-perils-of-simulation-as-evidence" id="toc-the-perils-of-simulation-as-evidence"><span class="toc-section-number">1.2</span> The perils of simulation as evidence</a></li>
<li><a href="1.3-simulating-to-learn.html#simulating-to-learn" id="toc-simulating-to-learn"><span class="toc-section-number">1.3</span> Simulating to learn</a></li>
<li><a href="1.4-why-r.html#why-r" id="toc-why-r"><span class="toc-section-number">1.4</span> Why R?</a></li>
<li><a href="1.5-organization-of-the-text.html#organization-of-the-text" id="toc-organization-of-the-text"><span class="toc-section-number">1.5</span> Organization of the text</a></li>
</ul></li>
<li class="has-sub"><a href="2-programming-preliminaries.html#programming-preliminaries" id="toc-programming-preliminaries"><span class="toc-section-number">2</span> Programming Preliminaries</a>
<ul>
<li><a href="2.1-welcome-to-the-tidyverse.html#welcome-to-the-tidyverse" id="toc-welcome-to-the-tidyverse"><span class="toc-section-number">2.1</span> Welcome to the tidyverse</a></li>
<li class="has-sub"><a href="2.2-functions.html#functions" id="toc-functions"><span class="toc-section-number">2.2</span> Functions</a>
<ul>
<li><a href="2.2-functions.html#rolling-your-own" id="toc-rolling-your-own"><span class="toc-section-number">2.2.1</span> Rolling your own</a></li>
<li><a href="2.2-functions.html#a-dangerous-function" id="toc-a-dangerous-function"><span class="toc-section-number">2.2.2</span> A dangerous function</a></li>
<li><a href="2.2-functions.html#using-named-arguments" id="toc-using-named-arguments"><span class="toc-section-number">2.2.3</span> Using Named Arguments</a></li>
<li><a href="2.2-functions.html#argument-defaults" id="toc-argument-defaults"><span class="toc-section-number">2.2.4</span> Argument Defaults</a></li>
<li><a href="2.2-functions.html#function-skeletons" id="toc-function-skeletons"><span class="toc-section-number">2.2.5</span> Function skeletons</a></li>
</ul></li>
<li><a href="2.3-pipe-dreams.html#pipe-dreams" id="toc-pipe-dreams"><span class="toc-section-number">2.3</span> <code>\&gt;</code> (Pipe) dreams</a></li>
<li><a href="2.4-recipes-versus-patterns.html#recipes-versus-patterns" id="toc-recipes-versus-patterns"><span class="toc-section-number">2.4</span> Recipes versus Patterns</a></li>
<li><a href="2.5-exercises.html#exercises" id="toc-exercises"><span class="toc-section-number">2.5</span> Exercises</a></li>
</ul></li>
<li class="has-sub"><a href="3-t-test-simulation.html#t-test-simulation" id="toc-t-test-simulation"><span class="toc-section-number">3</span> An initial simulation</a>
<ul>
<li><a href="3.1-simulating-a-single-scenario.html#simulating-a-single-scenario" id="toc-simulating-a-single-scenario"><span class="toc-section-number">3.1</span> Simulating a single scenario</a></li>
<li><a href="3.2-a-non-normal-population-distribution.html#a-non-normal-population-distribution" id="toc-a-non-normal-population-distribution"><span class="toc-section-number">3.2</span> A non-normal population distribution</a></li>
<li><a href="3.3-simulating-across-different-scenarios.html#simulating-across-different-scenarios" id="toc-simulating-across-different-scenarios"><span class="toc-section-number">3.3</span> Simulating across different scenarios</a></li>
<li><a href="3.4-extending-the-simulation-design.html#extending-the-simulation-design" id="toc-extending-the-simulation-design"><span class="toc-section-number">3.4</span> Extending the simulation design</a></li>
<li><a href="3.5-exercises-1.html#exercises-1" id="toc-exercises-1"><span class="toc-section-number">3.5</span> Exercises</a></li>
</ul></li>
<li class="part"><span><b>II Structure and Mechanics of a Simulation Study</b></span></li>
<li class="has-sub"><a href="4-simulation-structure.html#simulation-structure" id="toc-simulation-structure"><span class="toc-section-number">4</span> Structure of a simulation study</a>
<ul>
<li><a href="4.1-general-structure-of-a-simulation.html#general-structure-of-a-simulation" id="toc-general-structure-of-a-simulation"><span class="toc-section-number">4.1</span> General structure of a simulation</a></li>
<li><a href="4.2-tidy-modular-simulations.html#tidy-modular-simulations" id="toc-tidy-modular-simulations"><span class="toc-section-number">4.2</span> Tidy, modular simulations</a></li>
<li class="has-sub"><a href="4.3-skeleton-of-a-simulation-study.html#skeleton-of-a-simulation-study" id="toc-skeleton-of-a-simulation-study"><span class="toc-section-number">4.3</span> Skeleton of a simulation study</a>
<ul>
<li><a href="4.3-skeleton-of-a-simulation-study.html#data-generating-process" id="toc-data-generating-process"><span class="toc-section-number">4.3.1</span> Data-Generating Process</a></li>
<li><a href="4.3-skeleton-of-a-simulation-study.html#data-analysis-procedure" id="toc-data-analysis-procedure"><span class="toc-section-number">4.3.2</span> Data Analysis Procedure</a></li>
<li><a href="4.3-skeleton-of-a-simulation-study.html#repetition" id="toc-repetition"><span class="toc-section-number">4.3.3</span> Repetition</a></li>
<li><a href="4.3-skeleton-of-a-simulation-study.html#performance-summaries" id="toc-performance-summaries"><span class="toc-section-number">4.3.4</span> Performance summaries</a></li>
<li><a href="4.3-skeleton-of-a-simulation-study.html#multifactor-simulations" id="toc-multifactor-simulations"><span class="toc-section-number">4.3.5</span> Multifactor simulations</a></li>
</ul></li>
<li><a href="4.4-exercises-2.html#exercises-2" id="toc-exercises-2"><span class="toc-section-number">4.4</span> Exercises</a></li>
</ul></li>
<li class="has-sub"><a href="5-case-ANOVA.html#case-ANOVA" id="toc-case-ANOVA"><span class="toc-section-number">5</span> Case Study: Heteroskedastic ANOVA</a>
<ul>
<li class="has-sub"><a href="5.1-case-anova-DGP.html#case-anova-DGP" id="toc-case-anova-DGP"><span class="toc-section-number">5.1</span> The data-generating model</a>
<ul>
<li><a href="5.1-case-anova-DGP.html#now-make-a-function" id="toc-now-make-a-function"><span class="toc-section-number">5.1.1</span> Now make a function</a></li>
<li><a href="5.1-case-anova-DGP.html#cautious-coding" id="toc-cautious-coding"><span class="toc-section-number">5.1.2</span> Cautious coding</a></li>
</ul></li>
<li><a href="5.2-the-hypothesis-testing-procedures.html#the-hypothesis-testing-procedures" id="toc-the-hypothesis-testing-procedures"><span class="toc-section-number">5.2</span> The hypothesis testing procedures</a></li>
<li><a href="5.3-running-the-simulation.html#running-the-simulation" id="toc-running-the-simulation"><span class="toc-section-number">5.3</span> Running the simulation</a></li>
<li><a href="5.4-summarizing-test-performance.html#summarizing-test-performance" id="toc-summarizing-test-performance"><span class="toc-section-number">5.4</span> Summarizing test performance</a></li>
<li><a href="5.5-exAnovaExercises.html#exAnovaExercises" id="toc-exAnovaExercises"><span class="toc-section-number">5.5</span> Exercises</a></li>
</ul></li>
<li class="has-sub"><a href="6-data-generating-processes.html#data-generating-processes" id="toc-data-generating-processes"><span class="toc-section-number">6</span> Data-generating processes</a>
<ul>
<li class="has-sub"><a href="6.1-DGP-examples.html#DGP-examples" id="toc-DGP-examples"><span class="toc-section-number">6.1</span> Examples</a>
<ul>
<li><a href="6.1-DGP-examples.html#ANOVA-example" id="toc-ANOVA-example"><span class="toc-section-number">6.1.1</span> Example 1: One-way analysis of variance</a></li>
<li><a href="6.1-DGP-examples.html#BVPois-example" id="toc-BVPois-example"><span class="toc-section-number">6.1.2</span> Example 2: Bivariate Poisson model</a></li>
<li><a href="6.1-DGP-examples.html#CRT-example" id="toc-CRT-example"><span class="toc-section-number">6.1.3</span> Example 3: Hierarchical linear model for a cluster-randomized trial</a></li>
</ul></li>
<li><a href="6.2-components-of-a-dgp.html#components-of-a-dgp" id="toc-components-of-a-dgp"><span class="toc-section-number">6.2</span> Components of a DGP</a></li>
<li><a href="6.3-DGP-functions.html#DGP-functions" id="toc-DGP-functions"><span class="toc-section-number">6.3</span> A statistical model is a recipe for data generation</a></li>
<li><a href="6.4-DGP-plotting.html#DGP-plotting" id="toc-DGP-plotting"><span class="toc-section-number">6.4</span> Plot the artificial data</a></li>
<li><a href="6.5-check-the-data-generating-function.html#check-the-data-generating-function" id="toc-check-the-data-generating-function"><span class="toc-section-number">6.5</span> Check the data-generating function</a></li>
<li class="has-sub"><a href="6.6-case-cluster.html#case-cluster" id="toc-case-cluster"><span class="toc-section-number">6.6</span> Example: Simulating clustered data</a>
<ul>
<li><a href="6.6-case-cluster.html#a-design-decision-what-do-we-want-to-manipulate" id="toc-a-design-decision-what-do-we-want-to-manipulate"><span class="toc-section-number">6.6.1</span> A design decision: What do we want to manipulate?</a></li>
<li><a href="6.6-case-cluster.html#a-model-for-a-cluster-rct" id="toc-a-model-for-a-cluster-rct"><span class="toc-section-number">6.6.2</span> A model for a cluster RCT</a></li>
<li><a href="6.6-case-cluster.html#from-equations-to-code" id="toc-from-equations-to-code"><span class="toc-section-number">6.6.3</span> From equations to code</a></li>
<li><a href="6.6-case-cluster.html#standardization-in-the-dgp" id="toc-standardization-in-the-dgp"><span class="toc-section-number">6.6.4</span> Standardization in the DGP</a></li>
</ul></li>
<li><a href="6.7-three-parameter-IRT.html#three-parameter-IRT" id="toc-three-parameter-IRT"><span class="toc-section-number">6.7</span> Sometimes a DGP is all you need</a></li>
<li><a href="6.8-more-to-explore.html#more-to-explore" id="toc-more-to-explore"><span class="toc-section-number">6.8</span> More to explore</a></li>
<li class="has-sub"><a href="6.9-exercises-3.html#exercises-3" id="toc-exercises-3"><span class="toc-section-number">6.9</span> Exercises</a>
<ul>
<li><a href="6.9-exercises-3.html#Welch-t-dgp" id="toc-Welch-t-dgp"><span class="toc-section-number">6.9.1</span> The Welch test on a shifted-and-scaled <span class="math inline">\(t\)</span> distribution</a></li>
<li><a href="6.9-exercises-3.html#plot-the-bivariate-poisson" id="toc-plot-the-bivariate-poisson"><span class="toc-section-number">6.9.2</span> Plot the bivariate Poisson</a></li>
<li><a href="6.9-exercises-3.html#BVP-check" id="toc-BVP-check"><span class="toc-section-number">6.9.3</span> Check the bivariate Poisson function</a></li>
<li><a href="6.9-exercises-3.html#BVP-error" id="toc-BVP-error"><span class="toc-section-number">6.9.4</span> Add error-catching to the bivariate Poisson function</a></li>
<li><a href="6.9-exercises-3.html#BVNB1" id="toc-BVNB1"><span class="toc-section-number">6.9.5</span> A bivariate negative binomial distribution</a></li>
<li><a href="6.9-exercises-3.html#BVNB2" id="toc-BVNB2"><span class="toc-section-number">6.9.6</span> Another bivariate negative binomial distribution</a></li>
<li><a href="6.9-exercises-3.html#cluster-RCT-plot" id="toc-cluster-RCT-plot"><span class="toc-section-number">6.9.7</span> Plot the data from a cluster-randomized trial</a></li>
<li><a href="6.9-exercises-3.html#cluster-RCT-checks" id="toc-cluster-RCT-checks"><span class="toc-section-number">6.9.8</span> Checking the Cluster RCT DGP</a></li>
<li><a href="6.9-exercises-3.html#cluster-RCT-heterogeneity" id="toc-cluster-RCT-heterogeneity"><span class="toc-section-number">6.9.9</span> More school-level variation</a></li>
<li><a href="6.9-exercises-3.html#cluster-RCT-baseline" id="toc-cluster-RCT-baseline"><span class="toc-section-number">6.9.10</span> Cluster-randomized trial with baseline predictors</a></li>
<li><a href="6.9-exercises-3.html#IRT-DGP-parameters" id="toc-IRT-DGP-parameters"><span class="toc-section-number">6.9.11</span> 3-parameter IRT datasets</a></li>
<li><a href="6.9-exercises-3.html#IRT-DGP-checking" id="toc-IRT-DGP-checking"><span class="toc-section-number">6.9.12</span> Check the 3-parameter IRT DGP</a></li>
<li><a href="6.9-exercises-3.html#IRT-DGP-breaking" id="toc-IRT-DGP-breaking"><span class="toc-section-number">6.9.13</span> Explore the 3-parameter IRT model</a></li>
<li><a href="6.9-exercises-3.html#meta-regression-DGP" id="toc-meta-regression-DGP"><span class="toc-section-number">6.9.14</span> Random effects meta-regression</a></li>
<li><a href="6.9-exercises-3.html#Vevea-Hedges-DGP" id="toc-Vevea-Hedges-DGP"><span class="toc-section-number">6.9.15</span> Meta-regression with selective reporting</a></li>
</ul></li>
</ul></li>
<li class="has-sub"><a href="7-data-analysis-procedures.html#data-analysis-procedures" id="toc-data-analysis-procedures"><span class="toc-section-number">7</span> Data analysis procedures</a>
<ul>
<li><a href="7.1-estimation-functions.html#estimation-functions" id="toc-estimation-functions"><span class="toc-section-number">7.1</span> Writing estimation functions</a></li>
<li><a href="7.2-multiple-estimation-procedures.html#multiple-estimation-procedures" id="toc-multiple-estimation-procedures"><span class="toc-section-number">7.2</span> Including Multiple Data Analysis Procedures</a></li>
<li class="has-sub"><a href="7.3-validating-an-estimation-function.html#validating-an-estimation-function" id="toc-validating-an-estimation-function"><span class="toc-section-number">7.3</span> Validating an Estimation Function</a>
<ul>
<li><a href="7.3-validating-an-estimation-function.html#checking-against-existing-implementations" id="toc-checking-against-existing-implementations"><span class="toc-section-number">7.3.1</span> Checking against existing implementations</a></li>
<li><a href="7.3-validating-an-estimation-function.html#checking-novel-procedures" id="toc-checking-novel-procedures"><span class="toc-section-number">7.3.2</span> Checking novel procedures</a></li>
<li><a href="7.3-validating-an-estimation-function.html#checking-with-simulations" id="toc-checking-with-simulations"><span class="toc-section-number">7.3.3</span> Checking with simulations</a></li>
</ul></li>
<li class="has-sub"><a href="7.4-handling-errors-warnings-and-other-hiccups.html#handling-errors-warnings-and-other-hiccups" id="toc-handling-errors-warnings-and-other-hiccups"><span class="toc-section-number">7.4</span> Handling errors, warnings, and other hiccups</a>
<ul>
<li><a href="7.4-handling-errors-warnings-and-other-hiccups.html#capturing-errors-and-warnings" id="toc-capturing-errors-and-warnings"><span class="toc-section-number">7.4.1</span> Capturing errors and warnings</a></li>
<li><a href="7.4-handling-errors-warnings-and-other-hiccups.html#adapting-for-errors" id="toc-adapting-for-errors"><span class="toc-section-number">7.4.2</span> Adapting estimation procedures for errors and warnings</a></li>
</ul></li>
<li class="has-sub"><a href="7.5-exercises-4.html#exercises-4" id="toc-exercises-4"><span class="toc-section-number">7.5</span> Exercises</a>
<ul>
<li><a href="7.5-exercises-4.html#BFFs-forever" id="toc-BFFs-forever"><span class="toc-section-number">7.5.1</span> More Heteroskedastic ANOVA</a></li>
<li><a href="7.5-exercises-4.html#contingent-testing" id="toc-contingent-testing"><span class="toc-section-number">7.5.2</span> Contingent testing</a></li>
<li><a href="7.5-exercises-4.html#cross-check-CRT-estimators" id="toc-cross-check-CRT-estimators"><span class="toc-section-number">7.5.3</span> Check the cluster-RCT functions</a></li>
<li><a href="7.5-exercises-4.html#CRT-ANCOVA-estimators" id="toc-CRT-ANCOVA-estimators"><span class="toc-section-number">7.5.4</span> Extending the cluster-RCT functions</a></li>
<li><a href="7.5-exercises-4.html#contingent-estimator-processing" id="toc-contingent-estimator-processing"><span class="toc-section-number">7.5.5</span> Contingent estimator processing</a></li>
<li><a href="7.5-exercises-4.html#IRT-3PL-estimation" id="toc-IRT-3PL-estimation"><span class="toc-section-number">7.5.6</span> Estimating 3-parameter item response theory models</a></li>
<li><a href="7.5-exercises-4.html#Vevea-Hedges-estimation" id="toc-Vevea-Hedges-estimation"><span class="toc-section-number">7.5.7</span> Meta-regression with selective reporting</a></li>
</ul></li>
</ul></li>
<li class="has-sub"><a href="8-running-the-simulation-process.html#running-the-simulation-process" id="toc-running-the-simulation-process"><span class="toc-section-number">8</span> Running the Simulation Process</a>
<ul>
<li><a href="8.1-writing-simulations-quick-with-the-simhelpers-package.html#writing-simulations-quick-with-the-simhelpers-package" id="toc-writing-simulations-quick-with-the-simhelpers-package"><span class="toc-section-number">8.1</span> Writing simulations quick with the simhelpers package</a></li>
<li><a href="8.2-adding-checks-and-balances.html#adding-checks-and-balances" id="toc-adding-checks-and-balances"><span class="toc-section-number">8.2</span> Adding Checks and Balances</a></li>
<li><a href="8.3-exercises-5.html#exercises-5" id="toc-exercises-5"><span class="toc-section-number">8.3</span> Exercises</a></li>
</ul></li>
<li class="has-sub"><a href="9-performance-criteria.html#performance-criteria" id="toc-performance-criteria"><span class="toc-section-number">9</span> Performance criteria</a>
<ul>
<li><a href="9.1-different-kinds-of-performance.html#different-kinds-of-performance" id="toc-different-kinds-of-performance"><span class="toc-section-number">9.1</span> Different kinds of performance</a></li>
<li class="has-sub"><a href="9.2-assessing-a-point-estimator.html#assessing-a-point-estimator" id="toc-assessing-a-point-estimator"><span class="toc-section-number">9.2</span> Assessing a Point Estimator</a>
<ul>
<li><a href="9.2-assessing-a-point-estimator.html#comparing-the-performances-of-the-cluster-rct-estimation-procedures" id="toc-comparing-the-performances-of-the-cluster-rct-estimation-procedures"><span class="toc-section-number">9.2.1</span> Comparing the Performances of the Cluster RCT Estimation Procedures</a></li>
<li><a href="9.2-assessing-a-point-estimator.html#estimands-not-represented-by-a-parameter" id="toc-estimands-not-represented-by-a-parameter"><span class="toc-section-number">9.2.2</span> Estimands Not Represented By a Parameter</a></li>
</ul></li>
<li class="has-sub"><a href="9.3-assessing-a-standard-error-estimator.html#assessing-a-standard-error-estimator" id="toc-assessing-a-standard-error-estimator"><span class="toc-section-number">9.3</span> Assessing a Standard Error Estimator</a>
<ul>
<li><a href="9.3-assessing-a-standard-error-estimator.html#why-not-assess-the-estimated-se-directly" id="toc-why-not-assess-the-estimated-se-directly"><span class="toc-section-number">9.3.1</span> Why Not Assess the Estimated SE directly?</a></li>
<li><a href="9.3-assessing-a-standard-error-estimator.html#assessing-ses-for-our-cluster-rct-simulation" id="toc-assessing-ses-for-our-cluster-rct-simulation"><span class="toc-section-number">9.3.2</span> Assessing SEs for Our Cluster RCT Simulation</a></li>
</ul></li>
<li class="has-sub"><a href="9.4-assessing-an-inferential-procedure-hypothesis-testing.html#assessing-an-inferential-procedure-hypothesis-testing" id="toc-assessing-an-inferential-procedure-hypothesis-testing"><span class="toc-section-number">9.4</span> Assessing an Inferential Procedure (Hypothesis Testing)</a>
<ul>
<li><a href="9.4-assessing-an-inferential-procedure-hypothesis-testing.html#validity" id="toc-validity"><span class="toc-section-number">9.4.1</span> Validity</a></li>
<li><a href="9.4-assessing-an-inferential-procedure-hypothesis-testing.html#power" id="toc-power"><span class="toc-section-number">9.4.2</span> Power</a></li>
<li><a href="9.4-assessing-an-inferential-procedure-hypothesis-testing.html#the-rejection-rate" id="toc-the-rejection-rate"><span class="toc-section-number">9.4.3</span> The Rejection Rate</a></li>
<li><a href="9.4-assessing-an-inferential-procedure-hypothesis-testing.html#inference-in-our-cluster-rct-simulation" id="toc-inference-in-our-cluster-rct-simulation"><span class="toc-section-number">9.4.4</span> Inference in our Cluster RCT Simulation</a></li>
</ul></li>
<li class="has-sub"><a href="9.5-assessing-confidence-intervals.html#assessing-confidence-intervals" id="toc-assessing-confidence-intervals"><span class="toc-section-number">9.5</span> Assessing Confidence Intervals</a>
<ul>
<li><a href="9.5-assessing-confidence-intervals.html#confidence-intervals-in-our-cluster-rct-example" id="toc-confidence-intervals-in-our-cluster-rct-example"><span class="toc-section-number">9.5.1</span> Confidence Intervals in our Cluster RCT Example</a></li>
</ul></li>
<li class="has-sub"><a href="9.6-additional-thoughts-on-measuring-performance.html#additional-thoughts-on-measuring-performance" id="toc-additional-thoughts-on-measuring-performance"><span class="toc-section-number">9.6</span> Additional Thoughts on Measuring Performance</a>
<ul>
<li><a href="9.6-additional-thoughts-on-measuring-performance.html#sec-relative-performance" id="toc-sec-relative-performance"><span class="toc-section-number">9.6.1</span> Selecting Relative vs. Absolute Criteria</a></li>
<li><a href="9.6-additional-thoughts-on-measuring-performance.html#robust-measures-of-performance" id="toc-robust-measures-of-performance"><span class="toc-section-number">9.6.2</span> Robust Measures of Performance</a></li>
<li><a href="9.6-additional-thoughts-on-measuring-performance.html#summary-of-peformance-measures" id="toc-summary-of-peformance-measures"><span class="toc-section-number">9.6.3</span> Summary of Peformance Measures</a></li>
</ul></li>
<li class="has-sub"><a href="9.7-uncertainty-in-performance-estimates-the-monte-carlo-standard-error.html#uncertainty-in-performance-estimates-the-monte-carlo-standard-error" id="toc-uncertainty-in-performance-estimates-the-monte-carlo-standard-error"><span class="toc-section-number">9.7</span> Uncertainty in Performance Estimates (the Monte Carlo Standard Error)</a>
<ul>
<li><a href="9.7-uncertainty-in-performance-estimates-the-monte-carlo-standard-error.html#mcse-for-relative-variance-estimators" id="toc-mcse-for-relative-variance-estimators"><span class="toc-section-number">9.7.1</span> MCSE for Relative Variance Estimators</a></li>
<li><a href="9.7-uncertainty-in-performance-estimates-the-monte-carlo-standard-error.html#calculating-mcses-with-the-simhelpers-package" id="toc-calculating-mcses-with-the-simhelpers-package"><span class="toc-section-number">9.7.2</span> Calculating MCSEs With the <code>simhelpers</code> Package</a></li>
<li><a href="9.7-uncertainty-in-performance-estimates-the-monte-carlo-standard-error.html#mcse-calculation-in-our-cluster-rct-example" id="toc-mcse-calculation-in-our-cluster-rct-example"><span class="toc-section-number">9.7.3</span> MCSE Calculation in our Cluster RCT Example</a></li>
</ul></li>
<li><a href="9.8-exercises-6.html#exercises-6" id="toc-exercises-6"><span class="toc-section-number">9.8</span> Exercises</a></li>
</ul></li>
<li class="has-sub"><a href="10-case_Cronbach.html#case_Cronbach" id="toc-case_Cronbach"><span class="toc-section-number">10</span> Project: Cronbach Alpha</a>
<ul>
<li><a href="10.1-background.html#background" id="toc-background"><span class="toc-section-number">10.1</span> Background</a></li>
<li><a href="10.2-getting-started.html#getting-started" id="toc-getting-started"><span class="toc-section-number">10.2</span> Getting started</a></li>
<li><a href="10.3-the-data-generating-function.html#the-data-generating-function" id="toc-the-data-generating-function"><span class="toc-section-number">10.3</span> The data-generating function</a></li>
<li class="has-sub"><a href="10.4-the-estimation-function.html#the-estimation-function" id="toc-the-estimation-function"><span class="toc-section-number">10.4</span> The estimation function</a>
<ul>
<li><a href="10.4-the-estimation-function.html#exercises-naive-confidence-intervals" id="toc-exercises-naive-confidence-intervals"><span class="toc-section-number">10.4.1</span> Exercises (Naive confidence intervals)</a></li>
</ul></li>
<li class="has-sub"><a href="10.5-estimator-performance.html#estimator-performance" id="toc-estimator-performance"><span class="toc-section-number">10.5</span> Estimator performance</a>
<ul>
<li><a href="10.5-estimator-performance.html#exercises-calculating-performance" id="toc-exercises-calculating-performance"><span class="toc-section-number">10.5.1</span> Exercises (Calculating Performance)</a></li>
</ul></li>
<li><a href="10.6-replication-and-the-simulation.html#replication-and-the-simulation" id="toc-replication-and-the-simulation"><span class="toc-section-number">10.6</span> Replication (and the simulation)</a></li>
<li><a href="10.7-extension-confidence-interval-coverage.html#extension-confidence-interval-coverage" id="toc-extension-confidence-interval-coverage"><span class="toc-section-number">10.7</span> Extension: Confidence interval coverage</a></li>
<li class="has-sub"><a href="10.8-a-taste-of-multiple-scenarios.html#a-taste-of-multiple-scenarios" id="toc-a-taste-of-multiple-scenarios"><span class="toc-section-number">10.8</span> A taste of multiple scenarios</a>
<ul>
<li><a href="10.8-a-taste-of-multiple-scenarios.html#exercises-7" id="toc-exercises-7"><span class="toc-section-number">10.8.1</span> Exercises</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>III Multifactor Simulations</b></span></li>
<li class="has-sub"><a href="11-exp-design.html#exp-design" id="toc-exp-design"><span class="toc-section-number">11</span> Designing the multifactor simulation experiment</a>
<ul>
<li class="has-sub"><a href="11.1-choosing-parameter-combinations.html#choosing-parameter-combinations" id="toc-choosing-parameter-combinations"><span class="toc-section-number">11.1</span> Choosing parameter combinations</a>
<ul>
<li><a href="11.1-choosing-parameter-combinations.html#choosing-parameters-for-the-clustered-rct" id="toc-choosing-parameters-for-the-clustered-rct"><span class="toc-section-number">11.1.1</span> Choosing parameters for the Clustered RCT</a></li>
</ul></li>
<li><a href="11.2-using-pmap-to-run-multifactor-simulations.html#using-pmap-to-run-multifactor-simulations" id="toc-using-pmap-to-run-multifactor-simulations"><span class="toc-section-number">11.2</span> Using pmap to run multifactor simulations</a></li>
<li class="has-sub"><a href="11.3-when-to-aggregate-results-across-multiple-simulations.html#when-to-aggregate-results-across-multiple-simulations" id="toc-when-to-aggregate-results-across-multiple-simulations"><span class="toc-section-number">11.3</span> When to aggregate results across multiple simulations</a>
<ul>
<li><a href="11.3-when-to-aggregate-results-across-multiple-simulations.html#aggregate-as-you-simulate-inside" id="toc-aggregate-as-you-simulate-inside"><span class="toc-section-number">11.3.1</span> Aggregate as you simulate (inside)</a></li>
<li><a href="11.3-when-to-aggregate-results-across-multiple-simulations.html#keep-all-simulation-runs-outside" id="toc-keep-all-simulation-runs-outside"><span class="toc-section-number">11.3.2</span> Keep all simulation runs (outside)</a></li>
<li><a href="11.3-when-to-aggregate-results-across-multiple-simulations.html#getting-raw-results-ready-for-analysis" id="toc-getting-raw-results-ready-for-analysis"><span class="toc-section-number">11.3.3</span> Getting raw results ready for analysis</a></li>
</ul></li>
<li class="has-sub"><a href="11.4-running-the-cluster-rct-multifactor-experiment.html#running-the-cluster-rct-multifactor-experiment" id="toc-running-the-cluster-rct-multifactor-experiment"><span class="toc-section-number">11.4</span> Running the Cluster RCT multifactor experiment</a>
<ul>
<li><a href="11.4-running-the-cluster-rct-multifactor-experiment.html#making-analyze_data-quiet" id="toc-making-analyze_data-quiet"><span class="toc-section-number">11.4.1</span> Making analyze_data() quiet</a></li>
</ul></li>
</ul></li>
<li class="has-sub"><a href="12-analyzing-the-multifactor-experiment.html#analyzing-the-multifactor-experiment" id="toc-analyzing-the-multifactor-experiment"><span class="toc-section-number">12</span> Analyzing the multifactor experiment</a>
<ul>
<li class="has-sub"><a href="12.1-ways-of-analyzing-simulation-results.html#ways-of-analyzing-simulation-results" id="toc-ways-of-analyzing-simulation-results"><span class="toc-section-number">12.1</span> Ways of analyzing simulation results</a>
<ul>
<li><a href="12.1-ways-of-analyzing-simulation-results.html#plot-everything-with-many-small-multiples" id="toc-plot-everything-with-many-small-multiples"><span class="toc-section-number">12.1.1</span> Plot everything with many small multiples</a></li>
<li><a href="12.1-ways-of-analyzing-simulation-results.html#bundling" id="toc-bundling"><span class="toc-section-number">12.1.2</span> Bundling</a></li>
<li><a href="12.1-ways-of-analyzing-simulation-results.html#aggregation" id="toc-aggregation"><span class="toc-section-number">12.1.3</span> Aggregation</a></li>
<li><a href="12.1-ways-of-analyzing-simulation-results.html#regression-summarization" id="toc-regression-summarization"><span class="toc-section-number">12.1.4</span> Regression Summarization</a></li>
<li><a href="12.1-ways-of-analyzing-simulation-results.html#focus-on-a-subset-kick-rest-to-supplement" id="toc-focus-on-a-subset-kick-rest-to-supplement"><span class="toc-section-number">12.1.5</span> Focus on a subset, kick rest to supplement</a></li>
</ul></li>
<li><a href="12.2-analyzing-results-when-some-trials-have-failed.html#analyzing-results-when-some-trials-have-failed" id="toc-analyzing-results-when-some-trials-have-failed"><span class="toc-section-number">12.2</span> Analyzing results when some trials have failed</a></li>
<li class="has-sub"><a href="12.3-case-study-power-for-a-randomized-trial.html#case-study-power-for-a-randomized-trial" id="toc-case-study-power-for-a-randomized-trial"><span class="toc-section-number">12.3</span> Case study: power for a randomized trial</a>
<ul>
<li><a href="12.3-case-study-power-for-a-randomized-trial.html#the-initial-analysis" id="toc-the-initial-analysis"><span class="toc-section-number">12.3.1</span> The initial analysis</a></li>
<li><a href="12.3-case-study-power-for-a-randomized-trial.html#focusing-on-validity" id="toc-focusing-on-validity"><span class="toc-section-number">12.3.2</span> Focusing on validity</a></li>
<li><a href="12.3-case-study-power-for-a-randomized-trial.html#aggregate-to-look-at-main-effects" id="toc-aggregate-to-look-at-main-effects"><span class="toc-section-number">12.3.3</span> Aggregate to look at main effects</a></li>
<li><a href="12.3-case-study-power-for-a-randomized-trial.html#recap" id="toc-recap"><span class="toc-section-number">12.3.4</span> Recap</a></li>
</ul></li>
<li><a href="12.4-exercises-8.html#exercises-8" id="toc-exercises-8"><span class="toc-section-number">12.4</span> Exercises</a></li>
</ul></li>
<li class="has-sub"><a href="13-case-study-comparing-different-estimators.html#case-study-comparing-different-estimators" id="toc-case-study-comparing-different-estimators"><span class="toc-section-number">13</span> Case study: Comparing different estimators</a>
<ul>
<li><a href="13.1-the-data-generating-process.html#the-data-generating-process" id="toc-the-data-generating-process"><span class="toc-section-number">13.1</span> The data generating process</a></li>
<li><a href="13.2-the-data-analysis-methods.html#the-data-analysis-methods" id="toc-the-data-analysis-methods"><span class="toc-section-number">13.2</span> The data analysis methods</a></li>
<li><a href="13.3-the-simulation-itself.html#the-simulation-itself" id="toc-the-simulation-itself"><span class="toc-section-number">13.3</span> The simulation itself</a></li>
<li><a href="13.4-calculating-performance-measures-for-all-our-estimators.html#calculating-performance-measures-for-all-our-estimators" id="toc-calculating-performance-measures-for-all-our-estimators"><span class="toc-section-number">13.4</span> Calculating performance measures for all our estimators</a></li>
<li><a href="13.5-improving-the-visualization-of-the-results.html#improving-the-visualization-of-the-results" id="toc-improving-the-visualization-of-the-results"><span class="toc-section-number">13.5</span> Improving the visualization of the results</a></li>
<li><a href="13.6-extension-the-bias-variance-tradeoff.html#extension-the-bias-variance-tradeoff" id="toc-extension-the-bias-variance-tradeoff"><span class="toc-section-number">13.6</span> Extension: The Bias-variance tradeoff</a></li>
</ul></li>
<li class="has-sub"><a href="14-presentation-of-simulation-results.html#presentation-of-simulation-results" id="toc-presentation-of-simulation-results"><span class="toc-section-number">14</span> Presentation of simulation results</a>
<ul>
<li><a href="14.1-tabulation.html#tabulation" id="toc-tabulation"><span class="toc-section-number">14.1</span> Tabulation</a></li>
<li class="has-sub"><a href="14.2-visualization.html#visualization" id="toc-visualization"><span class="toc-section-number">14.2</span> Visualization</a>
<ul>
<li><a href="14.2-visualization.html#example-1-biserial-correlation-estimation" id="toc-example-1-biserial-correlation-estimation"><span class="toc-section-number">14.2.1</span> Example 1: Biserial correlation estimation</a></li>
<li><a href="14.2-visualization.html#example-2-variance-estimation-and-meta-regression" id="toc-example-2-variance-estimation-and-meta-regression"><span class="toc-section-number">14.2.2</span> Example 2: Variance estimation and Meta-regression</a></li>
<li><a href="14.2-visualization.html#example-heat-maps-of-coverage" id="toc-example-heat-maps-of-coverage"><span class="toc-section-number">14.2.3</span> Example: Heat maps of coverage</a></li>
</ul></li>
<li><a href="14.3-modeling.html#modeling" id="toc-modeling"><span class="toc-section-number">14.3</span> Modeling</a></li>
</ul></li>
<li class="part"><span><b>IV Computational Considerations</b></span></li>
<li class="has-sub"><a href="15-sec-reproducability.html#sec-reproducability" id="toc-sec-reproducability"><span class="toc-section-number">15</span> Ensuring reproducibility</a>
<ul>
<li><a href="15.1-seeds-and-pseudo-random-number-generators.html#seeds-and-pseudo-random-number-generators" id="toc-seeds-and-pseudo-random-number-generators"><span class="toc-section-number">15.1</span> Seeds and pseudo-random number generators</a></li>
<li><a href="15.2-including-seed-in-our-simulation-driver.html#including-seed-in-our-simulation-driver" id="toc-including-seed-in-our-simulation-driver"><span class="toc-section-number">15.2</span> Including seed in our simulation driver</a></li>
<li><a href="15.3-reasons-for-setting-the-seed.html#reasons-for-setting-the-seed" id="toc-reasons-for-setting-the-seed"><span class="toc-section-number">15.3</span> Reasons for setting the seed</a></li>
</ul></li>
<li class="has-sub"><a href="16-optimize-code.html#optimize-code" id="toc-optimize-code"><span class="toc-section-number">16</span> Optimizing code (and why you often shouldn’t)</a>
<ul>
<li><a href="16.1-hand-building-functions.html#hand-building-functions" id="toc-hand-building-functions"><span class="toc-section-number">16.1</span> Hand-building functions</a></li>
<li><a href="16.2-sec_comp_efficiency.html#sec_comp_efficiency" id="toc-sec_comp_efficiency"><span class="toc-section-number">16.2</span> Computational efficiency versus simplicity</a></li>
<li><a href="16.3-reusing-code-to-speed-up-computation.html#reusing-code-to-speed-up-computation" id="toc-reusing-code-to-speed-up-computation"><span class="toc-section-number">16.3</span> Reusing code to speed up computation</a></li>
</ul></li>
<li class="has-sub"><a href="17-error-trapping-and-other-headaches.html#error-trapping-and-other-headaches" id="toc-error-trapping-and-other-headaches"><span class="toc-section-number">17</span> Error trapping and other headaches</a>
<ul>
<li><a href="17-error-trapping-and-other-headaches.html#what-to-do-with-warnings-in-simulations" id="toc-what-to-do-with-warnings-in-simulations"><span class="toc-section-number">17.0.1</span> What to do with warnings in simulations</a></li>
</ul></li>
<li class="has-sub"><a href="18-saving-files.html#saving-files" id="toc-saving-files"><span class="toc-section-number">18</span> Saving files and results</a>
<ul>
<li><a href="18.1-saving-simulations-in-general.html#saving-simulations-in-general" id="toc-saving-simulations-in-general"><span class="toc-section-number">18.1</span> Saving simulations in general</a></li>
<li><a href="18.2-saving-simulations-as-you-go.html#saving-simulations-as-you-go" id="toc-saving-simulations-as-you-go"><span class="toc-section-number">18.2</span> Saving simulations as you go</a></li>
<li><a href="18.3-dynamically-making-directories.html#dynamically-making-directories" id="toc-dynamically-making-directories"><span class="toc-section-number">18.3</span> Dynamically making directories</a></li>
<li><a href="18.4-loading-and-combining-files-of-simulation-results.html#loading-and-combining-files-of-simulation-results" id="toc-loading-and-combining-files-of-simulation-results"><span class="toc-section-number">18.4</span> Loading and combining files of simulation results</a></li>
</ul></li>
<li class="has-sub"><a href="19-parallel-processing.html#parallel-processing" id="toc-parallel-processing"><span class="toc-section-number">19</span> Parallel Processing</a>
<ul>
<li><a href="19.1-parallel-on-your-computer.html#parallel-on-your-computer" id="toc-parallel-on-your-computer"><span class="toc-section-number">19.1</span> Parallel on your computer</a></li>
<li class="has-sub"><a href="19.2-parallel-off-your-computer.html#parallel-off-your-computer" id="toc-parallel-off-your-computer"><span class="toc-section-number">19.2</span> Parallel off your computer</a>
<ul>
<li><a href="19.2-parallel-off-your-computer.html#what-is-a-command-line-interface" id="toc-what-is-a-command-line-interface"><span class="toc-section-number">19.2.1</span> What is a command-line interface?</a></li>
<li><a href="19.2-parallel-off-your-computer.html#running-a-job-on-a-cluster" id="toc-running-a-job-on-a-cluster"><span class="toc-section-number">19.2.2</span> Running a job on a cluster</a></li>
<li><a href="19.2-parallel-off-your-computer.html#checking-on-a-job" id="toc-checking-on-a-job"><span class="toc-section-number">19.2.3</span> Checking on a job</a></li>
<li><a href="19.2-parallel-off-your-computer.html#running-lots-of-jobs-on-a-cluster" id="toc-running-lots-of-jobs-on-a-cluster"><span class="toc-section-number">19.2.4</span> Running lots of jobs on a cluster</a></li>
<li><a href="19.2-parallel-off-your-computer.html#resources-for-harvards-odyssey" id="toc-resources-for-harvards-odyssey"><span class="toc-section-number">19.2.5</span> Resources for Harvard’s Odyssey</a></li>
<li><a href="19.2-parallel-off-your-computer.html#acknowledgements-1" id="toc-acknowledgements-1"><span class="toc-section-number">19.2.6</span> Acknowledgements</a></li>
</ul></li>
</ul></li>
<li class="has-sub"><a href="20-simulations-as-evidence.html#simulations-as-evidence" id="toc-simulations-as-evidence"><span class="toc-section-number">20</span> Simulations as evidence</a>
<ul>
<li class="has-sub"><a href="20.1-strategies-for-making-relevant-simulations.html#strategies-for-making-relevant-simulations" id="toc-strategies-for-making-relevant-simulations"><span class="toc-section-number">20.1</span> Strategies for making relevant simulations</a>
<ul>
<li><a href="20.1-strategies-for-making-relevant-simulations.html#make-your-simulation-general-with-an-extensive-multi-factor-experiment" id="toc-make-your-simulation-general-with-an-extensive-multi-factor-experiment"><span class="toc-section-number">20.1.1</span> Make your simulation general with an extensive multi-factor experiment</a></li>
<li><a href="20.1-strategies-for-making-relevant-simulations.html#use-previously-published-simulations-to-beat-them-at-their-own-game" id="toc-use-previously-published-simulations-to-beat-them-at-their-own-game"><span class="toc-section-number">20.1.2</span> Use previously published simulations to beat them at their own game</a></li>
<li><a href="20.1-strategies-for-making-relevant-simulations.html#calibrate-simulation-factors-to-real-data" id="toc-calibrate-simulation-factors-to-real-data"><span class="toc-section-number">20.1.3</span> Calibrate simulation factors to real data</a></li>
<li><a href="20.1-strategies-for-making-relevant-simulations.html#use-real-data-to-obtain-directly" id="toc-use-real-data-to-obtain-directly"><span class="toc-section-number">20.1.4</span> Use real data to obtain directly</a></li>
<li><a href="20.1-strategies-for-making-relevant-simulations.html#fully-calibrated-simulations" id="toc-fully-calibrated-simulations"><span class="toc-section-number">20.1.5</span> Fully calibrated simulations</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>V Complex Data Structures</b></span></li>
<li class="has-sub"><a href="21-using-simulation-as-a-power-calculator.html#using-simulation-as-a-power-calculator" id="toc-using-simulation-as-a-power-calculator"><span class="toc-section-number">21</span> Using simulation as a power calculator</a>
<ul>
<li><a href="21.1-getting-design-parameters-from-pilot-data.html#getting-design-parameters-from-pilot-data" id="toc-getting-design-parameters-from-pilot-data"><span class="toc-section-number">21.1</span> Getting design parameters from pilot data</a></li>
<li><a href="21.2-the-data-generating-process-1.html#the-data-generating-process-1" id="toc-the-data-generating-process-1"><span class="toc-section-number">21.2</span> The data generating process</a></li>
<li><a href="21.3-running-the-simulation-1.html#running-the-simulation-1" id="toc-running-the-simulation-1"><span class="toc-section-number">21.3</span> Running the simulation</a></li>
<li class="has-sub"><a href="21.4-evaluating-power.html#evaluating-power" id="toc-evaluating-power"><span class="toc-section-number">21.4</span> Evaluating power</a>
<ul>
<li><a href="21.4-evaluating-power.html#checking-validity-of-our-models" id="toc-checking-validity-of-our-models"><span class="toc-section-number">21.4.1</span> Checking validity of our models</a></li>
<li><a href="21.4-evaluating-power.html#assessing-precision-se" id="toc-assessing-precision-se"><span class="toc-section-number">21.4.2</span> Assessing Precision (SE)</a></li>
<li><a href="21.4-evaluating-power.html#assessing-power" id="toc-assessing-power"><span class="toc-section-number">21.4.3</span> Assessing power</a></li>
<li><a href="21.4-evaluating-power.html#assessing-minimum-detectable-effects" id="toc-assessing-minimum-detectable-effects"><span class="toc-section-number">21.4.4</span> Assessing Minimum Detectable Effects</a></li>
</ul></li>
</ul></li>
<li class="has-sub"><a href="22-potential-outcomes.html#potential-outcomes" id="toc-potential-outcomes"><span class="toc-section-number">22</span> Simulation under the Potential Outcomes Framework</a>
<ul>
<li><a href="22.1-finite-vs.-superpopulation-inference.html#finite-vs.-superpopulation-inference" id="toc-finite-vs.-superpopulation-inference"><span class="toc-section-number">22.1</span> Finite vs. Superpopulation inference</a></li>
<li><a href="22.2-data-generation-processes-for-potential-outcomes.html#data-generation-processes-for-potential-outcomes" id="toc-data-generation-processes-for-potential-outcomes"><span class="toc-section-number">22.2</span> Data generation processes for potential outcomes</a></li>
<li><a href="22.3-finite-sample-performance-measures.html#finite-sample-performance-measures" id="toc-finite-sample-performance-measures"><span class="toc-section-number">22.3</span> Finite sample performance measures</a></li>
<li><a href="22.4-nested-finite-simulation-procedure.html#nested-finite-simulation-procedure" id="toc-nested-finite-simulation-procedure"><span class="toc-section-number">22.4</span> Nested finite simulation procedure</a></li>
</ul></li>
<li class="has-sub"><a href="23-the-parametric-bootstrap.html#the-parametric-bootstrap" id="toc-the-parametric-bootstrap"><span class="toc-section-number">23</span> The Parametric bootstrap</a>
<ul>
<li><a href="23.1-air-conditioners-a-stolen-case-study.html#air-conditioners-a-stolen-case-study" id="toc-air-conditioners-a-stolen-case-study"><span class="toc-section-number">23.1</span> Air conditioners: a stolen case study</a></li>
</ul></li>
<li class="appendix"><span><b>Appendices</b></span></li>
<li class="has-sub"><a href="A-coding-tidbits.html#coding-tidbits" id="toc-coding-tidbits"><span class="toc-section-number">A</span> Coding tidbits</a>
<ul>
<li class="has-sub"><a href="A.1-repeating-oneself.html#repeating-oneself" id="toc-repeating-oneself"><span class="toc-section-number">A.1</span> How to repeat yourself</a>
<ul>
<li><a href="A.1-repeating-oneself.html#using-replicate" id="toc-using-replicate"><span class="toc-section-number">A.1.1</span> Using <code>replicate()</code></a></li>
<li><a href="A.1-repeating-oneself.html#using-map" id="toc-using-map"><span class="toc-section-number">A.1.2</span> Using <code>map()</code></a></li>
<li><a href="A.1-repeating-oneself.html#map-with-no-inputs" id="toc-map-with-no-inputs"><span class="toc-section-number">A.1.3</span> map with no inputs</a></li>
<li><a href="A.1-repeating-oneself.html#other-approaches-for-repetition" id="toc-other-approaches-for-repetition"><span class="toc-section-number">A.1.4</span> Other approaches for repetition</a></li>
</ul></li>
<li><a href="A.2-default-arguments.html#default-arguments" id="toc-default-arguments"><span class="toc-section-number">A.2</span> Default arguments for functions</a></li>
<li><a href="A.3-about-source-command.html#about-source-command" id="toc-about-source-command"><span class="toc-section-number">A.3</span> The source command and keeping things organized</a></li>
<li><a href="A.4-about-keeping-tests-with-FALSE.html#about-keeping-tests-with-FALSE" id="toc-about-keeping-tests-with-FALSE"><span class="toc-section-number">A.4</span> Testing and debugging code in your scripts</a></li>
<li><a href="A.5-about-browser-debugging.html#about-browser-debugging" id="toc-about-browser-debugging"><span class="toc-section-number">A.5</span> Debugging with browser</a></li>
<li><a href="A.6-about-stopifnot.html#about-stopifnot" id="toc-about-stopifnot"><span class="toc-section-number">A.6</span> Protecting your functions with “stop”</a></li>
</ul></li>
<li><a href="B-further-readings-and-resources.html#further-readings-and-resources" id="toc-further-readings-and-resources"><span class="toc-section-number">B</span> Further readings and resources</a></li>
</ul>
</div>
</div>
</div>
<div class="row">
<div class="col-sm-12">
<div id="case-cluster" class="section level2" number="6.6">
<h2><span class="header-section-number">6.6</span> Example: Simulating clustered data</h2>
<p>Writing code for a complicated DGP can feel like a daunting task, but if you first focus on a recipe for how the data is generated, it is often not too bad to then convert that recipe into code.
We now illustrate this process with a detailed case study involving a more complex data-generating process
Recent literature on multisite trials (where, for example, students are randomized to treatment or control within each of a series of sites) has explored how variation in the strength of effects across sites can affect how different data-analysis procedures behave <span class="citation">(e.g., <a href="#ref-miratrix2021applied">Miratrix, Weiss, and Henderson 2021</a>; <a href="#ref-Bloom:2016um">Bloom et al. 2016</a>)</span>.
In this example, we are going to extend this work to explore best practices for estimating treatment effects in cluster randomized trials.
In particular, we will investigate what happens when the treatment impact for each school is related to the size of the school.</p>
<div id="a-design-decision-what-do-we-want-to-manipulate" class="section level3" number="6.6.1">
<h3><span class="header-section-number">6.6.1</span> A design decision: What do we want to manipulate?</h3>
<p>In designing a simulation study, we need to find a DGP that will allow us to address the specific questions we are interested in investigating.
For instance, in the one-way ANOVA example, we wanted to see how different degrees of within-group variation impacted the performance of several hypothesis-testing procedures.
We therefore needed a data generation process that allowed us to control the extent of within-group variation.</p>
<p>To figure out what DGP to use for simulating data from a cluster-randomized trial, we need to consider how we are going to use those data in our simulation study.
Because we are interested in understanding what happens when school-specific effects are related to school size, we will need data with the following features:</p>
<ol style="list-style-type: lower-alpha">
<li>observations for students in each of several schools;</li>
<li>schools are different sizes and have different mean outcomes;</li>
<li>school-specific treatment effects correlate with school size; and</li>
<li>schools are assigned to different treatment conditions.</li>
</ol>
<p>A given dataset will consist of observations for individual students in schools, with each student having a school id, a treatment assignment (shared for all in the school), and an outcome.
A good starting point for building a DGP is to first sketch out what a simulated dataset should look like.
For this example, we need data like the following:</p>
<table>
<thead>
<tr class="header">
<th align="right">schoolID</th>
<th align="right">Z</th>
<th align="right">size</th>
<th align="right">studentID</th>
<th align="right">Y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">24</td>
<td align="right">1</td>
<td align="right">3.6</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">24</td>
<td align="right">3</td>
<td align="right">1.0</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">etc</td>
<td align="right">etc</td>
<td align="right">etc</td>
<td align="right">etc</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">24</td>
<td align="right">24</td>
<td align="right">2.0</td>
</tr>
<tr class="odd">
<td align="right">2</td>
<td align="right">0</td>
<td align="right">32</td>
<td align="right">1</td>
<td align="right">0.5</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">0</td>
<td align="right">32</td>
<td align="right">2</td>
<td align="right">1.5</td>
</tr>
<tr class="odd">
<td align="right">2</td>
<td align="right">0</td>
<td align="right">32</td>
<td align="right">3</td>
<td align="right">1.2</td>
</tr>
<tr class="even">
<td align="right">etc</td>
<td align="right">etc</td>
<td align="right">etc</td>
<td align="right">etc</td>
<td align="right">etc</td>
</tr>
</tbody>
</table>
<p>When running simulations, it is good practice to look at simple scenarios along with complex ones.
This lets us not only identify conditions where some aspect of the DGP is important, but also verify that the feature does <em>not</em> matter under scenarios where we know it should not.
Given this principle, we land on the following points:</p>
<ul>
<li>We need a DGP that lets us generate schools that are all the same size or that are all different sizes.</li>
<li>Our DGP should allow for variation in the school-specific treatment effects.</li>
<li>We should have the option to generate school-specific effects that are related or unrelated to school size.</li>
</ul>
</div>
<div id="a-model-for-a-cluster-rct" class="section level3" number="6.6.2">
<h3><span class="header-section-number">6.6.2</span> A model for a cluster RCT</h3>
<p>DGPs are expressed and communicated using mathematical models.
In developing a DGP, we often start by considering the model for the outcomes (along with its focal parameters), which covers some but not all of the steps in the full recipe for generating data.
It is helpful to write down the equations for the outcome model and then note what further quantities need to be generated (such as structural features and covariates).
Then we can consider how to generate these quantities with auxiliary models.</p>
<p>Section <a href="6.1-DGP-examples.html#CRT-example">6.1.3</a> introduced a basic HLM for a cluster-randomized trial.
This model had two parts, starting with a model for our student outcome:
<span class="math display">\[ Y_{ij} = \beta_{0j} + \epsilon_{ij} \mbox{ with } \epsilon_{ij} \sim N( 0, \sigma^2_\epsilon ) \]</span>
where <span class="math inline">\(Y_{ij}\)</span> is the outcome for student <span class="math inline">\(i\)</span> in site <span class="math inline">\(j\)</span>, <span class="math inline">\(\beta_{0j}\)</span> is the average outcome in site <span class="math inline">\(j\)</span>, and <span class="math inline">\(\epsilon_{ij}\)</span> is the residual error for student <span class="math inline">\(i\)</span> in site <span class="math inline">\(j\)</span>.
The model was completed by specifying how the site-specific outcomes vary as a function of treatment assignment:
<span class="math display">\[ \beta_{0j} = \gamma_{0} + \gamma_{1} Z_j + u_j, \quad u_j \sim N( 0, \sigma^2_u ).\]</span>
This model has a constant treatment effect: if a school is assigned to treatment, then all outcomes in the cluster are raised by the amount <span class="math inline">\(\gamma_{1}\)</span>.
But we also want to allow the size of impact to vary by school size.
This suggests we will need to elaborate the model to include a treatment-by-size interaction term.</p>
<p>One approach for allowing the school-specific impacts to depend on school size is to introduce school size as a predictor, as in
<span class="math display">\[
\beta_{0j} = \gamma_{0} + \gamma_{1} Z_j + \gamma_{2} \left(Z_j \times n_j\right) + u_j.
\]</span>
A drawback of this approach is that changing the average size of the schools will change the average treatment impact.
A more interpretable approach is to allow treatment effects to depend on the <em>relative</em> school sizes.
To do this, we can define a covariate that describes the deviation in the school size relative to the average size.
Thus, let
<span class="math display">\[ S_j = \frac{n_j - \bar{n}}{ \bar{n} }, \]</span>
where <span class="math inline">\(\bar{n}\)</span> is the overall average school size.
Using this covariate, we then revise our equation for our site <span class="math inline">\(j\)</span> to:
<span class="math display">\[ \beta_{0j} = \gamma_{0} + \gamma_{1} Z_j + \gamma_{2} \left( Z_j \times S_j\right) + u_j. \]</span>
If <span class="math inline">\(\gamma_{2}\)</span> is positive, then bigger schools will have larger treatment impacts.
Because <span class="math inline">\(S_j\)</span> is centered at 0, the overall average impact across schools will be simply <span class="math inline">\(\gamma_{1}\)</span>.
(If <span class="math inline">\(S_j\)</span> was not centered at zero, then the overall average impact would be some function of <span class="math inline">\(\gamma_{1}\)</span> and <span class="math inline">\(\gamma_{2}\)</span>.)</p>
<p>Putting all of the above together, we now have an HLM to describe the distribution of outcomes conditional on the covariates and structural features:
<span class="math display">\[
\begin{aligned}
Y_{ij} &amp;= \beta_{0j} + \epsilon_{ij} \quad &amp;\epsilon_{ij} &amp;\sim N( 0, \sigma^2_\epsilon ) \\
\beta_{0j} &amp;= \gamma_{0} + \gamma_{1} Z_j + \gamma_{2} Z_j S_j + u_j \quad &amp; u_j &amp;\sim N( 0, \sigma^2_u )
\end{aligned}
\]</span>
Substituting the second equation into the first leads to a single equation for generating the student-level outcomes (or what is called the reduced form of the HLM):
<span class="math display">\[ Y_{ij} = \gamma_{0} + \gamma_{1} Z_j + \gamma_{2} Z_j S_j  + u_j + \epsilon_{ij}\]</span>
The parameters of this focal model are the mean outcome among control schools (<span class="math inline">\(\gamma_{0}\)</span>), the average treatment impact (<span class="math inline">\(\gamma_{1}\)</span>), the site-size by treatment interaction term (<span class="math inline">\(\gamma_{2}\)</span>), the amount of school-level variation (<span class="math inline">\(\sigma^2_u\)</span>), and the amount of within-school variation (<span class="math inline">\(\sigma^2_\epsilon\)</span>).</p>
<p>There are several ways that we could elaborate this model further.
For one, we might want to include a main effect for <span class="math inline">\(S_j\)</span>, so that average outcomes in the absence of treatment are also dependent on school size.
For another, we might revise the model to allow for school-to-school variation in treatment impacts that is not explained by school size.
For simplicity, we do not build in these further features, but see the exercises at the end of the chapter.</p>
<p>So far we have a mathematical model analogous to what we would write if we were <em>analyzing</em> the data.
To <em>generate</em> data, we also need a way to generate the structural features and covariates involved in the model.
First, we need to know the number of clusters (<span class="math inline">\(J\)</span>) and the sizes of the clusters (<span class="math inline">\(n_j\)</span>, for <span class="math inline">\(j = 1, ..., J\)</span>).
For illustrative purposes, we will generate size sizes from a uniform distribution with average school size <span class="math inline">\(\bar{n}\)</span> and a fixed parameter <span class="math inline">\(\alpha\)</span> that controls the degree of variation in school size. Mathematically,
<span class="math display">\[ n_j \sim \text{Unif}\left[ (1-\alpha)\bar{n}, (1+\alpha)\bar{n} \right].\]</span>
Equivalently, we could generate site sizes by taking
<span class="math display">\[n_j = \bar{n}(1 + \alpha U_j), \quad U_j \sim unif(-1, 1).\]</span>
For instance, if <span class="math inline">\(\bar{n} = 100\)</span> and <span class="math inline">\(\alpha = 0.25\)</span> then schools would range in size from 75 to 125.
This specification is nice because it is simple, with just two parameters, both of which are easy to interpret: <span class="math inline">\(\bar{n}\)</span> is the average school size and <span class="math inline">\(\alpha\)</span> is the degree of variation in school size.</p>
<p>To round out the model, we also need to define how to generate the treatment indicator, <span class="math inline">\(Z_j\)</span>.
To allow for different treatment allocations, we will specify a proportion <span class="math inline">\(p\)</span> of clusters assigned to treatment.
Because we are simulating a cluster-randomized trial, we do this by drawing a simple random sample (without replacement) of <span class="math inline">\(p \times J\)</span> schools out of the total sample of <span class="math inline">\(J\)</span> schools, then setting <span class="math inline">\(Z_j = 1\)</span> for these schools and <span class="math inline">\(Z_j = 0\)</span> for the remaining schools.
We will denote this process as <span class="math inline">\(Z_1,...,Z_J \sim SRS(p, J)\)</span>, where SRS stands for simple random sample.</p>
<p>Now that we have an auxiliary model for school sizes, let us look again at our treatment impact heterogeneity term:
<span class="math display">\[ \gamma_{2} Z_j S_j = \gamma_{2} Z_j \left(\frac{n_j - \bar{n}}{\bar{n}}\right) = \gamma_{2}  \alpha Z_j U_j, \]</span>
where <span class="math inline">\(U_j \sim \text{Unif}(-1,1)\)</span> is the uniform variable used to generate <span class="math inline">\(n_j\)</span>.
Because we have standardized by average school size, the importance of the covariate does not change as a function of average school size, but rather as a function of the relative variation parameter <span class="math inline">\(\alpha\)</span>.
Setting up a DGP with standardized quantities will make it easier to interpret simulation results, especially if we are looking at results from multiple scenarios with different parameter values.
To the extent feasible, we want the parameters of the DGP to change only one feature of the data, so that it is easier to isolate the influence of each parameter.</p>
</div>
<div id="from-equations-to-code" class="section level3" number="6.6.3">
<h3><span class="header-section-number">6.6.3</span> From equations to code</h3>
<p>When sketching out the equations for the DGP, we worked from the lowest level of the model (the students) to the higher level (schools) and then to the auxiliary models for covariates and structural features.
For writing code to based on the DGP, we will proceed in the opposite direction, from auxiliary to focal and from the highest level to the lowest.
First, we will generate the sites and their features:</p>
<ul>
<li>Generate school sizes</li>
<li>Generate school-level covariates</li>
<li>Generate school-level random effects</li>
</ul>
<p>Then we will generate the students inside the sites:</p>
<ul>
<li>Generate student residuals</li>
<li>Add everything up to generate student outcomes</li>
</ul>
<p>The mathematical model gives us the details we need to execute with each of these steps.</p>
<p>Here is the skeleton of a DGP function with arguments for each of the parameters we might want to control, including defaults for each (see <a href="A.2-default-arguments.html#default-arguments">A.2</a> for more on function defaults):</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb131-1"><a href="6.6-case-cluster.html#cb131-1" tabindex="-1"></a>gen_cluster_RCT <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb131-2"><a href="6.6-case-cluster.html#cb131-2" tabindex="-1"></a>    <span class="at">J =</span> <span class="dv">30</span>,</span>
<span id="cb131-3"><a href="6.6-case-cluster.html#cb131-3" tabindex="-1"></a>    <span class="at">n_bar =</span> <span class="dv">10</span>,</span>
<span id="cb131-4"><a href="6.6-case-cluster.html#cb131-4" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="dv">0</span>,</span>
<span id="cb131-5"><a href="6.6-case-cluster.html#cb131-5" tabindex="-1"></a>    <span class="at">p =</span> <span class="fl">0.5</span>,</span>
<span id="cb131-6"><a href="6.6-case-cluster.html#cb131-6" tabindex="-1"></a>    <span class="at">gamma_0 =</span> <span class="dv">0</span>, <span class="at">gamma_1 =</span> <span class="dv">0</span>, <span class="at">gamma_2 =</span> <span class="dv">0</span>,</span>
<span id="cb131-7"><a href="6.6-case-cluster.html#cb131-7" tabindex="-1"></a>    <span class="at">sigma2_u =</span> <span class="dv">0</span>, <span class="at">sigma2_e =</span> <span class="dv">1</span></span>
<span id="cb131-8"><a href="6.6-case-cluster.html#cb131-8" tabindex="-1"></a>) {</span>
<span id="cb131-9"><a href="6.6-case-cluster.html#cb131-9" tabindex="-1"></a>  </span>
<span id="cb131-10"><a href="6.6-case-cluster.html#cb131-10" tabindex="-1"></a>  <span class="co"># generate schools sizes </span></span>
<span id="cb131-11"><a href="6.6-case-cluster.html#cb131-11" tabindex="-1"></a>  <span class="co"># Code (see below) goes here</span></span>
<span id="cb131-12"><a href="6.6-case-cluster.html#cb131-12" tabindex="-1"></a>}</span></code></pre></div>
<p>Note that the inputs to this function are a mix of <em>model parameters</em> (<code>gamma_0</code>, <code>gamma_1</code>, <code>gamma_2</code>, representing coefficients in regressions), <em>auxilary parameters</em> (<code>sigma2_u</code>, <code>sigma2_e</code>, <code>alpha</code>, <code>n_bar</code>), and <em>design parameters</em> (<code>J</code>, <code>p</code>) that directly inform data generation.
We set default arguments (e.g., <code>gamma_0=0</code>) so that we can ignore aspects of the DGP that we do not care about for the moment.</p>
<p>Inside the model, we will have a block of code to generate the variables pertaining to schools, and then another to generate the variables pertaining to students.</p>
<p>We first make the schools:</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb132-1"><a href="6.6-case-cluster.html#cb132-1" tabindex="-1"></a>  n_min <span class="ot">&lt;-</span> <span class="fu">round</span>( n_bar <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> alpha) )</span>
<span id="cb132-2"><a href="6.6-case-cluster.html#cb132-2" tabindex="-1"></a>  n_max <span class="ot">&lt;-</span> <span class="fu">round</span>( n_bar <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> alpha) )</span>
<span id="cb132-3"><a href="6.6-case-cluster.html#cb132-3" tabindex="-1"></a>  nj <span class="ot">&lt;-</span> <span class="fu">sample</span>( n_min<span class="sc">:</span>n_max, J, <span class="at">replace =</span> <span class="cn">TRUE</span> )</span>
<span id="cb132-4"><a href="6.6-case-cluster.html#cb132-4" tabindex="-1"></a>  </span>
<span id="cb132-5"><a href="6.6-case-cluster.html#cb132-5" tabindex="-1"></a>  <span class="co"># Generate average control outcome for all schools</span></span>
<span id="cb132-6"><a href="6.6-case-cluster.html#cb132-6" tabindex="-1"></a>  <span class="co"># (the random effects)</span></span>
<span id="cb132-7"><a href="6.6-case-cluster.html#cb132-7" tabindex="-1"></a>  u0j <span class="ot">&lt;-</span> <span class="fu">rnorm</span>( J, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="fu">sqrt</span>(sigma2_u) )</span>
<span id="cb132-8"><a href="6.6-case-cluster.html#cb132-8" tabindex="-1"></a>  </span>
<span id="cb132-9"><a href="6.6-case-cluster.html#cb132-9" tabindex="-1"></a>  <span class="co"># randomize schools (proportion p to treatment)</span></span>
<span id="cb132-10"><a href="6.6-case-cluster.html#cb132-10" tabindex="-1"></a>  Zj <span class="ot">&lt;-</span> <span class="fu">ifelse</span>( <span class="fu">sample</span>( <span class="dv">1</span><span class="sc">:</span>J ) <span class="sc">&lt;=</span> J <span class="sc">*</span> p, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb132-11"><a href="6.6-case-cluster.html#cb132-11" tabindex="-1"></a>  </span>
<span id="cb132-12"><a href="6.6-case-cluster.html#cb132-12" tabindex="-1"></a>  <span class="co"># Calculate schools intercepts</span></span>
<span id="cb132-13"><a href="6.6-case-cluster.html#cb132-13" tabindex="-1"></a>  S_j <span class="ot">&lt;-</span> (nj <span class="sc">-</span> n_bar) <span class="sc">/</span> n_bar</span>
<span id="cb132-14"><a href="6.6-case-cluster.html#cb132-14" tabindex="-1"></a>  beta_0j <span class="ot">&lt;-</span> gamma_0 <span class="sc">+</span> gamma_1 <span class="sc">*</span> Zj <span class="sc">+</span> gamma_2 <span class="sc">*</span> Zj <span class="sc">*</span> S_j <span class="sc">+</span> u0j</span></code></pre></div>
<p>The code is a literal translation of the math we did before.
Note the line with <code>sample(1:J) &lt;= J*p</code>; this is a simple trick to generate a 0/1 indicator for control and treatment conditions.</p>
<p>There is also a serious error in the above code (serious in that the code will run and look fine in many cases, but not always do what we want); we leave it as an exercise (see below) to find and fix it.
<!-- JEP: Does this exercise support our pedagogical goals? If this is supposed to be intro chapter, then debugging a subtle problem seems like it could be counterproductive. -->
<!-- LWM: I think we hand-hold the debugging clearly in the exercises, so I am not worried, and the larger point is important? --></p>
<p>Next, we use the site characteristics to generate the individual-level variables:</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb133-1"><a href="6.6-case-cluster.html#cb133-1" tabindex="-1"></a>  <span class="co"># Make individual site membership</span></span>
<span id="cb133-2"><a href="6.6-case-cluster.html#cb133-2" tabindex="-1"></a>  sid <span class="ot">&lt;-</span> <span class="fu">as.factor</span>( <span class="fu">rep</span>( <span class="dv">1</span><span class="sc">:</span>J, nj ) )</span>
<span id="cb133-3"><a href="6.6-case-cluster.html#cb133-3" tabindex="-1"></a>  </span>
<span id="cb133-4"><a href="6.6-case-cluster.html#cb133-4" tabindex="-1"></a>  <span class="co"># Generate the individual-level errors and outcome</span></span>
<span id="cb133-5"><a href="6.6-case-cluster.html#cb133-5" tabindex="-1"></a>  N <span class="ot">&lt;-</span> <span class="fu">sum</span>( nj )</span>
<span id="cb133-6"><a href="6.6-case-cluster.html#cb133-6" tabindex="-1"></a>  e <span class="ot">&lt;-</span> <span class="fu">rnorm</span>( N, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="fu">sqrt</span>(sigma2_e) )</span>
<span id="cb133-7"><a href="6.6-case-cluster.html#cb133-7" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> beta_0j[sid] <span class="sc">+</span> e</span>
<span id="cb133-8"><a href="6.6-case-cluster.html#cb133-8" tabindex="-1"></a>  </span>
<span id="cb133-9"><a href="6.6-case-cluster.html#cb133-9" tabindex="-1"></a>  <span class="co"># Bundle into a dataset</span></span>
<span id="cb133-10"><a href="6.6-case-cluster.html#cb133-10" tabindex="-1"></a>  dd <span class="ot">&lt;-</span> <span class="fu">data.frame</span>( </span>
<span id="cb133-11"><a href="6.6-case-cluster.html#cb133-11" tabindex="-1"></a>    <span class="at">sid =</span> sid,</span>
<span id="cb133-12"><a href="6.6-case-cluster.html#cb133-12" tabindex="-1"></a>    <span class="at">Z =</span> Zj[ sid ],</span>
<span id="cb133-13"><a href="6.6-case-cluster.html#cb133-13" tabindex="-1"></a>    <span class="at">Yobs =</span> Y</span>
<span id="cb133-14"><a href="6.6-case-cluster.html#cb133-14" tabindex="-1"></a>  )</span></code></pre></div>
<p>A key piece here is the <code>rep()</code> function that takes a list and repeats each element of the list a specified number of times.
In particular, <code>rep()</code> repeats each number (<span class="math inline">\(1, 2, \ldots, J\)</span>), the corresponding number of times as listed in <code>nj</code>.
Putting the code above into the function skeleton will produce a complete DGP function (view the <a href="/case_study_code/gen_cluster_RCT.R">complete function here</a>).
We can then call the function as so:</p>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb134-1"><a href="6.6-case-cluster.html#cb134-1" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">gen_cluster_RCT</span>( </span>
<span id="cb134-2"><a href="6.6-case-cluster.html#cb134-2" tabindex="-1"></a>  <span class="at">J=</span><span class="dv">3</span>, <span class="at">n_bar =</span> <span class="dv">5</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">p =</span> <span class="fl">0.5</span>, </span>
<span id="cb134-3"><a href="6.6-case-cluster.html#cb134-3" tabindex="-1"></a>  <span class="at">gamma_0 =</span> <span class="dv">0</span>, <span class="at">gamma_1 =</span> <span class="fl">0.2</span>, <span class="at">gamma_2 =</span> <span class="fl">0.2</span>,</span>
<span id="cb134-4"><a href="6.6-case-cluster.html#cb134-4" tabindex="-1"></a>  <span class="at">sigma2_u =</span> <span class="fl">0.4</span>, <span class="at">sigma2_e =</span> <span class="dv">1</span></span>
<span id="cb134-5"><a href="6.6-case-cluster.html#cb134-5" tabindex="-1"></a>)</span>
<span id="cb134-6"><a href="6.6-case-cluster.html#cb134-6" tabindex="-1"></a></span>
<span id="cb134-7"><a href="6.6-case-cluster.html#cb134-7" tabindex="-1"></a>dat</span></code></pre></div>
<pre><code>##    sid Z       Yobs
## 1    1 1  2.3263686
## 2    1 1  2.0202277
## 3    1 1  3.5850632
## 4    1 1  0.9581332
## 5    1 1  2.6183761
## 6    1 1  0.3198559
## 7    2 0 -2.2305376
## 8    2 0  1.0479261
## 9    2 0 -0.6256389
## 10   2 0  1.0891353
## 11   2 0 -0.6051252
## 12   2 0 -0.3099363
## 13   2 0 -0.9828624
## 14   2 0 -0.5571326
## 15   3 0  0.1203995
## 16   3 0  1.7086978
## 17   3 0  0.1213685</code></pre>
<p>With this function, we can control the average size of the clusters (<code>n</code>), the number of clusters (<code>J</code>), the proportion treated (<code>p</code>), the average outcome in the control group (<code>gamma_0</code>), the average treatment effect (<code>gamma_1</code>), the site size by treatment interaction (<code>gamma_2</code>), the amount of cross site variation (<code>sigma2_u</code>), the residual variation (<code>sigma2_e</code>), and the amount of site size variation (<code>alpha</code>).
The next step is to test the code, making sure it is doing what we think it is.
In fact, it is not–there is a subtle bug that only appears under some specifications of the parameters; see the exercises for more on diagnosing and repairing this error.</p>
</div>
<div id="standardization-in-the-dgp" class="section level3" number="6.6.4">
<h3><span class="header-section-number">6.6.4</span> Standardization in the DGP</h3>
<p>One difficulty with the current implementation of the model is that the magnitude of the different parameters are inter-connected.
For instance, raising or lowering the within-school variance (<span class="math inline">\(\sigma^2_u\)</span>) will increase the overall variation in <span class="math inline">\(Y\)</span>, and therefore affect our the interpretation of the treatment effect parameters, because a given value of <span class="math inline">\(\gamma_{1}\)</span> will be less consequential if there is more overall variation.
We can fix this issue by standardizing the model parameters.
Standardization will allow us to reduce the set of parameters we might want to manipulate and will ensure that varying the remaining parameters only affects one aspect of the DGP.</p>
<p>For a continuous, normally distributed outcome variable, a common approach to scaling is to constrain the overall variance of the outcome to a fixed value, such as 1 or 100.
The magnitude of the other parameters of the model can then be interpreted relative to this scale.
Often, we can also constrain the mean of the outcome to a fixed value, such as setting <span class="math inline">\(\gamma_0 = 0\)</span> without affecting the interpretation of the other parameters.</p>
<p>With the current model, the variance of the outcome across students in the control condition is
<span class="math display">\[
\begin{aligned}
\text{Var}( Y_{ij} | Z_j = 0) &amp;= \text{Var}( \beta_{0j} + \epsilon_{ij} | Z_j = 0) \\
&amp;= \text{Var}( \gamma_{0} + \gamma_{1} Z_j + \gamma_{2} Z_j S_j + u_j + \epsilon_{ij} | Z_j = 0) \\
&amp;= \text{Var}( \gamma_{0} + u_j + \epsilon_{ij} ) \\
&amp;= \sigma^2_u + \sigma^2_\epsilon.
\end{aligned}
\]</span>
To ensure that the total variance is held constant, we can redefine the variance parameters in terms of the intra-class correlation (ICC).
The ICC is defined as
<span class="math display">\[ ICC = \frac{ \sigma^2_u }{ \sigma^2_u + \sigma^2_\epsilon }.\]</span>
The ICC measures the degree of between-group variation as a proportion of the total variation of the outcome.
It plays an important role in power calculations for cluster-randomized trials.
If we want the total variance of the outcome to be 1, we need to set <span class="math inline">\(\sigma^2_u + \sigma^2_{\epsilon} = 1\)</span>, which the implies that <span class="math inline">\(ICC = \sigma^2_u\)</span>, and <span class="math inline">\(\sigma^2_\epsilon = 1 - ICC\)</span>.
Thus, we can call our DGP function as follows:</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb136-1"><a href="6.6-case-cluster.html#cb136-1" tabindex="-1"></a>ICC <span class="ot">&lt;-</span> <span class="fl">0.3</span></span>
<span id="cb136-2"><a href="6.6-case-cluster.html#cb136-2" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">gen_cluster_RCT</span>( </span>
<span id="cb136-3"><a href="6.6-case-cluster.html#cb136-3" tabindex="-1"></a>  <span class="at">J =</span> <span class="dv">30</span>, <span class="at">n_bar =</span> <span class="dv">20</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">p =</span> <span class="fl">0.5</span>,</span>
<span id="cb136-4"><a href="6.6-case-cluster.html#cb136-4" tabindex="-1"></a>  <span class="at">gamma_0 =</span> <span class="dv">0</span>, <span class="at">gamma_1 =</span> <span class="fl">0.3</span>, <span class="at">gamma_2 =</span> <span class="fl">0.2</span>,</span>
<span id="cb136-5"><a href="6.6-case-cluster.html#cb136-5" tabindex="-1"></a>  <span class="at">sigma2_u =</span> ICC, <span class="at">sigma2_e =</span> <span class="dv">1</span> <span class="sc">-</span> ICC</span>
<span id="cb136-6"><a href="6.6-case-cluster.html#cb136-6" tabindex="-1"></a>)</span></code></pre></div>
<p>Manipulating the ICC rather than separately manipulating <span class="math inline">\(\sigma^2_u\)</span> and <span class="math inline">\(\sigma^2_\epsilon\)</span> will let us change the degree of between-group variation without affecting the overall scale of the outcome.</p>
<p>A further consequence of setting the overall scale of the outcome to 1 is that the parameters controlling the treatment impact can now be interpreted as standardized mean difference effect sizes.
The standardized mean difference for a treatment impact is defined as the average impact over the standard deviation of the outcome among control observations.<a href="#fn11" class="footnote-ref" id="fnref11"><sup>11</sup></a>
Letting <span class="math inline">\(\delta\)</span> denote the standardized mean difference parameter,
<span class="math display">\[ \delta = \frac{E(Y | Z_j = 1) - E(Y | Z_j = 0)}{SD( Y | Z_j = 0 )} = \frac{\gamma_1}{\sqrt{ \sigma^2_u + \sigma^2_\epsilon } } \]</span>
Because we have constrained the total variance, <span class="math inline">\(\gamma_1\)</span> is equivalent to <span class="math inline">\(\delta\)</span>. This equivalence holds for any value of <span class="math inline">\(\gamma_0\)</span>, so we do not have to worry about manipulating <span class="math inline">\(\gamma_0\)</span> in the simulations—we can simply leave it at its default value.</p>
<!-- JEP: Do we want to discuss anything about interpretation of gamma_2? Or add an exercise about it? -->
<!-- LWM: I don't think there is a need -->
</div>
</div>
<h3>References</h3>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-Bloom:2016um" class="csl-entry">
Bloom, Howard S., Stephen W. Raudenbush, Michael J. Weiss, and Kristin Porter. 2016. <span>“<span class="nocase">Using Multisite Experiments to Study Cross-Site Variation in Treatment Effects: A Hybrid Approach With Fixed Intercepts and a Random Treatment Coefficient</span>.”</span> <em>Journal of Research on Educational Effectiveness</em> 10 (4): 0–0. <a href="https://doi.org/10.1080/19345747.2016.1264518">https://doi.org/10.1080/19345747.2016.1264518</a>.
</div>
<div id="ref-miratrix2021applied" class="csl-entry">
Miratrix, Luke W., Michael J. Weiss, and Brit Henderson. 2021. <span>“An <span>Applied Researcher</span>’s <span>Guide</span> to <span>Estimating Effects</span> from <span>Multisite Individually Randomized Trials</span>: <span>Estimands</span>, <span>Estimators</span>, and <span>Estimates</span>.”</span> <em>Journal of Research on Educational Effectiveness</em> 14 (1): 270–308. <a href="https://doi.org/10.1080/19345747.2020.1831115">https://doi.org/10.1080/19345747.2020.1831115</a>.
</div>
</div>
<div class="footnotes">
<hr />
<ol start="11">
<li id="fn11"><p>An alternative definition is based on the pooled standard deviation, but this is usually a bad choice if one suspects treatment variation. More treatment variation should not reduce the effect size for the same absolute average impact.<a href="6.6-case-cluster.html#fnref11" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
<p style="text-align: center;">
<a href="6.5-check-the-data-generating-function.html"><button class="btn btn-default">Previous</button></a>
<a href="6.7-three-parameter-IRT.html"><button class="btn btn-default">Next</button></a>
</p>
</div>
</div>


</div>

<script>

// add bootstrap table styles to pandoc tables
$(document).ready(function () {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
});

</script>

</body>
</html>
