<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 10 Designing and executing multifactor simulations | Designing Monte Carlo Simulations in R</title>
  <meta name="description" content="A text on designing, implementing, and reporting on Monte Carlo simulation studies" />
  <meta name="generator" content="bookdown 0.44 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 10 Designing and executing multifactor simulations | Designing Monte Carlo Simulations in R" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="A text on designing, implementing, and reporting on Monte Carlo simulation studies" />
  <meta name="github-repo" content="jepusto/Designing-Simulations-in-R" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 10 Designing and executing multifactor simulations | Designing Monte Carlo Simulations in R" />
  
  <meta name="twitter:description" content="A text on designing, implementing, and reporting on Monte Carlo simulation studies" />
  

<meta name="author" content="Luke W. Miratrix and James E. Pustejovsky (Equal authors)" />


<meta name="date" content="2025-09-06" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="performance-criteria.html"/>
<link rel="next" href="presentation-of-results.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
<span class="math inline">
\(\newcommand{\Prob}{\text{Pr}}\)
\(\newcommand{\E}{\mathbb{E}}\)
\(\newcommand{\M}{\mathbb{M}}\)
\(\newcommand{\Q}{\mathbb{Q}}\)
\(\newcommand{\Var}{\text{Var}}\)
\(\newcommand{\Bias}{\text{Bias}}\)
\(\newcommand{\RMSE}{\text{RMSE}}\)
\(\newcommand{\Cov}{\text{Cov}}\)
\(\newcommand{\cor}{\text{cor}}\)
\(\newcommand{\diag}{\text{diag}}\)
\(\newcommand{\mat}[1]{\mathbf{#1}}\)
\(\newcommand{\bs}{\boldsymbol}\)
\(\newcommand{\trace}{\text{tr}}\)
</span>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>
<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Designing Simulations in R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#license"><i class="fa fa-check"></i>License</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#about-the-authors"><i class="fa fa-check"></i>About the authors</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#acknowledgements"><i class="fa fa-check"></i>Acknowledgements</a></li>
</ul></li>
<li class="part"><span><b>I An Introductory Look</b></span></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="introduction.html"><a href="introduction.html#some-of-simulations-many-uses"><i class="fa fa-check"></i><b>1.1</b> Some of simulation’s many uses</a>
<ul>
<li class="chapter" data-level="1.1.1" data-path="introduction.html"><a href="introduction.html#comparing-statistical-approaches"><i class="fa fa-check"></i><b>1.1.1</b> Comparing statistical approaches</a></li>
<li class="chapter" data-level="1.1.2" data-path="introduction.html"><a href="introduction.html#assessing-performance-of-complex-pipelines"><i class="fa fa-check"></i><b>1.1.2</b> Assessing performance of complex pipelines</a></li>
<li class="chapter" data-level="1.1.3" data-path="introduction.html"><a href="introduction.html#assessing-performance-under-misspecification"><i class="fa fa-check"></i><b>1.1.3</b> Assessing performance under misspecification</a></li>
<li class="chapter" data-level="1.1.4" data-path="introduction.html"><a href="introduction.html#assessing-the-finite-sample-performance-of-a-statistical-approach"><i class="fa fa-check"></i><b>1.1.4</b> Assessing the finite-sample performance of a statistical approach</a></li>
<li class="chapter" data-level="1.1.5" data-path="introduction.html"><a href="introduction.html#conducting-power-analyses"><i class="fa fa-check"></i><b>1.1.5</b> Conducting Power Analyses</a></li>
<li class="chapter" data-level="1.1.6" data-path="introduction.html"><a href="introduction.html#simulating-processess"><i class="fa fa-check"></i><b>1.1.6</b> Simulating processess</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="introduction.html"><a href="introduction.html#the-perils-of-simulation-as-evidence"><i class="fa fa-check"></i><b>1.2</b> The perils of simulation as evidence</a></li>
<li class="chapter" data-level="1.3" data-path="introduction.html"><a href="introduction.html#simulating-to-learn"><i class="fa fa-check"></i><b>1.3</b> Simulating to learn</a></li>
<li class="chapter" data-level="1.4" data-path="introduction.html"><a href="introduction.html#why-r"><i class="fa fa-check"></i><b>1.4</b> Why R?</a></li>
<li class="chapter" data-level="1.5" data-path="introduction.html"><a href="introduction.html#organization-of-the-text"><i class="fa fa-check"></i><b>1.5</b> Organization of the text</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html"><i class="fa fa-check"></i><b>2</b> Programming Preliminaries</a>
<ul>
<li class="chapter" data-level="2.1" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#welcome-to-the-tidyverse"><i class="fa fa-check"></i><b>2.1</b> Welcome to the tidyverse</a></li>
<li class="chapter" data-level="2.2" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#functions"><i class="fa fa-check"></i><b>2.2</b> Functions</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#rolling-your-own"><i class="fa fa-check"></i><b>2.2.1</b> Rolling your own</a></li>
<li class="chapter" data-level="2.2.2" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#a-dangerous-function"><i class="fa fa-check"></i><b>2.2.2</b> A dangerous function</a></li>
<li class="chapter" data-level="2.2.3" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#using-named-arguments"><i class="fa fa-check"></i><b>2.2.3</b> Using Named Arguments</a></li>
<li class="chapter" data-level="2.2.4" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#argument-defaults"><i class="fa fa-check"></i><b>2.2.4</b> Argument Defaults</a></li>
<li class="chapter" data-level="2.2.5" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#function-skeletons"><i class="fa fa-check"></i><b>2.2.5</b> Function skeletons</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#pipe-dreams"><i class="fa fa-check"></i><b>2.3</b> <code>\&gt;</code> (Pipe) dreams</a></li>
<li class="chapter" data-level="2.4" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#recipes-versus-patterns"><i class="fa fa-check"></i><b>2.4</b> Recipes versus Patterns</a></li>
<li class="chapter" data-level="2.5" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#exercises"><i class="fa fa-check"></i><b>2.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="t-test-simulation.html"><a href="t-test-simulation.html"><i class="fa fa-check"></i><b>3</b> An initial simulation</a>
<ul>
<li class="chapter" data-level="3.1" data-path="t-test-simulation.html"><a href="t-test-simulation.html#simulating-a-single-scenario"><i class="fa fa-check"></i><b>3.1</b> Simulating a single scenario</a></li>
<li class="chapter" data-level="3.2" data-path="t-test-simulation.html"><a href="t-test-simulation.html#a-non-normal-population-distribution"><i class="fa fa-check"></i><b>3.2</b> A non-normal population distribution</a></li>
<li class="chapter" data-level="3.3" data-path="t-test-simulation.html"><a href="t-test-simulation.html#simulating-across-different-scenarios"><i class="fa fa-check"></i><b>3.3</b> Simulating across different scenarios</a></li>
<li class="chapter" data-level="3.4" data-path="t-test-simulation.html"><a href="t-test-simulation.html#extending-the-simulation-design"><i class="fa fa-check"></i><b>3.4</b> Extending the simulation design</a></li>
<li class="chapter" data-level="3.5" data-path="t-test-simulation.html"><a href="t-test-simulation.html#exercises-1"><i class="fa fa-check"></i><b>3.5</b> Exercises</a></li>
</ul></li>
<li class="part"><span><b>II Structure and Mechanics of a Simulation Study</b></span></li>
<li class="chapter" data-level="4" data-path="simulation-structure.html"><a href="simulation-structure.html"><i class="fa fa-check"></i><b>4</b> Structure of a simulation study</a>
<ul>
<li class="chapter" data-level="4.1" data-path="simulation-structure.html"><a href="simulation-structure.html#general-structure-of-a-simulation"><i class="fa fa-check"></i><b>4.1</b> General structure of a simulation</a></li>
<li class="chapter" data-level="4.2" data-path="simulation-structure.html"><a href="simulation-structure.html#tidy-modular-simulations"><i class="fa fa-check"></i><b>4.2</b> Tidy, modular simulations</a></li>
<li class="chapter" data-level="4.3" data-path="simulation-structure.html"><a href="simulation-structure.html#skeleton-of-a-simulation-study"><i class="fa fa-check"></i><b>4.3</b> Skeleton of a simulation study</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="simulation-structure.html"><a href="simulation-structure.html#data-generating-process"><i class="fa fa-check"></i><b>4.3.1</b> Data-Generating Process</a></li>
<li class="chapter" data-level="4.3.2" data-path="simulation-structure.html"><a href="simulation-structure.html#data-analysis-procedure"><i class="fa fa-check"></i><b>4.3.2</b> Data Analysis Procedure</a></li>
<li class="chapter" data-level="4.3.3" data-path="simulation-structure.html"><a href="simulation-structure.html#repetition"><i class="fa fa-check"></i><b>4.3.3</b> Repetition</a></li>
<li class="chapter" data-level="4.3.4" data-path="simulation-structure.html"><a href="simulation-structure.html#performance-summaries"><i class="fa fa-check"></i><b>4.3.4</b> Performance summaries</a></li>
<li class="chapter" data-level="4.3.5" data-path="simulation-structure.html"><a href="simulation-structure.html#multifactor-simulations"><i class="fa fa-check"></i><b>4.3.5</b> Multifactor simulations</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="simulation-structure.html"><a href="simulation-structure.html#exercises-2"><i class="fa fa-check"></i><b>4.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="case-ANOVA.html"><a href="case-ANOVA.html"><i class="fa fa-check"></i><b>5</b> Case Study: Heteroskedastic ANOVA and Welch</a>
<ul>
<li class="chapter" data-level="5.1" data-path="case-ANOVA.html"><a href="case-ANOVA.html#case-anova-DGP"><i class="fa fa-check"></i><b>5.1</b> The data-generating model</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="case-ANOVA.html"><a href="case-ANOVA.html#now-make-a-function"><i class="fa fa-check"></i><b>5.1.1</b> Now make a function</a></li>
<li class="chapter" data-level="5.1.2" data-path="case-ANOVA.html"><a href="case-ANOVA.html#cautious-coding"><i class="fa fa-check"></i><b>5.1.2</b> Cautious coding</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="case-ANOVA.html"><a href="case-ANOVA.html#the-hypothesis-testing-procedures"><i class="fa fa-check"></i><b>5.2</b> The hypothesis testing procedures</a></li>
<li class="chapter" data-level="5.3" data-path="case-ANOVA.html"><a href="case-ANOVA.html#running-the-simulation"><i class="fa fa-check"></i><b>5.3</b> Running the simulation</a></li>
<li class="chapter" data-level="5.4" data-path="case-ANOVA.html"><a href="case-ANOVA.html#summarizing-test-performance"><i class="fa fa-check"></i><b>5.4</b> Summarizing test performance</a></li>
<li class="chapter" data-level="5.5" data-path="case-ANOVA.html"><a href="case-ANOVA.html#exAnovaExercises"><i class="fa fa-check"></i><b>5.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="data-generating-processes.html"><a href="data-generating-processes.html"><i class="fa fa-check"></i><b>6</b> Data-generating processes</a>
<ul>
<li class="chapter" data-level="6.1" data-path="data-generating-processes.html"><a href="data-generating-processes.html#DGP-examples"><i class="fa fa-check"></i><b>6.1</b> Examples</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="data-generating-processes.html"><a href="data-generating-processes.html#ANOVA-example"><i class="fa fa-check"></i><b>6.1.1</b> Example 1: One-way analysis of variance</a></li>
<li class="chapter" data-level="6.1.2" data-path="data-generating-processes.html"><a href="data-generating-processes.html#BVPois-example"><i class="fa fa-check"></i><b>6.1.2</b> Example 2: Bivariate Poisson model</a></li>
<li class="chapter" data-level="6.1.3" data-path="data-generating-processes.html"><a href="data-generating-processes.html#CRT-example"><i class="fa fa-check"></i><b>6.1.3</b> Example 3: Hierarchical linear model for a cluster-randomized trial</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="data-generating-processes.html"><a href="data-generating-processes.html#components-of-a-dgp"><i class="fa fa-check"></i><b>6.2</b> Components of a DGP</a></li>
<li class="chapter" data-level="6.3" data-path="data-generating-processes.html"><a href="data-generating-processes.html#DGP-functions"><i class="fa fa-check"></i><b>6.3</b> A statistical model is a recipe for data generation</a></li>
<li class="chapter" data-level="6.4" data-path="data-generating-processes.html"><a href="data-generating-processes.html#DGP-plotting"><i class="fa fa-check"></i><b>6.4</b> Plot the artificial data</a></li>
<li class="chapter" data-level="6.5" data-path="data-generating-processes.html"><a href="data-generating-processes.html#check-the-data-generating-function"><i class="fa fa-check"></i><b>6.5</b> Check the data-generating function</a></li>
<li class="chapter" data-level="6.6" data-path="data-generating-processes.html"><a href="data-generating-processes.html#case-cluster"><i class="fa fa-check"></i><b>6.6</b> Example: Simulating clustered data</a>
<ul>
<li class="chapter" data-level="6.6.1" data-path="data-generating-processes.html"><a href="data-generating-processes.html#a-design-decision-what-do-we-want-to-manipulate"><i class="fa fa-check"></i><b>6.6.1</b> A design decision: What do we want to manipulate?</a></li>
<li class="chapter" data-level="6.6.2" data-path="data-generating-processes.html"><a href="data-generating-processes.html#a-model-for-a-cluster-rct"><i class="fa fa-check"></i><b>6.6.2</b> A model for a cluster RCT</a></li>
<li class="chapter" data-level="6.6.3" data-path="data-generating-processes.html"><a href="data-generating-processes.html#from-equations-to-code"><i class="fa fa-check"></i><b>6.6.3</b> From equations to code</a></li>
<li class="chapter" data-level="6.6.4" data-path="data-generating-processes.html"><a href="data-generating-processes.html#DGP-standardization"><i class="fa fa-check"></i><b>6.6.4</b> Standardization in the DGP</a></li>
</ul></li>
<li class="chapter" data-level="6.7" data-path="data-generating-processes.html"><a href="data-generating-processes.html#three-parameter-IRT"><i class="fa fa-check"></i><b>6.7</b> Sometimes a DGP is all you need</a></li>
<li class="chapter" data-level="6.8" data-path="data-generating-processes.html"><a href="data-generating-processes.html#more-to-explore"><i class="fa fa-check"></i><b>6.8</b> More to explore</a></li>
<li class="chapter" data-level="6.9" data-path="data-generating-processes.html"><a href="data-generating-processes.html#exercises-3"><i class="fa fa-check"></i><b>6.9</b> Exercises</a>
<ul>
<li class="chapter" data-level="6.9.1" data-path="data-generating-processes.html"><a href="data-generating-processes.html#Welch-t-dgp"><i class="fa fa-check"></i><b>6.9.1</b> The Welch test on a shifted-and-scaled <span class="math inline">\(t\)</span> distribution</a></li>
<li class="chapter" data-level="6.9.2" data-path="data-generating-processes.html"><a href="data-generating-processes.html#plot-the-bivariate-poisson"><i class="fa fa-check"></i><b>6.9.2</b> Plot the bivariate Poisson</a></li>
<li class="chapter" data-level="6.9.3" data-path="data-generating-processes.html"><a href="data-generating-processes.html#BVP-check"><i class="fa fa-check"></i><b>6.9.3</b> Check the bivariate Poisson function</a></li>
<li class="chapter" data-level="6.9.4" data-path="data-generating-processes.html"><a href="data-generating-processes.html#BVP-error"><i class="fa fa-check"></i><b>6.9.4</b> Add error-catching to the bivariate Poisson function</a></li>
<li class="chapter" data-level="6.9.5" data-path="data-generating-processes.html"><a href="data-generating-processes.html#BVNB1"><i class="fa fa-check"></i><b>6.9.5</b> A bivariate negative binomial distribution</a></li>
<li class="chapter" data-level="6.9.6" data-path="data-generating-processes.html"><a href="data-generating-processes.html#BVNB2"><i class="fa fa-check"></i><b>6.9.6</b> Another bivariate negative binomial distribution</a></li>
<li class="chapter" data-level="6.9.7" data-path="data-generating-processes.html"><a href="data-generating-processes.html#cluster-RCT-plot"><i class="fa fa-check"></i><b>6.9.7</b> Plot the data from a cluster-randomized trial</a></li>
<li class="chapter" data-level="6.9.8" data-path="data-generating-processes.html"><a href="data-generating-processes.html#cluster-RCT-checks"><i class="fa fa-check"></i><b>6.9.8</b> Checking the Cluster RCT DGP</a></li>
<li class="chapter" data-level="6.9.9" data-path="data-generating-processes.html"><a href="data-generating-processes.html#cluster-RCT-heterogeneity"><i class="fa fa-check"></i><b>6.9.9</b> More school-level variation</a></li>
<li class="chapter" data-level="6.9.10" data-path="data-generating-processes.html"><a href="data-generating-processes.html#cluster-RCT-baseline"><i class="fa fa-check"></i><b>6.9.10</b> Cluster-randomized trial with baseline predictors</a></li>
<li class="chapter" data-level="6.9.11" data-path="data-generating-processes.html"><a href="data-generating-processes.html#IRT-DGP-parameters"><i class="fa fa-check"></i><b>6.9.11</b> 3-parameter IRT datasets</a></li>
<li class="chapter" data-level="6.9.12" data-path="data-generating-processes.html"><a href="data-generating-processes.html#IRT-DGP-checking"><i class="fa fa-check"></i><b>6.9.12</b> Check the 3-parameter IRT DGP</a></li>
<li class="chapter" data-level="6.9.13" data-path="data-generating-processes.html"><a href="data-generating-processes.html#IRT-DGP-breaking"><i class="fa fa-check"></i><b>6.9.13</b> Explore the 3-parameter IRT model</a></li>
<li class="chapter" data-level="6.9.14" data-path="data-generating-processes.html"><a href="data-generating-processes.html#meta-regression-DGP"><i class="fa fa-check"></i><b>6.9.14</b> Random effects meta-regression</a></li>
<li class="chapter" data-level="6.9.15" data-path="data-generating-processes.html"><a href="data-generating-processes.html#Vevea-Hedges-DGP"><i class="fa fa-check"></i><b>6.9.15</b> Meta-regression with selective reporting</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html"><i class="fa fa-check"></i><b>7</b> Data analysis procedures</a>
<ul>
<li class="chapter" data-level="7.1" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#estimation-functions"><i class="fa fa-check"></i><b>7.1</b> Writing estimation functions</a></li>
<li class="chapter" data-level="7.2" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#multiple-estimation-procedures"><i class="fa fa-check"></i><b>7.2</b> Including Multiple Data Analysis Procedures</a></li>
<li class="chapter" data-level="7.3" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#validating-an-estimation-function"><i class="fa fa-check"></i><b>7.3</b> Validating an Estimation Function</a>
<ul>
<li class="chapter" data-level="7.3.1" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#checking-against-existing-implementations"><i class="fa fa-check"></i><b>7.3.1</b> Checking against existing implementations</a></li>
<li class="chapter" data-level="7.3.2" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#checking-novel-procedures"><i class="fa fa-check"></i><b>7.3.2</b> Checking novel procedures</a></li>
<li class="chapter" data-level="7.3.3" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#checking-with-simulations"><i class="fa fa-check"></i><b>7.3.3</b> Checking with simulations</a></li>
</ul></li>
<li class="chapter" data-level="7.4" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#handling-errors-warnings-and-other-hiccups"><i class="fa fa-check"></i><b>7.4</b> Handling errors, warnings, and other hiccups</a>
<ul>
<li class="chapter" data-level="7.4.1" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#capturing-errors-and-warnings"><i class="fa fa-check"></i><b>7.4.1</b> Capturing errors and warnings</a></li>
<li class="chapter" data-level="7.4.2" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#adapting-for-errors"><i class="fa fa-check"></i><b>7.4.2</b> Adapting estimation procedures for errors and warnings</a></li>
</ul></li>
<li class="chapter" data-level="7.5" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#exercises-4"><i class="fa fa-check"></i><b>7.5</b> Exercises</a>
<ul>
<li class="chapter" data-level="7.5.1" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#BFFs-forever"><i class="fa fa-check"></i><b>7.5.1</b> More Heteroskedastic ANOVA</a></li>
<li class="chapter" data-level="7.5.2" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#contingent-testing"><i class="fa fa-check"></i><b>7.5.2</b> Contingent testing</a></li>
<li class="chapter" data-level="7.5.3" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#cross-check-CRT-estimators"><i class="fa fa-check"></i><b>7.5.3</b> Check the cluster-RCT functions</a></li>
<li class="chapter" data-level="7.5.4" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#CRT-ANCOVA-estimators"><i class="fa fa-check"></i><b>7.5.4</b> Extending the cluster-RCT functions</a></li>
<li class="chapter" data-level="7.5.5" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#contingent-estimator-processing"><i class="fa fa-check"></i><b>7.5.5</b> Contingent estimator processing</a></li>
<li class="chapter" data-level="7.5.6" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#IRT-3PL-estimation"><i class="fa fa-check"></i><b>7.5.6</b> Estimating 3-parameter item response theory models</a></li>
<li class="chapter" data-level="7.5.7" data-path="data-analysis-procedures.html"><a href="data-analysis-procedures.html#Vevea-Hedges-estimation"><i class="fa fa-check"></i><b>7.5.7</b> Meta-regression with selective reporting</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html"><i class="fa fa-check"></i><b>8</b> Running the Simulation Process</a>
<ul>
<li class="chapter" data-level="8.1" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#repeating-oneself"><i class="fa fa-check"></i><b>8.1</b> Repeating oneself</a></li>
<li class="chapter" data-level="8.2" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#one-run-at-a-time"><i class="fa fa-check"></i><b>8.2</b> One run at a time</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#one-run-reparameterization"><i class="fa fa-check"></i><b>8.2.1</b> Reparameterizing</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#bundle-sim-demo"><i class="fa fa-check"></i><b>8.3</b> Bundling simulations with <code>simhelpers</code></a></li>
<li class="chapter" data-level="8.4" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#seeds-and-pseudo-RNGs"><i class="fa fa-check"></i><b>8.4</b> Seeds and pseudo-random number generators</a></li>
<li class="chapter" data-level="8.5" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#exercises-5"><i class="fa fa-check"></i><b>8.5</b> Exercises</a>
<ul>
<li class="chapter" data-level="8.5.1" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#Welch-simulation"><i class="fa fa-check"></i><b>8.5.1</b> Welch simulations</a></li>
<li class="chapter" data-level="8.5.2" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#Pearson-sampling-distributions"><i class="fa fa-check"></i><b>8.5.2</b> Compare sampling distributions of Pearson’s correlation coefficients</a></li>
<li class="chapter" data-level="8.5.3" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#reparameterization-redux"><i class="fa fa-check"></i><b>8.5.3</b> Reparameterization, redux</a></li>
<li class="chapter" data-level="8.5.4" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#fancy-cluster-RCT-sims"><i class="fa fa-check"></i><b>8.5.4</b> Fancy clustered RCT simulations</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="performance-criteria.html"><a href="performance-criteria.html"><i class="fa fa-check"></i><b>9</b> Performance metrics</a>
<ul>
<li class="chapter" data-level="9.1" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-point-estimators"><i class="fa fa-check"></i><b>9.1</b> Metrics for Point Estimators</a>
<ul>
<li class="chapter" data-level="9.1.1" data-path="performance-criteria.html"><a href="performance-criteria.html#clusterRCTperformance"><i class="fa fa-check"></i><b>9.1.1</b> Comparing the Performances of the Cluster RCT Estimation Procedures</a></li>
<li class="chapter" data-level="9.1.2" data-path="performance-criteria.html"><a href="performance-criteria.html#less-conventional-performance-metrics"><i class="fa fa-check"></i><b>9.1.2</b> Less Conventional Performance metrics</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="performance-criteria.html"><a href="performance-criteria.html#metrics-for-standard-error-estimators"><i class="fa fa-check"></i><b>9.2</b> Metrics for Standard Error Estimators</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-ses-for-our-cluster-rct-simulation"><i class="fa fa-check"></i><b>9.2.1</b> Assessing SEs for Our Cluster RCT Simulation</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="performance-criteria.html"><a href="performance-criteria.html#metrics-for-confidence-intervals"><i class="fa fa-check"></i><b>9.3</b> Metrics for Confidence Intervals</a>
<ul>
<li class="chapter" data-level="9.3.1" data-path="performance-criteria.html"><a href="performance-criteria.html#confidence-intervals-in-our-cluster-rct-example"><i class="fa fa-check"></i><b>9.3.1</b> Confidence Intervals in our Cluster RCT Example</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-inferential-procedures"><i class="fa fa-check"></i><b>9.4</b> Metrics for Inferential Procedures (Hypothesis Tests)</a>
<ul>
<li class="chapter" data-level="9.4.1" data-path="performance-criteria.html"><a href="performance-criteria.html#validity"><i class="fa fa-check"></i><b>9.4.1</b> Validity</a></li>
<li class="chapter" data-level="9.4.2" data-path="performance-criteria.html"><a href="performance-criteria.html#power"><i class="fa fa-check"></i><b>9.4.2</b> Power</a></li>
<li class="chapter" data-level="9.4.3" data-path="performance-criteria.html"><a href="performance-criteria.html#the-rejection-rate"><i class="fa fa-check"></i><b>9.4.3</b> The Rejection Rate</a></li>
<li class="chapter" data-level="9.4.4" data-path="performance-criteria.html"><a href="performance-criteria.html#inference-in-our-cluster-rct-simulation"><i class="fa fa-check"></i><b>9.4.4</b> Inference in our Cluster RCT Simulation</a></li>
</ul></li>
<li class="chapter" data-level="9.5" data-path="performance-criteria.html"><a href="performance-criteria.html#sec-relative-performance"><i class="fa fa-check"></i><b>9.5</b> Selecting Relative vs. Absolute Metrics</a></li>
<li class="chapter" data-level="9.6" data-path="performance-criteria.html"><a href="performance-criteria.html#summary-of-peformance-measures"><i class="fa fa-check"></i><b>9.6</b> Summary of Peformance Measures</a>
<ul>
<li class="chapter" data-level="9.6.1" data-path="performance-criteria.html"><a href="performance-criteria.html#windsorization-to-control-outliers"><i class="fa fa-check"></i><b>9.6.1</b> Windsorization to control outliers</a></li>
<li class="chapter" data-level="9.6.2" data-path="performance-criteria.html"><a href="performance-criteria.html#correlation-measures-vs-absolute-performance"><i class="fa fa-check"></i><b>9.6.2</b> Correlation measures vs absolute performance</a></li>
</ul></li>
<li class="chapter" data-level="9.7" data-path="performance-criteria.html"><a href="performance-criteria.html#summary-of-peformance-measures-1"><i class="fa fa-check"></i><b>9.7</b> Summary of Peformance Measures</a></li>
<li class="chapter" data-level="9.8" data-path="performance-criteria.html"><a href="performance-criteria.html#implicit-estimands"><i class="fa fa-check"></i><b>9.8</b> Estimands Not Represented By a Parameter</a></li>
<li class="chapter" data-level="9.9" data-path="performance-criteria.html"><a href="performance-criteria.html#MCSE"><i class="fa fa-check"></i><b>9.9</b> Uncertainty in Performance Estimates (the Monte Carlo Standard Error)</a>
<ul>
<li class="chapter" data-level="9.9.1" data-path="performance-criteria.html"><a href="performance-criteria.html#mcse-for-relative-variance-estimators"><i class="fa fa-check"></i><b>9.9.1</b> MCSE for Relative Variance Estimators</a></li>
<li class="chapter" data-level="9.9.2" data-path="performance-criteria.html"><a href="performance-criteria.html#calculating-mcses-with-the-simhelpers-package"><i class="fa fa-check"></i><b>9.9.2</b> Calculating MCSEs With the <code>simhelpers</code> Package</a></li>
<li class="chapter" data-level="9.9.3" data-path="performance-criteria.html"><a href="performance-criteria.html#mcse-calculation-in-our-cluster-rct-example"><i class="fa fa-check"></i><b>9.9.3</b> MCSE Calculation in our Cluster RCT Example</a></li>
</ul></li>
<li class="chapter" data-level="9.10" data-path="performance-criteria.html"><a href="performance-criteria.html#concluding-thoughts"><i class="fa fa-check"></i><b>9.10</b> Concluding thoughts</a></li>
<li class="chapter" data-level="9.11" data-path="performance-criteria.html"><a href="performance-criteria.html#exercises-6"><i class="fa fa-check"></i><b>9.11</b> Exercises</a>
<ul>
<li class="chapter" data-level="9.11.1" data-path="performance-criteria.html"><a href="performance-criteria.html#Brown-Forsythe-performance"><i class="fa fa-check"></i><b>9.11.1</b> Brown and Forsythe (1974)</a></li>
<li class="chapter" data-level="9.11.2" data-path="performance-criteria.html"><a href="performance-criteria.html#jackknife-MCSE"><i class="fa fa-check"></i><b>9.11.2</b> Jackknife calculation of MCSEs</a></li>
<li class="chapter" data-level="9.11.3" data-path="performance-criteria.html"><a href="performance-criteria.html#cluster-RCT-SPATE"><i class="fa fa-check"></i><b>9.11.3</b> Distribution theory for person-level average treatment effects</a></li>
<li class="chapter" data-level="9.11.4" data-path="performance-criteria.html"><a href="performance-criteria.html#multiple-scenario-performance"><i class="fa fa-check"></i><b>9.11.4</b> Multiple scenarios</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>III Multifactor Simulations</b></span></li>
<li class="chapter" data-level="10" data-path="exp-design.html"><a href="exp-design.html"><i class="fa fa-check"></i><b>10</b> Designing and executing multifactor simulations</a>
<ul>
<li class="chapter" data-level="10.1" data-path="exp-design.html"><a href="exp-design.html#choosing-parameter-combinations"><i class="fa fa-check"></i><b>10.1</b> Choosing parameter combinations</a></li>
<li class="chapter" data-level="10.2" data-path="exp-design.html"><a href="exp-design.html#using-pmap-to-run-multifactor-simulations"><i class="fa fa-check"></i><b>10.2</b> Using pmap to run multifactor simulations</a></li>
<li class="chapter" data-level="10.3" data-path="exp-design.html"><a href="exp-design.html#when-to-calculate-performance-metrics"><i class="fa fa-check"></i><b>10.3</b> When to calculate performance metrics</a>
<ul>
<li class="chapter" data-level="10.3.1" data-path="exp-design.html"><a href="exp-design.html#aggregate-as-you-simulate-inside"><i class="fa fa-check"></i><b>10.3.1</b> Aggregate as you simulate (inside)</a></li>
<li class="chapter" data-level="10.3.2" data-path="exp-design.html"><a href="exp-design.html#keep-all-simulation-runs-outside"><i class="fa fa-check"></i><b>10.3.2</b> Keep all simulation runs (outside)</a></li>
<li class="chapter" data-level="10.3.3" data-path="exp-design.html"><a href="exp-design.html#getting-raw-results-ready-for-analysis"><i class="fa fa-check"></i><b>10.3.3</b> Getting raw results ready for analysis</a></li>
</ul></li>
<li class="chapter" data-level="10.4" data-path="exp-design.html"><a href="exp-design.html#summary"><i class="fa fa-check"></i><b>10.4</b> Summary</a></li>
<li class="chapter" data-level="10.5" data-path="exp-design.html"><a href="exp-design.html#case-study-a-multifactor-evaluation-of-cluster-rct-estimators"><i class="fa fa-check"></i><b>10.5</b> Case Study: A multifactor evaluation of cluster RCT estimators</a>
<ul>
<li class="chapter" data-level="10.5.1" data-path="exp-design.html"><a href="exp-design.html#choosing-parameters-for-the-clustered-rct"><i class="fa fa-check"></i><b>10.5.1</b> Choosing parameters for the Clustered RCT</a></li>
<li class="chapter" data-level="10.5.2" data-path="exp-design.html"><a href="exp-design.html#redundant-factor-combinations"><i class="fa fa-check"></i><b>10.5.2</b> Redundant factor combinations</a></li>
<li class="chapter" data-level="10.5.3" data-path="exp-design.html"><a href="exp-design.html#running-the-simulations"><i class="fa fa-check"></i><b>10.5.3</b> Running the simulations</a></li>
<li class="chapter" data-level="10.5.4" data-path="exp-design.html"><a href="exp-design.html#calculating-performance-metrics"><i class="fa fa-check"></i><b>10.5.4</b> Calculating performance metrics</a></li>
</ul></li>
<li class="chapter" data-level="10.6" data-path="exp-design.html"><a href="exp-design.html#exercises-7"><i class="fa fa-check"></i><b>10.6</b> Exercises</a>
<ul>
<li class="chapter" data-level="10.6.1" data-path="exp-design.html"><a href="exp-design.html#brown-and-forsythe-redux"><i class="fa fa-check"></i><b>10.6.1</b> Brown and Forsythe redux</a></li>
<li class="chapter" data-level="10.6.2" data-path="exp-design.html"><a href="exp-design.html#meta-regression"><i class="fa fa-check"></i><b>10.6.2</b> Meta-regression</a></li>
<li class="chapter" data-level="10.6.3" data-path="exp-design.html"><a href="exp-design.html#exercise:trimmed-mean"><i class="fa fa-check"></i><b>10.6.3</b> Comparing the trimmed mean, median and mean</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="11" data-path="presentation-of-results.html"><a href="presentation-of-results.html"><i class="fa fa-check"></i><b>11</b> Exploring and presenting simulation results</a>
<ul>
<li class="chapter" data-level="11.1" data-path="presentation-of-results.html"><a href="presentation-of-results.html#tabulation"><i class="fa fa-check"></i><b>11.1</b> Tabulation</a>
<ul>
<li class="chapter" data-level="11.1.1" data-path="presentation-of-results.html"><a href="presentation-of-results.html#example-estimators-of-treatment-variation"><i class="fa fa-check"></i><b>11.1.1</b> Example: estimators of treatment variation</a></li>
</ul></li>
<li class="chapter" data-level="11.2" data-path="presentation-of-results.html"><a href="presentation-of-results.html#visualization"><i class="fa fa-check"></i><b>11.2</b> Visualization</a>
<ul>
<li class="chapter" data-level="11.2.1" data-path="presentation-of-results.html"><a href="presentation-of-results.html#example-0-rmse-in-cluster-rcts"><i class="fa fa-check"></i><b>11.2.1</b> Example 0: RMSE in Cluster RCTs</a></li>
<li class="chapter" data-level="11.2.2" data-path="presentation-of-results.html"><a href="presentation-of-results.html#example-1-biserial-correlation-estimation"><i class="fa fa-check"></i><b>11.2.2</b> Example 1: Biserial correlation estimation</a></li>
<li class="chapter" data-level="11.2.3" data-path="presentation-of-results.html"><a href="presentation-of-results.html#example-2-variance-estimation-and-meta-regression"><i class="fa fa-check"></i><b>11.2.3</b> Example 2: Variance estimation and Meta-regression</a></li>
<li class="chapter" data-level="11.2.4" data-path="presentation-of-results.html"><a href="presentation-of-results.html#example-3-heat-maps-of-coverage"><i class="fa fa-check"></i><b>11.2.4</b> Example 3: Heat maps of coverage</a></li>
<li class="chapter" data-level="11.2.5" data-path="presentation-of-results.html"><a href="presentation-of-results.html#example-4-relative-performance-of-treatment-effect-estimators"><i class="fa fa-check"></i><b>11.2.5</b> Example 4: Relative performance of treatment effect estimators</a></li>
</ul></li>
<li class="chapter" data-level="11.3" data-path="presentation-of-results.html"><a href="presentation-of-results.html#modeling"><i class="fa fa-check"></i><b>11.3</b> Modeling</a>
<ul>
<li class="chapter" data-level="11.3.1" data-path="presentation-of-results.html"><a href="presentation-of-results.html#example-1-biserial-revisited"><i class="fa fa-check"></i><b>11.3.1</b> Example 1: Biserial, revisited</a></li>
<li class="chapter" data-level="11.3.2" data-path="presentation-of-results.html"><a href="presentation-of-results.html#example-2-comparing-methods-for-cross-classified-data"><i class="fa fa-check"></i><b>11.3.2</b> Example 2: Comparing methods for cross-classified data</a></li>
</ul></li>
<li class="chapter" data-level="11.4" data-path="presentation-of-results.html"><a href="presentation-of-results.html#reporting"><i class="fa fa-check"></i><b>11.4</b> Reporting</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="building-good-visualization.html"><a href="building-good-visualization.html"><i class="fa fa-check"></i><b>12</b> Building good visualizations</a>
<ul>
<li class="chapter" data-level="12.1" data-path="building-good-visualization.html"><a href="building-good-visualization.html#subsetting-and-many-small-multiples"><i class="fa fa-check"></i><b>12.1</b> Subsetting and Many Small Multiples</a></li>
<li class="chapter" data-level="12.2" data-path="building-good-visualization.html"><a href="building-good-visualization.html#bundling"><i class="fa fa-check"></i><b>12.2</b> Bundling</a></li>
<li class="chapter" data-level="12.3" data-path="building-good-visualization.html"><a href="building-good-visualization.html#aggregation"><i class="fa fa-check"></i><b>12.3</b> Aggregation</a></li>
<li class="chapter" data-level="12.4" data-path="building-good-visualization.html"><a href="building-good-visualization.html#assessing-true-ses"><i class="fa fa-check"></i><b>12.4</b> Assessing true SEs</a></li>
<li class="chapter" data-level="12.5" data-path="building-good-visualization.html"><a href="building-good-visualization.html#the-bias-se-rmse-plot"><i class="fa fa-check"></i><b>12.5</b> The Bias-SE-RMSE plot</a></li>
<li class="chapter" data-level="12.6" data-path="building-good-visualization.html"><a href="building-good-visualization.html#assessing-estimated-ses"><i class="fa fa-check"></i><b>12.6</b> Assessing estimated SEs</a></li>
<li class="chapter" data-level="12.7" data-path="building-good-visualization.html"><a href="building-good-visualization.html#assessing-confidence-intervals"><i class="fa fa-check"></i><b>12.7</b> Assessing confidence intervals</a></li>
<li class="chapter" data-level="12.8" data-path="building-good-visualization.html"><a href="building-good-visualization.html#exercises-8"><i class="fa fa-check"></i><b>12.8</b> Exercises</a>
<ul>
<li class="chapter" data-level="12.8.1" data-path="building-good-visualization.html"><a href="building-good-visualization.html#assessing-uncertainty"><i class="fa fa-check"></i><b>12.8.1</b> Assessing uncertainty</a></li>
<li class="chapter" data-level="12.8.2" data-path="building-good-visualization.html"><a href="building-good-visualization.html#assessing-power"><i class="fa fa-check"></i><b>12.8.2</b> Assessing power</a></li>
<li class="chapter" data-level="12.8.3" data-path="building-good-visualization.html"><a href="building-good-visualization.html#going-deeper-with-coverage"><i class="fa fa-check"></i><b>12.8.3</b> Going deeper with coverage</a></li>
<li class="chapter" data-level="12.8.4" data-path="building-good-visualization.html"><a href="building-good-visualization.html#pearson-correlations-with-a-bivariate-poisson-distribution"><i class="fa fa-check"></i><b>12.8.4</b> Pearson correlations with a bivariate Poisson distribution</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="13" data-path="special-topics-on-reporting-simulation-results.html"><a href="special-topics-on-reporting-simulation-results.html"><i class="fa fa-check"></i><b>13</b> Special Topics on Reporting Simulation Results</a>
<ul>
<li class="chapter" data-level="13.1" data-path="special-topics-on-reporting-simulation-results.html"><a href="special-topics-on-reporting-simulation-results.html#using-regression-to-analyze-simulation-results"><i class="fa fa-check"></i><b>13.1</b> Using regression to analyze simulation results</a>
<ul>
<li class="chapter" data-level="13.1.1" data-path="special-topics-on-reporting-simulation-results.html"><a href="special-topics-on-reporting-simulation-results.html#example-1-biserial-revisited-1"><i class="fa fa-check"></i><b>13.1.1</b> Example 1: Biserial, revisited</a></li>
<li class="chapter" data-level="13.1.2" data-path="special-topics-on-reporting-simulation-results.html"><a href="special-topics-on-reporting-simulation-results.html#example-2-cluster-rct-example-revisited"><i class="fa fa-check"></i><b>13.1.2</b> Example 2: Cluster RCT example, revisited</a></li>
</ul></li>
<li class="chapter" data-level="13.2" data-path="special-topics-on-reporting-simulation-results.html"><a href="special-topics-on-reporting-simulation-results.html#using-regression-trees-to-find-important-factors"><i class="fa fa-check"></i><b>13.2</b> Using regression trees to find important factors</a></li>
<li class="chapter" data-level="13.3" data-path="special-topics-on-reporting-simulation-results.html"><a href="special-topics-on-reporting-simulation-results.html#analyzing-results-with-few-iterations-per-scenario"><i class="fa fa-check"></i><b>13.3</b> Analyzing results with few iterations per scenario</a>
<ul>
<li class="chapter" data-level="13.3.1" data-path="special-topics-on-reporting-simulation-results.html"><a href="special-topics-on-reporting-simulation-results.html#example-clusterrct-with-only-100-replicates-per-scenario"><i class="fa fa-check"></i><b>13.3.1</b> Example: ClusterRCT with only 100 replicates per scenario</a></li>
</ul></li>
<li class="chapter" data-level="13.4" data-path="special-topics-on-reporting-simulation-results.html"><a href="special-topics-on-reporting-simulation-results.html#what-to-do-with-warnings-in-simulations"><i class="fa fa-check"></i><b>13.4</b> What to do with warnings in simulations</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="case-study-comparing-different-estimators.html"><a href="case-study-comparing-different-estimators.html"><i class="fa fa-check"></i><b>14</b> Case study: Comparing different estimators</a>
<ul>
<li class="chapter" data-level="14.1" data-path="case-study-comparing-different-estimators.html"><a href="case-study-comparing-different-estimators.html#bias-variance-tradeoffs"><i class="fa fa-check"></i><b>14.1</b> Bias-variance tradeoffs</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html"><i class="fa fa-check"></i><b>15</b> Simulations as evidence</a>
<ul>
<li class="chapter" data-level="15.1" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#strategies-for-making-relevant-simulations"><i class="fa fa-check"></i><b>15.1</b> Strategies for making relevant simulations</a>
<ul>
<li class="chapter" data-level="15.1.1" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#break-symmetries-and-regularities"><i class="fa fa-check"></i><b>15.1.1</b> Break symmetries and regularities</a></li>
<li class="chapter" data-level="15.1.2" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#make-your-simulation-general-with-an-extensive-multi-factor-experiment"><i class="fa fa-check"></i><b>15.1.2</b> Make your simulation general with an extensive multi-factor experiment</a></li>
<li class="chapter" data-level="15.1.3" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#use-previously-published-simulations-to-beat-them-at-their-own-game"><i class="fa fa-check"></i><b>15.1.3</b> Use previously published simulations to beat them at their own game</a></li>
<li class="chapter" data-level="15.1.4" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#calibrate-simulation-factors-to-real-data"><i class="fa fa-check"></i><b>15.1.4</b> Calibrate simulation factors to real data</a></li>
<li class="chapter" data-level="15.1.5" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#use-real-data-to-obtain-directly"><i class="fa fa-check"></i><b>15.1.5</b> Use real data to obtain directly</a></li>
<li class="chapter" data-level="15.1.6" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#fully-calibrated-simulations"><i class="fa fa-check"></i><b>15.1.6</b> Fully calibrated simulations</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>IV Computational Considerations</b></span></li>
<li class="chapter" data-level="16" data-path="organizing-a-simulation-project.html"><a href="organizing-a-simulation-project.html"><i class="fa fa-check"></i><b>16</b> Organizing a simulation project</a>
<ul>
<li class="chapter" data-level="16.1" data-path="organizing-a-simulation-project.html"><a href="organizing-a-simulation-project.html#well-structured-r-scripts"><i class="fa fa-check"></i><b>16.1</b> Well structured R scripts</a>
<ul>
<li class="chapter" data-level="16.1.1" data-path="organizing-a-simulation-project.html"><a href="organizing-a-simulation-project.html#about-source-command"><i class="fa fa-check"></i><b>16.1.1</b> The source command</a></li>
<li class="chapter" data-level="16.1.2" data-path="organizing-a-simulation-project.html"><a href="organizing-a-simulation-project.html#putting-headers-in-your-.r-file"><i class="fa fa-check"></i><b>16.1.2</b> Putting headers in your .R file</a></li>
<li class="chapter" data-level="16.1.3" data-path="organizing-a-simulation-project.html"><a href="organizing-a-simulation-project.html#about-keeping-tests-with-FALSE"><i class="fa fa-check"></i><b>16.1.3</b> Storing testing code in your scripts</a></li>
</ul></li>
<li class="chapter" data-level="16.2" data-path="organizing-a-simulation-project.html"><a href="organizing-a-simulation-project.html#principled-directory-structures"><i class="fa fa-check"></i><b>16.2</b> Principled directory structures</a></li>
<li class="chapter" data-level="16.3" data-path="organizing-a-simulation-project.html"><a href="organizing-a-simulation-project.html#saving-files"><i class="fa fa-check"></i><b>16.3</b> Saving simulation results</a>
<ul>
<li class="chapter" data-level="16.3.1" data-path="organizing-a-simulation-project.html"><a href="organizing-a-simulation-project.html#saving-simulations-in-general"><i class="fa fa-check"></i><b>16.3.1</b> Saving simulations in general</a></li>
<li class="chapter" data-level="16.3.2" data-path="organizing-a-simulation-project.html"><a href="organizing-a-simulation-project.html#saving-simulations-as-you-go"><i class="fa fa-check"></i><b>16.3.2</b> Saving simulations as you go</a></li>
<li class="chapter" data-level="16.3.3" data-path="organizing-a-simulation-project.html"><a href="organizing-a-simulation-project.html#dynamically-making-directories"><i class="fa fa-check"></i><b>16.3.3</b> Dynamically making directories</a></li>
<li class="chapter" data-level="16.3.4" data-path="organizing-a-simulation-project.html"><a href="organizing-a-simulation-project.html#loading-and-combining-files-of-simulation-results"><i class="fa fa-check"></i><b>16.3.4</b> Loading and combining files of simulation results</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="17" data-path="parallel-processing.html"><a href="parallel-processing.html"><i class="fa fa-check"></i><b>17</b> Parallel Processing</a>
<ul>
<li class="chapter" data-level="17.1" data-path="parallel-processing.html"><a href="parallel-processing.html#parallel-on-your-computer"><i class="fa fa-check"></i><b>17.1</b> Parallel on your computer</a></li>
<li class="chapter" data-level="17.2" data-path="parallel-processing.html"><a href="parallel-processing.html#parallel-on-a-virtual-machine"><i class="fa fa-check"></i><b>17.2</b> Parallel on a virtual machine</a></li>
<li class="chapter" data-level="17.3" data-path="parallel-processing.html"><a href="parallel-processing.html#parallel-on-a-cluster"><i class="fa fa-check"></i><b>17.3</b> Parallel on a cluster</a>
<ul>
<li class="chapter" data-level="17.3.1" data-path="parallel-processing.html"><a href="parallel-processing.html#what-is-a-command-line-interface"><i class="fa fa-check"></i><b>17.3.1</b> What is a command-line interface?</a></li>
<li class="chapter" data-level="17.3.2" data-path="parallel-processing.html"><a href="parallel-processing.html#running-a-job-on-a-cluster"><i class="fa fa-check"></i><b>17.3.2</b> Running a job on a cluster</a></li>
<li class="chapter" data-level="17.3.3" data-path="parallel-processing.html"><a href="parallel-processing.html#checking-on-a-job"><i class="fa fa-check"></i><b>17.3.3</b> Checking on a job</a></li>
<li class="chapter" data-level="17.3.4" data-path="parallel-processing.html"><a href="parallel-processing.html#running-lots-of-jobs-on-a-cluster"><i class="fa fa-check"></i><b>17.3.4</b> Running lots of jobs on a cluster</a></li>
<li class="chapter" data-level="17.3.5" data-path="parallel-processing.html"><a href="parallel-processing.html#resources-for-harvards-odyssey"><i class="fa fa-check"></i><b>17.3.5</b> Resources for Harvard’s Odyssey</a></li>
<li class="chapter" data-level="17.3.6" data-path="parallel-processing.html"><a href="parallel-processing.html#acknowledgements-1"><i class="fa fa-check"></i><b>17.3.6</b> Acknowledgements</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="18" data-path="debugging-and-testing.html"><a href="debugging-and-testing.html"><i class="fa fa-check"></i><b>18</b> Debugging and Testing</a>
<ul>
<li class="chapter" data-level="18.1" data-path="debugging-and-testing.html"><a href="debugging-and-testing.html#about-print"><i class="fa fa-check"></i><b>18.1</b> Debugging with <code>print()</code></a></li>
<li class="chapter" data-level="18.2" data-path="debugging-and-testing.html"><a href="debugging-and-testing.html#about-browser-debugging"><i class="fa fa-check"></i><b>18.2</b> Debugging with <code>browser()</code></a></li>
<li class="chapter" data-level="18.3" data-path="debugging-and-testing.html"><a href="debugging-and-testing.html#debugging-with-debug"><i class="fa fa-check"></i><b>18.3</b> Debugging with <code>debug()</code></a></li>
<li class="chapter" data-level="18.4" data-path="debugging-and-testing.html"><a href="debugging-and-testing.html#about-stopifnot"><i class="fa fa-check"></i><b>18.4</b> Protecting functions with <code>stop()</code></a></li>
<li class="chapter" data-level="18.5" data-path="debugging-and-testing.html"><a href="debugging-and-testing.html#testing-code"><i class="fa fa-check"></i><b>18.5</b> Testing code</a></li>
</ul></li>
<li class="part"><span><b>V Complex Data Structures</b></span></li>
<li class="chapter" data-level="19" data-path="sec:power.html"><a href="sec:power.html"><i class="fa fa-check"></i><b>19</b> Using simulation as a power calculator</a>
<ul>
<li class="chapter" data-level="19.1" data-path="sec:power.html"><a href="sec:power.html#getting-design-parameters-from-pilot-data"><i class="fa fa-check"></i><b>19.1</b> Getting design parameters from pilot data</a></li>
<li class="chapter" data-level="19.2" data-path="sec:power.html"><a href="sec:power.html#the-data-generating-process"><i class="fa fa-check"></i><b>19.2</b> The data generating process</a></li>
<li class="chapter" data-level="19.3" data-path="sec:power.html"><a href="sec:power.html#running-the-simulation-1"><i class="fa fa-check"></i><b>19.3</b> Running the simulation</a></li>
<li class="chapter" data-level="19.4" data-path="sec:power.html"><a href="sec:power.html#evaluating-power"><i class="fa fa-check"></i><b>19.4</b> Evaluating power</a>
<ul>
<li class="chapter" data-level="19.4.1" data-path="sec:power.html"><a href="sec:power.html#checking-validity-of-our-models"><i class="fa fa-check"></i><b>19.4.1</b> Checking validity of our models</a></li>
<li class="chapter" data-level="19.4.2" data-path="sec:power.html"><a href="sec:power.html#assessing-precision-se"><i class="fa fa-check"></i><b>19.4.2</b> Assessing Precision (SE)</a></li>
<li class="chapter" data-level="19.4.3" data-path="sec:power.html"><a href="sec:power.html#assessing-power-1"><i class="fa fa-check"></i><b>19.4.3</b> Assessing power</a></li>
<li class="chapter" data-level="19.4.4" data-path="sec:power.html"><a href="sec:power.html#assessing-minimum-detectable-effects"><i class="fa fa-check"></i><b>19.4.4</b> Assessing Minimum Detectable Effects</a></li>
</ul></li>
<li class="chapter" data-level="19.5" data-path="sec:power.html"><a href="sec:power.html#power-for-multilevel-data"><i class="fa fa-check"></i><b>19.5</b> Power for Multilevel Data</a></li>
</ul></li>
<li class="chapter" data-level="20" data-path="potential-outcomes.html"><a href="potential-outcomes.html"><i class="fa fa-check"></i><b>20</b> Simulation under the Potential Outcomes Framework</a>
<ul>
<li class="chapter" data-level="20.1" data-path="potential-outcomes.html"><a href="potential-outcomes.html#finite-vs.-superpopulation-inference"><i class="fa fa-check"></i><b>20.1</b> Finite vs. Superpopulation inference</a></li>
<li class="chapter" data-level="20.2" data-path="potential-outcomes.html"><a href="potential-outcomes.html#data-generation-processes-for-potential-outcomes"><i class="fa fa-check"></i><b>20.2</b> Data generation processes for potential outcomes</a></li>
<li class="chapter" data-level="20.3" data-path="potential-outcomes.html"><a href="potential-outcomes.html#finite-sample-performance-measures"><i class="fa fa-check"></i><b>20.3</b> Finite sample performance measures</a></li>
<li class="chapter" data-level="20.4" data-path="potential-outcomes.html"><a href="potential-outcomes.html#nested-finite-simulation-procedure"><i class="fa fa-check"></i><b>20.4</b> Nested finite simulation procedure</a></li>
</ul></li>
<li class="chapter" data-level="21" data-path="the-parametric-bootstrap.html"><a href="the-parametric-bootstrap.html"><i class="fa fa-check"></i><b>21</b> The Parametric bootstrap</a>
<ul>
<li class="chapter" data-level="21.1" data-path="the-parametric-bootstrap.html"><a href="the-parametric-bootstrap.html#air-conditioners-a-stolen-case-study"><i class="fa fa-check"></i><b>21.1</b> Air conditioners: a stolen case study</a></li>
</ul></li>
<li class="appendix"><span><b>Appendices</b></span></li>
<li class="chapter" data-level="A" data-path="coding-tidbits.html"><a href="coding-tidbits.html"><i class="fa fa-check"></i><b>A</b> Coding Reference</a>
<ul>
<li class="chapter" data-level="A.1" data-path="coding-tidbits.html"><a href="coding-tidbits.html#more-repeating-oneself"><i class="fa fa-check"></i><b>A.1</b> How to repeat yourself</a>
<ul>
<li class="chapter" data-level="A.1.1" data-path="coding-tidbits.html"><a href="coding-tidbits.html#using-replicate"><i class="fa fa-check"></i><b>A.1.1</b> Using <code>replicate()</code></a></li>
<li class="chapter" data-level="A.1.2" data-path="coding-tidbits.html"><a href="coding-tidbits.html#using-map"><i class="fa fa-check"></i><b>A.1.2</b> Using <code>map()</code></a></li>
<li class="chapter" data-level="A.1.3" data-path="coding-tidbits.html"><a href="coding-tidbits.html#map-with-no-inputs"><i class="fa fa-check"></i><b>A.1.3</b> map with no inputs</a></li>
<li class="chapter" data-level="A.1.4" data-path="coding-tidbits.html"><a href="coding-tidbits.html#other-approaches-for-repetition"><i class="fa fa-check"></i><b>A.1.4</b> Other approaches for repetition</a></li>
</ul></li>
<li class="chapter" data-level="A.2" data-path="coding-tidbits.html"><a href="coding-tidbits.html#default-arguments"><i class="fa fa-check"></i><b>A.2</b> Default arguments for functions</a></li>
<li class="chapter" data-level="A.3" data-path="coding-tidbits.html"><a href="coding-tidbits.html#profiling-code"><i class="fa fa-check"></i><b>A.3</b> Profiling Code</a>
<ul>
<li class="chapter" data-level="A.3.1" data-path="coding-tidbits.html"><a href="coding-tidbits.html#using-sys.time-and-system.time"><i class="fa fa-check"></i><b>A.3.1</b> Using <code>Sys.time()</code> and <code>system.time()</code></a></li>
<li class="chapter" data-level="A.3.2" data-path="coding-tidbits.html"><a href="coding-tidbits.html#the-tictoc-package"><i class="fa fa-check"></i><b>A.3.2</b> The <code>tictoc</code> package</a></li>
<li class="chapter" data-level="A.3.3" data-path="coding-tidbits.html"><a href="coding-tidbits.html#the-bench-package"><i class="fa fa-check"></i><b>A.3.3</b> The <code>bench</code> package</a></li>
<li class="chapter" data-level="A.3.4" data-path="coding-tidbits.html"><a href="coding-tidbits.html#profiling-with-profvis"><i class="fa fa-check"></i><b>A.3.4</b> Profiling with <code>profvis</code></a></li>
</ul></li>
<li class="chapter" data-level="A.4" data-path="coding-tidbits.html"><a href="coding-tidbits.html#optimize-code"><i class="fa fa-check"></i><b>A.4</b> Optimizing code (and why you often shouldn’t)</a>
<ul>
<li class="chapter" data-level="A.4.1" data-path="coding-tidbits.html"><a href="coding-tidbits.html#hand-building-functions"><i class="fa fa-check"></i><b>A.4.1</b> Hand-building functions</a></li>
<li class="chapter" data-level="A.4.2" data-path="coding-tidbits.html"><a href="coding-tidbits.html#sec_comp_efficiency"><i class="fa fa-check"></i><b>A.4.2</b> Computational efficiency versus simplicity</a></li>
<li class="chapter" data-level="A.4.3" data-path="coding-tidbits.html"><a href="coding-tidbits.html#reusing-code-to-speed-up-computation"><i class="fa fa-check"></i><b>A.4.3</b> Reusing code to speed up computation</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="B" data-path="further-readings-and-resources.html"><a href="further-readings-and-resources.html"><i class="fa fa-check"></i><b>B</b> Further readings and resources</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Designing Monte Carlo Simulations in R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="exp-design" class="section level1 hasAnchor" number="10">
<h1><span class="header-section-number">Chapter 10</span> Designing and executing multifactor simulations<a href="exp-design.html#exp-design" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Thus far, we have created code that will run a simulation for a single combination of parameter values.
In practice, simulation studies typically examine a range of different values, including varying the levels of the focal parameter values, auxiliary parameters, sample size, and possibly other design parameters, to explore a range of different scenarios.
We either want reassurance that our findings are general, or we want to understand what aspects of the context affect the performance of the estimator or estimators we are studying.
A single simulation gives us no hint as to either of these questions.
It is only by looking across a range of settings that we can hope to understand trade-offs, general rules, and limits.
Let’s now look at the remaining piece of the simulation puzzle: the study’s experimental design.</p>
<p>Simulation studies often take the form of <strong>full factorial</strong> designed experiments.
In full factorials, each factor (a particular knob a researcher might turn to change the simulation conditions) is varied across multiple levels, and the design includes <em>every</em> possible combination of the levels of every factor. One way to represent such a design is as a list of the factors and levels to be explored.</p>
<p>For example, consider a simulation study examining the performance of confidence intervals for Pearson’s correlation coefficient under a bivariate Poisson distribution.
We examined this data-generating model in Section <a href="data-generating-processes.html#BVPois-example">6.1.2</a>, implementing it in the function <code>r_bivariate_Poisson()</code>. The model has three parameters (the means of each variate, <span class="math inline">\(\mu_1, \mu_2\)</span> and the correlation <span class="math inline">\(\rho\)</span>) and there is one design parameter (sample size, <span class="math inline">\(N\)</span>).
Thus, we could in principle examine up to four factors.</p>
<p>Using these parameters directly as factors in the simulation design will lead to considerable redundancy because of the symmetry of the model: generating data with <span class="math inline">\(\mu_1 = 10\)</span> and <span class="math inline">\(\mu_2 = 5\)</span> would lead to identical correlations as using <span class="math inline">\(\mu_1 = 5\)</span> and <span class="math inline">\(\mu_2 = 10\)</span>.
It is useful to re-parameterize to reduce redundancy and simply things.
We will therefore define the simulation conditions by always treating <span class="math inline">\(\mu_1\)</span> as the larger variate and by specifying the ratio of the smaller to the larger mean as <span class="math inline">\(\lambda = \mu_2 / \mu_1\)</span>.
We might then examine the following factors:</p>
<ul>
<li>the sample size, with values of <span class="math inline">\(N = 10, 20\)</span>, or <span class="math inline">\(30\)</span></li>
<li>the mean of the larger variate, with values of <span class="math inline">\(\mu_1 = 4, 8\)</span>, or <span class="math inline">\(12\)</span></li>
<li>the ratio of means, with values of <span class="math inline">\(\lambda = 0.5\)</span> or <span class="math inline">\(1.0\)</span>.</li>
<li>the true correlation, with values ranging from <span class="math inline">\(\rho = 0.0\)</span> to <span class="math inline">\(0.7\)</span> in steps of <span class="math inline">\(0.1\)</span></li>
</ul>
<p>The above parameters describe a <span class="math inline">\(3 \times 3 \times 2 \times 8\)</span> factorial design, where each element is the number of levels for that factor. This is a four-factor experiment, because we have four different things we are varying.</p>
<p>To implement this design in code, we first save the simulation parameters as a list with one entry per factor, where each entry consists of the levels that we would like to explore.
We will run a simulation for every possible combination of these values.
Here is code that generates all of the scenarios given the above design, storing these combinations in a data frame, <code>params</code>, that represents the full experimental design:</p>
<div class="sourceCode" id="cb363"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb363-1"><a href="exp-design.html#cb363-1" tabindex="-1"></a>design_factors <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb363-2"><a href="exp-design.html#cb363-2" tabindex="-1"></a>  <span class="at">N =</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">30</span>),</span>
<span id="cb363-3"><a href="exp-design.html#cb363-3" tabindex="-1"></a>  <span class="at">mu1 =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">8</span>, <span class="dv">12</span>),</span>
<span id="cb363-4"><a href="exp-design.html#cb363-4" tabindex="-1"></a>  <span class="at">lambda =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">1.0</span>),</span>
<span id="cb363-5"><a href="exp-design.html#cb363-5" tabindex="-1"></a>  <span class="at">rho =</span> <span class="fu">seq</span>(<span class="fl">0.0</span>, <span class="fl">0.7</span>, <span class="fl">0.1</span>)</span>
<span id="cb363-6"><a href="exp-design.html#cb363-6" tabindex="-1"></a>)</span>
<span id="cb363-7"><a href="exp-design.html#cb363-7" tabindex="-1"></a></span>
<span id="cb363-8"><a href="exp-design.html#cb363-8" tabindex="-1"></a><span class="fu">lengths</span>(design_factors)</span></code></pre></div>
<pre><code>##      N    mu1 lambda    rho 
##      3      3      2      8</code></pre>
<div class="sourceCode" id="cb365"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb365-1"><a href="exp-design.html#cb365-1" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>( <span class="sc">!!!</span>design_factors )</span>
<span id="cb365-2"><a href="exp-design.html#cb365-2" tabindex="-1"></a>params</span></code></pre></div>
<pre><code>## # A tibble: 144 × 4
##        N   mu1 lambda   rho
##    &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
##  1    10     4    0.5   0  
##  2    10     4    0.5   0.1
##  3    10     4    0.5   0.2
##  4    10     4    0.5   0.3
##  5    10     4    0.5   0.4
##  6    10     4    0.5   0.5
##  7    10     4    0.5   0.6
##  8    10     4    0.5   0.7
##  9    10     4    1     0  
## 10    10     4    1     0.1
## # ℹ 134 more rows</code></pre>
<p>We use <code>expand_grid()</code> from the <code>tidyr</code> package to create all possible combinations of the four factors.<a href="#fn15" class="footnote-ref" id="fnref15"><sup>15</sup></a>
We have a total of <span class="math inline">\(3 \times 3 \times 2 \times 8 = 144\)</span> rows, each row corresponding to a simulation scenario to explore.
With multifactor experiments, it is easy to end up running a lot of experiments!</p>
<p>The multi-factor aspect of a simulation is incredible important.
It can take us from an overly narrow exploration to one that has broader significance.
As <span class="citation">Little (<a href="#ref-little2013praise">2013</a>)</span> puts it:</p>
<blockquote>
<p>Good simulation studies are not given the respect they deserve. Often the design is perfunctory and simplistic, neglecting to attempt a factorial experimental design to cover the relevant sample space, and results are over-generalized. Well designed simulation studies with realistic sample sizes are an antidote to a ﬁxation on asymptotics and a useful tool for assessing calibration.</p>
</blockquote>
<div id="choosing-parameter-combinations" class="section level2 hasAnchor" number="10.1">
<h2><span class="header-section-number">10.1</span> Choosing parameter combinations<a href="exp-design.html#choosing-parameter-combinations" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>How do we go about choosing parameter values to examine?
Choosing which parameters to use is a central part of good simulation design because the primary limitation of simulation studies is always their <em>generalizability</em>.
On the one hand, it is difficult to extrapolate findings from a simulation study beyond the set of simulation conditions that were examined. On the other hand, it is often difficult or impossible to examine the full space of all possible parameter values, except for very simple problems.
Even in the relatively straightforward Pearson correlation simulation, we have four factors and the last three could each take on an infinite number of possible levels.
How can we come up with a defensible set of levels to examine?</p>
<p>Broadly, you generally want to vary parameters that you believe matter, or that you think other people will believe matter.
The first is so you can learn.
The second is to build your case.
The choice of simulation conditions needs to be made in the context of the problem or model that you are studying, so it is difficult to identify valid but acontextual principles.
We nonetheless offer a few points of advice, informed by our experience conducting and reading simulation studies:</p>
<ol style="list-style-type: decimal">
<li><p>For research simulations, it often is important to be able to relate your findings to previous research. This suggests that you should select parameter levels to make this possible, such as by looking at sample sizes similar to those examined in previous studies. That said, previous simulation studies are not always perfect (actually, there are a lot of really crummy ones out there!), and so prior work should not generally be your sole guide or justification.</p></li>
<li><p>Generally, it is better to err on the side of being more comprehensive. You learn more by looking at a broader range of conditions, and you can always boil down your results to a more limited set of conditions for purposes of presentation.</p></li>
<li><p>It is also important to explore breakdown points (e.g., what sample size is too small for a method to work?) rather than focusing only on conditions where a method might be expected to work well. Pushing the boundaries and identifying conditions where estimation methods break will help you to provide better guidance for how the methods should be used in practice.</p></li>
</ol>
<p>On point (2), comprehensiveness will generally increase the amount of computing required for a simulation. However, this can be tempered by reducing the number of replications per scenario.
For example, say you were planning on doing 1000 simulations per scenario, but then you realize there is some other factor that you do not think matters, but that you believe other researchers will worry about.
You could add in that factor, say with four levels, and then do 250 simulations per scenario.
The total work remains the same.
When analyzing the final simulation you would first verify you do not see trends along this new factor, and then marginalize out that factor in your summaries of results.
Marginalizing out a factor (i.e., averaging your performance metrics across the additional factor) is a powerful technique of making a claim about how your methods work <em>on average</em> across a <em>range</em> of scenarios, rather than for a specific scenario.
We will discuss it further in Chapter <a href="presentation-of-results.html#presentation-of-results">11</a>.</p>
<p>Once you have identified your parameters, you then have to decide on the levels of the parameter you will include in the simulation.
There are three strategies you might take:</p>
<ol style="list-style-type: decimal">
<li>Vary a parameter over as much of its range as you can.</li>
<li>Choose parameter levels to represent a realistic practical range. These ranges would ideally be empirically justified based on systematic reviews of prior applications. Lacking such empirical evidence, you may need to rely on informal impressions of what is realistic in practice.</li>
<li>Choose parameters to emulate an important known application or context.</li>
</ol>
<p>Of these choices, option (1) is the most general but also the most computationally intensive.
In the ideal, option (2) focuses attention on what is of practical relevance to a practitioner.
Option (3) is usually coupled with a subsequent applied data analysis, and in this case the simulation is often used to enrich that analysis.
In particular, if the simulation shows the methods work for data with the given form of the target application, people may be more willing to believe the application’s findings.</p>
<p>Regardless of how you select your primary parameters, you should also vary nuisance parameters (at least a little) to test the sensitivity of your results to these other aspects.
While simulations will (generally) never be fully generalizable, you can certainly make them so they avoid the obvious things a critic might identify as a basis for dismissing your findings.</p>
<p>To recap, as you think about your parameter selection, always keep the following design principles and acknowledgements:</p>
<ul>
<li>The primary limitation of simulation studies is generalizability.</li>
<li>Choose conditions that allow you to relate your findings to previous work.</li>
<li>Err towards being comprehensive. Your goal should be to build an understanding of the major moving parts, and you can always tailor your final presentation of results to give the simplified story, once you find it.</li>
<li>Explore breakdown points and boundary conditions (e.g., what sample size is too small for applying a given method?).</li>
</ul>
<p>Finally, you should fully expect to add and subtract from your set of simulation factors as you get your initial simulation results. Rarely does anyone nail the choice of parameters on the first pass.</p>
</div>
<div id="using-pmap-to-run-multifactor-simulations" class="section level2 hasAnchor" number="10.2">
<h2><span class="header-section-number">10.2</span> Using pmap to run multifactor simulations<a href="exp-design.html#using-pmap-to-run-multifactor-simulations" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Once we have selected factors and levels for simulation, we now need to run the simulation code across all of our factor combinations.
Conceptually, each row of our <code>params</code> dataset represents a single simulation scenario, and we want to run our simulation code for each of these scenarios.
We would thus call our simulation function, using all the values in that row as parameters to pass to the function.</p>
<p>One way to call a function on each row of a dataset in this manner is by using <code>pmap()</code> from the <code>purrr</code> package.
<code>pmap()</code> marches down a set of lists, running a function on each <span class="math inline">\(p\)</span>-tuple of elements, taking the <span class="math inline">\(i^{th}\)</span> element from each list for iteration <span class="math inline">\(i\)</span>, and passing them as parameters to the specified function.
<code>pmap()</code> then returns the results of this sequence of function calls as a list of results.<a href="#fn16" class="footnote-ref" id="fnref16"><sup>16</sup></a>
Because R’s <code>data.frame</code> objects are also sets of lists (where each variable is a vector, which is a simple form of list), <code>pmap()</code> also works seemlessly on <code>data.frame</code> or <code>tibble</code> objects.</p>
<p>Here is a small illustration of <code>pmap()</code> in action:</p>
<div class="sourceCode" id="cb368"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb368-1"><a href="exp-design.html#cb368-1" tabindex="-1"></a>some_function <span class="ot">&lt;-</span> <span class="cf">function</span>( a, b, theta, scale ) {</span>
<span id="cb368-2"><a href="exp-design.html#cb368-2" tabindex="-1"></a>    scale <span class="sc">*</span> (a <span class="sc">+</span> theta<span class="sc">*</span>(b<span class="sc">-</span>a))</span>
<span id="cb368-3"><a href="exp-design.html#cb368-3" tabindex="-1"></a>}</span>
<span id="cb368-4"><a href="exp-design.html#cb368-4" tabindex="-1"></a></span>
<span id="cb368-5"><a href="exp-design.html#cb368-5" tabindex="-1"></a>args_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>( <span class="at">a =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">b =</span> <span class="dv">5</span><span class="sc">:</span><span class="dv">7</span>, <span class="at">theta =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.3</span>, <span class="fl">0.7</span>) )</span>
<span id="cb368-6"><a href="exp-design.html#cb368-6" tabindex="-1"></a>purrr<span class="sc">::</span><span class="fu">pmap</span>( args_data, <span class="at">.f =</span> some_function, <span class="at">scale =</span> <span class="dv">10</span> )</span></code></pre></div>
<pre><code>## [[1]]
## [1] 18
## 
## [[2]]
## [1] 32
## 
## [[3]]
## [1] 58</code></pre>
<p>One important constraint of <code>pmap()</code> is that the variable names over which to iterate over must correspond exactly to arguments of the function to be evaluated.
In the above example, <code>args_data</code> must have column names that correspond to the arguments of <code>some_function</code>.
For functions with additional arguments that are not manipulated, extra parameters can be passed after the function name (as in the <code>scale</code> argument in this example).
These will also be passed to each function call, but will be the same for all calls.</p>
<p>Let’s now implement this technique for our simulation of confidence intervals for Pearson’s correlation coefficient.
In Section <a href="data-analysis-procedures.html#estimation-functions">7.1</a>, we developed a function called <code>r_and_z()</code> for computing confidence intervals for Pearson’s correlation using Fisher’s <span class="math inline">\(z\)</span> transformation;
then in Section <a href="building-good-visualization.html#assessing-confidence-intervals">12.7</a>, we wrote a function called <code>evaluate_CIs()</code> for evaluating confidence interval coverage and average width.
We can bundle <code>r_bivariate_Poisson()</code>, <code>r_and_z()</code>, and <code>evaluate_CIs()</code> into a simulation driver function by taking</p>
<div class="sourceCode" id="cb370"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb370-1"><a href="exp-design.html#cb370-1" tabindex="-1"></a><span class="fu">library</span>(simhelpers)</span>
<span id="cb370-2"><a href="exp-design.html#cb370-2" tabindex="-1"></a></span>
<span id="cb370-3"><a href="exp-design.html#cb370-3" tabindex="-1"></a>Pearson_sim <span class="ot">&lt;-</span> <span class="fu">bundle_sim</span>(</span>
<span id="cb370-4"><a href="exp-design.html#cb370-4" tabindex="-1"></a>  <span class="at">f_generate =</span> r_bivariate_Poisson, <span class="at">f_analyze =</span> r_and_z, <span class="at">f_summarize =</span> evaluate_CIs</span>
<span id="cb370-5"><a href="exp-design.html#cb370-5" tabindex="-1"></a>)</span>
<span id="cb370-6"><a href="exp-design.html#cb370-6" tabindex="-1"></a><span class="fu">args</span>(Pearson_sim)</span></code></pre></div>
<pre><code>## function (reps, N, mu1, mu2, rho = 0, seed = NA_integer_, summarize = TRUE) 
## NULL</code></pre>
<p>This function will run a simulation for a given scenario:</p>
<div class="sourceCode" id="cb372"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb372-1"><a href="exp-design.html#cb372-1" tabindex="-1"></a><span class="fu">Pearson_sim</span>(<span class="dv">1000</span>, <span class="at">N =</span> <span class="dv">10</span>, <span class="at">mu1 =</span> <span class="dv">5</span>, <span class="at">mu2 =</span> <span class="dv">5</span>, <span class="at">rho =</span> <span class="fl">0.3</span>)</span></code></pre></div>
<pre><code>## # A tibble: 1 × 5
##   K_coverage coverage coverage_mcse width
##        &lt;int&gt;    &lt;dbl&gt;         &lt;dbl&gt; &lt;dbl&gt;
## 1       1000     0.95       0.00689  1.10
## # ℹ 1 more variable: width_mcse &lt;dbl&gt;</code></pre>
<p>In order to call <code>Pearson_sim()</code>, we will need to ensure that the columns of the <code>params</code> dataset correspond to the arguments of the function.
Because we re-parameterized the model in terms of <span class="math inline">\(\lambda\)</span>, we will first need to compute the parameter value for <span class="math inline">\(\mu_2\)</span> and remove the <code>lambda</code> variable because it is not an argument of <code>Pearson_sim()</code>:</p>
<div class="sourceCode" id="cb374"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb374-1"><a href="exp-design.html#cb374-1" tabindex="-1"></a>params_mod <span class="ot">&lt;-</span> </span>
<span id="cb374-2"><a href="exp-design.html#cb374-2" tabindex="-1"></a>  params <span class="sc">%&gt;%</span></span>
<span id="cb374-3"><a href="exp-design.html#cb374-3" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mu2 =</span> mu1 <span class="sc">*</span> lambda) <span class="sc">%&gt;%</span></span>
<span id="cb374-4"><a href="exp-design.html#cb374-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>lambda)</span></code></pre></div>
<p>Now we can use <code>pmap()</code> to run the simulation for all 144 parameter settings:</p>
<div class="sourceCode" id="cb375"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb375-1"><a href="exp-design.html#cb375-1" tabindex="-1"></a>sim_results <span class="ot">&lt;-</span> params</span>
<span id="cb375-2"><a href="exp-design.html#cb375-2" tabindex="-1"></a>sim_results<span class="sc">$</span>res <span class="ot">&lt;-</span> <span class="fu">pmap</span>(params_mod, Pearson_sim, <span class="at">reps =</span> <span class="dv">1000</span> )</span></code></pre></div>
<p>The above code calls our <code>run_alpha_sim()</code> method for each row in the list of scenarios we want to explore.
Conveniently, we can store the results <strong>as a new variable in the same dataset</strong>.</p>
<div class="sourceCode" id="cb376"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb376-1"><a href="exp-design.html#cb376-1" tabindex="-1"></a>sim_results</span></code></pre></div>
<pre><code>## # A tibble: 144 × 5
##        N   mu1   rho   mu2 res             
##    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;list&gt;          
##  1    10     4   0       2 &lt;tibble [1 × 5]&gt;
##  2    10     4   0.1     2 &lt;tibble [1 × 5]&gt;
##  3    10     4   0.2     2 &lt;tibble [1 × 5]&gt;
##  4    10     4   0.3     2 &lt;tibble [1 × 5]&gt;
##  5    10     4   0.4     2 &lt;tibble [1 × 5]&gt;
##  6    10     4   0.5     2 &lt;tibble [1 × 5]&gt;
##  7    10     4   0.6     2 &lt;tibble [1 × 5]&gt;
##  8    10     4   0.7     2 &lt;tibble [1 × 5]&gt;
##  9    10     4   0       4 &lt;tibble [1 × 5]&gt;
## 10    10     4   0.1     4 &lt;tibble [1 × 5]&gt;
## # ℹ 134 more rows</code></pre>
<p>The above code may look a bit peculiar: we are storing a set of dataframes (our result) in our original dataframe.
This is actually ok in R: our results will be in what is called a <strong>list-column</strong>, where each element in our list column is the little summary of our simulation results for that scenario.
Here is the third scenario, for example:</p>
<div class="sourceCode" id="cb378"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb378-1"><a href="exp-design.html#cb378-1" tabindex="-1"></a>sim_results<span class="sc">$</span>res[[<span class="dv">3</span>]]</span></code></pre></div>
<pre><code>## # A tibble: 1 × 5
##   K_coverage coverage coverage_mcse width
##        &lt;int&gt;    &lt;dbl&gt;         &lt;dbl&gt; &lt;dbl&gt;
## 1       1000    0.947       0.00708  1.13
## # ℹ 1 more variable: width_mcse &lt;dbl&gt;</code></pre>
<p>List columns are neat, but hard to work with.
To turn the list-column into normal data, we can use <code>unnest()</code> to expand the <code>res</code> variable, replicating the values of the main variables once for each row in the nested dataset:</p>
<div class="sourceCode" id="cb380"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb380-1"><a href="exp-design.html#cb380-1" tabindex="-1"></a>sim_results <span class="ot">&lt;-</span> <span class="fu">unnest</span>(sim_results, <span class="at">cols =</span> res)</span>
<span id="cb380-2"><a href="exp-design.html#cb380-2" tabindex="-1"></a>sim_results</span></code></pre></div>
<pre><code>## # A tibble: 144 × 9
##        N   mu1   rho   mu2 K_coverage coverage
##    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;      &lt;int&gt;    &lt;dbl&gt;
##  1    10     4   0       2       1000    0.949
##  2    10     4   0.1     2       1000    0.954
##  3    10     4   0.2     2       1000    0.947
##  4    10     4   0.3     2       1000    0.94 
##  5    10     4   0.4     2       1000    0.953
##  6    10     4   0.5     2       1000    0.953
##  7    10     4   0.6     2       1000    0.938
##  8    10     4   0.7     2       1000    0.945
##  9    10     4   0       4       1000    0.956
## 10    10     4   0.1     4       1000    0.94 
## # ℹ 134 more rows
## # ℹ 3 more variables: coverage_mcse &lt;dbl&gt;,
## #   width &lt;dbl&gt;, width_mcse &lt;dbl&gt;</code></pre>
<p>Putting all of this together into a tidy workflow leads to the following:</p>
<div class="sourceCode" id="cb382"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb382-1"><a href="exp-design.html#cb382-1" tabindex="-1"></a>sim_results <span class="ot">&lt;-</span> </span>
<span id="cb382-2"><a href="exp-design.html#cb382-2" tabindex="-1"></a>  params <span class="sc">%&gt;%</span></span>
<span id="cb382-3"><a href="exp-design.html#cb382-3" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb382-4"><a href="exp-design.html#cb382-4" tabindex="-1"></a>    <span class="at">mu2 =</span> mu1 <span class="sc">*</span> lambda,</span>
<span id="cb382-5"><a href="exp-design.html#cb382-5" tabindex="-1"></a>    <span class="at">reps =</span> <span class="dv">1000</span></span>
<span id="cb382-6"><a href="exp-design.html#cb382-6" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb382-7"><a href="exp-design.html#cb382-7" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb382-8"><a href="exp-design.html#cb382-8" tabindex="-1"></a>    <span class="at">res =</span> <span class="fu">pmap</span>(dplyr<span class="sc">::</span><span class="fu">select</span>(., <span class="sc">-</span>lambda), <span class="at">.f =</span> Pearson_sim)</span>
<span id="cb382-9"><a href="exp-design.html#cb382-9" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb382-10"><a href="exp-design.html#cb382-10" tabindex="-1"></a>  <span class="fu">unnest</span>(<span class="at">cols =</span> res)</span></code></pre></div>
<p>If you like, you can simply use the <code>evaluate_by_row()</code> function from the <code>simhelpers</code> package:</p>
<div class="sourceCode" id="cb383"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb383-1"><a href="exp-design.html#cb383-1" tabindex="-1"></a>sim_results <span class="ot">&lt;-</span> </span>
<span id="cb383-2"><a href="exp-design.html#cb383-2" tabindex="-1"></a>  params <span class="sc">%&gt;%</span></span>
<span id="cb383-3"><a href="exp-design.html#cb383-3" tabindex="-1"></a>  <span class="fu">mutate</span>( <span class="at">mu2 =</span> mu1 <span class="sc">*</span> lambda ) <span class="sc">%&gt;%</span></span>
<span id="cb383-4"><a href="exp-design.html#cb383-4" tabindex="-1"></a>  <span class="fu">evaluate_by_row</span>( Pearson_sim, <span class="at">reps =</span> <span class="dv">1000</span> )</span></code></pre></div>
<p>An advantage of <code>evaluate_by_row()</code> is that the input dataset can include extra variables (such as <code>lambda</code>).
Another advantage is that it is easy to run the calculations in parallel; see Chapter <a href="parallel-processing.html#parallel-processing">17</a>.</p>
<p>As a final step, we save our results using tidyverse’s <code>write_rds()</code>; see <a href="https://r4ds.hadley.nz/data-import.html#sec-writing-to-a-file">R for Data Science, Section 7.5</a>.
We first ensure we have a directory by making one via <code>dir.create()</code> (see Chapter <a href="organizing-a-simulation-project.html#saving-files">16.3</a> for more on files):</p>
<div class="sourceCode" id="cb384"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb384-1"><a href="exp-design.html#cb384-1" tabindex="-1"></a><span class="fu">dir.create</span>( <span class="st">&quot;results&quot;</span>, <span class="at">showWarnings =</span> <span class="cn">FALSE</span> )</span>
<span id="cb384-2"><a href="exp-design.html#cb384-2" tabindex="-1"></a><span class="fu">write_rds</span>( sim_results, <span class="at">file =</span> <span class="st">&quot;results/Pearson_Poisson_results.rds&quot;</span> )</span></code></pre></div>
<p>We now have a complete set of simulation results for all of the scenarios we specified.</p>
</div>
<div id="when-to-calculate-performance-metrics" class="section level2 hasAnchor" number="10.3">
<h2><span class="header-section-number">10.3</span> When to calculate performance metrics<a href="exp-design.html#when-to-calculate-performance-metrics" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>For a single-scenario simulation, we repeatedly generate and analyze data, and then assess the performance across the repetitions.
When we extend this process to multifactor simulations, we have a choice: do we compute performance measures for each simulation scenario as we go (inside) or do we compute all of them after we get all of our individual results (outside)?
There are pros and cons to each approach.</p>
<div id="aggregate-as-you-simulate-inside" class="section level3 hasAnchor" number="10.3.1">
<h3><span class="header-section-number">10.3.1</span> Aggregate as you simulate (inside)<a href="exp-design.html#aggregate-as-you-simulate-inside" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <em>inside</em> approach runs a stand-alone simulation for each scenario of interest. For each combination of factors, we simulate data, apply our estimators, assess performance, and return a table with summary performance measures. We can then stack these tables to get a dataset with all of the results, ready for analysis.</p>
<p>This is the approach we illustrated above. It is straightforward and streamlined: we already have a method to run simulations for a single scenario, and we just repeat it across multiple scenarios and combine the outputs.
After calling <code>pmap()</code> (or <code>evaluate_by_row()</code>) and stacking the results, we end up with a dataset containing all the simulation conditions, one simulation context per row (or maybe we have sets of several rows for each simulation context, with one row for each method), with the columns consisting of the simulation factors and measured performance outcomes.
This table of performance is ideally all we need to conduct further analysis and write up the results.</p>
<p>The primary advantages of the inside strategy are that it is easy to modularize the simulation code and it produces a compact dataset of results, minimizing the number and size of files that need to be stored.
On the con side, calculating summary performance measures inside of the simulation driver limits our ability to add new performance measures on the fly or to examine the distribution of individual estimates.
For example, say we wanted to check if the distribution of Fisher-z estimates in a particular scenario was right-skewed, perhaps because we are worried that the estimator sometimes breaks down.
We might want to make a histogram of the point estimates, or calculate the skew of the estimates as a performance measure.
Because the individual estimates are not saved, we would have no way of investigating these questions without rerunning the simulation for that condition.
In short, the inside strategy minimizes disk space but constrains our ability to explore or revise performance calculations.</p>
</div>
<div id="keep-all-simulation-runs-outside" class="section level3 hasAnchor" number="10.3.2">
<h3><span class="header-section-number">10.3.2</span> Keep all simulation runs (outside)<a href="exp-design.html#keep-all-simulation-runs-outside" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <em>outside</em> approach involves retaining the entire set of estimates from every replication, with each row corresponding to an estimate for a given simulated dataset.
The benefit of the outside approach is that it allows us to add or change how we calculate performance measures without re-running the entire simulation.
This is especially important if the simulation is time-intensive, such as when the estimators being evaluated are computationally expensive.
The primary disadvantage the outside approach is that it produces large amounts of data that need to be stored and further manipulated.
Thus, the outside strategy maximizes flexibility, at the cost of increased dataset size.</p>
<p>In our Pearson correlation simulation, we initially followed the inside strategy. To move to the outside strategy, we can set the <code>summarize</code> argument of <code>Pearson_sim()</code> to <code>FALSE</code> so that the simulation driver returns a row for every replication:</p>
<div class="sourceCode" id="cb385"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb385-1"><a href="exp-design.html#cb385-1" tabindex="-1"></a><span class="fu">Pearson_sim</span>(<span class="at">reps =</span> <span class="dv">4</span>, <span class="at">N =</span> <span class="dv">15</span>, <span class="at">mu1 =</span> <span class="dv">5</span>, <span class="at">mu2 =</span> <span class="dv">5</span>, <span class="at">rho =</span> <span class="fl">0.5</span>, <span class="at">summarize =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<pre><code>##           r         z       CI_lo     CI_hi
## 1 0.7357811 0.9412173  0.35872730 0.9064070
## 2 0.2699353 0.2767941 -0.28121305 0.6871768
## 3 0.9229897 1.6088484  0.77909181 0.9744972
## 4 0.5481935 0.6157950  0.04996054 0.8279517</code></pre>
<p>We then save the entire set of estimates, rather than the performance summaries.
This result file will have <span class="math inline">\(R\)</span> times as many rows as the older file. In practice, these results can quickly get to be extremely large.
But disk space is cheap!
Here we run the same experiment as in Section <a href="exp-design.html#using-pmap-to-run-multifactor-simulations">10.2</a>, but storing the individual replications instead of just the summarized results:</p>
<div class="sourceCode" id="cb387"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb387-1"><a href="exp-design.html#cb387-1" tabindex="-1"></a>sim_results_full <span class="ot">&lt;-</span> </span>
<span id="cb387-2"><a href="exp-design.html#cb387-2" tabindex="-1"></a>  params <span class="sc">%&gt;%</span></span>
<span id="cb387-3"><a href="exp-design.html#cb387-3" tabindex="-1"></a>  <span class="fu">mutate</span>( <span class="at">mu2 =</span> mu1 <span class="sc">*</span> lambda ) <span class="sc">%&gt;%</span></span>
<span id="cb387-4"><a href="exp-design.html#cb387-4" tabindex="-1"></a>  <span class="fu">evaluate_by_row</span>( Pearson_sim, <span class="at">reps =</span> <span class="dv">1000</span>, <span class="at">summarize =</span> <span class="cn">FALSE</span> )</span>
<span id="cb387-5"><a href="exp-design.html#cb387-5" tabindex="-1"></a></span>
<span id="cb387-6"><a href="exp-design.html#cb387-6" tabindex="-1"></a><span class="fu">write_rds</span>( sim_results_full, <span class="at">file =</span> <span class="st">&quot;results/Pearson_Poisson_results_full.rds&quot;</span> )</span></code></pre></div>
<p>We end up with many more rows.
Here is the number of rows for the outside vs inside approach:</p>
<div class="sourceCode" id="cb388"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb388-1"><a href="exp-design.html#cb388-1" tabindex="-1"></a><span class="fu">c</span>(<span class="at">inside =</span> <span class="fu">nrow</span>( sim_results ), <span class="at">outside =</span> <span class="fu">nrow</span>( sim_results_full ))</span></code></pre></div>
<pre><code>##  inside outside 
##     144  144000</code></pre>
<p>Comparing the file sizes on the disk:</p>
<div class="sourceCode" id="cb390"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb390-1"><a href="exp-design.html#cb390-1" tabindex="-1"></a><span class="fu">c</span>(</span>
<span id="cb390-2"><a href="exp-design.html#cb390-2" tabindex="-1"></a>  <span class="at">inside =</span> <span class="fu">file.size</span>(<span class="st">&quot;results/Pearson_Poisson_results.rds&quot;</span>),</span>
<span id="cb390-3"><a href="exp-design.html#cb390-3" tabindex="-1"></a>  <span class="at">outside =</span> <span class="fu">file.size</span>(<span class="st">&quot;results/Pearson_Poisson_results_full.rds&quot;</span>)</span>
<span id="cb390-4"><a href="exp-design.html#cb390-4" tabindex="-1"></a>) <span class="sc">/</span> <span class="dv">2</span><span class="sc">^</span><span class="dv">10</span> <span class="co"># Kb</span></span></code></pre></div>
<pre><code>##     inside    outside 
##   43.14551 9000.31055</code></pre>
<p>The first is several kilobytes, the second is several megabytes.</p>
</div>
<div id="getting-raw-results-ready-for-analysis" class="section level3 hasAnchor" number="10.3.3">
<h3><span class="header-section-number">10.3.3</span> Getting raw results ready for analysis<a href="exp-design.html#getting-raw-results-ready-for-analysis" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>If we generate raw results, we then need to do the performance calculations across replications within each simulation context so that we can explore the trends across simulation factors.</p>
<p>One way to do this is to use <code>group_by()</code> and <code>summarize()</code> to carry out the performance calculations:</p>
<div class="sourceCode" id="cb392"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb392-1"><a href="exp-design.html#cb392-1" tabindex="-1"></a>sim_results_full <span class="sc">%&gt;%</span></span>
<span id="cb392-2"><a href="exp-design.html#cb392-2" tabindex="-1"></a>  <span class="fu">group_by</span>( N, mu1, mu2, rho ) <span class="sc">%&gt;%</span></span>
<span id="cb392-3"><a href="exp-design.html#cb392-3" tabindex="-1"></a>  <span class="fu">summarise</span>( </span>
<span id="cb392-4"><a href="exp-design.html#cb392-4" tabindex="-1"></a>    <span class="fu">calc_coverage</span>(<span class="at">lower_bound =</span> CI_lo, <span class="at">upper_bound =</span> CI_hi, <span class="at">true_param =</span> rho)</span>
<span id="cb392-5"><a href="exp-design.html#cb392-5" tabindex="-1"></a>  )</span></code></pre></div>
<pre><code>## # A tibble: 144 × 9
## # Groups:   N, mu1, mu2 [18]
##        N   mu1   mu2   rho K_coverage coverage
##    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;      &lt;int&gt;    &lt;dbl&gt;
##  1    10     4     2   0         1000    0.945
##  2    10     4     2   0.1       1000    0.936
##  3    10     4     2   0.2       1000    0.956
##  4    10     4     2   0.3       1000    0.944
##  5    10     4     2   0.4       1000    0.946
##  6    10     4     2   0.5       1000    0.935
##  7    10     4     2   0.6       1000    0.95 
##  8    10     4     2   0.7       1000    0.945
##  9    10     4     4   0         1000    0.946
## 10    10     4     4   0.1       1000    0.944
## # ℹ 134 more rows
## # ℹ 3 more variables: coverage_mcse &lt;dbl&gt;,
## #   width &lt;dbl&gt;, width_mcse &lt;dbl&gt;</code></pre>
<p>If we want to use our full performance measure function <code>evaluate_CIs()</code> to get additional metrics such as MCSEs, we would <em>nest</em> our data into a series of mini-datasets (one for each simulation), and then process each element.
As we saw above, nesting collapses a larger dataset into one where one of the variables consists of a list of datasets:</p>
<div class="sourceCode" id="cb394"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb394-1"><a href="exp-design.html#cb394-1" tabindex="-1"></a>results <span class="ot">&lt;-</span> </span>
<span id="cb394-2"><a href="exp-design.html#cb394-2" tabindex="-1"></a>  sim_results_full <span class="sc">|&gt;</span></span>
<span id="cb394-3"><a href="exp-design.html#cb394-3" tabindex="-1"></a>  <span class="fu">group_by</span>( N, mu1, mu2, rho ) <span class="sc">%&gt;%</span></span>
<span id="cb394-4"><a href="exp-design.html#cb394-4" tabindex="-1"></a>  <span class="fu">nest</span>( <span class="at">.key =</span> <span class="st">&quot;res&quot;</span> )</span>
<span id="cb394-5"><a href="exp-design.html#cb394-5" tabindex="-1"></a>results</span></code></pre></div>
<pre><code>## # A tibble: 144 × 5
## # Groups:   N, mu1, mu2, rho [144]
##        N   mu1   rho   mu2 res                 
##    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;list&gt;              
##  1    10     4   0       2 &lt;tibble [1,000 × 4]&gt;
##  2    10     4   0.1     2 &lt;tibble [1,000 × 4]&gt;
##  3    10     4   0.2     2 &lt;tibble [1,000 × 4]&gt;
##  4    10     4   0.3     2 &lt;tibble [1,000 × 4]&gt;
##  5    10     4   0.4     2 &lt;tibble [1,000 × 4]&gt;
##  6    10     4   0.5     2 &lt;tibble [1,000 × 4]&gt;
##  7    10     4   0.6     2 &lt;tibble [1,000 × 4]&gt;
##  8    10     4   0.7     2 &lt;tibble [1,000 × 4]&gt;
##  9    10     4   0       4 &lt;tibble [1,000 × 4]&gt;
## 10    10     4   0.1     4 &lt;tibble [1,000 × 4]&gt;
## # ℹ 134 more rows</code></pre>
<p>Note how each row of our nested data has a little tibble containing the results for that context, with 1000 rows each.
Once nested, we can then use <code>map2()</code> to apply a function to each element of <code>res</code>:</p>
<div class="sourceCode" id="cb396"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb396-1"><a href="exp-design.html#cb396-1" tabindex="-1"></a>results_summary <span class="ot">&lt;-</span> </span>
<span id="cb396-2"><a href="exp-design.html#cb396-2" tabindex="-1"></a>  results <span class="sc">%&gt;%</span></span>
<span id="cb396-3"><a href="exp-design.html#cb396-3" tabindex="-1"></a>  <span class="fu">mutate</span>( <span class="at">performance =</span> <span class="fu">map2</span>( res, rho, evaluate_CIs ) ) <span class="sc">%&gt;%</span></span>
<span id="cb396-4"><a href="exp-design.html#cb396-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>( <span class="sc">-</span>res ) <span class="sc">%&gt;%</span></span>
<span id="cb396-5"><a href="exp-design.html#cb396-5" tabindex="-1"></a>  <span class="fu">unnest</span>( <span class="at">cols=</span><span class="st">&quot;performance&quot;</span> ) </span>
<span id="cb396-6"><a href="exp-design.html#cb396-6" tabindex="-1"></a>results_summary</span></code></pre></div>
<pre><code>## # A tibble: 144 × 9
## # Groups:   N, mu1, mu2, rho [144]
##        N   mu1   rho   mu2 K_coverage coverage
##    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;      &lt;int&gt;    &lt;dbl&gt;
##  1    10     4   0       2       1000    0.945
##  2    10     4   0.1     2       1000    0.936
##  3    10     4   0.2     2       1000    0.956
##  4    10     4   0.3     2       1000    0.944
##  5    10     4   0.4     2       1000    0.946
##  6    10     4   0.5     2       1000    0.935
##  7    10     4   0.6     2       1000    0.95 
##  8    10     4   0.7     2       1000    0.945
##  9    10     4   0       4       1000    0.946
## 10    10     4   0.1     4       1000    0.944
## # ℹ 134 more rows
## # ℹ 3 more variables: coverage_mcse &lt;dbl&gt;,
## #   width &lt;dbl&gt;, width_mcse &lt;dbl&gt;</code></pre>
<p>We have built our final performance table <em>after</em> running the entire simulation, rather than running it on each simulation scenario in turn.</p>
<p>Now, if we want to add a performance metric, we can simply change <code>evaluate_CIs</code> and recalculate, without having to recompute the entire simulation.
Summarizing during the simulation vs. after, as we just did, leads to the same set of results.<a href="#fn17" class="footnote-ref" id="fnref17"><sup>17</sup></a>
Allowing yourself the flexibility to re-calculate performance measures can be very advantageous, and we tend to follow this outside strategy for any simulations involving more complex estimation procedures.</p>
</div>
</div>
<div id="summary" class="section level2 hasAnchor" number="10.4">
<h2><span class="header-section-number">10.4</span> Summary<a href="exp-design.html#summary" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Multifactor simulations are simply a systematically generated series of individual scenario simulations.
The overall workflow is to first identify the factors and levels to explore (which we store as a dataset of all the combinations of the factors desired).
Think of this as a menu, or checklist, of simulations to run.
The next step is to then to walk down the list, running each simulation in turn.</p>
<p>Each individual simulation will generate its own set of results.
These can be the raw results (individual simulation iterations) or summary results (performance measures).
We stack all of these results, connecting them to the simulation factors they came from, to get a single massive dataset.
The key question is then how to explore this full set of results; without much difficulty, the amount of results generated can be kind of overwhelming!</p>
<p>The next chapters dive into how to take on this final task.</p>
</div>
<div id="case-study-a-multifactor-evaluation-of-cluster-rct-estimators" class="section level2 hasAnchor" number="10.5">
<h2><span class="header-section-number">10.5</span> Case Study: A multifactor evaluation of cluster RCT estimators<a href="exp-design.html#case-study-a-multifactor-evaluation-of-cluster-rct-estimators" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>To bring the multifactor simulation to life, let us return to the case study of comparing three ways to analyze a cluster randomized trial that we presented in Section <a href="data-generating-processes.html#case-cluster">6.6</a>.
In our original setup, we wrote code to generate cluster randomized trial data where a cluster’s size could be correlated its average treatment effect.
Then, in Chapter <a href="performance-criteria.html#clusterRCTperformance">9.1.1</a> we looked across a variety of performance criteria so we could see how the estimators compared for any given scenario we wanted.</p>
<p>So far, we have only examined a single scenario at a time.
But how do our findings generalize? Under what conditions do the various estimation methods perform better or worse?
To answer these questions, we need to extend to a multifactor simulation to <em>systematically</em> explore how our three estimators behave across a range of contexts.
Happily, the modular functions that we have designed make it relatively straightforward to explore a range of scenarios by calling our simulation function over and over, using the tools of this chapter.
We illustrate extending to a full multifactor simulation next, and then continue our running example to discuss how to analyze the results in Chapter <a href="building-good-visualization.html#building-good-visualization">12</a>.</p>
<div id="choosing-parameters-for-the-clustered-rct" class="section level3 hasAnchor" number="10.5.1">
<h3><span class="header-section-number">10.5.1</span> Choosing parameters for the Clustered RCT<a href="exp-design.html#choosing-parameters-for-the-clustered-rct" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We begin by identifying some potential research questions suggested by our preliminary exploration.
Regarding bias, we noticed in our initial simulation that Linear Regression targets a person-weighted average effect, so it would be considered biased for the cluster-average average treatment effect.
We might then ask, how large is bias in practice, and how much does bias change as we change the cluster-size by impact relationship?
Considering precision, we saw that Linear Regression has a higher standard error than the other estimators.
But is this a general finding? If not, are there contexts where linear regression will have a lower standard error than the others?
Further, we originally thought that aggregation would lose information because smaller clusters would have the same weight as larger clusters, but be more imprecisely estimated.
Were we wrong? Or perhaps if cluster size was even more variable, aggregation might do worse and worse.
Finally, the estimated SEs for all three methods all appeared to be good, although they were rather variable, relative to the true SE.
We might then ask, are the standard errors always the right size, on average? Will the estimated SEs fall apart (i.e., be far too large or far too small) in some contexts? If so, which ones?</p>
<p>To answer all of these questions we need to more systematically explore the space of models.
But we have a lot of knobs to turn.
In particular, our data-generating process will produce artificial cluster-randomized experiments where we can vary any of the following features:</p>
<ul>
<li>the number of clusters;</li>
<li>the proportion of clusters that receive treatment;</li>
<li>the average cluster size and degree of variation in cluster sizes;</li>
<li>how much the average impact varies across clusters, and how strongly that is connected to cluster size;</li>
<li>how much the cluster intercepts vary (degree of cross-cluster variation); and</li>
<li>the degree of residual variation.</li>
</ul>
<p>Manipulating all of these factors would lead to a huge and unwieldy number of simulation conditions to evaluate.
Before proceeding, we reflect on our research questions, speculate as to what is likely to matter, and then consider varying the following:</p>
<ul>
<li>Number of clusters: Do cluster-robust SEs work with fewer clusters?</li>
<li>Average cluster size: Does the number of students/cluster matter?</li>
<li>Variation in cluster size: Do varying cluster sizes cause bias or break things?</li>
<li>Correlation of cluster size and cluster impact: Will correlation cause bias?</li>
<li>Cross cluster variation: Does the amount of cluster variation matter?</li>
</ul>
<p>When selecting factors to manipulate, it is important to ensure the each factor is isolated, so that changing one of them should not change other aspects of the data-generating process that might impact performance.
For example, if we simply added more cross-cluster variation by directly increasing the random effects for the clusters, the total variation in the outcome will also increase.
If we then see that the performance of an estimator deteriorates as variation increases, we have a confound: is the cross-cluster variation causing the problem, or is it the total variation?
To avoid this confound, we should vary cluster variation while holding the total variation fixed; this is why we use the ICC parameterization, as discussed in Section <a href="data-generating-processes.html#case-cluster">6.6</a>.</p>
<p>Given our research questions and the way we parameterize the DGP, we end up with the following factors and levels:</p>
<div class="sourceCode" id="cb398"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb398-1"><a href="exp-design.html#cb398-1" tabindex="-1"></a>crt_design_factors <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb398-2"><a href="exp-design.html#cb398-2" tabindex="-1"></a>  <span class="at">n_bar =</span> <span class="fu">c</span>( <span class="dv">20</span>, <span class="dv">80</span>, <span class="dv">320</span> ),</span>
<span id="cb398-3"><a href="exp-design.html#cb398-3" tabindex="-1"></a>  <span class="at">J =</span> <span class="fu">c</span>( <span class="dv">5</span>, <span class="dv">20</span>, <span class="dv">80</span> ),</span>
<span id="cb398-4"><a href="exp-design.html#cb398-4" tabindex="-1"></a>  <span class="at">ATE =</span> <span class="fu">c</span>( <span class="fl">0.2</span> ),</span>
<span id="cb398-5"><a href="exp-design.html#cb398-5" tabindex="-1"></a>  <span class="at">size_coef =</span> <span class="fu">c</span>( <span class="dv">0</span>, <span class="fl">0.2</span> ),</span>
<span id="cb398-6"><a href="exp-design.html#cb398-6" tabindex="-1"></a>  <span class="at">ICC =</span> <span class="fu">c</span>( <span class="dv">0</span>, <span class="fl">0.2</span>, <span class="fl">0.4</span>, <span class="fl">0.6</span>, <span class="fl">0.8</span> ),</span>
<span id="cb398-7"><a href="exp-design.html#cb398-7" tabindex="-1"></a>  <span class="at">alpha =</span> <span class="fu">c</span>( <span class="dv">0</span>, <span class="fl">0.5</span>, <span class="fl">0.8</span> )</span>
<span id="cb398-8"><a href="exp-design.html#cb398-8" tabindex="-1"></a>)</span></code></pre></div>
<p>The ATE factor only has one level. We could later expand this if we wanted to, but based on theoretical concerns we are fairly confident the ATE will not impact our research questions, so we leave it as it is, set at a value we would consider plausible in real life.</p>
</div>
<div id="redundant-factor-combinations" class="section level3 hasAnchor" number="10.5.2">
<h3><span class="header-section-number">10.5.2</span> Redundant factor combinations<a href="exp-design.html#redundant-factor-combinations" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>There is some redundancy in the parameter combinations that we have selected.
In particular, if <code>size_coef</code> is nonzero, but <code>alpha</code> is 0, then the cluster size will not impact the cluster average ATE because there is no variation in cluster size.
We could drop one of the redundant conditions to save some simulation runs—in essence we are running the same simulation for <code>alpha=0</code> two times, once for each <code>size_coef</code> value, for each level of <code>ICC</code>, <code>n_bar</code> and <code>J</code>.
However, doing so would mean that our simulation is no longer fully crossed.
We will leave the redundant conditions in as a sanity check for our results.
We know we should get the same results and if we do not, then we either have uncontrolled uncertainty in our simulation or an error in the code.
If computation is cheap, then keeping the fully crossed structure will make for easier analysis.
Otherwise our experiment is not balanced, and so when we average performance across some factors to see the effect of others, we might end up with surprising and misleading results.</p>
</div>
<div id="running-the-simulations" class="section level3 hasAnchor" number="10.5.3">
<h3><span class="header-section-number">10.5.3</span> Running the simulations<a href="exp-design.html#running-the-simulations" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We will run our cluster RCT simulation using the same code pattern as we used with the Pearson correlation simulations.
Because we are not exactly sure which performance metrics we will want to use, we will save the individual replications and then calculate performance metrics after generating the simulation results.
That is, we will use the outside strategy.</p>
<p>We first make a table of scenarios:</p>
<div class="sourceCode" id="cb399"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb399-1"><a href="exp-design.html#cb399-1" tabindex="-1"></a>params <span class="ot">&lt;-</span> </span>
<span id="cb399-2"><a href="exp-design.html#cb399-2" tabindex="-1"></a>  <span class="fu">expand_grid</span>( <span class="sc">!!!</span>crt_design_factors ) <span class="sc">%&gt;%</span></span>
<span id="cb399-3"><a href="exp-design.html#cb399-3" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb399-4"><a href="exp-design.html#cb399-4" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">20200320</span> <span class="sc">+</span> <span class="dv">17</span> <span class="sc">*</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()</span>
<span id="cb399-5"><a href="exp-design.html#cb399-5" tabindex="-1"></a>  )</span></code></pre></div>
<p>To allow reproducibility, we specify a different seed for each scenario just to avoid anything confusing about shared randomness across scenarios (see Section <a href="running-the-simulation-process.html#seeds-and-pseudo-RNGs">8.4</a> for further discussion).
We then run the simulation 1000 times each for scenario, then unnest to get our final data:</p>
<div class="sourceCode" id="cb400"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb400-1"><a href="exp-design.html#cb400-1" tabindex="-1"></a>params<span class="sc">$</span>res <span class="ot">&lt;-</span> <span class="fu">pmap</span>(params, <span class="at">.f =</span> run_CRT_sim, <span class="at">reps =</span> <span class="dv">1000</span> )</span>
<span id="cb400-2"><a href="exp-design.html#cb400-2" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">unnest</span>(params, <span class="at">cols=</span>data)</span>
<span id="cb400-3"><a href="exp-design.html#cb400-3" tabindex="-1"></a><span class="fu">saveRDS</span>( res, <span class="at">file =</span> <span class="st">&quot;results/simulation_CRT.rds&quot;</span> )</span></code></pre></div>
<p>Normally, we would speed up these calculations using parallel processing; we discuss how to do so in Chapter <a href="parallel-processing.html#parallel-processing">17</a>.
Even under parallel processing, this simulation took overnight to run.
Our final results look like this:</p>
<pre><code>## # A tibble: 810,000 × 13
##    n_bar     J   ATE size_coef   ICC alpha  reps
##    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1    20     5   0.2         0     0     0  1000
##  2    20     5   0.2         0     0     0  1000
##  3    20     5   0.2         0     0     0  1000
##  4    20     5   0.2         0     0     0  1000
##  5    20     5   0.2         0     0     0  1000
##  6    20     5   0.2         0     0     0  1000
##  7    20     5   0.2         0     0     0  1000
##  8    20     5   0.2         0     0     0  1000
##  9    20     5   0.2         0     0     0  1000
## 10    20     5   0.2         0     0     0  1000
## # ℹ 809,990 more rows
## # ℹ 6 more variables: seed &lt;dbl&gt;, runID &lt;chr&gt;,
## #   method &lt;chr&gt;, ATE_hat &lt;dbl&gt;, SE_hat &lt;dbl&gt;,
## #   p_value &lt;dbl&gt;</code></pre>
<p>We have a lot of rows of data!</p>
</div>
<div id="calculating-performance-metrics" class="section level3 hasAnchor" number="10.5.4">
<h3><span class="header-section-number">10.5.4</span> Calculating performance metrics<a href="exp-design.html#calculating-performance-metrics" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Our next step is to group the results by the simulation factors and calculate the performance metrics across the replications of each simulation condition.
Here we calculate our primary performance measures by hand:</p>
<div class="sourceCode" id="cb402"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb402-1"><a href="exp-design.html#cb402-1" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">readRDS</span>( <span class="at">file =</span> <span class="st">&quot;results/simulation_CRT.rds&quot;</span> )</span>
<span id="cb402-2"><a href="exp-design.html#cb402-2" tabindex="-1"></a></span>
<span id="cb402-3"><a href="exp-design.html#cb402-3" tabindex="-1"></a>sres <span class="ot">&lt;-</span> </span>
<span id="cb402-4"><a href="exp-design.html#cb402-4" tabindex="-1"></a>  res <span class="sc">%&gt;%</span> </span>
<span id="cb402-5"><a href="exp-design.html#cb402-5" tabindex="-1"></a>  <span class="fu">group_by</span>( n_bar, J, ATE, size_coef, ICC, alpha, method ) <span class="sc">%&gt;%</span></span>
<span id="cb402-6"><a href="exp-design.html#cb402-6" tabindex="-1"></a>  <span class="fu">summarise</span>( </span>
<span id="cb402-7"><a href="exp-design.html#cb402-7" tabindex="-1"></a>    <span class="at">bias =</span> <span class="fu">mean</span>(ATE_hat <span class="sc">-</span> ATE),</span>
<span id="cb402-8"><a href="exp-design.html#cb402-8" tabindex="-1"></a>    <span class="at">SE =</span> <span class="fu">sd</span>( ATE_hat ),</span>
<span id="cb402-9"><a href="exp-design.html#cb402-9" tabindex="-1"></a>    <span class="at">RMSE =</span> <span class="fu">sqrt</span>( <span class="fu">mean</span>( (ATE_hat <span class="sc">-</span> ATE )<span class="sc">^</span><span class="dv">2</span> ) ),</span>
<span id="cb402-10"><a href="exp-design.html#cb402-10" tabindex="-1"></a>    <span class="at">ESE_hat =</span> <span class="fu">sqrt</span>( <span class="fu">mean</span>( SE_hat<span class="sc">^</span><span class="dv">2</span> ) ),</span>
<span id="cb402-11"><a href="exp-design.html#cb402-11" tabindex="-1"></a>    <span class="at">SD_SE_hat =</span> <span class="fu">sqrt</span>( <span class="fu">sd</span>( SE_hat<span class="sc">^</span><span class="dv">2</span> ) ),</span>
<span id="cb402-12"><a href="exp-design.html#cb402-12" tabindex="-1"></a>    <span class="at">power =</span> <span class="fu">mean</span>( p_value <span class="sc">&lt;=</span> <span class="fl">0.05</span> ),</span>
<span id="cb402-13"><a href="exp-design.html#cb402-13" tabindex="-1"></a>    <span class="at">R =</span> <span class="fu">n</span>(),</span>
<span id="cb402-14"><a href="exp-design.html#cb402-14" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span></span>
<span id="cb402-15"><a href="exp-design.html#cb402-15" tabindex="-1"></a>  )</span></code></pre></div>
<p>If we want MCSEs (as we usually do), then we could do that by hand or use the <code>simhelpers</code> package as so:</p>
<div class="sourceCode" id="cb403"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb403-1"><a href="exp-design.html#cb403-1" tabindex="-1"></a><span class="fu">library</span>( simhelpers )</span>
<span id="cb403-2"><a href="exp-design.html#cb403-2" tabindex="-1"></a></span>
<span id="cb403-3"><a href="exp-design.html#cb403-3" tabindex="-1"></a>sres <span class="ot">&lt;-</span> </span>
<span id="cb403-4"><a href="exp-design.html#cb403-4" tabindex="-1"></a>  res <span class="sc">%&gt;%</span> </span>
<span id="cb403-5"><a href="exp-design.html#cb403-5" tabindex="-1"></a>  <span class="fu">group_by</span>( n_bar, J, ATE, size_coef, ICC, alpha, method ) <span class="sc">%&gt;%</span></span>
<span id="cb403-6"><a href="exp-design.html#cb403-6" tabindex="-1"></a>  <span class="fu">summarise</span>( </span>
<span id="cb403-7"><a href="exp-design.html#cb403-7" tabindex="-1"></a>    <span class="fu">calc_absolute</span>( </span>
<span id="cb403-8"><a href="exp-design.html#cb403-8" tabindex="-1"></a>      <span class="at">estimates =</span> ATE_hat, <span class="at">true_param =</span> ATE, </span>
<span id="cb403-9"><a href="exp-design.html#cb403-9" tabindex="-1"></a>      <span class="at">criteria =</span> <span class="fu">c</span>(<span class="st">&quot;bias&quot;</span>,<span class="st">&quot;stddev&quot;</span>,<span class="st">&quot;rmse&quot;</span>)</span>
<span id="cb403-10"><a href="exp-design.html#cb403-10" tabindex="-1"></a>    ),</span>
<span id="cb403-11"><a href="exp-design.html#cb403-11" tabindex="-1"></a>    <span class="fu">calc_relative_var</span>( </span>
<span id="cb403-12"><a href="exp-design.html#cb403-12" tabindex="-1"></a>      <span class="at">estimates =</span> ATE_hat, <span class="at">var_estimates =</span> SE_hat<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb403-13"><a href="exp-design.html#cb403-13" tabindex="-1"></a>      <span class="at">criteria =</span> <span class="st">&quot;relative bias&quot;</span></span>
<span id="cb403-14"><a href="exp-design.html#cb403-14" tabindex="-1"></a>    ) </span>
<span id="cb403-15"><a href="exp-design.html#cb403-15" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb403-16"><a href="exp-design.html#cb403-16" tabindex="-1"></a>  <span class="fu">rename</span>( <span class="at">SE =</span> stddev, <span class="at">SE_mcse =</span> stddev_mcse ) <span class="sc">%&gt;%</span></span>
<span id="cb403-17"><a href="exp-design.html#cb403-17" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>( <span class="sc">-</span>K_absolute, <span class="sc">-</span>K_relvar ) <span class="sc">%&gt;%</span></span>
<span id="cb403-18"><a href="exp-design.html#cb403-18" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb403-19"><a href="exp-design.html#cb403-19" tabindex="-1"></a></span>
<span id="cb403-20"><a href="exp-design.html#cb403-20" tabindex="-1"></a><span class="fu">glimpse</span>( sres )</span></code></pre></div>
<pre><code>## Rows: 810
## Columns: 15
## $ n_bar             &lt;dbl&gt; 20, 20, 20, 20, 20, 20…
## $ J                 &lt;dbl&gt; 5, 5, 5, 5, 5, 5, 5, 5…
## $ ATE               &lt;dbl&gt; 0.2, 0.2, 0.2, 0.2, 0.…
## $ size_coef         &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0…
## $ ICC               &lt;dbl&gt; 0.0, 0.0, 0.0, 0.0, 0.…
## $ alpha             &lt;dbl&gt; 0.0, 0.0, 0.0, 0.5, 0.…
## $ method            &lt;chr&gt; &quot;Agg&quot;, &quot;LR&quot;, &quot;MLM&quot;, &quot;A…
## $ bias              &lt;dbl&gt; 0.0078528924, 0.007852…
## $ bias_mcse         &lt;dbl&gt; 0.006512388, 0.0065123…
## $ SE                &lt;dbl&gt; 0.2059398, 0.2059398, …
## $ SE_mcse           &lt;dbl&gt; 0.004380492, 0.0043804…
## $ rmse              &lt;dbl&gt; 0.2059865, 0.2059865, …
## $ rmse_mcse         &lt;dbl&gt; 0.005468829, 0.0054688…
## $ rel_bias_var      &lt;dbl&gt; 0.9834635, 0.9834635, …
## $ rel_bias_var_mcse &lt;dbl&gt; 0.05290317, 0.05290317…</code></pre>
<!-- JEP: Do we need a brief conclusion to the section? -->
<!-- JEP: Do we need a conclusions section for the overall chapter? -->
</div>
</div>
<div id="exercises-7" class="section level2 hasAnchor" number="10.6">
<h2><span class="header-section-number">10.6</span> Exercises<a href="exp-design.html#exercises-7" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="brown-and-forsythe-redux" class="section level3 hasAnchor" number="10.6.1">
<h3><span class="header-section-number">10.6.1</span> Brown and Forsythe redux<a href="exp-design.html#brown-and-forsythe-redux" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Take another look at Table <a href="case-ANOVA.html#tab:BF-Scenarios">5.1</a>, which is excerpted from <span class="citation">Brown and Forsythe (<a href="#ref-brown1974SmallSampleBehavior">1974</a>)</span>.
Create a tibble with one row for each of the 20 scenarios that they evaluated.
Then create a function for running the full simulation process (see Exercise <a href="running-the-simulation-process.html#Welch-simulation">8.5.1</a>).
Use <code>pmap()</code> or <code>evaluate_by_row()</code> to run simulations of all 20 scenarios and reproduce the results in Table <a href="case-ANOVA.html#tab:BF-table1">5.2</a> of Chapter <a href="case-ANOVA.html#case-ANOVA">5</a>.</p>
</div>
<div id="meta-regression" class="section level3 hasAnchor" number="10.6.2">
<h3><span class="header-section-number">10.6.2</span> Meta-regression<a href="exp-design.html#meta-regression" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Exercise <a href="data-generating-processes.html#meta-regression-DGP">6.9.14</a> described the random effects meta-regression model.
List the focal, auxiliary, and structural parameters of this model, and propose a set of design factors to use in a multifactor simulation of the model.
Create a list with one entry per factor, then create a dataset with one row for each simulation context that you propose to evaluate.</p>
</div>
<div id="exercise:trimmed-mean" class="section level3 hasAnchor" number="10.6.3">
<h3><span class="header-section-number">10.6.3</span> Comparing the trimmed mean, median and mean<a href="exp-design.html#exercise:trimmed-mean" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In this exercise, you will write a simulation to compare several different
estimators of a common parameter.
In particular, you will compare the mean, trimmed mean, and median as estimators of the center of a symmetric distribution (such that the mean and median parameters are identical).<br />
To do this, you should break building this simulation evaluation down into functions for each component of the simulation.
This will allow you to extend the same framework to more complicated simulation studies.
This extended exercise illustrates how methodologists might compare different estimation strategies, as you might see in the “simulation” section of a stats paper.</p>
<p>As the data-generation function, use a scaled <span class="math inline">\(t\)</span>-distribution so that the standard deviation will always be 1 but will have different fatness of tails (high chance of outliers):</p>
<div class="sourceCode" id="cb405"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb405-1"><a href="exp-design.html#cb405-1" tabindex="-1"></a>gen_scaled_t <span class="ot">&lt;-</span> <span class="cf">function</span>( n, mu, df0 ) {</span>
<span id="cb405-2"><a href="exp-design.html#cb405-2" tabindex="-1"></a>    mu <span class="sc">+</span> <span class="fu">rt</span>( n, <span class="at">df=</span>df0 ) <span class="sc">/</span> <span class="fu">sqrt</span>( df0 <span class="sc">/</span> (df0<span class="dv">-2</span>) )</span>
<span id="cb405-3"><a href="exp-design.html#cb405-3" tabindex="-1"></a>}</span></code></pre></div>
<p>The variance of a <span class="math inline">\(t\)</span> distribution is <span class="math inline">\(df/(df-2)\)</span>, so when we divide our observations by the
square root of this, we standardize them so they have unit variance.</p>
<ol style="list-style-type: decimal">
<li><p>Verify that <code>gen_scaled_t()</code> produces data with mean <code>mu</code> and standard deviation 1 for various <code>df0</code> values.</p></li>
<li><p>Write a method to calculate the mean, trimmed mean, and median of a vector of data.
The trimmed mean should trim 10% of the data from each end.
The method should return a data frame with the three estimates, one row per estimator.</p></li>
<li><p>Verify your estimation method works by analyzing a dataset generated with <code>gen_scaled_t()</code>.
For example, you can generate a dataset of size 100 with <code>gen_scaled_t(100, 0, 3)</code> and then analyze it.</p></li>
<li><p>Use <code>bundle_sim()</code> to create a simulation function that generates data and then analyzes it.
The function should take <code>n</code> and <code>df0</code> as arguments, and return the estimates from your analysis method.
Use <code>id</code> to give each simulation run an ID.</p></li>
<li><p>Run your simulation function for 1000 datasets of size 10, with <code>mu=0</code> and <code>df0=5</code>.
Store the results in a variable called <code>raw_exps</code>.</p></li>
<li><p>Write a function to calculate the RMSE, bias, and standard error for your three estimators, given the results.</p></li>
<li><p>Make a single function that takes <code>df0</code> and <code>n</code>, and runs a simulation and returns the performances of your three methods.</p></li>
<li><p>Now make a grid of <span class="math inline">\(n = 10, 50, 250, 1250\)</span> and <span class="math inline">\(df_0 =  3, 5, 15, 30\)</span>, and generate results for your multi-factor simulation.</p></li>
<li><p>Make a plot showing how SE changes as a function of sample size for each estimator. Do the three estimator seem to follow the same pattern? Or do they work differently?</p></li>
</ol>

</div>
</div>
</div>
<h3>References</h3>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-brown1974SmallSampleBehavior" class="csl-entry">
Brown, Morton B., and Alan B. Forsythe. 1974. <span>“The <span>Small Sample Behavior</span> of <span>Some Statistics Which Test</span> the <span>Equality</span> of <span>Several Means</span>.”</span> <em>Technometrics</em> 16 (1): 129–32. <a href="https://doi.org/10.1080/00401706.1974.10489158">https://doi.org/10.1080/00401706.1974.10489158</a>.
</div>
<div id="ref-little2013praise" class="csl-entry">
Little, Roderick J. 2013. <span>“In Praise of Simplicity Not Mathematistry! Ten Simple Powerful Ideas for the Statistical Scientist.”</span> <em>Journal of the American Statistical Association</em> 108 (502): 359–69.
</div>
</div>
<div class="footnotes">
<hr />
<ol start="15">
<li id="fn15"><p><code>expand_grid()</code> is set up to take one argument per factor of the design. A clearer example of its natural syntax is:</p>
<div class="sourceCode" id="cb367"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb367-1"><a href="#cb367-1" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb367-2"><a href="#cb367-2" tabindex="-1"></a>  <span class="at">N =</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">30</span>),</span>
<span id="cb367-3"><a href="#cb367-3" tabindex="-1"></a>  <span class="at">mu1 =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">8</span>, <span class="dv">12</span>),</span>
<span id="cb367-4"><a href="#cb367-4" tabindex="-1"></a>  <span class="at">lambda =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">1.0</span>),</span>
<span id="cb367-5"><a href="#cb367-5" tabindex="-1"></a>  <span class="at">rho =</span> <span class="fu">seq</span>(<span class="fl">0.0</span>, <span class="fl">0.7</span>, <span class="fl">0.1</span>)</span>
<span id="cb367-6"><a href="#cb367-6" tabindex="-1"></a>)</span></code></pre></div>
<p>However, we generally find it useful to create a list of design factors before creating the full grid of parameter values, so we prefer to make <code>design_factors</code> first. To use <code>expand_grid()</code> on a list, we need to use <code>!!!</code>, the splice operator from the <code>rlang</code> package, which treats <code>design_factors</code> as a set of arguments to be passed to <code>expand_grid</code>. The syntax may look a bit wacky, but it is succinct and useful.<a href="exp-design.html#fnref15" class="footnote-back">↩︎</a></p></li>
<li id="fn16"><p>Just like <code>map()</code> or <code>map2()</code>, <code>pmap()</code> has variants such as <code>_dbl</code> or <code>_df</code>.
These variants automatically stack or convert the list of things returned into a tidier collection (for <code>_dbl</code> it will convert to a vector of numbers, for <code>_df</code> it will stack the results to make a large dataframe, assuming each thing returned is a little dataframe).<a href="exp-design.html#fnref16" class="footnote-back">↩︎</a></p></li>
<li id="fn17"><p>In fact, if we use the same seed, we should obtain <em>exactly</em> the same results.<a href="exp-design.html#fnref17" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="performance-criteria.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="presentation-of-results.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": {
    "github": false,
    "facebook": true,
    "twitter": true,
    "linkedin": false,
    "weibo": false,
    "instapaper": false,
    "vk": false,
    "whatsapp": false,
    "all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
  },
  "fontsettings": {
    "theme": "white",
    "family": "sans",
    "size": 2
  },
  "edit": {
    "link": "https://github.com/jepusto/Designing-Simulations-in-R/edit/master/070-experimental-design.Rmd",
    "text": "Edit"
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": null,
    "text": null
  },
  "download": ["Designing-Simulations-in-R.pdf", "Designing-Simulations-in-R.epub"],
  "search": {
    "engine": "lunr",
    "options": null
  },
  "toc": {
    "collapse": "section",
    "scroll_highlight": true
  },
  "toolbar": {
    "position": "fixed"
  },
  "info": true
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
