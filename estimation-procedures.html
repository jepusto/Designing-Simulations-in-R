<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 7 Estimation procedures | Designing Monte Carlo Simulations in R</title>
  <meta name="description" content="A text on designing, implementing, and reporting on Monte Carlo simulation studies" />
  <meta name="generator" content="bookdown 0.45 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 7 Estimation procedures | Designing Monte Carlo Simulations in R" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="A text on designing, implementing, and reporting on Monte Carlo simulation studies" />
  <meta name="github-repo" content="jepusto/Designing-Simulations-in-R" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 7 Estimation procedures | Designing Monte Carlo Simulations in R" />
  
  <meta name="twitter:description" content="A text on designing, implementing, and reporting on Monte Carlo simulation studies" />
  

<meta name="author" content="Luke W. Miratrix and James E. Pustejovsky (Equal authors)" />


<meta name="date" content="2026-01-16" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="data-generating-processes.html"/>
<link rel="next" href="running-the-simulation-process.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
<span class="math inline">
\(\newcommand{\Prob}{\text{Pr}}\)
\(\newcommand{\E}{\mathbb{E}}\)
\(\newcommand{\M}{\mathbb{M}}\)
\(\newcommand{\Q}{\mathbb{Q}}\)
\(\newcommand{\Var}{\text{Var}}\)
\(\newcommand{\Bias}{\text{Bias}}\)
\(\newcommand{\RMSE}{\text{RMSE}}\)
\(\newcommand{\Cov}{\text{Cov}}\)
\(\newcommand{\cor}{\text{cor}}\)
\(\newcommand{\diag}{\text{diag}}\)
\(\newcommand{\mat}[1]{\mathbf{#1}}\)
\(\newcommand{\bs}{\boldsymbol}\)
\(\newcommand{\trace}{\text{tr}}\)
</span>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Designing Simulations in R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#license"><i class="fa fa-check"></i>License</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#about-the-authors"><i class="fa fa-check"></i>About the authors</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#acknowledgements"><i class="fa fa-check"></i>Acknowledgements</a></li>
</ul></li>
<li class="part"><span><b>I An Introductory Look</b></span></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="introduction.html"><a href="introduction.html#some-of-simulations-many-uses"><i class="fa fa-check"></i><b>1.1</b> Some of simulation’s many uses</a>
<ul>
<li class="chapter" data-level="1.1.1" data-path="introduction.html"><a href="introduction.html#comparing-statistical-approaches"><i class="fa fa-check"></i><b>1.1.1</b> Comparing statistical approaches</a></li>
<li class="chapter" data-level="1.1.2" data-path="introduction.html"><a href="introduction.html#assessing-performance-of-complex-pipelines"><i class="fa fa-check"></i><b>1.1.2</b> Assessing performance of complex pipelines</a></li>
<li class="chapter" data-level="1.1.3" data-path="introduction.html"><a href="introduction.html#assessing-performance-under-misspecification"><i class="fa fa-check"></i><b>1.1.3</b> Assessing performance under misspecification</a></li>
<li class="chapter" data-level="1.1.4" data-path="introduction.html"><a href="introduction.html#assessing-the-finite-sample-performance-of-a-statistical-approach"><i class="fa fa-check"></i><b>1.1.4</b> Assessing the finite-sample performance of a statistical approach</a></li>
<li class="chapter" data-level="1.1.5" data-path="introduction.html"><a href="introduction.html#conducting-power-analyses"><i class="fa fa-check"></i><b>1.1.5</b> Conducting Power Analyses</a></li>
<li class="chapter" data-level="1.1.6" data-path="introduction.html"><a href="introduction.html#simulating-processess"><i class="fa fa-check"></i><b>1.1.6</b> Simulating processess</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="introduction.html"><a href="introduction.html#the-perils-of-simulation-as-evidence"><i class="fa fa-check"></i><b>1.2</b> The perils of simulation as evidence</a></li>
<li class="chapter" data-level="1.3" data-path="introduction.html"><a href="introduction.html#simulating-to-learn"><i class="fa fa-check"></i><b>1.3</b> Simulating to learn</a></li>
<li class="chapter" data-level="1.4" data-path="introduction.html"><a href="introduction.html#why-r"><i class="fa fa-check"></i><b>1.4</b> Why R?</a></li>
<li class="chapter" data-level="1.5" data-path="introduction.html"><a href="introduction.html#organization-of-the-text"><i class="fa fa-check"></i><b>1.5</b> Organization of the text</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html"><i class="fa fa-check"></i><b>2</b> Programming Preliminaries</a>
<ul>
<li class="chapter" data-level="2.1" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#welcome-to-the-tidyverse"><i class="fa fa-check"></i><b>2.1</b> Welcome to the tidyverse</a></li>
<li class="chapter" data-level="2.2" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#functions"><i class="fa fa-check"></i><b>2.2</b> Functions</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#rolling-your-own"><i class="fa fa-check"></i><b>2.2.1</b> Rolling your own</a></li>
<li class="chapter" data-level="2.2.2" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#a-dangerous-function"><i class="fa fa-check"></i><b>2.2.2</b> A dangerous function</a></li>
<li class="chapter" data-level="2.2.3" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#using-named-arguments"><i class="fa fa-check"></i><b>2.2.3</b> Using Named Arguments</a></li>
<li class="chapter" data-level="2.2.4" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#argument-defaults"><i class="fa fa-check"></i><b>2.2.4</b> Argument Defaults</a></li>
<li class="chapter" data-level="2.2.5" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#function-skeletons"><i class="fa fa-check"></i><b>2.2.5</b> Function skeletons</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#pipe-dreams"><i class="fa fa-check"></i><b>2.3</b> <code>\&gt;</code> (Pipe) dreams</a></li>
<li class="chapter" data-level="2.4" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#recipes-versus-patterns"><i class="fa fa-check"></i><b>2.4</b> Recipes versus Patterns</a></li>
<li class="chapter" data-level="2.5" data-path="programming-preliminaries.html"><a href="programming-preliminaries.html#exercises"><i class="fa fa-check"></i><b>2.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="t-test-simulation.html"><a href="t-test-simulation.html"><i class="fa fa-check"></i><b>3</b> An initial simulation</a>
<ul>
<li class="chapter" data-level="3.1" data-path="t-test-simulation.html"><a href="t-test-simulation.html#simulating-a-single-scenario"><i class="fa fa-check"></i><b>3.1</b> Simulating a single scenario</a></li>
<li class="chapter" data-level="3.2" data-path="t-test-simulation.html"><a href="t-test-simulation.html#a-non-normal-population-distribution"><i class="fa fa-check"></i><b>3.2</b> A non-normal population distribution</a></li>
<li class="chapter" data-level="3.3" data-path="t-test-simulation.html"><a href="t-test-simulation.html#simulating-across-different-scenarios"><i class="fa fa-check"></i><b>3.3</b> Simulating across different scenarios</a></li>
<li class="chapter" data-level="3.4" data-path="t-test-simulation.html"><a href="t-test-simulation.html#extending-the-simulation-design"><i class="fa fa-check"></i><b>3.4</b> Extending the simulation design</a></li>
<li class="chapter" data-level="3.5" data-path="t-test-simulation.html"><a href="t-test-simulation.html#exercises-1"><i class="fa fa-check"></i><b>3.5</b> Exercises</a></li>
</ul></li>
<li class="part"><span><b>II Structure and Mechanics of a Simulation Study</b></span></li>
<li class="chapter" data-level="4" data-path="simulation-structure.html"><a href="simulation-structure.html"><i class="fa fa-check"></i><b>4</b> Structure of a simulation study</a>
<ul>
<li class="chapter" data-level="4.1" data-path="simulation-structure.html"><a href="simulation-structure.html#general-structure-of-a-simulation"><i class="fa fa-check"></i><b>4.1</b> General structure of a simulation</a></li>
<li class="chapter" data-level="4.2" data-path="simulation-structure.html"><a href="simulation-structure.html#tidy-modular-simulations"><i class="fa fa-check"></i><b>4.2</b> Tidy, modular simulations</a></li>
<li class="chapter" data-level="4.3" data-path="simulation-structure.html"><a href="simulation-structure.html#skeleton-of-a-simulation-study"><i class="fa fa-check"></i><b>4.3</b> Skeleton of a simulation study</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="simulation-structure.html"><a href="simulation-structure.html#data-generating-process"><i class="fa fa-check"></i><b>4.3.1</b> Data-Generating Process</a></li>
<li class="chapter" data-level="4.3.2" data-path="simulation-structure.html"><a href="simulation-structure.html#data-analysis-procedure"><i class="fa fa-check"></i><b>4.3.2</b> Data Analysis Procedure</a></li>
<li class="chapter" data-level="4.3.3" data-path="simulation-structure.html"><a href="simulation-structure.html#repetition"><i class="fa fa-check"></i><b>4.3.3</b> Repetition</a></li>
<li class="chapter" data-level="4.3.4" data-path="simulation-structure.html"><a href="simulation-structure.html#performance-summaries"><i class="fa fa-check"></i><b>4.3.4</b> Performance summaries</a></li>
<li class="chapter" data-level="4.3.5" data-path="simulation-structure.html"><a href="simulation-structure.html#multifactor-simulations"><i class="fa fa-check"></i><b>4.3.5</b> Multifactor simulations</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="simulation-structure.html"><a href="simulation-structure.html#exercises-2"><i class="fa fa-check"></i><b>4.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="case-ANOVA.html"><a href="case-ANOVA.html"><i class="fa fa-check"></i><b>5</b> Case Study: Heteroskedastic ANOVA and Welch</a>
<ul>
<li class="chapter" data-level="5.1" data-path="case-ANOVA.html"><a href="case-ANOVA.html#case-anova-DGP"><i class="fa fa-check"></i><b>5.1</b> The data-generating model</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="case-ANOVA.html"><a href="case-ANOVA.html#now-make-a-function"><i class="fa fa-check"></i><b>5.1.1</b> Now make a function</a></li>
<li class="chapter" data-level="5.1.2" data-path="case-ANOVA.html"><a href="case-ANOVA.html#cautious-coding"><i class="fa fa-check"></i><b>5.1.2</b> Cautious coding</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="case-ANOVA.html"><a href="case-ANOVA.html#ANOVA-hypothesis-testing-function"><i class="fa fa-check"></i><b>5.2</b> The hypothesis testing procedures</a></li>
<li class="chapter" data-level="5.3" data-path="case-ANOVA.html"><a href="case-ANOVA.html#running-the-simulation"><i class="fa fa-check"></i><b>5.3</b> Running the simulation</a></li>
<li class="chapter" data-level="5.4" data-path="case-ANOVA.html"><a href="case-ANOVA.html#summarizing-test-performance"><i class="fa fa-check"></i><b>5.4</b> Summarizing test performance</a></li>
<li class="chapter" data-level="5.5" data-path="case-ANOVA.html"><a href="case-ANOVA.html#exAnovaExercises"><i class="fa fa-check"></i><b>5.5</b> Exercises</a>
<ul>
<li class="chapter" data-level="5.5.1" data-path="case-ANOVA.html"><a href="case-ANOVA.html#BF-other-alphas"><i class="fa fa-check"></i><b>5.5.1</b> Other <span class="math inline">\(\alpha\)</span>’s</a></li>
<li class="chapter" data-level="5.5.2" data-path="case-ANOVA.html"><a href="case-ANOVA.html#BF-compare-results"><i class="fa fa-check"></i><b>5.5.2</b> Compare results</a></li>
<li class="chapter" data-level="5.5.3" data-path="case-ANOVA.html"><a href="case-ANOVA.html#BF-power"><i class="fa fa-check"></i><b>5.5.3</b> Power</a></li>
<li class="chapter" data-level="5.5.4" data-path="case-ANOVA.html"><a href="case-ANOVA.html#BF-wide-long"><i class="fa fa-check"></i><b>5.5.4</b> Wide or long?</a></li>
<li class="chapter" data-level="5.5.5" data-path="case-ANOVA.html"><a href="case-ANOVA.html#BF-other-tests"><i class="fa fa-check"></i><b>5.5.5</b> Other tests</a></li>
<li class="chapter" data-level="5.5.6" data-path="case-ANOVA.html"><a href="case-ANOVA.html#methodological-extensions"><i class="fa fa-check"></i><b>5.5.6</b> Methodological extensions</a></li>
<li class="chapter" data-level="5.5.7" data-path="case-ANOVA.html"><a href="case-ANOVA.html#power-analysis"><i class="fa fa-check"></i><b>5.5.7</b> Power analysis</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="data-generating-processes.html"><a href="data-generating-processes.html"><i class="fa fa-check"></i><b>6</b> Data-generating processes</a>
<ul>
<li class="chapter" data-level="6.1" data-path="data-generating-processes.html"><a href="data-generating-processes.html#DGP-examples"><i class="fa fa-check"></i><b>6.1</b> Examples</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="data-generating-processes.html"><a href="data-generating-processes.html#ANOVA-example"><i class="fa fa-check"></i><b>6.1.1</b> Example 1: One-way analysis of variance</a></li>
<li class="chapter" data-level="6.1.2" data-path="data-generating-processes.html"><a href="data-generating-processes.html#BVPois-example"><i class="fa fa-check"></i><b>6.1.2</b> Example 2: Bivariate Poisson model</a></li>
<li class="chapter" data-level="6.1.3" data-path="data-generating-processes.html"><a href="data-generating-processes.html#CRT-example"><i class="fa fa-check"></i><b>6.1.3</b> Example 3: Hierarchical linear model for a cluster-randomized trial</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="data-generating-processes.html"><a href="data-generating-processes.html#components-of-a-dgp"><i class="fa fa-check"></i><b>6.2</b> Components of a DGP</a></li>
<li class="chapter" data-level="6.3" data-path="data-generating-processes.html"><a href="data-generating-processes.html#DGP-functions"><i class="fa fa-check"></i><b>6.3</b> A statistical model is a recipe for data generation</a></li>
<li class="chapter" data-level="6.4" data-path="data-generating-processes.html"><a href="data-generating-processes.html#DGP-plotting"><i class="fa fa-check"></i><b>6.4</b> Plot the artificial data</a></li>
<li class="chapter" data-level="6.5" data-path="data-generating-processes.html"><a href="data-generating-processes.html#check-the-data-generating-function"><i class="fa fa-check"></i><b>6.5</b> Check the data-generating function</a></li>
<li class="chapter" data-level="6.6" data-path="data-generating-processes.html"><a href="data-generating-processes.html#case-cluster"><i class="fa fa-check"></i><b>6.6</b> Example: Simulating clustered data</a>
<ul>
<li class="chapter" data-level="6.6.1" data-path="data-generating-processes.html"><a href="data-generating-processes.html#a-design-decision-what-do-we-want-to-manipulate"><i class="fa fa-check"></i><b>6.6.1</b> A design decision: What do we want to manipulate?</a></li>
<li class="chapter" data-level="6.6.2" data-path="data-generating-processes.html"><a href="data-generating-processes.html#a-model-for-a-cluster-rct"><i class="fa fa-check"></i><b>6.6.2</b> A model for a cluster RCT</a></li>
<li class="chapter" data-level="6.6.3" data-path="data-generating-processes.html"><a href="data-generating-processes.html#from-equations-to-code"><i class="fa fa-check"></i><b>6.6.3</b> From equations to code</a></li>
<li class="chapter" data-level="6.6.4" data-path="data-generating-processes.html"><a href="data-generating-processes.html#DGP-standardization"><i class="fa fa-check"></i><b>6.6.4</b> Standardization in the DGP</a></li>
</ul></li>
<li class="chapter" data-level="6.7" data-path="data-generating-processes.html"><a href="data-generating-processes.html#three-parameter-IRT"><i class="fa fa-check"></i><b>6.7</b> Sometimes a DGP is all you need</a></li>
<li class="chapter" data-level="6.8" data-path="data-generating-processes.html"><a href="data-generating-processes.html#more-to-explore"><i class="fa fa-check"></i><b>6.8</b> More to explore</a></li>
<li class="chapter" data-level="6.9" data-path="data-generating-processes.html"><a href="data-generating-processes.html#exercises-3"><i class="fa fa-check"></i><b>6.9</b> Exercises</a>
<ul>
<li class="chapter" data-level="6.9.1" data-path="data-generating-processes.html"><a href="data-generating-processes.html#Welch-t-dgp"><i class="fa fa-check"></i><b>6.9.1</b> The Welch test on a shifted-and-scaled <span class="math inline">\(t\)</span> distribution</a></li>
<li class="chapter" data-level="6.9.2" data-path="data-generating-processes.html"><a href="data-generating-processes.html#plot-the-bivariate-poisson"><i class="fa fa-check"></i><b>6.9.2</b> Plot the bivariate Poisson</a></li>
<li class="chapter" data-level="6.9.3" data-path="data-generating-processes.html"><a href="data-generating-processes.html#BVP-check"><i class="fa fa-check"></i><b>6.9.3</b> Check the bivariate Poisson function</a></li>
<li class="chapter" data-level="6.9.4" data-path="data-generating-processes.html"><a href="data-generating-processes.html#BVP-error"><i class="fa fa-check"></i><b>6.9.4</b> Add error-catching to the bivariate Poisson function</a></li>
<li class="chapter" data-level="6.9.5" data-path="data-generating-processes.html"><a href="data-generating-processes.html#BVNB1"><i class="fa fa-check"></i><b>6.9.5</b> A bivariate negative binomial distribution</a></li>
<li class="chapter" data-level="6.9.6" data-path="data-generating-processes.html"><a href="data-generating-processes.html#BVNB2"><i class="fa fa-check"></i><b>6.9.6</b> Another bivariate negative binomial distribution</a></li>
<li class="chapter" data-level="6.9.7" data-path="data-generating-processes.html"><a href="data-generating-processes.html#cluster-RCT-plot"><i class="fa fa-check"></i><b>6.9.7</b> Plot the data from a cluster-randomized trial</a></li>
<li class="chapter" data-level="6.9.8" data-path="data-generating-processes.html"><a href="data-generating-processes.html#cluster-RCT-checks"><i class="fa fa-check"></i><b>6.9.8</b> Checking the Cluster RCT DGP</a></li>
<li class="chapter" data-level="6.9.9" data-path="data-generating-processes.html"><a href="data-generating-processes.html#cluster-RCT-heterogeneity"><i class="fa fa-check"></i><b>6.9.9</b> More school-level variation</a></li>
<li class="chapter" data-level="6.9.10" data-path="data-generating-processes.html"><a href="data-generating-processes.html#cluster-RCT-baseline"><i class="fa fa-check"></i><b>6.9.10</b> Cluster-randomized trial with baseline predictors</a></li>
<li class="chapter" data-level="6.9.11" data-path="data-generating-processes.html"><a href="data-generating-processes.html#IRT-DGP-parameters"><i class="fa fa-check"></i><b>6.9.11</b> 3-parameter IRT datasets</a></li>
<li class="chapter" data-level="6.9.12" data-path="data-generating-processes.html"><a href="data-generating-processes.html#IRT-DGP-checking"><i class="fa fa-check"></i><b>6.9.12</b> Check the 3-parameter IRT DGP</a></li>
<li class="chapter" data-level="6.9.13" data-path="data-generating-processes.html"><a href="data-generating-processes.html#IRT-DGP-breaking"><i class="fa fa-check"></i><b>6.9.13</b> Explore the 3-parameter IRT model</a></li>
<li class="chapter" data-level="6.9.14" data-path="data-generating-processes.html"><a href="data-generating-processes.html#meta-regression-DGP"><i class="fa fa-check"></i><b>6.9.14</b> Random effects meta-regression</a></li>
<li class="chapter" data-level="6.9.15" data-path="data-generating-processes.html"><a href="data-generating-processes.html#Vevea-Hedges-DGP"><i class="fa fa-check"></i><b>6.9.15</b> Meta-regression with selective reporting</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="estimation-procedures.html"><a href="estimation-procedures.html"><i class="fa fa-check"></i><b>7</b> Estimation procedures</a>
<ul>
<li class="chapter" data-level="7.1" data-path="estimation-procedures.html"><a href="estimation-procedures.html#estimation-functions"><i class="fa fa-check"></i><b>7.1</b> Writing estimation functions</a></li>
<li class="chapter" data-level="7.2" data-path="estimation-procedures.html"><a href="estimation-procedures.html#multiple-estimation-procedures"><i class="fa fa-check"></i><b>7.2</b> Including Multiple Data Analysis Procedures</a></li>
<li class="chapter" data-level="7.3" data-path="estimation-procedures.html"><a href="estimation-procedures.html#validating-estimation-function"><i class="fa fa-check"></i><b>7.3</b> Validating an Estimation Function</a>
<ul>
<li class="chapter" data-level="7.3.1" data-path="estimation-procedures.html"><a href="estimation-procedures.html#checking-against-existing-implementations"><i class="fa fa-check"></i><b>7.3.1</b> Checking against existing implementations</a></li>
<li class="chapter" data-level="7.3.2" data-path="estimation-procedures.html"><a href="estimation-procedures.html#checking-novel-procedures"><i class="fa fa-check"></i><b>7.3.2</b> Checking novel procedures</a></li>
<li class="chapter" data-level="7.3.3" data-path="estimation-procedures.html"><a href="estimation-procedures.html#checking-with-simulations"><i class="fa fa-check"></i><b>7.3.3</b> Checking with simulations</a></li>
</ul></li>
<li class="chapter" data-level="7.4" data-path="estimation-procedures.html"><a href="estimation-procedures.html#error-handling"><i class="fa fa-check"></i><b>7.4</b> Handling errors, warnings, and other hiccups</a>
<ul>
<li class="chapter" data-level="7.4.1" data-path="estimation-procedures.html"><a href="estimation-procedures.html#capturing-errors-and-warnings"><i class="fa fa-check"></i><b>7.4.1</b> Capturing errors and warnings</a></li>
<li class="chapter" data-level="7.4.2" data-path="estimation-procedures.html"><a href="estimation-procedures.html#adapting-for-errors"><i class="fa fa-check"></i><b>7.4.2</b> Adapting estimators for errors and warnings</a></li>
<li class="chapter" data-level="7.4.3" data-path="estimation-procedures.html"><a href="estimation-procedures.html#the-safely-option"><i class="fa fa-check"></i><b>7.4.3</b> The <code>safely()</code> option</a></li>
</ul></li>
<li class="chapter" data-level="7.5" data-path="estimation-procedures.html"><a href="estimation-procedures.html#exercises-4"><i class="fa fa-check"></i><b>7.5</b> Exercises</a>
<ul>
<li class="chapter" data-level="7.5.1" data-path="estimation-procedures.html"><a href="estimation-procedures.html#BFFs-forever"><i class="fa fa-check"></i><b>7.5.1</b> More Heteroskedastic ANOVA</a></li>
<li class="chapter" data-level="7.5.2" data-path="estimation-procedures.html"><a href="estimation-procedures.html#contingent-testing"><i class="fa fa-check"></i><b>7.5.2</b> Contingent testing</a></li>
<li class="chapter" data-level="7.5.3" data-path="estimation-procedures.html"><a href="estimation-procedures.html#cross-check-CRT-estimators"><i class="fa fa-check"></i><b>7.5.3</b> Check the cluster-RCT functions</a></li>
<li class="chapter" data-level="7.5.4" data-path="estimation-procedures.html"><a href="estimation-procedures.html#CRT-ANCOVA-estimators"><i class="fa fa-check"></i><b>7.5.4</b> Extending the cluster-RCT functions</a></li>
<li class="chapter" data-level="7.5.5" data-path="estimation-procedures.html"><a href="estimation-procedures.html#contingent-estimator-processing"><i class="fa fa-check"></i><b>7.5.5</b> Contingent estimator processing</a></li>
<li class="chapter" data-level="7.5.6" data-path="estimation-procedures.html"><a href="estimation-procedures.html#IRT-3PL-estimation"><i class="fa fa-check"></i><b>7.5.6</b> Estimating 3-parameter item response theory models</a></li>
<li class="chapter" data-level="7.5.7" data-path="estimation-procedures.html"><a href="estimation-procedures.html#Vevea-Hedges-estimation"><i class="fa fa-check"></i><b>7.5.7</b> Meta-regression with selective reporting</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html"><i class="fa fa-check"></i><b>8</b> Running the Simulation Process</a>
<ul>
<li class="chapter" data-level="8.1" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#repeating-oneself"><i class="fa fa-check"></i><b>8.1</b> Repeating oneself</a></li>
<li class="chapter" data-level="8.2" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#one-run-at-a-time"><i class="fa fa-check"></i><b>8.2</b> One run at a time</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#one-run-reparameterization"><i class="fa fa-check"></i><b>8.2.1</b> Reparameterizing</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#bundle-sim-demo"><i class="fa fa-check"></i><b>8.3</b> Bundling simulations with <code>simhelpers</code></a></li>
<li class="chapter" data-level="8.4" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#seeds-and-pseudo-RNGs"><i class="fa fa-check"></i><b>8.4</b> Seeds and pseudo-random number generators</a></li>
<li class="chapter" data-level="8.5" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#exercises-5"><i class="fa fa-check"></i><b>8.5</b> Exercises</a>
<ul>
<li class="chapter" data-level="8.5.1" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#Welch-simulation"><i class="fa fa-check"></i><b>8.5.1</b> Welch simulations</a></li>
<li class="chapter" data-level="8.5.2" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#Pearson-sampling-distributions"><i class="fa fa-check"></i><b>8.5.2</b> Compare sampling distributions of Pearson’s correlation coefficients</a></li>
<li class="chapter" data-level="8.5.3" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#reparameterization-redux"><i class="fa fa-check"></i><b>8.5.3</b> Reparameterization, redux</a></li>
<li class="chapter" data-level="8.5.4" data-path="running-the-simulation-process.html"><a href="running-the-simulation-process.html#fancy-cluster-RCT-sims"><i class="fa fa-check"></i><b>8.5.4</b> Fancy clustered RCT simulations</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="performance-measures.html"><a href="performance-measures.html"><i class="fa fa-check"></i><b>9</b> Performance Measures</a>
<ul>
<li class="chapter" data-level="9.1" data-path="performance-measures.html"><a href="performance-measures.html#assessing-point-estimators"><i class="fa fa-check"></i><b>9.1</b> Measures for Point Estimators</a>
<ul>
<li class="chapter" data-level="9.1.1" data-path="performance-measures.html"><a href="performance-measures.html#clusterRCTperformance"><i class="fa fa-check"></i><b>9.1.1</b> Comparing the Performance of the Cluster RCT Estimation Procedures</a></li>
<li class="chapter" data-level="9.1.2" data-path="performance-measures.html"><a href="performance-measures.html#less-conventional-measures"><i class="fa fa-check"></i><b>9.1.2</b> Less Conventional Performance Measures</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="performance-measures.html"><a href="performance-measures.html#measures-for-variance-estimators"><i class="fa fa-check"></i><b>9.2</b> Measures for Variance Estimators</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="performance-measures.html"><a href="performance-measures.html#satterthwaite-degrees-of-freedom"><i class="fa fa-check"></i><b>9.2.1</b> Satterthwaite degrees of freedom</a></li>
<li class="chapter" data-level="9.2.2" data-path="performance-measures.html"><a href="performance-measures.html#assessing-ses-for-the-cluster-rct-simulation"><i class="fa fa-check"></i><b>9.2.2</b> Assessing SEs for the Cluster RCT Simulation</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="performance-measures.html"><a href="performance-measures.html#measures-for-confidence-intervals"><i class="fa fa-check"></i><b>9.3</b> Measures for Confidence Intervals</a>
<ul>
<li class="chapter" data-level="9.3.1" data-path="performance-measures.html"><a href="performance-measures.html#cluster-RCT-CI-coverage"><i class="fa fa-check"></i><b>9.3.1</b> Confidence Intervals in the Cluster RCT Simulation</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="performance-measures.html"><a href="performance-measures.html#assessing-inferential-procedures"><i class="fa fa-check"></i><b>9.4</b> Measures for Inferential Procedures (Hypothesis Tests)</a>
<ul>
<li class="chapter" data-level="9.4.1" data-path="performance-measures.html"><a href="performance-measures.html#validity"><i class="fa fa-check"></i><b>9.4.1</b> Validity</a></li>
<li class="chapter" data-level="9.4.2" data-path="performance-measures.html"><a href="performance-measures.html#power"><i class="fa fa-check"></i><b>9.4.2</b> Power</a></li>
<li class="chapter" data-level="9.4.3" data-path="performance-measures.html"><a href="performance-measures.html#rejection-rates"><i class="fa fa-check"></i><b>9.4.3</b> Rejection Rates</a></li>
<li class="chapter" data-level="9.4.4" data-path="performance-measures.html"><a href="performance-measures.html#inference-in-the-cluster-rct-simulation"><i class="fa fa-check"></i><b>9.4.4</b> Inference in the Cluster RCT Simulation</a></li>
</ul></li>
<li class="chapter" data-level="9.5" data-path="performance-measures.html"><a href="performance-measures.html#sec-relative-performance"><i class="fa fa-check"></i><b>9.5</b> Relative or Absolute Measures?</a>
<ul>
<li class="chapter" data-level="9.5.1" data-path="performance-measures.html"><a href="performance-measures.html#performance-relative-to-a-benchmark-estimator"><i class="fa fa-check"></i><b>9.5.1</b> Performance relative to a benchmark estimator</a></li>
</ul></li>
<li class="chapter" data-level="9.6" data-path="performance-measures.html"><a href="performance-measures.html#implicit-estimands"><i class="fa fa-check"></i><b>9.6</b> Estimands Not Represented By a Parameter</a></li>
<li class="chapter" data-level="9.7" data-path="performance-measures.html"><a href="performance-measures.html#MCSE"><i class="fa fa-check"></i><b>9.7</b> Uncertainty in Performance Estimates (the Monte Carlo Standard Error)</a>
<ul>
<li class="chapter" data-level="9.7.1" data-path="performance-measures.html"><a href="performance-measures.html#conventional-measures-for-point-estimators"><i class="fa fa-check"></i><b>9.7.1</b> Conventional measures for point estimators</a></li>
<li class="chapter" data-level="9.7.2" data-path="performance-measures.html"><a href="performance-measures.html#less-conventional-measures-for-point-estimators"><i class="fa fa-check"></i><b>9.7.2</b> Less conventional measures for point estimators</a></li>
<li class="chapter" data-level="9.7.3" data-path="performance-measures.html"><a href="performance-measures.html#MCSE-for-relative-variance"><i class="fa fa-check"></i><b>9.7.3</b> MCSE for Relative Variance Estimators</a></li>
<li class="chapter" data-level="9.7.4" data-path="performance-measures.html"><a href="performance-measures.html#mcse-for-confidence-intervals-and-hypothesis-tests"><i class="fa fa-check"></i><b>9.7.4</b> MCSE for Confidence Intervals and Hypothesis Tests</a></li>
<li class="chapter" data-level="9.7.5" data-path="performance-measures.html"><a href="performance-measures.html#calculating-mcses-with-the-simhelpers-package"><i class="fa fa-check"></i><b>9.7.5</b> Calculating MCSEs With the <code>simhelpers</code> Package</a></li>
<li class="chapter" data-level="9.7.6" data-path="performance-measures.html"><a href="performance-measures.html#mcse-calculation-in-our-cluster-rct-example"><i class="fa fa-check"></i><b>9.7.6</b> MCSE Calculation in our Cluster RCT Example</a></li>
</ul></li>
<li class="chapter" data-level="9.8" data-path="performance-measures.html"><a href="performance-measures.html#summary-of-peformance-measures"><i class="fa fa-check"></i><b>9.8</b> Summary of Peformance Measures</a></li>
<li class="chapter" data-level="9.9" data-path="performance-measures.html"><a href="performance-measures.html#concluding-thoughts"><i class="fa fa-check"></i><b>9.9</b> Concluding thoughts</a></li>
<li class="chapter" data-level="9.10" data-path="performance-measures.html"><a href="performance-measures.html#exercises-6"><i class="fa fa-check"></i><b>9.10</b> Exercises</a>
<ul>
<li class="chapter" data-level="9.10.1" data-path="performance-measures.html"><a href="performance-measures.html#Brown-Forsythe-performance"><i class="fa fa-check"></i><b>9.10.1</b> Brown and Forsythe (1974) results</a></li>
<li class="chapter" data-level="9.10.2" data-path="performance-measures.html"><a href="performance-measures.html#size-adjusted-power"><i class="fa fa-check"></i><b>9.10.2</b> Size-adjusted power</a></li>
<li class="chapter" data-level="9.10.3" data-path="performance-measures.html"><a href="performance-measures.html#three-correlation-estimators"><i class="fa fa-check"></i><b>9.10.3</b> Three correlation estimators</a></li>
<li class="chapter" data-level="9.10.4" data-path="performance-measures.html"><a href="performance-measures.html#cluster-RCT-t-confidence-intervals"><i class="fa fa-check"></i><b>9.10.4</b> Confidence interval comparison</a></li>
<li class="chapter" data-level="9.10.5" data-path="performance-measures.html"><a href="performance-measures.html#jackknife-MCSE"><i class="fa fa-check"></i><b>9.10.5</b> Jackknife calculation of MCSEs for RMSE</a></li>
<li class="chapter" data-level="9.10.6" data-path="performance-measures.html"><a href="performance-measures.html#jackknife-MCSE-ratio"><i class="fa fa-check"></i><b>9.10.6</b> Jackknife calculation of MCSEs for RMSE ratios</a></li>
<li class="chapter" data-level="9.10.7" data-path="performance-measures.html"><a href="performance-measures.html#cluster-RCT-SPATE"><i class="fa fa-check"></i><b>9.10.7</b> Distribution theory for person-level average treatment effects</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>III Systematic Simulations</b></span></li>
<li class="chapter" data-level="10" data-path="simulating-multiple-scenarios.html"><a href="simulating-multiple-scenarios.html"><i class="fa fa-check"></i><b>10</b> Simulating across multiple scenarios</a>
<ul>
<li class="chapter" data-level="10.1" data-path="simulating-multiple-scenarios.html"><a href="simulating-multiple-scenarios.html#simulating-across-levels-of-a-single-factor"><i class="fa fa-check"></i><b>10.1</b> Simulating across levels of a single factor</a>
<ul>
<li class="chapter" data-level="10.1.1" data-path="simulating-multiple-scenarios.html"><a href="simulating-multiple-scenarios.html#a-performance-summary-function"><i class="fa fa-check"></i><b>10.1.1</b> A performance summary function</a></li>
<li class="chapter" data-level="10.1.2" data-path="simulating-multiple-scenarios.html"><a href="simulating-multiple-scenarios.html#adding-performance-calculations-to-the-simulation-driver"><i class="fa fa-check"></i><b>10.1.2</b> Adding performance calculations to the simulation driver</a></li>
</ul></li>
<li class="chapter" data-level="10.2" data-path="simulating-multiple-scenarios.html"><a href="simulating-multiple-scenarios.html#simulating-across-multiple-factors"><i class="fa fa-check"></i><b>10.2</b> Simulating across multiple factors</a></li>
<li class="chapter" data-level="10.3" data-path="simulating-multiple-scenarios.html"><a href="simulating-multiple-scenarios.html#using-pmap-to-run-multifactor-simulations"><i class="fa fa-check"></i><b>10.3</b> Using pmap to run multifactor simulations</a></li>
<li class="chapter" data-level="10.4" data-path="simulating-multiple-scenarios.html"><a href="simulating-multiple-scenarios.html#when-to-calculate-performance-metrics"><i class="fa fa-check"></i><b>10.4</b> When to calculate performance metrics</a>
<ul>
<li class="chapter" data-level="10.4.1" data-path="simulating-multiple-scenarios.html"><a href="simulating-multiple-scenarios.html#aggregate-as-you-simulate-inside"><i class="fa fa-check"></i><b>10.4.1</b> Aggregate as you simulate (inside)</a></li>
<li class="chapter" data-level="10.4.2" data-path="simulating-multiple-scenarios.html"><a href="simulating-multiple-scenarios.html#keep-all-simulation-runs-outside"><i class="fa fa-check"></i><b>10.4.2</b> Keep all simulation runs (outside)</a></li>
<li class="chapter" data-level="10.4.3" data-path="simulating-multiple-scenarios.html"><a href="simulating-multiple-scenarios.html#getting-raw-results-ready-for-analysis"><i class="fa fa-check"></i><b>10.4.3</b> Getting raw results ready for analysis</a></li>
</ul></li>
<li class="chapter" data-level="10.5" data-path="simulating-multiple-scenarios.html"><a href="simulating-multiple-scenarios.html#summary"><i class="fa fa-check"></i><b>10.5</b> Summary</a></li>
<li class="chapter" data-level="10.6" data-path="simulating-multiple-scenarios.html"><a href="simulating-multiple-scenarios.html#exercises-7"><i class="fa fa-check"></i><b>10.6</b> Exercises</a>
<ul>
<li class="chapter" data-level="10.6.1" data-path="simulating-multiple-scenarios.html"><a href="simulating-multiple-scenarios.html#extending-Brown-Forsythe-power"><i class="fa fa-check"></i><b>10.6.1</b> Extending Brown and Forsythe</a></li>
<li class="chapter" data-level="10.6.2" data-path="simulating-multiple-scenarios.html"><a href="simulating-multiple-scenarios.html#exercise:trimmed-mean"><i class="fa fa-check"></i><b>10.6.2</b> Comparing the trimmed mean, median and mean</a></li>
<li class="chapter" data-level="10.6.3" data-path="simulating-multiple-scenarios.html"><a href="simulating-multiple-scenarios.html#exercise:multifactor-latent-correlation"><i class="fa fa-check"></i><b>10.6.3</b> Estimating latent correlations</a></li>
<li class="chapter" data-level="10.6.4" data-path="simulating-multiple-scenarios.html"><a href="simulating-multiple-scenarios.html#exercise:multifactor-meta-regression"><i class="fa fa-check"></i><b>10.6.4</b> Meta-regression</a></li>
<li class="chapter" data-level="10.6.5" data-path="simulating-multiple-scenarios.html"><a href="simulating-multiple-scenarios.html#exercise:examine-a-multifactor-simulation-design"><i class="fa fa-check"></i><b>10.6.5</b> Examine a multifactor simulation design</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="11" data-path="designing-multifactor-simulations.html"><a href="designing-multifactor-simulations.html"><i class="fa fa-check"></i><b>11</b> Designing multifactor simulations</a>
<ul>
<li class="chapter" data-level="11.1" data-path="designing-multifactor-simulations.html"><a href="designing-multifactor-simulations.html#choosing-parameter-combinations"><i class="fa fa-check"></i><b>11.1</b> Choosing parameter combinations</a></li>
<li class="chapter" data-level="11.2" data-path="designing-multifactor-simulations.html"><a href="designing-multifactor-simulations.html#case-study-a-multifactor-evaluation-of-cluster-rct-estimators"><i class="fa fa-check"></i><b>11.2</b> Case Study: A multifactor evaluation of cluster RCT estimators</a>
<ul>
<li class="chapter" data-level="11.2.1" data-path="designing-multifactor-simulations.html"><a href="designing-multifactor-simulations.html#choosing-parameters-for-the-clustered-rct"><i class="fa fa-check"></i><b>11.2.1</b> Choosing parameters for the Clustered RCT</a></li>
<li class="chapter" data-level="11.2.2" data-path="designing-multifactor-simulations.html"><a href="designing-multifactor-simulations.html#redundant-factor-combinations"><i class="fa fa-check"></i><b>11.2.2</b> Redundant factor combinations</a></li>
<li class="chapter" data-level="11.2.3" data-path="designing-multifactor-simulations.html"><a href="designing-multifactor-simulations.html#running-the-simulations"><i class="fa fa-check"></i><b>11.2.3</b> Running the simulations</a></li>
<li class="chapter" data-level="11.2.4" data-path="designing-multifactor-simulations.html"><a href="designing-multifactor-simulations.html#calculating-performance-metrics"><i class="fa fa-check"></i><b>11.2.4</b> Calculating performance metrics</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="12" data-path="presentation-of-results.html"><a href="presentation-of-results.html"><i class="fa fa-check"></i><b>12</b> Exploring and presenting simulation results</a>
<ul>
<li class="chapter" data-level="12.1" data-path="presentation-of-results.html"><a href="presentation-of-results.html#tabulation"><i class="fa fa-check"></i><b>12.1</b> Tabulation</a>
<ul>
<li class="chapter" data-level="12.1.1" data-path="presentation-of-results.html"><a href="presentation-of-results.html#example-estimators-of-treatment-variation"><i class="fa fa-check"></i><b>12.1.1</b> Example: estimators of treatment variation</a></li>
</ul></li>
<li class="chapter" data-level="12.2" data-path="presentation-of-results.html"><a href="presentation-of-results.html#visualization"><i class="fa fa-check"></i><b>12.2</b> Visualization</a>
<ul>
<li class="chapter" data-level="12.2.1" data-path="presentation-of-results.html"><a href="presentation-of-results.html#example-0-rmse-in-cluster-rcts"><i class="fa fa-check"></i><b>12.2.1</b> Example 0: RMSE in Cluster RCTs</a></li>
<li class="chapter" data-level="12.2.2" data-path="presentation-of-results.html"><a href="presentation-of-results.html#example-1-biserial-correlation-estimation"><i class="fa fa-check"></i><b>12.2.2</b> Example 1: Biserial correlation estimation</a></li>
<li class="chapter" data-level="12.2.3" data-path="presentation-of-results.html"><a href="presentation-of-results.html#example-2-variance-estimation-and-meta-regression"><i class="fa fa-check"></i><b>12.2.3</b> Example 2: Variance estimation and Meta-regression</a></li>
<li class="chapter" data-level="12.2.4" data-path="presentation-of-results.html"><a href="presentation-of-results.html#example-3-heat-maps-of-coverage"><i class="fa fa-check"></i><b>12.2.4</b> Example 3: Heat maps of coverage</a></li>
<li class="chapter" data-level="12.2.5" data-path="presentation-of-results.html"><a href="presentation-of-results.html#example-4-relative-performance-of-treatment-effect-estimators"><i class="fa fa-check"></i><b>12.2.5</b> Example 4: Relative performance of treatment effect estimators</a></li>
</ul></li>
<li class="chapter" data-level="12.3" data-path="presentation-of-results.html"><a href="presentation-of-results.html#modeling"><i class="fa fa-check"></i><b>12.3</b> Modeling</a>
<ul>
<li class="chapter" data-level="12.3.1" data-path="presentation-of-results.html"><a href="presentation-of-results.html#example-1-biserial-revisited"><i class="fa fa-check"></i><b>12.3.1</b> Example 1: Biserial, revisited</a></li>
<li class="chapter" data-level="12.3.2" data-path="presentation-of-results.html"><a href="presentation-of-results.html#example-2-comparing-methods-for-cross-classified-data"><i class="fa fa-check"></i><b>12.3.2</b> Example 2: Comparing methods for cross-classified data</a></li>
</ul></li>
<li class="chapter" data-level="12.4" data-path="presentation-of-results.html"><a href="presentation-of-results.html#reporting"><i class="fa fa-check"></i><b>12.4</b> Reporting</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="building-good-visualization.html"><a href="building-good-visualization.html"><i class="fa fa-check"></i><b>13</b> Building good visualizations</a>
<ul>
<li class="chapter" data-level="13.1" data-path="building-good-visualization.html"><a href="building-good-visualization.html#subsetting-and-many-small-multiples"><i class="fa fa-check"></i><b>13.1</b> Subsetting and Many Small Multiples</a></li>
<li class="chapter" data-level="13.2" data-path="building-good-visualization.html"><a href="building-good-visualization.html#bundling"><i class="fa fa-check"></i><b>13.2</b> Bundling</a></li>
<li class="chapter" data-level="13.3" data-path="building-good-visualization.html"><a href="building-good-visualization.html#aggregation"><i class="fa fa-check"></i><b>13.3</b> Aggregation</a></li>
<li class="chapter" data-level="13.4" data-path="building-good-visualization.html"><a href="building-good-visualization.html#comparing-true-ses-with-standardization"><i class="fa fa-check"></i><b>13.4</b> Comparing true SEs with standardization</a></li>
<li class="chapter" data-level="13.5" data-path="building-good-visualization.html"><a href="building-good-visualization.html#the-bias-se-rmse-plot"><i class="fa fa-check"></i><b>13.5</b> The Bias-SE-RMSE plot</a></li>
<li class="chapter" data-level="13.6" data-path="building-good-visualization.html"><a href="building-good-visualization.html#assessing-the-quality-of-the-estimated-ses"><i class="fa fa-check"></i><b>13.6</b> Assessing the quality of the estimated SEs</a>
<ul>
<li class="chapter" data-level="13.6.1" data-path="building-good-visualization.html"><a href="building-good-visualization.html#stability-of-estimated-ses"><i class="fa fa-check"></i><b>13.6.1</b> Stability of estimated SEs</a></li>
</ul></li>
<li class="chapter" data-level="13.7" data-path="building-good-visualization.html"><a href="building-good-visualization.html#assessing-confidence-intervals"><i class="fa fa-check"></i><b>13.7</b> Assessing confidence intervals</a></li>
<li class="chapter" data-level="13.8" data-path="building-good-visualization.html"><a href="building-good-visualization.html#exercises-8"><i class="fa fa-check"></i><b>13.8</b> Exercises</a>
<ul>
<li class="chapter" data-level="13.8.1" data-path="building-good-visualization.html"><a href="building-good-visualization.html#assessing-uncertainty"><i class="fa fa-check"></i><b>13.8.1</b> Assessing uncertainty</a></li>
<li class="chapter" data-level="13.8.2" data-path="building-good-visualization.html"><a href="building-good-visualization.html#assessing-power"><i class="fa fa-check"></i><b>13.8.2</b> Assessing power</a></li>
<li class="chapter" data-level="13.8.3" data-path="building-good-visualization.html"><a href="building-good-visualization.html#going-deeper-with-coverage"><i class="fa fa-check"></i><b>13.8.3</b> Going deeper with coverage</a></li>
<li class="chapter" data-level="13.8.4" data-path="building-good-visualization.html"><a href="building-good-visualization.html#pearson-correlations-with-a-bivariate-poisson-distribution"><i class="fa fa-check"></i><b>13.8.4</b> Pearson correlations with a bivariate Poisson distribution</a></li>
<li class="chapter" data-level="13.8.5" data-path="building-good-visualization.html"><a href="building-good-visualization.html#making-another-plot-for-assessing-ses"><i class="fa fa-check"></i><b>13.8.5</b> Making another plot for assessing SEs</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="14" data-path="special-topics-on-reporting-simulation-results.html"><a href="special-topics-on-reporting-simulation-results.html"><i class="fa fa-check"></i><b>14</b> Special Topics on Reporting Simulation Results</a>
<ul>
<li class="chapter" data-level="14.1" data-path="special-topics-on-reporting-simulation-results.html"><a href="special-topics-on-reporting-simulation-results.html#using-regression-to-analyze-simulation-results"><i class="fa fa-check"></i><b>14.1</b> Using regression to analyze simulation results</a>
<ul>
<li class="chapter" data-level="14.1.1" data-path="special-topics-on-reporting-simulation-results.html"><a href="special-topics-on-reporting-simulation-results.html#example-1-biserial-revisited-1"><i class="fa fa-check"></i><b>14.1.1</b> Example 1: Biserial, revisited</a></li>
<li class="chapter" data-level="14.1.2" data-path="special-topics-on-reporting-simulation-results.html"><a href="special-topics-on-reporting-simulation-results.html#example-2-cluster-rct-example-revisited"><i class="fa fa-check"></i><b>14.1.2</b> Example 2: Cluster RCT example, revisited</a></li>
</ul></li>
<li class="chapter" data-level="14.2" data-path="special-topics-on-reporting-simulation-results.html"><a href="special-topics-on-reporting-simulation-results.html#using-regression-trees-to-find-important-factors"><i class="fa fa-check"></i><b>14.2</b> Using regression trees to find important factors</a></li>
<li class="chapter" data-level="14.3" data-path="special-topics-on-reporting-simulation-results.html"><a href="special-topics-on-reporting-simulation-results.html#analyzing-results-with-few-iterations-per-scenario"><i class="fa fa-check"></i><b>14.3</b> Analyzing results with few iterations per scenario</a>
<ul>
<li class="chapter" data-level="14.3.1" data-path="special-topics-on-reporting-simulation-results.html"><a href="special-topics-on-reporting-simulation-results.html#example-clusterrct-with-only-100-replicates-per-scenario"><i class="fa fa-check"></i><b>14.3.1</b> Example: ClusterRCT with only 100 replicates per scenario</a></li>
</ul></li>
<li class="chapter" data-level="14.4" data-path="special-topics-on-reporting-simulation-results.html"><a href="special-topics-on-reporting-simulation-results.html#what-to-do-with-warnings-in-simulations"><i class="fa fa-check"></i><b>14.4</b> What to do with warnings in simulations</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="case-study-comparing-different-estimators.html"><a href="case-study-comparing-different-estimators.html"><i class="fa fa-check"></i><b>15</b> Case study: Comparing different estimators</a>
<ul>
<li class="chapter" data-level="15.1" data-path="case-study-comparing-different-estimators.html"><a href="case-study-comparing-different-estimators.html#bias-variance-tradeoffs"><i class="fa fa-check"></i><b>15.1</b> Bias-variance tradeoffs</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html"><i class="fa fa-check"></i><b>16</b> Simulations as evidence</a>
<ul>
<li class="chapter" data-level="16.1" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#strategies-for-making-relevant-simulations"><i class="fa fa-check"></i><b>16.1</b> Strategies for making relevant simulations</a>
<ul>
<li class="chapter" data-level="16.1.1" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#break-symmetries-and-regularities"><i class="fa fa-check"></i><b>16.1.1</b> Break symmetries and regularities</a></li>
<li class="chapter" data-level="16.1.2" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#make-your-simulation-general-with-an-extensive-multi-factor-experiment"><i class="fa fa-check"></i><b>16.1.2</b> Make your simulation general with an extensive multi-factor experiment</a></li>
<li class="chapter" data-level="16.1.3" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#use-previously-published-simulations-to-beat-them-at-their-own-game"><i class="fa fa-check"></i><b>16.1.3</b> Use previously published simulations to beat them at their own game</a></li>
<li class="chapter" data-level="16.1.4" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#calibrate-simulation-factors-to-real-data"><i class="fa fa-check"></i><b>16.1.4</b> Calibrate simulation factors to real data</a></li>
<li class="chapter" data-level="16.1.5" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#use-real-data-to-obtain-directly"><i class="fa fa-check"></i><b>16.1.5</b> Use real data to obtain directly</a></li>
<li class="chapter" data-level="16.1.6" data-path="simulations-as-evidence.html"><a href="simulations-as-evidence.html#fully-calibrated-simulations"><i class="fa fa-check"></i><b>16.1.6</b> Fully calibrated simulations</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>IV Computational Considerations</b></span></li>
<li class="chapter" data-level="17" data-path="organizing-a-simulation-project.html"><a href="organizing-a-simulation-project.html"><i class="fa fa-check"></i><b>17</b> Organizing a simulation project</a>
<ul>
<li class="chapter" data-level="17.1" data-path="organizing-a-simulation-project.html"><a href="organizing-a-simulation-project.html#well-structured-r-scripts"><i class="fa fa-check"></i><b>17.1</b> Well structured R scripts</a>
<ul>
<li class="chapter" data-level="17.1.1" data-path="organizing-a-simulation-project.html"><a href="organizing-a-simulation-project.html#about-source-command"><i class="fa fa-check"></i><b>17.1.1</b> The source command</a></li>
<li class="chapter" data-level="17.1.2" data-path="organizing-a-simulation-project.html"><a href="organizing-a-simulation-project.html#putting-headers-in-your-.r-file"><i class="fa fa-check"></i><b>17.1.2</b> Putting headers in your .R file</a></li>
<li class="chapter" data-level="17.1.3" data-path="organizing-a-simulation-project.html"><a href="organizing-a-simulation-project.html#about-keeping-tests-with-FALSE"><i class="fa fa-check"></i><b>17.1.3</b> Storing testing code in your scripts</a></li>
</ul></li>
<li class="chapter" data-level="17.2" data-path="organizing-a-simulation-project.html"><a href="organizing-a-simulation-project.html#principled-directory-structures"><i class="fa fa-check"></i><b>17.2</b> Principled directory structures</a></li>
<li class="chapter" data-level="17.3" data-path="organizing-a-simulation-project.html"><a href="organizing-a-simulation-project.html#saving-files"><i class="fa fa-check"></i><b>17.3</b> Saving simulation results</a>
<ul>
<li class="chapter" data-level="17.3.1" data-path="organizing-a-simulation-project.html"><a href="organizing-a-simulation-project.html#saving-simulations-in-general"><i class="fa fa-check"></i><b>17.3.1</b> Saving simulations in general</a></li>
<li class="chapter" data-level="17.3.2" data-path="organizing-a-simulation-project.html"><a href="organizing-a-simulation-project.html#saving-simulations-as-you-go"><i class="fa fa-check"></i><b>17.3.2</b> Saving simulations as you go</a></li>
<li class="chapter" data-level="17.3.3" data-path="organizing-a-simulation-project.html"><a href="organizing-a-simulation-project.html#dynamically-making-directories"><i class="fa fa-check"></i><b>17.3.3</b> Dynamically making directories</a></li>
<li class="chapter" data-level="17.3.4" data-path="organizing-a-simulation-project.html"><a href="organizing-a-simulation-project.html#loading-and-combining-files-of-simulation-results"><i class="fa fa-check"></i><b>17.3.4</b> Loading and combining files of simulation results</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="18" data-path="parallel-processing.html"><a href="parallel-processing.html"><i class="fa fa-check"></i><b>18</b> Parallel Processing</a>
<ul>
<li class="chapter" data-level="18.1" data-path="parallel-processing.html"><a href="parallel-processing.html#parallel-on-your-computer"><i class="fa fa-check"></i><b>18.1</b> Parallel on your computer</a></li>
<li class="chapter" data-level="18.2" data-path="parallel-processing.html"><a href="parallel-processing.html#parallel-on-a-virtual-machine"><i class="fa fa-check"></i><b>18.2</b> Parallel on a virtual machine</a></li>
<li class="chapter" data-level="18.3" data-path="parallel-processing.html"><a href="parallel-processing.html#parallel-on-a-cluster"><i class="fa fa-check"></i><b>18.3</b> Parallel on a cluster</a>
<ul>
<li class="chapter" data-level="18.3.1" data-path="parallel-processing.html"><a href="parallel-processing.html#what-is-a-command-line-interface"><i class="fa fa-check"></i><b>18.3.1</b> What is a command-line interface?</a></li>
<li class="chapter" data-level="18.3.2" data-path="parallel-processing.html"><a href="parallel-processing.html#running-a-job-on-a-cluster"><i class="fa fa-check"></i><b>18.3.2</b> Running a job on a cluster</a></li>
<li class="chapter" data-level="18.3.3" data-path="parallel-processing.html"><a href="parallel-processing.html#checking-on-a-job"><i class="fa fa-check"></i><b>18.3.3</b> Checking on a job</a></li>
<li class="chapter" data-level="18.3.4" data-path="parallel-processing.html"><a href="parallel-processing.html#running-lots-of-jobs-on-a-cluster"><i class="fa fa-check"></i><b>18.3.4</b> Running lots of jobs on a cluster</a></li>
<li class="chapter" data-level="18.3.5" data-path="parallel-processing.html"><a href="parallel-processing.html#resources-for-harvards-odyssey"><i class="fa fa-check"></i><b>18.3.5</b> Resources for Harvard’s Odyssey</a></li>
<li class="chapter" data-level="18.3.6" data-path="parallel-processing.html"><a href="parallel-processing.html#acknowledgements-1"><i class="fa fa-check"></i><b>18.3.6</b> Acknowledgements</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="19" data-path="debugging-and-testing.html"><a href="debugging-and-testing.html"><i class="fa fa-check"></i><b>19</b> Debugging and Testing</a>
<ul>
<li class="chapter" data-level="19.1" data-path="debugging-and-testing.html"><a href="debugging-and-testing.html#about-print"><i class="fa fa-check"></i><b>19.1</b> Debugging with <code>print()</code></a></li>
<li class="chapter" data-level="19.2" data-path="debugging-and-testing.html"><a href="debugging-and-testing.html#about-browser-debugging"><i class="fa fa-check"></i><b>19.2</b> Debugging with <code>browser()</code></a></li>
<li class="chapter" data-level="19.3" data-path="debugging-and-testing.html"><a href="debugging-and-testing.html#debugging-with-debug"><i class="fa fa-check"></i><b>19.3</b> Debugging with <code>debug()</code></a></li>
<li class="chapter" data-level="19.4" data-path="debugging-and-testing.html"><a href="debugging-and-testing.html#about-stopifnot"><i class="fa fa-check"></i><b>19.4</b> Protecting functions with <code>stop()</code></a></li>
<li class="chapter" data-level="19.5" data-path="debugging-and-testing.html"><a href="debugging-and-testing.html#testing-code"><i class="fa fa-check"></i><b>19.5</b> Testing code</a></li>
</ul></li>
<li class="part"><span><b>V Complex Data Structures</b></span></li>
<li class="chapter" data-level="20" data-path="sec:power.html"><a href="sec:power.html"><i class="fa fa-check"></i><b>20</b> Using simulation as a power calculator</a>
<ul>
<li class="chapter" data-level="20.1" data-path="sec:power.html"><a href="sec:power.html#getting-design-parameters-from-pilot-data"><i class="fa fa-check"></i><b>20.1</b> Getting design parameters from pilot data</a></li>
<li class="chapter" data-level="20.2" data-path="sec:power.html"><a href="sec:power.html#the-data-generating-process"><i class="fa fa-check"></i><b>20.2</b> The data generating process</a></li>
<li class="chapter" data-level="20.3" data-path="sec:power.html"><a href="sec:power.html#running-the-simulation-1"><i class="fa fa-check"></i><b>20.3</b> Running the simulation</a></li>
<li class="chapter" data-level="20.4" data-path="sec:power.html"><a href="sec:power.html#evaluating-power"><i class="fa fa-check"></i><b>20.4</b> Evaluating power</a>
<ul>
<li class="chapter" data-level="20.4.1" data-path="sec:power.html"><a href="sec:power.html#checking-validity-of-our-models"><i class="fa fa-check"></i><b>20.4.1</b> Checking validity of our models</a></li>
<li class="chapter" data-level="20.4.2" data-path="sec:power.html"><a href="sec:power.html#assessing-precision-se"><i class="fa fa-check"></i><b>20.4.2</b> Assessing Precision (SE)</a></li>
<li class="chapter" data-level="20.4.3" data-path="sec:power.html"><a href="sec:power.html#assessing-power-1"><i class="fa fa-check"></i><b>20.4.3</b> Assessing power</a></li>
<li class="chapter" data-level="20.4.4" data-path="sec:power.html"><a href="sec:power.html#assessing-minimum-detectable-effects"><i class="fa fa-check"></i><b>20.4.4</b> Assessing Minimum Detectable Effects</a></li>
</ul></li>
<li class="chapter" data-level="20.5" data-path="sec:power.html"><a href="sec:power.html#power-for-multilevel-data"><i class="fa fa-check"></i><b>20.5</b> Power for Multilevel Data</a></li>
</ul></li>
<li class="chapter" data-level="21" data-path="potential-outcomes.html"><a href="potential-outcomes.html"><i class="fa fa-check"></i><b>21</b> Simulation under the Potential Outcomes Framework</a>
<ul>
<li class="chapter" data-level="21.1" data-path="potential-outcomes.html"><a href="potential-outcomes.html#finite-vs.-superpopulation-inference"><i class="fa fa-check"></i><b>21.1</b> Finite vs. Superpopulation inference</a></li>
<li class="chapter" data-level="21.2" data-path="potential-outcomes.html"><a href="potential-outcomes.html#data-generation-processes-for-potential-outcomes"><i class="fa fa-check"></i><b>21.2</b> Data generation processes for potential outcomes</a></li>
<li class="chapter" data-level="21.3" data-path="potential-outcomes.html"><a href="potential-outcomes.html#finite-sample-performance-measures"><i class="fa fa-check"></i><b>21.3</b> Finite sample performance measures</a></li>
<li class="chapter" data-level="21.4" data-path="potential-outcomes.html"><a href="potential-outcomes.html#nested-finite-simulation-procedure"><i class="fa fa-check"></i><b>21.4</b> Nested finite simulation procedure</a></li>
</ul></li>
<li class="chapter" data-level="22" data-path="the-parametric-bootstrap.html"><a href="the-parametric-bootstrap.html"><i class="fa fa-check"></i><b>22</b> The Parametric bootstrap</a>
<ul>
<li class="chapter" data-level="22.1" data-path="the-parametric-bootstrap.html"><a href="the-parametric-bootstrap.html#air-conditioners-a-stolen-case-study"><i class="fa fa-check"></i><b>22.1</b> Air conditioners: a stolen case study</a></li>
</ul></li>
<li class="appendix"><span><b>Appendices</b></span></li>
<li class="chapter" data-level="A" data-path="coding-tidbits.html"><a href="coding-tidbits.html"><i class="fa fa-check"></i><b>A</b> Coding Reference</a>
<ul>
<li class="chapter" data-level="A.1" data-path="coding-tidbits.html"><a href="coding-tidbits.html#more-repeating-oneself"><i class="fa fa-check"></i><b>A.1</b> How to repeat yourself</a>
<ul>
<li class="chapter" data-level="A.1.1" data-path="coding-tidbits.html"><a href="coding-tidbits.html#using-replicate"><i class="fa fa-check"></i><b>A.1.1</b> Using <code>replicate()</code></a></li>
<li class="chapter" data-level="A.1.2" data-path="coding-tidbits.html"><a href="coding-tidbits.html#using-map"><i class="fa fa-check"></i><b>A.1.2</b> Using <code>map()</code></a></li>
<li class="chapter" data-level="A.1.3" data-path="coding-tidbits.html"><a href="coding-tidbits.html#map-with-no-inputs"><i class="fa fa-check"></i><b>A.1.3</b> map with no inputs</a></li>
<li class="chapter" data-level="A.1.4" data-path="coding-tidbits.html"><a href="coding-tidbits.html#other-approaches-for-repetition"><i class="fa fa-check"></i><b>A.1.4</b> Other approaches for repetition</a></li>
</ul></li>
<li class="chapter" data-level="A.2" data-path="coding-tidbits.html"><a href="coding-tidbits.html#default-arguments"><i class="fa fa-check"></i><b>A.2</b> Default arguments for functions</a></li>
<li class="chapter" data-level="A.3" data-path="coding-tidbits.html"><a href="coding-tidbits.html#profiling-code"><i class="fa fa-check"></i><b>A.3</b> Profiling Code</a>
<ul>
<li class="chapter" data-level="A.3.1" data-path="coding-tidbits.html"><a href="coding-tidbits.html#using-sys.time-and-system.time"><i class="fa fa-check"></i><b>A.3.1</b> Using <code>Sys.time()</code> and <code>system.time()</code></a></li>
<li class="chapter" data-level="A.3.2" data-path="coding-tidbits.html"><a href="coding-tidbits.html#the-tictoc-package"><i class="fa fa-check"></i><b>A.3.2</b> The <code>tictoc</code> package</a></li>
<li class="chapter" data-level="A.3.3" data-path="coding-tidbits.html"><a href="coding-tidbits.html#the-bench-package"><i class="fa fa-check"></i><b>A.3.3</b> The <code>bench</code> package</a></li>
<li class="chapter" data-level="A.3.4" data-path="coding-tidbits.html"><a href="coding-tidbits.html#profiling-with-profvis"><i class="fa fa-check"></i><b>A.3.4</b> Profiling with <code>profvis</code></a></li>
</ul></li>
<li class="chapter" data-level="A.4" data-path="coding-tidbits.html"><a href="coding-tidbits.html#optimize-code"><i class="fa fa-check"></i><b>A.4</b> Optimizing code (and why you often shouldn’t)</a>
<ul>
<li class="chapter" data-level="A.4.1" data-path="coding-tidbits.html"><a href="coding-tidbits.html#hand-building-functions"><i class="fa fa-check"></i><b>A.4.1</b> Hand-building functions</a></li>
<li class="chapter" data-level="A.4.2" data-path="coding-tidbits.html"><a href="coding-tidbits.html#sec_comp_efficiency"><i class="fa fa-check"></i><b>A.4.2</b> Computational efficiency versus simplicity</a></li>
<li class="chapter" data-level="A.4.3" data-path="coding-tidbits.html"><a href="coding-tidbits.html#reusing-code-to-speed-up-computation"><i class="fa fa-check"></i><b>A.4.3</b> Reusing code to speed up computation</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="B" data-path="further-readings-and-resources.html"><a href="further-readings-and-resources.html"><i class="fa fa-check"></i><b>B</b> Further readings and resources</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Designing Monte Carlo Simulations in R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="estimation-procedures" class="section level1 hasAnchor" number="7">
<h1><span class="header-section-number">Chapter 7</span> Estimation procedures<a href="estimation-procedures.html#estimation-procedures" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>We do simulation studies to understand how to analyze data.
Thus, the central object of study is a <em>data analysis procedure</em>, or a set of steps or calculations carried out on a dataset.
We want to know how well a procedure would work when applied in practice, and the data generating processes we described in Chapter <a href="data-generating-processes.html#data-generating-processes">6</a> provides a stand-in for real data.
To revisit our consumer product testing analogy from Chapter <a href="introduction.html#introduction">1</a>, the data analysis procedure is the product, and the data generating process is the set of trials to which we subject the product.</p>
<p>Depending on the research question, a data-analysis procedure might be very simple—as simple as just computing a sample correlation—or it might involve something more complex, such as fitting a multilevel model and generating a confidence interval for a specific coefficient.
A data analysis procedure might even involve a combination of several components.
For example, the procedure might entail first running a variable screening procedure and then fitting a random forest on the selected predictor variables.
As another example, a data-analysis procedure might involve using multiple imputation for missingness on key variables, then fitting a statistical model, and then generating predicted values based on the model. For sake of brevity, we will use the term <em>estimation procedure</em> or just <em>estimator</em> to encompass all of these procedures, even ones that involve multi-step or multi-component procedures.</p>
<p>In this chapter, we demonstrate how to implement an estimator in the form of an R function, which we call an <em>estimation function</em>, so that its performance can eventually be evaluated by repeatedly applying it to artificial data.
We start by describing the high-level design of an estimation function and illustrate with some simple examples in Section <a href="estimation-procedures.html#estimation-functions">7.1</a>.</p>
<p>Depending on the research question, we will often be interested in comparing several competing estimators.
In this case, we will create <em>several</em> functions that implement the estimators that we plan to compare.
The easiest approach here is to implement each estimator in turn, and then bundle the collection in a final overall function.
We describe how to do this in Section <a href="estimation-procedures.html#multiple-estimation-procedures">7.2</a>.</p>
<p>In Section <a href="estimation-procedures.html#validating-estimation-function">7.3</a>, we describe strategies for validating the coded-up estimator before running a full simulation.
We offer a few strategies for validating one’s code, including checking against existing implementations, checking theoretical properties, and using simulations to check for bugs.</p>
<p>For a full simulation, an estimator needs to be reliable, not crashing and giving answers across the wide range of datasets to which it is applied.
An estimator will need to be able to handle odd edge cases or pathological datasets that might be generated as we explore a full range of simulation scenarios.
To allow for this, Section <a href="estimation-procedures.html#error-handling">7.4</a> demonstrates several methods for handling common computational problems, such as errors or warnings.</p>
<div id="estimation-functions" class="section level2 hasAnchor" number="7.1">
<h2><span class="header-section-number">7.1</span> Writing estimation functions<a href="estimation-procedures.html#estimation-functions" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In the abstract, a function that implements an estimation procedure should have the following form:</p>
<div class="sourceCode" id="cb159"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb159-1"><a href="estimation-procedures.html#cb159-1" tabindex="-1"></a>estimator <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb159-2"><a href="estimation-procedures.html#cb159-2" tabindex="-1"></a></span>
<span id="cb159-3"><a href="estimation-procedures.html#cb159-3" tabindex="-1"></a>  <span class="co"># calculations/model-fitting/estimation procedures</span></span>
<span id="cb159-4"><a href="estimation-procedures.html#cb159-4" tabindex="-1"></a>  </span>
<span id="cb159-5"><a href="estimation-procedures.html#cb159-5" tabindex="-1"></a>  <span class="fu">return</span>(estimates)</span>
<span id="cb159-6"><a href="estimation-procedures.html#cb159-6" tabindex="-1"></a>}</span></code></pre></div>
<p>An estimator function should take a dataset as input, fit a model or otherwise calculates an estimate, possibly with associated standard errors and so forth, and return these quantities as output.
It can return point estimates of parameters, standard errors, confidence intervals, <span class="math inline">\(p\)</span>-values, predictions, or other quantities.
The calculations in the body of the function should be set up to use datasets that have the same structure (i.e., same dimensions, same variable names) as the output of the corresponding function for generating simulated data.
However, in principle, we should also be able to run the estimation function on real data as well.</p>
<p>As a first example, suppose we want to evaluate a method for generating a confidence interval for Pearson’s sample correlation coefficient when faced with non-normal data.
For bivariate normal data, statistical theory provides some very useful facts.
In particular, it tells us that applying Fisher’s <span class="math inline">\(z\)</span>-transformation of Pearson’s correlation coefficient, which is equivalent to the hyperbolic arc-tangent function (<code>atanh()</code> in R), produces a statistic that is very close to normally distributed.
It also tells us that the empirical standard error of the <span class="math inline">\(z\)</span>-transformed correlation coefficient is simply <span class="math inline">\(1 / \sqrt{N - 3}\)</span>, and thus independent of the correlation parameter.
This makes <span class="math inline">\(z\)</span>-transformation very useful for computing confidence intervals, which can then be back-transformed to the Pearson-<span class="math inline">\(r\)</span> scale.
However, these results are specific to bivariate normal distributions.
Would this transformation work well in the face of non-normal data, such as the bivariate Poisson distribution we coded in Chapter <a href="data-generating-processes.html#data-generating-processes">6</a>?</p>
<p>For studying this question with simulation, a simple estimation function would take a dataset with two variables as input and compute the sample correlation and its <span class="math inline">\(z\)</span>-transformation, compute confidence intervals for <span class="math inline">\(z\)</span>, and then back-transform the confidence interval end-points.
Here is an implementation of this sequence of calculations:</p>
<div class="sourceCode" id="cb160"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb160-1"><a href="estimation-procedures.html#cb160-1" tabindex="-1"></a>r_and_z <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb160-2"><a href="estimation-procedures.html#cb160-2" tabindex="-1"></a>  </span>
<span id="cb160-3"><a href="estimation-procedures.html#cb160-3" tabindex="-1"></a>  r <span class="ot">&lt;-</span> <span class="fu">cor</span>(data<span class="sc">$</span>C1, data<span class="sc">$</span>C2)</span>
<span id="cb160-4"><a href="estimation-procedures.html#cb160-4" tabindex="-1"></a>  z <span class="ot">&lt;-</span> <span class="fu">atanh</span>(r)</span>
<span id="cb160-5"><a href="estimation-procedures.html#cb160-5" tabindex="-1"></a>  se_z <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="fu">nrow</span>(data) <span class="sc">-</span> <span class="dv">3</span>)</span>
<span id="cb160-6"><a href="estimation-procedures.html#cb160-6" tabindex="-1"></a>  ci_z <span class="ot">&lt;-</span> z <span class="sc">+</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>) <span class="sc">*</span> <span class="fu">qnorm</span>(.<span class="dv">975</span>) <span class="sc">*</span> se_z</span>
<span id="cb160-7"><a href="estimation-procedures.html#cb160-7" tabindex="-1"></a>  ci_r <span class="ot">&lt;-</span> <span class="fu">tanh</span>(ci_z)</span>
<span id="cb160-8"><a href="estimation-procedures.html#cb160-8" tabindex="-1"></a>  </span>
<span id="cb160-9"><a href="estimation-procedures.html#cb160-9" tabindex="-1"></a>  <span class="fu">data.frame</span>( <span class="at">r =</span> r, <span class="at">z =</span> z, <span class="at">CI_lo =</span> ci_r[<span class="dv">1</span>], <span class="at">CI_hi =</span> ci_r[<span class="dv">2</span>] )</span>
<span id="cb160-10"><a href="estimation-procedures.html#cb160-10" tabindex="-1"></a>}</span></code></pre></div>
<p>To check that the function returns a result of the expected form, we generate a small dataset using the <code>r_bivariate_Poisson()</code> function developed in the last chapter, then apply our estimation function to the result:</p>
<div class="sourceCode" id="cb161"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb161-1"><a href="estimation-procedures.html#cb161-1" tabindex="-1"></a>Pois_dat <span class="ot">&lt;-</span> <span class="fu">r_bivariate_Poisson</span>(<span class="dv">40</span>, <span class="at">rho =</span> <span class="fl">0.5</span>, <span class="at">mu1 =</span> <span class="dv">4</span>, <span class="at">mu2 =</span> <span class="dv">4</span>)</span>
<span id="cb161-2"><a href="estimation-procedures.html#cb161-2" tabindex="-1"></a><span class="fu">r_and_z</span>(Pois_dat)</span></code></pre></div>
<pre><code>##           r        z     CI_lo     CI_hi
## 1 0.6371712 0.753397 0.4063077 0.7915666</code></pre>
<p>Although it is a little cumbersome to do so, we could also apply the estimation function to a real dataset.
Here is an example, which calculates the correlation between ratings of judicial integrity and familiarity with the law from the <code>USJudgeRatings</code> dataset (which is included in base R).
For the function to work on this dataset, we first need to rename the relevant variables because our function takes a <code>data.frame</code> with two columns named <code>C1</code> and <code>C2</code>:</p>
<div class="sourceCode" id="cb163"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb163-1"><a href="estimation-procedures.html#cb163-1" tabindex="-1"></a><span class="fu">data</span>(USJudgeRatings)</span>
<span id="cb163-2"><a href="estimation-procedures.html#cb163-2" tabindex="-1"></a></span>
<span id="cb163-3"><a href="estimation-procedures.html#cb163-3" tabindex="-1"></a>USJudgeRatings <span class="sc">%&gt;%</span></span>
<span id="cb163-4"><a href="estimation-procedures.html#cb163-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="at">C1 =</span> INTG, <span class="at">C2 =</span> FAMI) <span class="sc">%&gt;%</span></span>
<span id="cb163-5"><a href="estimation-procedures.html#cb163-5" tabindex="-1"></a>  <span class="fu">r_and_z</span>()</span></code></pre></div>
<pre><code>##          r        z     CI_lo     CI_hi
## 1 0.868858 1.328401 0.7692563 0.9272343</code></pre>
<p>The function returns a valid result—a quite strong correlation in this case!</p>
<p>It is good practice to test out a newly-developed estimation function on real data as a check that it is working as intended.
Testing on real data ensures that the estimation function is not using information outside of the dataset, such as by using known parameter values to construct an estimate.
Applying the function to a real dataset demonstrates that the function implements a procedure that could actually be applied in real data analysis contexts.</p>
</div>
<div id="multiple-estimation-procedures" class="section level2 hasAnchor" number="7.2">
<h2><span class="header-section-number">7.2</span> Including Multiple Data Analysis Procedures<a href="estimation-procedures.html#multiple-estimation-procedures" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Many simulations involve head-to-head comparisons between more than one data-analysis procedure.
As a design principle, we generally recommend writing different functions for each estimation method one is planning on evaluating.
Doing so makes it easier to add in additional methods as desired or to focus on just a subset of methods.
Writing separate functions also leads to a code base that is flexible and useful for other purposes (such as analyzing real data).
Finally (repeating one of our favorite mantras), separating functions makes debugging easier because it lets you focus attention on one thing at a time, without worrying about how errors in one area might propagate to others.</p>
<p>To see how this works in practice, we return to the case study from Section <a href="data-generating-processes.html#case-cluster">6.6</a>, where we developed a data-generating function for simulating a cluster-randomized trial with student-level outcomes but school-level treatment assignment.
Our data-generating process allowed for varying school sizes and heterogeneous treatment effects that are correlated with school size.
Several different procedures might be used to estimate an overall average effect from a clustered experiment. We will consider three different procedures:</p>
<ul>
<li>Fitting a multi-level regression model (also known as a hierarchical linear model),</li>
<li>Fitting an ordinary least squares (OLS) regression model and applying cluster-robust standard errors, or</li>
<li>Averaging the outcomes by school, then fitting a linear regression model on the mean outcomes.</li>
</ul>
<p>All three of these methods are widely used and have some theoretical guarantees supporting their use.
Education researchers tend to be more comfortable using multi-level regression models, whereas economists tend to use OLS with clustered standard errors.
<!-- JEP: Any rationale/precedent for the averaging approach? --></p>
<p>We next develop estimation functions for each of these procedures, focusing on a simple model that does not include any covariates besides the treatment indicator.
Each function needs to produce a point estimate, standard error, and <span class="math inline">\(p\)</span>-value for the average treatment effect.
To have data to practice on, we generate a sample dataset using <a href="/case_study_code/gen_cluster_RCT_rev.R">a revised version of <code>gen_cluster_RCT()</code></a>, which corrects the bug discussed in Exercise <a href="data-generating-processes.html#cluster-RCT-checks">6.9.8</a>:</p>
<div class="sourceCode" id="cb165"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb165-1"><a href="estimation-procedures.html#cb165-1" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">gen_cluster_RCT</span>( </span>
<span id="cb165-2"><a href="estimation-procedures.html#cb165-2" tabindex="-1"></a>  <span class="at">J=</span><span class="dv">16</span>, <span class="at">n_bar =</span> <span class="dv">30</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="at">p =</span> <span class="fl">0.5</span>, </span>
<span id="cb165-3"><a href="estimation-procedures.html#cb165-3" tabindex="-1"></a>  <span class="at">gamma_0 =</span> <span class="dv">0</span>, <span class="at">gamma_1 =</span> <span class="fl">0.2</span>, <span class="at">gamma_2 =</span> <span class="fl">0.2</span>,</span>
<span id="cb165-4"><a href="estimation-procedures.html#cb165-4" tabindex="-1"></a>  <span class="at">sigma2_u =</span> <span class="fl">0.4</span>, <span class="at">sigma2_e =</span> <span class="fl">0.6</span></span>
<span id="cb165-5"><a href="estimation-procedures.html#cb165-5" tabindex="-1"></a>)</span></code></pre></div>
<p>For the multi-level modeling strategy, there are several different existing packages that we could use.
We will implement an estimator using the popular <code>lme4</code> package, via the <code>lmerTest</code> function which calculates a <span class="math inline">\(p\)</span>-value for the average effect.
Here is a basic implementation:</p>
<div class="sourceCode" id="cb166"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb166-1"><a href="estimation-procedures.html#cb166-1" tabindex="-1"></a>analysis_MLM <span class="ot">&lt;-</span> <span class="cf">function</span>( dat ) {</span>
<span id="cb166-2"><a href="estimation-procedures.html#cb166-2" tabindex="-1"></a>  </span>
<span id="cb166-3"><a href="estimation-procedures.html#cb166-3" tabindex="-1"></a>  M1_test <span class="ot">&lt;-</span> lmerTest<span class="sc">::</span><span class="fu">lmer</span>( Yobs <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> Z <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> sid), <span class="at">data =</span> dat )</span>
<span id="cb166-4"><a href="estimation-procedures.html#cb166-4" tabindex="-1"></a>  M1_summary <span class="ot">&lt;-</span> <span class="fu">summary</span>(M1_test)<span class="sc">$</span>coefficients</span>
<span id="cb166-5"><a href="estimation-procedures.html#cb166-5" tabindex="-1"></a>  </span>
<span id="cb166-6"><a href="estimation-procedures.html#cb166-6" tabindex="-1"></a>  <span class="fu">tibble</span>( </span>
<span id="cb166-7"><a href="estimation-procedures.html#cb166-7" tabindex="-1"></a>    <span class="at">ATE_hat =</span> M1_summary[<span class="st">&quot;Z&quot;</span>,<span class="st">&quot;Estimate&quot;</span>], </span>
<span id="cb166-8"><a href="estimation-procedures.html#cb166-8" tabindex="-1"></a>    <span class="at">SE_hat =</span> M1_summary[<span class="st">&quot;Z&quot;</span>,<span class="st">&quot;Std. Error&quot;</span>], </span>
<span id="cb166-9"><a href="estimation-procedures.html#cb166-9" tabindex="-1"></a>    <span class="at">p_value =</span> M1_summary[<span class="st">&quot;Z&quot;</span>, <span class="st">&quot;Pr(&gt;|t|)&quot;</span>] </span>
<span id="cb166-10"><a href="estimation-procedures.html#cb166-10" tabindex="-1"></a>  )</span>
<span id="cb166-11"><a href="estimation-procedures.html#cb166-11" tabindex="-1"></a>  </span>
<span id="cb166-12"><a href="estimation-procedures.html#cb166-12" tabindex="-1"></a>}</span></code></pre></div>
<p>The function fits a multi-level model with a fixed coefficient for the treatment indicator and random intercepts for each school.
It outputs only the statistics in which we are interested.</p>
<p>Our function makes use of the <code>lmerTest</code> package.
Rather than assuming that this package will be loaded, we call the relevant function using the package name as a prefix: <code>lmerTest::lmer()</code>.
This way, we can run the function even if we have not loaded the package in the global environment.
Referencing functions with their package prefix is also preferable to loading packages inside the function itself (e.g., with <code>require(lmerTest)</code>) because calling the function then does not change which packages are loaded in the global environment.</p>
<p>Here is a function implementing OLS regression with cluster-robust standard errors:</p>
<div class="sourceCode" id="cb167"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb167-1"><a href="estimation-procedures.html#cb167-1" tabindex="-1"></a>analysis_OLS <span class="ot">&lt;-</span> <span class="cf">function</span>( dat, <span class="at">se_type =</span> <span class="st">&quot;CR2&quot;</span> ) {</span>
<span id="cb167-2"><a href="estimation-procedures.html#cb167-2" tabindex="-1"></a>  </span>
<span id="cb167-3"><a href="estimation-procedures.html#cb167-3" tabindex="-1"></a>  M2 <span class="ot">&lt;-</span> estimatr<span class="sc">::</span><span class="fu">lm_robust</span>( </span>
<span id="cb167-4"><a href="estimation-procedures.html#cb167-4" tabindex="-1"></a>    Yobs <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> Z, <span class="at">data =</span> dat, </span>
<span id="cb167-5"><a href="estimation-procedures.html#cb167-5" tabindex="-1"></a>    <span class="at">clusters =</span> sid,  <span class="at">se_type =</span> se_type</span>
<span id="cb167-6"><a href="estimation-procedures.html#cb167-6" tabindex="-1"></a>  )</span>
<span id="cb167-7"><a href="estimation-procedures.html#cb167-7" tabindex="-1"></a>  </span>
<span id="cb167-8"><a href="estimation-procedures.html#cb167-8" tabindex="-1"></a>  <span class="fu">tibble</span>( </span>
<span id="cb167-9"><a href="estimation-procedures.html#cb167-9" tabindex="-1"></a>    <span class="at">ATE_hat =</span> M2<span class="sc">$</span>coefficients[[<span class="st">&quot;Z&quot;</span>]], </span>
<span id="cb167-10"><a href="estimation-procedures.html#cb167-10" tabindex="-1"></a>    <span class="at">SE_hat =</span> M2<span class="sc">$</span>std.error[[<span class="st">&quot;Z&quot;</span>]], </span>
<span id="cb167-11"><a href="estimation-procedures.html#cb167-11" tabindex="-1"></a>    <span class="at">p_value =</span> M2<span class="sc">$</span>p.value[[<span class="st">&quot;Z&quot;</span>]] </span>
<span id="cb167-12"><a href="estimation-procedures.html#cb167-12" tabindex="-1"></a>  )</span>
<span id="cb167-13"><a href="estimation-procedures.html#cb167-13" tabindex="-1"></a>}</span></code></pre></div>
<p>To get cluster-robust standard errors, we use the <code>lm_robust()</code> function from the <code>estimatr()</code> package, again calling only the relevant function using the package prefix rather than loading the whole package.
A novel aspect of this estimation function is that it includes an additional intput argument, <code>se_type</code>, which allows us to control the type of standard error calculated by <code>lm_robust()</code>.
Adding this option would let us use the same function to compute (and compare) different types of clustered standard errors for the average treatment effect estimate.
We set a default option of <code>"CR2"</code>, just like the default of <code>lm_robust()</code>.</p>
<p>Sometimes an analytic procedure involves multiple steps.
For example, the aggregation estimator first involves collapsing the data to a school-level dataset, and then analyzing at the school level.
This is no problem:<br />
we just wrap all the steps in a single estimation function.
Once written, all we need to do is call the function—no matter how complicated the process inside.
Here is the code for the aggregate-then-analyze approach:</p>
<div class="sourceCode" id="cb168"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb168-1"><a href="estimation-procedures.html#cb168-1" tabindex="-1"></a>analysis_agg <span class="ot">&lt;-</span> <span class="cf">function</span>( dat, <span class="at">se_type =</span> <span class="st">&quot;HC2&quot;</span> ) {</span>
<span id="cb168-2"><a href="estimation-procedures.html#cb168-2" tabindex="-1"></a>  </span>
<span id="cb168-3"><a href="estimation-procedures.html#cb168-3" tabindex="-1"></a>  datagg <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">summarise</span>( </span>
<span id="cb168-4"><a href="estimation-procedures.html#cb168-4" tabindex="-1"></a>    dat,</span>
<span id="cb168-5"><a href="estimation-procedures.html#cb168-5" tabindex="-1"></a>    <span class="at">Ybar =</span> <span class="fu">mean</span>( Yobs ),</span>
<span id="cb168-6"><a href="estimation-procedures.html#cb168-6" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb168-7"><a href="estimation-procedures.html#cb168-7" tabindex="-1"></a>    <span class="at">.by =</span> <span class="fu">c</span>(sid, Z)</span>
<span id="cb168-8"><a href="estimation-procedures.html#cb168-8" tabindex="-1"></a>  )</span>
<span id="cb168-9"><a href="estimation-procedures.html#cb168-9" tabindex="-1"></a>  </span>
<span id="cb168-10"><a href="estimation-procedures.html#cb168-10" tabindex="-1"></a>  <span class="fu">stopifnot</span>( <span class="fu">nrow</span>( datagg ) <span class="sc">==</span> <span class="fu">length</span>(<span class="fu">unique</span>(dat<span class="sc">$</span>sid) ) )</span>
<span id="cb168-11"><a href="estimation-procedures.html#cb168-11" tabindex="-1"></a>  </span>
<span id="cb168-12"><a href="estimation-procedures.html#cb168-12" tabindex="-1"></a>  M3 <span class="ot">&lt;-</span> estimatr<span class="sc">::</span><span class="fu">lm_robust</span>( </span>
<span id="cb168-13"><a href="estimation-procedures.html#cb168-13" tabindex="-1"></a>    Ybar <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> Z, <span class="at">data =</span> datagg, </span>
<span id="cb168-14"><a href="estimation-procedures.html#cb168-14" tabindex="-1"></a>    <span class="at">se_type =</span> se_type </span>
<span id="cb168-15"><a href="estimation-procedures.html#cb168-15" tabindex="-1"></a>  )</span>
<span id="cb168-16"><a href="estimation-procedures.html#cb168-16" tabindex="-1"></a>  </span>
<span id="cb168-17"><a href="estimation-procedures.html#cb168-17" tabindex="-1"></a>  <span class="fu">tibble</span>( </span>
<span id="cb168-18"><a href="estimation-procedures.html#cb168-18" tabindex="-1"></a>    <span class="at">ATE_hat =</span> M3<span class="sc">$</span>coefficients[[<span class="st">&quot;Z&quot;</span>]], </span>
<span id="cb168-19"><a href="estimation-procedures.html#cb168-19" tabindex="-1"></a>    <span class="at">SE_hat =</span> M3<span class="sc">$</span>std.error[[<span class="st">&quot;Z&quot;</span>]], </span>
<span id="cb168-20"><a href="estimation-procedures.html#cb168-20" tabindex="-1"></a>    <span class="at">p_value =</span> M3<span class="sc">$</span>p.value[[<span class="st">&quot;Z&quot;</span>]] </span>
<span id="cb168-21"><a href="estimation-procedures.html#cb168-21" tabindex="-1"></a>  )</span>
<span id="cb168-22"><a href="estimation-procedures.html#cb168-22" tabindex="-1"></a>}</span></code></pre></div>
<p>Note the <code>stopifnot</code> command: it will throw an error if the condition is not true.
This <code>stopifnot</code> ensures we do not have both treatment and control students within a single school–if we did, we would have more aggregated values than school ids due to the grouping!
Putting <em>assert statements</em> in your code like this is a good way to guarantee you are not introducing weird and hard-to-track errors.
A <code>stopifnot</code> statement halts your code as soon as something goes wrong, rather than letting that initial error flow on to further work, potentially creating odd results that are hard to understand.
Here we are protecting ourselves from strange results if, for example, we messed up our DGP code to have treatment not nested within school, or if we were using data that did not actually come from a cluster randomized experiment.
See Section <a href="debugging-and-testing.html#about-stopifnot">19.4</a> for more.</p>
<p>All of our functions produce output in the same format:</p>
<div class="sourceCode" id="cb169"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb169-1"><a href="estimation-procedures.html#cb169-1" tabindex="-1"></a><span class="fu">analysis_MLM</span>( dat )</span></code></pre></div>
<pre><code>## # A tibble: 1 × 3
##   ATE_hat SE_hat p_value
##     &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;
## 1  -0.176  0.383   0.653</code></pre>
<div class="sourceCode" id="cb171"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb171-1"><a href="estimation-procedures.html#cb171-1" tabindex="-1"></a><span class="fu">analysis_OLS</span>( dat )</span></code></pre></div>
<pre><code>## # A tibble: 1 × 3
##   ATE_hat SE_hat p_value
##     &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;
## 1  -0.124  0.462   0.793</code></pre>
<div class="sourceCode" id="cb173"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb173-1"><a href="estimation-procedures.html#cb173-1" tabindex="-1"></a><span class="fu">analysis_agg</span>( dat )</span></code></pre></div>
<pre><code>## # A tibble: 1 × 3
##   ATE_hat SE_hat p_value
##     &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;
## 1  -0.178  0.378   0.645</code></pre>
<p>Ensuring that the output of all the functions is structured in the same way will make it easy to keep the results organized once we start running multiple iterations of the simulation.
If each estimation method returns a dataset with the same variables, we can simply stack the results on top of each other.
Here is a function that bundles all the estimation procedures together:</p>
<div class="sourceCode" id="cb175"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb175-1"><a href="estimation-procedures.html#cb175-1" tabindex="-1"></a>estimate_Tx_Fx <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb175-2"><a href="estimation-procedures.html#cb175-2" tabindex="-1"></a>    data, </span>
<span id="cb175-3"><a href="estimation-procedures.html#cb175-3" tabindex="-1"></a>    <span class="at">CR_se_type =</span> <span class="st">&quot;CR2&quot;</span>, <span class="at">agg_se_type =</span> <span class="st">&quot;HC2&quot;</span></span>
<span id="cb175-4"><a href="estimation-procedures.html#cb175-4" tabindex="-1"></a>) {</span>
<span id="cb175-5"><a href="estimation-procedures.html#cb175-5" tabindex="-1"></a>  </span>
<span id="cb175-6"><a href="estimation-procedures.html#cb175-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb175-7"><a href="estimation-procedures.html#cb175-7" tabindex="-1"></a>    <span class="at">MLM =</span> <span class="fu">analysis_MLM</span>( data ),</span>
<span id="cb175-8"><a href="estimation-procedures.html#cb175-8" tabindex="-1"></a>    <span class="at">OLS =</span> <span class="fu">analysis_OLS</span>( data, <span class="at">se_type =</span> CR_se_type),</span>
<span id="cb175-9"><a href="estimation-procedures.html#cb175-9" tabindex="-1"></a>    <span class="at">agg =</span> <span class="fu">analysis_agg</span>( data, <span class="at">se_type =</span> agg_se_type),</span>
<span id="cb175-10"><a href="estimation-procedures.html#cb175-10" tabindex="-1"></a>    <span class="at">.id =</span> <span class="st">&quot;estimator&quot;</span></span>
<span id="cb175-11"><a href="estimation-procedures.html#cb175-11" tabindex="-1"></a>  )</span>
<span id="cb175-12"><a href="estimation-procedures.html#cb175-12" tabindex="-1"></a>  </span>
<span id="cb175-13"><a href="estimation-procedures.html#cb175-13" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb176"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb176-1"><a href="estimation-procedures.html#cb176-1" tabindex="-1"></a><span class="fu">estimate_Tx_Fx</span>(dat)</span></code></pre></div>
<pre><code>## # A tibble: 3 × 4
##   estimator ATE_hat SE_hat p_value
##   &lt;chr&gt;       &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;
## 1 MLM        -0.176  0.383   0.653
## 2 OLS        -0.124  0.462   0.793
## 3 agg        -0.178  0.378   0.645</code></pre>
<p>This is a common coding pattern for simulations that involve multiple estimators.
Each procedure is expressed in its own function, then these are assembled together in a single function so that they can all easily be applied to the same dataset.
Stacking the results row-wise will make it easy to compute performance measures for all methods at once.
The benefit of stacking will become even more evident once we are working across multiple replications of the simulation process, as we will in Chapter <a href="running-the-simulation-process.html#running-the-simulation-process">8</a>.</p>
</div>
<div id="validating-estimation-function" class="section level2 hasAnchor" number="7.3">
<h2><span class="header-section-number">7.3</span> Validating an Estimation Function<a href="estimation-procedures.html#validating-estimation-function" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Just as with data-generating functions, it is critical to verify that an estimation function is correctly implemented.
If an estimation function involves a known procedure that has been implemented in R or one of its contributed packages, then a straightforward way to do this is to compare your implementation to another existing implementation.
For estimation functions that involve multi-step procedures or novel methods, other approaches to verification may be needed.</p>
<div id="checking-against-existing-implementations" class="section level3 hasAnchor" number="7.3.1">
<h3><span class="header-section-number">7.3.1</span> Checking against existing implementations<a href="estimation-procedures.html#checking-against-existing-implementations" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In Chapter <a href="case-ANOVA.html#case-ANOVA">5</a>, we wrote a function called <code>ANOVA_Welch_F()</code> for computing <span class="math inline">\(p\)</span>-values from two different procedures for testing equality of means in a heteroskedastic ANOVA:</p>
<div class="sourceCode" id="cb178"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb178-1"><a href="estimation-procedures.html#cb178-1" tabindex="-1"></a>ANOVA_Welch_F <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb178-2"><a href="estimation-procedures.html#cb178-2" tabindex="-1"></a>  anova_F <span class="ot">&lt;-</span> <span class="fu">oneway.test</span>(x <span class="sc">~</span> group, <span class="at">data =</span> data, <span class="at">var.equal =</span> <span class="cn">TRUE</span>)</span>
<span id="cb178-3"><a href="estimation-procedures.html#cb178-3" tabindex="-1"></a>  Welch_F <span class="ot">&lt;-</span> <span class="fu">oneway.test</span>(x <span class="sc">~</span> group, <span class="at">data =</span> data, <span class="at">var.equal =</span> <span class="cn">FALSE</span>)</span>
<span id="cb178-4"><a href="estimation-procedures.html#cb178-4" tabindex="-1"></a>  </span>
<span id="cb178-5"><a href="estimation-procedures.html#cb178-5" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb178-6"><a href="estimation-procedures.html#cb178-6" tabindex="-1"></a>    <span class="at">ANOVA =</span> anova_F<span class="sc">$</span>p.value,</span>
<span id="cb178-7"><a href="estimation-procedures.html#cb178-7" tabindex="-1"></a>    <span class="at">Welch =</span> Welch_F<span class="sc">$</span>p.value</span>
<span id="cb178-8"><a href="estimation-procedures.html#cb178-8" tabindex="-1"></a>  )</span>
<span id="cb178-9"><a href="estimation-procedures.html#cb178-9" tabindex="-1"></a>  </span>
<span id="cb178-10"><a href="estimation-procedures.html#cb178-10" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb178-11"><a href="estimation-procedures.html#cb178-11" tabindex="-1"></a>}</span></code></pre></div>
<p>We can test this function by comparing its output against the built-in <code>oneway.test</code> function, as follows:</p>
<div class="sourceCode" id="cb179"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb179-1"><a href="estimation-procedures.html#cb179-1" tabindex="-1"></a>sim_data <span class="ot">&lt;-</span> <span class="fu">generate_ANOVA_data</span>(</span>
<span id="cb179-2"><a href="estimation-procedures.html#cb179-2" tabindex="-1"></a>  <span class="at">mu =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">6</span>), </span>
<span id="cb179-3"><a href="estimation-procedures.html#cb179-3" tabindex="-1"></a>  <span class="at">sigma_sq =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">1</span>),</span>
<span id="cb179-4"><a href="estimation-procedures.html#cb179-4" tabindex="-1"></a>  <span class="at">sample_size =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">2</span>, <span class="dv">4</span>)</span>
<span id="cb179-5"><a href="estimation-procedures.html#cb179-5" tabindex="-1"></a>)</span>
<span id="cb179-6"><a href="estimation-procedures.html#cb179-6" tabindex="-1"></a></span>
<span id="cb179-7"><a href="estimation-procedures.html#cb179-7" tabindex="-1"></a>aov_results <span class="ot">&lt;-</span> <span class="fu">oneway.test</span>(x <span class="sc">~</span> <span class="fu">factor</span>(group), <span class="at">data =</span> sim_data, <span class="at">var.equal =</span> <span class="cn">FALSE</span>)</span>
<span id="cb179-8"><a href="estimation-procedures.html#cb179-8" tabindex="-1"></a>aov_results</span></code></pre></div>
<pre><code>## 
##  One-way analysis of means (not assuming
##  equal variances)
## 
## data:  x and factor(group)
## F = 15.577, num df = 3.0000, denom df =
## 3.0993, p-value = 0.02275</code></pre>
<div class="sourceCode" id="cb181"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb181-1"><a href="estimation-procedures.html#cb181-1" tabindex="-1"></a>Welch_results <span class="ot">&lt;-</span> <span class="fu">ANOVA_Welch_F</span>(sim_data)</span>
<span id="cb181-2"><a href="estimation-procedures.html#cb181-2" tabindex="-1"></a><span class="fu">all.equal</span>(aov_results<span class="sc">$</span>p.value, Welch_results<span class="sc">$</span>Welch)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p>We use <code>all.equal()</code> because it will check equality up to a tolerance in R, which can avoid some perplexing errors due to rounding.</p>
<p>For the bivariate correlation example introduced in Section <a href="estimation-procedures.html#estimation-functions">7.1</a>, we can check the output of <code>r_and_z()</code> against R’s built-in <code>cor.test()</code> function:</p>
<div class="sourceCode" id="cb183"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb183-1"><a href="estimation-procedures.html#cb183-1" tabindex="-1"></a>Pois_dat <span class="ot">&lt;-</span> <span class="fu">r_bivariate_Poisson</span>(<span class="dv">15</span>, <span class="at">rho =</span> <span class="fl">0.6</span>, <span class="at">mu1 =</span> <span class="dv">14</span>, <span class="at">mu2 =</span> <span class="dv">8</span>)</span>
<span id="cb183-2"><a href="estimation-procedures.html#cb183-2" tabindex="-1"></a></span>
<span id="cb183-3"><a href="estimation-procedures.html#cb183-3" tabindex="-1"></a>my_result <span class="ot">&lt;-</span> <span class="fu">r_and_z</span>(Pois_dat) <span class="sc">|&gt;</span> <span class="fu">subset</span>(<span class="at">select =</span> <span class="sc">-</span>z)</span>
<span id="cb183-4"><a href="estimation-procedures.html#cb183-4" tabindex="-1"></a>my_result</span></code></pre></div>
<pre><code>##           r     CI_lo     CI_hi
## 1 0.7474359 0.3810838 0.9109217</code></pre>
<div class="sourceCode" id="cb185"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb185-1"><a href="estimation-procedures.html#cb185-1" tabindex="-1"></a>R_result <span class="ot">&lt;-</span> <span class="fu">cor.test</span>(<span class="sc">~</span> C1 <span class="sc">+</span> C2, <span class="at">data =</span> Pois_dat)</span>
<span id="cb185-2"><a href="estimation-procedures.html#cb185-2" tabindex="-1"></a>R_result <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">r =</span> R_result<span class="sc">$</span>estimate[[<span class="st">&quot;cor&quot;</span>]], </span>
<span id="cb185-3"><a href="estimation-procedures.html#cb185-3" tabindex="-1"></a>                   <span class="at">CI_lo =</span> R_result<span class="sc">$</span>conf.int[<span class="dv">1</span>], </span>
<span id="cb185-4"><a href="estimation-procedures.html#cb185-4" tabindex="-1"></a>                   <span class="at">CI_hi =</span> R_result<span class="sc">$</span>conf.int[<span class="dv">2</span>])</span>
<span id="cb185-5"><a href="estimation-procedures.html#cb185-5" tabindex="-1"></a>R_result</span></code></pre></div>
<pre><code>## # A tibble: 1 × 3
##       r CI_lo CI_hi
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 0.747 0.381 0.911</code></pre>
<div class="sourceCode" id="cb187"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb187-1"><a href="estimation-procedures.html#cb187-1" tabindex="-1"></a><span class="fu">all.equal</span>( <span class="fu">as.numeric</span>(R_result), <span class="fu">as.numeric</span>(my_result) )</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p>This type of check is all the more useful here because <code>r_and_z()</code> uses our own implementation of the confidence interval calculations, rather than relying on R’s built-in functions as we did with <code>ANOVA_Welch_F()</code>.</p>
<p>One might ask why you should bother implementing your own function if you already have a version implemented in R.
In some cases, it might be possible to implement a faster version of a function because you can cut corners by skipping input data verification, providing fewer estimation options, or cutting out post-estimation processing.
Any of these could help with the overall speed of your simulation.
On the other hand, gains in computational efficiency might not be worth the human time it would take to implement the calculations from scratch.
See Chapter <a href="coding-tidbits.html#optimize-code">A.4</a> for more discussion of this trade-off.</p>
</div>
<div id="checking-novel-procedures" class="section level3 hasAnchor" number="7.3.2">
<h3><span class="header-section-number">7.3.2</span> Checking novel procedures<a href="estimation-procedures.html#checking-novel-procedures" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Simulations are usually an integral part of projects to develop novel statistical methods.
Checking estimation functions in such projects presents a challenge: if an estimator truly is new, how do you check that your code is correct?
Effective methods for doing so will vary from problem to problem, but an over-arching strategy is to use theoretical results about the performance of the estimator to check that your implementation works as expected.
For instance, we might work out the algebraic properties of an estimator for a special case and then check that the result of the estimation function agrees with our algebra.
For some estimation problems, we might be able to identify theoretical properties of an estimator when applied to a very large sample of data and when the model is correctly specified.
If we can find results about large-sample behavior, then we can test an estimation function by applying it to a very large sample and checking whether the resulting estimates are very close to specified parameter values.
We illustrate each of these approaches using our functions for estimating treatment effects from cluster-randomized trials.</p>
<p>We start by testing an algebraic property.
With each of the three methods we have implemented, the treatment effect estimator is a difference between the weighted average of the outcomes from students in each treatment condition;
the only difference between the estimators is in what weights are used.
In the special case where all schools have the same number of students, the weights used by all three methods end up being the same: all three methods allocate equal weight to each school.
Therefore, we know that there should be no difference between the three point estimates.
Furthermore, a bit of algebra will show that the cluster-robust standard error from the OLS approach will end up being identical to the robust standard error from the aggregation approach.
If there are also equal numbers of schools assigned to both conditions, then the standard error from the multilevel model will also be identical to the other standard errors.</p>
<p>Let’s verify that our estimation functions produce results that are consistent with these theoretical properties.
To do so, we will need to generate a dataset with equal cluster sizes, setting <span class="math inline">\(\alpha = 0\)</span>:</p>
<div class="sourceCode" id="cb189"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb189-1"><a href="estimation-procedures.html#cb189-1" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">gen_cluster_RCT</span>( </span>
<span id="cb189-2"><a href="estimation-procedures.html#cb189-2" tabindex="-1"></a>  <span class="at">J=</span><span class="dv">12</span>, <span class="at">n_bar =</span> <span class="dv">30</span>, <span class="at">alpha =</span> <span class="dv">0</span>, <span class="at">p =</span> <span class="fl">0.5</span>, </span>
<span id="cb189-3"><a href="estimation-procedures.html#cb189-3" tabindex="-1"></a>  <span class="at">gamma_0 =</span> <span class="dv">0</span>, <span class="at">gamma_1 =</span> <span class="fl">0.2</span>, <span class="at">gamma_2 =</span> <span class="fl">0.2</span>,</span>
<span id="cb189-4"><a href="estimation-procedures.html#cb189-4" tabindex="-1"></a>  <span class="at">sigma2_u =</span> <span class="fl">0.4</span>, <span class="at">sigma2_e =</span> <span class="fl">0.6</span></span>
<span id="cb189-5"><a href="estimation-procedures.html#cb189-5" tabindex="-1"></a>)</span>
<span id="cb189-6"><a href="estimation-procedures.html#cb189-6" tabindex="-1"></a><span class="fu">table</span>(dat<span class="sc">$</span>sid) <span class="co"># verify equal-sized clusters</span></span></code></pre></div>
<pre><code>## 
##  1  2  3  4  5  6  7  8  9 10 11 12 
## 30 30 30 30 30 30 30 30 30 30 30 30</code></pre>
<div class="sourceCode" id="cb191"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb191-1"><a href="estimation-procedures.html#cb191-1" tabindex="-1"></a><span class="fu">estimate_Tx_Fx</span>(dat)</span></code></pre></div>
<pre><code>## # A tibble: 3 × 4
##   estimator ATE_hat SE_hat p_value
##   &lt;chr&gt;       &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;
## 1 MLM         0.456  0.401   0.282
## 2 OLS         0.456  0.401   0.282
## 3 agg         0.456  0.401   0.282</code></pre>
<p>All three methods yield identical results.
Now let’s try equal school sizes but unequal allocation to treatment:</p>
<div class="sourceCode" id="cb193"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb193-1"><a href="estimation-procedures.html#cb193-1" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">gen_cluster_RCT</span>( </span>
<span id="cb193-2"><a href="estimation-procedures.html#cb193-2" tabindex="-1"></a>  <span class="at">J=</span><span class="dv">12</span>, <span class="at">n_bar =</span> <span class="dv">30</span>, <span class="at">alpha =</span> <span class="dv">0</span>, <span class="at">p =</span> <span class="dv">2</span> <span class="sc">/</span> <span class="dv">3</span>, </span>
<span id="cb193-3"><a href="estimation-procedures.html#cb193-3" tabindex="-1"></a>  <span class="at">gamma_0 =</span> <span class="dv">0</span>, <span class="at">gamma_1 =</span> <span class="fl">0.2</span>, <span class="at">gamma_2 =</span> <span class="fl">0.2</span>,</span>
<span id="cb193-4"><a href="estimation-procedures.html#cb193-4" tabindex="-1"></a>  <span class="at">sigma2_u =</span> <span class="fl">0.4</span>, <span class="at">sigma2_e =</span> <span class="fl">0.6</span></span>
<span id="cb193-5"><a href="estimation-procedures.html#cb193-5" tabindex="-1"></a>)</span>
<span id="cb193-6"><a href="estimation-procedures.html#cb193-6" tabindex="-1"></a><span class="fu">estimate_Tx_Fx</span>(dat)</span></code></pre></div>
<pre><code>## # A tibble: 3 × 4
##   estimator ATE_hat SE_hat p_value
##   &lt;chr&gt;       &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;
## 1 MLM         0.292  0.309   0.367
## 2 OLS         0.292  0.260   0.303
## 3 agg         0.292  0.260   0.287</code></pre>
<p>As expected, all three point estimators match, but the SE from the multilevel model is a little bit discrepant from the others.</p>
<p>We can also use large-sample theory to check the multilevel modeling estimator.
If the model is correctly specified, then <em>all</em> the parameters of the model should be accurately estimated if the model is fit to a very large sample of data.
To check this property, we will need access to the full model output, not just the selected results returned by <code>analysis_MLM()</code>.
One way to handle this is to make a small tweak to the estimation function, adding an option to control whether to return the entire model or just selected results.
Here is the tweaked function:</p>
<div class="sourceCode" id="cb195"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb195-1"><a href="estimation-procedures.html#cb195-1" tabindex="-1"></a>analysis_MLM <span class="ot">&lt;-</span> <span class="cf">function</span>( dat, <span class="at">all_results =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb195-2"><a href="estimation-procedures.html#cb195-2" tabindex="-1"></a>  </span>
<span id="cb195-3"><a href="estimation-procedures.html#cb195-3" tabindex="-1"></a>  M1_test <span class="ot">&lt;-</span> lmerTest<span class="sc">::</span><span class="fu">lmer</span>( Yobs <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> Z <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> sid), <span class="at">data =</span> dat )</span>
<span id="cb195-4"><a href="estimation-procedures.html#cb195-4" tabindex="-1"></a>  </span>
<span id="cb195-5"><a href="estimation-procedures.html#cb195-5" tabindex="-1"></a>  <span class="cf">if</span> (all_results) {</span>
<span id="cb195-6"><a href="estimation-procedures.html#cb195-6" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">summary</span>(M1_test))</span>
<span id="cb195-7"><a href="estimation-procedures.html#cb195-7" tabindex="-1"></a>  } </span>
<span id="cb195-8"><a href="estimation-procedures.html#cb195-8" tabindex="-1"></a>  </span>
<span id="cb195-9"><a href="estimation-procedures.html#cb195-9" tabindex="-1"></a>  M1_summary <span class="ot">&lt;-</span> <span class="fu">summary</span>(M1_test)<span class="sc">$</span>coefficients</span>
<span id="cb195-10"><a href="estimation-procedures.html#cb195-10" tabindex="-1"></a>  </span>
<span id="cb195-11"><a href="estimation-procedures.html#cb195-11" tabindex="-1"></a>  <span class="fu">tibble</span>( </span>
<span id="cb195-12"><a href="estimation-procedures.html#cb195-12" tabindex="-1"></a>    <span class="at">ATE_hat =</span> M1_summary[<span class="st">&quot;Z&quot;</span>,<span class="st">&quot;Estimate&quot;</span>], </span>
<span id="cb195-13"><a href="estimation-procedures.html#cb195-13" tabindex="-1"></a>    <span class="at">SE_hat =</span> M1_summary[<span class="st">&quot;Z&quot;</span>,<span class="st">&quot;Std. Error&quot;</span>], </span>
<span id="cb195-14"><a href="estimation-procedures.html#cb195-14" tabindex="-1"></a>    <span class="at">p_value =</span> M1_summary[<span class="st">&quot;Z&quot;</span>, <span class="st">&quot;Pr(&gt;|t|)&quot;</span>] </span>
<span id="cb195-15"><a href="estimation-procedures.html#cb195-15" tabindex="-1"></a>  )</span>
<span id="cb195-16"><a href="estimation-procedures.html#cb195-16" tabindex="-1"></a>}</span></code></pre></div>
<p>Setting <code>all_results</code> to <code>TRUE</code> will return the entire function; keeping it at the default value of <code>FALSE</code> will return the same output as the other functions.
Now let’s apply the estimation function to a very large dataset, with variation in cluster sizes.
We set <code>gamma_2 = 0</code> so that the estimation model is correctly specified:</p>
<div class="sourceCode" id="cb196"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb196-1"><a href="estimation-procedures.html#cb196-1" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">gen_cluster_RCT</span>( </span>
<span id="cb196-2"><a href="estimation-procedures.html#cb196-2" tabindex="-1"></a>  <span class="at">J=</span><span class="dv">5000</span>, <span class="at">n_bar =</span> <span class="dv">20</span>, <span class="at">alpha =</span> <span class="fl">0.9</span>, <span class="at">p =</span> <span class="dv">2</span> <span class="sc">/</span> <span class="dv">3</span>, </span>
<span id="cb196-3"><a href="estimation-procedures.html#cb196-3" tabindex="-1"></a>  <span class="at">gamma_0 =</span> <span class="dv">2</span>, <span class="at">gamma_1 =</span> <span class="fl">0.30</span>, <span class="at">gamma_2 =</span> <span class="dv">0</span>,</span>
<span id="cb196-4"><a href="estimation-procedures.html#cb196-4" tabindex="-1"></a>  <span class="at">sigma2_u =</span> <span class="fl">0.4</span>, <span class="at">sigma2_e =</span> <span class="fl">0.6</span></span>
<span id="cb196-5"><a href="estimation-procedures.html#cb196-5" tabindex="-1"></a>)</span>
<span id="cb196-6"><a href="estimation-procedures.html#cb196-6" tabindex="-1"></a></span>
<span id="cb196-7"><a href="estimation-procedures.html#cb196-7" tabindex="-1"></a><span class="fu">analysis_MLM</span>(dat, <span class="at">all_results =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<pre><code>## Linear mixed model fit by REML. t-tests use
##   Satterthwaite&#39;s method [lmerModLmerTest]
## Formula: Yobs ~ 1 + Z + (1 | sid)
##    Data: dat
## 
## REML criterion at convergence: 241831
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -4.5540 -0.6605  0.0009  0.6593  4.3081 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev.
##  sid      (Intercept) 0.3924   0.6264  
##  Residual             0.5984   0.7736  
## Number of obs: 98739, groups:  sid, 5000
## 
## Fixed effects:
##              Estimate Std. Error        df
## (Intercept) 2.005e+00  1.627e-02 4.960e+03
## Z           3.028e-01  1.992e-02 4.949e+03
##             t value Pr(&gt;|t|)    
## (Intercept)   123.2   &lt;2e-16 ***
## Z              15.2   &lt;2e-16 ***
## ---
## Signif. codes:  
## 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Correlation of Fixed Effects:
##   (Intr)
## Z -0.817</code></pre>
<p>The intercept and treatment effect coefficient estimates are very close to their true parameter values, as are the estimated school-level variance and student-level residual variance.
This all gives some assurance that the <code>analysis_MLM()</code> function is working properly.</p>
<p>Of course, it is important to bear in mind that these tests are only partial verifications.
With the algebraic test, we have only checked that the functions seem to be working properly for scenarios with equal school sizes, but they still might have errors that only appear when school sizes vary.
Likewise, <code>analysis_MLM()</code> seems to be working properly for very large datasets, but our test does not rule out the possibility of bugs that only crawl out when <span class="math inline">\(J\)</span> is small.
Our large-sample test also relies on the correctness of the <code>gen_cluster_RCT()</code> function;
if we had seen a discrepancy between parameters and estimates from the multilevel model, it could have been because of a problem with the data-generation function rather than with the estimation function.</p>
<p>These limitations are typical of what can be accomplished through tests based on theoretical results, because theoretical results typically only hold under specific conditions.
After all, if we had comprehensive theoretical results, we would not need to simulate anything in the first place!
Nonetheless, it is good to work through such tests to the extent that relevant theory is available for the problem you are studying.</p>
</div>
<div id="checking-with-simulations" class="section level3 hasAnchor" number="7.3.3">
<h3><span class="header-section-number">7.3.3</span> Checking with simulations<a href="estimation-procedures.html#checking-with-simulations" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Checking, debugging, and revising should not be limited to when you are initially developing estimation functions.
It often happens that later steps in the process of conducting a simulation will reveal problems with the code for earlier steps.
For instance, once you have run the data-generating and estimation steps repeatedly, calculated performance summaries, and created some graphs of the results, you might find an unusual or anomolous pattern in the performance of an estimator.
This might be a legitimate result—perhaps the estimator really does behave weirdly or not work well—or it might be due to a problem in how you implemented the estimator or data-generating process.
When faced with an unusual pattern, revisit the estimation code to double check for bugs and also think further about what might lead to the anomaly.
Further exploration might lead you to a deeper understanding of how a method works and perhaps even an idea for how to improve the estimator or refine the data-generating process.</p>
<p>A good illustration of this process comes from one of Luke’s past research projects (see <span class="citation">@pashley2024improving</span>), in which he and other co-authors were working on a way to improve Instrumental Variable (IV) estimation using post-stratification.
The method they studied involved grouping units based on a covariate that predicts compliance status, then calculating estimates within each group, then averaging the estimates across groups.
They used simulations to see whether this method would improve the accuracy of the overall summary effect estimate.
In the first simulation, the estimates were full of missing values and odd results because the estimation function failed to account for what happens in groups of observations where the number of compliers was estimated to be zero.
After repairing that problem and re-running everything, the simulation results still indicated serious and unexpected bias, which turned out to be due to an error in how the estimation function implemented the step of averaging estimates across groups.
After again correcting and re-running, the simulation results showed that the gains in accuracy from this new method were minimal, even when the groups were formed based on a variable that was almost perfectly predictive of compliance status.
Eventually, we understood that the groups with very few compliers produced such unstable estimates that they spoiled the overall average estimate.
This inspired us to revise our estimation strategy and introduce a method that dropped or down-weighted strata with few compliers, which ultimately helped us to strengthen the contribution of our work.</p>
<p>As this experience highlights, simulations seldom follow a single, well-defined trajectory.
The point of conducting simulations is to help us, as researchers, learn about estimation methods so that we can analyze real data better.
Simulations can strengthen our methodological and theoretical understanding, which can then inspire ideas for better approaches which we can then test in subsequent simulations.
Of course, at some point one needs to step off this merry-go-round, write up the findings, cook dinner, and clean the bathroom.
But, just like many other research endeavors, simulations are often a highly iterative process.</p>
</div>
</div>
<div id="error-handling" class="section level2 hasAnchor" number="7.4">
<h2><span class="header-section-number">7.4</span> Handling errors, warnings, and other hiccups<a href="estimation-procedures.html#error-handling" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Especially when working with more advanced estimation methods, it is possible that your estimation function will fail, throw an error, or return something uninterpretable for certain input datasets.
For instance, maximum likelihood estimation often involves using iterative, numerical optimization algorithms that sometimes fail to converge.
This might happen rarely enough that it takes a while to even notice that it is a problem, but even quite rare things can occur when you run simulations with many thousands of repetitions.
Less dire but still annoying, your estimation function might occasionally generate warnings, which can pile up if you are running many repetitions.
In some cases, such warnings might also signal that the estimator produced a bad result, and
it may not be clear whether we should retain this result in the estimator’s overall performance assessments.
After all, the function tried to warn us that something is off!</p>
<p>Errors and warnings in estimation functions pose two problems, one purely technical and one conceptual.
On a technical level, R functions stop running if they hit an error, so we need ways to handle the errors in order to get our simulations up and running.
Furthermore, warnings can clutter up the console and slow down code execution, so we may want to capture and suppress them as well.
On a conceptual level, we need to decide how to use the information contained in errors and warnings, whether that be by further elaborating the estimators to address different contingencies or by evaluating the performance of the estimators in a way that appropriately accounts for these events.
We consider both these problems here, and then revisit the conceptual considerations in Chapter <a href="performance-measures.html#performance-measures">9</a>, where we discuss assessing estimator performance.</p>
<div id="capturing-errors-and-warnings" class="section level3 hasAnchor" number="7.4.1">
<h3><span class="header-section-number">7.4.1</span> Capturing errors and warnings<a href="estimation-procedures.html#capturing-errors-and-warnings" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Some estimation functions will require complicated or stochastic calculations that can sometimes produce errors.
Intermittent errors can really be annoying and time-consuming if not addressed.
To protect yourself, it is good practice to anticipate potential errors, preventing them from stopping code execution and allowing your simulations to keep running.
We next demonstrate some techniques for error-handling using tools from the <code>purrr</code> package.</p>
<p>For illustrative purposes, consider the following error-prone function that sometimes returns what we want, sometimes returns <code>NaN</code> due to taking the square root of a negative number, and sometimes crashes completely because <code>broken_code()</code> does not exist:</p>
<div class="sourceCode" id="cb198"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb198-1"><a href="estimation-procedures.html#cb198-1" tabindex="-1"></a>my_complex_function <span class="ot">=</span> <span class="cf">function</span>( param ) {</span>
<span id="cb198-2"><a href="estimation-procedures.html#cb198-2" tabindex="-1"></a>    </span>
<span id="cb198-3"><a href="estimation-procedures.html#cb198-3" tabindex="-1"></a>    vals <span class="ot">=</span> <span class="fu">rnorm</span>( param, <span class="at">mean =</span> <span class="fl">0.5</span> )</span>
<span id="cb198-4"><a href="estimation-procedures.html#cb198-4" tabindex="-1"></a>    <span class="cf">if</span> ( <span class="fu">sum</span>( vals ) <span class="sc">&gt;</span> <span class="dv">5</span> ) {</span>
<span id="cb198-5"><a href="estimation-procedures.html#cb198-5" tabindex="-1"></a>        <span class="fu">broken_code</span>( <span class="dv">4</span> )</span>
<span id="cb198-6"><a href="estimation-procedures.html#cb198-6" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb198-7"><a href="estimation-procedures.html#cb198-7" tabindex="-1"></a>        <span class="fu">sqrt</span>( <span class="fu">sum</span>( vals ) <span class="sc">*</span> <span class="fu">sign</span>( vals )[[<span class="dv">1</span>]] )</span>
<span id="cb198-8"><a href="estimation-procedures.html#cb198-8" tabindex="-1"></a>    }</span>
<span id="cb198-9"><a href="estimation-procedures.html#cb198-9" tabindex="-1"></a>}</span></code></pre></div>
<p>Running it a few times produces a mix of results and warnings:</p>
<div class="sourceCode" id="cb199"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb199-1"><a href="estimation-procedures.html#cb199-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">156858</span>)</span>
<span id="cb199-2"><a href="estimation-procedures.html#cb199-2" tabindex="-1"></a><span class="fu">my_complex_function</span>( <span class="dv">7</span> )</span></code></pre></div>
<pre><code>## Warning in sqrt(sum(vals) * sign(vals)[[1]]):
## NaNs produced</code></pre>
<pre><code>## [1] NaN</code></pre>
<div class="sourceCode" id="cb202"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb202-1"><a href="estimation-procedures.html#cb202-1" tabindex="-1"></a><span class="fu">my_complex_function</span>( <span class="dv">7</span> )</span></code></pre></div>
<pre><code>## [1] 2.11999</code></pre>
<div class="sourceCode" id="cb204"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb204-1"><a href="estimation-procedures.html#cb204-1" tabindex="-1"></a><span class="fu">my_complex_function</span>( <span class="dv">4</span> )</span></code></pre></div>
<pre><code>## [1] 0.09896136</code></pre>
<p>Running it many times produces warnings, then an error:</p>
<div class="sourceCode" id="cb206"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb206-1"><a href="estimation-procedures.html#cb206-1" tabindex="-1"></a><span class="fu">set.seed</span>( <span class="dv">131</span> )</span>
<span id="cb206-2"><a href="estimation-procedures.html#cb206-2" tabindex="-1"></a>resu <span class="ot">&lt;-</span> <span class="fu">replicate</span>(<span class="dv">20</span>, <span class="fu">my_complex_function</span>( <span class="dv">6</span> ))</span></code></pre></div>
<pre><code>## Warning in sqrt(sum(vals) * sign(vals)[[1]]):
## NaNs produced
## Warning in sqrt(sum(vals) * sign(vals)[[1]]):
## NaNs produced
## Warning in sqrt(sum(vals) * sign(vals)[[1]]):
## NaNs produced</code></pre>
<pre><code>## Error in broken_code(4): could not find function &quot;broken_code&quot;</code></pre>
<p>We need to “trap” these warnings and errors so they do not clutter or stop our simulation.
Let’s do the errors first.</p>
<p>The <code>purrr</code> package includes a function called <code>possibly()</code> that makes it easy to trap errors:</p>
<div class="sourceCode" id="cb209"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb209-1"><a href="estimation-procedures.html#cb209-1" tabindex="-1"></a>my_possible_function <span class="ot">&lt;-</span> <span class="fu">possibly</span>( my_complex_function, <span class="at">otherwise =</span> <span class="cn">NA</span> )</span>
<span id="cb209-2"><a href="estimation-procedures.html#cb209-2" tabindex="-1"></a><span class="fu">my_possible_function</span>( <span class="dv">7</span> )</span></code></pre></div>
<pre><code>## Warning in sqrt(sum(vals) * sign(vals)[[1]]):
## NaNs produced</code></pre>
<pre><code>## [1] NaN</code></pre>
<div class="sourceCode" id="cb212"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb212-1"><a href="estimation-procedures.html#cb212-1" tabindex="-1"></a>rs <span class="ot">&lt;-</span> <span class="fu">replicate</span>(<span class="dv">20</span>, <span class="fu">my_possible_function</span>( <span class="dv">7</span> ))</span></code></pre></div>
<pre><code>## Warning in sqrt(sum(vals) * sign(vals)[[1]]):
## NaNs produced
## Warning in sqrt(sum(vals) * sign(vals)[[1]]):
## NaNs produced
## Warning in sqrt(sum(vals) * sign(vals)[[1]]):
## NaNs produced
## Warning in sqrt(sum(vals) * sign(vals)[[1]]):
## NaNs produced
## Warning in sqrt(sum(vals) * sign(vals)[[1]]):
## NaNs produced
## Warning in sqrt(sum(vals) * sign(vals)[[1]]):
## NaNs produced
## Warning in sqrt(sum(vals) * sign(vals)[[1]]):
## NaNs produced
## Warning in sqrt(sum(vals) * sign(vals)[[1]]):
## NaNs produced
## Warning in sqrt(sum(vals) * sign(vals)[[1]]):
## NaNs produced
## Warning in sqrt(sum(vals) * sign(vals)[[1]]):
## NaNs produced</code></pre>
<div class="sourceCode" id="cb214"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb214-1"><a href="estimation-procedures.html#cb214-1" tabindex="-1"></a>rs</span></code></pre></div>
<pre><code>##  [1] 0.8653335       NaN 2.0056463       NaN
##  [5]        NA       NaN       NaN 1.0718040
##  [9] 1.5937092 2.0111968       NaN        NA
## [13] 1.7401242       NaN 0.9721895       NaN
## [17] 2.0947465       NaN       NaN       NaN</code></pre>
<p><code>possibly()</code> is an example of a <em>functional</em> (or an <em>abverb</em> or “wrapper function”), which takes a function and returns a new function that does something slightly different.
The new function has the exact same parameters as the function we put into it.
The difference is the new version of the function will, if an error happens, return the value specified by the <code>otherwise</code> argument (here, <code>NA</code>), rather than stopping execution with an error.
It does not silence the warnings, however.</p>
<p>To handle warnings, the <code>quietly()</code> functional leads to results that are bundled together with any console output, warnings, and messages, rather than printing anything to the console:</p>
<div class="sourceCode" id="cb216"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb216-1"><a href="estimation-procedures.html#cb216-1" tabindex="-1"></a>my_quiet_function <span class="ot">&lt;-</span> <span class="fu">quietly</span>( my_complex_function )</span>
<span id="cb216-2"><a href="estimation-procedures.html#cb216-2" tabindex="-1"></a></span>
<span id="cb216-3"><a href="estimation-procedures.html#cb216-3" tabindex="-1"></a><span class="fu">my_quiet_function</span>( <span class="dv">1</span> )</span></code></pre></div>
<pre><code>## $result
## [1] 0.6065094
## 
## $output
## [1] &quot;&quot;
## 
## $warnings
## character(0)
## 
## $messages
## character(0)</code></pre>
<p>Wrapping a function with <code>quietly()</code> can be especially useful to reduce extraneous printing in a simulation, which can slow down code execution more than you might expect.
However, <code>quietly()</code> does not trap errors:</p>
<div class="sourceCode" id="cb218"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb218-1"><a href="estimation-procedures.html#cb218-1" tabindex="-1"></a>rs <span class="ot">&lt;-</span> <span class="fu">replicate</span>(<span class="dv">20</span>, <span class="fu">my_quiet_function</span>( <span class="dv">7</span> ))</span></code></pre></div>
<pre><code>## Error in broken_code(4): could not find function &quot;broken_code&quot;</code></pre>
<p>To handle both errors and warnings, we double-wrap the function, first with <code>possibly()</code> and then with <code>quietly()</code>:</p>
<div class="sourceCode" id="cb220"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb220-1"><a href="estimation-procedures.html#cb220-1" tabindex="-1"></a>my_safe_quiet_function <span class="ot">&lt;-</span> <span class="fu">quietly</span>( <span class="fu">possibly</span>( my_complex_function, <span class="at">otherwise =</span> <span class="cn">NA</span> ) )</span>
<span id="cb220-2"><a href="estimation-procedures.html#cb220-2" tabindex="-1"></a><span class="fu">my_safe_quiet_function</span>(<span class="dv">7</span>)</span></code></pre></div>
<pre><code>## $result
## [1] 1.538658
## 
## $output
## [1] &quot;&quot;
## 
## $warnings
## character(0)
## 
## $messages
## character(0)</code></pre>
<p>To see how this works in practice, we will adapt our <code>analysis_MLM()</code> function, which makes use of <code>lmer()</code> for fitting a multilevel model.
Currently, the estimation function sometimes prints messages to the console:</p>
<div class="sourceCode" id="cb222"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb222-1"><a href="estimation-procedures.html#cb222-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">101012</span>)  <span class="co"># (hand-picked to show a warning.)</span></span>
<span id="cb222-2"><a href="estimation-procedures.html#cb222-2" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">gen_cluster_RCT</span>( <span class="at">J =</span> <span class="dv">50</span>, <span class="at">n_bar =</span> <span class="dv">100</span>, <span class="at">sigma2_u =</span> <span class="dv">0</span> )</span>
<span id="cb222-3"><a href="estimation-procedures.html#cb222-3" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">analysis_MLM</span>(dat)</span></code></pre></div>
<pre><code>## boundary (singular) fit: see help(&#39;isSingular&#39;)</code></pre>
<p>Wrapping <code>lmer()</code> with <code>quietly()</code> makes it possible to catch such output and store it along with other results, as in the following:</p>
<div class="sourceCode" id="cb224"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb224-1"><a href="estimation-procedures.html#cb224-1" tabindex="-1"></a>quiet_safe_lmer <span class="ot">&lt;-</span> <span class="fu">quietly</span>( <span class="fu">possibly</span>( lmerTest<span class="sc">::</span>lmer, <span class="at">otherwise=</span><span class="cn">NULL</span> ) )</span>
<span id="cb224-2"><a href="estimation-procedures.html#cb224-2" tabindex="-1"></a>M1 <span class="ot">&lt;-</span> <span class="fu">quiet_safe_lmer</span>( Yobs <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> Z <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>sid), <span class="at">data=</span>dat )</span>
<span id="cb224-3"><a href="estimation-procedures.html#cb224-3" tabindex="-1"></a>M1</span></code></pre></div>
<pre><code>## $result
## Linear mixed model fit by REML [&#39;lmerModLmerTest&#39;]
## Formula: ..1
##    Data: ..2
## REML criterion at convergence: 14026.44
## Random effects:
##  Groups   Name        Std.Dev.
##  sid      (Intercept) 0.0000  
##  Residual             0.9828  
## Number of obs: 5000, groups:  sid, 50
## Fixed Effects:
## (Intercept)            Z  
##   -0.013930    -0.008804  
## optimizer (nloptwrap) convergence code: 0 (OK) ; 0 optimizer warnings; 1 lme4 warnings 
## 
## $output
## [1] &quot;&quot;
## 
## $warnings
## character(0)
## 
## $messages
## [1] &quot;boundary (singular) fit: see help(&#39;isSingular&#39;)\n&quot;</code></pre>
<p>We then pick apart the pieces and construct a dataset of results:</p>
<div class="sourceCode" id="cb226"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb226-1"><a href="estimation-procedures.html#cb226-1" tabindex="-1"></a><span class="cf">if</span> ( <span class="fu">is.null</span>( M1<span class="sc">$</span>result ) ) {</span>
<span id="cb226-2"><a href="estimation-procedures.html#cb226-2" tabindex="-1"></a>  <span class="co"># we had an error!</span></span>
<span id="cb226-3"><a href="estimation-procedures.html#cb226-3" tabindex="-1"></a>  <span class="fu">tibble</span>( <span class="at">ATE_hat =</span> <span class="cn">NA</span>, <span class="at">SE_hat =</span> <span class="cn">NA</span>, <span class="at">p_value =</span> <span class="cn">NA</span>,</span>
<span id="cb226-4"><a href="estimation-procedures.html#cb226-4" tabindex="-1"></a>          <span class="at">message =</span> M1<span class="sc">$</span>message,</span>
<span id="cb226-5"><a href="estimation-procedures.html#cb226-5" tabindex="-1"></a>          <span class="at">warning =</span> M1<span class="sc">$</span>warning,</span>
<span id="cb226-6"><a href="estimation-procedures.html#cb226-6" tabindex="-1"></a>          <span class="at">error =</span> <span class="cn">TRUE</span> )</span>
<span id="cb226-7"><a href="estimation-procedures.html#cb226-7" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb226-8"><a href="estimation-procedures.html#cb226-8" tabindex="-1"></a>  sum <span class="ot">&lt;-</span> <span class="fu">summary</span>( M1<span class="sc">$</span>result )</span>
<span id="cb226-9"><a href="estimation-procedures.html#cb226-9" tabindex="-1"></a>  <span class="fu">tibble</span>( </span>
<span id="cb226-10"><a href="estimation-procedures.html#cb226-10" tabindex="-1"></a>    <span class="at">ATE_hat =</span> sum<span class="sc">$</span>coefficients[<span class="st">&quot;Z&quot;</span>,<span class="st">&quot;Estimate&quot;</span>], </span>
<span id="cb226-11"><a href="estimation-procedures.html#cb226-11" tabindex="-1"></a>    <span class="at">SE_hat =</span> sum<span class="sc">$</span>coefficients[<span class="st">&quot;Z&quot;</span>,<span class="st">&quot;Std. Error&quot;</span>], </span>
<span id="cb226-12"><a href="estimation-procedures.html#cb226-12" tabindex="-1"></a>    <span class="at">p_value =</span> sum<span class="sc">$</span>coefficients[<span class="st">&quot;Z&quot;</span>, <span class="st">&quot;Pr(&gt;|t|)&quot;</span>],</span>
<span id="cb226-13"><a href="estimation-procedures.html#cb226-13" tabindex="-1"></a>    <span class="at">message =</span> <span class="fu">list</span>( M1<span class="sc">$</span>message ),</span>
<span id="cb226-14"><a href="estimation-procedures.html#cb226-14" tabindex="-1"></a>    <span class="at">warning =</span> <span class="fu">list</span>( M1<span class="sc">$</span>warning ),</span>
<span id="cb226-15"><a href="estimation-procedures.html#cb226-15" tabindex="-1"></a>    <span class="at">error =</span> <span class="cn">FALSE</span> )</span>
<span id="cb226-16"><a href="estimation-procedures.html#cb226-16" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## # A tibble: 1 × 6
##    ATE_hat SE_hat p_value message   warning error
##      &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt; &lt;list&gt;    &lt;list&gt;  &lt;lgl&gt;
## 1 -0.00880 0.0278   0.751 &lt;chr [1]&gt; &lt;chr&gt;   FALSE</code></pre>
<p>Now we can plug in the above code to make a nicely quieted and safe function.
This version runs without extraneous messages:</p>
<div class="sourceCode" id="cb228"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb228-1"><a href="estimation-procedures.html#cb228-1" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">analysis_MLM_safe</span>(dat)</span>
<span id="cb228-2"><a href="estimation-procedures.html#cb228-2" tabindex="-1"></a>mod</span></code></pre></div>
<pre><code>## # A tibble: 1 × 6
##    ATE_hat SE_hat p_value message   warning error
##      &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt; &lt;list&gt;    &lt;list&gt;  &lt;lgl&gt;
## 1 -0.00880 0.0278   0.751 &lt;chr [1]&gt; &lt;chr&gt;   FALSE</code></pre>
<p>Now we have the estimation results along with any diagnostic information from messages or warnings.
Storing this information will let us evaluate what proportion of the time there was a warning or message, run additional analyses on the subset of replications where there was no such warning, or even modify the estimator to take the diagnostics into account.
We have solved the technical problem—our code will run and give results—but not the conceptual one: what does it mean when our estimator gives an NA or a convergence warning with a nominal answer?
How do we decide how good our estimator is when it does this?</p>
</div>
<div id="adapting-for-errors" class="section level3 hasAnchor" number="7.4.2">
<h3><span class="header-section-number">7.4.2</span> Adapting estimators for errors and warnings<a href="estimation-procedures.html#adapting-for-errors" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>So far, we have seen techniques for handling technical hiccups that occur when data analysis procedures do not always produce results.
But how do we account for the absence of results in a simulation?
In Chapter <a href="performance-measures.html#performance-measures">9</a>, we will delve into the conceptual issues with summarizing the performance of methods that do not always provide an answer.
However, one of the best solutions to such problems still concerns the formulation of estimation functions, and so we introduce it here.
That solution is to <em>re-define the estimator</em> to include contingencies for handling a lack of results.</p>
<p>Consider a data analyst who was planning to apply a fancy statistical model to their data, but then finds that the model does not converge.
What would that analyst do in practice (besides cussing and taking a snack break)?
Rather than giving up entirely, they would probably think of an alternative analysis and attempt to apply it, perhaps by simplifying the model in some way.
To the extent that we can anticipate such possibilities, we can build these error-contingent alternative analyses into our estimation function.
Because of this, it would be more precise to talk about an <em>estimation procedure</em> or a <em>data-analysis procedure</em> rather than just an <em>estimator</em>.
An analysis may be many different steps in a branching structure of analysis.</p>
<p>To illustrate, let’s look at an error (a not-particularly-subtle one) that could crop up in the cluster-randomized trial example when clusters are very small:</p>
<div class="sourceCode" id="cb230"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb230-1"><a href="estimation-procedures.html#cb230-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">65842</span>)</span>
<span id="cb230-2"><a href="estimation-procedures.html#cb230-2" tabindex="-1"></a>tiny_dat <span class="ot">&lt;-</span> <span class="fu">gen_cluster_RCT</span>( <span class="at">J =</span> <span class="dv">10</span>, <span class="at">n_bar =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>)</span>
<span id="cb230-3"><a href="estimation-procedures.html#cb230-3" tabindex="-1"></a><span class="fu">analysis_MLM_safe</span>(tiny_dat)</span></code></pre></div>
<pre><code>## # A tibble: 0 × 6
## # ℹ 6 variables: ATE_hat &lt;lgl&gt;, SE_hat &lt;lgl&gt;,
## #   p_value &lt;lgl&gt;, message &lt;chr&gt;, warning &lt;chr&gt;,
## #   error &lt;lgl&gt;</code></pre>
<div class="sourceCode" id="cb232"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb232-1"><a href="estimation-procedures.html#cb232-1" tabindex="-1"></a><span class="fu">table</span>(tiny_dat<span class="sc">$</span>sid)</span></code></pre></div>
<pre><code>## 
##  1  2  3  4  5  6  7  8  9 10 
##  1  1  1  1  1  1  1  1  1  1</code></pre>
<p>The error occurs because all 10 simulated schools happened to include a single student, making it impossible to estimate a random-intercepts multilevel model.
A natural fall-back analysis here would be to estimate an ordinary least squares regression analysis.</p>
<p>Suppose that our imaginary analyst is not especially into nuance, and so will fall back onto ordinary least squares whenever the multilevel model produces an error.
We can express this logic in our estimation function by first catching the error thrown by <code>lmer()</code> and then running an OLS regression in the event an error is thrown:</p>
<div class="sourceCode" id="cb234"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb234-1"><a href="estimation-procedures.html#cb234-1" tabindex="-1"></a>analysis_MLM_contingent <span class="ot">&lt;-</span> <span class="cf">function</span>( dat ) {</span>
<span id="cb234-2"><a href="estimation-procedures.html#cb234-2" tabindex="-1"></a>  </span>
<span id="cb234-3"><a href="estimation-procedures.html#cb234-3" tabindex="-1"></a>  M1 <span class="ot">&lt;-</span> <span class="fu">quiet_safe_lmer</span>( Yobs <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> Z <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> sid), <span class="at">data=</span>dat )</span>
<span id="cb234-4"><a href="estimation-procedures.html#cb234-4" tabindex="-1"></a>  </span>
<span id="cb234-5"><a href="estimation-procedures.html#cb234-5" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(M1<span class="sc">$</span>result)) { </span>
<span id="cb234-6"><a href="estimation-procedures.html#cb234-6" tabindex="-1"></a>    sum <span class="ot">&lt;-</span> <span class="fu">summary</span>( M1<span class="sc">$</span>result )</span>
<span id="cb234-7"><a href="estimation-procedures.html#cb234-7" tabindex="-1"></a>    <span class="fu">tibble</span>( </span>
<span id="cb234-8"><a href="estimation-procedures.html#cb234-8" tabindex="-1"></a>      <span class="at">ATE_hat =</span> sum<span class="sc">$</span>coefficients[<span class="st">&quot;Z&quot;</span>,<span class="st">&quot;Estimate&quot;</span>], </span>
<span id="cb234-9"><a href="estimation-procedures.html#cb234-9" tabindex="-1"></a>      <span class="at">SE_hat =</span> sum<span class="sc">$</span>coefficients[<span class="st">&quot;Z&quot;</span>,<span class="st">&quot;Std. Error&quot;</span>], </span>
<span id="cb234-10"><a href="estimation-procedures.html#cb234-10" tabindex="-1"></a>      <span class="at">p_value =</span> sum<span class="sc">$</span>coefficients[<span class="st">&quot;Z&quot;</span>, <span class="st">&quot;Pr(&gt;|t|)&quot;</span>] )</span>
<span id="cb234-11"><a href="estimation-procedures.html#cb234-11" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb234-12"><a href="estimation-procedures.html#cb234-12" tabindex="-1"></a>    <span class="co"># If lmer() errors, fall back on OLS</span></span>
<span id="cb234-13"><a href="estimation-procedures.html#cb234-13" tabindex="-1"></a>    M_ols <span class="ot">&lt;-</span> <span class="fu">summary</span>(<span class="fu">lm</span>(Yobs <span class="sc">~</span> Z, <span class="at">data =</span> dat))</span>
<span id="cb234-14"><a href="estimation-procedures.html#cb234-14" tabindex="-1"></a>    res <span class="ot">&lt;-</span> <span class="fu">tibble</span>( </span>
<span id="cb234-15"><a href="estimation-procedures.html#cb234-15" tabindex="-1"></a>      <span class="at">ATE_hat =</span> M_ols<span class="sc">$</span>coefficients[<span class="st">&quot;Z&quot;</span>,<span class="st">&quot;Estimate&quot;</span>], </span>
<span id="cb234-16"><a href="estimation-procedures.html#cb234-16" tabindex="-1"></a>      <span class="at">SE_hat =</span> M_ols<span class="sc">$</span>coefficients[<span class="st">&quot;Z&quot;</span>, <span class="st">&quot;Std. Error&quot;</span>], </span>
<span id="cb234-17"><a href="estimation-procedures.html#cb234-17" tabindex="-1"></a>      <span class="at">p_value =</span> M_ols<span class="sc">$</span>coefficients[<span class="st">&quot;Z&quot;</span>,<span class="st">&quot;Pr(&gt;|t|)&quot;</span>] )</span>
<span id="cb234-18"><a href="estimation-procedures.html#cb234-18" tabindex="-1"></a>  }</span>
<span id="cb234-19"><a href="estimation-procedures.html#cb234-19" tabindex="-1"></a></span>
<span id="cb234-20"><a href="estimation-procedures.html#cb234-20" tabindex="-1"></a>  <span class="co"># Store original messages, warnings, errors  </span></span>
<span id="cb234-21"><a href="estimation-procedures.html#cb234-21" tabindex="-1"></a>  res<span class="sc">$</span>message <span class="ot">&lt;-</span> <span class="fu">ifelse</span>( <span class="fu">length</span>( M1<span class="sc">$</span>message ) <span class="sc">&gt;</span> <span class="dv">0</span>, M1<span class="sc">$</span>message, <span class="cn">NA_character_</span> )</span>
<span id="cb234-22"><a href="estimation-procedures.html#cb234-22" tabindex="-1"></a>  res<span class="sc">$</span>warning <span class="ot">&lt;-</span> <span class="fu">ifelse</span>( <span class="fu">length</span>( M1<span class="sc">$</span>warning ) <span class="sc">&gt;</span> <span class="dv">0</span>, M1<span class="sc">$</span>warning, <span class="cn">NA_character_</span> )</span>
<span id="cb234-23"><a href="estimation-procedures.html#cb234-23" tabindex="-1"></a>  res<span class="sc">$</span>error <span class="ot">&lt;-</span> <span class="fu">is.null</span>( M1<span class="sc">$</span>result )</span>
<span id="cb234-24"><a href="estimation-procedures.html#cb234-24" tabindex="-1"></a></span>
<span id="cb234-25"><a href="estimation-procedures.html#cb234-25" tabindex="-1"></a>  <span class="fu">return</span>(res)</span>
<span id="cb234-26"><a href="estimation-procedures.html#cb234-26" tabindex="-1"></a>}</span></code></pre></div>
<p>We still store the messages, warnings, and errors from the initial <code>lmer()</code> fit so that we can keep track of how often errors occur.
The function now returns an treatment effect estimate even if <code>lmer()</code> errors:</p>
<div class="sourceCode" id="cb235"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb235-1"><a href="estimation-procedures.html#cb235-1" tabindex="-1"></a><span class="fu">analysis_MLM_contingent</span>(tiny_dat)</span></code></pre></div>
<pre><code>## # A tibble: 1 × 6
##   ATE_hat SE_hat p_value message warning error
##     &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;lgl&gt;
## 1   0.400  0.603   0.525 &lt;NA&gt;    &lt;NA&gt;    TRUE</code></pre>
<p>Of course, we can easily anticipate the conditions under which this particular error will occur: all we need to do is check whether all the clusters are single observations.
Because it is easily anticipated, a better strategy for handling this error is to check <em>before</em> fitting the multilevel model and proceeding accordingly in the event that the clusters are all singletons.
Exercise <a href="estimation-procedures.html#contingent-estimator-processing">7.5.5</a> asks you to implement this approach and further refine this contingent analysis strategy.</p>
<p>Adapting estimation functions to address errors can be an effective—and often very interesting—strategy for studying the performance of estimation methods.
Rather than studying the performance of a data-analysis method that is only sometimes well-defined, we shift to studying a stylized cognitive model for the analyst’s decision-making process, which handles contingencies that might crop up whether analyzing simulated data or real empirical data.
Of course, studying such a model is only interesting to the extent that the decision-making process it implements is a plausible representation of what an analyst might actually do in practice.</p>
<p>The adaptive estimation approach does lead to more complex estimation functions, which entail implementing multiple estimation methods and a set of decision rules for applying them.
Often, the set of contingencies that need to be handled will not be immediately obvious, so you may find that you need to build and refine the decision rules as you learn more about how they work.
Running an estimator over multiple, simulated datasets is an excellent (if aggravating!) way to identify errors and edge cases.
We turn to procedures for doing so in Chapter <a href="running-the-simulation-process.html#running-the-simulation-process">8</a>.</p>
</div>
<div id="the-safely-option" class="section level3 hasAnchor" number="7.4.3">
<h3><span class="header-section-number">7.4.3</span> The <code>safely()</code> option<a href="estimation-procedures.html#the-safely-option" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>There is one final <code>purrr</code> option, <code>safely()</code>, which traps the full error message, instead of just replacing the output with a fixed value as <code>possibly()</code> does.
<code>safely()</code> returns a list with two entries: the original result of the original function (or some fixed value if there was an error), and the error message (or NULL if there was no error).</p>
<p>To use it, we feed our function into <code>safely()</code> to create a new version:</p>
<div class="sourceCode" id="cb237"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb237-1"><a href="estimation-procedures.html#cb237-1" tabindex="-1"></a>my_safe_function <span class="ot">&lt;-</span> <span class="fu">safely</span>( my_complex_function, <span class="at">otherwise =</span> <span class="cn">NA</span> )</span>
<span id="cb237-2"><a href="estimation-procedures.html#cb237-2" tabindex="-1"></a><span class="fu">my_safe_function</span>( <span class="dv">7</span> )</span></code></pre></div>
<pre><code>## $result
## [1] 1.277916
## 
## $error
## NULL</code></pre>
<p>Just as with <code>possibly()</code>, we can include <code>otherwise = NA</code> to set a return value if there is an error.</p>
<p>We can use the safe function repeatedly and it will always return a result:</p>
<div class="sourceCode" id="cb239"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb239-1"><a href="estimation-procedures.html#cb239-1" tabindex="-1"></a>resu <span class="ot">&lt;-</span> <span class="fu">replicate</span>(<span class="dv">20</span>, <span class="fu">my_safe_function</span>( <span class="dv">7</span> ), <span class="at">simplify =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<pre><code>## Warning in sqrt(sum(vals) * sign(vals)[[1]]):
## NaNs produced
## Warning in sqrt(sum(vals) * sign(vals)[[1]]):
## NaNs produced
## Warning in sqrt(sum(vals) * sign(vals)[[1]]):
## NaNs produced
## Warning in sqrt(sum(vals) * sign(vals)[[1]]):
## NaNs produced
## Warning in sqrt(sum(vals) * sign(vals)[[1]]):
## NaNs produced</code></pre>
<p>We still get warnings, but any errors are trapped so the function does not crash.</p>
<p>We end up with a 20-entry list, with each element consisting of a pair of the result and error message:</p>
<div class="sourceCode" id="cb241"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb241-1"><a href="estimation-procedures.html#cb241-1" tabindex="-1"></a><span class="fu">length</span>( resu )</span></code></pre></div>
<pre><code>## [1] 20</code></pre>
<div class="sourceCode" id="cb243"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb243-1"><a href="estimation-procedures.html#cb243-1" tabindex="-1"></a>resu[[<span class="dv">3</span>]]</span></code></pre></div>
<pre><code>## $result
## [1] NaN
## 
## $error
## NULL</code></pre>
<p>We can massage our data to a more easy to parse format:</p>
<div class="sourceCode" id="cb245"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb245-1"><a href="estimation-procedures.html#cb245-1" tabindex="-1"></a>resu <span class="ot">&lt;-</span> <span class="fu">transpose</span>( resu )</span>
<span id="cb245-2"><a href="estimation-procedures.html#cb245-2" tabindex="-1"></a><span class="fu">unlist</span>(resu<span class="sc">$</span>result)</span></code></pre></div>
<pre><code>##  [1]        NA        NA       NaN       NaN
##  [5]        NA 1.1766144        NA 1.6221953
##  [9]        NA       NaN        NA 1.6086350
## [13]       NaN 1.5356493        NA 1.1105727
## [17]        NA       NaN 1.1576487 0.8228205</code></pre>
<p>The <code>transpose()</code> function takes a list of lists, and reorganizes them to give you a list of all the first elements, a list of all the second elements, etc.
<code>transpose()</code> is very powerful for wrangling data, because then we can make a tibble with list columns as so:</p>
<div class="sourceCode" id="cb247"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb247-1"><a href="estimation-procedures.html#cb247-1" tabindex="-1"></a>tb <span class="ot">&lt;-</span> <span class="fu">tibble</span>( <span class="at">result =</span> <span class="fu">unlist</span>( resu<span class="sc">$</span>result ), </span>
<span id="cb247-2"><a href="estimation-procedures.html#cb247-2" tabindex="-1"></a>              <span class="at">error =</span> resu<span class="sc">$</span>error )</span>
<span id="cb247-3"><a href="estimation-procedures.html#cb247-3" tabindex="-1"></a><span class="fu">print</span>( tb, <span class="at">n =</span> <span class="dv">4</span> )</span></code></pre></div>
<pre><code>## # A tibble: 20 × 2
##   result error     
##    &lt;dbl&gt; &lt;list&gt;    
## 1     NA &lt;smplErrr&gt;
## 2     NA &lt;smplErrr&gt;
## 3    NaN &lt;NULL&gt;    
## 4    NaN &lt;NULL&gt;    
## # ℹ 16 more rows</code></pre>
<p>We now have our results all organized, and we can see which iterations produced errors.</p>
<p>Unfortunately, to use <code>safely()</code> and <code>quietly()</code> together, we get a bit of a mess.
Extending our cluster RCT example, we have:</p>
<div class="sourceCode" id="cb249"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb249-1"><a href="estimation-procedures.html#cb249-1" tabindex="-1"></a>quiet_safe_lmer <span class="ot">&lt;-</span> <span class="fu">quietly</span>( <span class="fu">safely</span>( lmerTest<span class="sc">::</span>lmer, <span class="at">otherwise=</span><span class="cn">NULL</span> ) )</span>
<span id="cb249-2"><a href="estimation-procedures.html#cb249-2" tabindex="-1"></a>M1 <span class="ot">&lt;-</span> <span class="fu">quiet_safe_lmer</span>( Yobs <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> Z <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> sid), <span class="at">data =</span> dat )</span>
<span id="cb249-3"><a href="estimation-procedures.html#cb249-3" tabindex="-1"></a>M1</span></code></pre></div>
<pre><code>## $result
## $result$result
## Linear mixed model fit by REML [&#39;lmerModLmerTest&#39;]
## Formula: ..1
##    Data: ..2
## REML criterion at convergence: 14026.44
## Random effects:
##  Groups   Name        Std.Dev.
##  sid      (Intercept) 0.0000  
##  Residual             0.9828  
## Number of obs: 5000, groups:  sid, 50
## Fixed Effects:
## (Intercept)            Z  
##   -0.013930    -0.008804  
## optimizer (nloptwrap) convergence code: 0 (OK) ; 0 optimizer warnings; 1 lme4 warnings 
## 
## $result$error
## NULL
## 
## 
## $output
## [1] &quot;&quot;
## 
## $warnings
## character(0)
## 
## $messages
## [1] &quot;boundary (singular) fit: see help(&#39;isSingular&#39;)\n&quot;</code></pre>
<p>The resulting object has the estimation results buried inside it.
Even though the result is a bit of a mess, this structure provides all the pieces that we need, including any errors, warnings, and other output.</p>
<p>We can then have, for example, code such as this in our estimation function:</p>
<div class="sourceCode" id="cb251"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb251-1"><a href="estimation-procedures.html#cb251-1" tabindex="-1"></a><span class="cf">if</span> ( <span class="fu">is.null</span>( M1<span class="sc">$</span>result<span class="sc">$</span>result ) ) {</span>
<span id="cb251-2"><a href="estimation-procedures.html#cb251-2" tabindex="-1"></a>  <span class="co"># we had an error!</span></span>
<span id="cb251-3"><a href="estimation-procedures.html#cb251-3" tabindex="-1"></a>  error <span class="ot">=</span> M1<span class="sc">$</span>result<span class="sc">$</span>error</span>
<span id="cb251-4"><a href="estimation-procedures.html#cb251-4" tabindex="-1"></a>  </span>
<span id="cb251-5"><a href="estimation-procedures.html#cb251-5" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb251-6"><a href="estimation-procedures.html#cb251-6" tabindex="-1"></a>  <span class="co"># We did not.  Do the same as above</span></span>
<span id="cb251-7"><a href="estimation-procedures.html#cb251-7" tabindex="-1"></a>  error <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb251-8"><a href="estimation-procedures.html#cb251-8" tabindex="-1"></a>}</span>
<span id="cb251-9"><a href="estimation-procedures.html#cb251-9" tabindex="-1"></a><span class="co"># etc.</span></span></code></pre></div>
<p>Fortunately, once we have written all this code, we can tuck it inside our estimation function, and then forget about it.
Once written, applying the function will produce a tidy table of results that we can easily analyze.</p>
</div>
</div>
<div id="exercises-4" class="section level2 hasAnchor" number="7.5">
<h2><span class="header-section-number">7.5</span> Exercises<a href="estimation-procedures.html#exercises-4" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="BFFs-forever" class="section level3 hasAnchor" number="7.5.1">
<h3><span class="header-section-number">7.5.1</span> More Heteroskedastic ANOVA<a href="estimation-procedures.html#BFFs-forever" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In the classic simulation by Brown and Forsythe (1974), they not only looked at the performance of the homoskedastic ANOVA-F test and Welch’s heteroskedastic-F test, they also proposed their own new hypothesis testing procedure.</p>
<ol style="list-style-type: decimal">
<li><p>Write a function that implements the Brown-Forsythe F* test (the BFF* test!) as described on p. 130 of Brown and Forsythe (1974), using the following code skeleton:</p>
<div class="sourceCode" id="cb252"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb252-1"><a href="estimation-procedures.html#cb252-1" tabindex="-1"></a>BF_F <span class="ot">&lt;-</span> <span class="cf">function</span>( data ) {</span>
<span id="cb252-2"><a href="estimation-procedures.html#cb252-2" tabindex="-1"></a></span>
<span id="cb252-3"><a href="estimation-procedures.html#cb252-3" tabindex="-1"></a>  <span class="co"># fill in the guts here</span></span>
<span id="cb252-4"><a href="estimation-procedures.html#cb252-4" tabindex="-1"></a></span>
<span id="cb252-5"><a href="estimation-procedures.html#cb252-5" tabindex="-1"></a>  <span class="fu">return</span>(pval)</span>
<span id="cb252-6"><a href="estimation-procedures.html#cb252-6" tabindex="-1"></a>}</span></code></pre></div>
<p>Run the following code to check that your function produces a result:</p>
<div class="sourceCode" id="cb253"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb253-1"><a href="estimation-procedures.html#cb253-1" tabindex="-1"></a>sim_data <span class="ot">&lt;-</span> <span class="fu">generate_ANOVA_data</span>(</span>
<span id="cb253-2"><a href="estimation-procedures.html#cb253-2" tabindex="-1"></a>  <span class="at">mu =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">6</span>), </span>
<span id="cb253-3"><a href="estimation-procedures.html#cb253-3" tabindex="-1"></a>  <span class="at">sigma_sq =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">1</span>),</span>
<span id="cb253-4"><a href="estimation-procedures.html#cb253-4" tabindex="-1"></a>  <span class="at">sample_size =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">2</span>, <span class="dv">4</span>)</span>
<span id="cb253-5"><a href="estimation-procedures.html#cb253-5" tabindex="-1"></a>)</span>
<span id="cb253-6"><a href="estimation-procedures.html#cb253-6" tabindex="-1"></a><span class="fu">BF_F</span>( sim_data )</span></code></pre></div></li>
<li><p>Try calling your <code>BF_F</code> function on a variety of datasets of different sizes and shapes, to make sure it works. What kinds of datasets should you test out?</p></li>
<li><p>Add the BFF* test into the output of <code>Welch_ANOVA_F()</code> by calling your <code>BF_F()</code> function inside the body of <code>Welch_ANOVA_F()</code>.</p></li>
<li><p>The <a href="https://cran.r-project.org/package=onewaytests"><code>onewaytests</code> package</a> implements a variety of different hypothesis testing procedures for one-way ANOVA. Validate your <code>Welch_ANOVA_F()</code> function by comparing the results to the output of the relevant functions from <code>onewaytests</code>.</p></li>
</ol>
</div>
<div id="contingent-testing" class="section level3 hasAnchor" number="7.5.2">
<h3><span class="header-section-number">7.5.2</span> Contingent testing<a href="estimation-procedures.html#contingent-testing" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In the one-way ANOVA problem, one approach that an analyst might think to take is to conduct a preliminary significance test for heterogeneity of variances (such as Levene’s test or Bartlett’s test), and then report the <span class="math inline">\(p\)</span>-value from the homoskedastic ANOVA F test if variance heterogeneity is not detected but the <span class="math inline">\(p\)</span>-value from the BFF* test if variance heteogeneity is detected.
Modify the <code>Welch_ANOVA_F()</code> function to return the <span class="math inline">\(p\)</span>-value from this contingent BFF* test in addition to the <span class="math inline">\(p\)</span>-values from the (non-contingent) ANOVA-F, Welch, and BFF* tests.
Include an input option that allows the user to control the <span class="math inline">\(\alpha\)</span> level of the preliminary test for heterogeneity of variances, as in the following skeleton.</p>
<div class="sourceCode" id="cb254"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb254-1"><a href="estimation-procedures.html#cb254-1" tabindex="-1"></a>Welch_ANOVA_F <span class="ot">&lt;-</span> <span class="cf">function</span>( data , <span class="at">pre_alpha =</span> .<span class="dv">05</span>) {</span>
<span id="cb254-2"><a href="estimation-procedures.html#cb254-2" tabindex="-1"></a>  <span class="co"># preliminary test for variance heterogeneity</span></span>
<span id="cb254-3"><a href="estimation-procedures.html#cb254-3" tabindex="-1"></a>  <span class="co"># compute non-contingent F tests for group differences</span></span>
<span id="cb254-4"><a href="estimation-procedures.html#cb254-4" tabindex="-1"></a>  <span class="co"># compute contingent test</span></span>
<span id="cb254-5"><a href="estimation-procedures.html#cb254-5" tabindex="-1"></a>  <span class="co"># compile results</span></span>
<span id="cb254-6"><a href="estimation-procedures.html#cb254-6" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb254-7"><a href="estimation-procedures.html#cb254-7" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="cross-check-CRT-estimators" class="section level3 hasAnchor" number="7.5.3">
<h3><span class="header-section-number">7.5.3</span> Check the cluster-RCT functions<a href="estimation-procedures.html#cross-check-CRT-estimators" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Section <a href="estimation-procedures.html#multiple-estimation-procedures">7.2</a> presented functions implementing several different strategies for estimating an average treatment effect from a cluster-randomized trial.
Write some code to validate these functions by comparing their output to the results of other tools for doing the same calculation.
Use one or more datasets simulated with <code>gen_cluster_RCT()</code>.
For each of these tests, you will need to figure out the appropriate syntax by reading the package documentation.</p>
<ol style="list-style-type: decimal">
<li><p>For <code>analysis_MLM()</code>, check the output by fitting the same model using <code>lme()</code> from the <code>nlme()</code> package or <code>glmmTMB()</code> from the package of the same name.</p></li>
<li><p>For <code>analysis_OLS()</code>, check the output by fitting the linear model using the base R function <code>lm()</code>, then computing standard errors using <code>vcovCL()</code> from the <code>sandwich</code> package. Also compare the output to the results of feeding the fitted model through <code>coef_test()</code> from the <code>clubSandwich</code> package.</p></li>
<li><p>For <code>analysis_agg()</code>, check the output by aggregating the data to the school-level, fitting the linear model using <code>lm()</code>, and computing standard errors using <code>vcovHC()</code> from the <code>sandwich</code> package.</p></li>
</ol>
</div>
<div id="CRT-ANCOVA-estimators" class="section level3 hasAnchor" number="7.5.4">
<h3><span class="header-section-number">7.5.4</span> Extending the cluster-RCT functions<a href="estimation-procedures.html#CRT-ANCOVA-estimators" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Exercise <a href="data-generating-processes.html#cluster-RCT-baseline">6.9.10</a> from Chapter <a href="data-generating-processes.html#data-generating-processes">6</a> asked you to extend the data-generating function for the cluster-randomized trial to include generating a student-level covariate, <span class="math inline">\(X\)</span>, that is predictive of the outcome.
Use your modified function to generate a dataset.</p>
<ol style="list-style-type: decimal">
<li><p>Modify the estimation functions from Section <a href="estimation-procedures.html#multiple-estimation-procedures">7.2</a> to use models that include the covariate as a predictor.</p></li>
<li><p>Further extend the functions to include an input argument for the set of predictors to be included in the model, as in the following skeleton for the multi-level model estimator:</p>
<div class="sourceCode" id="cb255"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb255-1"><a href="estimation-procedures.html#cb255-1" tabindex="-1"></a>analysis_MLM <span class="ot">&lt;-</span> <span class="cf">function</span>(dat, <span class="at">predictors =</span> <span class="st">&quot;Z&quot;</span>) {</span>
<span id="cb255-2"><a href="estimation-procedures.html#cb255-2" tabindex="-1"></a></span>
<span id="cb255-3"><a href="estimation-procedures.html#cb255-3" tabindex="-1"></a>}</span>
<span id="cb255-4"><a href="estimation-procedures.html#cb255-4" tabindex="-1"></a></span>
<span id="cb255-5"><a href="estimation-procedures.html#cb255-5" tabindex="-1"></a><span class="fu">analysis_MLM</span>( dat )</span>
<span id="cb255-6"><a href="estimation-procedures.html#cb255-6" tabindex="-1"></a><span class="fu">analysis_MLM</span>( dat, <span class="at">predictors =</span> <span class="fu">c</span>(<span class="st">&quot;Z&quot;</span>,<span class="st">&quot;X&quot;</span>))</span>
<span id="cb255-7"><a href="estimation-procedures.html#cb255-7" tabindex="-1"></a><span class="fu">analysis_MLM</span>( dat, <span class="at">predictors =</span> <span class="fu">c</span>(<span class="st">&quot;Z&quot;</span>,<span class="st">&quot;X&quot;</span>, <span class="st">&quot;X:Z&quot;</span>))</span></code></pre></div>
<p>Hint: Check out the <code>reformulate()</code> function, which makes it easy to build formulas for different sets of predictors.</p></li>
</ol>
</div>
<div id="contingent-estimator-processing" class="section level3 hasAnchor" number="7.5.5">
<h3><span class="header-section-number">7.5.5</span> Contingent estimator processing<a href="estimation-procedures.html#contingent-estimator-processing" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In Section <a href="estimation-procedures.html#adapting-for-errors">7.4.2</a> we developed a version of <code>analysis_MLM()</code> that fell back on OLS regression in the event that <code>lmer()</code> produced any error.
The implementation that we demonstrated is not especially smart.
For one, it does not anticipate that the error will occur.
For another, if we are using this function as one of several estimation strategies, it will require fitting the OLS regression multiple times.
Can you fix these problems?</p>
<ol style="list-style-type: decimal">
<li><p>Revise <code>analysis_MLM_contingent()</code> so that it checks whether all clusters are single observations <em>before</em> fitting the multilevel model.
Handle event the contingency where all clusters are singletons by skipping the model-fitting step, returning <code>NA</code> values for the point estimator, standard error, and p-value, and returning an informative message in the <code>error</code> variable. Test that the function is working as expected.</p></li>
<li><p>Revise <code>estimate_Tx_Fx()</code> to use your new version of <code>analysis_MLM_contingent()</code>. The revised function will sometimes return <code>NA</code> values for the <code>MLM</code> results. To implement the strategy of falling-back on OLS regression, add some code that replaces any <code>NA</code> values with corresponding results of <code>analysis_OLS()</code>. Test that the function is working as expected.</p></li>
</ol>
</div>
<div id="IRT-3PL-estimation" class="section level3 hasAnchor" number="7.5.6">
<h3><span class="header-section-number">7.5.6</span> Estimating 3-parameter item response theory models<a href="estimation-procedures.html#IRT-3PL-estimation" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Exercise <a href="data-generating-processes.html#IRT-DGP-parameters">6.9.11</a> asked you to write a data-generating function for the 3-parameter IRT model described in described in Section <a href="data-generating-processes.html#three-parameter-IRT">6.7</a>.
Use your function to generate a large dataset.
Using functions from the <a href="https://cran.r-project.org/package=ltm"><code>{ltm}</code></a>, <a href="https://cran.r-project.org/package=mirt"><code>{mirt}</code></a>, or <a href="https://cran.r-project.org/package=TAM"><code>{TAM}</code></a> packages, <em>estimate</em> the parameters of the 3-parameter IRT model based on the simulated dataset.</p>
<ol style="list-style-type: decimal">
<li><p>Write a function to <em>estimate</em> a 3-parameter IRT model and return a dataset containing estimates of the item characteristics <span class="math inline">\((\alpha_m,\beta_m, \gamma_m)\)</span>.</p></li>
<li><p>Add an option to the function to allow the user to specify known values of <span class="math inline">\(\gamma_m\)</span>.</p></li>
<li><p>Create a graphic showing how the item parameter estimates compare to the true item characteristics.</p></li>
<li><p>Write a function or set of functions to apply 1-parameter, 2-parameter, and 3-parameter models and return datasets containing the person ability estimates <span class="math inline">\(\theta_1,...,\theta_N\)</span> and corresponding standard errors of measurement.</p></li>
</ol>
</div>
<div id="Vevea-Hedges-estimation" class="section level3 hasAnchor" number="7.5.7">
<h3><span class="header-section-number">7.5.7</span> Meta-regression with selective reporting<a href="estimation-procedures.html#Vevea-Hedges-estimation" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Exercise <a href="data-generating-processes.html#Vevea-Hedges-DGP">6.9.15</a> asked you to write a data-generating function for the <span class="citation">@vevea1995general</span> selection model.
The <code>{metafor}</code> package includes a function for fitting this model (as well as a variety of other selection models).
Here is an example of the syntax for estimating this model, using a dataset from the <code>{metadat}</code> package:</p>
<div class="sourceCode" id="cb256"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb256-1"><a href="estimation-procedures.html#cb256-1" tabindex="-1"></a><span class="fu">library</span>(metafor)</span>
<span id="cb256-2"><a href="estimation-procedures.html#cb256-2" tabindex="-1"></a><span class="fu">data</span>(<span class="st">&quot;dat.assink2016&quot;</span>, <span class="at">package =</span> <span class="st">&quot;metadat&quot;</span>)</span>
<span id="cb256-3"><a href="estimation-procedures.html#cb256-3" tabindex="-1"></a></span>
<span id="cb256-4"><a href="estimation-procedures.html#cb256-4" tabindex="-1"></a><span class="co"># rename variables and tidy up</span></span>
<span id="cb256-5"><a href="estimation-procedures.html#cb256-5" tabindex="-1"></a>dat <span class="ot">&lt;-</span> </span>
<span id="cb256-6"><a href="estimation-procedures.html#cb256-6" tabindex="-1"></a>  dat.assink2016 <span class="sc">%&gt;%</span></span>
<span id="cb256-7"><a href="estimation-procedures.html#cb256-7" tabindex="-1"></a>  <span class="fu">mutate</span>( <span class="at">si =</span> <span class="fu">sqrt</span>(vi) ) <span class="sc">%&gt;%</span></span>
<span id="cb256-8"><a href="estimation-procedures.html#cb256-8" tabindex="-1"></a>  <span class="fu">rename</span>( <span class="at">Ti =</span> yi, <span class="at">s_sq =</span> vi, <span class="at">Xi =</span> year )</span>
<span id="cb256-9"><a href="estimation-procedures.html#cb256-9" tabindex="-1"></a></span>
<span id="cb256-10"><a href="estimation-procedures.html#cb256-10" tabindex="-1"></a><span class="co"># fit a random effects meta-regression model</span></span>
<span id="cb256-11"><a href="estimation-procedures.html#cb256-11" tabindex="-1"></a>rma_fit <span class="ot">&lt;-</span> <span class="fu">rma.uni</span>(<span class="at">yi =</span> Ti, <span class="at">sei =</span> si, <span class="at">mods =</span> <span class="sc">~</span> Xi, <span class="at">data =</span> dat)</span>
<span id="cb256-12"><a href="estimation-procedures.html#cb256-12" tabindex="-1"></a><span class="co"># fit two-step selection model</span></span>
<span id="cb256-13"><a href="estimation-procedures.html#cb256-13" tabindex="-1"></a><span class="fu">selmodel</span>(rma_fit, <span class="at">type =</span> <span class="st">&quot;step&quot;</span>, <span class="at">steps =</span> <span class="fu">c</span>(.<span class="dv">025</span>, .<span class="dv">500</span>))</span></code></pre></div>
<pre><code>## 
## Mixed-Effects Model (k = 100; tau^2 estimator: ML)
## 
## tau^2 (estimated amount of residual heterogeneity): 0.2314 (SE = 0.0500)
## tau (square root of estimated tau^2 value):         0.4810
## 
## Test for Residual Heterogeneity:
## LRT(df = 1) = 349.3718, p-val &lt; .0001
## 
## Test of Moderators (coefficient 2):
## QM(df = 1) = 42.1433, p-val &lt; .0001
## 
## Model Results:
## 
##          estimate      se     zval    pval 
## intrcpt    0.4149  0.1013   4.0942  &lt;.0001 
## Xi        -0.0782  0.0120  -6.4918  &lt;.0001 
##            ci.lb    ci.ub      
## intrcpt   0.2163   0.6135  *** 
## Xi       -0.1018  -0.0546  *** 
## 
## Test for Selection Model Parameters:
## LRT(df = 2) = 1.7814, p-val = 0.4104
## 
## Selection Model Results:
## 
##                      k  estimate      se     zval 
## 0     &lt; p &lt;= 0.025  59    1.0000     ---      --- 
## 0.025 &lt; p &lt;= 0.5    23    0.6990  0.2307  -1.3049 
## 0.5   &lt; p &lt;= 1      18    0.5027  0.2743  -1.8132 
##                       pval   ci.lb   ci.ub    
## 0     &lt; p &lt;= 0.025     ---     ---     ---    
## 0.025 &lt; p &lt;= 0.5    0.1919  0.2470  1.1511    
## 0.5   &lt; p &lt;= 1      0.0698  0.0000  1.0403  . 
## 
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p>The <code>selmodel()</code> function can also be used to fit selection models in which one or both of the selection parameters are fixed to user-specified values.
For example:</p>
<div class="sourceCode" id="cb258"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb258-1"><a href="estimation-procedures.html#cb258-1" tabindex="-1"></a><span class="co"># Fixing lambda_1 = 0.5, lambda_2 = 0.2</span></span>
<span id="cb258-2"><a href="estimation-procedures.html#cb258-2" tabindex="-1"></a>fix_both <span class="ot">&lt;-</span> <span class="fu">selmodel</span>(rma_fit, <span class="at">type =</span> <span class="st">&quot;step&quot;</span>, <span class="at">steps =</span> <span class="fu">c</span>(.<span class="dv">025</span>, .<span class="dv">500</span>), </span>
<span id="cb258-3"><a href="estimation-procedures.html#cb258-3" tabindex="-1"></a>                     <span class="at">delta =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fl">0.5</span>, <span class="fl">0.2</span>))</span>
<span id="cb258-4"><a href="estimation-procedures.html#cb258-4" tabindex="-1"></a></span>
<span id="cb258-5"><a href="estimation-procedures.html#cb258-5" tabindex="-1"></a><span class="co"># Fixing lambda_1 = 0.5, estimating lambda_2</span></span>
<span id="cb258-6"><a href="estimation-procedures.html#cb258-6" tabindex="-1"></a>fix_one <span class="ot">&lt;-</span> <span class="fu">selmodel</span>(rma_fit, <span class="at">type =</span> <span class="st">&quot;step&quot;</span>, <span class="at">steps =</span> <span class="fu">c</span>(.<span class="dv">025</span>, .<span class="dv">500</span>), </span>
<span id="cb258-7"><a href="estimation-procedures.html#cb258-7" tabindex="-1"></a>                    <span class="at">delta =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fl">0.5</span>, <span class="cn">NA</span>))</span></code></pre></div>
<ol style="list-style-type: decimal">
<li><p>Write an estimation function that fits the selection model and returns estimates, standard errors, and confidence intervals for each of the model parameters <span class="math inline">\((\beta_0,\beta_1,\tau,\lambda_1,\lambda_2)\)</span>.</p></li>
<li><p>The <code>selmodel()</code> fitting function sometimes returns errors, as in the following example:</p>
<div class="sourceCode" id="cb259"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb259-1"><a href="estimation-procedures.html#cb259-1" tabindex="-1"></a>dat_sig <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Ti <span class="sc">/</span> si <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb259-2"><a href="estimation-procedures.html#cb259-2" tabindex="-1"></a>rma_pos <span class="ot">&lt;-</span> <span class="fu">rma.uni</span>(<span class="at">yi =</span> Ti, <span class="at">sei =</span> si, <span class="at">mods =</span> <span class="sc">~</span> Xi, <span class="at">data =</span> dat_sig)</span>
<span id="cb259-3"><a href="estimation-procedures.html#cb259-3" tabindex="-1"></a><span class="co"># fit two-step selection model</span></span>
<span id="cb259-4"><a href="estimation-procedures.html#cb259-4" tabindex="-1"></a>sel_fit <span class="ot">&lt;-</span> <span class="fu">selmodel</span>(rma_pos, <span class="at">type =</span> <span class="st">&quot;step&quot;</span>, <span class="at">steps =</span> <span class="fu">c</span>(.<span class="dv">025</span>, .<span class="dv">500</span>))</span></code></pre></div>
<pre><code>## Warning: One or more intervals do not contain any
## observed p-values.</code></pre>
<pre><code>## Warning: One or more &#39;delta&#39; estimates are (almost) equal to their lower or upper bound.
## Treat results with caution (or consider adjusting &#39;delta.min&#39; and/or &#39;delta.max&#39;).</code></pre>
<p>Modify your estimation function to catch and return warnings such as these.
Write code demonstrating that the function works as expected.</p></li>
<li><p>The <code>selmodel()</code> throws warnings when the dataset contains no observations with <span class="math inline">\(p_i\)</span> in one of the specified intervals.
Modify your estimation function to set the selection probability for an interval to <span class="math inline">\(\lambda_1 = 0.1\)</span> if there are no <span class="math inline">\(p_i\)</span> values between .025 and .500 and to set <span class="math inline">\(\lambda_2 = 0.1\)</span> if there are no <span class="math inline">\(p_i\)</span> values larger than .500.
Write code demonstrating that the function works as expected.</p></li>
</ol>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="data-generating-processes.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="running-the-simulation-process.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": {
    "github": false,
    "facebook": true,
    "twitter": true,
    "linkedin": false,
    "weibo": false,
    "instapaper": false,
    "vk": false,
    "whatsapp": false,
    "all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
  },
  "fontsettings": {
    "theme": "white",
    "family": "sans",
    "size": 2
  },
  "edit": {
    "link": "https://github.com/jepusto/Designing-Simulations-in-R/edit/master/030-Estimation-procedures.Rmd",
    "text": "Edit"
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": null,
    "text": null
  },
  "download": ["Designing-Simulations-in-R.pdf", "Designing-Simulations-in-R.epub"],
  "search": {
    "engine": "lunr",
    "options": null
  },
  "toc": {
    "collapse": "section",
    "scroll_highlight": true
  },
  "toolbar": {
    "position": "fixed"
  },
  "info": true
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
